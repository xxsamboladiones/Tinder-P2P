(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();function _u(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Fp={exports:{}},pc={},Up={exports:{}},Te={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var d6;function _P(){if(d6)return Te;d6=1;var n=Symbol.for("react.element"),e=Symbol.for("react.portal"),t=Symbol.for("react.fragment"),r=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),i=Symbol.for("react.provider"),a=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),h=Symbol.for("react.memo"),f=Symbol.for("react.lazy"),p=Symbol.iterator;function m(T){return T===null||typeof T!="object"?null:(T=p&&T[p]||T["@@iterator"],typeof T=="function"?T:null)}var w={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},x=Object.assign,S={};function E(T,N,Z){this.props=T,this.context=N,this.refs=S,this.updater=Z||w}E.prototype.isReactComponent={},E.prototype.setState=function(T,N){if(typeof T!="object"&&typeof T!="function"&&T!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,T,N,"setState")},E.prototype.forceUpdate=function(T){this.updater.enqueueForceUpdate(this,T,"forceUpdate")};function A(){}A.prototype=E.prototype;function P(T,N,Z){this.props=T,this.context=N,this.refs=S,this.updater=Z||w}var k=P.prototype=new A;k.constructor=P,x(k,E.prototype),k.isPureReactComponent=!0;var F=Array.isArray,I=Object.prototype.hasOwnProperty,V={current:null},Q={key:!0,ref:!0,__self:!0,__source:!0};function D(T,N,Z){var oe,ie={},ae=null,me=null;if(N!=null)for(oe in N.ref!==void 0&&(me=N.ref),N.key!==void 0&&(ae=""+N.key),N)I.call(N,oe)&&!Q.hasOwnProperty(oe)&&(ie[oe]=N[oe]);var ve=arguments.length-2;if(ve===1)ie.children=Z;else if(1<ve){for(var ge=Array(ve),De=0;De<ve;De++)ge[De]=arguments[De+2];ie.children=ge}if(T&&T.defaultProps)for(oe in ve=T.defaultProps,ve)ie[oe]===void 0&&(ie[oe]=ve[oe]);return{$$typeof:n,type:T,key:ae,ref:me,props:ie,_owner:V.current}}function R(T,N){return{$$typeof:n,type:T.type,key:N,ref:T.ref,props:T.props,_owner:T._owner}}function Y(T){return typeof T=="object"&&T!==null&&T.$$typeof===n}function J(T){var N={"=":"=0",":":"=2"};return"$"+T.replace(/[=:]/g,function(Z){return N[Z]})}var X=/\/+/g;function B(T,N){return typeof T=="object"&&T!==null&&T.key!=null?J(""+T.key):N.toString(36)}function O(T,N,Z,oe,ie){var ae=typeof T;(ae==="undefined"||ae==="boolean")&&(T=null);var me=!1;if(T===null)me=!0;else switch(ae){case"string":case"number":me=!0;break;case"object":switch(T.$$typeof){case n:case e:me=!0}}if(me)return me=T,ie=ie(me),T=oe===""?"."+B(me,0):oe,F(ie)?(Z="",T!=null&&(Z=T.replace(X,"$&/")+"/"),O(ie,N,Z,"",function(De){return De})):ie!=null&&(Y(ie)&&(ie=R(ie,Z+(!ie.key||me&&me.key===ie.key?"":(""+ie.key).replace(X,"$&/")+"/")+T)),N.push(ie)),1;if(me=0,oe=oe===""?".":oe+":",F(T))for(var ve=0;ve<T.length;ve++){ae=T[ve];var ge=oe+B(ae,ve);me+=O(ae,N,Z,ge,ie)}else if(ge=m(T),typeof ge=="function")for(T=ge.call(T),ve=0;!(ae=T.next()).done;)ae=ae.value,ge=oe+B(ae,ve++),me+=O(ae,N,Z,ge,ie);else if(ae==="object")throw N=String(T),Error("Objects are not valid as a React child (found: "+(N==="[object Object]"?"object with keys {"+Object.keys(T).join(", ")+"}":N)+"). If you meant to render a collection of children, use an array instead.");return me}function L(T,N,Z){if(T==null)return T;var oe=[],ie=0;return O(T,oe,"","",function(ae){return N.call(Z,ae,ie++)}),oe}function K(T){if(T._status===-1){var N=T._result;N=N(),N.then(function(Z){(T._status===0||T._status===-1)&&(T._status=1,T._result=Z)},function(Z){(T._status===0||T._status===-1)&&(T._status=2,T._result=Z)}),T._status===-1&&(T._status=0,T._result=N)}if(T._status===1)return T._result.default;throw T._result}var G={current:null},$={transition:null},j={ReactCurrentDispatcher:G,ReactCurrentBatchConfig:$,ReactCurrentOwner:V};function H(){throw Error("act(...) is not supported in production builds of React.")}return Te.Children={map:L,forEach:function(T,N,Z){L(T,function(){N.apply(this,arguments)},Z)},count:function(T){var N=0;return L(T,function(){N++}),N},toArray:function(T){return L(T,function(N){return N})||[]},only:function(T){if(!Y(T))throw Error("React.Children.only expected to receive a single React element child.");return T}},Te.Component=E,Te.Fragment=t,Te.Profiler=s,Te.PureComponent=P,Te.StrictMode=r,Te.Suspense=u,Te.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=j,Te.act=H,Te.cloneElement=function(T,N,Z){if(T==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+T+".");var oe=x({},T.props),ie=T.key,ae=T.ref,me=T._owner;if(N!=null){if(N.ref!==void 0&&(ae=N.ref,me=V.current),N.key!==void 0&&(ie=""+N.key),T.type&&T.type.defaultProps)var ve=T.type.defaultProps;for(ge in N)I.call(N,ge)&&!Q.hasOwnProperty(ge)&&(oe[ge]=N[ge]===void 0&&ve!==void 0?ve[ge]:N[ge])}var ge=arguments.length-2;if(ge===1)oe.children=Z;else if(1<ge){ve=Array(ge);for(var De=0;De<ge;De++)ve[De]=arguments[De+2];oe.children=ve}return{$$typeof:n,type:T.type,key:ie,ref:ae,props:oe,_owner:me}},Te.createContext=function(T){return T={$$typeof:a,_currentValue:T,_currentValue2:T,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},T.Provider={$$typeof:i,_context:T},T.Consumer=T},Te.createElement=D,Te.createFactory=function(T){var N=D.bind(null,T);return N.type=T,N},Te.createRef=function(){return{current:null}},Te.forwardRef=function(T){return{$$typeof:c,render:T}},Te.isValidElement=Y,Te.lazy=function(T){return{$$typeof:f,_payload:{_status:-1,_result:T},_init:K}},Te.memo=function(T,N){return{$$typeof:h,type:T,compare:N===void 0?null:N}},Te.startTransition=function(T){var N=$.transition;$.transition={};try{T()}finally{$.transition=N}},Te.unstable_act=H,Te.useCallback=function(T,N){return G.current.useCallback(T,N)},Te.useContext=function(T){return G.current.useContext(T)},Te.useDebugValue=function(){},Te.useDeferredValue=function(T){return G.current.useDeferredValue(T)},Te.useEffect=function(T,N){return G.current.useEffect(T,N)},Te.useId=function(){return G.current.useId()},Te.useImperativeHandle=function(T,N,Z){return G.current.useImperativeHandle(T,N,Z)},Te.useInsertionEffect=function(T,N){return G.current.useInsertionEffect(T,N)},Te.useLayoutEffect=function(T,N){return G.current.useLayoutEffect(T,N)},Te.useMemo=function(T,N){return G.current.useMemo(T,N)},Te.useReducer=function(T,N,Z){return G.current.useReducer(T,N,Z)},Te.useRef=function(T){return G.current.useRef(T)},Te.useState=function(T){return G.current.useState(T)},Te.useSyncExternalStore=function(T,N,Z){return G.current.useSyncExternalStore(T,N,Z)},Te.useTransition=function(){return G.current.useTransition()},Te.version="18.3.1",Te}var h6;function Du(){return h6||(h6=1,Up.exports=_P()),Up.exports}/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var f6;function DP(){if(f6)return pc;f6=1;var n=Du(),e=Symbol.for("react.element"),t=Symbol.for("react.fragment"),r=Object.prototype.hasOwnProperty,s=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function a(c,u,h){var f,p={},m=null,w=null;h!==void 0&&(m=""+h),u.key!==void 0&&(m=""+u.key),u.ref!==void 0&&(w=u.ref);for(f in u)r.call(u,f)&&!i.hasOwnProperty(f)&&(p[f]=u[f]);if(c&&c.defaultProps)for(f in u=c.defaultProps,u)p[f]===void 0&&(p[f]=u[f]);return{$$typeof:e,type:c,key:m,ref:w,props:p,_owner:s.current}}return pc.Fragment=t,pc.jsx=a,pc.jsxs=a,pc}var p6;function IP(){return p6||(p6=1,Fp.exports=DP()),Fp.exports}var v=IP(),ch={},Vp={exports:{}},Sn={},jp={exports:{}},$p={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var g6;function NP(){return g6||(g6=1,function(n){function e($,j){var H=$.length;$.push(j);e:for(;0<H;){var T=H-1>>>1,N=$[T];if(0<s(N,j))$[T]=j,$[H]=N,H=T;else break e}}function t($){return $.length===0?null:$[0]}function r($){if($.length===0)return null;var j=$[0],H=$.pop();if(H!==j){$[0]=H;e:for(var T=0,N=$.length,Z=N>>>1;T<Z;){var oe=2*(T+1)-1,ie=$[oe],ae=oe+1,me=$[ae];if(0>s(ie,H))ae<N&&0>s(me,ie)?($[T]=me,$[ae]=H,T=ae):($[T]=ie,$[oe]=H,T=oe);else if(ae<N&&0>s(me,H))$[T]=me,$[ae]=H,T=ae;else break e}}return j}function s($,j){var H=$.sortIndex-j.sortIndex;return H!==0?H:$.id-j.id}if(typeof performance=="object"&&typeof performance.now=="function"){var i=performance;n.unstable_now=function(){return i.now()}}else{var a=Date,c=a.now();n.unstable_now=function(){return a.now()-c}}var u=[],h=[],f=1,p=null,m=3,w=!1,x=!1,S=!1,E=typeof setTimeout=="function"?setTimeout:null,A=typeof clearTimeout=="function"?clearTimeout:null,P=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function k($){for(var j=t(h);j!==null;){if(j.callback===null)r(h);else if(j.startTime<=$)r(h),j.sortIndex=j.expirationTime,e(u,j);else break;j=t(h)}}function F($){if(S=!1,k($),!x)if(t(u)!==null)x=!0,K(I);else{var j=t(h);j!==null&&G(F,j.startTime-$)}}function I($,j){x=!1,S&&(S=!1,A(D),D=-1),w=!0;var H=m;try{for(k(j),p=t(u);p!==null&&(!(p.expirationTime>j)||$&&!J());){var T=p.callback;if(typeof T=="function"){p.callback=null,m=p.priorityLevel;var N=T(p.expirationTime<=j);j=n.unstable_now(),typeof N=="function"?p.callback=N:p===t(u)&&r(u),k(j)}else r(u);p=t(u)}if(p!==null)var Z=!0;else{var oe=t(h);oe!==null&&G(F,oe.startTime-j),Z=!1}return Z}finally{p=null,m=H,w=!1}}var V=!1,Q=null,D=-1,R=5,Y=-1;function J(){return!(n.unstable_now()-Y<R)}function X(){if(Q!==null){var $=n.unstable_now();Y=$;var j=!0;try{j=Q(!0,$)}finally{j?B():(V=!1,Q=null)}}else V=!1}var B;if(typeof P=="function")B=function(){P(X)};else if(typeof MessageChannel<"u"){var O=new MessageChannel,L=O.port2;O.port1.onmessage=X,B=function(){L.postMessage(null)}}else B=function(){E(X,0)};function K($){Q=$,V||(V=!0,B())}function G($,j){D=E(function(){$(n.unstable_now())},j)}n.unstable_IdlePriority=5,n.unstable_ImmediatePriority=1,n.unstable_LowPriority=4,n.unstable_NormalPriority=3,n.unstable_Profiling=null,n.unstable_UserBlockingPriority=2,n.unstable_cancelCallback=function($){$.callback=null},n.unstable_continueExecution=function(){x||w||(x=!0,K(I))},n.unstable_forceFrameRate=function($){0>$||125<$?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):R=0<$?Math.floor(1e3/$):5},n.unstable_getCurrentPriorityLevel=function(){return m},n.unstable_getFirstCallbackNode=function(){return t(u)},n.unstable_next=function($){switch(m){case 1:case 2:case 3:var j=3;break;default:j=m}var H=m;m=j;try{return $()}finally{m=H}},n.unstable_pauseExecution=function(){},n.unstable_requestPaint=function(){},n.unstable_runWithPriority=function($,j){switch($){case 1:case 2:case 3:case 4:case 5:break;default:$=3}var H=m;m=$;try{return j()}finally{m=H}},n.unstable_scheduleCallback=function($,j,H){var T=n.unstable_now();switch(typeof H=="object"&&H!==null?(H=H.delay,H=typeof H=="number"&&0<H?T+H:T):H=T,$){case 1:var N=-1;break;case 2:N=250;break;case 5:N=1073741823;break;case 4:N=1e4;break;default:N=5e3}return N=H+N,$={id:f++,callback:j,priorityLevel:$,startTime:H,expirationTime:N,sortIndex:-1},H>T?($.sortIndex=H,e(h,$),t(u)===null&&$===t(h)&&(S?(A(D),D=-1):S=!0,G(F,H-T))):($.sortIndex=N,e(u,$),x||w||(x=!0,K(I))),$},n.unstable_shouldYield=J,n.unstable_wrapCallback=function($){var j=m;return function(){var H=m;m=j;try{return $.apply(this,arguments)}finally{m=H}}}}($p)),$p}var m6;function MP(){return m6||(m6=1,jp.exports=NP()),jp.exports}/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var y6;function RP(){if(y6)return Sn;y6=1;var n=Du(),e=MP();function t(o){for(var l="https://reactjs.org/docs/error-decoder.html?invariant="+o,d=1;d<arguments.length;d++)l+="&args[]="+encodeURIComponent(arguments[d]);return"Minified React error #"+o+"; visit "+l+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var r=new Set,s={};function i(o,l){a(o,l),a(o+"Capture",l)}function a(o,l){for(s[o]=l,o=0;o<l.length;o++)r.add(l[o])}var c=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),u=Object.prototype.hasOwnProperty,h=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,f={},p={};function m(o){return u.call(p,o)?!0:u.call(f,o)?!1:h.test(o)?p[o]=!0:(f[o]=!0,!1)}function w(o,l,d,g){if(d!==null&&d.type===0)return!1;switch(typeof l){case"function":case"symbol":return!0;case"boolean":return g?!1:d!==null?!d.acceptsBooleans:(o=o.toLowerCase().slice(0,5),o!=="data-"&&o!=="aria-");default:return!1}}function x(o,l,d,g){if(l===null||typeof l>"u"||w(o,l,d,g))return!0;if(g)return!1;if(d!==null)switch(d.type){case 3:return!l;case 4:return l===!1;case 5:return isNaN(l);case 6:return isNaN(l)||1>l}return!1}function S(o,l,d,g,y,b,C){this.acceptsBooleans=l===2||l===3||l===4,this.attributeName=g,this.attributeNamespace=y,this.mustUseProperty=d,this.propertyName=o,this.type=l,this.sanitizeURL=b,this.removeEmptyString=C}var E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(o){E[o]=new S(o,0,!1,o,null,!1,!1)}),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(o){var l=o[0];E[l]=new S(l,1,!1,o[1],null,!1,!1)}),["contentEditable","draggable","spellCheck","value"].forEach(function(o){E[o]=new S(o,2,!1,o.toLowerCase(),null,!1,!1)}),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(o){E[o]=new S(o,2,!1,o,null,!1,!1)}),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(o){E[o]=new S(o,3,!1,o.toLowerCase(),null,!1,!1)}),["checked","multiple","muted","selected"].forEach(function(o){E[o]=new S(o,3,!0,o,null,!1,!1)}),["capture","download"].forEach(function(o){E[o]=new S(o,4,!1,o,null,!1,!1)}),["cols","rows","size","span"].forEach(function(o){E[o]=new S(o,6,!1,o,null,!1,!1)}),["rowSpan","start"].forEach(function(o){E[o]=new S(o,5,!1,o.toLowerCase(),null,!1,!1)});var A=/[\-:]([a-z])/g;function P(o){return o[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(o){var l=o.replace(A,P);E[l]=new S(l,1,!1,o,null,!1,!1)}),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(o){var l=o.replace(A,P);E[l]=new S(l,1,!1,o,"http://www.w3.org/1999/xlink",!1,!1)}),["xml:base","xml:lang","xml:space"].forEach(function(o){var l=o.replace(A,P);E[l]=new S(l,1,!1,o,"http://www.w3.org/XML/1998/namespace",!1,!1)}),["tabIndex","crossOrigin"].forEach(function(o){E[o]=new S(o,1,!1,o.toLowerCase(),null,!1,!1)}),E.xlinkHref=new S("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach(function(o){E[o]=new S(o,1,!1,o.toLowerCase(),null,!0,!0)});function k(o,l,d,g){var y=E.hasOwnProperty(l)?E[l]:null;(y!==null?y.type!==0:g||!(2<l.length)||l[0]!=="o"&&l[0]!=="O"||l[1]!=="n"&&l[1]!=="N")&&(x(l,d,y,g)&&(d=null),g||y===null?m(l)&&(d===null?o.removeAttribute(l):o.setAttribute(l,""+d)):y.mustUseProperty?o[y.propertyName]=d===null?y.type===3?!1:"":d:(l=y.attributeName,g=y.attributeNamespace,d===null?o.removeAttribute(l):(y=y.type,d=y===3||y===4&&d===!0?"":""+d,g?o.setAttributeNS(g,l,d):o.setAttribute(l,d))))}var F=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,I=Symbol.for("react.element"),V=Symbol.for("react.portal"),Q=Symbol.for("react.fragment"),D=Symbol.for("react.strict_mode"),R=Symbol.for("react.profiler"),Y=Symbol.for("react.provider"),J=Symbol.for("react.context"),X=Symbol.for("react.forward_ref"),B=Symbol.for("react.suspense"),O=Symbol.for("react.suspense_list"),L=Symbol.for("react.memo"),K=Symbol.for("react.lazy"),G=Symbol.for("react.offscreen"),$=Symbol.iterator;function j(o){return o===null||typeof o!="object"?null:(o=$&&o[$]||o["@@iterator"],typeof o=="function"?o:null)}var H=Object.assign,T;function N(o){if(T===void 0)try{throw Error()}catch(d){var l=d.stack.trim().match(/\n( *(at )?)/);T=l&&l[1]||""}return`
`+T+o}var Z=!1;function oe(o,l){if(!o||Z)return"";Z=!0;var d=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(l)if(l=function(){throw Error()},Object.defineProperty(l.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(l,[])}catch(W){var g=W}Reflect.construct(o,[],l)}else{try{l.call()}catch(W){g=W}o.call(l.prototype)}else{try{throw Error()}catch(W){g=W}o()}}catch(W){if(W&&g&&typeof W.stack=="string"){for(var y=W.stack.split(`
`),b=g.stack.split(`
`),C=y.length-1,_=b.length-1;1<=C&&0<=_&&y[C]!==b[_];)_--;for(;1<=C&&0<=_;C--,_--)if(y[C]!==b[_]){if(C!==1||_!==1)do if(C--,_--,0>_||y[C]!==b[_]){var M=`
`+y[C].replace(" at new "," at ");return o.displayName&&M.includes("<anonymous>")&&(M=M.replace("<anonymous>",o.displayName)),M}while(1<=C&&0<=_);break}}}finally{Z=!1,Error.prepareStackTrace=d}return(o=o?o.displayName||o.name:"")?N(o):""}function ie(o){switch(o.tag){case 5:return N(o.type);case 16:return N("Lazy");case 13:return N("Suspense");case 19:return N("SuspenseList");case 0:case 2:case 15:return o=oe(o.type,!1),o;case 11:return o=oe(o.type.render,!1),o;case 1:return o=oe(o.type,!0),o;default:return""}}function ae(o){if(o==null)return null;if(typeof o=="function")return o.displayName||o.name||null;if(typeof o=="string")return o;switch(o){case Q:return"Fragment";case V:return"Portal";case R:return"Profiler";case D:return"StrictMode";case B:return"Suspense";case O:return"SuspenseList"}if(typeof o=="object")switch(o.$$typeof){case J:return(o.displayName||"Context")+".Consumer";case Y:return(o._context.displayName||"Context")+".Provider";case X:var l=o.render;return o=o.displayName,o||(o=l.displayName||l.name||"",o=o!==""?"ForwardRef("+o+")":"ForwardRef"),o;case L:return l=o.displayName||null,l!==null?l:ae(o.type)||"Memo";case K:l=o._payload,o=o._init;try{return ae(o(l))}catch{}}return null}function me(o){var l=o.type;switch(o.tag){case 24:return"Cache";case 9:return(l.displayName||"Context")+".Consumer";case 10:return(l._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return o=l.render,o=o.displayName||o.name||"",l.displayName||(o!==""?"ForwardRef("+o+")":"ForwardRef");case 7:return"Fragment";case 5:return l;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return ae(l);case 8:return l===D?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof l=="function")return l.displayName||l.name||null;if(typeof l=="string")return l}return null}function ve(o){switch(typeof o){case"boolean":case"number":case"string":case"undefined":return o;case"object":return o;default:return""}}function ge(o){var l=o.type;return(o=o.nodeName)&&o.toLowerCase()==="input"&&(l==="checkbox"||l==="radio")}function De(o){var l=ge(o)?"checked":"value",d=Object.getOwnPropertyDescriptor(o.constructor.prototype,l),g=""+o[l];if(!o.hasOwnProperty(l)&&typeof d<"u"&&typeof d.get=="function"&&typeof d.set=="function"){var y=d.get,b=d.set;return Object.defineProperty(o,l,{configurable:!0,get:function(){return y.call(this)},set:function(C){g=""+C,b.call(this,C)}}),Object.defineProperty(o,l,{enumerable:d.enumerable}),{getValue:function(){return g},setValue:function(C){g=""+C},stopTracking:function(){o._valueTracker=null,delete o[l]}}}}function At(o){o._valueTracker||(o._valueTracker=De(o))}function Jr(o){if(!o)return!1;var l=o._valueTracker;if(!l)return!0;var d=l.getValue(),g="";return o&&(g=ge(o)?o.checked?"true":"false":o.value),o=g,o!==d?(l.setValue(o),!0):!1}function kr(o){if(o=o||(typeof document<"u"?document:void 0),typeof o>"u")return null;try{return o.activeElement||o.body}catch{return o.body}}function Fo(o,l){var d=l.checked;return H({},l,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:d??o._wrapperState.initialChecked})}function Tl(o,l){var d=l.defaultValue==null?"":l.defaultValue,g=l.checked!=null?l.checked:l.defaultChecked;d=ve(l.value!=null?l.value:d),o._wrapperState={initialChecked:g,initialValue:d,controlled:l.type==="checkbox"||l.type==="radio"?l.checked!=null:l.value!=null}}function v4(o,l){l=l.checked,l!=null&&k(o,"checked",l,!1)}function q1(o,l){v4(o,l);var d=ve(l.value),g=l.type;if(d!=null)g==="number"?(d===0&&o.value===""||o.value!=d)&&(o.value=""+d):o.value!==""+d&&(o.value=""+d);else if(g==="submit"||g==="reset"){o.removeAttribute("value");return}l.hasOwnProperty("value")?W1(o,l.type,d):l.hasOwnProperty("defaultValue")&&W1(o,l.type,ve(l.defaultValue)),l.checked==null&&l.defaultChecked!=null&&(o.defaultChecked=!!l.defaultChecked)}function b4(o,l,d){if(l.hasOwnProperty("value")||l.hasOwnProperty("defaultValue")){var g=l.type;if(!(g!=="submit"&&g!=="reset"||l.value!==void 0&&l.value!==null))return;l=""+o._wrapperState.initialValue,d||l===o.value||(o.value=l),o.defaultValue=l}d=o.name,d!==""&&(o.name=""),o.defaultChecked=!!o._wrapperState.initialChecked,d!==""&&(o.name=d)}function W1(o,l,d){(l!=="number"||kr(o.ownerDocument)!==o)&&(d==null?o.defaultValue=""+o._wrapperState.initialValue:o.defaultValue!==""+d&&(o.defaultValue=""+d))}var _l=Array.isArray;function Uo(o,l,d,g){if(o=o.options,l){l={};for(var y=0;y<d.length;y++)l["$"+d[y]]=!0;for(d=0;d<o.length;d++)y=l.hasOwnProperty("$"+o[d].value),o[d].selected!==y&&(o[d].selected=y),y&&g&&(o[d].defaultSelected=!0)}else{for(d=""+ve(d),l=null,y=0;y<o.length;y++){if(o[y].value===d){o[y].selected=!0,g&&(o[y].defaultSelected=!0);return}l!==null||o[y].disabled||(l=o[y])}l!==null&&(l.selected=!0)}}function G1(o,l){if(l.dangerouslySetInnerHTML!=null)throw Error(t(91));return H({},l,{value:void 0,defaultValue:void 0,children:""+o._wrapperState.initialValue})}function x4(o,l){var d=l.value;if(d==null){if(d=l.children,l=l.defaultValue,d!=null){if(l!=null)throw Error(t(92));if(_l(d)){if(1<d.length)throw Error(t(93));d=d[0]}l=d}l==null&&(l=""),d=l}o._wrapperState={initialValue:ve(d)}}function S4(o,l){var d=ve(l.value),g=ve(l.defaultValue);d!=null&&(d=""+d,d!==o.value&&(o.value=d),l.defaultValue==null&&o.defaultValue!==d&&(o.defaultValue=d)),g!=null&&(o.defaultValue=""+g)}function E4(o){var l=o.textContent;l===o._wrapperState.initialValue&&l!==""&&l!==null&&(o.value=l)}function C4(o){switch(o){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Q1(o,l){return o==null||o==="http://www.w3.org/1999/xhtml"?C4(l):o==="http://www.w3.org/2000/svg"&&l==="foreignObject"?"http://www.w3.org/1999/xhtml":o}var td,k4=function(o){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(l,d,g,y){MSApp.execUnsafeLocalFunction(function(){return o(l,d,g,y)})}:o}(function(o,l){if(o.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in o)o.innerHTML=l;else{for(td=td||document.createElement("div"),td.innerHTML="<svg>"+l.valueOf().toString()+"</svg>",l=td.firstChild;o.firstChild;)o.removeChild(o.firstChild);for(;l.firstChild;)o.appendChild(l.firstChild)}});function Dl(o,l){if(l){var d=o.firstChild;if(d&&d===o.lastChild&&d.nodeType===3){d.nodeValue=l;return}}o.textContent=l}var Il={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Mk=["Webkit","ms","Moz","O"];Object.keys(Il).forEach(function(o){Mk.forEach(function(l){l=l+o.charAt(0).toUpperCase()+o.substring(1),Il[l]=Il[o]})});function A4(o,l,d){return l==null||typeof l=="boolean"||l===""?"":d||typeof l!="number"||l===0||Il.hasOwnProperty(o)&&Il[o]?(""+l).trim():l+"px"}function P4(o,l){o=o.style;for(var d in l)if(l.hasOwnProperty(d)){var g=d.indexOf("--")===0,y=A4(d,l[d],g);d==="float"&&(d="cssFloat"),g?o.setProperty(d,y):o[d]=y}}var Rk=H({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function Y1(o,l){if(l){if(Rk[o]&&(l.children!=null||l.dangerouslySetInnerHTML!=null))throw Error(t(137,o));if(l.dangerouslySetInnerHTML!=null){if(l.children!=null)throw Error(t(60));if(typeof l.dangerouslySetInnerHTML!="object"||!("__html"in l.dangerouslySetInnerHTML))throw Error(t(61))}if(l.style!=null&&typeof l.style!="object")throw Error(t(62))}}function X1(o,l){if(o.indexOf("-")===-1)return typeof l.is=="string";switch(o){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var J1=null;function Z1(o){return o=o.target||o.srcElement||window,o.correspondingUseElement&&(o=o.correspondingUseElement),o.nodeType===3?o.parentNode:o}var e0=null,Vo=null,jo=null;function T4(o){if(o=Zl(o)){if(typeof e0!="function")throw Error(t(280));var l=o.stateNode;l&&(l=Cd(l),e0(o.stateNode,o.type,l))}}function _4(o){Vo?jo?jo.push(o):jo=[o]:Vo=o}function D4(){if(Vo){var o=Vo,l=jo;if(jo=Vo=null,T4(o),l)for(o=0;o<l.length;o++)T4(l[o])}}function I4(o,l){return o(l)}function N4(){}var t0=!1;function M4(o,l,d){if(t0)return o(l,d);t0=!0;try{return I4(o,l,d)}finally{t0=!1,(Vo!==null||jo!==null)&&(N4(),D4())}}function Nl(o,l){var d=o.stateNode;if(d===null)return null;var g=Cd(d);if(g===null)return null;d=g[l];e:switch(l){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(g=!g.disabled)||(o=o.type,g=!(o==="button"||o==="input"||o==="select"||o==="textarea")),o=!g;break e;default:o=!1}if(o)return null;if(d&&typeof d!="function")throw Error(t(231,l,typeof d));return d}var n0=!1;if(c)try{var Ml={};Object.defineProperty(Ml,"passive",{get:function(){n0=!0}}),window.addEventListener("test",Ml,Ml),window.removeEventListener("test",Ml,Ml)}catch{n0=!1}function Lk(o,l,d,g,y,b,C,_,M){var W=Array.prototype.slice.call(arguments,3);try{l.apply(d,W)}catch(ne){this.onError(ne)}}var Rl=!1,nd=null,rd=!1,r0=null,Ok={onError:function(o){Rl=!0,nd=o}};function Bk(o,l,d,g,y,b,C,_,M){Rl=!1,nd=null,Lk.apply(Ok,arguments)}function Fk(o,l,d,g,y,b,C,_,M){if(Bk.apply(this,arguments),Rl){if(Rl){var W=nd;Rl=!1,nd=null}else throw Error(t(198));rd||(rd=!0,r0=W)}}function Ni(o){var l=o,d=o;if(o.alternate)for(;l.return;)l=l.return;else{o=l;do l=o,(l.flags&4098)!==0&&(d=l.return),o=l.return;while(o)}return l.tag===3?d:null}function R4(o){if(o.tag===13){var l=o.memoizedState;if(l===null&&(o=o.alternate,o!==null&&(l=o.memoizedState)),l!==null)return l.dehydrated}return null}function L4(o){if(Ni(o)!==o)throw Error(t(188))}function Uk(o){var l=o.alternate;if(!l){if(l=Ni(o),l===null)throw Error(t(188));return l!==o?null:o}for(var d=o,g=l;;){var y=d.return;if(y===null)break;var b=y.alternate;if(b===null){if(g=y.return,g!==null){d=g;continue}break}if(y.child===b.child){for(b=y.child;b;){if(b===d)return L4(y),o;if(b===g)return L4(y),l;b=b.sibling}throw Error(t(188))}if(d.return!==g.return)d=y,g=b;else{for(var C=!1,_=y.child;_;){if(_===d){C=!0,d=y,g=b;break}if(_===g){C=!0,g=y,d=b;break}_=_.sibling}if(!C){for(_=b.child;_;){if(_===d){C=!0,d=b,g=y;break}if(_===g){C=!0,g=b,d=y;break}_=_.sibling}if(!C)throw Error(t(189))}}if(d.alternate!==g)throw Error(t(190))}if(d.tag!==3)throw Error(t(188));return d.stateNode.current===d?o:l}function O4(o){return o=Uk(o),o!==null?B4(o):null}function B4(o){if(o.tag===5||o.tag===6)return o;for(o=o.child;o!==null;){var l=B4(o);if(l!==null)return l;o=o.sibling}return null}var F4=e.unstable_scheduleCallback,U4=e.unstable_cancelCallback,Vk=e.unstable_shouldYield,jk=e.unstable_requestPaint,wt=e.unstable_now,$k=e.unstable_getCurrentPriorityLevel,s0=e.unstable_ImmediatePriority,V4=e.unstable_UserBlockingPriority,sd=e.unstable_NormalPriority,zk=e.unstable_LowPriority,j4=e.unstable_IdlePriority,id=null,Ar=null;function Hk(o){if(Ar&&typeof Ar.onCommitFiberRoot=="function")try{Ar.onCommitFiberRoot(id,o,void 0,(o.current.flags&128)===128)}catch{}}var ir=Math.clz32?Math.clz32:Wk,Kk=Math.log,qk=Math.LN2;function Wk(o){return o>>>=0,o===0?32:31-(Kk(o)/qk|0)|0}var od=64,ad=4194304;function Ll(o){switch(o&-o){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return o&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return o&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return o}}function ld(o,l){var d=o.pendingLanes;if(d===0)return 0;var g=0,y=o.suspendedLanes,b=o.pingedLanes,C=d&268435455;if(C!==0){var _=C&~y;_!==0?g=Ll(_):(b&=C,b!==0&&(g=Ll(b)))}else C=d&~y,C!==0?g=Ll(C):b!==0&&(g=Ll(b));if(g===0)return 0;if(l!==0&&l!==g&&(l&y)===0&&(y=g&-g,b=l&-l,y>=b||y===16&&(b&4194240)!==0))return l;if((g&4)!==0&&(g|=d&16),l=o.entangledLanes,l!==0)for(o=o.entanglements,l&=g;0<l;)d=31-ir(l),y=1<<d,g|=o[d],l&=~y;return g}function Gk(o,l){switch(o){case 1:case 2:case 4:return l+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return l+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function Qk(o,l){for(var d=o.suspendedLanes,g=o.pingedLanes,y=o.expirationTimes,b=o.pendingLanes;0<b;){var C=31-ir(b),_=1<<C,M=y[C];M===-1?((_&d)===0||(_&g)!==0)&&(y[C]=Gk(_,l)):M<=l&&(o.expiredLanes|=_),b&=~_}}function i0(o){return o=o.pendingLanes&-1073741825,o!==0?o:o&1073741824?1073741824:0}function $4(){var o=od;return od<<=1,(od&4194240)===0&&(od=64),o}function o0(o){for(var l=[],d=0;31>d;d++)l.push(o);return l}function Ol(o,l,d){o.pendingLanes|=l,l!==536870912&&(o.suspendedLanes=0,o.pingedLanes=0),o=o.eventTimes,l=31-ir(l),o[l]=d}function Yk(o,l){var d=o.pendingLanes&~l;o.pendingLanes=l,o.suspendedLanes=0,o.pingedLanes=0,o.expiredLanes&=l,o.mutableReadLanes&=l,o.entangledLanes&=l,l=o.entanglements;var g=o.eventTimes;for(o=o.expirationTimes;0<d;){var y=31-ir(d),b=1<<y;l[y]=0,g[y]=-1,o[y]=-1,d&=~b}}function a0(o,l){var d=o.entangledLanes|=l;for(o=o.entanglements;d;){var g=31-ir(d),y=1<<g;y&l|o[g]&l&&(o[g]|=l),d&=~y}}var ze=0;function z4(o){return o&=-o,1<o?4<o?(o&268435455)!==0?16:536870912:4:1}var H4,l0,K4,q4,W4,c0=!1,cd=[],Ls=null,Os=null,Bs=null,Bl=new Map,Fl=new Map,Fs=[],Xk="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function G4(o,l){switch(o){case"focusin":case"focusout":Ls=null;break;case"dragenter":case"dragleave":Os=null;break;case"mouseover":case"mouseout":Bs=null;break;case"pointerover":case"pointerout":Bl.delete(l.pointerId);break;case"gotpointercapture":case"lostpointercapture":Fl.delete(l.pointerId)}}function Ul(o,l,d,g,y,b){return o===null||o.nativeEvent!==b?(o={blockedOn:l,domEventName:d,eventSystemFlags:g,nativeEvent:b,targetContainers:[y]},l!==null&&(l=Zl(l),l!==null&&l0(l)),o):(o.eventSystemFlags|=g,l=o.targetContainers,y!==null&&l.indexOf(y)===-1&&l.push(y),o)}function Jk(o,l,d,g,y){switch(l){case"focusin":return Ls=Ul(Ls,o,l,d,g,y),!0;case"dragenter":return Os=Ul(Os,o,l,d,g,y),!0;case"mouseover":return Bs=Ul(Bs,o,l,d,g,y),!0;case"pointerover":var b=y.pointerId;return Bl.set(b,Ul(Bl.get(b)||null,o,l,d,g,y)),!0;case"gotpointercapture":return b=y.pointerId,Fl.set(b,Ul(Fl.get(b)||null,o,l,d,g,y)),!0}return!1}function Q4(o){var l=Mi(o.target);if(l!==null){var d=Ni(l);if(d!==null){if(l=d.tag,l===13){if(l=R4(d),l!==null){o.blockedOn=l,W4(o.priority,function(){K4(d)});return}}else if(l===3&&d.stateNode.current.memoizedState.isDehydrated){o.blockedOn=d.tag===3?d.stateNode.containerInfo:null;return}}}o.blockedOn=null}function ud(o){if(o.blockedOn!==null)return!1;for(var l=o.targetContainers;0<l.length;){var d=d0(o.domEventName,o.eventSystemFlags,l[0],o.nativeEvent);if(d===null){d=o.nativeEvent;var g=new d.constructor(d.type,d);J1=g,d.target.dispatchEvent(g),J1=null}else return l=Zl(d),l!==null&&l0(l),o.blockedOn=d,!1;l.shift()}return!0}function Y4(o,l,d){ud(o)&&d.delete(l)}function Zk(){c0=!1,Ls!==null&&ud(Ls)&&(Ls=null),Os!==null&&ud(Os)&&(Os=null),Bs!==null&&ud(Bs)&&(Bs=null),Bl.forEach(Y4),Fl.forEach(Y4)}function Vl(o,l){o.blockedOn===l&&(o.blockedOn=null,c0||(c0=!0,e.unstable_scheduleCallback(e.unstable_NormalPriority,Zk)))}function jl(o){function l(y){return Vl(y,o)}if(0<cd.length){Vl(cd[0],o);for(var d=1;d<cd.length;d++){var g=cd[d];g.blockedOn===o&&(g.blockedOn=null)}}for(Ls!==null&&Vl(Ls,o),Os!==null&&Vl(Os,o),Bs!==null&&Vl(Bs,o),Bl.forEach(l),Fl.forEach(l),d=0;d<Fs.length;d++)g=Fs[d],g.blockedOn===o&&(g.blockedOn=null);for(;0<Fs.length&&(d=Fs[0],d.blockedOn===null);)Q4(d),d.blockedOn===null&&Fs.shift()}var $o=F.ReactCurrentBatchConfig,dd=!0;function eA(o,l,d,g){var y=ze,b=$o.transition;$o.transition=null;try{ze=1,u0(o,l,d,g)}finally{ze=y,$o.transition=b}}function tA(o,l,d,g){var y=ze,b=$o.transition;$o.transition=null;try{ze=4,u0(o,l,d,g)}finally{ze=y,$o.transition=b}}function u0(o,l,d,g){if(dd){var y=d0(o,l,d,g);if(y===null)T0(o,l,g,hd,d),G4(o,g);else if(Jk(y,o,l,d,g))g.stopPropagation();else if(G4(o,g),l&4&&-1<Xk.indexOf(o)){for(;y!==null;){var b=Zl(y);if(b!==null&&H4(b),b=d0(o,l,d,g),b===null&&T0(o,l,g,hd,d),b===y)break;y=b}y!==null&&g.stopPropagation()}else T0(o,l,g,null,d)}}var hd=null;function d0(o,l,d,g){if(hd=null,o=Z1(g),o=Mi(o),o!==null)if(l=Ni(o),l===null)o=null;else if(d=l.tag,d===13){if(o=R4(l),o!==null)return o;o=null}else if(d===3){if(l.stateNode.current.memoizedState.isDehydrated)return l.tag===3?l.stateNode.containerInfo:null;o=null}else l!==o&&(o=null);return hd=o,null}function X4(o){switch(o){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch($k()){case s0:return 1;case V4:return 4;case sd:case zk:return 16;case j4:return 536870912;default:return 16}default:return 16}}var Us=null,h0=null,fd=null;function J4(){if(fd)return fd;var o,l=h0,d=l.length,g,y="value"in Us?Us.value:Us.textContent,b=y.length;for(o=0;o<d&&l[o]===y[o];o++);var C=d-o;for(g=1;g<=C&&l[d-g]===y[b-g];g++);return fd=y.slice(o,1<g?1-g:void 0)}function pd(o){var l=o.keyCode;return"charCode"in o?(o=o.charCode,o===0&&l===13&&(o=13)):o=l,o===10&&(o=13),32<=o||o===13?o:0}function gd(){return!0}function Z4(){return!1}function _n(o){function l(d,g,y,b,C){this._reactName=d,this._targetInst=y,this.type=g,this.nativeEvent=b,this.target=C,this.currentTarget=null;for(var _ in o)o.hasOwnProperty(_)&&(d=o[_],this[_]=d?d(b):b[_]);return this.isDefaultPrevented=(b.defaultPrevented!=null?b.defaultPrevented:b.returnValue===!1)?gd:Z4,this.isPropagationStopped=Z4,this}return H(l.prototype,{preventDefault:function(){this.defaultPrevented=!0;var d=this.nativeEvent;d&&(d.preventDefault?d.preventDefault():typeof d.returnValue!="unknown"&&(d.returnValue=!1),this.isDefaultPrevented=gd)},stopPropagation:function(){var d=this.nativeEvent;d&&(d.stopPropagation?d.stopPropagation():typeof d.cancelBubble!="unknown"&&(d.cancelBubble=!0),this.isPropagationStopped=gd)},persist:function(){},isPersistent:gd}),l}var zo={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(o){return o.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},f0=_n(zo),$l=H({},zo,{view:0,detail:0}),nA=_n($l),p0,g0,zl,md=H({},$l,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:y0,button:0,buttons:0,relatedTarget:function(o){return o.relatedTarget===void 0?o.fromElement===o.srcElement?o.toElement:o.fromElement:o.relatedTarget},movementX:function(o){return"movementX"in o?o.movementX:(o!==zl&&(zl&&o.type==="mousemove"?(p0=o.screenX-zl.screenX,g0=o.screenY-zl.screenY):g0=p0=0,zl=o),p0)},movementY:function(o){return"movementY"in o?o.movementY:g0}}),ey=_n(md),rA=H({},md,{dataTransfer:0}),sA=_n(rA),iA=H({},$l,{relatedTarget:0}),m0=_n(iA),oA=H({},zo,{animationName:0,elapsedTime:0,pseudoElement:0}),aA=_n(oA),lA=H({},zo,{clipboardData:function(o){return"clipboardData"in o?o.clipboardData:window.clipboardData}}),cA=_n(lA),uA=H({},zo,{data:0}),ty=_n(uA),dA={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},hA={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},fA={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function pA(o){var l=this.nativeEvent;return l.getModifierState?l.getModifierState(o):(o=fA[o])?!!l[o]:!1}function y0(){return pA}var gA=H({},$l,{key:function(o){if(o.key){var l=dA[o.key]||o.key;if(l!=="Unidentified")return l}return o.type==="keypress"?(o=pd(o),o===13?"Enter":String.fromCharCode(o)):o.type==="keydown"||o.type==="keyup"?hA[o.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:y0,charCode:function(o){return o.type==="keypress"?pd(o):0},keyCode:function(o){return o.type==="keydown"||o.type==="keyup"?o.keyCode:0},which:function(o){return o.type==="keypress"?pd(o):o.type==="keydown"||o.type==="keyup"?o.keyCode:0}}),mA=_n(gA),yA=H({},md,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),ny=_n(yA),wA=H({},$l,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:y0}),vA=_n(wA),bA=H({},zo,{propertyName:0,elapsedTime:0,pseudoElement:0}),xA=_n(bA),SA=H({},md,{deltaX:function(o){return"deltaX"in o?o.deltaX:"wheelDeltaX"in o?-o.wheelDeltaX:0},deltaY:function(o){return"deltaY"in o?o.deltaY:"wheelDeltaY"in o?-o.wheelDeltaY:"wheelDelta"in o?-o.wheelDelta:0},deltaZ:0,deltaMode:0}),EA=_n(SA),CA=[9,13,27,32],w0=c&&"CompositionEvent"in window,Hl=null;c&&"documentMode"in document&&(Hl=document.documentMode);var kA=c&&"TextEvent"in window&&!Hl,ry=c&&(!w0||Hl&&8<Hl&&11>=Hl),sy=" ",iy=!1;function oy(o,l){switch(o){case"keyup":return CA.indexOf(l.keyCode)!==-1;case"keydown":return l.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function ay(o){return o=o.detail,typeof o=="object"&&"data"in o?o.data:null}var Ho=!1;function AA(o,l){switch(o){case"compositionend":return ay(l);case"keypress":return l.which!==32?null:(iy=!0,sy);case"textInput":return o=l.data,o===sy&&iy?null:o;default:return null}}function PA(o,l){if(Ho)return o==="compositionend"||!w0&&oy(o,l)?(o=J4(),fd=h0=Us=null,Ho=!1,o):null;switch(o){case"paste":return null;case"keypress":if(!(l.ctrlKey||l.altKey||l.metaKey)||l.ctrlKey&&l.altKey){if(l.char&&1<l.char.length)return l.char;if(l.which)return String.fromCharCode(l.which)}return null;case"compositionend":return ry&&l.locale!=="ko"?null:l.data;default:return null}}var TA={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function ly(o){var l=o&&o.nodeName&&o.nodeName.toLowerCase();return l==="input"?!!TA[o.type]:l==="textarea"}function cy(o,l,d,g){_4(g),l=xd(l,"onChange"),0<l.length&&(d=new f0("onChange","change",null,d,g),o.push({event:d,listeners:l}))}var Kl=null,ql=null;function _A(o){Py(o,0)}function yd(o){var l=Qo(o);if(Jr(l))return o}function DA(o,l){if(o==="change")return l}var uy=!1;if(c){var v0;if(c){var b0="oninput"in document;if(!b0){var dy=document.createElement("div");dy.setAttribute("oninput","return;"),b0=typeof dy.oninput=="function"}v0=b0}else v0=!1;uy=v0&&(!document.documentMode||9<document.documentMode)}function hy(){Kl&&(Kl.detachEvent("onpropertychange",fy),ql=Kl=null)}function fy(o){if(o.propertyName==="value"&&yd(ql)){var l=[];cy(l,ql,o,Z1(o)),M4(_A,l)}}function IA(o,l,d){o==="focusin"?(hy(),Kl=l,ql=d,Kl.attachEvent("onpropertychange",fy)):o==="focusout"&&hy()}function NA(o){if(o==="selectionchange"||o==="keyup"||o==="keydown")return yd(ql)}function MA(o,l){if(o==="click")return yd(l)}function RA(o,l){if(o==="input"||o==="change")return yd(l)}function LA(o,l){return o===l&&(o!==0||1/o===1/l)||o!==o&&l!==l}var or=typeof Object.is=="function"?Object.is:LA;function Wl(o,l){if(or(o,l))return!0;if(typeof o!="object"||o===null||typeof l!="object"||l===null)return!1;var d=Object.keys(o),g=Object.keys(l);if(d.length!==g.length)return!1;for(g=0;g<d.length;g++){var y=d[g];if(!u.call(l,y)||!or(o[y],l[y]))return!1}return!0}function py(o){for(;o&&o.firstChild;)o=o.firstChild;return o}function gy(o,l){var d=py(o);o=0;for(var g;d;){if(d.nodeType===3){if(g=o+d.textContent.length,o<=l&&g>=l)return{node:d,offset:l-o};o=g}e:{for(;d;){if(d.nextSibling){d=d.nextSibling;break e}d=d.parentNode}d=void 0}d=py(d)}}function my(o,l){return o&&l?o===l?!0:o&&o.nodeType===3?!1:l&&l.nodeType===3?my(o,l.parentNode):"contains"in o?o.contains(l):o.compareDocumentPosition?!!(o.compareDocumentPosition(l)&16):!1:!1}function yy(){for(var o=window,l=kr();l instanceof o.HTMLIFrameElement;){try{var d=typeof l.contentWindow.location.href=="string"}catch{d=!1}if(d)o=l.contentWindow;else break;l=kr(o.document)}return l}function x0(o){var l=o&&o.nodeName&&o.nodeName.toLowerCase();return l&&(l==="input"&&(o.type==="text"||o.type==="search"||o.type==="tel"||o.type==="url"||o.type==="password")||l==="textarea"||o.contentEditable==="true")}function OA(o){var l=yy(),d=o.focusedElem,g=o.selectionRange;if(l!==d&&d&&d.ownerDocument&&my(d.ownerDocument.documentElement,d)){if(g!==null&&x0(d)){if(l=g.start,o=g.end,o===void 0&&(o=l),"selectionStart"in d)d.selectionStart=l,d.selectionEnd=Math.min(o,d.value.length);else if(o=(l=d.ownerDocument||document)&&l.defaultView||window,o.getSelection){o=o.getSelection();var y=d.textContent.length,b=Math.min(g.start,y);g=g.end===void 0?b:Math.min(g.end,y),!o.extend&&b>g&&(y=g,g=b,b=y),y=gy(d,b);var C=gy(d,g);y&&C&&(o.rangeCount!==1||o.anchorNode!==y.node||o.anchorOffset!==y.offset||o.focusNode!==C.node||o.focusOffset!==C.offset)&&(l=l.createRange(),l.setStart(y.node,y.offset),o.removeAllRanges(),b>g?(o.addRange(l),o.extend(C.node,C.offset)):(l.setEnd(C.node,C.offset),o.addRange(l)))}}for(l=[],o=d;o=o.parentNode;)o.nodeType===1&&l.push({element:o,left:o.scrollLeft,top:o.scrollTop});for(typeof d.focus=="function"&&d.focus(),d=0;d<l.length;d++)o=l[d],o.element.scrollLeft=o.left,o.element.scrollTop=o.top}}var BA=c&&"documentMode"in document&&11>=document.documentMode,Ko=null,S0=null,Gl=null,E0=!1;function wy(o,l,d){var g=d.window===d?d.document:d.nodeType===9?d:d.ownerDocument;E0||Ko==null||Ko!==kr(g)||(g=Ko,"selectionStart"in g&&x0(g)?g={start:g.selectionStart,end:g.selectionEnd}:(g=(g.ownerDocument&&g.ownerDocument.defaultView||window).getSelection(),g={anchorNode:g.anchorNode,anchorOffset:g.anchorOffset,focusNode:g.focusNode,focusOffset:g.focusOffset}),Gl&&Wl(Gl,g)||(Gl=g,g=xd(S0,"onSelect"),0<g.length&&(l=new f0("onSelect","select",null,l,d),o.push({event:l,listeners:g}),l.target=Ko)))}function wd(o,l){var d={};return d[o.toLowerCase()]=l.toLowerCase(),d["Webkit"+o]="webkit"+l,d["Moz"+o]="moz"+l,d}var qo={animationend:wd("Animation","AnimationEnd"),animationiteration:wd("Animation","AnimationIteration"),animationstart:wd("Animation","AnimationStart"),transitionend:wd("Transition","TransitionEnd")},C0={},vy={};c&&(vy=document.createElement("div").style,"AnimationEvent"in window||(delete qo.animationend.animation,delete qo.animationiteration.animation,delete qo.animationstart.animation),"TransitionEvent"in window||delete qo.transitionend.transition);function vd(o){if(C0[o])return C0[o];if(!qo[o])return o;var l=qo[o],d;for(d in l)if(l.hasOwnProperty(d)&&d in vy)return C0[o]=l[d];return o}var by=vd("animationend"),xy=vd("animationiteration"),Sy=vd("animationstart"),Ey=vd("transitionend"),Cy=new Map,ky="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Vs(o,l){Cy.set(o,l),i(l,[o])}for(var k0=0;k0<ky.length;k0++){var A0=ky[k0],FA=A0.toLowerCase(),UA=A0[0].toUpperCase()+A0.slice(1);Vs(FA,"on"+UA)}Vs(by,"onAnimationEnd"),Vs(xy,"onAnimationIteration"),Vs(Sy,"onAnimationStart"),Vs("dblclick","onDoubleClick"),Vs("focusin","onFocus"),Vs("focusout","onBlur"),Vs(Ey,"onTransitionEnd"),a("onMouseEnter",["mouseout","mouseover"]),a("onMouseLeave",["mouseout","mouseover"]),a("onPointerEnter",["pointerout","pointerover"]),a("onPointerLeave",["pointerout","pointerover"]),i("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),i("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),i("onBeforeInput",["compositionend","keypress","textInput","paste"]),i("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),i("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),i("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Ql="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),VA=new Set("cancel close invalid load scroll toggle".split(" ").concat(Ql));function Ay(o,l,d){var g=o.type||"unknown-event";o.currentTarget=d,Fk(g,l,void 0,o),o.currentTarget=null}function Py(o,l){l=(l&4)!==0;for(var d=0;d<o.length;d++){var g=o[d],y=g.event;g=g.listeners;e:{var b=void 0;if(l)for(var C=g.length-1;0<=C;C--){var _=g[C],M=_.instance,W=_.currentTarget;if(_=_.listener,M!==b&&y.isPropagationStopped())break e;Ay(y,_,W),b=M}else for(C=0;C<g.length;C++){if(_=g[C],M=_.instance,W=_.currentTarget,_=_.listener,M!==b&&y.isPropagationStopped())break e;Ay(y,_,W),b=M}}}if(rd)throw o=r0,rd=!1,r0=null,o}function rt(o,l){var d=l[R0];d===void 0&&(d=l[R0]=new Set);var g=o+"__bubble";d.has(g)||(Ty(l,o,2,!1),d.add(g))}function P0(o,l,d){var g=0;l&&(g|=4),Ty(d,o,g,l)}var bd="_reactListening"+Math.random().toString(36).slice(2);function Yl(o){if(!o[bd]){o[bd]=!0,r.forEach(function(d){d!=="selectionchange"&&(VA.has(d)||P0(d,!1,o),P0(d,!0,o))});var l=o.nodeType===9?o:o.ownerDocument;l===null||l[bd]||(l[bd]=!0,P0("selectionchange",!1,l))}}function Ty(o,l,d,g){switch(X4(l)){case 1:var y=eA;break;case 4:y=tA;break;default:y=u0}d=y.bind(null,l,d,o),y=void 0,!n0||l!=="touchstart"&&l!=="touchmove"&&l!=="wheel"||(y=!0),g?y!==void 0?o.addEventListener(l,d,{capture:!0,passive:y}):o.addEventListener(l,d,!0):y!==void 0?o.addEventListener(l,d,{passive:y}):o.addEventListener(l,d,!1)}function T0(o,l,d,g,y){var b=g;if((l&1)===0&&(l&2)===0&&g!==null)e:for(;;){if(g===null)return;var C=g.tag;if(C===3||C===4){var _=g.stateNode.containerInfo;if(_===y||_.nodeType===8&&_.parentNode===y)break;if(C===4)for(C=g.return;C!==null;){var M=C.tag;if((M===3||M===4)&&(M=C.stateNode.containerInfo,M===y||M.nodeType===8&&M.parentNode===y))return;C=C.return}for(;_!==null;){if(C=Mi(_),C===null)return;if(M=C.tag,M===5||M===6){g=b=C;continue e}_=_.parentNode}}g=g.return}M4(function(){var W=b,ne=Z1(d),re=[];e:{var te=Cy.get(o);if(te!==void 0){var ce=f0,he=o;switch(o){case"keypress":if(pd(d)===0)break e;case"keydown":case"keyup":ce=mA;break;case"focusin":he="focus",ce=m0;break;case"focusout":he="blur",ce=m0;break;case"beforeblur":case"afterblur":ce=m0;break;case"click":if(d.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":ce=ey;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":ce=sA;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":ce=vA;break;case by:case xy:case Sy:ce=aA;break;case Ey:ce=xA;break;case"scroll":ce=nA;break;case"wheel":ce=EA;break;case"copy":case"cut":case"paste":ce=cA;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":ce=ny}var fe=(l&4)!==0,vt=!fe&&o==="scroll",z=fe?te!==null?te+"Capture":null:te;fe=[];for(var U=W,q;U!==null;){q=U;var se=q.stateNode;if(q.tag===5&&se!==null&&(q=se,z!==null&&(se=Nl(U,z),se!=null&&fe.push(Xl(U,se,q)))),vt)break;U=U.return}0<fe.length&&(te=new ce(te,he,null,d,ne),re.push({event:te,listeners:fe}))}}if((l&7)===0){e:{if(te=o==="mouseover"||o==="pointerover",ce=o==="mouseout"||o==="pointerout",te&&d!==J1&&(he=d.relatedTarget||d.fromElement)&&(Mi(he)||he[Zr]))break e;if((ce||te)&&(te=ne.window===ne?ne:(te=ne.ownerDocument)?te.defaultView||te.parentWindow:window,ce?(he=d.relatedTarget||d.toElement,ce=W,he=he?Mi(he):null,he!==null&&(vt=Ni(he),he!==vt||he.tag!==5&&he.tag!==6)&&(he=null)):(ce=null,he=W),ce!==he)){if(fe=ey,se="onMouseLeave",z="onMouseEnter",U="mouse",(o==="pointerout"||o==="pointerover")&&(fe=ny,se="onPointerLeave",z="onPointerEnter",U="pointer"),vt=ce==null?te:Qo(ce),q=he==null?te:Qo(he),te=new fe(se,U+"leave",ce,d,ne),te.target=vt,te.relatedTarget=q,se=null,Mi(ne)===W&&(fe=new fe(z,U+"enter",he,d,ne),fe.target=q,fe.relatedTarget=vt,se=fe),vt=se,ce&&he)t:{for(fe=ce,z=he,U=0,q=fe;q;q=Wo(q))U++;for(q=0,se=z;se;se=Wo(se))q++;for(;0<U-q;)fe=Wo(fe),U--;for(;0<q-U;)z=Wo(z),q--;for(;U--;){if(fe===z||z!==null&&fe===z.alternate)break t;fe=Wo(fe),z=Wo(z)}fe=null}else fe=null;ce!==null&&_y(re,te,ce,fe,!1),he!==null&&vt!==null&&_y(re,vt,he,fe,!0)}}e:{if(te=W?Qo(W):window,ce=te.nodeName&&te.nodeName.toLowerCase(),ce==="select"||ce==="input"&&te.type==="file")var ye=DA;else if(ly(te))if(uy)ye=RA;else{ye=NA;var be=IA}else(ce=te.nodeName)&&ce.toLowerCase()==="input"&&(te.type==="checkbox"||te.type==="radio")&&(ye=MA);if(ye&&(ye=ye(o,W))){cy(re,ye,d,ne);break e}be&&be(o,te,W),o==="focusout"&&(be=te._wrapperState)&&be.controlled&&te.type==="number"&&W1(te,"number",te.value)}switch(be=W?Qo(W):window,o){case"focusin":(ly(be)||be.contentEditable==="true")&&(Ko=be,S0=W,Gl=null);break;case"focusout":Gl=S0=Ko=null;break;case"mousedown":E0=!0;break;case"contextmenu":case"mouseup":case"dragend":E0=!1,wy(re,d,ne);break;case"selectionchange":if(BA)break;case"keydown":case"keyup":wy(re,d,ne)}var xe;if(w0)e:{switch(o){case"compositionstart":var ke="onCompositionStart";break e;case"compositionend":ke="onCompositionEnd";break e;case"compositionupdate":ke="onCompositionUpdate";break e}ke=void 0}else Ho?oy(o,d)&&(ke="onCompositionEnd"):o==="keydown"&&d.keyCode===229&&(ke="onCompositionStart");ke&&(ry&&d.locale!=="ko"&&(Ho||ke!=="onCompositionStart"?ke==="onCompositionEnd"&&Ho&&(xe=J4()):(Us=ne,h0="value"in Us?Us.value:Us.textContent,Ho=!0)),be=xd(W,ke),0<be.length&&(ke=new ty(ke,o,null,d,ne),re.push({event:ke,listeners:be}),xe?ke.data=xe:(xe=ay(d),xe!==null&&(ke.data=xe)))),(xe=kA?AA(o,d):PA(o,d))&&(W=xd(W,"onBeforeInput"),0<W.length&&(ne=new ty("onBeforeInput","beforeinput",null,d,ne),re.push({event:ne,listeners:W}),ne.data=xe))}Py(re,l)})}function Xl(o,l,d){return{instance:o,listener:l,currentTarget:d}}function xd(o,l){for(var d=l+"Capture",g=[];o!==null;){var y=o,b=y.stateNode;y.tag===5&&b!==null&&(y=b,b=Nl(o,d),b!=null&&g.unshift(Xl(o,b,y)),b=Nl(o,l),b!=null&&g.push(Xl(o,b,y))),o=o.return}return g}function Wo(o){if(o===null)return null;do o=o.return;while(o&&o.tag!==5);return o||null}function _y(o,l,d,g,y){for(var b=l._reactName,C=[];d!==null&&d!==g;){var _=d,M=_.alternate,W=_.stateNode;if(M!==null&&M===g)break;_.tag===5&&W!==null&&(_=W,y?(M=Nl(d,b),M!=null&&C.unshift(Xl(d,M,_))):y||(M=Nl(d,b),M!=null&&C.push(Xl(d,M,_)))),d=d.return}C.length!==0&&o.push({event:l,listeners:C})}var jA=/\r\n?/g,$A=/\u0000|\uFFFD/g;function Dy(o){return(typeof o=="string"?o:""+o).replace(jA,`
`).replace($A,"")}function Sd(o,l,d){if(l=Dy(l),Dy(o)!==l&&d)throw Error(t(425))}function Ed(){}var _0=null,D0=null;function I0(o,l){return o==="textarea"||o==="noscript"||typeof l.children=="string"||typeof l.children=="number"||typeof l.dangerouslySetInnerHTML=="object"&&l.dangerouslySetInnerHTML!==null&&l.dangerouslySetInnerHTML.__html!=null}var N0=typeof setTimeout=="function"?setTimeout:void 0,zA=typeof clearTimeout=="function"?clearTimeout:void 0,Iy=typeof Promise=="function"?Promise:void 0,HA=typeof queueMicrotask=="function"?queueMicrotask:typeof Iy<"u"?function(o){return Iy.resolve(null).then(o).catch(KA)}:N0;function KA(o){setTimeout(function(){throw o})}function M0(o,l){var d=l,g=0;do{var y=d.nextSibling;if(o.removeChild(d),y&&y.nodeType===8)if(d=y.data,d==="/$"){if(g===0){o.removeChild(y),jl(l);return}g--}else d!=="$"&&d!=="$?"&&d!=="$!"||g++;d=y}while(d);jl(l)}function js(o){for(;o!=null;o=o.nextSibling){var l=o.nodeType;if(l===1||l===3)break;if(l===8){if(l=o.data,l==="$"||l==="$!"||l==="$?")break;if(l==="/$")return null}}return o}function Ny(o){o=o.previousSibling;for(var l=0;o;){if(o.nodeType===8){var d=o.data;if(d==="$"||d==="$!"||d==="$?"){if(l===0)return o;l--}else d==="/$"&&l++}o=o.previousSibling}return null}var Go=Math.random().toString(36).slice(2),Pr="__reactFiber$"+Go,Jl="__reactProps$"+Go,Zr="__reactContainer$"+Go,R0="__reactEvents$"+Go,qA="__reactListeners$"+Go,WA="__reactHandles$"+Go;function Mi(o){var l=o[Pr];if(l)return l;for(var d=o.parentNode;d;){if(l=d[Zr]||d[Pr]){if(d=l.alternate,l.child!==null||d!==null&&d.child!==null)for(o=Ny(o);o!==null;){if(d=o[Pr])return d;o=Ny(o)}return l}o=d,d=o.parentNode}return null}function Zl(o){return o=o[Pr]||o[Zr],!o||o.tag!==5&&o.tag!==6&&o.tag!==13&&o.tag!==3?null:o}function Qo(o){if(o.tag===5||o.tag===6)return o.stateNode;throw Error(t(33))}function Cd(o){return o[Jl]||null}var L0=[],Yo=-1;function $s(o){return{current:o}}function st(o){0>Yo||(o.current=L0[Yo],L0[Yo]=null,Yo--)}function Ze(o,l){Yo++,L0[Yo]=o.current,o.current=l}var zs={},Yt=$s(zs),yn=$s(!1),Ri=zs;function Xo(o,l){var d=o.type.contextTypes;if(!d)return zs;var g=o.stateNode;if(g&&g.__reactInternalMemoizedUnmaskedChildContext===l)return g.__reactInternalMemoizedMaskedChildContext;var y={},b;for(b in d)y[b]=l[b];return g&&(o=o.stateNode,o.__reactInternalMemoizedUnmaskedChildContext=l,o.__reactInternalMemoizedMaskedChildContext=y),y}function wn(o){return o=o.childContextTypes,o!=null}function kd(){st(yn),st(Yt)}function My(o,l,d){if(Yt.current!==zs)throw Error(t(168));Ze(Yt,l),Ze(yn,d)}function Ry(o,l,d){var g=o.stateNode;if(l=l.childContextTypes,typeof g.getChildContext!="function")return d;g=g.getChildContext();for(var y in g)if(!(y in l))throw Error(t(108,me(o)||"Unknown",y));return H({},d,g)}function Ad(o){return o=(o=o.stateNode)&&o.__reactInternalMemoizedMergedChildContext||zs,Ri=Yt.current,Ze(Yt,o),Ze(yn,yn.current),!0}function Ly(o,l,d){var g=o.stateNode;if(!g)throw Error(t(169));d?(o=Ry(o,l,Ri),g.__reactInternalMemoizedMergedChildContext=o,st(yn),st(Yt),Ze(Yt,o)):st(yn),Ze(yn,d)}var es=null,Pd=!1,O0=!1;function Oy(o){es===null?es=[o]:es.push(o)}function GA(o){Pd=!0,Oy(o)}function Hs(){if(!O0&&es!==null){O0=!0;var o=0,l=ze;try{var d=es;for(ze=1;o<d.length;o++){var g=d[o];do g=g(!0);while(g!==null)}es=null,Pd=!1}catch(y){throw es!==null&&(es=es.slice(o+1)),F4(s0,Hs),y}finally{ze=l,O0=!1}}return null}var Jo=[],Zo=0,Td=null,_d=0,zn=[],Hn=0,Li=null,ts=1,ns="";function Oi(o,l){Jo[Zo++]=_d,Jo[Zo++]=Td,Td=o,_d=l}function By(o,l,d){zn[Hn++]=ts,zn[Hn++]=ns,zn[Hn++]=Li,Li=o;var g=ts;o=ns;var y=32-ir(g)-1;g&=~(1<<y),d+=1;var b=32-ir(l)+y;if(30<b){var C=y-y%5;b=(g&(1<<C)-1).toString(32),g>>=C,y-=C,ts=1<<32-ir(l)+y|d<<y|g,ns=b+o}else ts=1<<b|d<<y|g,ns=o}function B0(o){o.return!==null&&(Oi(o,1),By(o,1,0))}function F0(o){for(;o===Td;)Td=Jo[--Zo],Jo[Zo]=null,_d=Jo[--Zo],Jo[Zo]=null;for(;o===Li;)Li=zn[--Hn],zn[Hn]=null,ns=zn[--Hn],zn[Hn]=null,ts=zn[--Hn],zn[Hn]=null}var Dn=null,In=null,ot=!1,ar=null;function Fy(o,l){var d=Gn(5,null,null,0);d.elementType="DELETED",d.stateNode=l,d.return=o,l=o.deletions,l===null?(o.deletions=[d],o.flags|=16):l.push(d)}function Uy(o,l){switch(o.tag){case 5:var d=o.type;return l=l.nodeType!==1||d.toLowerCase()!==l.nodeName.toLowerCase()?null:l,l!==null?(o.stateNode=l,Dn=o,In=js(l.firstChild),!0):!1;case 6:return l=o.pendingProps===""||l.nodeType!==3?null:l,l!==null?(o.stateNode=l,Dn=o,In=null,!0):!1;case 13:return l=l.nodeType!==8?null:l,l!==null?(d=Li!==null?{id:ts,overflow:ns}:null,o.memoizedState={dehydrated:l,treeContext:d,retryLane:1073741824},d=Gn(18,null,null,0),d.stateNode=l,d.return=o,o.child=d,Dn=o,In=null,!0):!1;default:return!1}}function U0(o){return(o.mode&1)!==0&&(o.flags&128)===0}function V0(o){if(ot){var l=In;if(l){var d=l;if(!Uy(o,l)){if(U0(o))throw Error(t(418));l=js(d.nextSibling);var g=Dn;l&&Uy(o,l)?Fy(g,d):(o.flags=o.flags&-4097|2,ot=!1,Dn=o)}}else{if(U0(o))throw Error(t(418));o.flags=o.flags&-4097|2,ot=!1,Dn=o}}}function Vy(o){for(o=o.return;o!==null&&o.tag!==5&&o.tag!==3&&o.tag!==13;)o=o.return;Dn=o}function Dd(o){if(o!==Dn)return!1;if(!ot)return Vy(o),ot=!0,!1;var l;if((l=o.tag!==3)&&!(l=o.tag!==5)&&(l=o.type,l=l!=="head"&&l!=="body"&&!I0(o.type,o.memoizedProps)),l&&(l=In)){if(U0(o))throw jy(),Error(t(418));for(;l;)Fy(o,l),l=js(l.nextSibling)}if(Vy(o),o.tag===13){if(o=o.memoizedState,o=o!==null?o.dehydrated:null,!o)throw Error(t(317));e:{for(o=o.nextSibling,l=0;o;){if(o.nodeType===8){var d=o.data;if(d==="/$"){if(l===0){In=js(o.nextSibling);break e}l--}else d!=="$"&&d!=="$!"&&d!=="$?"||l++}o=o.nextSibling}In=null}}else In=Dn?js(o.stateNode.nextSibling):null;return!0}function jy(){for(var o=In;o;)o=js(o.nextSibling)}function ea(){In=Dn=null,ot=!1}function j0(o){ar===null?ar=[o]:ar.push(o)}var QA=F.ReactCurrentBatchConfig;function ec(o,l,d){if(o=d.ref,o!==null&&typeof o!="function"&&typeof o!="object"){if(d._owner){if(d=d._owner,d){if(d.tag!==1)throw Error(t(309));var g=d.stateNode}if(!g)throw Error(t(147,o));var y=g,b=""+o;return l!==null&&l.ref!==null&&typeof l.ref=="function"&&l.ref._stringRef===b?l.ref:(l=function(C){var _=y.refs;C===null?delete _[b]:_[b]=C},l._stringRef=b,l)}if(typeof o!="string")throw Error(t(284));if(!d._owner)throw Error(t(290,o))}return o}function Id(o,l){throw o=Object.prototype.toString.call(l),Error(t(31,o==="[object Object]"?"object with keys {"+Object.keys(l).join(", ")+"}":o))}function $y(o){var l=o._init;return l(o._payload)}function zy(o){function l(z,U){if(o){var q=z.deletions;q===null?(z.deletions=[U],z.flags|=16):q.push(U)}}function d(z,U){if(!o)return null;for(;U!==null;)l(z,U),U=U.sibling;return null}function g(z,U){for(z=new Map;U!==null;)U.key!==null?z.set(U.key,U):z.set(U.index,U),U=U.sibling;return z}function y(z,U){return z=Js(z,U),z.index=0,z.sibling=null,z}function b(z,U,q){return z.index=q,o?(q=z.alternate,q!==null?(q=q.index,q<U?(z.flags|=2,U):q):(z.flags|=2,U)):(z.flags|=1048576,U)}function C(z){return o&&z.alternate===null&&(z.flags|=2),z}function _(z,U,q,se){return U===null||U.tag!==6?(U=Np(q,z.mode,se),U.return=z,U):(U=y(U,q),U.return=z,U)}function M(z,U,q,se){var ye=q.type;return ye===Q?ne(z,U,q.props.children,se,q.key):U!==null&&(U.elementType===ye||typeof ye=="object"&&ye!==null&&ye.$$typeof===K&&$y(ye)===U.type)?(se=y(U,q.props),se.ref=ec(z,U,q),se.return=z,se):(se=th(q.type,q.key,q.props,null,z.mode,se),se.ref=ec(z,U,q),se.return=z,se)}function W(z,U,q,se){return U===null||U.tag!==4||U.stateNode.containerInfo!==q.containerInfo||U.stateNode.implementation!==q.implementation?(U=Mp(q,z.mode,se),U.return=z,U):(U=y(U,q.children||[]),U.return=z,U)}function ne(z,U,q,se,ye){return U===null||U.tag!==7?(U=Hi(q,z.mode,se,ye),U.return=z,U):(U=y(U,q),U.return=z,U)}function re(z,U,q){if(typeof U=="string"&&U!==""||typeof U=="number")return U=Np(""+U,z.mode,q),U.return=z,U;if(typeof U=="object"&&U!==null){switch(U.$$typeof){case I:return q=th(U.type,U.key,U.props,null,z.mode,q),q.ref=ec(z,null,U),q.return=z,q;case V:return U=Mp(U,z.mode,q),U.return=z,U;case K:var se=U._init;return re(z,se(U._payload),q)}if(_l(U)||j(U))return U=Hi(U,z.mode,q,null),U.return=z,U;Id(z,U)}return null}function te(z,U,q,se){var ye=U!==null?U.key:null;if(typeof q=="string"&&q!==""||typeof q=="number")return ye!==null?null:_(z,U,""+q,se);if(typeof q=="object"&&q!==null){switch(q.$$typeof){case I:return q.key===ye?M(z,U,q,se):null;case V:return q.key===ye?W(z,U,q,se):null;case K:return ye=q._init,te(z,U,ye(q._payload),se)}if(_l(q)||j(q))return ye!==null?null:ne(z,U,q,se,null);Id(z,q)}return null}function ce(z,U,q,se,ye){if(typeof se=="string"&&se!==""||typeof se=="number")return z=z.get(q)||null,_(U,z,""+se,ye);if(typeof se=="object"&&se!==null){switch(se.$$typeof){case I:return z=z.get(se.key===null?q:se.key)||null,M(U,z,se,ye);case V:return z=z.get(se.key===null?q:se.key)||null,W(U,z,se,ye);case K:var be=se._init;return ce(z,U,q,be(se._payload),ye)}if(_l(se)||j(se))return z=z.get(q)||null,ne(U,z,se,ye,null);Id(U,se)}return null}function he(z,U,q,se){for(var ye=null,be=null,xe=U,ke=U=0,Lt=null;xe!==null&&ke<q.length;ke++){xe.index>ke?(Lt=xe,xe=null):Lt=xe.sibling;var Le=te(z,xe,q[ke],se);if(Le===null){xe===null&&(xe=Lt);break}o&&xe&&Le.alternate===null&&l(z,xe),U=b(Le,U,ke),be===null?ye=Le:be.sibling=Le,be=Le,xe=Lt}if(ke===q.length)return d(z,xe),ot&&Oi(z,ke),ye;if(xe===null){for(;ke<q.length;ke++)xe=re(z,q[ke],se),xe!==null&&(U=b(xe,U,ke),be===null?ye=xe:be.sibling=xe,be=xe);return ot&&Oi(z,ke),ye}for(xe=g(z,xe);ke<q.length;ke++)Lt=ce(xe,z,ke,q[ke],se),Lt!==null&&(o&&Lt.alternate!==null&&xe.delete(Lt.key===null?ke:Lt.key),U=b(Lt,U,ke),be===null?ye=Lt:be.sibling=Lt,be=Lt);return o&&xe.forEach(function(Zs){return l(z,Zs)}),ot&&Oi(z,ke),ye}function fe(z,U,q,se){var ye=j(q);if(typeof ye!="function")throw Error(t(150));if(q=ye.call(q),q==null)throw Error(t(151));for(var be=ye=null,xe=U,ke=U=0,Lt=null,Le=q.next();xe!==null&&!Le.done;ke++,Le=q.next()){xe.index>ke?(Lt=xe,xe=null):Lt=xe.sibling;var Zs=te(z,xe,Le.value,se);if(Zs===null){xe===null&&(xe=Lt);break}o&&xe&&Zs.alternate===null&&l(z,xe),U=b(Zs,U,ke),be===null?ye=Zs:be.sibling=Zs,be=Zs,xe=Lt}if(Le.done)return d(z,xe),ot&&Oi(z,ke),ye;if(xe===null){for(;!Le.done;ke++,Le=q.next())Le=re(z,Le.value,se),Le!==null&&(U=b(Le,U,ke),be===null?ye=Le:be.sibling=Le,be=Le);return ot&&Oi(z,ke),ye}for(xe=g(z,xe);!Le.done;ke++,Le=q.next())Le=ce(xe,z,ke,Le.value,se),Le!==null&&(o&&Le.alternate!==null&&xe.delete(Le.key===null?ke:Le.key),U=b(Le,U,ke),be===null?ye=Le:be.sibling=Le,be=Le);return o&&xe.forEach(function(TP){return l(z,TP)}),ot&&Oi(z,ke),ye}function vt(z,U,q,se){if(typeof q=="object"&&q!==null&&q.type===Q&&q.key===null&&(q=q.props.children),typeof q=="object"&&q!==null){switch(q.$$typeof){case I:e:{for(var ye=q.key,be=U;be!==null;){if(be.key===ye){if(ye=q.type,ye===Q){if(be.tag===7){d(z,be.sibling),U=y(be,q.props.children),U.return=z,z=U;break e}}else if(be.elementType===ye||typeof ye=="object"&&ye!==null&&ye.$$typeof===K&&$y(ye)===be.type){d(z,be.sibling),U=y(be,q.props),U.ref=ec(z,be,q),U.return=z,z=U;break e}d(z,be);break}else l(z,be);be=be.sibling}q.type===Q?(U=Hi(q.props.children,z.mode,se,q.key),U.return=z,z=U):(se=th(q.type,q.key,q.props,null,z.mode,se),se.ref=ec(z,U,q),se.return=z,z=se)}return C(z);case V:e:{for(be=q.key;U!==null;){if(U.key===be)if(U.tag===4&&U.stateNode.containerInfo===q.containerInfo&&U.stateNode.implementation===q.implementation){d(z,U.sibling),U=y(U,q.children||[]),U.return=z,z=U;break e}else{d(z,U);break}else l(z,U);U=U.sibling}U=Mp(q,z.mode,se),U.return=z,z=U}return C(z);case K:return be=q._init,vt(z,U,be(q._payload),se)}if(_l(q))return he(z,U,q,se);if(j(q))return fe(z,U,q,se);Id(z,q)}return typeof q=="string"&&q!==""||typeof q=="number"?(q=""+q,U!==null&&U.tag===6?(d(z,U.sibling),U=y(U,q),U.return=z,z=U):(d(z,U),U=Np(q,z.mode,se),U.return=z,z=U),C(z)):d(z,U)}return vt}var ta=zy(!0),Hy=zy(!1),Nd=$s(null),Md=null,na=null,$0=null;function z0(){$0=na=Md=null}function H0(o){var l=Nd.current;st(Nd),o._currentValue=l}function K0(o,l,d){for(;o!==null;){var g=o.alternate;if((o.childLanes&l)!==l?(o.childLanes|=l,g!==null&&(g.childLanes|=l)):g!==null&&(g.childLanes&l)!==l&&(g.childLanes|=l),o===d)break;o=o.return}}function ra(o,l){Md=o,$0=na=null,o=o.dependencies,o!==null&&o.firstContext!==null&&((o.lanes&l)!==0&&(vn=!0),o.firstContext=null)}function Kn(o){var l=o._currentValue;if($0!==o)if(o={context:o,memoizedValue:l,next:null},na===null){if(Md===null)throw Error(t(308));na=o,Md.dependencies={lanes:0,firstContext:o}}else na=na.next=o;return l}var Bi=null;function q0(o){Bi===null?Bi=[o]:Bi.push(o)}function Ky(o,l,d,g){var y=l.interleaved;return y===null?(d.next=d,q0(l)):(d.next=y.next,y.next=d),l.interleaved=d,rs(o,g)}function rs(o,l){o.lanes|=l;var d=o.alternate;for(d!==null&&(d.lanes|=l),d=o,o=o.return;o!==null;)o.childLanes|=l,d=o.alternate,d!==null&&(d.childLanes|=l),d=o,o=o.return;return d.tag===3?d.stateNode:null}var Ks=!1;function W0(o){o.updateQueue={baseState:o.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function qy(o,l){o=o.updateQueue,l.updateQueue===o&&(l.updateQueue={baseState:o.baseState,firstBaseUpdate:o.firstBaseUpdate,lastBaseUpdate:o.lastBaseUpdate,shared:o.shared,effects:o.effects})}function ss(o,l){return{eventTime:o,lane:l,tag:0,payload:null,callback:null,next:null}}function qs(o,l,d){var g=o.updateQueue;if(g===null)return null;if(g=g.shared,(Me&2)!==0){var y=g.pending;return y===null?l.next=l:(l.next=y.next,y.next=l),g.pending=l,rs(o,d)}return y=g.interleaved,y===null?(l.next=l,q0(g)):(l.next=y.next,y.next=l),g.interleaved=l,rs(o,d)}function Rd(o,l,d){if(l=l.updateQueue,l!==null&&(l=l.shared,(d&4194240)!==0)){var g=l.lanes;g&=o.pendingLanes,d|=g,l.lanes=d,a0(o,d)}}function Wy(o,l){var d=o.updateQueue,g=o.alternate;if(g!==null&&(g=g.updateQueue,d===g)){var y=null,b=null;if(d=d.firstBaseUpdate,d!==null){do{var C={eventTime:d.eventTime,lane:d.lane,tag:d.tag,payload:d.payload,callback:d.callback,next:null};b===null?y=b=C:b=b.next=C,d=d.next}while(d!==null);b===null?y=b=l:b=b.next=l}else y=b=l;d={baseState:g.baseState,firstBaseUpdate:y,lastBaseUpdate:b,shared:g.shared,effects:g.effects},o.updateQueue=d;return}o=d.lastBaseUpdate,o===null?d.firstBaseUpdate=l:o.next=l,d.lastBaseUpdate=l}function Ld(o,l,d,g){var y=o.updateQueue;Ks=!1;var b=y.firstBaseUpdate,C=y.lastBaseUpdate,_=y.shared.pending;if(_!==null){y.shared.pending=null;var M=_,W=M.next;M.next=null,C===null?b=W:C.next=W,C=M;var ne=o.alternate;ne!==null&&(ne=ne.updateQueue,_=ne.lastBaseUpdate,_!==C&&(_===null?ne.firstBaseUpdate=W:_.next=W,ne.lastBaseUpdate=M))}if(b!==null){var re=y.baseState;C=0,ne=W=M=null,_=b;do{var te=_.lane,ce=_.eventTime;if((g&te)===te){ne!==null&&(ne=ne.next={eventTime:ce,lane:0,tag:_.tag,payload:_.payload,callback:_.callback,next:null});e:{var he=o,fe=_;switch(te=l,ce=d,fe.tag){case 1:if(he=fe.payload,typeof he=="function"){re=he.call(ce,re,te);break e}re=he;break e;case 3:he.flags=he.flags&-65537|128;case 0:if(he=fe.payload,te=typeof he=="function"?he.call(ce,re,te):he,te==null)break e;re=H({},re,te);break e;case 2:Ks=!0}}_.callback!==null&&_.lane!==0&&(o.flags|=64,te=y.effects,te===null?y.effects=[_]:te.push(_))}else ce={eventTime:ce,lane:te,tag:_.tag,payload:_.payload,callback:_.callback,next:null},ne===null?(W=ne=ce,M=re):ne=ne.next=ce,C|=te;if(_=_.next,_===null){if(_=y.shared.pending,_===null)break;te=_,_=te.next,te.next=null,y.lastBaseUpdate=te,y.shared.pending=null}}while(!0);if(ne===null&&(M=re),y.baseState=M,y.firstBaseUpdate=W,y.lastBaseUpdate=ne,l=y.shared.interleaved,l!==null){y=l;do C|=y.lane,y=y.next;while(y!==l)}else b===null&&(y.shared.lanes=0);Vi|=C,o.lanes=C,o.memoizedState=re}}function Gy(o,l,d){if(o=l.effects,l.effects=null,o!==null)for(l=0;l<o.length;l++){var g=o[l],y=g.callback;if(y!==null){if(g.callback=null,g=d,typeof y!="function")throw Error(t(191,y));y.call(g)}}}var tc={},Tr=$s(tc),nc=$s(tc),rc=$s(tc);function Fi(o){if(o===tc)throw Error(t(174));return o}function G0(o,l){switch(Ze(rc,l),Ze(nc,o),Ze(Tr,tc),o=l.nodeType,o){case 9:case 11:l=(l=l.documentElement)?l.namespaceURI:Q1(null,"");break;default:o=o===8?l.parentNode:l,l=o.namespaceURI||null,o=o.tagName,l=Q1(l,o)}st(Tr),Ze(Tr,l)}function sa(){st(Tr),st(nc),st(rc)}function Qy(o){Fi(rc.current);var l=Fi(Tr.current),d=Q1(l,o.type);l!==d&&(Ze(nc,o),Ze(Tr,d))}function Q0(o){nc.current===o&&(st(Tr),st(nc))}var ct=$s(0);function Od(o){for(var l=o;l!==null;){if(l.tag===13){var d=l.memoizedState;if(d!==null&&(d=d.dehydrated,d===null||d.data==="$?"||d.data==="$!"))return l}else if(l.tag===19&&l.memoizedProps.revealOrder!==void 0){if((l.flags&128)!==0)return l}else if(l.child!==null){l.child.return=l,l=l.child;continue}if(l===o)break;for(;l.sibling===null;){if(l.return===null||l.return===o)return null;l=l.return}l.sibling.return=l.return,l=l.sibling}return null}var Y0=[];function X0(){for(var o=0;o<Y0.length;o++)Y0[o]._workInProgressVersionPrimary=null;Y0.length=0}var Bd=F.ReactCurrentDispatcher,J0=F.ReactCurrentBatchConfig,Ui=0,ut=null,Pt=null,Mt=null,Fd=!1,sc=!1,ic=0,YA=0;function Xt(){throw Error(t(321))}function Z0(o,l){if(l===null)return!1;for(var d=0;d<l.length&&d<o.length;d++)if(!or(o[d],l[d]))return!1;return!0}function ep(o,l,d,g,y,b){if(Ui=b,ut=l,l.memoizedState=null,l.updateQueue=null,l.lanes=0,Bd.current=o===null||o.memoizedState===null?eP:tP,o=d(g,y),sc){b=0;do{if(sc=!1,ic=0,25<=b)throw Error(t(301));b+=1,Mt=Pt=null,l.updateQueue=null,Bd.current=nP,o=d(g,y)}while(sc)}if(Bd.current=jd,l=Pt!==null&&Pt.next!==null,Ui=0,Mt=Pt=ut=null,Fd=!1,l)throw Error(t(300));return o}function tp(){var o=ic!==0;return ic=0,o}function _r(){var o={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Mt===null?ut.memoizedState=Mt=o:Mt=Mt.next=o,Mt}function qn(){if(Pt===null){var o=ut.alternate;o=o!==null?o.memoizedState:null}else o=Pt.next;var l=Mt===null?ut.memoizedState:Mt.next;if(l!==null)Mt=l,Pt=o;else{if(o===null)throw Error(t(310));Pt=o,o={memoizedState:Pt.memoizedState,baseState:Pt.baseState,baseQueue:Pt.baseQueue,queue:Pt.queue,next:null},Mt===null?ut.memoizedState=Mt=o:Mt=Mt.next=o}return Mt}function oc(o,l){return typeof l=="function"?l(o):l}function np(o){var l=qn(),d=l.queue;if(d===null)throw Error(t(311));d.lastRenderedReducer=o;var g=Pt,y=g.baseQueue,b=d.pending;if(b!==null){if(y!==null){var C=y.next;y.next=b.next,b.next=C}g.baseQueue=y=b,d.pending=null}if(y!==null){b=y.next,g=g.baseState;var _=C=null,M=null,W=b;do{var ne=W.lane;if((Ui&ne)===ne)M!==null&&(M=M.next={lane:0,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null}),g=W.hasEagerState?W.eagerState:o(g,W.action);else{var re={lane:ne,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null};M===null?(_=M=re,C=g):M=M.next=re,ut.lanes|=ne,Vi|=ne}W=W.next}while(W!==null&&W!==b);M===null?C=g:M.next=_,or(g,l.memoizedState)||(vn=!0),l.memoizedState=g,l.baseState=C,l.baseQueue=M,d.lastRenderedState=g}if(o=d.interleaved,o!==null){y=o;do b=y.lane,ut.lanes|=b,Vi|=b,y=y.next;while(y!==o)}else y===null&&(d.lanes=0);return[l.memoizedState,d.dispatch]}function rp(o){var l=qn(),d=l.queue;if(d===null)throw Error(t(311));d.lastRenderedReducer=o;var g=d.dispatch,y=d.pending,b=l.memoizedState;if(y!==null){d.pending=null;var C=y=y.next;do b=o(b,C.action),C=C.next;while(C!==y);or(b,l.memoizedState)||(vn=!0),l.memoizedState=b,l.baseQueue===null&&(l.baseState=b),d.lastRenderedState=b}return[b,g]}function Yy(){}function Xy(o,l){var d=ut,g=qn(),y=l(),b=!or(g.memoizedState,y);if(b&&(g.memoizedState=y,vn=!0),g=g.queue,sp(e5.bind(null,d,g,o),[o]),g.getSnapshot!==l||b||Mt!==null&&Mt.memoizedState.tag&1){if(d.flags|=2048,ac(9,Zy.bind(null,d,g,y,l),void 0,null),Rt===null)throw Error(t(349));(Ui&30)!==0||Jy(d,l,y)}return y}function Jy(o,l,d){o.flags|=16384,o={getSnapshot:l,value:d},l=ut.updateQueue,l===null?(l={lastEffect:null,stores:null},ut.updateQueue=l,l.stores=[o]):(d=l.stores,d===null?l.stores=[o]:d.push(o))}function Zy(o,l,d,g){l.value=d,l.getSnapshot=g,t5(l)&&n5(o)}function e5(o,l,d){return d(function(){t5(l)&&n5(o)})}function t5(o){var l=o.getSnapshot;o=o.value;try{var d=l();return!or(o,d)}catch{return!0}}function n5(o){var l=rs(o,1);l!==null&&dr(l,o,1,-1)}function r5(o){var l=_r();return typeof o=="function"&&(o=o()),l.memoizedState=l.baseState=o,o={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:oc,lastRenderedState:o},l.queue=o,o=o.dispatch=ZA.bind(null,ut,o),[l.memoizedState,o]}function ac(o,l,d,g){return o={tag:o,create:l,destroy:d,deps:g,next:null},l=ut.updateQueue,l===null?(l={lastEffect:null,stores:null},ut.updateQueue=l,l.lastEffect=o.next=o):(d=l.lastEffect,d===null?l.lastEffect=o.next=o:(g=d.next,d.next=o,o.next=g,l.lastEffect=o)),o}function s5(){return qn().memoizedState}function Ud(o,l,d,g){var y=_r();ut.flags|=o,y.memoizedState=ac(1|l,d,void 0,g===void 0?null:g)}function Vd(o,l,d,g){var y=qn();g=g===void 0?null:g;var b=void 0;if(Pt!==null){var C=Pt.memoizedState;if(b=C.destroy,g!==null&&Z0(g,C.deps)){y.memoizedState=ac(l,d,b,g);return}}ut.flags|=o,y.memoizedState=ac(1|l,d,b,g)}function i5(o,l){return Ud(8390656,8,o,l)}function sp(o,l){return Vd(2048,8,o,l)}function o5(o,l){return Vd(4,2,o,l)}function a5(o,l){return Vd(4,4,o,l)}function l5(o,l){if(typeof l=="function")return o=o(),l(o),function(){l(null)};if(l!=null)return o=o(),l.current=o,function(){l.current=null}}function c5(o,l,d){return d=d!=null?d.concat([o]):null,Vd(4,4,l5.bind(null,l,o),d)}function ip(){}function u5(o,l){var d=qn();l=l===void 0?null:l;var g=d.memoizedState;return g!==null&&l!==null&&Z0(l,g[1])?g[0]:(d.memoizedState=[o,l],o)}function d5(o,l){var d=qn();l=l===void 0?null:l;var g=d.memoizedState;return g!==null&&l!==null&&Z0(l,g[1])?g[0]:(o=o(),d.memoizedState=[o,l],o)}function h5(o,l,d){return(Ui&21)===0?(o.baseState&&(o.baseState=!1,vn=!0),o.memoizedState=d):(or(d,l)||(d=$4(),ut.lanes|=d,Vi|=d,o.baseState=!0),l)}function XA(o,l){var d=ze;ze=d!==0&&4>d?d:4,o(!0);var g=J0.transition;J0.transition={};try{o(!1),l()}finally{ze=d,J0.transition=g}}function f5(){return qn().memoizedState}function JA(o,l,d){var g=Ys(o);if(d={lane:g,action:d,hasEagerState:!1,eagerState:null,next:null},p5(o))g5(l,d);else if(d=Ky(o,l,d,g),d!==null){var y=un();dr(d,o,g,y),m5(d,l,g)}}function ZA(o,l,d){var g=Ys(o),y={lane:g,action:d,hasEagerState:!1,eagerState:null,next:null};if(p5(o))g5(l,y);else{var b=o.alternate;if(o.lanes===0&&(b===null||b.lanes===0)&&(b=l.lastRenderedReducer,b!==null))try{var C=l.lastRenderedState,_=b(C,d);if(y.hasEagerState=!0,y.eagerState=_,or(_,C)){var M=l.interleaved;M===null?(y.next=y,q0(l)):(y.next=M.next,M.next=y),l.interleaved=y;return}}catch{}finally{}d=Ky(o,l,y,g),d!==null&&(y=un(),dr(d,o,g,y),m5(d,l,g))}}function p5(o){var l=o.alternate;return o===ut||l!==null&&l===ut}function g5(o,l){sc=Fd=!0;var d=o.pending;d===null?l.next=l:(l.next=d.next,d.next=l),o.pending=l}function m5(o,l,d){if((d&4194240)!==0){var g=l.lanes;g&=o.pendingLanes,d|=g,l.lanes=d,a0(o,d)}}var jd={readContext:Kn,useCallback:Xt,useContext:Xt,useEffect:Xt,useImperativeHandle:Xt,useInsertionEffect:Xt,useLayoutEffect:Xt,useMemo:Xt,useReducer:Xt,useRef:Xt,useState:Xt,useDebugValue:Xt,useDeferredValue:Xt,useTransition:Xt,useMutableSource:Xt,useSyncExternalStore:Xt,useId:Xt,unstable_isNewReconciler:!1},eP={readContext:Kn,useCallback:function(o,l){return _r().memoizedState=[o,l===void 0?null:l],o},useContext:Kn,useEffect:i5,useImperativeHandle:function(o,l,d){return d=d!=null?d.concat([o]):null,Ud(4194308,4,l5.bind(null,l,o),d)},useLayoutEffect:function(o,l){return Ud(4194308,4,o,l)},useInsertionEffect:function(o,l){return Ud(4,2,o,l)},useMemo:function(o,l){var d=_r();return l=l===void 0?null:l,o=o(),d.memoizedState=[o,l],o},useReducer:function(o,l,d){var g=_r();return l=d!==void 0?d(l):l,g.memoizedState=g.baseState=l,o={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:o,lastRenderedState:l},g.queue=o,o=o.dispatch=JA.bind(null,ut,o),[g.memoizedState,o]},useRef:function(o){var l=_r();return o={current:o},l.memoizedState=o},useState:r5,useDebugValue:ip,useDeferredValue:function(o){return _r().memoizedState=o},useTransition:function(){var o=r5(!1),l=o[0];return o=XA.bind(null,o[1]),_r().memoizedState=o,[l,o]},useMutableSource:function(){},useSyncExternalStore:function(o,l,d){var g=ut,y=_r();if(ot){if(d===void 0)throw Error(t(407));d=d()}else{if(d=l(),Rt===null)throw Error(t(349));(Ui&30)!==0||Jy(g,l,d)}y.memoizedState=d;var b={value:d,getSnapshot:l};return y.queue=b,i5(e5.bind(null,g,b,o),[o]),g.flags|=2048,ac(9,Zy.bind(null,g,b,d,l),void 0,null),d},useId:function(){var o=_r(),l=Rt.identifierPrefix;if(ot){var d=ns,g=ts;d=(g&~(1<<32-ir(g)-1)).toString(32)+d,l=":"+l+"R"+d,d=ic++,0<d&&(l+="H"+d.toString(32)),l+=":"}else d=YA++,l=":"+l+"r"+d.toString(32)+":";return o.memoizedState=l},unstable_isNewReconciler:!1},tP={readContext:Kn,useCallback:u5,useContext:Kn,useEffect:sp,useImperativeHandle:c5,useInsertionEffect:o5,useLayoutEffect:a5,useMemo:d5,useReducer:np,useRef:s5,useState:function(){return np(oc)},useDebugValue:ip,useDeferredValue:function(o){var l=qn();return h5(l,Pt.memoizedState,o)},useTransition:function(){var o=np(oc)[0],l=qn().memoizedState;return[o,l]},useMutableSource:Yy,useSyncExternalStore:Xy,useId:f5,unstable_isNewReconciler:!1},nP={readContext:Kn,useCallback:u5,useContext:Kn,useEffect:sp,useImperativeHandle:c5,useInsertionEffect:o5,useLayoutEffect:a5,useMemo:d5,useReducer:rp,useRef:s5,useState:function(){return rp(oc)},useDebugValue:ip,useDeferredValue:function(o){var l=qn();return Pt===null?l.memoizedState=o:h5(l,Pt.memoizedState,o)},useTransition:function(){var o=rp(oc)[0],l=qn().memoizedState;return[o,l]},useMutableSource:Yy,useSyncExternalStore:Xy,useId:f5,unstable_isNewReconciler:!1};function lr(o,l){if(o&&o.defaultProps){l=H({},l),o=o.defaultProps;for(var d in o)l[d]===void 0&&(l[d]=o[d]);return l}return l}function op(o,l,d,g){l=o.memoizedState,d=d(g,l),d=d==null?l:H({},l,d),o.memoizedState=d,o.lanes===0&&(o.updateQueue.baseState=d)}var $d={isMounted:function(o){return(o=o._reactInternals)?Ni(o)===o:!1},enqueueSetState:function(o,l,d){o=o._reactInternals;var g=un(),y=Ys(o),b=ss(g,y);b.payload=l,d!=null&&(b.callback=d),l=qs(o,b,y),l!==null&&(dr(l,o,y,g),Rd(l,o,y))},enqueueReplaceState:function(o,l,d){o=o._reactInternals;var g=un(),y=Ys(o),b=ss(g,y);b.tag=1,b.payload=l,d!=null&&(b.callback=d),l=qs(o,b,y),l!==null&&(dr(l,o,y,g),Rd(l,o,y))},enqueueForceUpdate:function(o,l){o=o._reactInternals;var d=un(),g=Ys(o),y=ss(d,g);y.tag=2,l!=null&&(y.callback=l),l=qs(o,y,g),l!==null&&(dr(l,o,g,d),Rd(l,o,g))}};function y5(o,l,d,g,y,b,C){return o=o.stateNode,typeof o.shouldComponentUpdate=="function"?o.shouldComponentUpdate(g,b,C):l.prototype&&l.prototype.isPureReactComponent?!Wl(d,g)||!Wl(y,b):!0}function w5(o,l,d){var g=!1,y=zs,b=l.contextType;return typeof b=="object"&&b!==null?b=Kn(b):(y=wn(l)?Ri:Yt.current,g=l.contextTypes,b=(g=g!=null)?Xo(o,y):zs),l=new l(d,b),o.memoizedState=l.state!==null&&l.state!==void 0?l.state:null,l.updater=$d,o.stateNode=l,l._reactInternals=o,g&&(o=o.stateNode,o.__reactInternalMemoizedUnmaskedChildContext=y,o.__reactInternalMemoizedMaskedChildContext=b),l}function v5(o,l,d,g){o=l.state,typeof l.componentWillReceiveProps=="function"&&l.componentWillReceiveProps(d,g),typeof l.UNSAFE_componentWillReceiveProps=="function"&&l.UNSAFE_componentWillReceiveProps(d,g),l.state!==o&&$d.enqueueReplaceState(l,l.state,null)}function ap(o,l,d,g){var y=o.stateNode;y.props=d,y.state=o.memoizedState,y.refs={},W0(o);var b=l.contextType;typeof b=="object"&&b!==null?y.context=Kn(b):(b=wn(l)?Ri:Yt.current,y.context=Xo(o,b)),y.state=o.memoizedState,b=l.getDerivedStateFromProps,typeof b=="function"&&(op(o,l,b,d),y.state=o.memoizedState),typeof l.getDerivedStateFromProps=="function"||typeof y.getSnapshotBeforeUpdate=="function"||typeof y.UNSAFE_componentWillMount!="function"&&typeof y.componentWillMount!="function"||(l=y.state,typeof y.componentWillMount=="function"&&y.componentWillMount(),typeof y.UNSAFE_componentWillMount=="function"&&y.UNSAFE_componentWillMount(),l!==y.state&&$d.enqueueReplaceState(y,y.state,null),Ld(o,d,y,g),y.state=o.memoizedState),typeof y.componentDidMount=="function"&&(o.flags|=4194308)}function ia(o,l){try{var d="",g=l;do d+=ie(g),g=g.return;while(g);var y=d}catch(b){y=`
Error generating stack: `+b.message+`
`+b.stack}return{value:o,source:l,stack:y,digest:null}}function lp(o,l,d){return{value:o,source:null,stack:d??null,digest:l??null}}function cp(o,l){try{console.error(l.value)}catch(d){setTimeout(function(){throw d})}}var rP=typeof WeakMap=="function"?WeakMap:Map;function b5(o,l,d){d=ss(-1,d),d.tag=3,d.payload={element:null};var g=l.value;return d.callback=function(){Qd||(Qd=!0,Cp=g),cp(o,l)},d}function x5(o,l,d){d=ss(-1,d),d.tag=3;var g=o.type.getDerivedStateFromError;if(typeof g=="function"){var y=l.value;d.payload=function(){return g(y)},d.callback=function(){cp(o,l)}}var b=o.stateNode;return b!==null&&typeof b.componentDidCatch=="function"&&(d.callback=function(){cp(o,l),typeof g!="function"&&(Gs===null?Gs=new Set([this]):Gs.add(this));var C=l.stack;this.componentDidCatch(l.value,{componentStack:C!==null?C:""})}),d}function S5(o,l,d){var g=o.pingCache;if(g===null){g=o.pingCache=new rP;var y=new Set;g.set(l,y)}else y=g.get(l),y===void 0&&(y=new Set,g.set(l,y));y.has(d)||(y.add(d),o=yP.bind(null,o,l,d),l.then(o,o))}function E5(o){do{var l;if((l=o.tag===13)&&(l=o.memoizedState,l=l!==null?l.dehydrated!==null:!0),l)return o;o=o.return}while(o!==null);return null}function C5(o,l,d,g,y){return(o.mode&1)===0?(o===l?o.flags|=65536:(o.flags|=128,d.flags|=131072,d.flags&=-52805,d.tag===1&&(d.alternate===null?d.tag=17:(l=ss(-1,1),l.tag=2,qs(d,l,1))),d.lanes|=1),o):(o.flags|=65536,o.lanes=y,o)}var sP=F.ReactCurrentOwner,vn=!1;function cn(o,l,d,g){l.child=o===null?Hy(l,null,d,g):ta(l,o.child,d,g)}function k5(o,l,d,g,y){d=d.render;var b=l.ref;return ra(l,y),g=ep(o,l,d,g,b,y),d=tp(),o!==null&&!vn?(l.updateQueue=o.updateQueue,l.flags&=-2053,o.lanes&=~y,is(o,l,y)):(ot&&d&&B0(l),l.flags|=1,cn(o,l,g,y),l.child)}function A5(o,l,d,g,y){if(o===null){var b=d.type;return typeof b=="function"&&!Ip(b)&&b.defaultProps===void 0&&d.compare===null&&d.defaultProps===void 0?(l.tag=15,l.type=b,P5(o,l,b,g,y)):(o=th(d.type,null,g,l,l.mode,y),o.ref=l.ref,o.return=l,l.child=o)}if(b=o.child,(o.lanes&y)===0){var C=b.memoizedProps;if(d=d.compare,d=d!==null?d:Wl,d(C,g)&&o.ref===l.ref)return is(o,l,y)}return l.flags|=1,o=Js(b,g),o.ref=l.ref,o.return=l,l.child=o}function P5(o,l,d,g,y){if(o!==null){var b=o.memoizedProps;if(Wl(b,g)&&o.ref===l.ref)if(vn=!1,l.pendingProps=g=b,(o.lanes&y)!==0)(o.flags&131072)!==0&&(vn=!0);else return l.lanes=o.lanes,is(o,l,y)}return up(o,l,d,g,y)}function T5(o,l,d){var g=l.pendingProps,y=g.children,b=o!==null?o.memoizedState:null;if(g.mode==="hidden")if((l.mode&1)===0)l.memoizedState={baseLanes:0,cachePool:null,transitions:null},Ze(aa,Nn),Nn|=d;else{if((d&1073741824)===0)return o=b!==null?b.baseLanes|d:d,l.lanes=l.childLanes=1073741824,l.memoizedState={baseLanes:o,cachePool:null,transitions:null},l.updateQueue=null,Ze(aa,Nn),Nn|=o,null;l.memoizedState={baseLanes:0,cachePool:null,transitions:null},g=b!==null?b.baseLanes:d,Ze(aa,Nn),Nn|=g}else b!==null?(g=b.baseLanes|d,l.memoizedState=null):g=d,Ze(aa,Nn),Nn|=g;return cn(o,l,y,d),l.child}function _5(o,l){var d=l.ref;(o===null&&d!==null||o!==null&&o.ref!==d)&&(l.flags|=512,l.flags|=2097152)}function up(o,l,d,g,y){var b=wn(d)?Ri:Yt.current;return b=Xo(l,b),ra(l,y),d=ep(o,l,d,g,b,y),g=tp(),o!==null&&!vn?(l.updateQueue=o.updateQueue,l.flags&=-2053,o.lanes&=~y,is(o,l,y)):(ot&&g&&B0(l),l.flags|=1,cn(o,l,d,y),l.child)}function D5(o,l,d,g,y){if(wn(d)){var b=!0;Ad(l)}else b=!1;if(ra(l,y),l.stateNode===null)Hd(o,l),w5(l,d,g),ap(l,d,g,y),g=!0;else if(o===null){var C=l.stateNode,_=l.memoizedProps;C.props=_;var M=C.context,W=d.contextType;typeof W=="object"&&W!==null?W=Kn(W):(W=wn(d)?Ri:Yt.current,W=Xo(l,W));var ne=d.getDerivedStateFromProps,re=typeof ne=="function"||typeof C.getSnapshotBeforeUpdate=="function";re||typeof C.UNSAFE_componentWillReceiveProps!="function"&&typeof C.componentWillReceiveProps!="function"||(_!==g||M!==W)&&v5(l,C,g,W),Ks=!1;var te=l.memoizedState;C.state=te,Ld(l,g,C,y),M=l.memoizedState,_!==g||te!==M||yn.current||Ks?(typeof ne=="function"&&(op(l,d,ne,g),M=l.memoizedState),(_=Ks||y5(l,d,_,g,te,M,W))?(re||typeof C.UNSAFE_componentWillMount!="function"&&typeof C.componentWillMount!="function"||(typeof C.componentWillMount=="function"&&C.componentWillMount(),typeof C.UNSAFE_componentWillMount=="function"&&C.UNSAFE_componentWillMount()),typeof C.componentDidMount=="function"&&(l.flags|=4194308)):(typeof C.componentDidMount=="function"&&(l.flags|=4194308),l.memoizedProps=g,l.memoizedState=M),C.props=g,C.state=M,C.context=W,g=_):(typeof C.componentDidMount=="function"&&(l.flags|=4194308),g=!1)}else{C=l.stateNode,qy(o,l),_=l.memoizedProps,W=l.type===l.elementType?_:lr(l.type,_),C.props=W,re=l.pendingProps,te=C.context,M=d.contextType,typeof M=="object"&&M!==null?M=Kn(M):(M=wn(d)?Ri:Yt.current,M=Xo(l,M));var ce=d.getDerivedStateFromProps;(ne=typeof ce=="function"||typeof C.getSnapshotBeforeUpdate=="function")||typeof C.UNSAFE_componentWillReceiveProps!="function"&&typeof C.componentWillReceiveProps!="function"||(_!==re||te!==M)&&v5(l,C,g,M),Ks=!1,te=l.memoizedState,C.state=te,Ld(l,g,C,y);var he=l.memoizedState;_!==re||te!==he||yn.current||Ks?(typeof ce=="function"&&(op(l,d,ce,g),he=l.memoizedState),(W=Ks||y5(l,d,W,g,te,he,M)||!1)?(ne||typeof C.UNSAFE_componentWillUpdate!="function"&&typeof C.componentWillUpdate!="function"||(typeof C.componentWillUpdate=="function"&&C.componentWillUpdate(g,he,M),typeof C.UNSAFE_componentWillUpdate=="function"&&C.UNSAFE_componentWillUpdate(g,he,M)),typeof C.componentDidUpdate=="function"&&(l.flags|=4),typeof C.getSnapshotBeforeUpdate=="function"&&(l.flags|=1024)):(typeof C.componentDidUpdate!="function"||_===o.memoizedProps&&te===o.memoizedState||(l.flags|=4),typeof C.getSnapshotBeforeUpdate!="function"||_===o.memoizedProps&&te===o.memoizedState||(l.flags|=1024),l.memoizedProps=g,l.memoizedState=he),C.props=g,C.state=he,C.context=M,g=W):(typeof C.componentDidUpdate!="function"||_===o.memoizedProps&&te===o.memoizedState||(l.flags|=4),typeof C.getSnapshotBeforeUpdate!="function"||_===o.memoizedProps&&te===o.memoizedState||(l.flags|=1024),g=!1)}return dp(o,l,d,g,b,y)}function dp(o,l,d,g,y,b){_5(o,l);var C=(l.flags&128)!==0;if(!g&&!C)return y&&Ly(l,d,!1),is(o,l,b);g=l.stateNode,sP.current=l;var _=C&&typeof d.getDerivedStateFromError!="function"?null:g.render();return l.flags|=1,o!==null&&C?(l.child=ta(l,o.child,null,b),l.child=ta(l,null,_,b)):cn(o,l,_,b),l.memoizedState=g.state,y&&Ly(l,d,!0),l.child}function I5(o){var l=o.stateNode;l.pendingContext?My(o,l.pendingContext,l.pendingContext!==l.context):l.context&&My(o,l.context,!1),G0(o,l.containerInfo)}function N5(o,l,d,g,y){return ea(),j0(y),l.flags|=256,cn(o,l,d,g),l.child}var hp={dehydrated:null,treeContext:null,retryLane:0};function fp(o){return{baseLanes:o,cachePool:null,transitions:null}}function M5(o,l,d){var g=l.pendingProps,y=ct.current,b=!1,C=(l.flags&128)!==0,_;if((_=C)||(_=o!==null&&o.memoizedState===null?!1:(y&2)!==0),_?(b=!0,l.flags&=-129):(o===null||o.memoizedState!==null)&&(y|=1),Ze(ct,y&1),o===null)return V0(l),o=l.memoizedState,o!==null&&(o=o.dehydrated,o!==null)?((l.mode&1)===0?l.lanes=1:o.data==="$!"?l.lanes=8:l.lanes=1073741824,null):(C=g.children,o=g.fallback,b?(g=l.mode,b=l.child,C={mode:"hidden",children:C},(g&1)===0&&b!==null?(b.childLanes=0,b.pendingProps=C):b=nh(C,g,0,null),o=Hi(o,g,d,null),b.return=l,o.return=l,b.sibling=o,l.child=b,l.child.memoizedState=fp(d),l.memoizedState=hp,o):pp(l,C));if(y=o.memoizedState,y!==null&&(_=y.dehydrated,_!==null))return iP(o,l,C,g,_,y,d);if(b){b=g.fallback,C=l.mode,y=o.child,_=y.sibling;var M={mode:"hidden",children:g.children};return(C&1)===0&&l.child!==y?(g=l.child,g.childLanes=0,g.pendingProps=M,l.deletions=null):(g=Js(y,M),g.subtreeFlags=y.subtreeFlags&14680064),_!==null?b=Js(_,b):(b=Hi(b,C,d,null),b.flags|=2),b.return=l,g.return=l,g.sibling=b,l.child=g,g=b,b=l.child,C=o.child.memoizedState,C=C===null?fp(d):{baseLanes:C.baseLanes|d,cachePool:null,transitions:C.transitions},b.memoizedState=C,b.childLanes=o.childLanes&~d,l.memoizedState=hp,g}return b=o.child,o=b.sibling,g=Js(b,{mode:"visible",children:g.children}),(l.mode&1)===0&&(g.lanes=d),g.return=l,g.sibling=null,o!==null&&(d=l.deletions,d===null?(l.deletions=[o],l.flags|=16):d.push(o)),l.child=g,l.memoizedState=null,g}function pp(o,l){return l=nh({mode:"visible",children:l},o.mode,0,null),l.return=o,o.child=l}function zd(o,l,d,g){return g!==null&&j0(g),ta(l,o.child,null,d),o=pp(l,l.pendingProps.children),o.flags|=2,l.memoizedState=null,o}function iP(o,l,d,g,y,b,C){if(d)return l.flags&256?(l.flags&=-257,g=lp(Error(t(422))),zd(o,l,C,g)):l.memoizedState!==null?(l.child=o.child,l.flags|=128,null):(b=g.fallback,y=l.mode,g=nh({mode:"visible",children:g.children},y,0,null),b=Hi(b,y,C,null),b.flags|=2,g.return=l,b.return=l,g.sibling=b,l.child=g,(l.mode&1)!==0&&ta(l,o.child,null,C),l.child.memoizedState=fp(C),l.memoizedState=hp,b);if((l.mode&1)===0)return zd(o,l,C,null);if(y.data==="$!"){if(g=y.nextSibling&&y.nextSibling.dataset,g)var _=g.dgst;return g=_,b=Error(t(419)),g=lp(b,g,void 0),zd(o,l,C,g)}if(_=(C&o.childLanes)!==0,vn||_){if(g=Rt,g!==null){switch(C&-C){case 4:y=2;break;case 16:y=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:y=32;break;case 536870912:y=268435456;break;default:y=0}y=(y&(g.suspendedLanes|C))!==0?0:y,y!==0&&y!==b.retryLane&&(b.retryLane=y,rs(o,y),dr(g,o,y,-1))}return Dp(),g=lp(Error(t(421))),zd(o,l,C,g)}return y.data==="$?"?(l.flags|=128,l.child=o.child,l=wP.bind(null,o),y._reactRetry=l,null):(o=b.treeContext,In=js(y.nextSibling),Dn=l,ot=!0,ar=null,o!==null&&(zn[Hn++]=ts,zn[Hn++]=ns,zn[Hn++]=Li,ts=o.id,ns=o.overflow,Li=l),l=pp(l,g.children),l.flags|=4096,l)}function R5(o,l,d){o.lanes|=l;var g=o.alternate;g!==null&&(g.lanes|=l),K0(o.return,l,d)}function gp(o,l,d,g,y){var b=o.memoizedState;b===null?o.memoizedState={isBackwards:l,rendering:null,renderingStartTime:0,last:g,tail:d,tailMode:y}:(b.isBackwards=l,b.rendering=null,b.renderingStartTime=0,b.last=g,b.tail=d,b.tailMode=y)}function L5(o,l,d){var g=l.pendingProps,y=g.revealOrder,b=g.tail;if(cn(o,l,g.children,d),g=ct.current,(g&2)!==0)g=g&1|2,l.flags|=128;else{if(o!==null&&(o.flags&128)!==0)e:for(o=l.child;o!==null;){if(o.tag===13)o.memoizedState!==null&&R5(o,d,l);else if(o.tag===19)R5(o,d,l);else if(o.child!==null){o.child.return=o,o=o.child;continue}if(o===l)break e;for(;o.sibling===null;){if(o.return===null||o.return===l)break e;o=o.return}o.sibling.return=o.return,o=o.sibling}g&=1}if(Ze(ct,g),(l.mode&1)===0)l.memoizedState=null;else switch(y){case"forwards":for(d=l.child,y=null;d!==null;)o=d.alternate,o!==null&&Od(o)===null&&(y=d),d=d.sibling;d=y,d===null?(y=l.child,l.child=null):(y=d.sibling,d.sibling=null),gp(l,!1,y,d,b);break;case"backwards":for(d=null,y=l.child,l.child=null;y!==null;){if(o=y.alternate,o!==null&&Od(o)===null){l.child=y;break}o=y.sibling,y.sibling=d,d=y,y=o}gp(l,!0,d,null,b);break;case"together":gp(l,!1,null,null,void 0);break;default:l.memoizedState=null}return l.child}function Hd(o,l){(l.mode&1)===0&&o!==null&&(o.alternate=null,l.alternate=null,l.flags|=2)}function is(o,l,d){if(o!==null&&(l.dependencies=o.dependencies),Vi|=l.lanes,(d&l.childLanes)===0)return null;if(o!==null&&l.child!==o.child)throw Error(t(153));if(l.child!==null){for(o=l.child,d=Js(o,o.pendingProps),l.child=d,d.return=l;o.sibling!==null;)o=o.sibling,d=d.sibling=Js(o,o.pendingProps),d.return=l;d.sibling=null}return l.child}function oP(o,l,d){switch(l.tag){case 3:I5(l),ea();break;case 5:Qy(l);break;case 1:wn(l.type)&&Ad(l);break;case 4:G0(l,l.stateNode.containerInfo);break;case 10:var g=l.type._context,y=l.memoizedProps.value;Ze(Nd,g._currentValue),g._currentValue=y;break;case 13:if(g=l.memoizedState,g!==null)return g.dehydrated!==null?(Ze(ct,ct.current&1),l.flags|=128,null):(d&l.child.childLanes)!==0?M5(o,l,d):(Ze(ct,ct.current&1),o=is(o,l,d),o!==null?o.sibling:null);Ze(ct,ct.current&1);break;case 19:if(g=(d&l.childLanes)!==0,(o.flags&128)!==0){if(g)return L5(o,l,d);l.flags|=128}if(y=l.memoizedState,y!==null&&(y.rendering=null,y.tail=null,y.lastEffect=null),Ze(ct,ct.current),g)break;return null;case 22:case 23:return l.lanes=0,T5(o,l,d)}return is(o,l,d)}var O5,mp,B5,F5;O5=function(o,l){for(var d=l.child;d!==null;){if(d.tag===5||d.tag===6)o.appendChild(d.stateNode);else if(d.tag!==4&&d.child!==null){d.child.return=d,d=d.child;continue}if(d===l)break;for(;d.sibling===null;){if(d.return===null||d.return===l)return;d=d.return}d.sibling.return=d.return,d=d.sibling}},mp=function(){},B5=function(o,l,d,g){var y=o.memoizedProps;if(y!==g){o=l.stateNode,Fi(Tr.current);var b=null;switch(d){case"input":y=Fo(o,y),g=Fo(o,g),b=[];break;case"select":y=H({},y,{value:void 0}),g=H({},g,{value:void 0}),b=[];break;case"textarea":y=G1(o,y),g=G1(o,g),b=[];break;default:typeof y.onClick!="function"&&typeof g.onClick=="function"&&(o.onclick=Ed)}Y1(d,g);var C;d=null;for(W in y)if(!g.hasOwnProperty(W)&&y.hasOwnProperty(W)&&y[W]!=null)if(W==="style"){var _=y[W];for(C in _)_.hasOwnProperty(C)&&(d||(d={}),d[C]="")}else W!=="dangerouslySetInnerHTML"&&W!=="children"&&W!=="suppressContentEditableWarning"&&W!=="suppressHydrationWarning"&&W!=="autoFocus"&&(s.hasOwnProperty(W)?b||(b=[]):(b=b||[]).push(W,null));for(W in g){var M=g[W];if(_=y?.[W],g.hasOwnProperty(W)&&M!==_&&(M!=null||_!=null))if(W==="style")if(_){for(C in _)!_.hasOwnProperty(C)||M&&M.hasOwnProperty(C)||(d||(d={}),d[C]="");for(C in M)M.hasOwnProperty(C)&&_[C]!==M[C]&&(d||(d={}),d[C]=M[C])}else d||(b||(b=[]),b.push(W,d)),d=M;else W==="dangerouslySetInnerHTML"?(M=M?M.__html:void 0,_=_?_.__html:void 0,M!=null&&_!==M&&(b=b||[]).push(W,M)):W==="children"?typeof M!="string"&&typeof M!="number"||(b=b||[]).push(W,""+M):W!=="suppressContentEditableWarning"&&W!=="suppressHydrationWarning"&&(s.hasOwnProperty(W)?(M!=null&&W==="onScroll"&&rt("scroll",o),b||_===M||(b=[])):(b=b||[]).push(W,M))}d&&(b=b||[]).push("style",d);var W=b;(l.updateQueue=W)&&(l.flags|=4)}},F5=function(o,l,d,g){d!==g&&(l.flags|=4)};function lc(o,l){if(!ot)switch(o.tailMode){case"hidden":l=o.tail;for(var d=null;l!==null;)l.alternate!==null&&(d=l),l=l.sibling;d===null?o.tail=null:d.sibling=null;break;case"collapsed":d=o.tail;for(var g=null;d!==null;)d.alternate!==null&&(g=d),d=d.sibling;g===null?l||o.tail===null?o.tail=null:o.tail.sibling=null:g.sibling=null}}function Jt(o){var l=o.alternate!==null&&o.alternate.child===o.child,d=0,g=0;if(l)for(var y=o.child;y!==null;)d|=y.lanes|y.childLanes,g|=y.subtreeFlags&14680064,g|=y.flags&14680064,y.return=o,y=y.sibling;else for(y=o.child;y!==null;)d|=y.lanes|y.childLanes,g|=y.subtreeFlags,g|=y.flags,y.return=o,y=y.sibling;return o.subtreeFlags|=g,o.childLanes=d,l}function aP(o,l,d){var g=l.pendingProps;switch(F0(l),l.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Jt(l),null;case 1:return wn(l.type)&&kd(),Jt(l),null;case 3:return g=l.stateNode,sa(),st(yn),st(Yt),X0(),g.pendingContext&&(g.context=g.pendingContext,g.pendingContext=null),(o===null||o.child===null)&&(Dd(l)?l.flags|=4:o===null||o.memoizedState.isDehydrated&&(l.flags&256)===0||(l.flags|=1024,ar!==null&&(Pp(ar),ar=null))),mp(o,l),Jt(l),null;case 5:Q0(l);var y=Fi(rc.current);if(d=l.type,o!==null&&l.stateNode!=null)B5(o,l,d,g,y),o.ref!==l.ref&&(l.flags|=512,l.flags|=2097152);else{if(!g){if(l.stateNode===null)throw Error(t(166));return Jt(l),null}if(o=Fi(Tr.current),Dd(l)){g=l.stateNode,d=l.type;var b=l.memoizedProps;switch(g[Pr]=l,g[Jl]=b,o=(l.mode&1)!==0,d){case"dialog":rt("cancel",g),rt("close",g);break;case"iframe":case"object":case"embed":rt("load",g);break;case"video":case"audio":for(y=0;y<Ql.length;y++)rt(Ql[y],g);break;case"source":rt("error",g);break;case"img":case"image":case"link":rt("error",g),rt("load",g);break;case"details":rt("toggle",g);break;case"input":Tl(g,b),rt("invalid",g);break;case"select":g._wrapperState={wasMultiple:!!b.multiple},rt("invalid",g);break;case"textarea":x4(g,b),rt("invalid",g)}Y1(d,b),y=null;for(var C in b)if(b.hasOwnProperty(C)){var _=b[C];C==="children"?typeof _=="string"?g.textContent!==_&&(b.suppressHydrationWarning!==!0&&Sd(g.textContent,_,o),y=["children",_]):typeof _=="number"&&g.textContent!==""+_&&(b.suppressHydrationWarning!==!0&&Sd(g.textContent,_,o),y=["children",""+_]):s.hasOwnProperty(C)&&_!=null&&C==="onScroll"&&rt("scroll",g)}switch(d){case"input":At(g),b4(g,b,!0);break;case"textarea":At(g),E4(g);break;case"select":case"option":break;default:typeof b.onClick=="function"&&(g.onclick=Ed)}g=y,l.updateQueue=g,g!==null&&(l.flags|=4)}else{C=y.nodeType===9?y:y.ownerDocument,o==="http://www.w3.org/1999/xhtml"&&(o=C4(d)),o==="http://www.w3.org/1999/xhtml"?d==="script"?(o=C.createElement("div"),o.innerHTML="<script><\/script>",o=o.removeChild(o.firstChild)):typeof g.is=="string"?o=C.createElement(d,{is:g.is}):(o=C.createElement(d),d==="select"&&(C=o,g.multiple?C.multiple=!0:g.size&&(C.size=g.size))):o=C.createElementNS(o,d),o[Pr]=l,o[Jl]=g,O5(o,l,!1,!1),l.stateNode=o;e:{switch(C=X1(d,g),d){case"dialog":rt("cancel",o),rt("close",o),y=g;break;case"iframe":case"object":case"embed":rt("load",o),y=g;break;case"video":case"audio":for(y=0;y<Ql.length;y++)rt(Ql[y],o);y=g;break;case"source":rt("error",o),y=g;break;case"img":case"image":case"link":rt("error",o),rt("load",o),y=g;break;case"details":rt("toggle",o),y=g;break;case"input":Tl(o,g),y=Fo(o,g),rt("invalid",o);break;case"option":y=g;break;case"select":o._wrapperState={wasMultiple:!!g.multiple},y=H({},g,{value:void 0}),rt("invalid",o);break;case"textarea":x4(o,g),y=G1(o,g),rt("invalid",o);break;default:y=g}Y1(d,y),_=y;for(b in _)if(_.hasOwnProperty(b)){var M=_[b];b==="style"?P4(o,M):b==="dangerouslySetInnerHTML"?(M=M?M.__html:void 0,M!=null&&k4(o,M)):b==="children"?typeof M=="string"?(d!=="textarea"||M!=="")&&Dl(o,M):typeof M=="number"&&Dl(o,""+M):b!=="suppressContentEditableWarning"&&b!=="suppressHydrationWarning"&&b!=="autoFocus"&&(s.hasOwnProperty(b)?M!=null&&b==="onScroll"&&rt("scroll",o):M!=null&&k(o,b,M,C))}switch(d){case"input":At(o),b4(o,g,!1);break;case"textarea":At(o),E4(o);break;case"option":g.value!=null&&o.setAttribute("value",""+ve(g.value));break;case"select":o.multiple=!!g.multiple,b=g.value,b!=null?Uo(o,!!g.multiple,b,!1):g.defaultValue!=null&&Uo(o,!!g.multiple,g.defaultValue,!0);break;default:typeof y.onClick=="function"&&(o.onclick=Ed)}switch(d){case"button":case"input":case"select":case"textarea":g=!!g.autoFocus;break e;case"img":g=!0;break e;default:g=!1}}g&&(l.flags|=4)}l.ref!==null&&(l.flags|=512,l.flags|=2097152)}return Jt(l),null;case 6:if(o&&l.stateNode!=null)F5(o,l,o.memoizedProps,g);else{if(typeof g!="string"&&l.stateNode===null)throw Error(t(166));if(d=Fi(rc.current),Fi(Tr.current),Dd(l)){if(g=l.stateNode,d=l.memoizedProps,g[Pr]=l,(b=g.nodeValue!==d)&&(o=Dn,o!==null))switch(o.tag){case 3:Sd(g.nodeValue,d,(o.mode&1)!==0);break;case 5:o.memoizedProps.suppressHydrationWarning!==!0&&Sd(g.nodeValue,d,(o.mode&1)!==0)}b&&(l.flags|=4)}else g=(d.nodeType===9?d:d.ownerDocument).createTextNode(g),g[Pr]=l,l.stateNode=g}return Jt(l),null;case 13:if(st(ct),g=l.memoizedState,o===null||o.memoizedState!==null&&o.memoizedState.dehydrated!==null){if(ot&&In!==null&&(l.mode&1)!==0&&(l.flags&128)===0)jy(),ea(),l.flags|=98560,b=!1;else if(b=Dd(l),g!==null&&g.dehydrated!==null){if(o===null){if(!b)throw Error(t(318));if(b=l.memoizedState,b=b!==null?b.dehydrated:null,!b)throw Error(t(317));b[Pr]=l}else ea(),(l.flags&128)===0&&(l.memoizedState=null),l.flags|=4;Jt(l),b=!1}else ar!==null&&(Pp(ar),ar=null),b=!0;if(!b)return l.flags&65536?l:null}return(l.flags&128)!==0?(l.lanes=d,l):(g=g!==null,g!==(o!==null&&o.memoizedState!==null)&&g&&(l.child.flags|=8192,(l.mode&1)!==0&&(o===null||(ct.current&1)!==0?Tt===0&&(Tt=3):Dp())),l.updateQueue!==null&&(l.flags|=4),Jt(l),null);case 4:return sa(),mp(o,l),o===null&&Yl(l.stateNode.containerInfo),Jt(l),null;case 10:return H0(l.type._context),Jt(l),null;case 17:return wn(l.type)&&kd(),Jt(l),null;case 19:if(st(ct),b=l.memoizedState,b===null)return Jt(l),null;if(g=(l.flags&128)!==0,C=b.rendering,C===null)if(g)lc(b,!1);else{if(Tt!==0||o!==null&&(o.flags&128)!==0)for(o=l.child;o!==null;){if(C=Od(o),C!==null){for(l.flags|=128,lc(b,!1),g=C.updateQueue,g!==null&&(l.updateQueue=g,l.flags|=4),l.subtreeFlags=0,g=d,d=l.child;d!==null;)b=d,o=g,b.flags&=14680066,C=b.alternate,C===null?(b.childLanes=0,b.lanes=o,b.child=null,b.subtreeFlags=0,b.memoizedProps=null,b.memoizedState=null,b.updateQueue=null,b.dependencies=null,b.stateNode=null):(b.childLanes=C.childLanes,b.lanes=C.lanes,b.child=C.child,b.subtreeFlags=0,b.deletions=null,b.memoizedProps=C.memoizedProps,b.memoizedState=C.memoizedState,b.updateQueue=C.updateQueue,b.type=C.type,o=C.dependencies,b.dependencies=o===null?null:{lanes:o.lanes,firstContext:o.firstContext}),d=d.sibling;return Ze(ct,ct.current&1|2),l.child}o=o.sibling}b.tail!==null&&wt()>la&&(l.flags|=128,g=!0,lc(b,!1),l.lanes=4194304)}else{if(!g)if(o=Od(C),o!==null){if(l.flags|=128,g=!0,d=o.updateQueue,d!==null&&(l.updateQueue=d,l.flags|=4),lc(b,!0),b.tail===null&&b.tailMode==="hidden"&&!C.alternate&&!ot)return Jt(l),null}else 2*wt()-b.renderingStartTime>la&&d!==1073741824&&(l.flags|=128,g=!0,lc(b,!1),l.lanes=4194304);b.isBackwards?(C.sibling=l.child,l.child=C):(d=b.last,d!==null?d.sibling=C:l.child=C,b.last=C)}return b.tail!==null?(l=b.tail,b.rendering=l,b.tail=l.sibling,b.renderingStartTime=wt(),l.sibling=null,d=ct.current,Ze(ct,g?d&1|2:d&1),l):(Jt(l),null);case 22:case 23:return _p(),g=l.memoizedState!==null,o!==null&&o.memoizedState!==null!==g&&(l.flags|=8192),g&&(l.mode&1)!==0?(Nn&1073741824)!==0&&(Jt(l),l.subtreeFlags&6&&(l.flags|=8192)):Jt(l),null;case 24:return null;case 25:return null}throw Error(t(156,l.tag))}function lP(o,l){switch(F0(l),l.tag){case 1:return wn(l.type)&&kd(),o=l.flags,o&65536?(l.flags=o&-65537|128,l):null;case 3:return sa(),st(yn),st(Yt),X0(),o=l.flags,(o&65536)!==0&&(o&128)===0?(l.flags=o&-65537|128,l):null;case 5:return Q0(l),null;case 13:if(st(ct),o=l.memoizedState,o!==null&&o.dehydrated!==null){if(l.alternate===null)throw Error(t(340));ea()}return o=l.flags,o&65536?(l.flags=o&-65537|128,l):null;case 19:return st(ct),null;case 4:return sa(),null;case 10:return H0(l.type._context),null;case 22:case 23:return _p(),null;case 24:return null;default:return null}}var Kd=!1,Zt=!1,cP=typeof WeakSet=="function"?WeakSet:Set,de=null;function oa(o,l){var d=o.ref;if(d!==null)if(typeof d=="function")try{d(null)}catch(g){pt(o,l,g)}else d.current=null}function yp(o,l,d){try{d()}catch(g){pt(o,l,g)}}var U5=!1;function uP(o,l){if(_0=dd,o=yy(),x0(o)){if("selectionStart"in o)var d={start:o.selectionStart,end:o.selectionEnd};else e:{d=(d=o.ownerDocument)&&d.defaultView||window;var g=d.getSelection&&d.getSelection();if(g&&g.rangeCount!==0){d=g.anchorNode;var y=g.anchorOffset,b=g.focusNode;g=g.focusOffset;try{d.nodeType,b.nodeType}catch{d=null;break e}var C=0,_=-1,M=-1,W=0,ne=0,re=o,te=null;t:for(;;){for(var ce;re!==d||y!==0&&re.nodeType!==3||(_=C+y),re!==b||g!==0&&re.nodeType!==3||(M=C+g),re.nodeType===3&&(C+=re.nodeValue.length),(ce=re.firstChild)!==null;)te=re,re=ce;for(;;){if(re===o)break t;if(te===d&&++W===y&&(_=C),te===b&&++ne===g&&(M=C),(ce=re.nextSibling)!==null)break;re=te,te=re.parentNode}re=ce}d=_===-1||M===-1?null:{start:_,end:M}}else d=null}d=d||{start:0,end:0}}else d=null;for(D0={focusedElem:o,selectionRange:d},dd=!1,de=l;de!==null;)if(l=de,o=l.child,(l.subtreeFlags&1028)!==0&&o!==null)o.return=l,de=o;else for(;de!==null;){l=de;try{var he=l.alternate;if((l.flags&1024)!==0)switch(l.tag){case 0:case 11:case 15:break;case 1:if(he!==null){var fe=he.memoizedProps,vt=he.memoizedState,z=l.stateNode,U=z.getSnapshotBeforeUpdate(l.elementType===l.type?fe:lr(l.type,fe),vt);z.__reactInternalSnapshotBeforeUpdate=U}break;case 3:var q=l.stateNode.containerInfo;q.nodeType===1?q.textContent="":q.nodeType===9&&q.documentElement&&q.removeChild(q.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(t(163))}}catch(se){pt(l,l.return,se)}if(o=l.sibling,o!==null){o.return=l.return,de=o;break}de=l.return}return he=U5,U5=!1,he}function cc(o,l,d){var g=l.updateQueue;if(g=g!==null?g.lastEffect:null,g!==null){var y=g=g.next;do{if((y.tag&o)===o){var b=y.destroy;y.destroy=void 0,b!==void 0&&yp(l,d,b)}y=y.next}while(y!==g)}}function qd(o,l){if(l=l.updateQueue,l=l!==null?l.lastEffect:null,l!==null){var d=l=l.next;do{if((d.tag&o)===o){var g=d.create;d.destroy=g()}d=d.next}while(d!==l)}}function wp(o){var l=o.ref;if(l!==null){var d=o.stateNode;switch(o.tag){case 5:o=d;break;default:o=d}typeof l=="function"?l(o):l.current=o}}function V5(o){var l=o.alternate;l!==null&&(o.alternate=null,V5(l)),o.child=null,o.deletions=null,o.sibling=null,o.tag===5&&(l=o.stateNode,l!==null&&(delete l[Pr],delete l[Jl],delete l[R0],delete l[qA],delete l[WA])),o.stateNode=null,o.return=null,o.dependencies=null,o.memoizedProps=null,o.memoizedState=null,o.pendingProps=null,o.stateNode=null,o.updateQueue=null}function j5(o){return o.tag===5||o.tag===3||o.tag===4}function $5(o){e:for(;;){for(;o.sibling===null;){if(o.return===null||j5(o.return))return null;o=o.return}for(o.sibling.return=o.return,o=o.sibling;o.tag!==5&&o.tag!==6&&o.tag!==18;){if(o.flags&2||o.child===null||o.tag===4)continue e;o.child.return=o,o=o.child}if(!(o.flags&2))return o.stateNode}}function vp(o,l,d){var g=o.tag;if(g===5||g===6)o=o.stateNode,l?d.nodeType===8?d.parentNode.insertBefore(o,l):d.insertBefore(o,l):(d.nodeType===8?(l=d.parentNode,l.insertBefore(o,d)):(l=d,l.appendChild(o)),d=d._reactRootContainer,d!=null||l.onclick!==null||(l.onclick=Ed));else if(g!==4&&(o=o.child,o!==null))for(vp(o,l,d),o=o.sibling;o!==null;)vp(o,l,d),o=o.sibling}function bp(o,l,d){var g=o.tag;if(g===5||g===6)o=o.stateNode,l?d.insertBefore(o,l):d.appendChild(o);else if(g!==4&&(o=o.child,o!==null))for(bp(o,l,d),o=o.sibling;o!==null;)bp(o,l,d),o=o.sibling}var Vt=null,cr=!1;function Ws(o,l,d){for(d=d.child;d!==null;)z5(o,l,d),d=d.sibling}function z5(o,l,d){if(Ar&&typeof Ar.onCommitFiberUnmount=="function")try{Ar.onCommitFiberUnmount(id,d)}catch{}switch(d.tag){case 5:Zt||oa(d,l);case 6:var g=Vt,y=cr;Vt=null,Ws(o,l,d),Vt=g,cr=y,Vt!==null&&(cr?(o=Vt,d=d.stateNode,o.nodeType===8?o.parentNode.removeChild(d):o.removeChild(d)):Vt.removeChild(d.stateNode));break;case 18:Vt!==null&&(cr?(o=Vt,d=d.stateNode,o.nodeType===8?M0(o.parentNode,d):o.nodeType===1&&M0(o,d),jl(o)):M0(Vt,d.stateNode));break;case 4:g=Vt,y=cr,Vt=d.stateNode.containerInfo,cr=!0,Ws(o,l,d),Vt=g,cr=y;break;case 0:case 11:case 14:case 15:if(!Zt&&(g=d.updateQueue,g!==null&&(g=g.lastEffect,g!==null))){y=g=g.next;do{var b=y,C=b.destroy;b=b.tag,C!==void 0&&((b&2)!==0||(b&4)!==0)&&yp(d,l,C),y=y.next}while(y!==g)}Ws(o,l,d);break;case 1:if(!Zt&&(oa(d,l),g=d.stateNode,typeof g.componentWillUnmount=="function"))try{g.props=d.memoizedProps,g.state=d.memoizedState,g.componentWillUnmount()}catch(_){pt(d,l,_)}Ws(o,l,d);break;case 21:Ws(o,l,d);break;case 22:d.mode&1?(Zt=(g=Zt)||d.memoizedState!==null,Ws(o,l,d),Zt=g):Ws(o,l,d);break;default:Ws(o,l,d)}}function H5(o){var l=o.updateQueue;if(l!==null){o.updateQueue=null;var d=o.stateNode;d===null&&(d=o.stateNode=new cP),l.forEach(function(g){var y=vP.bind(null,o,g);d.has(g)||(d.add(g),g.then(y,y))})}}function ur(o,l){var d=l.deletions;if(d!==null)for(var g=0;g<d.length;g++){var y=d[g];try{var b=o,C=l,_=C;e:for(;_!==null;){switch(_.tag){case 5:Vt=_.stateNode,cr=!1;break e;case 3:Vt=_.stateNode.containerInfo,cr=!0;break e;case 4:Vt=_.stateNode.containerInfo,cr=!0;break e}_=_.return}if(Vt===null)throw Error(t(160));z5(b,C,y),Vt=null,cr=!1;var M=y.alternate;M!==null&&(M.return=null),y.return=null}catch(W){pt(y,l,W)}}if(l.subtreeFlags&12854)for(l=l.child;l!==null;)K5(l,o),l=l.sibling}function K5(o,l){var d=o.alternate,g=o.flags;switch(o.tag){case 0:case 11:case 14:case 15:if(ur(l,o),Dr(o),g&4){try{cc(3,o,o.return),qd(3,o)}catch(fe){pt(o,o.return,fe)}try{cc(5,o,o.return)}catch(fe){pt(o,o.return,fe)}}break;case 1:ur(l,o),Dr(o),g&512&&d!==null&&oa(d,d.return);break;case 5:if(ur(l,o),Dr(o),g&512&&d!==null&&oa(d,d.return),o.flags&32){var y=o.stateNode;try{Dl(y,"")}catch(fe){pt(o,o.return,fe)}}if(g&4&&(y=o.stateNode,y!=null)){var b=o.memoizedProps,C=d!==null?d.memoizedProps:b,_=o.type,M=o.updateQueue;if(o.updateQueue=null,M!==null)try{_==="input"&&b.type==="radio"&&b.name!=null&&v4(y,b),X1(_,C);var W=X1(_,b);for(C=0;C<M.length;C+=2){var ne=M[C],re=M[C+1];ne==="style"?P4(y,re):ne==="dangerouslySetInnerHTML"?k4(y,re):ne==="children"?Dl(y,re):k(y,ne,re,W)}switch(_){case"input":q1(y,b);break;case"textarea":S4(y,b);break;case"select":var te=y._wrapperState.wasMultiple;y._wrapperState.wasMultiple=!!b.multiple;var ce=b.value;ce!=null?Uo(y,!!b.multiple,ce,!1):te!==!!b.multiple&&(b.defaultValue!=null?Uo(y,!!b.multiple,b.defaultValue,!0):Uo(y,!!b.multiple,b.multiple?[]:"",!1))}y[Jl]=b}catch(fe){pt(o,o.return,fe)}}break;case 6:if(ur(l,o),Dr(o),g&4){if(o.stateNode===null)throw Error(t(162));y=o.stateNode,b=o.memoizedProps;try{y.nodeValue=b}catch(fe){pt(o,o.return,fe)}}break;case 3:if(ur(l,o),Dr(o),g&4&&d!==null&&d.memoizedState.isDehydrated)try{jl(l.containerInfo)}catch(fe){pt(o,o.return,fe)}break;case 4:ur(l,o),Dr(o);break;case 13:ur(l,o),Dr(o),y=o.child,y.flags&8192&&(b=y.memoizedState!==null,y.stateNode.isHidden=b,!b||y.alternate!==null&&y.alternate.memoizedState!==null||(Ep=wt())),g&4&&H5(o);break;case 22:if(ne=d!==null&&d.memoizedState!==null,o.mode&1?(Zt=(W=Zt)||ne,ur(l,o),Zt=W):ur(l,o),Dr(o),g&8192){if(W=o.memoizedState!==null,(o.stateNode.isHidden=W)&&!ne&&(o.mode&1)!==0)for(de=o,ne=o.child;ne!==null;){for(re=de=ne;de!==null;){switch(te=de,ce=te.child,te.tag){case 0:case 11:case 14:case 15:cc(4,te,te.return);break;case 1:oa(te,te.return);var he=te.stateNode;if(typeof he.componentWillUnmount=="function"){g=te,d=te.return;try{l=g,he.props=l.memoizedProps,he.state=l.memoizedState,he.componentWillUnmount()}catch(fe){pt(g,d,fe)}}break;case 5:oa(te,te.return);break;case 22:if(te.memoizedState!==null){G5(re);continue}}ce!==null?(ce.return=te,de=ce):G5(re)}ne=ne.sibling}e:for(ne=null,re=o;;){if(re.tag===5){if(ne===null){ne=re;try{y=re.stateNode,W?(b=y.style,typeof b.setProperty=="function"?b.setProperty("display","none","important"):b.display="none"):(_=re.stateNode,M=re.memoizedProps.style,C=M!=null&&M.hasOwnProperty("display")?M.display:null,_.style.display=A4("display",C))}catch(fe){pt(o,o.return,fe)}}}else if(re.tag===6){if(ne===null)try{re.stateNode.nodeValue=W?"":re.memoizedProps}catch(fe){pt(o,o.return,fe)}}else if((re.tag!==22&&re.tag!==23||re.memoizedState===null||re===o)&&re.child!==null){re.child.return=re,re=re.child;continue}if(re===o)break e;for(;re.sibling===null;){if(re.return===null||re.return===o)break e;ne===re&&(ne=null),re=re.return}ne===re&&(ne=null),re.sibling.return=re.return,re=re.sibling}}break;case 19:ur(l,o),Dr(o),g&4&&H5(o);break;case 21:break;default:ur(l,o),Dr(o)}}function Dr(o){var l=o.flags;if(l&2){try{e:{for(var d=o.return;d!==null;){if(j5(d)){var g=d;break e}d=d.return}throw Error(t(160))}switch(g.tag){case 5:var y=g.stateNode;g.flags&32&&(Dl(y,""),g.flags&=-33);var b=$5(o);bp(o,b,y);break;case 3:case 4:var C=g.stateNode.containerInfo,_=$5(o);vp(o,_,C);break;default:throw Error(t(161))}}catch(M){pt(o,o.return,M)}o.flags&=-3}l&4096&&(o.flags&=-4097)}function dP(o,l,d){de=o,q5(o)}function q5(o,l,d){for(var g=(o.mode&1)!==0;de!==null;){var y=de,b=y.child;if(y.tag===22&&g){var C=y.memoizedState!==null||Kd;if(!C){var _=y.alternate,M=_!==null&&_.memoizedState!==null||Zt;_=Kd;var W=Zt;if(Kd=C,(Zt=M)&&!W)for(de=y;de!==null;)C=de,M=C.child,C.tag===22&&C.memoizedState!==null?Q5(y):M!==null?(M.return=C,de=M):Q5(y);for(;b!==null;)de=b,q5(b),b=b.sibling;de=y,Kd=_,Zt=W}W5(o)}else(y.subtreeFlags&8772)!==0&&b!==null?(b.return=y,de=b):W5(o)}}function W5(o){for(;de!==null;){var l=de;if((l.flags&8772)!==0){var d=l.alternate;try{if((l.flags&8772)!==0)switch(l.tag){case 0:case 11:case 15:Zt||qd(5,l);break;case 1:var g=l.stateNode;if(l.flags&4&&!Zt)if(d===null)g.componentDidMount();else{var y=l.elementType===l.type?d.memoizedProps:lr(l.type,d.memoizedProps);g.componentDidUpdate(y,d.memoizedState,g.__reactInternalSnapshotBeforeUpdate)}var b=l.updateQueue;b!==null&&Gy(l,b,g);break;case 3:var C=l.updateQueue;if(C!==null){if(d=null,l.child!==null)switch(l.child.tag){case 5:d=l.child.stateNode;break;case 1:d=l.child.stateNode}Gy(l,C,d)}break;case 5:var _=l.stateNode;if(d===null&&l.flags&4){d=_;var M=l.memoizedProps;switch(l.type){case"button":case"input":case"select":case"textarea":M.autoFocus&&d.focus();break;case"img":M.src&&(d.src=M.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(l.memoizedState===null){var W=l.alternate;if(W!==null){var ne=W.memoizedState;if(ne!==null){var re=ne.dehydrated;re!==null&&jl(re)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(t(163))}Zt||l.flags&512&&wp(l)}catch(te){pt(l,l.return,te)}}if(l===o){de=null;break}if(d=l.sibling,d!==null){d.return=l.return,de=d;break}de=l.return}}function G5(o){for(;de!==null;){var l=de;if(l===o){de=null;break}var d=l.sibling;if(d!==null){d.return=l.return,de=d;break}de=l.return}}function Q5(o){for(;de!==null;){var l=de;try{switch(l.tag){case 0:case 11:case 15:var d=l.return;try{qd(4,l)}catch(M){pt(l,d,M)}break;case 1:var g=l.stateNode;if(typeof g.componentDidMount=="function"){var y=l.return;try{g.componentDidMount()}catch(M){pt(l,y,M)}}var b=l.return;try{wp(l)}catch(M){pt(l,b,M)}break;case 5:var C=l.return;try{wp(l)}catch(M){pt(l,C,M)}}}catch(M){pt(l,l.return,M)}if(l===o){de=null;break}var _=l.sibling;if(_!==null){_.return=l.return,de=_;break}de=l.return}}var hP=Math.ceil,Wd=F.ReactCurrentDispatcher,xp=F.ReactCurrentOwner,Wn=F.ReactCurrentBatchConfig,Me=0,Rt=null,Et=null,jt=0,Nn=0,aa=$s(0),Tt=0,uc=null,Vi=0,Gd=0,Sp=0,dc=null,bn=null,Ep=0,la=1/0,os=null,Qd=!1,Cp=null,Gs=null,Yd=!1,Qs=null,Xd=0,hc=0,kp=null,Jd=-1,Zd=0;function un(){return(Me&6)!==0?wt():Jd!==-1?Jd:Jd=wt()}function Ys(o){return(o.mode&1)===0?1:(Me&2)!==0&&jt!==0?jt&-jt:QA.transition!==null?(Zd===0&&(Zd=$4()),Zd):(o=ze,o!==0||(o=window.event,o=o===void 0?16:X4(o.type)),o)}function dr(o,l,d,g){if(50<hc)throw hc=0,kp=null,Error(t(185));Ol(o,d,g),((Me&2)===0||o!==Rt)&&(o===Rt&&((Me&2)===0&&(Gd|=d),Tt===4&&Xs(o,jt)),xn(o,g),d===1&&Me===0&&(l.mode&1)===0&&(la=wt()+500,Pd&&Hs()))}function xn(o,l){var d=o.callbackNode;Qk(o,l);var g=ld(o,o===Rt?jt:0);if(g===0)d!==null&&U4(d),o.callbackNode=null,o.callbackPriority=0;else if(l=g&-g,o.callbackPriority!==l){if(d!=null&&U4(d),l===1)o.tag===0?GA(X5.bind(null,o)):Oy(X5.bind(null,o)),HA(function(){(Me&6)===0&&Hs()}),d=null;else{switch(z4(g)){case 1:d=s0;break;case 4:d=V4;break;case 16:d=sd;break;case 536870912:d=j4;break;default:d=sd}d=i6(d,Y5.bind(null,o))}o.callbackPriority=l,o.callbackNode=d}}function Y5(o,l){if(Jd=-1,Zd=0,(Me&6)!==0)throw Error(t(327));var d=o.callbackNode;if(ca()&&o.callbackNode!==d)return null;var g=ld(o,o===Rt?jt:0);if(g===0)return null;if((g&30)!==0||(g&o.expiredLanes)!==0||l)l=eh(o,g);else{l=g;var y=Me;Me|=2;var b=Z5();(Rt!==o||jt!==l)&&(os=null,la=wt()+500,$i(o,l));do try{gP();break}catch(_){J5(o,_)}while(!0);z0(),Wd.current=b,Me=y,Et!==null?l=0:(Rt=null,jt=0,l=Tt)}if(l!==0){if(l===2&&(y=i0(o),y!==0&&(g=y,l=Ap(o,y))),l===1)throw d=uc,$i(o,0),Xs(o,g),xn(o,wt()),d;if(l===6)Xs(o,g);else{if(y=o.current.alternate,(g&30)===0&&!fP(y)&&(l=eh(o,g),l===2&&(b=i0(o),b!==0&&(g=b,l=Ap(o,b))),l===1))throw d=uc,$i(o,0),Xs(o,g),xn(o,wt()),d;switch(o.finishedWork=y,o.finishedLanes=g,l){case 0:case 1:throw Error(t(345));case 2:zi(o,bn,os);break;case 3:if(Xs(o,g),(g&130023424)===g&&(l=Ep+500-wt(),10<l)){if(ld(o,0)!==0)break;if(y=o.suspendedLanes,(y&g)!==g){un(),o.pingedLanes|=o.suspendedLanes&y;break}o.timeoutHandle=N0(zi.bind(null,o,bn,os),l);break}zi(o,bn,os);break;case 4:if(Xs(o,g),(g&4194240)===g)break;for(l=o.eventTimes,y=-1;0<g;){var C=31-ir(g);b=1<<C,C=l[C],C>y&&(y=C),g&=~b}if(g=y,g=wt()-g,g=(120>g?120:480>g?480:1080>g?1080:1920>g?1920:3e3>g?3e3:4320>g?4320:1960*hP(g/1960))-g,10<g){o.timeoutHandle=N0(zi.bind(null,o,bn,os),g);break}zi(o,bn,os);break;case 5:zi(o,bn,os);break;default:throw Error(t(329))}}}return xn(o,wt()),o.callbackNode===d?Y5.bind(null,o):null}function Ap(o,l){var d=dc;return o.current.memoizedState.isDehydrated&&($i(o,l).flags|=256),o=eh(o,l),o!==2&&(l=bn,bn=d,l!==null&&Pp(l)),o}function Pp(o){bn===null?bn=o:bn.push.apply(bn,o)}function fP(o){for(var l=o;;){if(l.flags&16384){var d=l.updateQueue;if(d!==null&&(d=d.stores,d!==null))for(var g=0;g<d.length;g++){var y=d[g],b=y.getSnapshot;y=y.value;try{if(!or(b(),y))return!1}catch{return!1}}}if(d=l.child,l.subtreeFlags&16384&&d!==null)d.return=l,l=d;else{if(l===o)break;for(;l.sibling===null;){if(l.return===null||l.return===o)return!0;l=l.return}l.sibling.return=l.return,l=l.sibling}}return!0}function Xs(o,l){for(l&=~Sp,l&=~Gd,o.suspendedLanes|=l,o.pingedLanes&=~l,o=o.expirationTimes;0<l;){var d=31-ir(l),g=1<<d;o[d]=-1,l&=~g}}function X5(o){if((Me&6)!==0)throw Error(t(327));ca();var l=ld(o,0);if((l&1)===0)return xn(o,wt()),null;var d=eh(o,l);if(o.tag!==0&&d===2){var g=i0(o);g!==0&&(l=g,d=Ap(o,g))}if(d===1)throw d=uc,$i(o,0),Xs(o,l),xn(o,wt()),d;if(d===6)throw Error(t(345));return o.finishedWork=o.current.alternate,o.finishedLanes=l,zi(o,bn,os),xn(o,wt()),null}function Tp(o,l){var d=Me;Me|=1;try{return o(l)}finally{Me=d,Me===0&&(la=wt()+500,Pd&&Hs())}}function ji(o){Qs!==null&&Qs.tag===0&&(Me&6)===0&&ca();var l=Me;Me|=1;var d=Wn.transition,g=ze;try{if(Wn.transition=null,ze=1,o)return o()}finally{ze=g,Wn.transition=d,Me=l,(Me&6)===0&&Hs()}}function _p(){Nn=aa.current,st(aa)}function $i(o,l){o.finishedWork=null,o.finishedLanes=0;var d=o.timeoutHandle;if(d!==-1&&(o.timeoutHandle=-1,zA(d)),Et!==null)for(d=Et.return;d!==null;){var g=d;switch(F0(g),g.tag){case 1:g=g.type.childContextTypes,g!=null&&kd();break;case 3:sa(),st(yn),st(Yt),X0();break;case 5:Q0(g);break;case 4:sa();break;case 13:st(ct);break;case 19:st(ct);break;case 10:H0(g.type._context);break;case 22:case 23:_p()}d=d.return}if(Rt=o,Et=o=Js(o.current,null),jt=Nn=l,Tt=0,uc=null,Sp=Gd=Vi=0,bn=dc=null,Bi!==null){for(l=0;l<Bi.length;l++)if(d=Bi[l],g=d.interleaved,g!==null){d.interleaved=null;var y=g.next,b=d.pending;if(b!==null){var C=b.next;b.next=y,g.next=C}d.pending=g}Bi=null}return o}function J5(o,l){do{var d=Et;try{if(z0(),Bd.current=jd,Fd){for(var g=ut.memoizedState;g!==null;){var y=g.queue;y!==null&&(y.pending=null),g=g.next}Fd=!1}if(Ui=0,Mt=Pt=ut=null,sc=!1,ic=0,xp.current=null,d===null||d.return===null){Tt=1,uc=l,Et=null;break}e:{var b=o,C=d.return,_=d,M=l;if(l=jt,_.flags|=32768,M!==null&&typeof M=="object"&&typeof M.then=="function"){var W=M,ne=_,re=ne.tag;if((ne.mode&1)===0&&(re===0||re===11||re===15)){var te=ne.alternate;te?(ne.updateQueue=te.updateQueue,ne.memoizedState=te.memoizedState,ne.lanes=te.lanes):(ne.updateQueue=null,ne.memoizedState=null)}var ce=E5(C);if(ce!==null){ce.flags&=-257,C5(ce,C,_,b,l),ce.mode&1&&S5(b,W,l),l=ce,M=W;var he=l.updateQueue;if(he===null){var fe=new Set;fe.add(M),l.updateQueue=fe}else he.add(M);break e}else{if((l&1)===0){S5(b,W,l),Dp();break e}M=Error(t(426))}}else if(ot&&_.mode&1){var vt=E5(C);if(vt!==null){(vt.flags&65536)===0&&(vt.flags|=256),C5(vt,C,_,b,l),j0(ia(M,_));break e}}b=M=ia(M,_),Tt!==4&&(Tt=2),dc===null?dc=[b]:dc.push(b),b=C;do{switch(b.tag){case 3:b.flags|=65536,l&=-l,b.lanes|=l;var z=b5(b,M,l);Wy(b,z);break e;case 1:_=M;var U=b.type,q=b.stateNode;if((b.flags&128)===0&&(typeof U.getDerivedStateFromError=="function"||q!==null&&typeof q.componentDidCatch=="function"&&(Gs===null||!Gs.has(q)))){b.flags|=65536,l&=-l,b.lanes|=l;var se=x5(b,_,l);Wy(b,se);break e}}b=b.return}while(b!==null)}t6(d)}catch(ye){l=ye,Et===d&&d!==null&&(Et=d=d.return);continue}break}while(!0)}function Z5(){var o=Wd.current;return Wd.current=jd,o===null?jd:o}function Dp(){(Tt===0||Tt===3||Tt===2)&&(Tt=4),Rt===null||(Vi&268435455)===0&&(Gd&268435455)===0||Xs(Rt,jt)}function eh(o,l){var d=Me;Me|=2;var g=Z5();(Rt!==o||jt!==l)&&(os=null,$i(o,l));do try{pP();break}catch(y){J5(o,y)}while(!0);if(z0(),Me=d,Wd.current=g,Et!==null)throw Error(t(261));return Rt=null,jt=0,Tt}function pP(){for(;Et!==null;)e6(Et)}function gP(){for(;Et!==null&&!Vk();)e6(Et)}function e6(o){var l=s6(o.alternate,o,Nn);o.memoizedProps=o.pendingProps,l===null?t6(o):Et=l,xp.current=null}function t6(o){var l=o;do{var d=l.alternate;if(o=l.return,(l.flags&32768)===0){if(d=aP(d,l,Nn),d!==null){Et=d;return}}else{if(d=lP(d,l),d!==null){d.flags&=32767,Et=d;return}if(o!==null)o.flags|=32768,o.subtreeFlags=0,o.deletions=null;else{Tt=6,Et=null;return}}if(l=l.sibling,l!==null){Et=l;return}Et=l=o}while(l!==null);Tt===0&&(Tt=5)}function zi(o,l,d){var g=ze,y=Wn.transition;try{Wn.transition=null,ze=1,mP(o,l,d,g)}finally{Wn.transition=y,ze=g}return null}function mP(o,l,d,g){do ca();while(Qs!==null);if((Me&6)!==0)throw Error(t(327));d=o.finishedWork;var y=o.finishedLanes;if(d===null)return null;if(o.finishedWork=null,o.finishedLanes=0,d===o.current)throw Error(t(177));o.callbackNode=null,o.callbackPriority=0;var b=d.lanes|d.childLanes;if(Yk(o,b),o===Rt&&(Et=Rt=null,jt=0),(d.subtreeFlags&2064)===0&&(d.flags&2064)===0||Yd||(Yd=!0,i6(sd,function(){return ca(),null})),b=(d.flags&15990)!==0,(d.subtreeFlags&15990)!==0||b){b=Wn.transition,Wn.transition=null;var C=ze;ze=1;var _=Me;Me|=4,xp.current=null,uP(o,d),K5(d,o),OA(D0),dd=!!_0,D0=_0=null,o.current=d,dP(d),jk(),Me=_,ze=C,Wn.transition=b}else o.current=d;if(Yd&&(Yd=!1,Qs=o,Xd=y),b=o.pendingLanes,b===0&&(Gs=null),Hk(d.stateNode),xn(o,wt()),l!==null)for(g=o.onRecoverableError,d=0;d<l.length;d++)y=l[d],g(y.value,{componentStack:y.stack,digest:y.digest});if(Qd)throw Qd=!1,o=Cp,Cp=null,o;return(Xd&1)!==0&&o.tag!==0&&ca(),b=o.pendingLanes,(b&1)!==0?o===kp?hc++:(hc=0,kp=o):hc=0,Hs(),null}function ca(){if(Qs!==null){var o=z4(Xd),l=Wn.transition,d=ze;try{if(Wn.transition=null,ze=16>o?16:o,Qs===null)var g=!1;else{if(o=Qs,Qs=null,Xd=0,(Me&6)!==0)throw Error(t(331));var y=Me;for(Me|=4,de=o.current;de!==null;){var b=de,C=b.child;if((de.flags&16)!==0){var _=b.deletions;if(_!==null){for(var M=0;M<_.length;M++){var W=_[M];for(de=W;de!==null;){var ne=de;switch(ne.tag){case 0:case 11:case 15:cc(8,ne,b)}var re=ne.child;if(re!==null)re.return=ne,de=re;else for(;de!==null;){ne=de;var te=ne.sibling,ce=ne.return;if(V5(ne),ne===W){de=null;break}if(te!==null){te.return=ce,de=te;break}de=ce}}}var he=b.alternate;if(he!==null){var fe=he.child;if(fe!==null){he.child=null;do{var vt=fe.sibling;fe.sibling=null,fe=vt}while(fe!==null)}}de=b}}if((b.subtreeFlags&2064)!==0&&C!==null)C.return=b,de=C;else e:for(;de!==null;){if(b=de,(b.flags&2048)!==0)switch(b.tag){case 0:case 11:case 15:cc(9,b,b.return)}var z=b.sibling;if(z!==null){z.return=b.return,de=z;break e}de=b.return}}var U=o.current;for(de=U;de!==null;){C=de;var q=C.child;if((C.subtreeFlags&2064)!==0&&q!==null)q.return=C,de=q;else e:for(C=U;de!==null;){if(_=de,(_.flags&2048)!==0)try{switch(_.tag){case 0:case 11:case 15:qd(9,_)}}catch(ye){pt(_,_.return,ye)}if(_===C){de=null;break e}var se=_.sibling;if(se!==null){se.return=_.return,de=se;break e}de=_.return}}if(Me=y,Hs(),Ar&&typeof Ar.onPostCommitFiberRoot=="function")try{Ar.onPostCommitFiberRoot(id,o)}catch{}g=!0}return g}finally{ze=d,Wn.transition=l}}return!1}function n6(o,l,d){l=ia(d,l),l=b5(o,l,1),o=qs(o,l,1),l=un(),o!==null&&(Ol(o,1,l),xn(o,l))}function pt(o,l,d){if(o.tag===3)n6(o,o,d);else for(;l!==null;){if(l.tag===3){n6(l,o,d);break}else if(l.tag===1){var g=l.stateNode;if(typeof l.type.getDerivedStateFromError=="function"||typeof g.componentDidCatch=="function"&&(Gs===null||!Gs.has(g))){o=ia(d,o),o=x5(l,o,1),l=qs(l,o,1),o=un(),l!==null&&(Ol(l,1,o),xn(l,o));break}}l=l.return}}function yP(o,l,d){var g=o.pingCache;g!==null&&g.delete(l),l=un(),o.pingedLanes|=o.suspendedLanes&d,Rt===o&&(jt&d)===d&&(Tt===4||Tt===3&&(jt&130023424)===jt&&500>wt()-Ep?$i(o,0):Sp|=d),xn(o,l)}function r6(o,l){l===0&&((o.mode&1)===0?l=1:(l=ad,ad<<=1,(ad&130023424)===0&&(ad=4194304)));var d=un();o=rs(o,l),o!==null&&(Ol(o,l,d),xn(o,d))}function wP(o){var l=o.memoizedState,d=0;l!==null&&(d=l.retryLane),r6(o,d)}function vP(o,l){var d=0;switch(o.tag){case 13:var g=o.stateNode,y=o.memoizedState;y!==null&&(d=y.retryLane);break;case 19:g=o.stateNode;break;default:throw Error(t(314))}g!==null&&g.delete(l),r6(o,d)}var s6;s6=function(o,l,d){if(o!==null)if(o.memoizedProps!==l.pendingProps||yn.current)vn=!0;else{if((o.lanes&d)===0&&(l.flags&128)===0)return vn=!1,oP(o,l,d);vn=(o.flags&131072)!==0}else vn=!1,ot&&(l.flags&1048576)!==0&&By(l,_d,l.index);switch(l.lanes=0,l.tag){case 2:var g=l.type;Hd(o,l),o=l.pendingProps;var y=Xo(l,Yt.current);ra(l,d),y=ep(null,l,g,o,y,d);var b=tp();return l.flags|=1,typeof y=="object"&&y!==null&&typeof y.render=="function"&&y.$$typeof===void 0?(l.tag=1,l.memoizedState=null,l.updateQueue=null,wn(g)?(b=!0,Ad(l)):b=!1,l.memoizedState=y.state!==null&&y.state!==void 0?y.state:null,W0(l),y.updater=$d,l.stateNode=y,y._reactInternals=l,ap(l,g,o,d),l=dp(null,l,g,!0,b,d)):(l.tag=0,ot&&b&&B0(l),cn(null,l,y,d),l=l.child),l;case 16:g=l.elementType;e:{switch(Hd(o,l),o=l.pendingProps,y=g._init,g=y(g._payload),l.type=g,y=l.tag=xP(g),o=lr(g,o),y){case 0:l=up(null,l,g,o,d);break e;case 1:l=D5(null,l,g,o,d);break e;case 11:l=k5(null,l,g,o,d);break e;case 14:l=A5(null,l,g,lr(g.type,o),d);break e}throw Error(t(306,g,""))}return l;case 0:return g=l.type,y=l.pendingProps,y=l.elementType===g?y:lr(g,y),up(o,l,g,y,d);case 1:return g=l.type,y=l.pendingProps,y=l.elementType===g?y:lr(g,y),D5(o,l,g,y,d);case 3:e:{if(I5(l),o===null)throw Error(t(387));g=l.pendingProps,b=l.memoizedState,y=b.element,qy(o,l),Ld(l,g,null,d);var C=l.memoizedState;if(g=C.element,b.isDehydrated)if(b={element:g,isDehydrated:!1,cache:C.cache,pendingSuspenseBoundaries:C.pendingSuspenseBoundaries,transitions:C.transitions},l.updateQueue.baseState=b,l.memoizedState=b,l.flags&256){y=ia(Error(t(423)),l),l=N5(o,l,g,d,y);break e}else if(g!==y){y=ia(Error(t(424)),l),l=N5(o,l,g,d,y);break e}else for(In=js(l.stateNode.containerInfo.firstChild),Dn=l,ot=!0,ar=null,d=Hy(l,null,g,d),l.child=d;d;)d.flags=d.flags&-3|4096,d=d.sibling;else{if(ea(),g===y){l=is(o,l,d);break e}cn(o,l,g,d)}l=l.child}return l;case 5:return Qy(l),o===null&&V0(l),g=l.type,y=l.pendingProps,b=o!==null?o.memoizedProps:null,C=y.children,I0(g,y)?C=null:b!==null&&I0(g,b)&&(l.flags|=32),_5(o,l),cn(o,l,C,d),l.child;case 6:return o===null&&V0(l),null;case 13:return M5(o,l,d);case 4:return G0(l,l.stateNode.containerInfo),g=l.pendingProps,o===null?l.child=ta(l,null,g,d):cn(o,l,g,d),l.child;case 11:return g=l.type,y=l.pendingProps,y=l.elementType===g?y:lr(g,y),k5(o,l,g,y,d);case 7:return cn(o,l,l.pendingProps,d),l.child;case 8:return cn(o,l,l.pendingProps.children,d),l.child;case 12:return cn(o,l,l.pendingProps.children,d),l.child;case 10:e:{if(g=l.type._context,y=l.pendingProps,b=l.memoizedProps,C=y.value,Ze(Nd,g._currentValue),g._currentValue=C,b!==null)if(or(b.value,C)){if(b.children===y.children&&!yn.current){l=is(o,l,d);break e}}else for(b=l.child,b!==null&&(b.return=l);b!==null;){var _=b.dependencies;if(_!==null){C=b.child;for(var M=_.firstContext;M!==null;){if(M.context===g){if(b.tag===1){M=ss(-1,d&-d),M.tag=2;var W=b.updateQueue;if(W!==null){W=W.shared;var ne=W.pending;ne===null?M.next=M:(M.next=ne.next,ne.next=M),W.pending=M}}b.lanes|=d,M=b.alternate,M!==null&&(M.lanes|=d),K0(b.return,d,l),_.lanes|=d;break}M=M.next}}else if(b.tag===10)C=b.type===l.type?null:b.child;else if(b.tag===18){if(C=b.return,C===null)throw Error(t(341));C.lanes|=d,_=C.alternate,_!==null&&(_.lanes|=d),K0(C,d,l),C=b.sibling}else C=b.child;if(C!==null)C.return=b;else for(C=b;C!==null;){if(C===l){C=null;break}if(b=C.sibling,b!==null){b.return=C.return,C=b;break}C=C.return}b=C}cn(o,l,y.children,d),l=l.child}return l;case 9:return y=l.type,g=l.pendingProps.children,ra(l,d),y=Kn(y),g=g(y),l.flags|=1,cn(o,l,g,d),l.child;case 14:return g=l.type,y=lr(g,l.pendingProps),y=lr(g.type,y),A5(o,l,g,y,d);case 15:return P5(o,l,l.type,l.pendingProps,d);case 17:return g=l.type,y=l.pendingProps,y=l.elementType===g?y:lr(g,y),Hd(o,l),l.tag=1,wn(g)?(o=!0,Ad(l)):o=!1,ra(l,d),w5(l,g,y),ap(l,g,y,d),dp(null,l,g,!0,o,d);case 19:return L5(o,l,d);case 22:return T5(o,l,d)}throw Error(t(156,l.tag))};function i6(o,l){return F4(o,l)}function bP(o,l,d,g){this.tag=o,this.key=d,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=l,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=g,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Gn(o,l,d,g){return new bP(o,l,d,g)}function Ip(o){return o=o.prototype,!(!o||!o.isReactComponent)}function xP(o){if(typeof o=="function")return Ip(o)?1:0;if(o!=null){if(o=o.$$typeof,o===X)return 11;if(o===L)return 14}return 2}function Js(o,l){var d=o.alternate;return d===null?(d=Gn(o.tag,l,o.key,o.mode),d.elementType=o.elementType,d.type=o.type,d.stateNode=o.stateNode,d.alternate=o,o.alternate=d):(d.pendingProps=l,d.type=o.type,d.flags=0,d.subtreeFlags=0,d.deletions=null),d.flags=o.flags&14680064,d.childLanes=o.childLanes,d.lanes=o.lanes,d.child=o.child,d.memoizedProps=o.memoizedProps,d.memoizedState=o.memoizedState,d.updateQueue=o.updateQueue,l=o.dependencies,d.dependencies=l===null?null:{lanes:l.lanes,firstContext:l.firstContext},d.sibling=o.sibling,d.index=o.index,d.ref=o.ref,d}function th(o,l,d,g,y,b){var C=2;if(g=o,typeof o=="function")Ip(o)&&(C=1);else if(typeof o=="string")C=5;else e:switch(o){case Q:return Hi(d.children,y,b,l);case D:C=8,y|=8;break;case R:return o=Gn(12,d,l,y|2),o.elementType=R,o.lanes=b,o;case B:return o=Gn(13,d,l,y),o.elementType=B,o.lanes=b,o;case O:return o=Gn(19,d,l,y),o.elementType=O,o.lanes=b,o;case G:return nh(d,y,b,l);default:if(typeof o=="object"&&o!==null)switch(o.$$typeof){case Y:C=10;break e;case J:C=9;break e;case X:C=11;break e;case L:C=14;break e;case K:C=16,g=null;break e}throw Error(t(130,o==null?o:typeof o,""))}return l=Gn(C,d,l,y),l.elementType=o,l.type=g,l.lanes=b,l}function Hi(o,l,d,g){return o=Gn(7,o,g,l),o.lanes=d,o}function nh(o,l,d,g){return o=Gn(22,o,g,l),o.elementType=G,o.lanes=d,o.stateNode={isHidden:!1},o}function Np(o,l,d){return o=Gn(6,o,null,l),o.lanes=d,o}function Mp(o,l,d){return l=Gn(4,o.children!==null?o.children:[],o.key,l),l.lanes=d,l.stateNode={containerInfo:o.containerInfo,pendingChildren:null,implementation:o.implementation},l}function SP(o,l,d,g,y){this.tag=l,this.containerInfo=o,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=o0(0),this.expirationTimes=o0(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=o0(0),this.identifierPrefix=g,this.onRecoverableError=y,this.mutableSourceEagerHydrationData=null}function Rp(o,l,d,g,y,b,C,_,M){return o=new SP(o,l,d,_,M),l===1?(l=1,b===!0&&(l|=8)):l=0,b=Gn(3,null,null,l),o.current=b,b.stateNode=o,b.memoizedState={element:g,isDehydrated:d,cache:null,transitions:null,pendingSuspenseBoundaries:null},W0(b),o}function EP(o,l,d){var g=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:V,key:g==null?null:""+g,children:o,containerInfo:l,implementation:d}}function o6(o){if(!o)return zs;o=o._reactInternals;e:{if(Ni(o)!==o||o.tag!==1)throw Error(t(170));var l=o;do{switch(l.tag){case 3:l=l.stateNode.context;break e;case 1:if(wn(l.type)){l=l.stateNode.__reactInternalMemoizedMergedChildContext;break e}}l=l.return}while(l!==null);throw Error(t(171))}if(o.tag===1){var d=o.type;if(wn(d))return Ry(o,d,l)}return l}function a6(o,l,d,g,y,b,C,_,M){return o=Rp(d,g,!0,o,y,b,C,_,M),o.context=o6(null),d=o.current,g=un(),y=Ys(d),b=ss(g,y),b.callback=l??null,qs(d,b,y),o.current.lanes=y,Ol(o,y,g),xn(o,g),o}function rh(o,l,d,g){var y=l.current,b=un(),C=Ys(y);return d=o6(d),l.context===null?l.context=d:l.pendingContext=d,l=ss(b,C),l.payload={element:o},g=g===void 0?null:g,g!==null&&(l.callback=g),o=qs(y,l,C),o!==null&&(dr(o,y,C,b),Rd(o,y,C)),C}function sh(o){if(o=o.current,!o.child)return null;switch(o.child.tag){case 5:return o.child.stateNode;default:return o.child.stateNode}}function l6(o,l){if(o=o.memoizedState,o!==null&&o.dehydrated!==null){var d=o.retryLane;o.retryLane=d!==0&&d<l?d:l}}function Lp(o,l){l6(o,l),(o=o.alternate)&&l6(o,l)}function CP(){return null}var c6=typeof reportError=="function"?reportError:function(o){console.error(o)};function Op(o){this._internalRoot=o}ih.prototype.render=Op.prototype.render=function(o){var l=this._internalRoot;if(l===null)throw Error(t(409));rh(o,l,null,null)},ih.prototype.unmount=Op.prototype.unmount=function(){var o=this._internalRoot;if(o!==null){this._internalRoot=null;var l=o.containerInfo;ji(function(){rh(null,o,null,null)}),l[Zr]=null}};function ih(o){this._internalRoot=o}ih.prototype.unstable_scheduleHydration=function(o){if(o){var l=q4();o={blockedOn:null,target:o,priority:l};for(var d=0;d<Fs.length&&l!==0&&l<Fs[d].priority;d++);Fs.splice(d,0,o),d===0&&Q4(o)}};function Bp(o){return!(!o||o.nodeType!==1&&o.nodeType!==9&&o.nodeType!==11)}function oh(o){return!(!o||o.nodeType!==1&&o.nodeType!==9&&o.nodeType!==11&&(o.nodeType!==8||o.nodeValue!==" react-mount-point-unstable "))}function u6(){}function kP(o,l,d,g,y){if(y){if(typeof g=="function"){var b=g;g=function(){var W=sh(C);b.call(W)}}var C=a6(l,g,o,0,null,!1,!1,"",u6);return o._reactRootContainer=C,o[Zr]=C.current,Yl(o.nodeType===8?o.parentNode:o),ji(),C}for(;y=o.lastChild;)o.removeChild(y);if(typeof g=="function"){var _=g;g=function(){var W=sh(M);_.call(W)}}var M=Rp(o,0,!1,null,null,!1,!1,"",u6);return o._reactRootContainer=M,o[Zr]=M.current,Yl(o.nodeType===8?o.parentNode:o),ji(function(){rh(l,M,d,g)}),M}function ah(o,l,d,g,y){var b=d._reactRootContainer;if(b){var C=b;if(typeof y=="function"){var _=y;y=function(){var M=sh(C);_.call(M)}}rh(l,C,o,y)}else C=kP(d,l,o,y,g);return sh(C)}H4=function(o){switch(o.tag){case 3:var l=o.stateNode;if(l.current.memoizedState.isDehydrated){var d=Ll(l.pendingLanes);d!==0&&(a0(l,d|1),xn(l,wt()),(Me&6)===0&&(la=wt()+500,Hs()))}break;case 13:ji(function(){var g=rs(o,1);if(g!==null){var y=un();dr(g,o,1,y)}}),Lp(o,1)}},l0=function(o){if(o.tag===13){var l=rs(o,134217728);if(l!==null){var d=un();dr(l,o,134217728,d)}Lp(o,134217728)}},K4=function(o){if(o.tag===13){var l=Ys(o),d=rs(o,l);if(d!==null){var g=un();dr(d,o,l,g)}Lp(o,l)}},q4=function(){return ze},W4=function(o,l){var d=ze;try{return ze=o,l()}finally{ze=d}},e0=function(o,l,d){switch(l){case"input":if(q1(o,d),l=d.name,d.type==="radio"&&l!=null){for(d=o;d.parentNode;)d=d.parentNode;for(d=d.querySelectorAll("input[name="+JSON.stringify(""+l)+'][type="radio"]'),l=0;l<d.length;l++){var g=d[l];if(g!==o&&g.form===o.form){var y=Cd(g);if(!y)throw Error(t(90));Jr(g),q1(g,y)}}}break;case"textarea":S4(o,d);break;case"select":l=d.value,l!=null&&Uo(o,!!d.multiple,l,!1)}},I4=Tp,N4=ji;var AP={usingClientEntryPoint:!1,Events:[Zl,Qo,Cd,_4,D4,Tp]},fc={findFiberByHostInstance:Mi,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},PP={bundleType:fc.bundleType,version:fc.version,rendererPackageName:fc.rendererPackageName,rendererConfig:fc.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:F.ReactCurrentDispatcher,findHostInstanceByFiber:function(o){return o=O4(o),o===null?null:o.stateNode},findFiberByHostInstance:fc.findFiberByHostInstance||CP,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var lh=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!lh.isDisabled&&lh.supportsFiber)try{id=lh.inject(PP),Ar=lh}catch{}}return Sn.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=AP,Sn.createPortal=function(o,l){var d=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!Bp(l))throw Error(t(200));return EP(o,l,null,d)},Sn.createRoot=function(o,l){if(!Bp(o))throw Error(t(299));var d=!1,g="",y=c6;return l!=null&&(l.unstable_strictMode===!0&&(d=!0),l.identifierPrefix!==void 0&&(g=l.identifierPrefix),l.onRecoverableError!==void 0&&(y=l.onRecoverableError)),l=Rp(o,1,!1,null,null,d,!1,g,y),o[Zr]=l.current,Yl(o.nodeType===8?o.parentNode:o),new Op(l)},Sn.findDOMNode=function(o){if(o==null)return null;if(o.nodeType===1)return o;var l=o._reactInternals;if(l===void 0)throw typeof o.render=="function"?Error(t(188)):(o=Object.keys(o).join(","),Error(t(268,o)));return o=O4(l),o=o===null?null:o.stateNode,o},Sn.flushSync=function(o){return ji(o)},Sn.hydrate=function(o,l,d){if(!oh(l))throw Error(t(200));return ah(null,o,l,!0,d)},Sn.hydrateRoot=function(o,l,d){if(!Bp(o))throw Error(t(405));var g=d!=null&&d.hydratedSources||null,y=!1,b="",C=c6;if(d!=null&&(d.unstable_strictMode===!0&&(y=!0),d.identifierPrefix!==void 0&&(b=d.identifierPrefix),d.onRecoverableError!==void 0&&(C=d.onRecoverableError)),l=a6(l,null,o,1,d??null,y,!1,b,C),o[Zr]=l.current,Yl(o),g)for(o=0;o<g.length;o++)d=g[o],y=d._getVersion,y=y(d._source),l.mutableSourceEagerHydrationData==null?l.mutableSourceEagerHydrationData=[d,y]:l.mutableSourceEagerHydrationData.push(d,y);return new ih(l)},Sn.render=function(o,l,d){if(!oh(l))throw Error(t(200));return ah(null,o,l,!1,d)},Sn.unmountComponentAtNode=function(o){if(!oh(o))throw Error(t(40));return o._reactRootContainer?(ji(function(){ah(null,null,o,!1,function(){o._reactRootContainer=null,o[Zr]=null})}),!0):!1},Sn.unstable_batchedUpdates=Tp,Sn.unstable_renderSubtreeIntoContainer=function(o,l,d,g){if(!oh(d))throw Error(t(200));if(o==null||o._reactInternals===void 0)throw Error(t(38));return ah(o,l,d,!1,g)},Sn.version="18.3.1-next-f1338f8080-20240426",Sn}var w6;function LP(){if(w6)return Vp.exports;w6=1;function n(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(n)}catch(e){console.error(e)}}return n(),Vp.exports=RP(),Vp.exports}var v6;function OP(){if(v6)return ch;v6=1;var n=LP();return ch.createRoot=n.createRoot,ch.hydrateRoot=n.hydrateRoot,ch}var BP=OP(),ee=Du();const gr=_u(ee),FP={},b6=n=>{let e;const t=new Set,r=(f,p)=>{const m=typeof f=="function"?f(e):f;if(!Object.is(m,e)){const w=e;e=p??(typeof m!="object"||m===null)?m:Object.assign({},e,m),t.forEach(x=>x(e,w))}},s=()=>e,u={setState:r,getState:s,getInitialState:()=>h,subscribe:f=>(t.add(f),()=>t.delete(f)),destroy:()=>{(FP?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},h=e=n(r,s,u);return u},UP=n=>n?b6(n):b6;var zp={exports:{}},Hp={},Kp={exports:{}},qp={};/**
 * @license React
 * use-sync-external-store-shim.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var x6;function VP(){if(x6)return qp;x6=1;var n=Du();function e(p,m){return p===m&&(p!==0||1/p===1/m)||p!==p&&m!==m}var t=typeof Object.is=="function"?Object.is:e,r=n.useState,s=n.useEffect,i=n.useLayoutEffect,a=n.useDebugValue;function c(p,m){var w=m(),x=r({inst:{value:w,getSnapshot:m}}),S=x[0].inst,E=x[1];return i(function(){S.value=w,S.getSnapshot=m,u(S)&&E({inst:S})},[p,w,m]),s(function(){return u(S)&&E({inst:S}),p(function(){u(S)&&E({inst:S})})},[p]),a(w),w}function u(p){var m=p.getSnapshot;p=p.value;try{var w=m();return!t(p,w)}catch{return!0}}function h(p,m){return m()}var f=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?h:c;return qp.useSyncExternalStore=n.useSyncExternalStore!==void 0?n.useSyncExternalStore:f,qp}var S6;function jP(){return S6||(S6=1,Kp.exports=VP()),Kp.exports}/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.js
 *
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var E6;function $P(){if(E6)return Hp;E6=1;var n=Du(),e=jP();function t(h,f){return h===f&&(h!==0||1/h===1/f)||h!==h&&f!==f}var r=typeof Object.is=="function"?Object.is:t,s=e.useSyncExternalStore,i=n.useRef,a=n.useEffect,c=n.useMemo,u=n.useDebugValue;return Hp.useSyncExternalStoreWithSelector=function(h,f,p,m,w){var x=i(null);if(x.current===null){var S={hasValue:!1,value:null};x.current=S}else S=x.current;x=c(function(){function A(V){if(!P){if(P=!0,k=V,V=m(V),w!==void 0&&S.hasValue){var Q=S.value;if(w(Q,V))return F=Q}return F=V}if(Q=F,r(k,V))return Q;var D=m(V);return w!==void 0&&w(Q,D)?(k=V,Q):(k=V,F=D)}var P=!1,k,F,I=p===void 0?null:p;return[function(){return A(f())},I===null?void 0:function(){return A(I())}]},[f,p,m,w]);var E=s(h,x[0],x[1]);return a(function(){S.hasValue=!0,S.value=E},[E]),u(E),E},Hp}var C6;function zP(){return C6||(C6=1,zp.exports=$P()),zp.exports}var HP=zP();const KP=_u(HP),xw={},{useDebugValue:qP}=gr,{useSyncExternalStoreWithSelector:WP}=KP;let k6=!1;const GP=n=>n;function QP(n,e=GP,t){(xw?"production":void 0)!=="production"&&t&&!k6&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),k6=!0);const r=WP(n.subscribe,n.getState,n.getServerState||n.getInitialState,e,t);return qP(r),r}const YP=n=>{(xw?"production":void 0)!=="production"&&typeof n!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const e=typeof n=="function"?UP(n):n,t=(r,s)=>QP(e,r,s);return Object.assign(t,e),t},XP=n=>YP,JP={};function ZP(n,e){let t;try{t=n()}catch{return}return{getItem:s=>{var i;const a=u=>u===null?null:JSON.parse(u,void 0),c=(i=t.getItem(s))!=null?i:null;return c instanceof Promise?c.then(a):a(c)},setItem:(s,i)=>t.setItem(s,JSON.stringify(i,void 0)),removeItem:s=>t.removeItem(s)}}const Wc=n=>e=>{try{const t=n(e);return t instanceof Promise?t:{then(r){return Wc(r)(t)},catch(r){return this}}}catch(t){return{then(r){return this},catch(r){return Wc(r)(t)}}}},eT=(n,e)=>(t,r,s)=>{let i={getStorage:()=>localStorage,serialize:JSON.stringify,deserialize:JSON.parse,partialize:E=>E,version:0,merge:(E,A)=>({...A,...E}),...e},a=!1;const c=new Set,u=new Set;let h;try{h=i.getStorage()}catch{}if(!h)return n((...E)=>{console.warn(`[zustand persist middleware] Unable to update item '${i.name}', the given storage is currently unavailable.`),t(...E)},r,s);const f=Wc(i.serialize),p=()=>{const E=i.partialize({...r()});let A;const P=f({state:E,version:i.version}).then(k=>h.setItem(i.name,k)).catch(k=>{A=k});if(A)throw A;return P},m=s.setState;s.setState=(E,A)=>{m(E,A),p()};const w=n((...E)=>{t(...E),p()},r,s);let x;const S=()=>{var E;if(!h)return;a=!1,c.forEach(P=>P(r()));const A=((E=i.onRehydrateStorage)==null?void 0:E.call(i,r()))||void 0;return Wc(h.getItem.bind(h))(i.name).then(P=>{if(P)return i.deserialize(P)}).then(P=>{if(P)if(typeof P.version=="number"&&P.version!==i.version){if(i.migrate)return i.migrate(P.state,P.version);console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return P.state}).then(P=>{var k;return x=i.merge(P,(k=r())!=null?k:w),t(x,!0),p()}).then(()=>{A?.(x,void 0),a=!0,u.forEach(P=>P(x))}).catch(P=>{A?.(void 0,P)})};return s.persist={setOptions:E=>{i={...i,...E},E.getStorage&&(h=E.getStorage())},clearStorage:()=>{h?.removeItem(i.name)},getOptions:()=>i,rehydrate:()=>S(),hasHydrated:()=>a,onHydrate:E=>(c.add(E),()=>{c.delete(E)}),onFinishHydration:E=>(u.add(E),()=>{u.delete(E)})},S(),x||w},tT=(n,e)=>(t,r,s)=>{let i={storage:ZP(()=>localStorage),partialize:S=>S,version:0,merge:(S,E)=>({...E,...S}),...e},a=!1;const c=new Set,u=new Set;let h=i.storage;if(!h)return n((...S)=>{console.warn(`[zustand persist middleware] Unable to update item '${i.name}', the given storage is currently unavailable.`),t(...S)},r,s);const f=()=>{const S=i.partialize({...r()});return h.setItem(i.name,{state:S,version:i.version})},p=s.setState;s.setState=(S,E)=>{p(S,E),f()};const m=n((...S)=>{t(...S),f()},r,s);s.getInitialState=()=>m;let w;const x=()=>{var S,E;if(!h)return;a=!1,c.forEach(P=>{var k;return P((k=r())!=null?k:m)});const A=((E=i.onRehydrateStorage)==null?void 0:E.call(i,(S=r())!=null?S:m))||void 0;return Wc(h.getItem.bind(h))(i.name).then(P=>{if(P)if(typeof P.version=="number"&&P.version!==i.version){if(i.migrate)return[!0,i.migrate(P.state,P.version)];console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}else return[!1,P.state];return[!1,void 0]}).then(P=>{var k;const[F,I]=P;if(w=i.merge(I,(k=r())!=null?k:m),t(w,!0),F)return f()}).then(()=>{A?.(w,void 0),w=r(),a=!0,u.forEach(P=>P(w))}).catch(P=>{A?.(void 0,P)})};return s.persist={setOptions:S=>{i={...i,...S},S.storage&&(h=S.storage)},clearStorage:()=>{h?.removeItem(i.name)},getOptions:()=>i,rehydrate:()=>x(),hasHydrated:()=>a,onHydrate:S=>(c.add(S),()=>{c.delete(S)}),onFinishHydration:S=>(u.add(S),()=>{u.delete(S)})},i.skipHydration||x(),w||m},nT=(n,e)=>"getStorage"in e||"serialize"in e||"deserialize"in e?((JP?"production":void 0)!=="production"&&console.warn("[DEPRECATED] `getStorage`, `serialize` and `deserialize` options are deprecated. Use `storage` option instead."),eT(n,e)):tT(n,e),rT=nT,gc=new Map,sT=[{id:"u1",name:"Mariana",age:24,bio:"Amo surf e caf",photo:"/assets/m1.jpg"},{id:"u2",name:"Lucas",age:27,bio:"Skate e beats",photo:"/assets/m2.jpg"},{id:"u3",name:"Ana",age:22,bio:"Designer e gamer",photo:"/assets/m3.jpg"}],Ts=XP()(rT((n,e)=>({user:null,matches:[],messages:[],isLoading:!1,error:null,login:async(t,r)=>{n({isLoading:!0,error:null});try{await new Promise(i=>setTimeout(i,1e3));const s=gc.get(t);return!s||s.password!==r?(n({error:"Email ou senha incorretos",isLoading:!1}),!1):(n({user:s.user,isLoading:!1}),!0)}catch{return n({error:"Erro ao fazer login",isLoading:!1}),!1}},register:async(t,r,s,i)=>{n({isLoading:!0,error:null});try{if(await new Promise(c=>setTimeout(c,1e3)),gc.has(t))return n({error:"Email j cadastrado",isLoading:!1}),!1;const a={id:Date.now().toString(),email:t,name:s,age:i,bio:"",photos:[]};return gc.set(t,{email:t,password:r,user:a}),n({user:a,isLoading:!1}),!0}catch{return n({error:"Erro ao criar conta",isLoading:!1}),!1}},logout:()=>{try{localStorage.removeItem("tinder-auth-storage")}catch(t){console.error("Erro ao limpar localStorage:",t)}n({user:null,matches:[],messages:[],error:null})},clearError:()=>{n({error:null})},updateProfile:t=>{const r=e().user;if(r){const s={...r,...t};n({user:s});const i=gc.get(r.email);i&&gc.set(r.email,{...i,user:s})}},likeProfile:t=>{if(Math.random()>.5){const r=sT.find(s=>s.id===t);if(r){const s=new Date,i={id:`match_${Date.now()}`,userId:r.id,name:r.name,age:r.age,bio:r.bio,photo:r.photo,matchedAt:s,unreadCount:0};n({matches:[...e().matches,i]}),setTimeout(()=>{const a={id:`msg_${Date.now()}`,matchId:i.id,senderId:r.id,text:"Oi! Que bom que deu match! ",timestamp:new Date,read:!1},c=e();n({messages:[...c.messages,a],matches:c.matches.map(u=>u.id===i.id?{...u,lastMessage:a,unreadCount:1}:u)})},2e3)}}},sendMessage:(t,r)=>{const s=e().user;if(!s)return;const i={id:`msg_${Date.now()}`,matchId:t,senderId:s.id,text:r,timestamp:new Date,read:!0},a=e();n({messages:[...a.messages,i],matches:a.matches.map(u=>u.id===t?{...u,lastMessage:i}:u)});const c=Math.random()*5e3+3e3;setTimeout(()=>{const u=["Que legal! ","Concordo totalmente!","Haha, adorei! ","Que interessante!","Me conta mais sobre isso!","Tambm gosto disso! ","Que coincidncia!","Parece que temos muito em comum! "],h=e().matches.find(f=>f.id===t);if(h){const f={id:`msg_${Date.now()}`,matchId:t,senderId:h.userId,text:u[Math.floor(Math.random()*u.length)],timestamp:new Date,read:!1},p=e();n({messages:[...p.messages,f],matches:p.matches.map(m=>m.id===t?{...m,lastMessage:f,unreadCount:m.unreadCount+1}:m)})}},c)},markMessagesAsRead:t=>{const r=e(),s=r.messages.some(a=>a.matchId===t&&!a.read),i=r.matches.some(a=>a.id===t&&a.unreadCount>0);!s&&!i||n({messages:r.messages.map(a=>a.matchId===t&&!a.read?{...a,read:!0}:a),matches:r.matches.map(a=>a.id===t&&a.unreadCount>0?{...a,unreadCount:0}:a)})},getMessagesForMatch:t=>{const r=e();if(!Array.isArray(r.messages))return console.error("Messages no  um array:",r.messages),[];try{return r.messages.filter(s=>s&&s.matchId===t).sort((s,i)=>{const a=s.timestamp instanceof Date?s.timestamp.getTime():new Date(s.timestamp).getTime(),c=i.timestamp instanceof Date?i.timestamp.getTime():new Date(i.timestamp).getTime();return a-c})}catch(s){return console.error("Erro ao buscar mensagens:",s),[]}},unmatchUser:t=>{const r=e();n({matches:r.matches.filter(s=>s.id!==t),messages:r.messages.filter(s=>s.matchId!==t)})},deleteConversation:t=>{const r=e();n({messages:r.messages.filter(s=>s.matchId!==t),matches:r.matches.map(s=>s.id===t?{...s,lastMessage:void 0,unreadCount:0}:s)})},clearCorruptedData:()=>{try{localStorage.removeItem("tinder-auth-storage"),n({user:null,matches:[],messages:[],error:null}),console.log("Dados corrompidos limpos com sucesso")}catch(t){console.error("Erro ao limpar dados corrompidos:",t)}}}),{name:"tinder-auth-storage",partialize:n=>({user:n.user,matches:n.matches,messages:n.messages}),serialize:n=>JSON.stringify(n),deserialize:n=>{try{const e=JSON.parse(n);return Array.isArray(e.matches)||(e.matches=[]),Array.isArray(e.messages)||(e.messages=[]),e.matches&&Array.isArray(e.matches)&&(e.matches=e.matches.map(t=>{try{return!t.id||!t.name?(console.warn("Match invlido encontrado:",t),null):{...t,matchedAt:t.matchedAt?new Date(t.matchedAt):new Date,lastMessage:t.lastMessage?{...t.lastMessage,timestamp:t.lastMessage.timestamp?new Date(t.lastMessage.timestamp):new Date}:void 0,unreadCount:t.unreadCount||0}}catch(r){return console.error("Erro ao processar match:",r),null}}).filter(Boolean)),e.messages&&Array.isArray(e.messages)&&(e.messages=e.messages.map(t=>{try{return{...t,timestamp:t.timestamp?new Date(t.timestamp):new Date}}catch(r){return console.error("Erro ao processar mensagem:",r),null}}).filter(Boolean)),e}catch(e){return console.error("Erro ao deserializar dados:",e),{user:null,matches:[],messages:[]}}}})),ym=ee.createContext({transformPagePoint:n=>n,isStatic:!1,reducedMotion:"never"}),s1=ee.createContext({}),wm=ee.createContext(null),i1=typeof document<"u",Sw=i1?ee.useLayoutEffect:ee.useEffect,Ew=ee.createContext({strict:!1}),vm=n=>n.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),iT="framerAppearId",Cw="data-"+vm(iT);function oT(n,e,t,r){const{visualElement:s}=ee.useContext(s1),i=ee.useContext(Ew),a=ee.useContext(wm),c=ee.useContext(ym).reducedMotion,u=ee.useRef();r=r||i.renderer,!u.current&&r&&(u.current=r(n,{visualState:e,parent:s,props:t,presenceContext:a,blockInitialAnimation:a?a.initial===!1:!1,reducedMotionConfig:c}));const h=u.current;ee.useInsertionEffect(()=>{h&&h.update(t,a)});const f=ee.useRef(!!(t[Cw]&&!window.HandoffComplete));return Sw(()=>{h&&(h.render(),f.current&&h.animationState&&h.animationState.animateChanges())}),ee.useEffect(()=>{h&&(h.updateFeatures(),!f.current&&h.animationState&&h.animationState.animateChanges(),f.current&&(f.current=!1,window.HandoffComplete=!0))}),h}function va(n){return n&&typeof n=="object"&&Object.prototype.hasOwnProperty.call(n,"current")}function aT(n,e,t){return ee.useCallback(r=>{r&&n.mount&&n.mount(r),e&&(r?e.mount(r):e.unmount()),t&&(typeof t=="function"?t(r):va(t)&&(t.current=r))},[e])}function Gc(n){return typeof n=="string"||Array.isArray(n)}function o1(n){return n!==null&&typeof n=="object"&&typeof n.start=="function"}const bm=["animate","whileInView","whileFocus","whileHover","whileTap","whileDrag","exit"],xm=["initial",...bm];function a1(n){return o1(n.animate)||xm.some(e=>Gc(n[e]))}function kw(n){return!!(a1(n)||n.variants)}function lT(n,e){if(a1(n)){const{initial:t,animate:r}=n;return{initial:t===!1||Gc(t)?t:void 0,animate:Gc(r)?r:void 0}}return n.inherit!==!1?e:{}}function cT(n){const{initial:e,animate:t}=lT(n,ee.useContext(s1));return ee.useMemo(()=>({initial:e,animate:t}),[A6(e),A6(t)])}function A6(n){return Array.isArray(n)?n.join(" "):n}const P6={animation:["animate","variants","whileHover","whileTap","exit","whileInView","whileFocus","whileDrag"],exit:["exit"],drag:["drag","dragControls"],focus:["whileFocus"],hover:["whileHover","onHoverStart","onHoverEnd"],tap:["whileTap","onTap","onTapStart","onTapCancel"],pan:["onPan","onPanStart","onPanSessionStart","onPanEnd"],inView:["whileInView","onViewportEnter","onViewportLeave"],layout:["layout","layoutId"]},Qc={};for(const n in P6)Qc[n]={isEnabled:e=>P6[n].some(t=>!!e[t])};function uT(n){for(const e in n)Qc[e]={...Qc[e],...n[e]}}const Aw=ee.createContext({}),Pw=ee.createContext({}),dT=Symbol.for("motionComponentSymbol");function hT({preloadedFeatures:n,createVisualElement:e,useRender:t,useVisualState:r,Component:s}){n&&uT(n);function i(c,u){let h;const f={...ee.useContext(ym),...c,layoutId:fT(c)},{isStatic:p}=f,m=cT(c),w=r(c,p);if(!p&&i1){m.visualElement=oT(s,w,f,e);const x=ee.useContext(Pw),S=ee.useContext(Ew).strict;m.visualElement&&(h=m.visualElement.loadFeatures(f,S,n,x))}return ee.createElement(s1.Provider,{value:m},h&&m.visualElement?ee.createElement(h,{visualElement:m.visualElement,...f}):null,t(s,c,aT(w,m.visualElement,u),w,p,m.visualElement))}const a=ee.forwardRef(i);return a[dT]=s,a}function fT({layoutId:n}){const e=ee.useContext(Aw).id;return e&&n!==void 0?e+"-"+n:n}function pT(n){function e(r,s={}){return hT(n(r,s))}if(typeof Proxy>"u")return e;const t=new Map;return new Proxy(e,{get:(r,s)=>(t.has(s)||t.set(s,e(s)),t.get(s))})}const gT=["animate","circle","defs","desc","ellipse","g","image","line","filter","marker","mask","metadata","path","pattern","polygon","polyline","rect","stop","switch","symbol","svg","text","tspan","use","view"];function Sm(n){return typeof n!="string"||n.includes("-")?!1:!!(gT.indexOf(n)>-1||/[A-Z]/.test(n))}const Jh={};function mT(n){Object.assign(Jh,n)}const Iu=["transformPerspective","x","y","z","translateX","translateY","translateZ","scale","scaleX","scaleY","rotate","rotateX","rotateY","rotateZ","skew","skewX","skewY"],ko=new Set(Iu);function Tw(n,{layout:e,layoutId:t}){return ko.has(n)||n.startsWith("origin")||(e||t!==void 0)&&(!!Jh[n]||n==="opacity")}const Pn=n=>!!(n&&n.getVelocity),yT={x:"translateX",y:"translateY",z:"translateZ",transformPerspective:"perspective"},wT=Iu.length;function vT(n,{enableHardwareAcceleration:e=!0,allowTransformNone:t=!0},r,s){let i="";for(let a=0;a<wT;a++){const c=Iu[a];if(n[c]!==void 0){const u=yT[c]||c;i+=`${u}(${n[c]}) `}}return e&&!n.z&&(i+="translateZ(0)"),i=i.trim(),s?i=s(n,r?"":i):t&&r&&(i="none"),i}const _w=n=>e=>typeof e=="string"&&e.startsWith(n),Dw=_w("--"),og=_w("var(--"),bT=/var\s*\(\s*--[\w-]+(\s*,\s*(?:(?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)+)?\s*\)/g,xT=(n,e)=>e&&typeof n=="number"?e.transform(n):n,vi=(n,e,t)=>Math.min(Math.max(t,n),e),Ao={test:n=>typeof n=="number",parse:parseFloat,transform:n=>n},Nc={...Ao,transform:n=>vi(0,1,n)},uh={...Ao,default:1},Mc=n=>Math.round(n*1e5)/1e5,l1=/(-)?([\d]*\.?[\d])+/g,Iw=/(#[0-9a-f]{3,8}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2}(-?[\d\.]+%?)\s*[\,\/]?\s*[\d\.]*%?\))/gi,ST=/^(#[0-9a-f]{3,8}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2}(-?[\d\.]+%?)\s*[\,\/]?\s*[\d\.]*%?\))$/i;function Nu(n){return typeof n=="string"}const Mu=n=>({test:e=>Nu(e)&&e.endsWith(n)&&e.split(" ").length===1,parse:parseFloat,transform:e=>`${e}${n}`}),ii=Mu("deg"),$r=Mu("%"),Ee=Mu("px"),ET=Mu("vh"),CT=Mu("vw"),T6={...$r,parse:n=>$r.parse(n)/100,transform:n=>$r.transform(n*100)},_6={...Ao,transform:Math.round},Nw={borderWidth:Ee,borderTopWidth:Ee,borderRightWidth:Ee,borderBottomWidth:Ee,borderLeftWidth:Ee,borderRadius:Ee,radius:Ee,borderTopLeftRadius:Ee,borderTopRightRadius:Ee,borderBottomRightRadius:Ee,borderBottomLeftRadius:Ee,width:Ee,maxWidth:Ee,height:Ee,maxHeight:Ee,size:Ee,top:Ee,right:Ee,bottom:Ee,left:Ee,padding:Ee,paddingTop:Ee,paddingRight:Ee,paddingBottom:Ee,paddingLeft:Ee,margin:Ee,marginTop:Ee,marginRight:Ee,marginBottom:Ee,marginLeft:Ee,rotate:ii,rotateX:ii,rotateY:ii,rotateZ:ii,scale:uh,scaleX:uh,scaleY:uh,scaleZ:uh,skew:ii,skewX:ii,skewY:ii,distance:Ee,translateX:Ee,translateY:Ee,translateZ:Ee,x:Ee,y:Ee,z:Ee,perspective:Ee,transformPerspective:Ee,opacity:Nc,originX:T6,originY:T6,originZ:Ee,zIndex:_6,fillOpacity:Nc,strokeOpacity:Nc,numOctaves:_6};function Em(n,e,t,r){const{style:s,vars:i,transform:a,transformOrigin:c}=n;let u=!1,h=!1,f=!0;for(const p in e){const m=e[p];if(Dw(p)){i[p]=m;continue}const w=Nw[p],x=xT(m,w);if(ko.has(p)){if(u=!0,a[p]=x,!f)continue;m!==(w.default||0)&&(f=!1)}else p.startsWith("origin")?(h=!0,c[p]=x):s[p]=x}if(e.transform||(u||r?s.transform=vT(n.transform,t,f,r):s.transform&&(s.transform="none")),h){const{originX:p="50%",originY:m="50%",originZ:w=0}=c;s.transformOrigin=`${p} ${m} ${w}`}}const Cm=()=>({style:{},transform:{},transformOrigin:{},vars:{}});function Mw(n,e,t){for(const r in e)!Pn(e[r])&&!Tw(r,t)&&(n[r]=e[r])}function kT({transformTemplate:n},e,t){return ee.useMemo(()=>{const r=Cm();return Em(r,e,{enableHardwareAcceleration:!t},n),Object.assign({},r.vars,r.style)},[e])}function AT(n,e,t){const r=n.style||{},s={};return Mw(s,r,n),Object.assign(s,kT(n,e,t)),n.transformValues?n.transformValues(s):s}function PT(n,e,t){const r={},s=AT(n,e,t);return n.drag&&n.dragListener!==!1&&(r.draggable=!1,s.userSelect=s.WebkitUserSelect=s.WebkitTouchCallout="none",s.touchAction=n.drag===!0?"none":`pan-${n.drag==="x"?"y":"x"}`),n.tabIndex===void 0&&(n.onTap||n.onTapStart||n.whileTap)&&(r.tabIndex=0),r.style=s,r}const TT=new Set(["animate","exit","variants","initial","style","values","variants","transition","transformTemplate","transformValues","custom","inherit","onBeforeLayoutMeasure","onAnimationStart","onAnimationComplete","onUpdate","onDragStart","onDrag","onDragEnd","onMeasureDragConstraints","onDirectionLock","onDragTransitionEnd","_dragX","_dragY","onHoverStart","onHoverEnd","onViewportEnter","onViewportLeave","globalTapTarget","ignoreStrict","viewport"]);function Zh(n){return n.startsWith("while")||n.startsWith("drag")&&n!=="draggable"||n.startsWith("layout")||n.startsWith("onTap")||n.startsWith("onPan")||n.startsWith("onLayout")||TT.has(n)}let Rw=n=>!Zh(n);function _T(n){n&&(Rw=e=>e.startsWith("on")?!Zh(e):n(e))}try{_T(require("@emotion/is-prop-valid").default)}catch{}function DT(n,e,t){const r={};for(const s in n)s==="values"&&typeof n.values=="object"||(Rw(s)||t===!0&&Zh(s)||!e&&!Zh(s)||n.draggable&&s.startsWith("onDrag"))&&(r[s]=n[s]);return r}function D6(n,e,t){return typeof n=="string"?n:Ee.transform(e+t*n)}function IT(n,e,t){const r=D6(e,n.x,n.width),s=D6(t,n.y,n.height);return`${r} ${s}`}const NT={offset:"stroke-dashoffset",array:"stroke-dasharray"},MT={offset:"strokeDashoffset",array:"strokeDasharray"};function RT(n,e,t=1,r=0,s=!0){n.pathLength=1;const i=s?NT:MT;n[i.offset]=Ee.transform(-r);const a=Ee.transform(e),c=Ee.transform(t);n[i.array]=`${a} ${c}`}function km(n,{attrX:e,attrY:t,attrScale:r,originX:s,originY:i,pathLength:a,pathSpacing:c=1,pathOffset:u=0,...h},f,p,m){if(Em(n,h,f,m),p){n.style.viewBox&&(n.attrs.viewBox=n.style.viewBox);return}n.attrs=n.style,n.style={};const{attrs:w,style:x,dimensions:S}=n;w.transform&&(S&&(x.transform=w.transform),delete w.transform),S&&(s!==void 0||i!==void 0||x.transform)&&(x.transformOrigin=IT(S,s!==void 0?s:.5,i!==void 0?i:.5)),e!==void 0&&(w.x=e),t!==void 0&&(w.y=t),r!==void 0&&(w.scale=r),a!==void 0&&RT(w,a,c,u,!1)}const Lw=()=>({...Cm(),attrs:{}}),Am=n=>typeof n=="string"&&n.toLowerCase()==="svg";function LT(n,e,t,r){const s=ee.useMemo(()=>{const i=Lw();return km(i,e,{enableHardwareAcceleration:!1},Am(r),n.transformTemplate),{...i.attrs,style:{...i.style}}},[e]);if(n.style){const i={};Mw(i,n.style,n),s.style={...i,...s.style}}return s}function OT(n=!1){return(t,r,s,{latestValues:i},a)=>{const u=(Sm(t)?LT:PT)(r,i,a,t),f={...DT(r,typeof t=="string",n),...u,ref:s},{children:p}=r,m=ee.useMemo(()=>Pn(p)?p.get():p,[p]);return ee.createElement(t,{...f,children:m})}}function Ow(n,{style:e,vars:t},r,s){Object.assign(n.style,e,s&&s.getProjectionStyles(r));for(const i in t)n.style.setProperty(i,t[i])}const Bw=new Set(["baseFrequency","diffuseConstant","kernelMatrix","kernelUnitLength","keySplines","keyTimes","limitingConeAngle","markerHeight","markerWidth","numOctaves","targetX","targetY","surfaceScale","specularConstant","specularExponent","stdDeviation","tableValues","viewBox","gradientTransform","pathLength","startOffset","textLength","lengthAdjust"]);function Fw(n,e,t,r){Ow(n,e,void 0,r);for(const s in e.attrs)n.setAttribute(Bw.has(s)?s:vm(s),e.attrs[s])}function Pm(n,e){const{style:t}=n,r={};for(const s in t)(Pn(t[s])||e.style&&Pn(e.style[s])||Tw(s,n))&&(r[s]=t[s]);return r}function Uw(n,e){const t=Pm(n,e);for(const r in n)if(Pn(n[r])||Pn(e[r])){const s=Iu.indexOf(r)!==-1?"attr"+r.charAt(0).toUpperCase()+r.substring(1):r;t[s]=n[r]}return t}function Tm(n,e,t,r={},s={}){return typeof e=="function"&&(e=e(t!==void 0?t:n.custom,r,s)),typeof e=="string"&&(e=n.variants&&n.variants[e]),typeof e=="function"&&(e=e(t!==void 0?t:n.custom,r,s)),e}function _m(n){const e=ee.useRef(null);return e.current===null&&(e.current=n()),e.current}const ef=n=>Array.isArray(n),BT=n=>!!(n&&typeof n=="object"&&n.mix&&n.toValue),FT=n=>ef(n)?n[n.length-1]||0:n;function jh(n){const e=Pn(n)?n.get():n;return BT(e)?e.toValue():e}function UT({scrapeMotionValuesFromProps:n,createRenderState:e,onMount:t},r,s,i){const a={latestValues:VT(r,s,i,n),renderState:e()};return t&&(a.mount=c=>t(r,c,a)),a}const Vw=n=>(e,t)=>{const r=ee.useContext(s1),s=ee.useContext(wm),i=()=>UT(n,e,r,s);return t?i():_m(i)};function VT(n,e,t,r){const s={},i=r(n,{});for(const m in i)s[m]=jh(i[m]);let{initial:a,animate:c}=n;const u=a1(n),h=kw(n);e&&h&&!u&&n.inherit!==!1&&(a===void 0&&(a=e.initial),c===void 0&&(c=e.animate));let f=t?t.initial===!1:!1;f=f||a===!1;const p=f?c:a;return p&&typeof p!="boolean"&&!o1(p)&&(Array.isArray(p)?p:[p]).forEach(w=>{const x=Tm(n,w);if(!x)return;const{transitionEnd:S,transition:E,...A}=x;for(const P in A){let k=A[P];if(Array.isArray(k)){const F=f?k.length-1:0;k=k[F]}k!==null&&(s[P]=k)}for(const P in S)s[P]=S[P]}),s}const xt=n=>n;let I6=class{constructor(){this.order=[],this.scheduled=new Set}add(e){if(!this.scheduled.has(e))return this.scheduled.add(e),this.order.push(e),!0}remove(e){const t=this.order.indexOf(e);t!==-1&&(this.order.splice(t,1),this.scheduled.delete(e))}clear(){this.order.length=0,this.scheduled.clear()}};function jT(n){let e=new I6,t=new I6,r=0,s=!1,i=!1;const a=new WeakSet,c={schedule:(u,h=!1,f=!1)=>{const p=f&&s,m=p?e:t;return h&&a.add(u),m.add(u)&&p&&s&&(r=e.order.length),u},cancel:u=>{t.remove(u),a.delete(u)},process:u=>{if(s){i=!0;return}if(s=!0,[e,t]=[t,e],t.clear(),r=e.order.length,r)for(let h=0;h<r;h++){const f=e.order[h];f(u),a.has(f)&&(c.schedule(f),n())}s=!1,i&&(i=!1,c.process(u))}};return c}const dh=["prepare","read","update","preRender","render","postRender"],$T=40;function zT(n,e){let t=!1,r=!0;const s={delta:0,timestamp:0,isProcessing:!1},i=dh.reduce((p,m)=>(p[m]=jT(()=>t=!0),p),{}),a=p=>i[p].process(s),c=()=>{const p=performance.now();t=!1,s.delta=r?1e3/60:Math.max(Math.min(p-s.timestamp,$T),1),s.timestamp=p,s.isProcessing=!0,dh.forEach(a),s.isProcessing=!1,t&&e&&(r=!1,n(c))},u=()=>{t=!0,r=!0,s.isProcessing||n(c)};return{schedule:dh.reduce((p,m)=>{const w=i[m];return p[m]=(x,S=!1,E=!1)=>(t||u(),w.schedule(x,S,E)),p},{}),cancel:p=>dh.forEach(m=>i[m].cancel(p)),state:s,steps:i}}const{schedule:nt,cancel:Kr,state:nn,steps:Wp}=zT(typeof requestAnimationFrame<"u"?requestAnimationFrame:xt,!0),HT={useVisualState:Vw({scrapeMotionValuesFromProps:Uw,createRenderState:Lw,onMount:(n,e,{renderState:t,latestValues:r})=>{nt.read(()=>{try{t.dimensions=typeof e.getBBox=="function"?e.getBBox():e.getBoundingClientRect()}catch{t.dimensions={x:0,y:0,width:0,height:0}}}),nt.render(()=>{km(t,r,{enableHardwareAcceleration:!1},Am(e.tagName),n.transformTemplate),Fw(e,t)})}})},KT={useVisualState:Vw({scrapeMotionValuesFromProps:Pm,createRenderState:Cm})};function qT(n,{forwardMotionProps:e=!1},t,r){return{...Sm(n)?HT:KT,preloadedFeatures:t,useRender:OT(e),createVisualElement:r,Component:n}}function ps(n,e,t,r={passive:!0}){return n.addEventListener(e,t,r),()=>n.removeEventListener(e,t)}const jw=n=>n.pointerType==="mouse"?typeof n.button!="number"||n.button<=0:n.isPrimary!==!1;function c1(n,e="page"){return{point:{x:n[e+"X"],y:n[e+"Y"]}}}const WT=n=>e=>jw(e)&&n(e,c1(e));function ms(n,e,t,r){return ps(n,e,WT(t),r)}const GT=(n,e)=>t=>e(n(t)),pi=(...n)=>n.reduce(GT);function $w(n){let e=null;return()=>{const t=()=>{e=null};return e===null?(e=n,t):!1}}const N6=$w("dragHorizontal"),M6=$w("dragVertical");function zw(n){let e=!1;if(n==="y")e=M6();else if(n==="x")e=N6();else{const t=N6(),r=M6();t&&r?e=()=>{t(),r()}:(t&&t(),r&&r())}return e}function Hw(){const n=zw(!0);return n?(n(),!1):!0}class Ti{constructor(e){this.isMounted=!1,this.node=e}update(){}}function R6(n,e){const t="pointer"+(e?"enter":"leave"),r="onHover"+(e?"Start":"End"),s=(i,a)=>{if(i.pointerType==="touch"||Hw())return;const c=n.getProps();n.animationState&&c.whileHover&&n.animationState.setActive("whileHover",e),c[r]&&nt.update(()=>c[r](i,a))};return ms(n.current,t,s,{passive:!n.getProps()[r]})}class QT extends Ti{mount(){this.unmount=pi(R6(this.node,!0),R6(this.node,!1))}unmount(){}}class YT extends Ti{constructor(){super(...arguments),this.isActive=!1}onFocus(){let e=!1;try{e=this.node.current.matches(":focus-visible")}catch{e=!0}!e||!this.node.animationState||(this.node.animationState.setActive("whileFocus",!0),this.isActive=!0)}onBlur(){!this.isActive||!this.node.animationState||(this.node.animationState.setActive("whileFocus",!1),this.isActive=!1)}mount(){this.unmount=pi(ps(this.node.current,"focus",()=>this.onFocus()),ps(this.node.current,"blur",()=>this.onBlur()))}unmount(){}}const Kw=(n,e)=>e?n===e?!0:Kw(n,e.parentElement):!1;function Gp(n,e){if(!e)return;const t=new PointerEvent("pointer"+n);e(t,c1(t))}class XT extends Ti{constructor(){super(...arguments),this.removeStartListeners=xt,this.removeEndListeners=xt,this.removeAccessibleListeners=xt,this.startPointerPress=(e,t)=>{if(this.isPressing)return;this.removeEndListeners();const r=this.node.getProps(),i=ms(window,"pointerup",(c,u)=>{if(!this.checkPressEnd())return;const{onTap:h,onTapCancel:f,globalTapTarget:p}=this.node.getProps();nt.update(()=>{!p&&!Kw(this.node.current,c.target)?f&&f(c,u):h&&h(c,u)})},{passive:!(r.onTap||r.onPointerUp)}),a=ms(window,"pointercancel",(c,u)=>this.cancelPress(c,u),{passive:!(r.onTapCancel||r.onPointerCancel)});this.removeEndListeners=pi(i,a),this.startPress(e,t)},this.startAccessiblePress=()=>{const e=i=>{if(i.key!=="Enter"||this.isPressing)return;const a=c=>{c.key!=="Enter"||!this.checkPressEnd()||Gp("up",(u,h)=>{const{onTap:f}=this.node.getProps();f&&nt.update(()=>f(u,h))})};this.removeEndListeners(),this.removeEndListeners=ps(this.node.current,"keyup",a),Gp("down",(c,u)=>{this.startPress(c,u)})},t=ps(this.node.current,"keydown",e),r=()=>{this.isPressing&&Gp("cancel",(i,a)=>this.cancelPress(i,a))},s=ps(this.node.current,"blur",r);this.removeAccessibleListeners=pi(t,s)}}startPress(e,t){this.isPressing=!0;const{onTapStart:r,whileTap:s}=this.node.getProps();s&&this.node.animationState&&this.node.animationState.setActive("whileTap",!0),r&&nt.update(()=>r(e,t))}checkPressEnd(){return this.removeEndListeners(),this.isPressing=!1,this.node.getProps().whileTap&&this.node.animationState&&this.node.animationState.setActive("whileTap",!1),!Hw()}cancelPress(e,t){if(!this.checkPressEnd())return;const{onTapCancel:r}=this.node.getProps();r&&nt.update(()=>r(e,t))}mount(){const e=this.node.getProps(),t=ms(e.globalTapTarget?window:this.node.current,"pointerdown",this.startPointerPress,{passive:!(e.onTapStart||e.onPointerStart)}),r=ps(this.node.current,"focus",this.startAccessiblePress);this.removeStartListeners=pi(t,r)}unmount(){this.removeStartListeners(),this.removeEndListeners(),this.removeAccessibleListeners()}}const ag=new WeakMap,Qp=new WeakMap,JT=n=>{const e=ag.get(n.target);e&&e(n)},ZT=n=>{n.forEach(JT)};function e_({root:n,...e}){const t=n||document;Qp.has(t)||Qp.set(t,{});const r=Qp.get(t),s=JSON.stringify(e);return r[s]||(r[s]=new IntersectionObserver(ZT,{root:n,...e})),r[s]}function t_(n,e,t){const r=e_(e);return ag.set(n,t),r.observe(n),()=>{ag.delete(n),r.unobserve(n)}}const n_={some:0,all:1};class r_ extends Ti{constructor(){super(...arguments),this.hasEnteredView=!1,this.isInView=!1}startObserver(){this.unmount();const{viewport:e={}}=this.node.getProps(),{root:t,margin:r,amount:s="some",once:i}=e,a={root:t?t.current:void 0,rootMargin:r,threshold:typeof s=="number"?s:n_[s]},c=u=>{const{isIntersecting:h}=u;if(this.isInView===h||(this.isInView=h,i&&!h&&this.hasEnteredView))return;h&&(this.hasEnteredView=!0),this.node.animationState&&this.node.animationState.setActive("whileInView",h);const{onViewportEnter:f,onViewportLeave:p}=this.node.getProps(),m=h?f:p;m&&m(u)};return t_(this.node.current,a,c)}mount(){this.startObserver()}update(){if(typeof IntersectionObserver>"u")return;const{props:e,prevProps:t}=this.node;["amount","margin","root"].some(s_(e,t))&&this.startObserver()}unmount(){}}function s_({viewport:n={}},{viewport:e={}}={}){return t=>n[t]!==e[t]}const i_={inView:{Feature:r_},tap:{Feature:XT},focus:{Feature:YT},hover:{Feature:QT}};function qw(n,e){if(!Array.isArray(e))return!1;const t=e.length;if(t!==n.length)return!1;for(let r=0;r<t;r++)if(e[r]!==n[r])return!1;return!0}function o_(n){const e={};return n.values.forEach((t,r)=>e[r]=t.get()),e}function a_(n){const e={};return n.values.forEach((t,r)=>e[r]=t.getVelocity()),e}function u1(n,e,t){const r=n.getProps();return Tm(r,e,t!==void 0?t:r.custom,o_(n),a_(n))}let Dm=xt;const so=n=>n*1e3,ys=n=>n/1e3,l_={current:!1},Ww=n=>Array.isArray(n)&&typeof n[0]=="number";function Gw(n){return!!(!n||typeof n=="string"&&Qw[n]||Ww(n)||Array.isArray(n)&&n.every(Gw))}const Pc=([n,e,t,r])=>`cubic-bezier(${n}, ${e}, ${t}, ${r})`,Qw={linear:"linear",ease:"ease",easeIn:"ease-in",easeOut:"ease-out",easeInOut:"ease-in-out",circIn:Pc([0,.65,.55,1]),circOut:Pc([.55,0,1,.45]),backIn:Pc([.31,.01,.66,-.59]),backOut:Pc([.33,1.53,.69,.99])};function Yw(n){if(n)return Ww(n)?Pc(n):Array.isArray(n)?n.map(Yw):Qw[n]}function c_(n,e,t,{delay:r=0,duration:s,repeat:i=0,repeatType:a="loop",ease:c,times:u}={}){const h={[e]:t};u&&(h.offset=u);const f=Yw(c);return Array.isArray(f)&&(h.easing=f),n.animate(h,{delay:r,duration:s,easing:Array.isArray(f)?"linear":f,fill:"both",iterations:i+1,direction:a==="reverse"?"alternate":"normal"})}function u_(n,{repeat:e,repeatType:t="loop"}){const r=e&&t!=="loop"&&e%2===1?0:n.length-1;return n[r]}const Xw=(n,e,t)=>(((1-3*t+3*e)*n+(3*t-6*e))*n+3*e)*n,d_=1e-7,h_=12;function f_(n,e,t,r,s){let i,a,c=0;do a=e+(t-e)/2,i=Xw(a,r,s)-n,i>0?t=a:e=a;while(Math.abs(i)>d_&&++c<h_);return a}function Ru(n,e,t,r){if(n===e&&t===r)return xt;const s=i=>f_(i,0,1,n,t);return i=>i===0||i===1?i:Xw(s(i),e,r)}const p_=Ru(.42,0,1,1),g_=Ru(0,0,.58,1),Jw=Ru(.42,0,.58,1),m_=n=>Array.isArray(n)&&typeof n[0]!="number",Zw=n=>e=>e<=.5?n(2*e)/2:(2-n(2*(1-e)))/2,ev=n=>e=>1-n(1-e),Im=n=>1-Math.sin(Math.acos(n)),tv=ev(Im),y_=Zw(Im),nv=Ru(.33,1.53,.69,.99),Nm=ev(nv),w_=Zw(Nm),v_=n=>(n*=2)<1?.5*Nm(n):.5*(2-Math.pow(2,-10*(n-1))),b_={linear:xt,easeIn:p_,easeInOut:Jw,easeOut:g_,circIn:Im,circInOut:y_,circOut:tv,backIn:Nm,backInOut:w_,backOut:nv,anticipate:v_},L6=n=>{if(Array.isArray(n)){Dm(n.length===4);const[e,t,r,s]=n;return Ru(e,t,r,s)}else if(typeof n=="string")return b_[n];return n},Mm=(n,e)=>t=>!!(Nu(t)&&ST.test(t)&&t.startsWith(n)||e&&Object.prototype.hasOwnProperty.call(t,e)),rv=(n,e,t)=>r=>{if(!Nu(r))return r;const[s,i,a,c]=r.match(l1);return{[n]:parseFloat(s),[e]:parseFloat(i),[t]:parseFloat(a),alpha:c!==void 0?parseFloat(c):1}},x_=n=>vi(0,255,n),Yp={...Ao,transform:n=>Math.round(x_(n))},Xi={test:Mm("rgb","red"),parse:rv("red","green","blue"),transform:({red:n,green:e,blue:t,alpha:r=1})=>"rgba("+Yp.transform(n)+", "+Yp.transform(e)+", "+Yp.transform(t)+", "+Mc(Nc.transform(r))+")"};function S_(n){let e="",t="",r="",s="";return n.length>5?(e=n.substring(1,3),t=n.substring(3,5),r=n.substring(5,7),s=n.substring(7,9)):(e=n.substring(1,2),t=n.substring(2,3),r=n.substring(3,4),s=n.substring(4,5),e+=e,t+=t,r+=r,s+=s),{red:parseInt(e,16),green:parseInt(t,16),blue:parseInt(r,16),alpha:s?parseInt(s,16)/255:1}}const lg={test:Mm("#"),parse:S_,transform:Xi.transform},ba={test:Mm("hsl","hue"),parse:rv("hue","saturation","lightness"),transform:({hue:n,saturation:e,lightness:t,alpha:r=1})=>"hsla("+Math.round(n)+", "+$r.transform(Mc(e))+", "+$r.transform(Mc(t))+", "+Mc(Nc.transform(r))+")"},dn={test:n=>Xi.test(n)||lg.test(n)||ba.test(n),parse:n=>Xi.test(n)?Xi.parse(n):ba.test(n)?ba.parse(n):lg.parse(n),transform:n=>Nu(n)?n:n.hasOwnProperty("red")?Xi.transform(n):ba.transform(n)},ft=(n,e,t)=>-t*n+t*e+n;function Xp(n,e,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?n+(e-n)*6*t:t<1/2?e:t<2/3?n+(e-n)*(2/3-t)*6:n}function E_({hue:n,saturation:e,lightness:t,alpha:r}){n/=360,e/=100,t/=100;let s=0,i=0,a=0;if(!e)s=i=a=t;else{const c=t<.5?t*(1+e):t+e-t*e,u=2*t-c;s=Xp(u,c,n+1/3),i=Xp(u,c,n),a=Xp(u,c,n-1/3)}return{red:Math.round(s*255),green:Math.round(i*255),blue:Math.round(a*255),alpha:r}}const Jp=(n,e,t)=>{const r=n*n;return Math.sqrt(Math.max(0,t*(e*e-r)+r))},C_=[lg,Xi,ba],k_=n=>C_.find(e=>e.test(n));function O6(n){const e=k_(n);let t=e.parse(n);return e===ba&&(t=E_(t)),t}const sv=(n,e)=>{const t=O6(n),r=O6(e),s={...t};return i=>(s.red=Jp(t.red,r.red,i),s.green=Jp(t.green,r.green,i),s.blue=Jp(t.blue,r.blue,i),s.alpha=ft(t.alpha,r.alpha,i),Xi.transform(s))};function A_(n){var e,t;return isNaN(n)&&Nu(n)&&(((e=n.match(l1))===null||e===void 0?void 0:e.length)||0)+(((t=n.match(Iw))===null||t===void 0?void 0:t.length)||0)>0}const iv={regex:bT,countKey:"Vars",token:"${v}",parse:xt},ov={regex:Iw,countKey:"Colors",token:"${c}",parse:dn.parse},av={regex:l1,countKey:"Numbers",token:"${n}",parse:Ao.parse};function Zp(n,{regex:e,countKey:t,token:r,parse:s}){const i=n.tokenised.match(e);i&&(n["num"+t]=i.length,n.tokenised=n.tokenised.replace(e,r),n.values.push(...i.map(s)))}function tf(n){const e=n.toString(),t={value:e,tokenised:e,values:[],numVars:0,numColors:0,numNumbers:0};return t.value.includes("var(--")&&Zp(t,iv),Zp(t,ov),Zp(t,av),t}function lv(n){return tf(n).values}function cv(n){const{values:e,numColors:t,numVars:r,tokenised:s}=tf(n),i=e.length;return a=>{let c=s;for(let u=0;u<i;u++)u<r?c=c.replace(iv.token,a[u]):u<r+t?c=c.replace(ov.token,dn.transform(a[u])):c=c.replace(av.token,Mc(a[u]));return c}}const P_=n=>typeof n=="number"?0:n;function T_(n){const e=lv(n);return cv(n)(e.map(P_))}const bi={test:A_,parse:lv,createTransformer:cv,getAnimatableNone:T_},uv=(n,e)=>t=>`${t>0?e:n}`;function dv(n,e){return typeof n=="number"?t=>ft(n,e,t):dn.test(n)?sv(n,e):n.startsWith("var(")?uv(n,e):fv(n,e)}const hv=(n,e)=>{const t=[...n],r=t.length,s=n.map((i,a)=>dv(i,e[a]));return i=>{for(let a=0;a<r;a++)t[a]=s[a](i);return t}},__=(n,e)=>{const t={...n,...e},r={};for(const s in t)n[s]!==void 0&&e[s]!==void 0&&(r[s]=dv(n[s],e[s]));return s=>{for(const i in r)t[i]=r[i](s);return t}},fv=(n,e)=>{const t=bi.createTransformer(e),r=tf(n),s=tf(e);return r.numVars===s.numVars&&r.numColors===s.numColors&&r.numNumbers>=s.numNumbers?pi(hv(r.values,s.values),t):uv(n,e)},Yc=(n,e,t)=>{const r=e-n;return r===0?1:(t-n)/r},B6=(n,e)=>t=>ft(n,e,t);function D_(n){return typeof n=="number"?B6:typeof n=="string"?dn.test(n)?sv:fv:Array.isArray(n)?hv:typeof n=="object"?__:B6}function I_(n,e,t){const r=[],s=t||D_(n[0]),i=n.length-1;for(let a=0;a<i;a++){let c=s(n[a],n[a+1]);if(e){const u=Array.isArray(e)?e[a]||xt:e;c=pi(u,c)}r.push(c)}return r}function Rm(n,e,{clamp:t=!0,ease:r,mixer:s}={}){const i=n.length;if(Dm(i===e.length),i===1)return()=>e[0];n[0]>n[i-1]&&(n=[...n].reverse(),e=[...e].reverse());const a=I_(e,r,s),c=a.length,u=h=>{let f=0;if(c>1)for(;f<n.length-2&&!(h<n[f+1]);f++);const p=Yc(n[f],n[f+1],h);return a[f](p)};return t?h=>u(vi(n[0],n[i-1],h)):u}function N_(n,e){const t=n[n.length-1];for(let r=1;r<=e;r++){const s=Yc(0,e,r);n.push(ft(t,1,s))}}function M_(n){const e=[0];return N_(e,n.length-1),e}function R_(n,e){return n.map(t=>t*e)}function L_(n,e){return n.map(()=>e||Jw).splice(0,n.length-1)}function nf({duration:n=300,keyframes:e,times:t,ease:r="easeInOut"}){const s=m_(r)?r.map(L6):L6(r),i={done:!1,value:e[0]},a=R_(t&&t.length===e.length?t:M_(e),n),c=Rm(a,e,{ease:Array.isArray(s)?s:L_(e,s)});return{calculatedDuration:n,next:u=>(i.value=c(u),i.done=u>=n,i)}}function pv(n,e){return e?n*(1e3/e):0}const O_=5;function gv(n,e,t){const r=Math.max(e-O_,0);return pv(t-n(r),e-r)}const e2=.001,B_=.01,F_=10,U_=.05,V_=1;function j_({duration:n=800,bounce:e=.25,velocity:t=0,mass:r=1}){let s,i,a=1-e;a=vi(U_,V_,a),n=vi(B_,F_,ys(n)),a<1?(s=h=>{const f=h*a,p=f*n,m=f-t,w=cg(h,a),x=Math.exp(-p);return e2-m/w*x},i=h=>{const p=h*a*n,m=p*t+t,w=Math.pow(a,2)*Math.pow(h,2)*n,x=Math.exp(-p),S=cg(Math.pow(h,2),a);return(-s(h)+e2>0?-1:1)*((m-w)*x)/S}):(s=h=>{const f=Math.exp(-h*n),p=(h-t)*n+1;return-e2+f*p},i=h=>{const f=Math.exp(-h*n),p=(t-h)*(n*n);return f*p});const c=5/n,u=z_(s,i,c);if(n=so(n),isNaN(u))return{stiffness:100,damping:10,duration:n};{const h=Math.pow(u,2)*r;return{stiffness:h,damping:a*2*Math.sqrt(r*h),duration:n}}}const $_=12;function z_(n,e,t){let r=t;for(let s=1;s<$_;s++)r=r-n(r)/e(r);return r}function cg(n,e){return n*Math.sqrt(1-e*e)}const H_=["duration","bounce"],K_=["stiffness","damping","mass"];function F6(n,e){return e.some(t=>n[t]!==void 0)}function q_(n){let e={velocity:0,stiffness:100,damping:10,mass:1,isResolvedFromDuration:!1,...n};if(!F6(n,K_)&&F6(n,H_)){const t=j_(n);e={...e,...t,mass:1},e.isResolvedFromDuration=!0}return e}function mv({keyframes:n,restDelta:e,restSpeed:t,...r}){const s=n[0],i=n[n.length-1],a={done:!1,value:s},{stiffness:c,damping:u,mass:h,duration:f,velocity:p,isResolvedFromDuration:m}=q_({...r,velocity:-ys(r.velocity||0)}),w=p||0,x=u/(2*Math.sqrt(c*h)),S=i-s,E=ys(Math.sqrt(c/h)),A=Math.abs(S)<5;t||(t=A?.01:2),e||(e=A?.005:.5);let P;if(x<1){const k=cg(E,x);P=F=>{const I=Math.exp(-x*E*F);return i-I*((w+x*E*S)/k*Math.sin(k*F)+S*Math.cos(k*F))}}else if(x===1)P=k=>i-Math.exp(-E*k)*(S+(w+E*S)*k);else{const k=E*Math.sqrt(x*x-1);P=F=>{const I=Math.exp(-x*E*F),V=Math.min(k*F,300);return i-I*((w+x*E*S)*Math.sinh(V)+k*S*Math.cosh(V))/k}}return{calculatedDuration:m&&f||null,next:k=>{const F=P(k);if(m)a.done=k>=f;else{let I=w;k!==0&&(x<1?I=gv(P,k,F):I=0);const V=Math.abs(I)<=t,Q=Math.abs(i-F)<=e;a.done=V&&Q}return a.value=a.done?i:F,a}}}function U6({keyframes:n,velocity:e=0,power:t=.8,timeConstant:r=325,bounceDamping:s=10,bounceStiffness:i=500,modifyTarget:a,min:c,max:u,restDelta:h=.5,restSpeed:f}){const p=n[0],m={done:!1,value:p},w=D=>c!==void 0&&D<c||u!==void 0&&D>u,x=D=>c===void 0?u:u===void 0||Math.abs(c-D)<Math.abs(u-D)?c:u;let S=t*e;const E=p+S,A=a===void 0?E:a(E);A!==E&&(S=A-p);const P=D=>-S*Math.exp(-D/r),k=D=>A+P(D),F=D=>{const R=P(D),Y=k(D);m.done=Math.abs(R)<=h,m.value=m.done?A:Y};let I,V;const Q=D=>{w(m.value)&&(I=D,V=mv({keyframes:[m.value,x(m.value)],velocity:gv(k,D,m.value),damping:s,stiffness:i,restDelta:h,restSpeed:f}))};return Q(0),{calculatedDuration:null,next:D=>{let R=!1;return!V&&I===void 0&&(R=!0,F(D),Q(D)),I!==void 0&&D>I?V.next(D-I):(!R&&F(D),m)}}}const W_=n=>{const e=({timestamp:t})=>n(t);return{start:()=>nt.update(e,!0),stop:()=>Kr(e),now:()=>nn.isProcessing?nn.timestamp:performance.now()}},V6=2e4;function j6(n){let e=0;const t=50;let r=n.next(e);for(;!r.done&&e<V6;)e+=t,r=n.next(e);return e>=V6?1/0:e}const G_={decay:U6,inertia:U6,tween:nf,keyframes:nf,spring:mv};function rf({autoplay:n=!0,delay:e=0,driver:t=W_,keyframes:r,type:s="keyframes",repeat:i=0,repeatDelay:a=0,repeatType:c="loop",onPlay:u,onStop:h,onComplete:f,onUpdate:p,...m}){let w=1,x=!1,S,E;const A=()=>{E=new Promise(T=>{S=T})};A();let P;const k=G_[s]||nf;let F;k!==nf&&typeof r[0]!="number"&&(F=Rm([0,100],r,{clamp:!1}),r=[0,100]);const I=k({...m,keyframes:r});let V;c==="mirror"&&(V=k({...m,keyframes:[...r].reverse(),velocity:-(m.velocity||0)}));let Q="idle",D=null,R=null,Y=null;I.calculatedDuration===null&&i&&(I.calculatedDuration=j6(I));const{calculatedDuration:J}=I;let X=1/0,B=1/0;J!==null&&(X=J+a,B=X*(i+1)-a);let O=0;const L=T=>{if(R===null)return;w>0&&(R=Math.min(R,T)),w<0&&(R=Math.min(T-B/w,R)),D!==null?O=D:O=Math.round(T-R)*w;const N=O-e*(w>=0?1:-1),Z=w>=0?N<0:N>B;O=Math.max(N,0),Q==="finished"&&D===null&&(O=B);let oe=O,ie=I;if(i){const ge=Math.min(O,B)/X;let De=Math.floor(ge),At=ge%1;!At&&ge>=1&&(At=1),At===1&&De--,De=Math.min(De,i+1),!!(De%2)&&(c==="reverse"?(At=1-At,a&&(At-=a/X)):c==="mirror"&&(ie=V)),oe=vi(0,1,At)*X}const ae=Z?{done:!1,value:r[0]}:ie.next(oe);F&&(ae.value=F(ae.value));let{done:me}=ae;!Z&&J!==null&&(me=w>=0?O>=B:O<=0);const ve=D===null&&(Q==="finished"||Q==="running"&&me);return p&&p(ae.value),ve&&$(),ae},K=()=>{P&&P.stop(),P=void 0},G=()=>{Q="idle",K(),S(),A(),R=Y=null},$=()=>{Q="finished",f&&f(),K(),S()},j=()=>{if(x)return;P||(P=t(L));const T=P.now();u&&u(),D!==null?R=T-D:(!R||Q==="finished")&&(R=T),Q==="finished"&&A(),Y=R,D=null,Q="running",P.start()};n&&j();const H={then(T,N){return E.then(T,N)},get time(){return ys(O)},set time(T){T=so(T),O=T,D!==null||!P||w===0?D=T:R=P.now()-T/w},get duration(){const T=I.calculatedDuration===null?j6(I):I.calculatedDuration;return ys(T)},get speed(){return w},set speed(T){T===w||!P||(w=T,H.time=ys(O))},get state(){return Q},play:j,pause:()=>{Q="paused",D=O},stop:()=>{x=!0,Q!=="idle"&&(Q="idle",h&&h(),G())},cancel:()=>{Y!==null&&L(Y),G()},complete:()=>{Q="finished"},sample:T=>(R=0,L(T))};return H}function Q_(n){let e;return()=>(e===void 0&&(e=n()),e)}const Y_=Q_(()=>Object.hasOwnProperty.call(Element.prototype,"animate")),X_=new Set(["opacity","clipPath","filter","transform","backgroundColor"]),hh=10,J_=2e4,Z_=(n,e)=>e.type==="spring"||n==="backgroundColor"||!Gw(e.ease);function eD(n,e,{onUpdate:t,onComplete:r,...s}){if(!(Y_()&&X_.has(e)&&!s.repeatDelay&&s.repeatType!=="mirror"&&s.damping!==0&&s.type!=="inertia"))return!1;let a=!1,c,u,h=!1;const f=()=>{u=new Promise(k=>{c=k})};f();let{keyframes:p,duration:m=300,ease:w,times:x}=s;if(Z_(e,s)){const k=rf({...s,repeat:0,delay:0});let F={done:!1,value:p[0]};const I=[];let V=0;for(;!F.done&&V<J_;)F=k.sample(V),I.push(F.value),V+=hh;x=void 0,p=I,m=V-hh,w="linear"}const S=c_(n.owner.current,e,p,{...s,duration:m,ease:w,times:x}),E=()=>{h=!1,S.cancel()},A=()=>{h=!0,nt.update(E),c(),f()};return S.onfinish=()=>{h||(n.set(u_(p,s)),r&&r(),A())},{then(k,F){return u.then(k,F)},attachTimeline(k){return S.timeline=k,S.onfinish=null,xt},get time(){return ys(S.currentTime||0)},set time(k){S.currentTime=so(k)},get speed(){return S.playbackRate},set speed(k){S.playbackRate=k},get duration(){return ys(m)},play:()=>{a||(S.play(),Kr(E))},pause:()=>S.pause(),stop:()=>{if(a=!0,S.playState==="idle")return;const{currentTime:k}=S;if(k){const F=rf({...s,autoplay:!1});n.setWithVelocity(F.sample(k-hh).value,F.sample(k).value,hh)}A()},complete:()=>{h||S.finish()},cancel:A}}function tD({keyframes:n,delay:e,onUpdate:t,onComplete:r}){const s=()=>(t&&t(n[n.length-1]),r&&r(),{time:0,speed:1,duration:0,play:xt,pause:xt,stop:xt,then:i=>(i(),Promise.resolve()),cancel:xt,complete:xt});return e?rf({keyframes:[0,1],duration:0,delay:e,onComplete:s}):s()}const nD={type:"spring",stiffness:500,damping:25,restSpeed:10},rD=n=>({type:"spring",stiffness:550,damping:n===0?2*Math.sqrt(550):30,restSpeed:10}),sD={type:"keyframes",duration:.8},iD={type:"keyframes",ease:[.25,.1,.35,1],duration:.3},oD=(n,{keyframes:e})=>e.length>2?sD:ko.has(n)?n.startsWith("scale")?rD(e[1]):nD:iD,ug=(n,e)=>n==="zIndex"?!1:!!(typeof e=="number"||Array.isArray(e)||typeof e=="string"&&(bi.test(e)||e==="0")&&!e.startsWith("url(")),aD=new Set(["brightness","contrast","saturate","opacity"]);function lD(n){const[e,t]=n.slice(0,-1).split("(");if(e==="drop-shadow")return n;const[r]=t.match(l1)||[];if(!r)return n;const s=t.replace(r,"");let i=aD.has(e)?1:0;return r!==t&&(i*=100),e+"("+i+s+")"}const cD=/([a-z-]*)\(.*?\)/g,dg={...bi,getAnimatableNone:n=>{const e=n.match(cD);return e?e.map(lD).join(" "):n}},uD={...Nw,color:dn,backgroundColor:dn,outlineColor:dn,fill:dn,stroke:dn,borderColor:dn,borderTopColor:dn,borderRightColor:dn,borderBottomColor:dn,borderLeftColor:dn,filter:dg,WebkitFilter:dg},Lm=n=>uD[n];function yv(n,e){let t=Lm(n);return t!==dg&&(t=bi),t.getAnimatableNone?t.getAnimatableNone(e):void 0}const wv=n=>/^0[^.\s]+$/.test(n);function dD(n){if(typeof n=="number")return n===0;if(n!==null)return n==="none"||n==="0"||wv(n)}function hD(n,e,t,r){const s=ug(e,t);let i;Array.isArray(t)?i=[...t]:i=[null,t];const a=r.from!==void 0?r.from:n.get();let c;const u=[];for(let h=0;h<i.length;h++)i[h]===null&&(i[h]=h===0?a:i[h-1]),dD(i[h])&&u.push(h),typeof i[h]=="string"&&i[h]!=="none"&&i[h]!=="0"&&(c=i[h]);if(s&&u.length&&c)for(let h=0;h<u.length;h++){const f=u[h];i[f]=yv(e,c)}return i}function fD({when:n,delay:e,delayChildren:t,staggerChildren:r,staggerDirection:s,repeat:i,repeatType:a,repeatDelay:c,from:u,elapsed:h,...f}){return!!Object.keys(f).length}function Om(n,e){return n[e]||n.default||n}const pD={skipAnimations:!1},Bm=(n,e,t,r={})=>s=>{const i=Om(r,n)||{},a=i.delay||r.delay||0;let{elapsed:c=0}=r;c=c-so(a);const u=hD(e,n,t,i),h=u[0],f=u[u.length-1],p=ug(n,h),m=ug(n,f);let w={keyframes:u,velocity:e.getVelocity(),ease:"easeOut",...i,delay:-c,onUpdate:x=>{e.set(x),i.onUpdate&&i.onUpdate(x)},onComplete:()=>{s(),i.onComplete&&i.onComplete()}};if(fD(i)||(w={...w,...oD(n,w)}),w.duration&&(w.duration=so(w.duration)),w.repeatDelay&&(w.repeatDelay=so(w.repeatDelay)),!p||!m||l_.current||i.type===!1||pD.skipAnimations)return tD(w);if(!r.isHandoff&&e.owner&&e.owner.current instanceof HTMLElement&&!e.owner.getProps().onUpdate){const x=eD(e,n,w);if(x)return x}return rf(w)};function sf(n){return!!(Pn(n)&&n.add)}const vv=n=>/^\-?\d*\.?\d+$/.test(n);function Fm(n,e){n.indexOf(e)===-1&&n.push(e)}function Um(n,e){const t=n.indexOf(e);t>-1&&n.splice(t,1)}class Vm{constructor(){this.subscriptions=[]}add(e){return Fm(this.subscriptions,e),()=>Um(this.subscriptions,e)}notify(e,t,r){const s=this.subscriptions.length;if(s)if(s===1)this.subscriptions[0](e,t,r);else for(let i=0;i<s;i++){const a=this.subscriptions[i];a&&a(e,t,r)}}getSize(){return this.subscriptions.length}clear(){this.subscriptions.length=0}}const gD=n=>!isNaN(parseFloat(n)),Rc={current:void 0};class mD{constructor(e,t={}){this.version="10.18.0",this.timeDelta=0,this.lastUpdated=0,this.canTrackVelocity=!1,this.events={},this.updateAndNotify=(r,s=!0)=>{this.prev=this.current,this.current=r;const{delta:i,timestamp:a}=nn;this.lastUpdated!==a&&(this.timeDelta=i,this.lastUpdated=a,nt.postRender(this.scheduleVelocityCheck)),this.prev!==this.current&&this.events.change&&this.events.change.notify(this.current),this.events.velocityChange&&this.events.velocityChange.notify(this.getVelocity()),s&&this.events.renderRequest&&this.events.renderRequest.notify(this.current)},this.scheduleVelocityCheck=()=>nt.postRender(this.velocityCheck),this.velocityCheck=({timestamp:r})=>{r!==this.lastUpdated&&(this.prev=this.current,this.events.velocityChange&&this.events.velocityChange.notify(this.getVelocity()))},this.hasAnimated=!1,this.prev=this.current=e,this.canTrackVelocity=gD(this.current),this.owner=t.owner}onChange(e){return this.on("change",e)}on(e,t){this.events[e]||(this.events[e]=new Vm);const r=this.events[e].add(t);return e==="change"?()=>{r(),nt.read(()=>{this.events.change.getSize()||this.stop()})}:r}clearListeners(){for(const e in this.events)this.events[e].clear()}attach(e,t){this.passiveEffect=e,this.stopPassiveEffect=t}set(e,t=!0){!t||!this.passiveEffect?this.updateAndNotify(e,t):this.passiveEffect(e,this.updateAndNotify)}setWithVelocity(e,t,r){this.set(t),this.prev=e,this.timeDelta=r}jump(e){this.updateAndNotify(e),this.prev=e,this.stop(),this.stopPassiveEffect&&this.stopPassiveEffect()}get(){return Rc.current&&Rc.current.push(this),this.current}getPrevious(){return this.prev}getVelocity(){return this.canTrackVelocity?pv(parseFloat(this.current)-parseFloat(this.prev),this.timeDelta):0}start(e){return this.stop(),new Promise(t=>{this.hasAnimated=!0,this.animation=e(t),this.events.animationStart&&this.events.animationStart.notify()}).then(()=>{this.events.animationComplete&&this.events.animationComplete.notify(),this.clearAnimation()})}stop(){this.animation&&(this.animation.stop(),this.events.animationCancel&&this.events.animationCancel.notify()),this.clearAnimation()}isAnimating(){return!!this.animation}clearAnimation(){delete this.animation}destroy(){this.clearListeners(),this.stop(),this.stopPassiveEffect&&this.stopPassiveEffect()}}function uo(n,e){return new mD(n,e)}const bv=n=>e=>e.test(n),yD={test:n=>n==="auto",parse:n=>n},xv=[Ao,Ee,$r,ii,CT,ET,yD],mc=n=>xv.find(bv(n)),wD=[...xv,dn,bi],vD=n=>wD.find(bv(n));function bD(n,e,t){n.hasValue(e)?n.getValue(e).set(t):n.addValue(e,uo(t))}function xD(n,e){const t=u1(n,e);let{transitionEnd:r={},transition:s={},...i}=t?n.makeTargetAnimatable(t,!1):{};i={...i,...r};for(const a in i){const c=FT(i[a]);bD(n,a,c)}}function SD(n,e,t){var r,s;const i=Object.keys(e).filter(c=>!n.hasValue(c)),a=i.length;if(a)for(let c=0;c<a;c++){const u=i[c],h=e[u];let f=null;Array.isArray(h)&&(f=h[0]),f===null&&(f=(s=(r=t[u])!==null&&r!==void 0?r:n.readValue(u))!==null&&s!==void 0?s:e[u]),f!=null&&(typeof f=="string"&&(vv(f)||wv(f))?f=parseFloat(f):!vD(f)&&bi.test(h)&&(f=yv(u,h)),n.addValue(u,uo(f,{owner:n})),t[u]===void 0&&(t[u]=f),f!==null&&n.setBaseTarget(u,f))}}function ED(n,e){return e?(e[n]||e.default||e).from:void 0}function CD(n,e,t){const r={};for(const s in n){const i=ED(s,e);if(i!==void 0)r[s]=i;else{const a=t.getValue(s);a&&(r[s]=a.get())}}return r}function kD({protectedKeys:n,needsAnimating:e},t){const r=n.hasOwnProperty(t)&&e[t]!==!0;return e[t]=!1,r}function AD(n,e){const t=n.get();if(Array.isArray(e)){for(let r=0;r<e.length;r++)if(e[r]!==t)return!0}else return t!==e}function Sv(n,e,{delay:t=0,transitionOverride:r,type:s}={}){let{transition:i=n.getDefaultTransition(),transitionEnd:a,...c}=n.makeTargetAnimatable(e);const u=n.getValue("willChange");r&&(i=r);const h=[],f=s&&n.animationState&&n.animationState.getState()[s];for(const p in c){const m=n.getValue(p),w=c[p];if(!m||w===void 0||f&&kD(f,p))continue;const x={delay:t,elapsed:0,...Om(i||{},p)};if(window.HandoffAppearAnimations){const A=n.getProps()[Cw];if(A){const P=window.HandoffAppearAnimations(A,p,m,nt);P!==null&&(x.elapsed=P,x.isHandoff=!0)}}let S=!x.isHandoff&&!AD(m,w);if(x.type==="spring"&&(m.getVelocity()||x.velocity)&&(S=!1),m.animation&&(S=!1),S)continue;m.start(Bm(p,m,w,n.shouldReduceMotion&&ko.has(p)?{type:!1}:x));const E=m.animation;sf(u)&&(u.add(p),E.then(()=>u.remove(p))),h.push(E)}return a&&Promise.all(h).then(()=>{a&&xD(n,a)}),h}function hg(n,e,t={}){const r=u1(n,e,t.custom);let{transition:s=n.getDefaultTransition()||{}}=r||{};t.transitionOverride&&(s=t.transitionOverride);const i=r?()=>Promise.all(Sv(n,r,t)):()=>Promise.resolve(),a=n.variantChildren&&n.variantChildren.size?(u=0)=>{const{delayChildren:h=0,staggerChildren:f,staggerDirection:p}=s;return PD(n,e,h+u,f,p,t)}:()=>Promise.resolve(),{when:c}=s;if(c){const[u,h]=c==="beforeChildren"?[i,a]:[a,i];return u().then(()=>h())}else return Promise.all([i(),a(t.delay)])}function PD(n,e,t=0,r=0,s=1,i){const a=[],c=(n.variantChildren.size-1)*r,u=s===1?(h=0)=>h*r:(h=0)=>c-h*r;return Array.from(n.variantChildren).sort(TD).forEach((h,f)=>{h.notify("AnimationStart",e),a.push(hg(h,e,{...i,delay:t+u(f)}).then(()=>h.notify("AnimationComplete",e)))}),Promise.all(a)}function TD(n,e){return n.sortNodePosition(e)}function _D(n,e,t={}){n.notify("AnimationStart",e);let r;if(Array.isArray(e)){const s=e.map(i=>hg(n,i,t));r=Promise.all(s)}else if(typeof e=="string")r=hg(n,e,t);else{const s=typeof e=="function"?u1(n,e,t.custom):e;r=Promise.all(Sv(n,s,t))}return r.then(()=>n.notify("AnimationComplete",e))}const DD=[...bm].reverse(),ID=bm.length;function ND(n){return e=>Promise.all(e.map(({animation:t,options:r})=>_D(n,t,r)))}function MD(n){let e=ND(n);const t=LD();let r=!0;const s=(u,h)=>{const f=u1(n,h);if(f){const{transition:p,transitionEnd:m,...w}=f;u={...u,...w,...m}}return u};function i(u){e=u(n)}function a(u,h){const f=n.getProps(),p=n.getVariantContext(!0)||{},m=[],w=new Set;let x={},S=1/0;for(let A=0;A<ID;A++){const P=DD[A],k=t[P],F=f[P]!==void 0?f[P]:p[P],I=Gc(F),V=P===h?k.isActive:null;V===!1&&(S=A);let Q=F===p[P]&&F!==f[P]&&I;if(Q&&r&&n.manuallyAnimateOnMount&&(Q=!1),k.protectedKeys={...x},!k.isActive&&V===null||!F&&!k.prevProp||o1(F)||typeof F=="boolean")continue;let R=RD(k.prevProp,F)||P===h&&k.isActive&&!Q&&I||A>S&&I,Y=!1;const J=Array.isArray(F)?F:[F];let X=J.reduce(s,{});V===!1&&(X={});const{prevResolvedValues:B={}}=k,O={...B,...X},L=K=>{R=!0,w.has(K)&&(Y=!0,w.delete(K)),k.needsAnimating[K]=!0};for(const K in O){const G=X[K],$=B[K];if(x.hasOwnProperty(K))continue;let j=!1;ef(G)&&ef($)?j=!qw(G,$):j=G!==$,j?G!==void 0?L(K):w.add(K):G!==void 0&&w.has(K)?L(K):k.protectedKeys[K]=!0}k.prevProp=F,k.prevResolvedValues=X,k.isActive&&(x={...x,...X}),r&&n.blockInitialAnimation&&(R=!1),R&&(!Q||Y)&&m.push(...J.map(K=>({animation:K,options:{type:P,...u}})))}if(w.size){const A={};w.forEach(P=>{const k=n.getBaseTarget(P);k!==void 0&&(A[P]=k)}),m.push({animation:A})}let E=!!m.length;return r&&(f.initial===!1||f.initial===f.animate)&&!n.manuallyAnimateOnMount&&(E=!1),r=!1,E?e(m):Promise.resolve()}function c(u,h,f){var p;if(t[u].isActive===h)return Promise.resolve();(p=n.variantChildren)===null||p===void 0||p.forEach(w=>{var x;return(x=w.animationState)===null||x===void 0?void 0:x.setActive(u,h)}),t[u].isActive=h;const m=a(f,u);for(const w in t)t[w].protectedKeys={};return m}return{animateChanges:a,setActive:c,setAnimateFunction:i,getState:()=>t}}function RD(n,e){return typeof e=="string"?e!==n:Array.isArray(e)?!qw(e,n):!1}function Ki(n=!1){return{isActive:n,protectedKeys:{},needsAnimating:{},prevResolvedValues:{}}}function LD(){return{animate:Ki(!0),whileInView:Ki(),whileHover:Ki(),whileTap:Ki(),whileDrag:Ki(),whileFocus:Ki(),exit:Ki()}}class OD extends Ti{constructor(e){super(e),e.animationState||(e.animationState=MD(e))}updateAnimationControlsSubscription(){const{animate:e}=this.node.getProps();this.unmount(),o1(e)&&(this.unmount=e.subscribe(this.node))}mount(){this.updateAnimationControlsSubscription()}update(){const{animate:e}=this.node.getProps(),{animate:t}=this.node.prevProps||{};e!==t&&this.updateAnimationControlsSubscription()}unmount(){}}let BD=0;class FD extends Ti{constructor(){super(...arguments),this.id=BD++}update(){if(!this.node.presenceContext)return;const{isPresent:e,onExitComplete:t,custom:r}=this.node.presenceContext,{isPresent:s}=this.node.prevPresenceContext||{};if(!this.node.animationState||e===s)return;const i=this.node.animationState.setActive("exit",!e,{custom:r??this.node.getProps().custom});t&&!e&&i.then(()=>t(this.id))}mount(){const{register:e}=this.node.presenceContext||{};e&&(this.unmount=e(this.id))}unmount(){}}const UD={animation:{Feature:OD},exit:{Feature:FD}},$6=(n,e)=>Math.abs(n-e);function VD(n,e){const t=$6(n.x,e.x),r=$6(n.y,e.y);return Math.sqrt(t**2+r**2)}class Ev{constructor(e,t,{transformPagePoint:r,contextWindow:s,dragSnapToOrigin:i=!1}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.contextWindow=window,this.updatePoint=()=>{if(!(this.lastMoveEvent&&this.lastMoveEventInfo))return;const p=n2(this.lastMoveEventInfo,this.history),m=this.startEvent!==null,w=VD(p.offset,{x:0,y:0})>=3;if(!m&&!w)return;const{point:x}=p,{timestamp:S}=nn;this.history.push({...x,timestamp:S});const{onStart:E,onMove:A}=this.handlers;m||(E&&E(this.lastMoveEvent,p),this.startEvent=this.lastMoveEvent),A&&A(this.lastMoveEvent,p)},this.handlePointerMove=(p,m)=>{this.lastMoveEvent=p,this.lastMoveEventInfo=t2(m,this.transformPagePoint),nt.update(this.updatePoint,!0)},this.handlePointerUp=(p,m)=>{this.end();const{onEnd:w,onSessionEnd:x,resumeAnimation:S}=this.handlers;if(this.dragSnapToOrigin&&S&&S(),!(this.lastMoveEvent&&this.lastMoveEventInfo))return;const E=n2(p.type==="pointercancel"?this.lastMoveEventInfo:t2(m,this.transformPagePoint),this.history);this.startEvent&&w&&w(p,E),x&&x(p,E)},!jw(e))return;this.dragSnapToOrigin=i,this.handlers=t,this.transformPagePoint=r,this.contextWindow=s||window;const a=c1(e),c=t2(a,this.transformPagePoint),{point:u}=c,{timestamp:h}=nn;this.history=[{...u,timestamp:h}];const{onSessionStart:f}=t;f&&f(e,n2(c,this.history)),this.removeListeners=pi(ms(this.contextWindow,"pointermove",this.handlePointerMove),ms(this.contextWindow,"pointerup",this.handlePointerUp),ms(this.contextWindow,"pointercancel",this.handlePointerUp))}updateHandlers(e){this.handlers=e}end(){this.removeListeners&&this.removeListeners(),Kr(this.updatePoint)}}function t2(n,e){return e?{point:e(n.point)}:n}function z6(n,e){return{x:n.x-e.x,y:n.y-e.y}}function n2({point:n},e){return{point:n,delta:z6(n,Cv(e)),offset:z6(n,jD(e)),velocity:$D(e,.1)}}function jD(n){return n[0]}function Cv(n){return n[n.length-1]}function $D(n,e){if(n.length<2)return{x:0,y:0};let t=n.length-1,r=null;const s=Cv(n);for(;t>=0&&(r=n[t],!(s.timestamp-r.timestamp>so(e)));)t--;if(!r)return{x:0,y:0};const i=ys(s.timestamp-r.timestamp);if(i===0)return{x:0,y:0};const a={x:(s.x-r.x)/i,y:(s.y-r.y)/i};return a.x===1/0&&(a.x=0),a.y===1/0&&(a.y=0),a}function Un(n){return n.max-n.min}function fg(n,e=0,t=.01){return Math.abs(n-e)<=t}function H6(n,e,t,r=.5){n.origin=r,n.originPoint=ft(e.min,e.max,n.origin),n.scale=Un(t)/Un(e),(fg(n.scale,1,1e-4)||isNaN(n.scale))&&(n.scale=1),n.translate=ft(t.min,t.max,n.origin)-n.originPoint,(fg(n.translate)||isNaN(n.translate))&&(n.translate=0)}function Lc(n,e,t,r){H6(n.x,e.x,t.x,r?r.originX:void 0),H6(n.y,e.y,t.y,r?r.originY:void 0)}function K6(n,e,t){n.min=t.min+e.min,n.max=n.min+Un(e)}function zD(n,e,t){K6(n.x,e.x,t.x),K6(n.y,e.y,t.y)}function q6(n,e,t){n.min=e.min-t.min,n.max=n.min+Un(e)}function Oc(n,e,t){q6(n.x,e.x,t.x),q6(n.y,e.y,t.y)}function HD(n,{min:e,max:t},r){return e!==void 0&&n<e?n=r?ft(e,n,r.min):Math.max(n,e):t!==void 0&&n>t&&(n=r?ft(t,n,r.max):Math.min(n,t)),n}function W6(n,e,t){return{min:e!==void 0?n.min+e:void 0,max:t!==void 0?n.max+t-(n.max-n.min):void 0}}function KD(n,{top:e,left:t,bottom:r,right:s}){return{x:W6(n.x,t,s),y:W6(n.y,e,r)}}function G6(n,e){let t=e.min-n.min,r=e.max-n.max;return e.max-e.min<n.max-n.min&&([t,r]=[r,t]),{min:t,max:r}}function qD(n,e){return{x:G6(n.x,e.x),y:G6(n.y,e.y)}}function WD(n,e){let t=.5;const r=Un(n),s=Un(e);return s>r?t=Yc(e.min,e.max-r,n.min):r>s&&(t=Yc(n.min,n.max-s,e.min)),vi(0,1,t)}function GD(n,e){const t={};return e.min!==void 0&&(t.min=e.min-n.min),e.max!==void 0&&(t.max=e.max-n.min),t}const pg=.35;function QD(n=pg){return n===!1?n=0:n===!0&&(n=pg),{x:Q6(n,"left","right"),y:Q6(n,"top","bottom")}}function Q6(n,e,t){return{min:Y6(n,e),max:Y6(n,t)}}function Y6(n,e){return typeof n=="number"?n:n[e]||0}const X6=()=>({translate:0,scale:1,origin:0,originPoint:0}),xa=()=>({x:X6(),y:X6()}),J6=()=>({min:0,max:0}),Ct=()=>({x:J6(),y:J6()});function Yn(n){return[n("x"),n("y")]}function kv({top:n,left:e,right:t,bottom:r}){return{x:{min:e,max:t},y:{min:n,max:r}}}function YD({x:n,y:e}){return{top:e.min,right:n.max,bottom:e.max,left:n.min}}function XD(n,e){if(!e)return n;const t=e({x:n.left,y:n.top}),r=e({x:n.right,y:n.bottom});return{top:t.y,left:t.x,bottom:r.y,right:r.x}}function r2(n){return n===void 0||n===1}function gg({scale:n,scaleX:e,scaleY:t}){return!r2(n)||!r2(e)||!r2(t)}function qi(n){return gg(n)||Av(n)||n.z||n.rotate||n.rotateX||n.rotateY}function Av(n){return Z6(n.x)||Z6(n.y)}function Z6(n){return n&&n!=="0%"}function of(n,e,t){const r=n-t,s=e*r;return t+s}function e8(n,e,t,r,s){return s!==void 0&&(n=of(n,s,r)),of(n,t,r)+e}function mg(n,e=0,t=1,r,s){n.min=e8(n.min,e,t,r,s),n.max=e8(n.max,e,t,r,s)}function Pv(n,{x:e,y:t}){mg(n.x,e.translate,e.scale,e.originPoint),mg(n.y,t.translate,t.scale,t.originPoint)}function JD(n,e,t,r=!1){const s=t.length;if(!s)return;e.x=e.y=1;let i,a;for(let c=0;c<s;c++){i=t[c],a=i.projectionDelta;const u=i.instance;u&&u.style&&u.style.display==="contents"||(r&&i.options.layoutScroll&&i.scroll&&i!==i.root&&Sa(n,{x:-i.scroll.offset.x,y:-i.scroll.offset.y}),a&&(e.x*=a.x.scale,e.y*=a.y.scale,Pv(n,a)),r&&qi(i.latestValues)&&Sa(n,i.latestValues))}e.x=t8(e.x),e.y=t8(e.y)}function t8(n){return Number.isInteger(n)||n>1.0000000000001||n<.999999999999?n:1}function oi(n,e){n.min=n.min+e,n.max=n.max+e}function n8(n,e,[t,r,s]){const i=e[s]!==void 0?e[s]:.5,a=ft(n.min,n.max,i);mg(n,e[t],e[r],a,e.scale)}const ZD=["x","scaleX","originX"],eI=["y","scaleY","originY"];function Sa(n,e){n8(n.x,e,ZD),n8(n.y,e,eI)}function Tv(n,e){return kv(XD(n.getBoundingClientRect(),e))}function tI(n,e,t){const r=Tv(n,t),{scroll:s}=e;return s&&(oi(r.x,s.offset.x),oi(r.y,s.offset.y)),r}const _v=({current:n})=>n?n.ownerDocument.defaultView:null,nI=new WeakMap;class rI{constructor(e){this.openGlobalLock=null,this.isDragging=!1,this.currentDirection=null,this.originPoint={x:0,y:0},this.constraints=!1,this.hasMutatedConstraints=!1,this.elastic=Ct(),this.visualElement=e}start(e,{snapToCursor:t=!1}={}){const{presenceContext:r}=this.visualElement;if(r&&r.isPresent===!1)return;const s=f=>{const{dragSnapToOrigin:p}=this.getProps();p?this.pauseAnimation():this.stopAnimation(),t&&this.snapToCursor(c1(f,"page").point)},i=(f,p)=>{const{drag:m,dragPropagation:w,onDragStart:x}=this.getProps();if(m&&!w&&(this.openGlobalLock&&this.openGlobalLock(),this.openGlobalLock=zw(m),!this.openGlobalLock))return;this.isDragging=!0,this.currentDirection=null,this.resolveConstraints(),this.visualElement.projection&&(this.visualElement.projection.isAnimationBlocked=!0,this.visualElement.projection.target=void 0),Yn(E=>{let A=this.getAxisMotionValue(E).get()||0;if($r.test(A)){const{projection:P}=this.visualElement;if(P&&P.layout){const k=P.layout.layoutBox[E];k&&(A=Un(k)*(parseFloat(A)/100))}}this.originPoint[E]=A}),x&&nt.update(()=>x(f,p),!1,!0);const{animationState:S}=this.visualElement;S&&S.setActive("whileDrag",!0)},a=(f,p)=>{const{dragPropagation:m,dragDirectionLock:w,onDirectionLock:x,onDrag:S}=this.getProps();if(!m&&!this.openGlobalLock)return;const{offset:E}=p;if(w&&this.currentDirection===null){this.currentDirection=sI(E),this.currentDirection!==null&&x&&x(this.currentDirection);return}this.updateAxis("x",p.point,E),this.updateAxis("y",p.point,E),this.visualElement.render(),S&&S(f,p)},c=(f,p)=>this.stop(f,p),u=()=>Yn(f=>{var p;return this.getAnimationState(f)==="paused"&&((p=this.getAxisMotionValue(f).animation)===null||p===void 0?void 0:p.play())}),{dragSnapToOrigin:h}=this.getProps();this.panSession=new Ev(e,{onSessionStart:s,onStart:i,onMove:a,onSessionEnd:c,resumeAnimation:u},{transformPagePoint:this.visualElement.getTransformPagePoint(),dragSnapToOrigin:h,contextWindow:_v(this.visualElement)})}stop(e,t){const r=this.isDragging;if(this.cancel(),!r)return;const{velocity:s}=t;this.startAnimation(s);const{onDragEnd:i}=this.getProps();i&&nt.update(()=>i(e,t))}cancel(){this.isDragging=!1;const{projection:e,animationState:t}=this.visualElement;e&&(e.isAnimationBlocked=!1),this.panSession&&this.panSession.end(),this.panSession=void 0;const{dragPropagation:r}=this.getProps();!r&&this.openGlobalLock&&(this.openGlobalLock(),this.openGlobalLock=null),t&&t.setActive("whileDrag",!1)}updateAxis(e,t,r){const{drag:s}=this.getProps();if(!r||!fh(e,s,this.currentDirection))return;const i=this.getAxisMotionValue(e);let a=this.originPoint[e]+r[e];this.constraints&&this.constraints[e]&&(a=HD(a,this.constraints[e],this.elastic[e])),i.set(a)}resolveConstraints(){var e;const{dragConstraints:t,dragElastic:r}=this.getProps(),s=this.visualElement.projection&&!this.visualElement.projection.layout?this.visualElement.projection.measure(!1):(e=this.visualElement.projection)===null||e===void 0?void 0:e.layout,i=this.constraints;t&&va(t)?this.constraints||(this.constraints=this.resolveRefConstraints()):t&&s?this.constraints=KD(s.layoutBox,t):this.constraints=!1,this.elastic=QD(r),i!==this.constraints&&s&&this.constraints&&!this.hasMutatedConstraints&&Yn(a=>{this.getAxisMotionValue(a)&&(this.constraints[a]=GD(s.layoutBox[a],this.constraints[a]))})}resolveRefConstraints(){const{dragConstraints:e,onMeasureDragConstraints:t}=this.getProps();if(!e||!va(e))return!1;const r=e.current,{projection:s}=this.visualElement;if(!s||!s.layout)return!1;const i=tI(r,s.root,this.visualElement.getTransformPagePoint());let a=qD(s.layout.layoutBox,i);if(t){const c=t(YD(a));this.hasMutatedConstraints=!!c,c&&(a=kv(c))}return a}startAnimation(e){const{drag:t,dragMomentum:r,dragElastic:s,dragTransition:i,dragSnapToOrigin:a,onDragTransitionEnd:c}=this.getProps(),u=this.constraints||{},h=Yn(f=>{if(!fh(f,t,this.currentDirection))return;let p=u&&u[f]||{};a&&(p={min:0,max:0});const m=s?200:1e6,w=s?40:1e7,x={type:"inertia",velocity:r?e[f]:0,bounceStiffness:m,bounceDamping:w,timeConstant:750,restDelta:1,restSpeed:10,...i,...p};return this.startAxisValueAnimation(f,x)});return Promise.all(h).then(c)}startAxisValueAnimation(e,t){const r=this.getAxisMotionValue(e);return r.start(Bm(e,r,0,t))}stopAnimation(){Yn(e=>this.getAxisMotionValue(e).stop())}pauseAnimation(){Yn(e=>{var t;return(t=this.getAxisMotionValue(e).animation)===null||t===void 0?void 0:t.pause()})}getAnimationState(e){var t;return(t=this.getAxisMotionValue(e).animation)===null||t===void 0?void 0:t.state}getAxisMotionValue(e){const t="_drag"+e.toUpperCase(),r=this.visualElement.getProps(),s=r[t];return s||this.visualElement.getValue(e,(r.initial?r.initial[e]:void 0)||0)}snapToCursor(e){Yn(t=>{const{drag:r}=this.getProps();if(!fh(t,r,this.currentDirection))return;const{projection:s}=this.visualElement,i=this.getAxisMotionValue(t);if(s&&s.layout){const{min:a,max:c}=s.layout.layoutBox[t];i.set(e[t]-ft(a,c,.5))}})}scalePositionWithinConstraints(){if(!this.visualElement.current)return;const{drag:e,dragConstraints:t}=this.getProps(),{projection:r}=this.visualElement;if(!va(t)||!r||!this.constraints)return;this.stopAnimation();const s={x:0,y:0};Yn(a=>{const c=this.getAxisMotionValue(a);if(c){const u=c.get();s[a]=WD({min:u,max:u},this.constraints[a])}});const{transformTemplate:i}=this.visualElement.getProps();this.visualElement.current.style.transform=i?i({},""):"none",r.root&&r.root.updateScroll(),r.updateLayout(),this.resolveConstraints(),Yn(a=>{if(!fh(a,e,null))return;const c=this.getAxisMotionValue(a),{min:u,max:h}=this.constraints[a];c.set(ft(u,h,s[a]))})}addListeners(){if(!this.visualElement.current)return;nI.set(this.visualElement,this);const e=this.visualElement.current,t=ms(e,"pointerdown",u=>{const{drag:h,dragListener:f=!0}=this.getProps();h&&f&&this.start(u)}),r=()=>{const{dragConstraints:u}=this.getProps();va(u)&&(this.constraints=this.resolveRefConstraints())},{projection:s}=this.visualElement,i=s.addEventListener("measure",r);s&&!s.layout&&(s.root&&s.root.updateScroll(),s.updateLayout()),r();const a=ps(window,"resize",()=>this.scalePositionWithinConstraints()),c=s.addEventListener("didUpdate",({delta:u,hasLayoutChanged:h})=>{this.isDragging&&h&&(Yn(f=>{const p=this.getAxisMotionValue(f);p&&(this.originPoint[f]+=u[f].translate,p.set(p.get()+u[f].translate))}),this.visualElement.render())});return()=>{a(),t(),i(),c&&c()}}getProps(){const e=this.visualElement.getProps(),{drag:t=!1,dragDirectionLock:r=!1,dragPropagation:s=!1,dragConstraints:i=!1,dragElastic:a=pg,dragMomentum:c=!0}=e;return{...e,drag:t,dragDirectionLock:r,dragPropagation:s,dragConstraints:i,dragElastic:a,dragMomentum:c}}}function fh(n,e,t){return(e===!0||e===n)&&(t===null||t===n)}function sI(n,e=10){let t=null;return Math.abs(n.y)>e?t="y":Math.abs(n.x)>e&&(t="x"),t}class iI extends Ti{constructor(e){super(e),this.removeGroupControls=xt,this.removeListeners=xt,this.controls=new rI(e)}mount(){const{dragControls:e}=this.node.getProps();e&&(this.removeGroupControls=e.subscribe(this.controls)),this.removeListeners=this.controls.addListeners()||xt}unmount(){this.removeGroupControls(),this.removeListeners()}}const r8=n=>(e,t)=>{n&&nt.update(()=>n(e,t))};class oI extends Ti{constructor(){super(...arguments),this.removePointerDownListener=xt}onPointerDown(e){this.session=new Ev(e,this.createPanHandlers(),{transformPagePoint:this.node.getTransformPagePoint(),contextWindow:_v(this.node)})}createPanHandlers(){const{onPanSessionStart:e,onPanStart:t,onPan:r,onPanEnd:s}=this.node.getProps();return{onSessionStart:r8(e),onStart:r8(t),onMove:r,onEnd:(i,a)=>{delete this.session,s&&nt.update(()=>s(i,a))}}}mount(){this.removePointerDownListener=ms(this.node.current,"pointerdown",e=>this.onPointerDown(e))}update(){this.session&&this.session.updateHandlers(this.createPanHandlers())}unmount(){this.removePointerDownListener(),this.session&&this.session.end()}}function aI(){const n=ee.useContext(wm);if(n===null)return[!0,null];const{isPresent:e,onExitComplete:t,register:r}=n,s=ee.useId();return ee.useEffect(()=>r(s),[]),!e&&t?[!1,()=>t&&t(s)]:[!0]}const $h={hasAnimatedSinceResize:!0,hasEverUpdated:!1};function s8(n,e){return e.max===e.min?0:n/(e.max-e.min)*100}const yc={correct:(n,e)=>{if(!e.target)return n;if(typeof n=="string")if(Ee.test(n))n=parseFloat(n);else return n;const t=s8(n,e.target.x),r=s8(n,e.target.y);return`${t}% ${r}%`}},lI={correct:(n,{treeScale:e,projectionDelta:t})=>{const r=n,s=bi.parse(n);if(s.length>5)return r;const i=bi.createTransformer(n),a=typeof s[0]!="number"?1:0,c=t.x.scale*e.x,u=t.y.scale*e.y;s[0+a]/=c,s[1+a]/=u;const h=ft(c,u,.5);return typeof s[2+a]=="number"&&(s[2+a]/=h),typeof s[3+a]=="number"&&(s[3+a]/=h),i(s)}};class cI extends gr.Component{componentDidMount(){const{visualElement:e,layoutGroup:t,switchLayoutGroup:r,layoutId:s}=this.props,{projection:i}=e;mT(uI),i&&(t.group&&t.group.add(i),r&&r.register&&s&&r.register(i),i.root.didUpdate(),i.addEventListener("animationComplete",()=>{this.safeToRemove()}),i.setOptions({...i.options,onExitComplete:()=>this.safeToRemove()})),$h.hasEverUpdated=!0}getSnapshotBeforeUpdate(e){const{layoutDependency:t,visualElement:r,drag:s,isPresent:i}=this.props,a=r.projection;return a&&(a.isPresent=i,s||e.layoutDependency!==t||t===void 0?a.willUpdate():this.safeToRemove(),e.isPresent!==i&&(i?a.promote():a.relegate()||nt.postRender(()=>{const c=a.getStack();(!c||!c.members.length)&&this.safeToRemove()}))),null}componentDidUpdate(){const{projection:e}=this.props.visualElement;e&&(e.root.didUpdate(),queueMicrotask(()=>{!e.currentAnimation&&e.isLead()&&this.safeToRemove()}))}componentWillUnmount(){const{visualElement:e,layoutGroup:t,switchLayoutGroup:r}=this.props,{projection:s}=e;s&&(s.scheduleCheckAfterUnmount(),t&&t.group&&t.group.remove(s),r&&r.deregister&&r.deregister(s))}safeToRemove(){const{safeToRemove:e}=this.props;e&&e()}render(){return null}}function Dv(n){const[e,t]=aI(),r=ee.useContext(Aw);return gr.createElement(cI,{...n,layoutGroup:r,switchLayoutGroup:ee.useContext(Pw),isPresent:e,safeToRemove:t})}const uI={borderRadius:{...yc,applyTo:["borderTopLeftRadius","borderTopRightRadius","borderBottomLeftRadius","borderBottomRightRadius"]},borderTopLeftRadius:yc,borderTopRightRadius:yc,borderBottomLeftRadius:yc,borderBottomRightRadius:yc,boxShadow:lI},Iv=["TopLeft","TopRight","BottomLeft","BottomRight"],dI=Iv.length,i8=n=>typeof n=="string"?parseFloat(n):n,o8=n=>typeof n=="number"||Ee.test(n);function hI(n,e,t,r,s,i){s?(n.opacity=ft(0,t.opacity!==void 0?t.opacity:1,fI(r)),n.opacityExit=ft(e.opacity!==void 0?e.opacity:1,0,pI(r))):i&&(n.opacity=ft(e.opacity!==void 0?e.opacity:1,t.opacity!==void 0?t.opacity:1,r));for(let a=0;a<dI;a++){const c=`border${Iv[a]}Radius`;let u=a8(e,c),h=a8(t,c);if(u===void 0&&h===void 0)continue;u||(u=0),h||(h=0),u===0||h===0||o8(u)===o8(h)?(n[c]=Math.max(ft(i8(u),i8(h),r),0),($r.test(h)||$r.test(u))&&(n[c]+="%")):n[c]=h}(e.rotate||t.rotate)&&(n.rotate=ft(e.rotate||0,t.rotate||0,r))}function a8(n,e){return n[e]!==void 0?n[e]:n.borderRadius}const fI=Nv(0,.5,tv),pI=Nv(.5,.95,xt);function Nv(n,e,t){return r=>r<n?0:r>e?1:t(Yc(n,e,r))}function l8(n,e){n.min=e.min,n.max=e.max}function Qn(n,e){l8(n.x,e.x),l8(n.y,e.y)}function c8(n,e,t,r,s){return n-=e,n=of(n,1/t,r),s!==void 0&&(n=of(n,1/s,r)),n}function gI(n,e=0,t=1,r=.5,s,i=n,a=n){if($r.test(e)&&(e=parseFloat(e),e=ft(a.min,a.max,e/100)-a.min),typeof e!="number")return;let c=ft(i.min,i.max,r);n===i&&(c-=e),n.min=c8(n.min,e,t,c,s),n.max=c8(n.max,e,t,c,s)}function u8(n,e,[t,r,s],i,a){gI(n,e[t],e[r],e[s],e.scale,i,a)}const mI=["x","scaleX","originX"],yI=["y","scaleY","originY"];function d8(n,e,t,r){u8(n.x,e,mI,t?t.x:void 0,r?r.x:void 0),u8(n.y,e,yI,t?t.y:void 0,r?r.y:void 0)}function h8(n){return n.translate===0&&n.scale===1}function Mv(n){return h8(n.x)&&h8(n.y)}function wI(n,e){return n.x.min===e.x.min&&n.x.max===e.x.max&&n.y.min===e.y.min&&n.y.max===e.y.max}function Rv(n,e){return Math.round(n.x.min)===Math.round(e.x.min)&&Math.round(n.x.max)===Math.round(e.x.max)&&Math.round(n.y.min)===Math.round(e.y.min)&&Math.round(n.y.max)===Math.round(e.y.max)}function f8(n){return Un(n.x)/Un(n.y)}class vI{constructor(){this.members=[]}add(e){Fm(this.members,e),e.scheduleRender()}remove(e){if(Um(this.members,e),e===this.prevLead&&(this.prevLead=void 0),e===this.lead){const t=this.members[this.members.length-1];t&&this.promote(t)}}relegate(e){const t=this.members.findIndex(s=>e===s);if(t===0)return!1;let r;for(let s=t;s>=0;s--){const i=this.members[s];if(i.isPresent!==!1){r=i;break}}return r?(this.promote(r),!0):!1}promote(e,t){const r=this.lead;if(e!==r&&(this.prevLead=r,this.lead=e,e.show(),r)){r.instance&&r.scheduleRender(),e.scheduleRender(),e.resumeFrom=r,t&&(e.resumeFrom.preserveOpacity=!0),r.snapshot&&(e.snapshot=r.snapshot,e.snapshot.latestValues=r.animationValues||r.latestValues),e.root&&e.root.isUpdating&&(e.isLayoutDirty=!0);const{crossfade:s}=e.options;s===!1&&r.hide()}}exitAnimationComplete(){this.members.forEach(e=>{const{options:t,resumingFrom:r}=e;t.onExitComplete&&t.onExitComplete(),r&&r.options.onExitComplete&&r.options.onExitComplete()})}scheduleRender(){this.members.forEach(e=>{e.instance&&e.scheduleRender(!1)})}removeLeadSnapshot(){this.lead&&this.lead.snapshot&&(this.lead.snapshot=void 0)}}function p8(n,e,t){let r="";const s=n.x.translate/e.x,i=n.y.translate/e.y;if((s||i)&&(r=`translate3d(${s}px, ${i}px, 0) `),(e.x!==1||e.y!==1)&&(r+=`scale(${1/e.x}, ${1/e.y}) `),t){const{rotate:u,rotateX:h,rotateY:f}=t;u&&(r+=`rotate(${u}deg) `),h&&(r+=`rotateX(${h}deg) `),f&&(r+=`rotateY(${f}deg) `)}const a=n.x.scale*e.x,c=n.y.scale*e.y;return(a!==1||c!==1)&&(r+=`scale(${a}, ${c})`),r||"none"}const bI=(n,e)=>n.depth-e.depth;class xI{constructor(){this.children=[],this.isDirty=!1}add(e){Fm(this.children,e),this.isDirty=!0}remove(e){Um(this.children,e),this.isDirty=!0}forEach(e){this.isDirty&&this.children.sort(bI),this.isDirty=!1,this.children.forEach(e)}}function SI(n,e){const t=performance.now(),r=({timestamp:s})=>{const i=s-t;i>=e&&(Kr(r),n(i-e))};return nt.read(r,!0),()=>Kr(r)}function EI(n){window.MotionDebug&&window.MotionDebug.record(n)}function CI(n){return n instanceof SVGElement&&n.tagName!=="svg"}function kI(n,e,t){const r=Pn(n)?n:uo(n);return r.start(Bm("",r,e,t)),r.animation}const g8=["","X","Y","Z"],AI={visibility:"hidden"},m8=1e3;let PI=0;const Wi={type:"projectionFrame",totalNodes:0,resolvedTargetDeltas:0,recalculatedProjection:0};function Lv({attachResizeListener:n,defaultParent:e,measureScroll:t,checkIsScrollRoot:r,resetTransform:s}){return class{constructor(a={},c=e?.()){this.id=PI++,this.animationId=0,this.children=new Set,this.options={},this.isTreeAnimating=!1,this.isAnimationBlocked=!1,this.isLayoutDirty=!1,this.isProjectionDirty=!1,this.isSharedProjectionDirty=!1,this.isTransformDirty=!1,this.updateManuallyBlocked=!1,this.updateBlockedByResize=!1,this.isUpdating=!1,this.isSVG=!1,this.needsReset=!1,this.shouldResetTransform=!1,this.treeScale={x:1,y:1},this.eventHandlers=new Map,this.hasTreeAnimated=!1,this.updateScheduled=!1,this.projectionUpdateScheduled=!1,this.checkUpdateFailed=()=>{this.isUpdating&&(this.isUpdating=!1,this.clearAllSnapshots())},this.updateProjection=()=>{this.projectionUpdateScheduled=!1,Wi.totalNodes=Wi.resolvedTargetDeltas=Wi.recalculatedProjection=0,this.nodes.forEach(DI),this.nodes.forEach(LI),this.nodes.forEach(OI),this.nodes.forEach(II),EI(Wi)},this.hasProjected=!1,this.isVisible=!0,this.animationProgress=0,this.sharedNodes=new Map,this.latestValues=a,this.root=c?c.root||c:this,this.path=c?[...c.path,c]:[],this.parent=c,this.depth=c?c.depth+1:0;for(let u=0;u<this.path.length;u++)this.path[u].shouldResetTransform=!0;this.root===this&&(this.nodes=new xI)}addEventListener(a,c){return this.eventHandlers.has(a)||this.eventHandlers.set(a,new Vm),this.eventHandlers.get(a).add(c)}notifyListeners(a,...c){const u=this.eventHandlers.get(a);u&&u.notify(...c)}hasListeners(a){return this.eventHandlers.has(a)}mount(a,c=this.root.hasTreeAnimated){if(this.instance)return;this.isSVG=CI(a),this.instance=a;const{layoutId:u,layout:h,visualElement:f}=this.options;if(f&&!f.current&&f.mount(a),this.root.nodes.add(this),this.parent&&this.parent.children.add(this),c&&(h||u)&&(this.isLayoutDirty=!0),n){let p;const m=()=>this.root.updateBlockedByResize=!1;n(a,()=>{this.root.updateBlockedByResize=!0,p&&p(),p=SI(m,250),$h.hasAnimatedSinceResize&&($h.hasAnimatedSinceResize=!1,this.nodes.forEach(w8))})}u&&this.root.registerSharedNode(u,this),this.options.animate!==!1&&f&&(u||h)&&this.addEventListener("didUpdate",({delta:p,hasLayoutChanged:m,hasRelativeTargetChanged:w,layout:x})=>{if(this.isTreeAnimationBlocked()){this.target=void 0,this.relativeTarget=void 0;return}const S=this.options.transition||f.getDefaultTransition()||jI,{onLayoutAnimationStart:E,onLayoutAnimationComplete:A}=f.getProps(),P=!this.targetLayout||!Rv(this.targetLayout,x)||w,k=!m&&w;if(this.options.layoutRoot||this.resumeFrom&&this.resumeFrom.instance||k||m&&(P||!this.currentAnimation)){this.resumeFrom&&(this.resumingFrom=this.resumeFrom,this.resumingFrom.resumingFrom=void 0),this.setAnimationOrigin(p,k);const F={...Om(S,"layout"),onPlay:E,onComplete:A};(f.shouldReduceMotion||this.options.layoutRoot)&&(F.delay=0,F.type=!1),this.startAnimation(F)}else m||w8(this),this.isLead()&&this.options.onExitComplete&&this.options.onExitComplete();this.targetLayout=x})}unmount(){this.options.layoutId&&this.willUpdate(),this.root.nodes.remove(this);const a=this.getStack();a&&a.remove(this),this.parent&&this.parent.children.delete(this),this.instance=void 0,Kr(this.updateProjection)}blockUpdate(){this.updateManuallyBlocked=!0}unblockUpdate(){this.updateManuallyBlocked=!1}isUpdateBlocked(){return this.updateManuallyBlocked||this.updateBlockedByResize}isTreeAnimationBlocked(){return this.isAnimationBlocked||this.parent&&this.parent.isTreeAnimationBlocked()||!1}startUpdate(){this.isUpdateBlocked()||(this.isUpdating=!0,this.nodes&&this.nodes.forEach(BI),this.animationId++)}getTransformTemplate(){const{visualElement:a}=this.options;return a&&a.getProps().transformTemplate}willUpdate(a=!0){if(this.root.hasTreeAnimated=!0,this.root.isUpdateBlocked()){this.options.onExitComplete&&this.options.onExitComplete();return}if(!this.root.isUpdating&&this.root.startUpdate(),this.isLayoutDirty)return;this.isLayoutDirty=!0;for(let f=0;f<this.path.length;f++){const p=this.path[f];p.shouldResetTransform=!0,p.updateScroll("snapshot"),p.options.layoutRoot&&p.willUpdate(!1)}const{layoutId:c,layout:u}=this.options;if(c===void 0&&!u)return;const h=this.getTransformTemplate();this.prevTransformTemplateValue=h?h(this.latestValues,""):void 0,this.updateSnapshot(),a&&this.notifyListeners("willUpdate")}update(){if(this.updateScheduled=!1,this.isUpdateBlocked()){this.unblockUpdate(),this.clearAllSnapshots(),this.nodes.forEach(y8);return}this.isUpdating||this.nodes.forEach(MI),this.isUpdating=!1,this.nodes.forEach(RI),this.nodes.forEach(TI),this.nodes.forEach(_I),this.clearAllSnapshots();const c=performance.now();nn.delta=vi(0,1e3/60,c-nn.timestamp),nn.timestamp=c,nn.isProcessing=!0,Wp.update.process(nn),Wp.preRender.process(nn),Wp.render.process(nn),nn.isProcessing=!1}didUpdate(){this.updateScheduled||(this.updateScheduled=!0,queueMicrotask(()=>this.update()))}clearAllSnapshots(){this.nodes.forEach(NI),this.sharedNodes.forEach(FI)}scheduleUpdateProjection(){this.projectionUpdateScheduled||(this.projectionUpdateScheduled=!0,nt.preRender(this.updateProjection,!1,!0))}scheduleCheckAfterUnmount(){nt.postRender(()=>{this.isLayoutDirty?this.root.didUpdate():this.root.checkUpdateFailed()})}updateSnapshot(){this.snapshot||!this.instance||(this.snapshot=this.measure())}updateLayout(){if(!this.instance||(this.updateScroll(),!(this.options.alwaysMeasureLayout&&this.isLead())&&!this.isLayoutDirty))return;if(this.resumeFrom&&!this.resumeFrom.instance)for(let u=0;u<this.path.length;u++)this.path[u].updateScroll();const a=this.layout;this.layout=this.measure(!1),this.layoutCorrected=Ct(),this.isLayoutDirty=!1,this.projectionDelta=void 0,this.notifyListeners("measure",this.layout.layoutBox);const{visualElement:c}=this.options;c&&c.notify("LayoutMeasure",this.layout.layoutBox,a?a.layoutBox:void 0)}updateScroll(a="measure"){let c=!!(this.options.layoutScroll&&this.instance);this.scroll&&this.scroll.animationId===this.root.animationId&&this.scroll.phase===a&&(c=!1),c&&(this.scroll={animationId:this.root.animationId,phase:a,isRoot:r(this.instance),offset:t(this.instance)})}resetTransform(){if(!s)return;const a=this.isLayoutDirty||this.shouldResetTransform,c=this.projectionDelta&&!Mv(this.projectionDelta),u=this.getTransformTemplate(),h=u?u(this.latestValues,""):void 0,f=h!==this.prevTransformTemplateValue;a&&(c||qi(this.latestValues)||f)&&(s(this.instance,h),this.shouldResetTransform=!1,this.scheduleRender())}measure(a=!0){const c=this.measurePageBox();let u=this.removeElementScroll(c);return a&&(u=this.removeTransform(u)),$I(u),{animationId:this.root.animationId,measuredBox:c,layoutBox:u,latestValues:{},source:this.id}}measurePageBox(){const{visualElement:a}=this.options;if(!a)return Ct();const c=a.measureViewportBox(),{scroll:u}=this.root;return u&&(oi(c.x,u.offset.x),oi(c.y,u.offset.y)),c}removeElementScroll(a){const c=Ct();Qn(c,a);for(let u=0;u<this.path.length;u++){const h=this.path[u],{scroll:f,options:p}=h;if(h!==this.root&&f&&p.layoutScroll){if(f.isRoot){Qn(c,a);const{scroll:m}=this.root;m&&(oi(c.x,-m.offset.x),oi(c.y,-m.offset.y))}oi(c.x,f.offset.x),oi(c.y,f.offset.y)}}return c}applyTransform(a,c=!1){const u=Ct();Qn(u,a);for(let h=0;h<this.path.length;h++){const f=this.path[h];!c&&f.options.layoutScroll&&f.scroll&&f!==f.root&&Sa(u,{x:-f.scroll.offset.x,y:-f.scroll.offset.y}),qi(f.latestValues)&&Sa(u,f.latestValues)}return qi(this.latestValues)&&Sa(u,this.latestValues),u}removeTransform(a){const c=Ct();Qn(c,a);for(let u=0;u<this.path.length;u++){const h=this.path[u];if(!h.instance||!qi(h.latestValues))continue;gg(h.latestValues)&&h.updateSnapshot();const f=Ct(),p=h.measurePageBox();Qn(f,p),d8(c,h.latestValues,h.snapshot?h.snapshot.layoutBox:void 0,f)}return qi(this.latestValues)&&d8(c,this.latestValues),c}setTargetDelta(a){this.targetDelta=a,this.root.scheduleUpdateProjection(),this.isProjectionDirty=!0}setOptions(a){this.options={...this.options,...a,crossfade:a.crossfade!==void 0?a.crossfade:!0}}clearMeasurements(){this.scroll=void 0,this.layout=void 0,this.snapshot=void 0,this.prevTransformTemplateValue=void 0,this.targetDelta=void 0,this.target=void 0,this.isLayoutDirty=!1}forceRelativeParentToResolveTarget(){this.relativeParent&&this.relativeParent.resolvedRelativeTargetAt!==nn.timestamp&&this.relativeParent.resolveTargetDelta(!0)}resolveTargetDelta(a=!1){var c;const u=this.getLead();this.isProjectionDirty||(this.isProjectionDirty=u.isProjectionDirty),this.isTransformDirty||(this.isTransformDirty=u.isTransformDirty),this.isSharedProjectionDirty||(this.isSharedProjectionDirty=u.isSharedProjectionDirty);const h=!!this.resumingFrom||this!==u;if(!(a||h&&this.isSharedProjectionDirty||this.isProjectionDirty||!((c=this.parent)===null||c===void 0)&&c.isProjectionDirty||this.attemptToResolveRelativeTarget))return;const{layout:p,layoutId:m}=this.options;if(!(!this.layout||!(p||m))){if(this.resolvedRelativeTargetAt=nn.timestamp,!this.targetDelta&&!this.relativeTarget){const w=this.getClosestProjectingParent();w&&w.layout&&this.animationProgress!==1?(this.relativeParent=w,this.forceRelativeParentToResolveTarget(),this.relativeTarget=Ct(),this.relativeTargetOrigin=Ct(),Oc(this.relativeTargetOrigin,this.layout.layoutBox,w.layout.layoutBox),Qn(this.relativeTarget,this.relativeTargetOrigin)):this.relativeParent=this.relativeTarget=void 0}if(!(!this.relativeTarget&&!this.targetDelta)){if(this.target||(this.target=Ct(),this.targetWithTransforms=Ct()),this.relativeTarget&&this.relativeTargetOrigin&&this.relativeParent&&this.relativeParent.target?(this.forceRelativeParentToResolveTarget(),zD(this.target,this.relativeTarget,this.relativeParent.target)):this.targetDelta?(this.resumingFrom?this.target=this.applyTransform(this.layout.layoutBox):Qn(this.target,this.layout.layoutBox),Pv(this.target,this.targetDelta)):Qn(this.target,this.layout.layoutBox),this.attemptToResolveRelativeTarget){this.attemptToResolveRelativeTarget=!1;const w=this.getClosestProjectingParent();w&&!!w.resumingFrom==!!this.resumingFrom&&!w.options.layoutScroll&&w.target&&this.animationProgress!==1?(this.relativeParent=w,this.forceRelativeParentToResolveTarget(),this.relativeTarget=Ct(),this.relativeTargetOrigin=Ct(),Oc(this.relativeTargetOrigin,this.target,w.target),Qn(this.relativeTarget,this.relativeTargetOrigin)):this.relativeParent=this.relativeTarget=void 0}Wi.resolvedTargetDeltas++}}}getClosestProjectingParent(){if(!(!this.parent||gg(this.parent.latestValues)||Av(this.parent.latestValues)))return this.parent.isProjecting()?this.parent:this.parent.getClosestProjectingParent()}isProjecting(){return!!((this.relativeTarget||this.targetDelta||this.options.layoutRoot)&&this.layout)}calcProjection(){var a;const c=this.getLead(),u=!!this.resumingFrom||this!==c;let h=!0;if((this.isProjectionDirty||!((a=this.parent)===null||a===void 0)&&a.isProjectionDirty)&&(h=!1),u&&(this.isSharedProjectionDirty||this.isTransformDirty)&&(h=!1),this.resolvedRelativeTargetAt===nn.timestamp&&(h=!1),h)return;const{layout:f,layoutId:p}=this.options;if(this.isTreeAnimating=!!(this.parent&&this.parent.isTreeAnimating||this.currentAnimation||this.pendingAnimation),this.isTreeAnimating||(this.targetDelta=this.relativeTarget=void 0),!this.layout||!(f||p))return;Qn(this.layoutCorrected,this.layout.layoutBox);const m=this.treeScale.x,w=this.treeScale.y;JD(this.layoutCorrected,this.treeScale,this.path,u),c.layout&&!c.target&&(this.treeScale.x!==1||this.treeScale.y!==1)&&(c.target=c.layout.layoutBox);const{target:x}=c;if(!x){this.projectionTransform&&(this.projectionDelta=xa(),this.projectionTransform="none",this.scheduleRender());return}this.projectionDelta||(this.projectionDelta=xa(),this.projectionDeltaWithTransform=xa());const S=this.projectionTransform;Lc(this.projectionDelta,this.layoutCorrected,x,this.latestValues),this.projectionTransform=p8(this.projectionDelta,this.treeScale),(this.projectionTransform!==S||this.treeScale.x!==m||this.treeScale.y!==w)&&(this.hasProjected=!0,this.scheduleRender(),this.notifyListeners("projectionUpdate",x)),Wi.recalculatedProjection++}hide(){this.isVisible=!1}show(){this.isVisible=!0}scheduleRender(a=!0){if(this.options.scheduleRender&&this.options.scheduleRender(),a){const c=this.getStack();c&&c.scheduleRender()}this.resumingFrom&&!this.resumingFrom.instance&&(this.resumingFrom=void 0)}setAnimationOrigin(a,c=!1){const u=this.snapshot,h=u?u.latestValues:{},f={...this.latestValues},p=xa();(!this.relativeParent||!this.relativeParent.options.layoutRoot)&&(this.relativeTarget=this.relativeTargetOrigin=void 0),this.attemptToResolveRelativeTarget=!c;const m=Ct(),w=u?u.source:void 0,x=this.layout?this.layout.source:void 0,S=w!==x,E=this.getStack(),A=!E||E.members.length<=1,P=!!(S&&!A&&this.options.crossfade===!0&&!this.path.some(VI));this.animationProgress=0;let k;this.mixTargetDelta=F=>{const I=F/1e3;v8(p.x,a.x,I),v8(p.y,a.y,I),this.setTargetDelta(p),this.relativeTarget&&this.relativeTargetOrigin&&this.layout&&this.relativeParent&&this.relativeParent.layout&&(Oc(m,this.layout.layoutBox,this.relativeParent.layout.layoutBox),UI(this.relativeTarget,this.relativeTargetOrigin,m,I),k&&wI(this.relativeTarget,k)&&(this.isProjectionDirty=!1),k||(k=Ct()),Qn(k,this.relativeTarget)),S&&(this.animationValues=f,hI(f,h,this.latestValues,I,P,A)),this.root.scheduleUpdateProjection(),this.scheduleRender(),this.animationProgress=I},this.mixTargetDelta(this.options.layoutRoot?1e3:0)}startAnimation(a){this.notifyListeners("animationStart"),this.currentAnimation&&this.currentAnimation.stop(),this.resumingFrom&&this.resumingFrom.currentAnimation&&this.resumingFrom.currentAnimation.stop(),this.pendingAnimation&&(Kr(this.pendingAnimation),this.pendingAnimation=void 0),this.pendingAnimation=nt.update(()=>{$h.hasAnimatedSinceResize=!0,this.currentAnimation=kI(0,m8,{...a,onUpdate:c=>{this.mixTargetDelta(c),a.onUpdate&&a.onUpdate(c)},onComplete:()=>{a.onComplete&&a.onComplete(),this.completeAnimation()}}),this.resumingFrom&&(this.resumingFrom.currentAnimation=this.currentAnimation),this.pendingAnimation=void 0})}completeAnimation(){this.resumingFrom&&(this.resumingFrom.currentAnimation=void 0,this.resumingFrom.preserveOpacity=void 0);const a=this.getStack();a&&a.exitAnimationComplete(),this.resumingFrom=this.currentAnimation=this.animationValues=void 0,this.notifyListeners("animationComplete")}finishAnimation(){this.currentAnimation&&(this.mixTargetDelta&&this.mixTargetDelta(m8),this.currentAnimation.stop()),this.completeAnimation()}applyTransformsToTarget(){const a=this.getLead();let{targetWithTransforms:c,target:u,layout:h,latestValues:f}=a;if(!(!c||!u||!h)){if(this!==a&&this.layout&&h&&Ov(this.options.animationType,this.layout.layoutBox,h.layoutBox)){u=this.target||Ct();const p=Un(this.layout.layoutBox.x);u.x.min=a.target.x.min,u.x.max=u.x.min+p;const m=Un(this.layout.layoutBox.y);u.y.min=a.target.y.min,u.y.max=u.y.min+m}Qn(c,u),Sa(c,f),Lc(this.projectionDeltaWithTransform,this.layoutCorrected,c,f)}}registerSharedNode(a,c){this.sharedNodes.has(a)||this.sharedNodes.set(a,new vI),this.sharedNodes.get(a).add(c);const h=c.options.initialPromotionConfig;c.promote({transition:h?h.transition:void 0,preserveFollowOpacity:h&&h.shouldPreserveFollowOpacity?h.shouldPreserveFollowOpacity(c):void 0})}isLead(){const a=this.getStack();return a?a.lead===this:!0}getLead(){var a;const{layoutId:c}=this.options;return c?((a=this.getStack())===null||a===void 0?void 0:a.lead)||this:this}getPrevLead(){var a;const{layoutId:c}=this.options;return c?(a=this.getStack())===null||a===void 0?void 0:a.prevLead:void 0}getStack(){const{layoutId:a}=this.options;if(a)return this.root.sharedNodes.get(a)}promote({needsReset:a,transition:c,preserveFollowOpacity:u}={}){const h=this.getStack();h&&h.promote(this,u),a&&(this.projectionDelta=void 0,this.needsReset=!0),c&&this.setOptions({transition:c})}relegate(){const a=this.getStack();return a?a.relegate(this):!1}resetRotation(){const{visualElement:a}=this.options;if(!a)return;let c=!1;const{latestValues:u}=a;if((u.rotate||u.rotateX||u.rotateY||u.rotateZ)&&(c=!0),!c)return;const h={};for(let f=0;f<g8.length;f++){const p="rotate"+g8[f];u[p]&&(h[p]=u[p],a.setStaticValue(p,0))}a.render();for(const f in h)a.setStaticValue(f,h[f]);a.scheduleRender()}getProjectionStyles(a){var c,u;if(!this.instance||this.isSVG)return;if(!this.isVisible)return AI;const h={visibility:""},f=this.getTransformTemplate();if(this.needsReset)return this.needsReset=!1,h.opacity="",h.pointerEvents=jh(a?.pointerEvents)||"",h.transform=f?f(this.latestValues,""):"none",h;const p=this.getLead();if(!this.projectionDelta||!this.layout||!p.target){const S={};return this.options.layoutId&&(S.opacity=this.latestValues.opacity!==void 0?this.latestValues.opacity:1,S.pointerEvents=jh(a?.pointerEvents)||""),this.hasProjected&&!qi(this.latestValues)&&(S.transform=f?f({},""):"none",this.hasProjected=!1),S}const m=p.animationValues||p.latestValues;this.applyTransformsToTarget(),h.transform=p8(this.projectionDeltaWithTransform,this.treeScale,m),f&&(h.transform=f(m,h.transform));const{x:w,y:x}=this.projectionDelta;h.transformOrigin=`${w.origin*100}% ${x.origin*100}% 0`,p.animationValues?h.opacity=p===this?(u=(c=m.opacity)!==null&&c!==void 0?c:this.latestValues.opacity)!==null&&u!==void 0?u:1:this.preserveOpacity?this.latestValues.opacity:m.opacityExit:h.opacity=p===this?m.opacity!==void 0?m.opacity:"":m.opacityExit!==void 0?m.opacityExit:0;for(const S in Jh){if(m[S]===void 0)continue;const{correct:E,applyTo:A}=Jh[S],P=h.transform==="none"?m[S]:E(m[S],p);if(A){const k=A.length;for(let F=0;F<k;F++)h[A[F]]=P}else h[S]=P}return this.options.layoutId&&(h.pointerEvents=p===this?jh(a?.pointerEvents)||"":"none"),h}clearSnapshot(){this.resumeFrom=this.snapshot=void 0}resetTree(){this.root.nodes.forEach(a=>{var c;return(c=a.currentAnimation)===null||c===void 0?void 0:c.stop()}),this.root.nodes.forEach(y8),this.root.sharedNodes.clear()}}}function TI(n){n.updateLayout()}function _I(n){var e;const t=((e=n.resumeFrom)===null||e===void 0?void 0:e.snapshot)||n.snapshot;if(n.isLead()&&n.layout&&t&&n.hasListeners("didUpdate")){const{layoutBox:r,measuredBox:s}=n.layout,{animationType:i}=n.options,a=t.source!==n.layout.source;i==="size"?Yn(p=>{const m=a?t.measuredBox[p]:t.layoutBox[p],w=Un(m);m.min=r[p].min,m.max=m.min+w}):Ov(i,t.layoutBox,r)&&Yn(p=>{const m=a?t.measuredBox[p]:t.layoutBox[p],w=Un(r[p]);m.max=m.min+w,n.relativeTarget&&!n.currentAnimation&&(n.isProjectionDirty=!0,n.relativeTarget[p].max=n.relativeTarget[p].min+w)});const c=xa();Lc(c,r,t.layoutBox);const u=xa();a?Lc(u,n.applyTransform(s,!0),t.measuredBox):Lc(u,r,t.layoutBox);const h=!Mv(c);let f=!1;if(!n.resumeFrom){const p=n.getClosestProjectingParent();if(p&&!p.resumeFrom){const{snapshot:m,layout:w}=p;if(m&&w){const x=Ct();Oc(x,t.layoutBox,m.layoutBox);const S=Ct();Oc(S,r,w.layoutBox),Rv(x,S)||(f=!0),p.options.layoutRoot&&(n.relativeTarget=S,n.relativeTargetOrigin=x,n.relativeParent=p)}}}n.notifyListeners("didUpdate",{layout:r,snapshot:t,delta:u,layoutDelta:c,hasLayoutChanged:h,hasRelativeTargetChanged:f})}else if(n.isLead()){const{onExitComplete:r}=n.options;r&&r()}n.options.transition=void 0}function DI(n){Wi.totalNodes++,n.parent&&(n.isProjecting()||(n.isProjectionDirty=n.parent.isProjectionDirty),n.isSharedProjectionDirty||(n.isSharedProjectionDirty=!!(n.isProjectionDirty||n.parent.isProjectionDirty||n.parent.isSharedProjectionDirty)),n.isTransformDirty||(n.isTransformDirty=n.parent.isTransformDirty))}function II(n){n.isProjectionDirty=n.isSharedProjectionDirty=n.isTransformDirty=!1}function NI(n){n.clearSnapshot()}function y8(n){n.clearMeasurements()}function MI(n){n.isLayoutDirty=!1}function RI(n){const{visualElement:e}=n.options;e&&e.getProps().onBeforeLayoutMeasure&&e.notify("BeforeLayoutMeasure"),n.resetTransform()}function w8(n){n.finishAnimation(),n.targetDelta=n.relativeTarget=n.target=void 0,n.isProjectionDirty=!0}function LI(n){n.resolveTargetDelta()}function OI(n){n.calcProjection()}function BI(n){n.resetRotation()}function FI(n){n.removeLeadSnapshot()}function v8(n,e,t){n.translate=ft(e.translate,0,t),n.scale=ft(e.scale,1,t),n.origin=e.origin,n.originPoint=e.originPoint}function b8(n,e,t,r){n.min=ft(e.min,t.min,r),n.max=ft(e.max,t.max,r)}function UI(n,e,t,r){b8(n.x,e.x,t.x,r),b8(n.y,e.y,t.y,r)}function VI(n){return n.animationValues&&n.animationValues.opacityExit!==void 0}const jI={duration:.45,ease:[.4,0,.1,1]},x8=n=>typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes(n),S8=x8("applewebkit/")&&!x8("chrome/")?Math.round:xt;function E8(n){n.min=S8(n.min),n.max=S8(n.max)}function $I(n){E8(n.x),E8(n.y)}function Ov(n,e,t){return n==="position"||n==="preserve-aspect"&&!fg(f8(e),f8(t),.2)}const zI=Lv({attachResizeListener:(n,e)=>ps(n,"resize",e),measureScroll:()=>({x:document.documentElement.scrollLeft||document.body.scrollLeft,y:document.documentElement.scrollTop||document.body.scrollTop}),checkIsScrollRoot:()=>!0}),s2={current:void 0},Bv=Lv({measureScroll:n=>({x:n.scrollLeft,y:n.scrollTop}),defaultParent:()=>{if(!s2.current){const n=new zI({});n.mount(window),n.setOptions({layoutScroll:!0}),s2.current=n}return s2.current},resetTransform:(n,e)=>{n.style.transform=e!==void 0?e:"none"},checkIsScrollRoot:n=>window.getComputedStyle(n).position==="fixed"}),HI={pan:{Feature:oI},drag:{Feature:iI,ProjectionNode:Bv,MeasureLayout:Dv}},KI=/var\((--[a-zA-Z0-9-_]+),? ?([a-zA-Z0-9 ()%#.,-]+)?\)/;function qI(n){const e=KI.exec(n);if(!e)return[,];const[,t,r]=e;return[t,r]}function yg(n,e,t=1){const[r,s]=qI(n);if(!r)return;const i=window.getComputedStyle(e).getPropertyValue(r);if(i){const a=i.trim();return vv(a)?parseFloat(a):a}else return og(s)?yg(s,e,t+1):s}function WI(n,{...e},t){const r=n.current;if(!(r instanceof Element))return{target:e,transitionEnd:t};t&&(t={...t}),n.values.forEach(s=>{const i=s.get();if(!og(i))return;const a=yg(i,r);a&&s.set(a)});for(const s in e){const i=e[s];if(!og(i))continue;const a=yg(i,r);a&&(e[s]=a,t||(t={}),t[s]===void 0&&(t[s]=i))}return{target:e,transitionEnd:t}}const GI=new Set(["width","height","top","left","right","bottom","x","y","translateX","translateY"]),Fv=n=>GI.has(n),QI=n=>Object.keys(n).some(Fv),C8=n=>n===Ao||n===Ee,k8=(n,e)=>parseFloat(n.split(", ")[e]),A8=(n,e)=>(t,{transform:r})=>{if(r==="none"||!r)return 0;const s=r.match(/^matrix3d\((.+)\)$/);if(s)return k8(s[1],e);{const i=r.match(/^matrix\((.+)\)$/);return i?k8(i[1],n):0}},YI=new Set(["x","y","z"]),XI=Iu.filter(n=>!YI.has(n));function JI(n){const e=[];return XI.forEach(t=>{const r=n.getValue(t);r!==void 0&&(e.push([t,r.get()]),r.set(t.startsWith("scale")?1:0))}),e.length&&n.render(),e}const Va={width:({x:n},{paddingLeft:e="0",paddingRight:t="0"})=>n.max-n.min-parseFloat(e)-parseFloat(t),height:({y:n},{paddingTop:e="0",paddingBottom:t="0"})=>n.max-n.min-parseFloat(e)-parseFloat(t),top:(n,{top:e})=>parseFloat(e),left:(n,{left:e})=>parseFloat(e),bottom:({y:n},{top:e})=>parseFloat(e)+(n.max-n.min),right:({x:n},{left:e})=>parseFloat(e)+(n.max-n.min),x:A8(4,13),y:A8(5,14)};Va.translateX=Va.x;Va.translateY=Va.y;const ZI=(n,e,t)=>{const r=e.measureViewportBox(),s=e.current,i=getComputedStyle(s),{display:a}=i,c={};a==="none"&&e.setStaticValue("display",n.display||"block"),t.forEach(h=>{c[h]=Va[h](r,i)}),e.render();const u=e.measureViewportBox();return t.forEach(h=>{const f=e.getValue(h);f&&f.jump(c[h]),n[h]=Va[h](u,i)}),n},eN=(n,e,t={},r={})=>{e={...e},r={...r};const s=Object.keys(e).filter(Fv);let i=[],a=!1;const c=[];if(s.forEach(u=>{const h=n.getValue(u);if(!n.hasValue(u))return;let f=t[u],p=mc(f);const m=e[u];let w;if(ef(m)){const x=m.length,S=m[0]===null?1:0;f=m[S],p=mc(f);for(let E=S;E<x&&m[E]!==null;E++)w?Dm(mc(m[E])===w):w=mc(m[E])}else w=mc(m);if(p!==w)if(C8(p)&&C8(w)){const x=h.get();typeof x=="string"&&h.set(parseFloat(x)),typeof m=="string"?e[u]=parseFloat(m):Array.isArray(m)&&w===Ee&&(e[u]=m.map(parseFloat))}else p?.transform&&w?.transform&&(f===0||m===0)?f===0?h.set(w.transform(f)):e[u]=p.transform(m):(a||(i=JI(n),a=!0),c.push(u),r[u]=r[u]!==void 0?r[u]:e[u],h.jump(m))}),c.length){const u=c.indexOf("height")>=0?window.pageYOffset:null,h=ZI(e,n,c);return i.length&&i.forEach(([f,p])=>{n.getValue(f).set(p)}),n.render(),i1&&u!==null&&window.scrollTo({top:u}),{target:h,transitionEnd:r}}else return{target:e,transitionEnd:r}};function tN(n,e,t,r){return QI(e)?eN(n,e,t,r):{target:e,transitionEnd:r}}const nN=(n,e,t,r)=>{const s=WI(n,e,r);return e=s.target,r=s.transitionEnd,tN(n,e,t,r)},wg={current:null},Uv={current:!1};function rN(){if(Uv.current=!0,!!i1)if(window.matchMedia){const n=window.matchMedia("(prefers-reduced-motion)"),e=()=>wg.current=n.matches;n.addListener(e),e()}else wg.current=!1}function sN(n,e,t){const{willChange:r}=e;for(const s in e){const i=e[s],a=t[s];if(Pn(i))n.addValue(s,i),sf(r)&&r.add(s);else if(Pn(a))n.addValue(s,uo(i,{owner:n})),sf(r)&&r.remove(s);else if(a!==i)if(n.hasValue(s)){const c=n.getValue(s);!c.hasAnimated&&c.set(i)}else{const c=n.getStaticValue(s);n.addValue(s,uo(c!==void 0?c:i,{owner:n}))}}for(const s in t)e[s]===void 0&&n.removeValue(s);return e}const P8=new WeakMap,Vv=Object.keys(Qc),iN=Vv.length,T8=["AnimationStart","AnimationComplete","Update","BeforeLayoutMeasure","LayoutMeasure","LayoutAnimationStart","LayoutAnimationComplete"],oN=xm.length;class aN{constructor({parent:e,props:t,presenceContext:r,reducedMotionConfig:s,visualState:i},a={}){this.current=null,this.children=new Set,this.isVariantNode=!1,this.isControllingVariants=!1,this.shouldReduceMotion=null,this.values=new Map,this.features={},this.valueSubscriptions=new Map,this.prevMotionValues={},this.events={},this.propEventSubscriptions={},this.notifyUpdate=()=>this.notify("Update",this.latestValues),this.render=()=>{this.current&&(this.triggerBuild(),this.renderInstance(this.current,this.renderState,this.props.style,this.projection))},this.scheduleRender=()=>nt.render(this.render,!1,!0);const{latestValues:c,renderState:u}=i;this.latestValues=c,this.baseTarget={...c},this.initialValues=t.initial?{...c}:{},this.renderState=u,this.parent=e,this.props=t,this.presenceContext=r,this.depth=e?e.depth+1:0,this.reducedMotionConfig=s,this.options=a,this.isControllingVariants=a1(t),this.isVariantNode=kw(t),this.isVariantNode&&(this.variantChildren=new Set),this.manuallyAnimateOnMount=!!(e&&e.current);const{willChange:h,...f}=this.scrapeMotionValuesFromProps(t,{});for(const p in f){const m=f[p];c[p]!==void 0&&Pn(m)&&(m.set(c[p],!1),sf(h)&&h.add(p))}}scrapeMotionValuesFromProps(e,t){return{}}mount(e){this.current=e,P8.set(e,this),this.projection&&!this.projection.instance&&this.projection.mount(e),this.parent&&this.isVariantNode&&!this.isControllingVariants&&(this.removeFromVariantTree=this.parent.addVariantChild(this)),this.values.forEach((t,r)=>this.bindToMotionValue(r,t)),Uv.current||rN(),this.shouldReduceMotion=this.reducedMotionConfig==="never"?!1:this.reducedMotionConfig==="always"?!0:wg.current,this.parent&&this.parent.children.add(this),this.update(this.props,this.presenceContext)}unmount(){P8.delete(this.current),this.projection&&this.projection.unmount(),Kr(this.notifyUpdate),Kr(this.render),this.valueSubscriptions.forEach(e=>e()),this.removeFromVariantTree&&this.removeFromVariantTree(),this.parent&&this.parent.children.delete(this);for(const e in this.events)this.events[e].clear();for(const e in this.features)this.features[e].unmount();this.current=null}bindToMotionValue(e,t){const r=ko.has(e),s=t.on("change",a=>{this.latestValues[e]=a,this.props.onUpdate&&nt.update(this.notifyUpdate,!1,!0),r&&this.projection&&(this.projection.isTransformDirty=!0)}),i=t.on("renderRequest",this.scheduleRender);this.valueSubscriptions.set(e,()=>{s(),i()})}sortNodePosition(e){return!this.current||!this.sortInstanceNodePosition||this.type!==e.type?0:this.sortInstanceNodePosition(this.current,e.current)}loadFeatures({children:e,...t},r,s,i){let a,c;for(let u=0;u<iN;u++){const h=Vv[u],{isEnabled:f,Feature:p,ProjectionNode:m,MeasureLayout:w}=Qc[h];m&&(a=m),f(t)&&(!this.features[h]&&p&&(this.features[h]=new p(this)),w&&(c=w))}if((this.type==="html"||this.type==="svg")&&!this.projection&&a){this.projection=new a(this.latestValues,this.parent&&this.parent.projection);const{layoutId:u,layout:h,drag:f,dragConstraints:p,layoutScroll:m,layoutRoot:w}=t;this.projection.setOptions({layoutId:u,layout:h,alwaysMeasureLayout:!!f||p&&va(p),visualElement:this,scheduleRender:()=>this.scheduleRender(),animationType:typeof h=="string"?h:"both",initialPromotionConfig:i,layoutScroll:m,layoutRoot:w})}return c}updateFeatures(){for(const e in this.features){const t=this.features[e];t.isMounted?t.update():(t.mount(),t.isMounted=!0)}}triggerBuild(){this.build(this.renderState,this.latestValues,this.options,this.props)}measureViewportBox(){return this.current?this.measureInstanceViewportBox(this.current,this.props):Ct()}getStaticValue(e){return this.latestValues[e]}setStaticValue(e,t){this.latestValues[e]=t}makeTargetAnimatable(e,t=!0){return this.makeTargetAnimatableFromInstance(e,this.props,t)}update(e,t){(e.transformTemplate||this.props.transformTemplate)&&this.scheduleRender(),this.prevProps=this.props,this.props=e,this.prevPresenceContext=this.presenceContext,this.presenceContext=t;for(let r=0;r<T8.length;r++){const s=T8[r];this.propEventSubscriptions[s]&&(this.propEventSubscriptions[s](),delete this.propEventSubscriptions[s]);const i=e["on"+s];i&&(this.propEventSubscriptions[s]=this.on(s,i))}this.prevMotionValues=sN(this,this.scrapeMotionValuesFromProps(e,this.prevProps),this.prevMotionValues),this.handleChildMotionValue&&this.handleChildMotionValue()}getProps(){return this.props}getVariant(e){return this.props.variants?this.props.variants[e]:void 0}getDefaultTransition(){return this.props.transition}getTransformPagePoint(){return this.props.transformPagePoint}getClosestVariantNode(){return this.isVariantNode?this:this.parent?this.parent.getClosestVariantNode():void 0}getVariantContext(e=!1){if(e)return this.parent?this.parent.getVariantContext():void 0;if(!this.isControllingVariants){const r=this.parent?this.parent.getVariantContext()||{}:{};return this.props.initial!==void 0&&(r.initial=this.props.initial),r}const t={};for(let r=0;r<oN;r++){const s=xm[r],i=this.props[s];(Gc(i)||i===!1)&&(t[s]=i)}return t}addVariantChild(e){const t=this.getClosestVariantNode();if(t)return t.variantChildren&&t.variantChildren.add(e),()=>t.variantChildren.delete(e)}addValue(e,t){t!==this.values.get(e)&&(this.removeValue(e),this.bindToMotionValue(e,t)),this.values.set(e,t),this.latestValues[e]=t.get()}removeValue(e){this.values.delete(e);const t=this.valueSubscriptions.get(e);t&&(t(),this.valueSubscriptions.delete(e)),delete this.latestValues[e],this.removeValueFromRenderState(e,this.renderState)}hasValue(e){return this.values.has(e)}getValue(e,t){if(this.props.values&&this.props.values[e])return this.props.values[e];let r=this.values.get(e);return r===void 0&&t!==void 0&&(r=uo(t,{owner:this}),this.addValue(e,r)),r}readValue(e){var t;return this.latestValues[e]!==void 0||!this.current?this.latestValues[e]:(t=this.getBaseTargetFromProps(this.props,e))!==null&&t!==void 0?t:this.readValueFromInstance(this.current,e,this.options)}setBaseTarget(e,t){this.baseTarget[e]=t}getBaseTarget(e){var t;const{initial:r}=this.props,s=typeof r=="string"||typeof r=="object"?(t=Tm(this.props,r))===null||t===void 0?void 0:t[e]:void 0;if(r&&s!==void 0)return s;const i=this.getBaseTargetFromProps(this.props,e);return i!==void 0&&!Pn(i)?i:this.initialValues[e]!==void 0&&s===void 0?void 0:this.baseTarget[e]}on(e,t){return this.events[e]||(this.events[e]=new Vm),this.events[e].add(t)}notify(e,...t){this.events[e]&&this.events[e].notify(...t)}}class jv extends aN{sortInstanceNodePosition(e,t){return e.compareDocumentPosition(t)&2?1:-1}getBaseTargetFromProps(e,t){return e.style?e.style[t]:void 0}removeValueFromRenderState(e,{vars:t,style:r}){delete t[e],delete r[e]}makeTargetAnimatableFromInstance({transition:e,transitionEnd:t,...r},{transformValues:s},i){let a=CD(r,e||{},this);if(s&&(t&&(t=s(t)),r&&(r=s(r)),a&&(a=s(a))),i){SD(this,r,a);const c=nN(this,r,a,t);t=c.transitionEnd,r=c.target}return{transition:e,transitionEnd:t,...r}}}function lN(n){return window.getComputedStyle(n)}class cN extends jv{constructor(){super(...arguments),this.type="html"}readValueFromInstance(e,t){if(ko.has(t)){const r=Lm(t);return r&&r.default||0}else{const r=lN(e),s=(Dw(t)?r.getPropertyValue(t):r[t])||0;return typeof s=="string"?s.trim():s}}measureInstanceViewportBox(e,{transformPagePoint:t}){return Tv(e,t)}build(e,t,r,s){Em(e,t,r,s.transformTemplate)}scrapeMotionValuesFromProps(e,t){return Pm(e,t)}handleChildMotionValue(){this.childSubscription&&(this.childSubscription(),delete this.childSubscription);const{children:e}=this.props;Pn(e)&&(this.childSubscription=e.on("change",t=>{this.current&&(this.current.textContent=`${t}`)}))}renderInstance(e,t,r,s){Ow(e,t,r,s)}}class uN extends jv{constructor(){super(...arguments),this.type="svg",this.isSVGTag=!1}getBaseTargetFromProps(e,t){return e[t]}readValueFromInstance(e,t){if(ko.has(t)){const r=Lm(t);return r&&r.default||0}return t=Bw.has(t)?t:vm(t),e.getAttribute(t)}measureInstanceViewportBox(){return Ct()}scrapeMotionValuesFromProps(e,t){return Uw(e,t)}build(e,t,r,s){km(e,t,r,this.isSVGTag,s.transformTemplate)}renderInstance(e,t,r,s){Fw(e,t,r,s)}mount(e){this.isSVGTag=Am(e.tagName),super.mount(e)}}const dN=(n,e)=>Sm(n)?new uN(e,{enableHardwareAcceleration:!1}):new cN(e,{enableHardwareAcceleration:!0}),hN={layout:{ProjectionNode:Bv,MeasureLayout:Dv}},fN={...UD,...i_,...HI,...hN},pN=pT((n,e)=>qT(n,e,fN,dN));function $v(n){const e=_m(()=>uo(n)),{isStatic:t}=ee.useContext(ym);if(t){const[,r]=ee.useState(n);ee.useEffect(()=>e.on("change",r),[])}return e}const gN=n=>n&&typeof n=="object"&&n.mix,mN=n=>gN(n)?n.mix:void 0;function yN(...n){const e=!Array.isArray(n[0]),t=e?0:-1,r=n[0+t],s=n[1+t],i=n[2+t],a=n[3+t],c=Rm(s,i,{mixer:mN(i[0]),...a});return e?c(r):c}function zv(n,e){const t=$v(e()),r=()=>t.set(e());return r(),Sw(()=>{const s=()=>nt.update(r,!1,!0),i=n.map(a=>a.on("change",s));return()=>{i.forEach(a=>a()),Kr(r)}}),t}function wN(n){Rc.current=[],n();const e=zv(Rc.current,n);return Rc.current=void 0,e}function vN(n,e,t,r){if(typeof n=="function")return wN(n);const s=typeof e=="function"?e:yN(e,t,r);return Array.isArray(n)?_8(n,s):_8([n],([i])=>s(i))}function _8(n,e){const t=_m(()=>[]);return zv(n,()=>{t.length=0;const r=n.length;for(let s=0;s<r;s++)t[s]=n[s].get();return e(t)})}function bN(){const[n,e]=ee.useState([]),[t,r]=ee.useState(0),s=Ts(m=>m.likeProfile),i=$v(0),a=vN(i,[-200,0,200],[-12,0,12]);ee.useEffect(()=>{(async()=>{const m=window.electronAPI?await window.electronAPI.getProfiles():[];e(m)})()},[]);function c(){i.set(0),r(m=>Math.min(m+1,n.length))}function u(){const m=n[t]?.id;m&&s(m),c()}function h(){c()}function f(m,w){w.offset.x>100?u():w.offset.x<-100?h():i.set(0)}const p=n[t];return p?v.jsxs(pN.div,{className:"bg-white rounded-2xl shadow p-4 cursor-grab",drag:"x",style:{x:i,rotate:a},dragConstraints:{left:0,right:0},dragElastic:.2,onDragEnd:f,children:[v.jsx("div",{className:"h-96 rounded-xl overflow-hidden bg-gray-200 flex items-center justify-center",children:v.jsx("img",{src:p.photos[0],alt:p.name,className:"object-cover w-full h-full"})}),v.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[v.jsxs("div",{children:[v.jsxs("div",{className:"font-bold text-lg",children:[p.name,", ",p.age]}),v.jsx("div",{className:"text-sm text-gray-600",children:p.bio})]}),v.jsxs("div",{className:"flex gap-2",children:[v.jsx("button",{onClick:h,className:"px-4 py-2 rounded-full border",children:""}),v.jsx("button",{onClick:u,className:"px-4 py-2 rounded-full bg-red-500 text-white",children:""})]})]})]}):v.jsx("div",{className:"text-center text-gray-500",children:"Sem mais perfis"})}function xN(){const[n,e]=ee.useState("login"),[t,r]=ee.useState(""),[s,i]=ee.useState(""),[a,c]=ee.useState(""),[u,h]=ee.useState(""),[f,p]=ee.useState(!1),{login:m,register:w,isLoading:x,error:S,clearError:E}=Ts(),A=async k=>{if(k.preventDefault(),E(),!t.trim()||!s.trim()||n==="register"&&!a.trim())return;(n==="login"?await m(t,s):await w(t,s,a,u?parseInt(u):void 0))&&(r(""),i(""),c(""),h(""))},P=()=>{e(n==="login"?"register":"login"),E()};return v.jsx("div",{className:"w-full max-w-md mx-auto",children:v.jsxs("div",{className:"bg-white rounded-2xl shadow-xl p-8",children:[v.jsxs("div",{className:"text-center mb-8",children:[v.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:n==="login"?"Entrar":"Criar Conta"}),v.jsx("p",{className:"text-gray-600",children:n==="login"?"Entre na sua conta para continuar":"Crie sua conta para comear"})]}),S&&v.jsx("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg",children:v.jsx("p",{className:"text-red-600 text-sm",children:S})}),v.jsxs("form",{onSubmit:A,className:"space-y-6",children:[n==="register"&&v.jsxs("div",{children:[v.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-2",children:"Nome completo"}),v.jsx("input",{id:"name",type:"text",value:a,onChange:k=>c(k.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors",placeholder:"Seu nome completo",required:n==="register"})]}),n==="register"&&v.jsxs("div",{children:[v.jsx("label",{htmlFor:"age",className:"block text-sm font-medium text-gray-700 mb-2",children:"Idade (opcional)"}),v.jsx("input",{id:"age",type:"number",value:u,onChange:k=>h(k.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors",placeholder:"Sua idade",min:"18",max:"100"})]}),v.jsxs("div",{children:[v.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-2",children:"Email"}),v.jsx("input",{id:"email",type:"email",value:t,onChange:k=>r(k.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors",placeholder:"seu@email.com",required:!0})]}),v.jsxs("div",{children:[v.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"Senha"}),v.jsxs("div",{className:"relative",children:[v.jsx("input",{id:"password",type:f?"text":"password",value:s,onChange:k=>i(k.target.value),className:"w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent transition-colors",placeholder:"Sua senha",required:!0,minLength:6}),v.jsx("button",{type:"button",onClick:()=>p(!f),className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700",children:f?"":""})]}),n==="register"&&v.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Mnimo 6 caracteres"})]}),v.jsx("button",{type:"submit",disabled:x,className:"w-full bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 disabled:from-gray-400 disabled:to-gray-400 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed",children:x?v.jsxs("div",{className:"flex items-center justify-center",children:[v.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"}),n==="login"?"Entrando...":"Criando conta..."]}):n==="login"?"Entrar":"Criar Conta"})]}),v.jsx("div",{className:"mt-8 text-center",children:v.jsxs("p",{className:"text-gray-600",children:[n==="login"?"No tem uma conta?":"J tem uma conta?",v.jsx("button",{onClick:P,className:"ml-2 text-red-500 hover:text-red-600 font-semibold transition-colors",children:n==="login"?"Criar conta":"Fazer login"})]})})]})})}function ja({isOpen:n,title:e,message:t,confirmText:r,cancelText:s,onConfirm:i,onCancel:a,type:c="danger"}){if(!n)return null;const h=(()=>{switch(c){case"danger":return{icon:"",confirmButton:"bg-red-500 hover:bg-red-600 text-white",iconBg:"bg-red-100"};case"warning":return{icon:"",confirmButton:"bg-orange-500 hover:bg-orange-600 text-white",iconBg:"bg-orange-100"};case"info":return{icon:"",confirmButton:"bg-blue-500 hover:bg-blue-600 text-white",iconBg:"bg-blue-100"}}})();return v.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:v.jsxs("div",{className:"bg-white rounded-2xl max-w-sm w-full p-6",children:[v.jsx("div",{className:`w-16 h-16 ${h.iconBg} rounded-full flex items-center justify-center mx-auto mb-4`,children:v.jsx("span",{className:"text-2xl",children:h.icon})}),v.jsxs("div",{className:"text-center mb-6",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:e}),v.jsx("p",{className:"text-gray-600 text-sm leading-relaxed",children:t})]}),v.jsxs("div",{className:"flex space-x-3",children:[v.jsx("button",{onClick:a,className:"flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium",children:s}),v.jsx("button",{onClick:i,className:`flex-1 px-4 py-3 rounded-lg transition-colors font-medium ${h.confirmButton}`,children:r})]})]})})}function SN({onSelectMatch:n}){const{matches:e,clearCorruptedData:t,unmatchUser:r,deleteConversation:s}=Ts(),[i,a]=ee.useState(null),[c,u]=ee.useState(null);return Array.isArray(e)?e.length===0?v.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-center p-6",children:[v.jsx("div",{className:"text-6xl mb-4",children:""}),v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Nenhum match ainda"}),v.jsx("p",{className:"text-gray-500 text-sm",children:"Continue fazendo swipe para encontrar pessoas incrveis!"})]}):v.jsxs("div",{className:"space-y-2",children:[e.filter(h=>h&&h.id).map((h,f)=>v.jsxs("div",{onClick:()=>n(h.id),className:"flex items-center p-4 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer border border-gray-100",children:[v.jsxs("div",{className:"relative",children:[v.jsx("img",{src:h.photo,alt:h.name,className:"w-12 h-12 rounded-full object-cover"}),h.unreadCount>0&&v.jsx("div",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:h.unreadCount})]}),v.jsxs("div",{className:"flex-1 ml-3",children:[v.jsxs("div",{className:"flex items-center justify-between",children:[v.jsx("h4",{className:"font-semibold text-gray-900",children:h.name}),v.jsx("span",{className:"text-xs text-gray-500",children:EN(h.lastMessage?.timestamp||h.matchedAt||new Date)})]}),v.jsx("p",{className:"text-sm text-gray-600 truncate",children:h.lastMessage?.text||"Vocs deram match!"})]}),v.jsxs("div",{className:"ml-2 flex items-center space-x-1",children:[v.jsx("button",{onClick:p=>{p.stopPropagation(),u(h.id)},className:"p-2 text-gray-400 hover:text-orange-500 transition-colors",title:"Apagar conversa",children:v.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}),v.jsx("button",{onClick:p=>{p.stopPropagation(),a(h.id)},className:"p-2 text-gray-400 hover:text-red-500 transition-colors",title:"Desfazer match",children:v.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),v.jsx("div",{className:"text-gray-400",children:v.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]})]},h.id||`match-${f}`)),i&&v.jsx(ja,{isOpen:!0,title:"Desfazer Match",message:`Tem certeza que deseja desfazer o match com ${e.find(h=>h.id===i)?.name}? Esta ao no pode ser desfeita e toda a conversa ser perdida.`,confirmText:"Desfazer Match",cancelText:"Cancelar",type:"danger",onConfirm:()=>{r(i),a(null)},onCancel:()=>a(null)}),c&&v.jsx(ja,{isOpen:!0,title:"Apagar Conversa",message:`Deseja apagar toda a conversa com ${e.find(h=>h.id===c)?.name}? O match ser mantido, mas todas as mensagens sero removidas.`,confirmText:"Apagar Conversa",cancelText:"Cancelar",type:"warning",onConfirm:()=>{s(c),u(null)},onCancel:()=>u(null)})]}):v.jsxs("div",{className:"flex flex-col items-center justify-center h-64 text-center p-6",children:[v.jsx("div",{className:"text-6xl mb-4",children:""}),v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Erro ao carregar matches"}),v.jsx("p",{className:"text-gray-500 text-sm mb-4",children:"Dados corrompidos detectados"}),v.jsx("button",{onClick:t,className:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:"Limpar dados e reiniciar"})]})}function EN(n){try{if(!n)return"agora";let e;if(typeof n=="string")e=new Date(n);else if(n instanceof Date)e=n;else return"agora";if(!e||isNaN(e.getTime()))return"agora";const r=new Date().getTime()-e.getTime(),s=Math.floor(r/6e4),i=Math.floor(r/36e5),a=Math.floor(r/864e5);return s<1?"agora":s<60?`${s}m`:i<24?`${i}h`:a<7?`${a}d`:e.toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit"})}catch(e){return console.error("Erro ao formatar tempo:",e,n),"agora"}}function CN({matchId:n,peerId:e,p2pChatIntegration:t,onBack:r}){const[s,i]=ee.useState(""),[a,c]=ee.useState(!1),[u,h]=ee.useState(!1),[f,p]=ee.useState(!1),[m,w]=ee.useState(!1),[x,S]=ee.useState({}),[E,A]=ee.useState([]),[P,k]=ee.useState("connecting"),F=ee.useRef(null),I=ee.useRef(!1),V=ee.useRef(),Q=ee.useRef(0),{matches:D,user:R,unmatchUser:Y,deleteConversation:J}=Ts(),X=D.find(N=>N.id===n),B=ee.useCallback({onMessage:N=>{N.matchId===n&&A(Z=>Z.some(ie=>ie.id===N.id)?Z:[...Z,N].sort((ie,ae)=>ie.timestamp.getTime()-ae.timestamp.getTime()))},onTypingIndicator:N=>{N.peerId===e&&S(Z=>({...Z,[N.peerId]:N.isTyping}))},onReadReceipt:N=>{console.log("Read receipt received:",N)},onMessageDeliveryUpdate:(N,Z)=>{A(oe=>oe.map(ie=>ie.id===N?{...ie,deliveryStatus:Z}:ie))}},[n,e]);ee.useEffect(()=>((async()=>{try{await t.initialize(),t.addHandler(B);const Z=t.getMessageHistory(n);A(Z),await t.synchronizeMessageHistory(e,n),k("connected")}catch(Z){console.error("Failed to initialize P2P chat:",Z),k("disconnected")}})(),()=>{t.removeHandler(B)}),[t,B,n,e]),ee.useEffect(()=>((async()=>{if(!I.current&&E.length>0)try{await t.markMessagesAsRead(n,e),I.current=!0}catch(Z){console.error("Failed to mark messages as read:",Z)}})(),()=>{I.current=!1}),[t,n,e,E]),ee.useEffect(()=>{F.current?.scrollIntoView({behavior:"smooth"})},[E]),ee.useEffect(()=>{const N=Z=>{a&&c(!1)};return document.addEventListener("mousedown",N),()=>{document.removeEventListener("mousedown",N)}},[a]);const O=ee.useCallback(async()=>{const N=Date.now();if(Q.current=N,!m){w(!0);try{await t.sendTypingIndicator(e,!0)}catch(Z){console.warn("Failed to send typing indicator:",Z)}}V.current&&clearTimeout(V.current),V.current=setTimeout(async()=>{if(Date.now()-Q.current>=1e3){w(!1);try{await t.sendTypingIndicator(e,!1)}catch(Z){console.warn("Failed to send typing stop indicator:",Z)}}},1e3)},[t,e,m]),L=async N=>{if(N.preventDefault(),!s.trim())return;const Z=s.trim();if(i(""),m){w(!1);try{await t.sendTypingIndicator(e,!1)}catch(oe){console.warn("Failed to send typing stop indicator:",oe)}}try{await t.sendMessage(n,e,Z)}catch(oe){console.error("Failed to send P2P message:",oe)}},K=N=>{i(N.target.value),O()},G=()=>{Y(n),t.clearMessageHistory(n),h(!1),r()},$=()=>{J(n),t.clearMessageHistory(n),p(!1)},j=N=>{switch(N){case"sent":return"";case"delivered":return"";case"failed":return"";default:return""}},H=()=>{switch(P){case"connected":return"text-green-500";case"connecting":return"text-yellow-500";case"disconnected":return"text-red-500";default:return"text-gray-500"}},T=()=>{switch(P){case"connected":return"P2P Connected";case"connecting":return"Connecting...";case"disconnected":return"Disconnected";default:return"Unknown"}};return X?v.jsxs("div",{className:"flex flex-col h-full",children:[v.jsxs("div",{className:"bg-white border-b px-4 py-3 flex items-center justify-between",children:[v.jsxs("div",{className:"flex items-center",children:[v.jsx("button",{onClick:r,className:"mr-3 p-1 text-gray-600 hover:text-gray-900 transition-colors",children:v.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),v.jsx("img",{src:X.photo,alt:X.name,className:"w-10 h-10 rounded-full object-cover mr-3"}),v.jsxs("div",{children:[v.jsx("h3",{className:"font-semibold text-gray-900",children:X.name}),v.jsxs("div",{className:"flex items-center space-x-2",children:[v.jsxs("p",{className:"text-sm text-gray-500",children:["Match em ",new Date(X.matchedAt).toLocaleDateString("pt-BR")]}),v.jsxs("span",{className:`text-xs ${H()}`,children:[" ",T()]})]})]})]}),v.jsxs("div",{className:"relative",children:[v.jsx("button",{onClick:()=>c(!a),className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",children:v.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})})}),a&&v.jsxs("div",{className:"absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border z-10",children:[v.jsxs("button",{onClick:()=>{p(!0),c(!1)},className:"w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2",children:[v.jsx("span",{children:""}),v.jsx("span",{children:"Apagar conversa"})]}),v.jsxs("button",{onClick:()=>{h(!0),c(!1)},className:"w-full px-4 py-3 text-left text-sm text-red-600 hover:bg-red-50 flex items-center space-x-2 border-t",children:[v.jsx("span",{children:""}),v.jsx("span",{children:"Desfazer match"})]})]})]})]}),v.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50",children:[E.length===0?v.jsxs("div",{className:"text-center py-8",children:[v.jsx("div",{className:"text-4xl mb-2",children:""}),v.jsx("p",{className:"text-gray-500",children:"Vocs deram match!"}),v.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"Comece uma conversa segura via P2P"}),P==="connected"&&v.jsxs("div",{className:"mt-2 text-xs text-green-600 flex items-center justify-center",children:[v.jsx("span",{className:"w-2 h-2 bg-green-500 rounded-full mr-2"}),"Conexo P2P estabelecida"]})]}):E.map(N=>{N.senderId===R?.id||N.senderId;const Z=N.senderId!==e;return v.jsx("div",{className:`flex ${Z?"justify-end":"justify-start"}`,children:v.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${Z?"bg-gradient-to-r from-red-500 to-pink-500 text-white":"bg-white text-gray-900 shadow-sm"}`,children:[v.jsx("p",{className:"text-sm",children:N.text}),v.jsxs("div",{className:`flex items-center justify-between text-xs mt-1 ${Z?"text-red-100":"text-gray-500"}`,children:[v.jsx("span",{children:N.timestamp.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}),Z&&v.jsxs("div",{className:"flex items-center space-x-1",children:[N.encrypted&&v.jsx("span",{title:"Mensagem criptografada",children:""}),v.jsx("span",{title:`Status: ${N.deliveryStatus||"pending"}`,children:j(N.deliveryStatus)})]})]})]})},N.id)}),Object.entries(x).map(([N,Z])=>Z&&N===e?v.jsx("div",{className:"flex justify-start",children:v.jsx("div",{className:"bg-gray-200 text-gray-600 px-4 py-2 rounded-2xl text-sm",children:v.jsxs("span",{className:"flex items-center",children:[v.jsxs("span",{className:"mr-2",children:[X.name," est digitando"]}),v.jsxs("div",{className:"flex space-x-1",children:[v.jsx("div",{className:"w-1 h-1 bg-gray-500 rounded-full animate-bounce"}),v.jsx("div",{className:"w-1 h-1 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"0.1s"}}),v.jsx("div",{className:"w-1 h-1 bg-gray-500 rounded-full animate-bounce",style:{animationDelay:"0.2s"}})]})]})})},`typing-${N}`):null),v.jsx("div",{ref:F})]}),v.jsxs("div",{className:"bg-white border-t p-4",children:[P==="disconnected"&&v.jsx("div",{className:"mb-2 text-center text-sm text-red-600 bg-red-50 py-2 px-4 rounded-lg",children:" Conexo P2P perdida. Tentando reconectar..."}),v.jsxs("form",{onSubmit:L,className:"flex space-x-2",children:[v.jsx("input",{type:"text",value:s,onChange:K,placeholder:P==="connected"?"Digite uma mensagem segura...":"Aguardando conexo...",disabled:P!=="connected",className:"flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-red-500 focus:border-transparent disabled:bg-gray-100 disabled:cursor-not-allowed"}),v.jsx("button",{type:"submit",disabled:!s.trim()||P!=="connected",className:"bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 disabled:from-gray-300 disabled:to-gray-300 text-white p-2 rounded-full transition-all duration-200 disabled:cursor-not-allowed",children:v.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]}),P==="connected"&&v.jsx("div",{className:"mt-2 text-xs text-gray-500 text-center",children:" Mensagens criptografadas end-to-end via P2P"})]}),v.jsx(ja,{isOpen:u,title:"Desfazer Match",message:`Tem certeza que deseja desfazer o match com ${X.name}? Esta ao no pode ser desfeita e toda a conversa ser perdida.`,confirmText:"Desfazer Match",cancelText:"Cancelar",type:"danger",onConfirm:G,onCancel:()=>h(!1)}),v.jsx(ja,{isOpen:f,title:"Apagar Conversa",message:`Deseja apagar toda a conversa com ${X.name}? O match ser mantido, mas todas as mensagens sero removidas.`,confirmText:"Apagar Conversa",cancelText:"Cancelar",type:"warning",onConfirm:$,onCancel:()=>p(!1)})]}):v.jsxs("div",{className:"flex flex-col h-full",children:[v.jsxs("div",{className:"bg-white border-b px-4 py-3 flex items-center",children:[v.jsx("button",{onClick:r,className:"mr-3 p-1 text-gray-600 hover:text-gray-900 transition-colors",children:v.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),v.jsx("h3",{className:"font-semibold text-gray-900",children:"Erro"})]}),v.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:v.jsxs("div",{className:"text-center",children:[v.jsx("div",{className:"text-4xl mb-4",children:""}),v.jsx("p",{className:"text-gray-500 mb-2",children:"Match no encontrado"}),v.jsxs("p",{className:"text-sm text-gray-400",children:["ID: ",n]}),v.jsx("button",{onClick:r,className:"mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:"Voltar"})]})})]})}var On=(n=>(n.CHAT="chat",n.PROFILE_UPDATE="profile_update",n.LIKE="like",n.MATCH="match",n.SYSTEM="system",n))(On||{}),Br=(n=>(n.MINIMAL="minimal",n.BALANCED="balanced",n.OPEN="open",n.CUSTOM="custom",n))(Br||{}),Ye=(n=>(n.NONE="none",n.MATCHES_ONLY="matches_only",n.NEARBY_USERS="nearby_users",n.ALL_USERS="all_users",n))(Ye||{}),mr=(n=>(n[n.CITY=3]="CITY",n[n.DISTRICT=4]="DISTRICT",n[n.NEIGHBORHOOD=5]="NEIGHBORHOOD",n[n.STREET=6]="STREET",n[n.BUILDING=7]="BUILDING",n))(mr||{});class kN{constructor(e,t,r,s={}){this.messageHandlers=new Set,this.pendingMessages=new Map,this.messageQueue=new Map,this.deliveryCallbacks=new Map,this.deliveryTimeouts=new Map,this.typingIndicators=new Map,this.typingCallbacks=new Set,this.cryptoManager=e,this.webrtcManager=t,this.p2pManager=r,this.config={maxRetries:3,retryDelay:1e3,messageTimeout:3e4,enableDeliveryConfirmation:!0,enableTypingIndicators:!0,...s},this.setupMessageHandling()}async initialize(){console.log("Initializing P2P Messaging Manager..."),this.cryptoManager.hasIdentity()||await this.cryptoManager.generateIdentity(),this.webrtcManager.onDataChannel((e,t)=>{t.label==="messaging"&&this.setupDataChannelHandlers(e,t)}),console.log("P2P Messaging Manager initialized")}async sendMessage(e,t,r=On.CHAT){const s=crypto.randomUUID();try{const i={id:s,type:r,from:this.p2pManager.getPeerId(),to:e,content:t,timestamp:new Date,deliveryConfirmation:this.config.enableDeliveryConfirmation},a=await this.encryptMessage(e,i);return await this.sendEncryptedMessage(e,a),this.trackMessageDelivery(s,e),console.log("Message sent:",s,"to peer:",e),s}catch(i){throw console.error("Failed to send message:",i),this.updateDeliveryStatus(s,e,"failed"),i}}async sendTypingIndicator(e,t){if(this.config.enableTypingIndicators)try{const r={id:crypto.randomUUID(),type:On.SYSTEM,from:this.p2pManager.getPeerId(),to:e,content:JSON.stringify({typing:t}),timestamp:new Date,deliveryConfirmation:!1},s=await this.encryptMessage(e,r);await this.sendEncryptedMessage(e,s)}catch(r){console.warn("Failed to send typing indicator:",r)}}onMessage(e){this.messageHandlers.add(e)}removeMessageHandler(e){this.messageHandlers.delete(e)}onTypingIndicator(e){this.typingCallbacks.add(e)}getMessageDeliveryStatus(e){return this.pendingMessages.get(e)||null}getPendingMessages(e){return this.messageQueue.get(e)||[]}clearMessageQueue(e){this.messageQueue.delete(e)}destroy(){console.log("Destroying P2P Messaging Manager..."),this.deliveryTimeouts.forEach(e=>clearTimeout(e)),this.deliveryTimeouts.clear(),this.typingIndicators.forEach(e=>clearTimeout(e)),this.typingIndicators.clear(),this.messageHandlers.clear(),this.typingCallbacks.clear(),this.pendingMessages.clear(),this.messageQueue.clear(),this.deliveryCallbacks.clear(),console.log("P2P Messaging Manager destroyed")}setupMessageHandling(){this.p2pManager.onMessage((e,t)=>{this.handleIncomingP2PMessage(e,t)})}setupDataChannelHandlers(e,t){console.log("Setting up messaging data channel for peer:",e),t.onmessage=async r=>{try{await this.handleDataChannelMessage(e,r.data)}catch(s){console.error("Error handling data channel message:",s)}},t.onopen=()=>{console.log("Messaging data channel opened for peer:",e),this.processMessageQueue(e)},t.onclose=()=>{console.log("Messaging data channel closed for peer:",e)},t.onerror=r=>{console.error("Messaging data channel error for peer:",e,r)}}async encryptMessage(e,t){try{if(!this.cryptoManager.hasIdentity())throw new Error("Crypto manager not initialized");const r=JSON.stringify({id:t.id,type:t.type,from:t.from,to:t.to,content:t.content,timestamp:t.timestamp.toISOString(),deliveryConfirmation:t.deliveryConfirmation});return await this.cryptoManager.encryptMessage(e,r)}catch(r){throw console.error("Message encryption failed:",r),new Error(`Message encryption failed: ${r instanceof Error?r.message:"Unknown error"}`)}}async decryptMessage(e,t){try{const r=await this.cryptoManager.decryptMessage(e,t),s=JSON.parse(r);return{id:s.id,type:s.type,from:s.from,to:s.to,content:s.content,timestamp:new Date(s.timestamp),deliveryConfirmation:s.deliveryConfirmation}}catch(r){throw console.error("Message decryption failed:",r),new Error(`Message decryption failed: ${r instanceof Error?r.message:"Unknown error"}`)}}async sendEncryptedMessage(e,t){try{let r=this.webrtcManager.getDataChannel(e,"messaging");(!r||r.readyState!=="open")&&(r=await this.webrtcManager.createDataChannel(e,"messaging"));const s={ciphertext:Array.from(new Uint8Array(t.ciphertext)),header:{publicKey:Array.from(new Uint8Array(t.header.publicKey)),previousChainLength:t.header.previousChainLength,messageNumber:t.header.messageNumber},timestamp:t.timestamp.toISOString()},i=JSON.stringify(s);await this.webrtcManager.sendData(e,"messaging",i),console.log("Encrypted message sent via WebRTC to peer:",e)}catch(r){throw console.error("Failed to send encrypted message:",r),r}}async handleIncomingP2PMessage(e,t){try{const r={ciphertext:t.payload.ciphertext,header:t.payload.header,timestamp:t.timestamp},s=await this.decryptMessage(e,r);await this.processDecryptedMessage(e,s)}catch(r){console.error("Failed to handle incoming P2P message:",r)}}async handleDataChannelMessage(e,t){try{let r;t instanceof ArrayBuffer?r=new TextDecoder().decode(t):r=t;const s=JSON.parse(r),i={ciphertext:new Uint8Array(s.ciphertext).buffer,header:{publicKey:new Uint8Array(s.header.publicKey).buffer,previousChainLength:s.header.previousChainLength,messageNumber:s.header.messageNumber},timestamp:new Date(s.timestamp)},a=await this.decryptMessage(e,i);await this.processDecryptedMessage(e,a)}catch(r){console.error("Failed to handle data channel message:",r)}}async processDecryptedMessage(e,t){console.log("Processing decrypted message:",t.type,"from peer:",e);try{switch(t.deliveryConfirmation&&await this.sendDeliveryConfirmation(e,t.id),t.type){case On.CHAT:this.notifyMessageHandlers(e,t);break;case On.SYSTEM:await this.handleSystemMessage(e,t);break;case On.MATCH:this.notifyMessageHandlers(e,t);break;default:console.warn("Unknown message type:",t.type),this.notifyMessageHandlers(e,t)}}catch(r){console.error("Failed to process decrypted message:",r)}}async handleSystemMessage(e,t){try{const r=JSON.parse(t.content);r.typing!==void 0?this.handleTypingIndicator(e,r.typing):r.deliveryConfirmation&&this.handleDeliveryConfirmation(r.messageId)}catch(r){console.warn("Failed to parse system message:",r)}}handleTypingIndicator(e,t){const r=this.typingIndicators.get(e);if(r&&clearTimeout(r),this.typingCallbacks.forEach(s=>{try{s(e,t)}catch(i){console.error("Typing indicator callback failed:",i)}}),t){const s=setTimeout(()=>{this.typingCallbacks.forEach(i=>{try{i(e,!1)}catch(a){console.error("Typing indicator timeout callback failed:",a)}}),this.typingIndicators.delete(e)},3e3);this.typingIndicators.set(e,s)}}async sendDeliveryConfirmation(e,t){try{const r={id:crypto.randomUUID(),type:On.SYSTEM,from:this.p2pManager.getPeerId(),to:e,content:JSON.stringify({deliveryConfirmation:!0,messageId:t}),timestamp:new Date,deliveryConfirmation:!1},s=await this.encryptMessage(e,r);await this.sendEncryptedMessage(e,s),console.log("Delivery confirmation sent for message:",t)}catch(r){console.warn("Failed to send delivery confirmation:",r)}}handleDeliveryConfirmation(e){const t=this.deliveryCallbacks.get(e);t&&(t(!0),this.deliveryCallbacks.delete(e));const r=this.deliveryTimeouts.get(e);r&&(clearTimeout(r),this.deliveryTimeouts.delete(e));const s=this.pendingMessages.get(e);s&&(s.status="delivered",s.timestamp=new Date),console.log("Delivery confirmation received for message:",e)}trackMessageDelivery(e,t){const r={messageId:e,peerId:t,status:"sent",timestamp:new Date,retryCount:0};if(this.pendingMessages.set(e,r),this.config.enableDeliveryConfirmation){const s=setTimeout(()=>{const i=this.deliveryCallbacks.get(e);i&&(i(!1),this.deliveryCallbacks.delete(e));const a=this.pendingMessages.get(e);a&&(a.status="failed",a.timestamp=new Date),this.deliveryTimeouts.delete(e),console.warn("Message delivery timeout:",e)},this.config.messageTimeout);this.deliveryTimeouts.set(e,s)}}updateDeliveryStatus(e,t,r){const s=this.pendingMessages.get(e);s?(s.status=r,s.timestamp=new Date):this.pendingMessages.set(e,{messageId:e,peerId:t,status:r,timestamp:new Date,retryCount:0})}async processMessageQueue(e){const t=this.messageQueue.get(e);if(!(!t||t.length===0)){console.log("Processing",t.length,"queued messages for peer:",e);for(const r of t)try{const s=await this.encryptMessage(e,r);await this.sendEncryptedMessage(e,s)}catch(s){console.error("Failed to send queued message:",s)}this.messageQueue.delete(e)}}notifyMessageHandlers(e,t){this.messageHandlers.forEach(r=>{try{r(e,t)}catch(s){console.error("Message handler callback failed:",s)}})}queueMessage(e,t){this.messageQueue.has(e)||this.messageQueue.set(e,[]),this.messageQueue.get(e).push(t),console.log("Message queued for peer:",e,"Queue size:",this.messageQueue.get(e).length)}async waitForDeliveryConfirmation(e){return this.config.enableDeliveryConfirmation?new Promise(t=>{this.deliveryCallbacks.set(e,t)}):!0}}class AN{constructor(e,t){this.handlers=new Set,this.messageHistory=new Map,this.syncedPeers=new Set,this.typingStates=new Map,this.typingTimeouts=new Map,this.readReceipts=new Map,this.messageMapping=new Map,this.messagingManager=e,this.p2pManager=t,this.setupMessageHandling(),this.setupTypingIndicators()}async initialize(){console.log("Initializing P2P Chat Integration..."),await this.messagingManager.initialize(),console.log("P2P Chat Integration initialized")}addHandler(e){this.handlers.add(e)}removeHandler(e){this.handlers.delete(e)}async sendMessage(e,t,r){try{const s=crypto.randomUUID(),i=await this.messagingManager.sendMessage(t,r,On.CHAT);this.messageMapping.set(i,s);const a={id:s,matchId:e,senderId:this.p2pManager.getPeerId(),text:r,timestamp:new Date,read:!0,deliveryStatus:"sent",encrypted:!0};return this.addToMessageHistory(e,a),this.notifyHandlers("onMessage",a),this.monitorDeliveryStatus(i,s),console.log("P2P chat message sent:",s,"to peer:",t),s}catch(s){throw console.error("Failed to send P2P chat message:",s),s}}async sendTypingIndicator(e,t){try{await this.messagingManager.sendTypingIndicator(e,t),console.log("Typing indicator sent:",t,"to peer:",e)}catch(r){console.warn("Failed to send typing indicator:",r)}}async sendReadReceipt(e,t){try{const r={messageId:t,readAt:new Date().toISOString()};await this.messagingManager.sendMessage(e,JSON.stringify({readReceipt:r}),On.SYSTEM),console.log("Read receipt sent for message:",t,"to peer:",e)}catch(r){console.warn("Failed to send read receipt:",r)}}getMessageHistory(e){return this.messageHistory.get(e)||[]}async markMessagesAsRead(e,t){const r=this.messageHistory.get(e)||[],s=r.filter(i=>!i.read&&i.senderId!==this.p2pManager.getPeerId());if(s.length!==0){r.forEach(i=>{!i.read&&i.senderId!==this.p2pManager.getPeerId()&&(i.read=!0)});for(const i of s)await this.sendReadReceipt(t,i.id);console.log("Marked",s.length,"messages as read for match:",e)}}getTypingIndicators(){return Array.from(this.typingStates.values())}async synchronizeMessageHistory(e,t){if(!this.syncedPeers.has(e))try{console.log("Synchronizing message history with peer:",e);const r={type:"history_sync_request",matchId:t,lastMessageId:this.getLastMessageId(t),timestamp:new Date().toISOString()};await this.messagingManager.sendMessage(e,JSON.stringify(r),On.SYSTEM),this.syncedPeers.add(e),console.log("Message history sync requested for peer:",e)}catch(r){console.error("Failed to synchronize message history:",r)}}clearMessageHistory(e){this.messageHistory.delete(e),console.log("Message history cleared for match:",e)}getMessageDeliveryStatus(e){for(const t of this.messageHistory.values()){const r=t.find(s=>s.id===e);if(r)return r.deliveryStatus||null}return null}destroy(){console.log("Destroying P2P Chat Integration..."),this.typingTimeouts.forEach(e=>clearTimeout(e)),this.typingTimeouts.clear(),this.handlers.clear(),this.messageHistory.clear(),this.syncedPeers.clear(),this.typingStates.clear(),this.readReceipts.clear(),this.messageMapping.clear(),console.log("P2P Chat Integration destroyed")}setupMessageHandling(){this.messagingManager.onMessage((e,t)=>{this.handleIncomingP2PMessage(e,t)})}setupTypingIndicators(){this.messagingManager.onTypingIndicator((e,t)=>{this.handleTypingIndicator(e,t)})}async handleIncomingP2PMessage(e,t){try{t.type===On.CHAT?await this.handleChatMessage(e,t):t.type===On.SYSTEM&&await this.handleSystemMessage(e,t)}catch(r){console.error("Failed to handle incoming P2P message:",r)}}async handleChatMessage(e,t){const r=this.generateMatchId(e),s={id:t.id,matchId:r,senderId:e,text:t.content,timestamp:t.timestamp,read:!1,encrypted:!0};this.addToMessageHistory(r,s),this.notifyHandlers("onMessage",s),console.log("Received P2P chat message:",s.id,"from peer:",e)}async handleSystemMessage(e,t){try{const r=JSON.parse(t.content);if(r.readReceipt){const s={messageId:r.readReceipt.messageId,peerId:e,readAt:new Date(r.readReceipt.readAt)};this.handleReadReceipt(s)}else r.type==="history_sync_request"?await this.handleHistorySyncRequest(e,r):r.type==="history_sync_response"&&await this.handleHistorySyncResponse(e,r)}catch(r){console.warn("Failed to parse system message:",r)}}handleTypingIndicator(e,t){const r={peerId:e,isTyping:t,timestamp:new Date};if(t){this.typingStates.set(e,r);const s=this.typingTimeouts.get(e);s&&clearTimeout(s);const i=setTimeout(()=>{this.typingStates.delete(e),this.typingTimeouts.delete(e),this.notifyHandlers("onTypingIndicator",{peerId:e,isTyping:!1,timestamp:new Date})},3e3);this.typingTimeouts.set(e,i)}else{this.typingStates.delete(e);const s=this.typingTimeouts.get(e);s&&(clearTimeout(s),this.typingTimeouts.delete(e))}this.notifyHandlers("onTypingIndicator",r)}handleReadReceipt(e){this.readReceipts.has(e.messageId)||this.readReceipts.set(e.messageId,[]),this.readReceipts.get(e.messageId).push(e),this.notifyHandlers("onReadReceipt",e),console.log("Received read receipt for message:",e.messageId,"from peer:",e.peerId)}async handleHistorySyncRequest(e,t){const r=t.matchId,s=t.lastMessageId,i=this.getMessageHistory(r),a=this.getMessagesAfter(i,s);if(a.length>0){const c={type:"history_sync_response",matchId:r,messages:a.map(u=>({id:u.id,senderId:u.senderId,text:u.text,timestamp:u.timestamp.toISOString()}))};await this.messagingManager.sendMessage(e,JSON.stringify(c),On.SYSTEM),console.log("Sent",a.length,"messages in history sync response to peer:",e)}}async handleHistorySyncResponse(e,t){const r=t.matchId,s=t.messages;for(const i of s){const a={id:i.id,matchId:r,senderId:i.senderId,text:i.text,timestamp:new Date(i.timestamp),read:i.senderId===this.p2pManager.getPeerId(),encrypted:!0};this.hasMessage(r,i.id)||(this.addToMessageHistory(r,a),this.notifyHandlers("onMessage",a))}console.log("Synchronized",s.length,"messages from peer:",e)}async monitorDeliveryStatus(e,t){try{const r=await this.messagingManager.waitForDeliveryConfirmation(e);this.updateMessageDeliveryStatus(t,r?"delivered":"failed"),this.notifyHandlers("onMessageDeliveryUpdate",t,r?"delivered":"failed")}catch(r){console.warn("Failed to monitor delivery status:",r),this.updateMessageDeliveryStatus(t,"failed"),this.notifyHandlers("onMessageDeliveryUpdate",t,"failed")}}addToMessageHistory(e,t){this.messageHistory.has(e)||this.messageHistory.set(e,[]);const r=this.messageHistory.get(e);r.some(s=>s.id===t.id)||(r.push(t),r.sort((s,i)=>s.timestamp.getTime()-i.timestamp.getTime()))}updateMessageDeliveryStatus(e,t){for(const r of this.messageHistory.values()){const s=r.find(i=>i.id===e);if(s){s.deliveryStatus=t;break}}}generateMatchId(e){const r=[this.p2pManager.getPeerId(),e].sort();return`p2p_match_${r[0]}_${r[1]}`}getLastMessageId(e){const t=this.messageHistory.get(e)||[];return t.length>0?t[t.length-1].id:null}getMessagesAfter(e,t){if(!t)return e;const r=e.findIndex(s=>s.id===t);return r>=0?e.slice(r+1):e}hasMessage(e,t){return(this.messageHistory.get(e)||[]).some(s=>s.id===t)}notifyHandlers(e,...t){this.handlers.forEach(r=>{try{const s=r[e];typeof s=="function"&&s.apply(r,t)}catch(s){console.error("Handler callback failed:",s)}})}}class PN{constructor(e,t,r,s={}){this.connectionStatuses=new Map,this.activeChats=new Set,this.chatHandlers=new Set,this.connectionHandlers=new Set,this.initialized=!1,this.p2pManager=e,this.messagingManager=new kN(t,r,e,{enableDeliveryConfirmation:s.enableReadReceipts!==!1,enableTypingIndicators:s.enableTypingIndicators!==!1}),this.chatIntegration=new AN(this.messagingManager,e),this.config={enableEncryption:!0,enableTypingIndicators:!0,enableReadReceipts:!0,enableMessageHistory:!0,maxHistorySize:1e3,syncTimeout:3e4,...s},this.setupEventHandlers()}async initialize(){if(!this.initialized){console.log("Initializing P2P Chat Manager...");try{await this.messagingManager.initialize(),await this.chatIntegration.initialize(),this.initialized=!0,console.log("P2P Chat Manager initialized successfully")}catch(e){throw console.error("Failed to initialize P2P Chat Manager:",e),e}}}async startChat(e){if(!this.initialized)throw new Error("P2P Chat Manager not initialized");try{console.log("Starting chat with peer:",e);const t=this.generateMatchId(e);return this.updateConnectionStatus(e,"connecting"),await this.ensureP2PConnection(e),this.activeChats.add(t),this.config.enableMessageHistory&&await this.chatIntegration.synchronizeMessageHistory(e,t),this.updateConnectionStatus(e,"connected"),console.log("Chat started successfully with peer:",e,"matchId:",t),t}catch(t){throw console.error("Failed to start chat with peer:",e,t),this.updateConnectionStatus(e,"error"),t}}async sendMessage(e,t,r){if(!this.initialized)throw new Error("P2P Chat Manager not initialized");if(!this.activeChats.has(e))throw new Error("Chat not active for match ID: "+e);try{const s=await this.chatIntegration.sendMessage(e,t,r);return console.log("Message sent via P2P Chat Manager:",s),s}catch(s){throw console.error("Failed to send message:",s),s}}async sendTypingIndicator(e,t){if(this.config.enableTypingIndicators)try{await this.chatIntegration.sendTypingIndicator(e,t)}catch(r){console.warn("Failed to send typing indicator:",r)}}async markMessagesAsRead(e,t){if(this.config.enableReadReceipts)try{await this.chatIntegration.markMessagesAsRead(e,t)}catch(r){console.warn("Failed to mark messages as read:",r)}}getMessageHistory(e){return this.chatIntegration.getMessageHistory(e)}getChatIntegration(){return this.chatIntegration}getConnectionStatus(e){return this.connectionStatuses.get(e)||null}getActiveConnections(){return Array.from(this.connectionStatuses.values())}isChatActive(e){return this.activeChats.has(e)}async endChat(e,t){console.log("Ending chat:",e,"with peer:",t),this.activeChats.delete(e),this.config.enableMessageHistory&&this.chatIntegration.clearMessageHistory(e),this.updateConnectionStatus(t,"disconnected"),console.log("Chat ended successfully")}addChatHandler(e){this.chatHandlers.add(e),this.chatIntegration.addHandler(e)}removeChatHandler(e){this.chatHandlers.delete(e),this.chatIntegration.removeHandler(e)}onConnectionStatusChange(e){this.connectionHandlers.add(e)}removeConnectionStatusHandler(e){this.connectionHandlers.delete(e)}getStats(){const e=Array.from(this.activeChats).flatMap(t=>this.chatIntegration.getMessageHistory(t));return{activeChats:this.activeChats.size,connectedPeers:Array.from(this.connectionStatuses.values()).filter(t=>t.status==="connected").length,totalMessages:e.length,encryptedMessages:e.filter(t=>t.encrypted).length}}destroy(){console.log("Destroying P2P Chat Manager..."),this.activeChats.clear(),this.chatHandlers.clear(),this.connectionHandlers.clear(),this.connectionStatuses.clear(),this.chatIntegration.destroy(),this.messagingManager.destroy(),this.initialized=!1,console.log("P2P Chat Manager destroyed")}setupEventHandlers(){}async ensureP2PConnection(e){try{if(!this.p2pManager.getNetworkStatus().connected)throw new Error("P2P network not connected");await this.p2pManager.connectToPeer(e),console.log("P2P connection ensured with peer:",e)}catch(t){throw console.error("Failed to ensure P2P connection:",t),t}}generateMatchId(e){const r=[this.p2pManager.getPeerId(),e].sort();return`p2p_match_${r[0]}_${r[1]}`}updateConnectionStatus(e,t){const r=this.connectionStatuses.get(e),s={peerId:e,status:t,lastSeen:t==="connected"?new Date:r?.lastSeen,latency:r?.latency};this.connectionStatuses.set(e,s),this.connectionHandlers.forEach(i=>{try{i(s)}catch(a){console.error("Connection status handler failed:",a)}}),console.log("Connection status updated for peer:",e,"status:",t)}cleanupInactiveConnections(){const e=new Date,t=300*1e3;for(const[r,s]of this.connectionStatuses.entries())s.lastSeen&&e.getTime()-s.lastSeen.getTime()>t&&s.status==="connected"&&this.updateConnectionStatus(r,"disconnected")}startPeriodicCleanup(){setInterval(()=>{this.cleanupInactiveConnections()},6e4)}}const TN=Symbol.for("@libp2p/connection"),vg=Symbol.for("@libp2p/content-routing"),af=Symbol.for("@libp2p/peer-discovery"),jm=Symbol.for("@libp2p/peer-id");function Bc(n){return!!n?.[jm]}const bg=Symbol.for("@libp2p/peer-routing"),d1="keep-alive",$m=Symbol.for("@libp2p/transport");var Xc;(function(n){n[n.FATAL_ALL=0]="FATAL_ALL",n[n.NO_FATAL=1]="NO_FATAL"})(Xc||(Xc={}));let xi=class extends Error{static name="AbortError";constructor(e="The operation was aborted"){super(e),this.name="AbortError"}},Ae=class extends Error{static name="InvalidParametersError";constructor(e="Invalid parameters"){super(e),this.name="InvalidParametersError"}};class lf extends Error{static name="InvalidPublicKeyError";constructor(e="Invalid public key"){super(e),this.name="InvalidPublicKeyError"}}class _N extends Error{static name="ConnectionClosingError";constructor(e="The connection is closing"){super(e),this.name="ConnectionClosingError"}}class Hv extends Error{static name="ConnectionClosedError";constructor(e="The connection is closed"){super(e),this.name="ConnectionClosedError"}}class Kv extends Error{static name="ConnectionFailedError";constructor(e="Connection failed"){super(e),this.name="ConnectionFailedError"}}class wc extends Error{static name="MuxerClosedError";constructor(e="The muxer is closed"){super(e),this.name="MuxerClosedError"}}class DN extends Error{static name="StreamResetError";constructor(e="The stream has been reset"){super(e),this.name="StreamResetError"}}class xg extends Error{static name="StreamStateError";constructor(e="The stream is in an invalid state"){super(e),this.name="StreamStateError"}}let Si=class extends Error{static name="NotFoundError";constructor(e="Not found"){super(e),this.name="NotFoundError"}};class qv extends Error{static name="InvalidPeerIdError";constructor(e="Invalid PeerID"){super(e),this.name="InvalidPeerIdError"}}let zm=class extends Error{static name="InvalidMultiaddrError";constructor(e="Invalid multiaddr"){super(e),this.name="InvalidMultiaddrError"}};class IN extends Error{static name="InvalidCIDError";constructor(e="Invalid CID"){super(e),this.name="InvalidCIDError"}}class NN extends Error{static name="InvalidMultihashError";constructor(e="Invalid Multihash"){super(e),this.name="InvalidMultihashError"}}class Hm extends Error{static name="UnsupportedProtocolError";constructor(e="Unsupported protocol error"){super(e),this.name="UnsupportedProtocolError"}}class Kt extends Error{static name="InvalidMessageError";constructor(e="Invalid message"){super(e),this.name="InvalidMessageError"}}class MN extends Error{static name="ProtocolError";constructor(e="Protocol error"){super(e),this.name="ProtocolError"}}let h1=class extends Error{static name="TimeoutError";constructor(e="Timed out"){super(e),this.name="TimeoutError"}};class cf extends Error{static name="NotStartedError";constructor(e="Not started"){super(e),this.name="NotStartedError"}}class Fc extends Error{static name="DialError";constructor(e="Dial error"){super(e),this.name="DialError"}}class Sg extends Error{static name="ListenError";constructor(e="Listen error"){super(e),this.name="ListenError"}}class Wv extends Error{static name="LimitedConnectionError";constructor(e="Limited connection"){super(e),this.name="LimitedConnectionError"}}class RN extends Error{static name="TooManyInboundProtocolStreamsError";constructor(e="Too many inbound protocol streams"){super(e),this.name="TooManyInboundProtocolStreamsError"}}class Gv extends Error{static name="TooManyOutboundProtocolStreamsError";constructor(e="Too many outbound protocol streams"){super(e),this.name="TooManyOutboundProtocolStreamsError"}}class Km extends Error{static name="UnsupportedKeyTypeError";constructor(e="Unsupported key type"){super(e),this.name="UnsupportedKeyTypeError"}}class ln extends EventTarget{#e=new Map;constructor(){super()}listenerCount(e){const t=this.#e.get(e);return t==null?0:t.length}addEventListener(e,t,r){super.addEventListener(e,t,r);let s=this.#e.get(e);s==null&&(s=[],this.#e.set(e,s)),s.push({callback:t,once:(r!==!0&&r!==!1&&r?.once)??!1})}removeEventListener(e,t,r){super.removeEventListener(e.toString(),t??null,r);let s=this.#e.get(e);s!=null&&(s=s.filter(({callback:i})=>i!==t),this.#e.set(e,s))}dispatchEvent(e){const t=super.dispatchEvent(e);let r=this.#e.get(e.type);return r==null||(r=r.filter(({once:s})=>!s),this.#e.set(e.type,r)),t}safeDispatchEvent(e,t={}){return this.dispatchEvent(new CustomEvent(e,t))}}function qm(n){return n!=null&&typeof n.start=="function"&&typeof n.stop=="function"}async function Jc(...n){const e=[];for(const t of n)qm(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStart!=null&&await t.beforeStart()})),await Promise.all(e.map(async t=>{await t.start()})),await Promise.all(e.map(async t=>{t.afterStart!=null&&await t.afterStart()}))}async function f1(...n){const e=[];for(const t of n)qm(t)&&e.push(t);await Promise.all(e.map(async t=>{t.beforeStop!=null&&await t.beforeStop()})),await Promise.all(e.map(async t=>{await t.stop()})),await Promise.all(e.map(async t=>{t.afterStop!=null&&await t.afterStop()}))}const br=Symbol.for("@libp2p/service-capabilities"),Zc=Symbol.for("@libp2p/service-dependencies");function LN(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}function p1(n){if(n instanceof Uint8Array&&n.constructor.name==="Uint8Array")return n;if(n instanceof ArrayBuffer)return new Uint8Array(n);if(ArrayBuffer.isView(n))return new Uint8Array(n.buffer,n.byteOffset,n.byteLength);throw new Error("Unknown type, must be binary type")}function ON(n){return new TextEncoder().encode(n)}function BN(n){return new TextDecoder().decode(n)}function FN(n,e){if(n.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var s=0;s<n.length;s++){var i=n.charAt(s),a=i.charCodeAt(0);if(t[a]!==255)throw new TypeError(i+" is ambiguous");t[a]=s}var c=n.length,u=n.charAt(0),h=Math.log(c)/Math.log(256),f=Math.log(256)/Math.log(c);function p(x){if(x instanceof Uint8Array||(ArrayBuffer.isView(x)?x=new Uint8Array(x.buffer,x.byteOffset,x.byteLength):Array.isArray(x)&&(x=Uint8Array.from(x))),!(x instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(x.length===0)return"";for(var S=0,E=0,A=0,P=x.length;A!==P&&x[A]===0;)A++,S++;for(var k=(P-A)*f+1>>>0,F=new Uint8Array(k);A!==P;){for(var I=x[A],V=0,Q=k-1;(I!==0||V<E)&&Q!==-1;Q--,V++)I+=256*F[Q]>>>0,F[Q]=I%c>>>0,I=I/c>>>0;if(I!==0)throw new Error("Non-zero carry");E=V,A++}for(var D=k-E;D!==k&&F[D]===0;)D++;for(var R=u.repeat(S);D<k;++D)R+=n.charAt(F[D]);return R}function m(x){if(typeof x!="string")throw new TypeError("Expected String");if(x.length===0)return new Uint8Array;var S=0;if(x[S]!==" "){for(var E=0,A=0;x[S]===u;)E++,S++;for(var P=(x.length-S)*h+1>>>0,k=new Uint8Array(P);x[S];){var F=t[x.charCodeAt(S)];if(F===255)return;for(var I=0,V=P-1;(F!==0||I<A)&&V!==-1;V--,I++)F+=c*k[V]>>>0,k[V]=F%256>>>0,F=F/256>>>0;if(F!==0)throw new Error("Non-zero carry");A=I,S++}if(x[S]!==" "){for(var Q=P-A;Q!==P&&k[Q]===0;)Q++;for(var D=new Uint8Array(E+(P-Q)),R=E;Q!==P;)D[R++]=k[Q++];return D}}}function w(x){var S=m(x);if(S)return S;throw new Error(`Non-${e} character`)}return{encode:p,decodeUnsafe:m,decode:w}}var UN=FN,VN=UN;let jN=class{name;prefix;baseEncode;constructor(e,t,r){this.name=e,this.prefix=t,this.baseEncode=r}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},$N=class{name;prefix;baseDecode;prefixCodePoint;constructor(e,t,r){this.name=e,this.prefix=t;const s=t.codePointAt(0);if(s===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=s,this.baseDecode=r}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Qv(this,e)}};class zN{decoders;constructor(e){this.decoders=e}or(e){return Qv(this,e)}decode(e){const t=e[0],r=this.decoders[t];if(r!=null)return r.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}}function Qv(n,e){return new zN({...n.decoders??{[n.prefix]:n},...e.decoders??{[e.prefix]:e}})}class HN{name;prefix;baseEncode;baseDecode;encoder;decoder;constructor(e,t,r,s){this.name=e,this.prefix=t,this.baseEncode=r,this.baseDecode=s,this.encoder=new jN(e,t,r),this.decoder=new $N(e,t,s)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}function g1({name:n,prefix:e,encode:t,decode:r}){return new HN(n,e,t,r)}function Lu({name:n,prefix:e,alphabet:t}){const{encode:r,decode:s}=VN(t,n);return g1({prefix:e,name:n,encode:r,decode:i=>p1(s(i))})}function KN(n,e,t,r){let s=n.length;for(;n[s-1]==="=";)--s;const i=new Uint8Array(s*t/8|0);let a=0,c=0,u=0;for(let h=0;h<s;++h){const f=e[n[h]];if(f===void 0)throw new SyntaxError(`Non-${r} character`);c=c<<t|f,a+=t,a>=8&&(a-=8,i[u++]=255&c>>a)}if(a>=t||(255&c<<8-a)!==0)throw new SyntaxError("Unexpected end of data");return i}function qN(n,e,t){const r=e[e.length-1]==="=",s=(1<<t)-1;let i="",a=0,c=0;for(let u=0;u<n.length;++u)for(c=c<<8|n[u],a+=8;a>t;)a-=t,i+=e[s&c>>a];if(a!==0&&(i+=e[s&c<<t-a]),r)for(;(i.length*t&7)!==0;)i+="=";return i}function WN(n){const e={};for(let t=0;t<n.length;++t)e[n[t]]=t;return e}function Qt({name:n,prefix:e,bitsPerChar:t,alphabet:r}){const s=WN(r);return g1({prefix:e,name:n,encode(i){return qN(i,r,t)},decode(i){return KN(i,s,t,n)}})}const bt=Lu({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),GN=Lu({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),QN=Object.freeze(Object.defineProperty({__proto__:null,base58btc:bt,base58flickr:GN},Symbol.toStringTag,{value:"Module"})),gi=Qt({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),YN=Qt({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),XN=Qt({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),JN=Qt({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ZN=Qt({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),eM=Qt({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),tM=Qt({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),nM=Qt({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),rM=Qt({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),sM=Object.freeze(Object.defineProperty({__proto__:null,base32:gi,base32hex:ZN,base32hexpad:tM,base32hexpadupper:nM,base32hexupper:eM,base32pad:XN,base32padupper:JN,base32upper:YN,base32z:rM},Symbol.toStringTag,{value:"Module"})),zh=Lu({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),iM=Lu({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),oM=Object.freeze(Object.defineProperty({__proto__:null,base36:zh,base36upper:iM},Symbol.toStringTag,{value:"Module"}));var aM=Yv,D8=128,lM=-128,cM=Math.pow(2,31);function Yv(n,e,t){e=e||[],t=t||0;for(var r=t;n>=cM;)e[t++]=n&255|D8,n/=128;for(;n&lM;)e[t++]=n&255|D8,n>>>=7;return e[t]=n|0,Yv.bytes=t-r+1,e}var uM=Eg,dM=128,I8=127;function Eg(n,r){var t=0,r=r||0,s=0,i=r,a,c=n.length;do{if(i>=c)throw Eg.bytes=0,new RangeError("Could not decode varint");a=n[i++],t+=s<28?(a&I8)<<s:(a&I8)*Math.pow(2,s),s+=7}while(a>=dM);return Eg.bytes=i-r,t}var hM=Math.pow(2,7),fM=Math.pow(2,14),pM=Math.pow(2,21),gM=Math.pow(2,28),mM=Math.pow(2,35),yM=Math.pow(2,42),wM=Math.pow(2,49),vM=Math.pow(2,56),bM=Math.pow(2,63),xM=function(n){return n<hM?1:n<fM?2:n<pM?3:n<gM?4:n<mM?5:n<yM?6:n<wM?7:n<vM?8:n<bM?9:10},SM={encode:aM,decode:uM,encodingLength:xM},uf=SM;function Cg(n,e=0){return[uf.decode(n,e),uf.decode.bytes]}function df(n,e,t=0){return uf.encode(n,e,t),e}function hf(n){return uf.encodingLength(n)}function $a(n,e){const t=e.byteLength,r=hf(n),s=r+hf(t),i=new Uint8Array(s+t);return df(n,i,0),df(t,i,r),i.set(e,s),new Wm(n,t,e,i)}function jn(n){const e=p1(n),[t,r]=Cg(e),[s,i]=Cg(e.subarray(r)),a=e.subarray(r+i);if(a.byteLength!==s)throw new Error("Incorrect length");return new Wm(t,s,a,e)}function EM(n,e){if(n===e)return!0;{const t=e;return n.code===t.code&&n.size===t.size&&t.bytes instanceof Uint8Array&&LN(n.bytes,t.bytes)}}class Wm{code;size;digest;bytes;constructor(e,t,r,s){this.code=e,this.size=t,this.digest=r,this.bytes=s}}function N8(n,e){const{bytes:t,version:r}=n;switch(r){case 0:return kM(t,kg(n),e??bt.encoder);default:return AM(t,kg(n),e??gi.encoder)}}const M8=new WeakMap;function kg(n){const e=M8.get(n);if(e==null){const t=new Map;return M8.set(n,t),t}return e}class Be{code;version;multihash;bytes;"/";constructor(e,t,r,s){this.code=t,this.version=e,this.multihash=r,this.bytes=s,this["/"]=s}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==vc)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==PM)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return Be.createV0(t)}default:throw Error(`Can not convert CID version ${this.version} to version 0. This is a bug please report`)}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,r=$a(e,t);return Be.createV1(this.code,r)}case 1:return this;default:throw Error(`Can not convert CID version ${this.version} to version 1. This is a bug please report`)}}equals(e){return Be.equals(this,e)}static equals(e,t){const r=t;return r!=null&&e.code===r.code&&e.version===r.version&&EM(e.multihash,r.multihash)}toString(e){return N8(this,e)}toJSON(){return{"/":N8(this)}}link(){return this}[Symbol.toStringTag]="CID";[Symbol.for("nodejs.util.inspect.custom")](){return`CID(${this.toString()})`}static asCID(e){if(e==null)return null;const t=e;if(t instanceof Be)return t;if(t["/"]!=null&&t["/"]===t.bytes||t.asCID===t){const{version:r,code:s,multihash:i,bytes:a}=t;return new Be(r,s,i,a??R8(r,s,i.bytes))}else if(t[TM]===!0){const{version:r,multihash:s,code:i}=t,a=jn(s);return Be.create(r,i,a)}else return null}static create(e,t,r){if(typeof t!="number")throw new Error("String codecs are no longer supported");if(!(r.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:{if(t!==vc)throw new Error(`Version 0 CID must use dag-pb (code: ${vc}) block encoding`);return new Be(e,t,r,r.bytes)}case 1:{const s=R8(e,t,r.bytes);return new Be(e,t,r,s)}default:throw new Error("Invalid version")}}static createV0(e){return Be.create(0,vc,e)}static createV1(e,t){return Be.create(1,e,t)}static decode(e){const[t,r]=Be.decodeFirst(e);if(r.length!==0)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=Be.inspectBytes(e),r=t.size-t.multihashSize,s=p1(e.subarray(r,r+t.multihashSize));if(s.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=s.subarray(t.multihashSize-t.digestSize),a=new Wm(t.multihashCode,t.digestSize,i,s);return[t.version===0?Be.createV0(a):Be.createV1(t.codec,a),e.subarray(t.size)]}static inspectBytes(e){let t=0;const r=()=>{const[p,m]=Cg(e.subarray(t));return t+=m,p};let s=r(),i=vc;if(s===18?(s=0,t=0):i=r(),s!==0&&s!==1)throw new RangeError(`Invalid CID version ${s}`);const a=t,c=r(),u=r(),h=t+u,f=h-a;return{version:s,codec:i,multihashCode:c,digestSize:u,multihashSize:f,size:h}}static parse(e,t){const[r,s]=CM(e,t),i=Be.decode(s);if(i.version===0&&e[0]!=="Q")throw Error("Version 0 CID string must not include multibase prefix");return kg(i).set(r,e),i}}function CM(n,e){switch(n[0]){case"Q":{const t=e??bt;return[bt.prefix,t.decode(`${bt.prefix}${n}`)]}case bt.prefix:{const t=e??bt;return[bt.prefix,t.decode(n)]}case gi.prefix:{const t=e??gi;return[gi.prefix,t.decode(n)]}case zh.prefix:{const t=e??zh;return[zh.prefix,t.decode(n)]}default:{if(e==null)throw Error("To parse non base32, base36 or base58btc encoded CID multibase decoder must be provided");return[n[0],e.decode(n)]}}}function kM(n,e,t){const{prefix:r}=t;if(r!==bt.prefix)throw Error(`Cannot string encode V0 in ${t.name} encoding`);const s=e.get(r);if(s==null){const i=t.encode(n).slice(1);return e.set(r,i),i}else return s}function AM(n,e,t){const{prefix:r}=t,s=e.get(r);if(s==null){const i=t.encode(n);return e.set(r,i),i}else return s}const vc=112,PM=18;function R8(n,e,t){const r=hf(n),s=r+hf(e),i=new Uint8Array(s+t.byteLength);return df(n,i,0),df(e,i,r),i.set(t,s),i}const TM=Symbol.for("@ipld/js-cid/CID"),Xv=0,_M="identity",Jv=p1;function DM(n,e){if(e?.truncate!=null&&e.truncate!==n.byteLength){if(e.truncate<0||e.truncate>n.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${n.byteLength}`);n=n.subarray(0,e.truncate)}return $a(Xv,Jv(n))}const xr={code:Xv,name:_M,encode:Jv,digest:DM};function Ve(n,e){if(n===e)return!0;if(n.byteLength!==e.byteLength)return!1;for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return!1;return!0}function Fe(n=0){return new Uint8Array(n)}function Sr(n=0){return new Uint8Array(n)}function Cs(n,e){e==null&&(e=n.reduce((s,i)=>s+i.length,0));const t=Sr(e);let r=0;for(const s of n)t.set(s,r),r+=s.length;return t}const Zv=Symbol.for("@achingbrain/uint8arraylist");function L8(n,e){if(e==null||e<0)throw new RangeError("index is out of bounds");let t=0;for(const r of n){const s=t+r.byteLength;if(e<s)return{buf:r,index:e-t};t=s}throw new RangeError("index is out of bounds")}function ph(n){return!!n?.[Zv]}class Ie{bufs;length;[Zv]=!0;constructor(...e){this.bufs=[],this.length=0,e.length>0&&this.appendAll(e)}*[Symbol.iterator](){yield*this.bufs}get byteLength(){return this.length}append(...e){this.appendAll(e)}appendAll(e){let t=0;for(const r of e)if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.push(r);else if(ph(r))t+=r.byteLength,this.bufs.push(...r.bufs);else throw new Error("Could not append value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}prepend(...e){this.prependAll(e)}prependAll(e){let t=0;for(const r of e.reverse())if(r instanceof Uint8Array)t+=r.byteLength,this.bufs.unshift(r);else if(ph(r))t+=r.byteLength,this.bufs.unshift(...r.bufs);else throw new Error("Could not prepend value, must be an Uint8Array or a Uint8ArrayList");this.length+=t}get(e){const t=L8(this.bufs,e);return t.buf[t.index]}set(e,t){const r=L8(this.bufs,e);r.buf[r.index]=t}write(e,t=0){if(e instanceof Uint8Array)for(let r=0;r<e.length;r++)this.set(t+r,e[r]);else if(ph(e))for(let r=0;r<e.length;r++)this.set(t+r,e.get(r));else throw new Error("Could not write value, must be an Uint8Array or a Uint8ArrayList")}consume(e){if(e=Math.trunc(e),!(Number.isNaN(e)||e<=0)){if(e===this.byteLength){this.bufs=[],this.length=0;return}for(;this.bufs.length>0;)if(e>=this.bufs[0].byteLength)e-=this.bufs[0].byteLength,this.length-=this.bufs[0].byteLength,this.bufs.shift();else{this.bufs[0]=this.bufs[0].subarray(e),this.length-=e;break}}}slice(e,t){const{bufs:r,length:s}=this._subList(e,t);return Cs(r,s)}subarray(e,t){const{bufs:r,length:s}=this._subList(e,t);return r.length===1?r[0]:Cs(r,s)}sublist(e,t){const{bufs:r,length:s}=this._subList(e,t),i=new Ie;return i.length=s,i.bufs=[...r],i}_subList(e,t){if(e=e??0,t=t??this.length,e<0&&(e=this.length+e),t<0&&(t=this.length+t),e<0||t>this.length)throw new RangeError("index is out of bounds");if(e===t)return{bufs:[],length:0};if(e===0&&t===this.length)return{bufs:this.bufs,length:this.length};const r=[];let s=0;for(let i=0;i<this.bufs.length;i++){const a=this.bufs[i],c=s,u=c+a.byteLength;if(s=u,e>=u)continue;const h=e>=c&&e<u,f=t>c&&t<=u;if(h&&f){if(e===c&&t===u){r.push(a);break}const p=e-c;r.push(a.subarray(p,p+(t-e)));break}if(h){if(e===0){r.push(a);continue}r.push(a.subarray(e-c));continue}if(f){if(t===u){r.push(a);break}r.push(a.subarray(0,t-c));break}r.push(a)}return{bufs:r,length:t-e}}indexOf(e,t=0){if(!ph(e)&&!(e instanceof Uint8Array))throw new TypeError('The "value" argument must be a Uint8ArrayList or Uint8Array');const r=e instanceof Uint8Array?e:e.subarray();if(t=Number(t??0),isNaN(t)&&(t=0),t<0&&(t=this.length+t),t<0&&(t=0),e.length===0)return t>this.length?this.length:t;const s=r.byteLength;if(s===0)throw new TypeError("search must be at least 1 byte long");const i=256,a=new Int32Array(i);for(let p=0;p<i;p++)a[p]=-1;for(let p=0;p<s;p++)a[r[p]]=p;const c=a,u=this.byteLength-r.byteLength,h=r.byteLength-1;let f;for(let p=t;p<=u;p+=f){f=0;for(let m=h;m>=0;m--){const w=this.get(p+m);if(r[m]!==w){f=Math.max(1,m-c[w]);break}}if(f===0)return p}return-1}getInt8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getInt8(0)}setInt8(e,t){const r=Sr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setInt8(0,t),this.write(r,e)}getInt16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt16(0,t)}setInt16(e,t,r){const s=Fe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt16(0,t,r),this.write(s,e)}getInt32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getInt32(0,t)}setInt32(e,t,r){const s=Fe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setInt32(0,t,r),this.write(s,e)}getBigInt64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigInt64(0,t)}setBigInt64(e,t,r){const s=Fe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigInt64(0,t,r),this.write(s,e)}getUint8(e){const t=this.subarray(e,e+1);return new DataView(t.buffer,t.byteOffset,t.byteLength).getUint8(0)}setUint8(e,t){const r=Sr(1);new DataView(r.buffer,r.byteOffset,r.byteLength).setUint8(0,t),this.write(r,e)}getUint16(e,t){const r=this.subarray(e,e+2);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint16(0,t)}setUint16(e,t,r){const s=Fe(2);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint16(0,t,r),this.write(s,e)}getUint32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getUint32(0,t)}setUint32(e,t,r){const s=Fe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setUint32(0,t,r),this.write(s,e)}getBigUint64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getBigUint64(0,t)}setBigUint64(e,t,r){const s=Fe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setBigUint64(0,t,r),this.write(s,e)}getFloat32(e,t){const r=this.subarray(e,e+4);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat32(0,t)}setFloat32(e,t,r){const s=Fe(4);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat32(0,t,r),this.write(s,e)}getFloat64(e,t){const r=this.subarray(e,e+8);return new DataView(r.buffer,r.byteOffset,r.byteLength).getFloat64(0,t)}setFloat64(e,t,r){const s=Fe(8);new DataView(s.buffer,s.byteOffset,s.byteLength).setFloat64(0,t,r),this.write(s,e)}equals(e){if(e==null||!(e instanceof Ie)||e.bufs.length!==this.bufs.length)return!1;for(let t=0;t<this.bufs.length;t++)if(!Ve(this.bufs[t],e.bufs[t]))return!1;return!0}static fromUint8Arrays(e,t){const r=new Ie;return r.bufs=e,t==null&&(t=e.reduce((s,i)=>s+i.byteLength,0)),r.length=t,r}}const IM=Lu({prefix:"9",name:"base10",alphabet:"0123456789"}),NM=Object.freeze(Object.defineProperty({__proto__:null,base10:IM},Symbol.toStringTag,{value:"Module"})),MM=Qt({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),RM=Qt({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),LM=Object.freeze(Object.defineProperty({__proto__:null,base16:MM,base16upper:RM},Symbol.toStringTag,{value:"Module"})),OM=Qt({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),BM=Object.freeze(Object.defineProperty({__proto__:null,base2:OM},Symbol.toStringTag,{value:"Module"})),eb=Array.from(""),FM=eb.reduce((n,e,t)=>(n[t]=e,n),[]),UM=eb.reduce((n,e,t)=>{const r=e.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${e}`);return n[r]=t,n},[]);function VM(n){return n.reduce((e,t)=>(e+=FM[t],e),"")}function jM(n){const e=[];for(const t of n){const r=t.codePointAt(0);if(r==null)throw new Error(`Invalid character: ${t}`);const s=UM[r];if(s==null)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}const $M=g1({prefix:"",name:"base256emoji",encode:VM,decode:jM}),zM=Object.freeze(Object.defineProperty({__proto__:null,base256emoji:$M},Symbol.toStringTag,{value:"Module"})),Gm=Qt({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),HM=Qt({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),tb=Qt({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),KM=Qt({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),qM=Object.freeze(Object.defineProperty({__proto__:null,base64:Gm,base64pad:HM,base64url:tb,base64urlpad:KM},Symbol.toStringTag,{value:"Module"})),WM=Qt({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),GM=Object.freeze(Object.defineProperty({__proto__:null,base8:WM},Symbol.toStringTag,{value:"Module"})),QM=g1({prefix:"\0",name:"identity",encode:n=>BN(n),decode:n=>ON(n)}),YM=Object.freeze(Object.defineProperty({__proto__:null,identity:QM},Symbol.toStringTag,{value:"Module"}));new TextEncoder;new TextDecoder;const XM=85,JM=20;function ZM({name:n,code:e,encode:t,minDigestLength:r,maxDigestLength:s}){return new eR(n,e,t,r,s)}class eR{name;code;encode;minDigestLength;maxDigestLength;constructor(e,t,r,s,i){this.name=e,this.code=t,this.encode=r,this.minDigestLength=s??JM,this.maxDigestLength=i}digest(e,t){if(t?.truncate!=null){if(t.truncate<this.minDigestLength)throw new Error(`Invalid truncate option, must be greater than or equal to ${this.minDigestLength}`);if(this.maxDigestLength!=null&&t.truncate>this.maxDigestLength)throw new Error(`Invalid truncate option, must be less than or equal to ${this.maxDigestLength}`)}if(e instanceof Uint8Array){const r=this.encode(e);return r instanceof Uint8Array?O8(r,this.code,t?.truncate):r.then(s=>O8(s,this.code,t?.truncate))}else throw Error("Unknown type, must be binary type")}}function O8(n,e,t){if(t!=null&&t!==n.byteLength){if(t>n.byteLength)throw new Error(`Invalid truncate option, must be less than or equal to ${n.byteLength}`);n=n.subarray(0,t)}return $a(e,n)}function tR(n){return async e=>new Uint8Array(await crypto.subtle.digest(n,e))}const mn=ZM({name:"sha2-256",code:18,encode:tR("SHA-256")}),eu={...YM,...BM,...GM,...NM,...LM,...sM,...oM,...QN,...qM,...zM};function nb(n,e,t,r){return{name:n,prefix:e,encoder:{name:n,prefix:e,encode:t},decoder:{decode:r}}}const B8=nb("utf8","u",n=>"u"+new TextDecoder("utf8").decode(n),n=>new TextEncoder().encode(n.substring(1))),i2=nb("ascii","a",n=>{let e="a";for(let t=0;t<n.length;t++)e+=String.fromCharCode(n[t]);return e},n=>{n=n.substring(1);const e=Sr(n.length);for(let t=0;t<n.length;t++)e[t]=n.charCodeAt(t);return e}),rb={utf8:B8,"utf-8":B8,hex:eu.base16,latin1:i2,ascii:i2,binary:i2,...eu};function we(n,e="utf8"){const t=rb[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.decoder.decode(`${t.prefix}${n}`)}function pe(n,e="utf8"){const t=rb[e];if(t==null)throw new Error(`Unsupported encoding "${e}"`);return t.encoder.encode(n).substring(1)}const nR=parseInt("11111",2),Ag=parseInt("10000000",2),rR=parseInt("01111111",2),F8={0:bc,1:bc,2:sR,3:aR,4:lR,5:oR,6:iR,16:bc,22:bc,48:bc};function m1(n,e={offset:0}){const t=n[e.offset]&nR;if(e.offset++,F8[t]!=null)return F8[t](n,e);throw new Error("No decoder for tag "+t)}function Ou(n,e){let t=0;if((n[e.offset]&Ag)===Ag){const r=n[e.offset]&rR;let s="0x";e.offset++;for(let i=0;i<r;i++,e.offset++)s+=n[e.offset].toString(16).padStart(2,"0");t=parseInt(s,16)}else t=n[e.offset],e.offset++;return t}function bc(n,e){Ou(n,e);const t=[];for(;!(e.offset>=n.byteLength);){const r=m1(n,e);if(r===null)break;t.push(r)}return t}function sR(n,e){const t=Ou(n,e),r=e.offset,s=e.offset+t,i=[];for(let a=r;a<s;a++)a===r&&n[a]===0||i.push(n[a]);return e.offset+=t,Uint8Array.from(i)}function iR(n,e){const t=Ou(n,e),r=e.offset+t,s=n[e.offset];e.offset++;let i=0,a=0;s<40?(i=0,a=s):s<80?(i=1,a=s-40):(i=2,a=s-80);let c=`${i}.${a}`,u=[];for(;e.offset<r;){const h=n[e.offset];if(e.offset++,u.push(h&127),h<128){u.reverse();let f=0;for(let p=0;p<u.length;p++)f+=u[p]<<p*7;c+=`.${f}`,u=[]}}return c}function oR(n,e){return e.offset++,null}function aR(n,e){const t=Ou(n,e),r=n[e.offset];e.offset++;const s=n.subarray(e.offset,e.offset+t-1);if(e.offset+=t,r!==0)throw new Error("Unused bits in bit string is unimplemented");return s}function lR(n,e){const t=Ou(n,e),r=n.subarray(e.offset,e.offset+t);return e.offset+=t,r}function cR(n){let e=n.toString(16);e.length%2===1&&(e="0"+e);const t=new Ie;for(let r=0;r<e.length;r+=2)t.append(Uint8Array.from([parseInt(`${e[r]}${e[r+1]}`,16)]));return t}function Qm(n){if(n.byteLength<128)return Uint8Array.from([n.byteLength]);const e=cR(n.byteLength);return new Ie(Uint8Array.from([e.byteLength|Ag]),e)}function Pg(n){const e=new Ie,t=128;return(n.subarray()[0]&t)===t&&e.append(Uint8Array.from([0])),e.append(n),new Ie(Uint8Array.from([2]),Qm(e),e)}function sb(n){const e=Uint8Array.from([0]),t=new Ie(e,n);return new Ie(Uint8Array.from([3]),Qm(t),t)}function Uc(n,e=48){const t=new Ie;for(const r of n)t.append(r);return new Ie(Uint8Array.from([e]),Qm(t),t)}async function uR(n,e,t,r){const s=await crypto.subtle.importKey("jwk",n,{name:"ECDSA",namedCurve:n.crv??"P-256"},!1,["verify"]);r?.signal?.throwIfAborted();const i=await crypto.subtle.verify({name:"ECDSA",hash:{name:"SHA-256"}},s,e,t.subarray());return r?.signal?.throwIfAborted(),i}const dR=Uint8Array.from([6,8,42,134,72,206,61,3,1,7]),hR=Uint8Array.from([6,5,43,129,4,0,34]),fR=Uint8Array.from([6,5,43,129,4,0,35]),pR={ext:!0,kty:"EC",crv:"P-256"},gR={ext:!0,kty:"EC",crv:"P-384"},mR={ext:!0,kty:"EC",crv:"P-521"},o2=32,a2=48,l2=66;function ib(n){const e=m1(n);return yR(e)}function yR(n){const e=n[1][1][0],t=1;let r,s;if(e.byteLength===o2*2+1)return r=pe(e.subarray(t,t+o2),"base64url"),s=pe(e.subarray(t+o2),"base64url"),new c2({...pR,key_ops:["verify"],x:r,y:s});if(e.byteLength===a2*2+1)return r=pe(e.subarray(t,t+a2),"base64url"),s=pe(e.subarray(t+a2),"base64url"),new c2({...gR,key_ops:["verify"],x:r,y:s});if(e.byteLength===l2*2+1)return r=pe(e.subarray(t,t+l2),"base64url"),s=pe(e.subarray(t+l2),"base64url"),new c2({...mR,key_ops:["verify"],x:r,y:s});throw new Ae(`coordinates were wrong length, got ${e.byteLength}, expected 65, 97 or 133`)}function wR(n){return Uc([Pg(Uint8Array.from([1])),Uc([vR(n.crv)],160),Uc([sb(new Ie(Uint8Array.from([4]),we(n.x??"","base64url"),we(n.y??"","base64url")))],161)]).subarray()}function vR(n){if(n==="P-256")return dR;if(n==="P-384")return hR;if(n==="P-521")return fR;throw new Ae(`Invalid curve ${n}`)}class c2{type="ECDSA";jwk;_raw;constructor(e){this.jwk=e}get raw(){return this._raw==null&&(this._raw=wR(this.jwk)),this._raw}toMultihash(){return xr.digest(ws(this))}toCID(){return Be.createV1(114,this.toMultihash())}toString(){return bt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Ve(this.raw,e.raw)}async verify(e,t,r){return uR(this.jwk,t,e,r)}}const ua=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Bu(n){return n instanceof Uint8Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint8Array"}function io(n){if(!Number.isSafeInteger(n)||n<0)throw new Error("positive integer expected, got "+n)}function _s(n,...e){if(!Bu(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error("Uint8Array expected of length "+e+", got length="+n.length)}function Fu(n){if(typeof n!="function"||typeof n.create!="function")throw new Error("Hash should be wrapped by utils.createHasher");io(n.outputLen),io(n.blockLen)}function ff(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function bR(n,e){_s(n);const t=e.outputLen;if(n.length<t)throw new Error("digestInto() expects output buffer of length at least "+t)}function Ei(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}function Hh(n){return new DataView(n.buffer,n.byteOffset,n.byteLength)}function Ir(n,e){return n<<32-e|n>>>e}const ob=typeof Uint8Array.from([]).toHex=="function"&&typeof Uint8Array.fromHex=="function",xR=Array.from({length:256},(n,e)=>e.toString(16).padStart(2,"0"));function oo(n){if(_s(n),ob)return n.toHex();let e="";for(let t=0;t<n.length;t++)e+=xR[n[t]];return e}const as={_0:48,_9:57,A:65,F:70,a:97,f:102};function U8(n){if(n>=as._0&&n<=as._9)return n-as._0;if(n>=as.A&&n<=as.F)return n-(as.A-10);if(n>=as.a&&n<=as.f)return n-(as.a-10)}function pf(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);if(ob)return Uint8Array.fromHex(n);const e=n.length,t=e/2;if(e%2)throw new Error("hex string expected, got unpadded hex of length "+e);const r=new Uint8Array(t);for(let s=0,i=0;s<t;s++,i+=2){const a=U8(n.charCodeAt(i)),c=U8(n.charCodeAt(i+1));if(a===void 0||c===void 0){const u=n[i]+n[i+1];throw new Error('hex string expected, got non-hex character "'+u+'" at index '+i)}r[s]=a*16+c}return r}const SR=async()=>{};async function ER(n,e,t){let r=Date.now();for(let s=0;s<n;s++){t(s);const i=Date.now()-r;i>=0&&i<e||(await SR(),r+=i)}}function ab(n){if(typeof n!="string")throw new Error("string expected");return new Uint8Array(new TextEncoder().encode(n))}function tu(n){return typeof n=="string"&&(n=ab(n)),_s(n),n}function V8(n){return typeof n=="string"&&(n=ab(n)),_s(n),n}function Fr(...n){let e=0;for(let r=0;r<n.length;r++){const s=n[r];_s(s),e+=s.length}const t=new Uint8Array(e);for(let r=0,s=0;r<n.length;r++){const i=n[r];t.set(i,s),s+=i.length}return t}function CR(n,e){if(e!==void 0&&{}.toString.call(e)!=="[object Object]")throw new Error("options should be object or undefined");return Object.assign(n,e)}class lb{}function cb(n){const e=r=>n().update(tu(r)).digest(),t=n();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>n(),e}function Po(n=32){if(ua&&typeof ua.getRandomValues=="function")return ua.getRandomValues(new Uint8Array(n));if(ua&&typeof ua.randomBytes=="function")return Uint8Array.from(ua.randomBytes(n));throw new Error("crypto.getRandomValues must be defined")}function kR(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const s=BigInt(32),i=BigInt(4294967295),a=Number(t>>s&i),c=Number(t&i),u=r?4:0,h=r?0:4;n.setUint32(e+u,a,r),n.setUint32(e+h,c,r)}function AR(n,e,t){return n&e^~n&t}function PR(n,e,t){return n&e^n&t^e&t}class ub extends lb{constructor(e,t,r,s){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=r,this.isLE=s,this.buffer=new Uint8Array(e),this.view=Hh(this.buffer)}update(e){ff(this),e=tu(e),_s(e);const{view:t,buffer:r,blockLen:s}=this,i=e.length;for(let a=0;a<i;){const c=Math.min(s-this.pos,i-a);if(c===s){const u=Hh(e);for(;s<=i-a;a+=s)this.process(u,a);continue}r.set(e.subarray(a,a+c),this.pos),this.pos+=c,a+=c,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ff(this),bR(e,this),this.finished=!0;const{buffer:t,view:r,blockLen:s,isLE:i}=this;let{pos:a}=this;t[a++]=128,Ei(this.buffer.subarray(a)),this.padOffset>s-a&&(this.process(r,0),a=0);for(let p=a;p<s;p++)t[p]=0;kR(r,s-8,BigInt(this.length*8),i),this.process(r,0);const c=Hh(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const h=u/4,f=this.get();if(h>f.length)throw new Error("_sha2: outputLen bigger than state");for(let p=0;p<h;p++)c.setUint32(4*p,f[p],i)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:r,length:s,finished:i,destroyed:a,pos:c}=this;return e.destroyed=a,e.finished=i,e.length=s,e.pos=c,s%t&&e.buffer.set(r),e}clone(){return this._cloneInto()}}const ei=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),en=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),gh=BigInt(2**32-1),j8=BigInt(32);function TR(n,e=!1){return e?{h:Number(n&gh),l:Number(n>>j8&gh)}:{h:Number(n>>j8&gh)|0,l:Number(n&gh)|0}}function _R(n,e=!1){const t=n.length;let r=new Uint32Array(t),s=new Uint32Array(t);for(let i=0;i<t;i++){const{h:a,l:c}=TR(n[i],e);[r[i],s[i]]=[a,c]}return[r,s]}const $8=(n,e,t)=>n>>>t,z8=(n,e,t)=>n<<32-t|e>>>t,da=(n,e,t)=>n>>>t|e<<32-t,ha=(n,e,t)=>n<<32-t|e>>>t,mh=(n,e,t)=>n<<64-t|e>>>t-32,yh=(n,e,t)=>n>>>t-32|e<<64-t;function ls(n,e,t,r){const s=(e>>>0)+(r>>>0);return{h:n+t+(s/2**32|0)|0,l:s|0}}const DR=(n,e,t)=>(n>>>0)+(e>>>0)+(t>>>0),IR=(n,e,t,r)=>e+t+r+(n/2**32|0)|0,NR=(n,e,t,r)=>(n>>>0)+(e>>>0)+(t>>>0)+(r>>>0),MR=(n,e,t,r,s)=>e+t+r+s+(n/2**32|0)|0,RR=(n,e,t,r,s)=>(n>>>0)+(e>>>0)+(t>>>0)+(r>>>0)+(s>>>0),LR=(n,e,t,r,s,i)=>e+t+r+s+i+(n/2**32|0)|0,OR=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ti=new Uint32Array(64);class BR extends ub{constructor(e=32){super(64,e,8,!1),this.A=ei[0]|0,this.B=ei[1]|0,this.C=ei[2]|0,this.D=ei[3]|0,this.E=ei[4]|0,this.F=ei[5]|0,this.G=ei[6]|0,this.H=ei[7]|0}get(){const{A:e,B:t,C:r,D:s,E:i,F:a,G:c,H:u}=this;return[e,t,r,s,i,a,c,u]}set(e,t,r,s,i,a,c,u){this.A=e|0,this.B=t|0,this.C=r|0,this.D=s|0,this.E=i|0,this.F=a|0,this.G=c|0,this.H=u|0}process(e,t){for(let p=0;p<16;p++,t+=4)ti[p]=e.getUint32(t,!1);for(let p=16;p<64;p++){const m=ti[p-15],w=ti[p-2],x=Ir(m,7)^Ir(m,18)^m>>>3,S=Ir(w,17)^Ir(w,19)^w>>>10;ti[p]=S+ti[p-7]+x+ti[p-16]|0}let{A:r,B:s,C:i,D:a,E:c,F:u,G:h,H:f}=this;for(let p=0;p<64;p++){const m=Ir(c,6)^Ir(c,11)^Ir(c,25),w=f+m+AR(c,u,h)+OR[p]+ti[p]|0,S=(Ir(r,2)^Ir(r,13)^Ir(r,22))+PR(r,s,i)|0;f=h,h=u,u=c,c=a+w|0,a=i,i=s,s=r,r=w+S|0}r=r+this.A|0,s=s+this.B|0,i=i+this.C|0,a=a+this.D|0,c=c+this.E|0,u=u+this.F|0,h=h+this.G|0,f=f+this.H|0,this.set(r,s,i,a,c,u,h,f)}roundClean(){Ei(ti)}destroy(){this.set(0,0,0,0,0,0,0,0),Ei(this.buffer)}}const db=_R(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(n=>BigInt(n))),FR=db[0],UR=db[1],ni=new Uint32Array(80),ri=new Uint32Array(80);class VR extends ub{constructor(e=64){super(128,e,16,!1),this.Ah=en[0]|0,this.Al=en[1]|0,this.Bh=en[2]|0,this.Bl=en[3]|0,this.Ch=en[4]|0,this.Cl=en[5]|0,this.Dh=en[6]|0,this.Dl=en[7]|0,this.Eh=en[8]|0,this.El=en[9]|0,this.Fh=en[10]|0,this.Fl=en[11]|0,this.Gh=en[12]|0,this.Gl=en[13]|0,this.Hh=en[14]|0,this.Hl=en[15]|0}get(){const{Ah:e,Al:t,Bh:r,Bl:s,Ch:i,Cl:a,Dh:c,Dl:u,Eh:h,El:f,Fh:p,Fl:m,Gh:w,Gl:x,Hh:S,Hl:E}=this;return[e,t,r,s,i,a,c,u,h,f,p,m,w,x,S,E]}set(e,t,r,s,i,a,c,u,h,f,p,m,w,x,S,E){this.Ah=e|0,this.Al=t|0,this.Bh=r|0,this.Bl=s|0,this.Ch=i|0,this.Cl=a|0,this.Dh=c|0,this.Dl=u|0,this.Eh=h|0,this.El=f|0,this.Fh=p|0,this.Fl=m|0,this.Gh=w|0,this.Gl=x|0,this.Hh=S|0,this.Hl=E|0}process(e,t){for(let k=0;k<16;k++,t+=4)ni[k]=e.getUint32(t),ri[k]=e.getUint32(t+=4);for(let k=16;k<80;k++){const F=ni[k-15]|0,I=ri[k-15]|0,V=da(F,I,1)^da(F,I,8)^$8(F,I,7),Q=ha(F,I,1)^ha(F,I,8)^z8(F,I,7),D=ni[k-2]|0,R=ri[k-2]|0,Y=da(D,R,19)^mh(D,R,61)^$8(D,R,6),J=ha(D,R,19)^yh(D,R,61)^z8(D,R,6),X=NR(Q,J,ri[k-7],ri[k-16]),B=MR(X,V,Y,ni[k-7],ni[k-16]);ni[k]=B|0,ri[k]=X|0}let{Ah:r,Al:s,Bh:i,Bl:a,Ch:c,Cl:u,Dh:h,Dl:f,Eh:p,El:m,Fh:w,Fl:x,Gh:S,Gl:E,Hh:A,Hl:P}=this;for(let k=0;k<80;k++){const F=da(p,m,14)^da(p,m,18)^mh(p,m,41),I=ha(p,m,14)^ha(p,m,18)^yh(p,m,41),V=p&w^~p&S,Q=m&x^~m&E,D=RR(P,I,Q,UR[k],ri[k]),R=LR(D,A,F,V,FR[k],ni[k]),Y=D|0,J=da(r,s,28)^mh(r,s,34)^mh(r,s,39),X=ha(r,s,28)^yh(r,s,34)^yh(r,s,39),B=r&i^r&c^i&c,O=s&a^s&u^a&u;A=S|0,P=E|0,S=w|0,E=x|0,w=p|0,x=m|0,{h:p,l:m}=ls(h|0,f|0,R|0,Y|0),h=c|0,f=u|0,c=i|0,u=a|0,i=r|0,a=s|0;const L=DR(Y,X,O);r=IR(L,R,J,B),s=L|0}({h:r,l:s}=ls(this.Ah|0,this.Al|0,r|0,s|0)),{h:i,l:a}=ls(this.Bh|0,this.Bl|0,i|0,a|0),{h:c,l:u}=ls(this.Ch|0,this.Cl|0,c|0,u|0),{h,l:f}=ls(this.Dh|0,this.Dl|0,h|0,f|0),{h:p,l:m}=ls(this.Eh|0,this.El|0,p|0,m|0),{h:w,l:x}=ls(this.Fh|0,this.Fl|0,w|0,x|0),{h:S,l:E}=ls(this.Gh|0,this.Gl|0,S|0,E|0),{h:A,l:P}=ls(this.Hh|0,this.Hl|0,A|0,P|0),this.set(r,s,i,a,c,u,h,f,p,m,w,x,S,E,A,P)}roundClean(){Ei(ni,ri)}destroy(){Ei(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}}const hb=cb(()=>new BR),fb=cb(()=>new VR);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Ym=BigInt(0),Tg=BigInt(1);function ho(n,e=""){if(typeof n!="boolean"){const t=e&&`"${e}"`;throw new Error(t+"expected boolean, got type="+typeof n)}return n}function yr(n,e,t=""){const r=Bu(n),s=n?.length,i=e!==void 0;if(!r||i&&s!==e){const a=t&&`"${t}" `,c=i?` of length ${e}`:"",u=r?`length=${s}`:`type=${typeof n}`;throw new Error(a+"expected Uint8Array"+c+", got "+u)}return n}function wh(n){const e=n.toString(16);return e.length&1?"0"+e:e}function pb(n){if(typeof n!="string")throw new Error("hex string expected, got "+typeof n);return n===""?Ym:BigInt("0x"+n)}function y1(n){return pb(oo(n))}function fo(n){return _s(n),pb(oo(Uint8Array.from(n).reverse()))}function Xm(n,e){return pf(n.toString(16).padStart(e*2,"0"))}function Jm(n,e){return Xm(n,e).reverse()}function at(n,e,t){let r;if(typeof e=="string")try{r=pf(e)}catch(i){throw new Error(n+" must be hex string or Uint8Array, cause: "+i)}else if(Bu(e))r=Uint8Array.from(e);else throw new Error(n+" must be hex string or Uint8Array");const s=r.length;if(typeof t=="number"&&s!==t)throw new Error(n+" of length "+t+" expected, got "+s);return r}function H8(n){return Uint8Array.from(n)}const u2=n=>typeof n=="bigint"&&Ym<=n;function jR(n,e,t){return u2(n)&&u2(e)&&u2(t)&&e<=n&&n<t}function nu(n,e,t,r){if(!jR(e,t,r))throw new Error("expected valid "+n+": "+t+" <= n < "+r+", got "+e)}function gb(n){let e;for(e=0;n>Ym;n>>=Tg,e+=1);return e}const Uu=n=>(Tg<<BigInt(n))-Tg;function $R(n,e,t){if(typeof n!="number"||n<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");const r=w=>new Uint8Array(w),s=w=>Uint8Array.of(w);let i=r(n),a=r(n),c=0;const u=()=>{i.fill(1),a.fill(0),c=0},h=(...w)=>t(a,i,...w),f=(w=r(0))=>{a=h(s(0),w),i=h(),w.length!==0&&(a=h(s(1),w),i=h())},p=()=>{if(c++>=1e3)throw new Error("drbg: tried 1000 values");let w=0;const x=[];for(;w<e;){i=h();const S=i.slice();x.push(S),w+=i.length}return Fr(...x)};return(w,x)=>{u(),f(w);let S;for(;!(S=x(p()));)f();return u(),S}}function yl(n,e,t={}){if(!n||typeof n!="object")throw new Error("expected valid options object");function r(s,i,a){const c=n[s];if(a&&c===void 0)return;const u=typeof c;if(u!==i||c===null)throw new Error(`param "${s}" is invalid: expected ${i}, got ${u}`)}Object.entries(e).forEach(([s,i])=>r(s,i,!1)),Object.entries(t).forEach(([s,i])=>r(s,i,!0))}function gf(n){const e=new WeakMap;return(t,...r)=>{const s=e.get(t);if(s!==void 0)return s;const i=n(t,...r);return e.set(t,i),i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const kn=BigInt(0),Wt=BigInt(1),Ji=BigInt(2),mb=BigInt(3),yb=BigInt(4),wb=BigInt(5),zR=BigInt(7),vb=BigInt(8),HR=BigInt(9),bb=BigInt(16);function mt(n,e){const t=n%e;return t>=kn?t:e+t}function ht(n,e,t){let r=n;for(;e-- >kn;)r*=r,r%=t;return r}function K8(n,e){if(n===kn)throw new Error("invert: expected non-zero number");if(e<=kn)throw new Error("invert: expected positive modulus, got "+e);let t=mt(n,e),r=e,s=kn,i=Wt;for(;t!==kn;){const c=r/t,u=r%t,h=s-i*c;r=t,t=u,s=i,i=h}if(r!==Wt)throw new Error("invert: does not exist");return mt(s,e)}function Zm(n,e,t){if(!n.eql(n.sqr(e),t))throw new Error("Cannot find square root")}function xb(n,e){const t=(n.ORDER+Wt)/yb,r=n.pow(e,t);return Zm(n,r,e),r}function KR(n,e){const t=(n.ORDER-wb)/vb,r=n.mul(e,Ji),s=n.pow(r,t),i=n.mul(e,s),a=n.mul(n.mul(i,Ji),s),c=n.mul(i,n.sub(a,n.ONE));return Zm(n,c,e),c}function qR(n){const e=To(n),t=Sb(n),r=t(e,e.neg(e.ONE)),s=t(e,r),i=t(e,e.neg(r)),a=(n+zR)/bb;return(c,u)=>{let h=c.pow(u,a),f=c.mul(h,r);const p=c.mul(h,s),m=c.mul(h,i),w=c.eql(c.sqr(f),u),x=c.eql(c.sqr(p),u);h=c.cmov(h,f,w),f=c.cmov(m,p,x);const S=c.eql(c.sqr(f),u),E=c.cmov(h,f,S);return Zm(c,E,u),E}}function Sb(n){if(n<mb)throw new Error("sqrt is not defined for small field");let e=n-Wt,t=0;for(;e%Ji===kn;)e/=Ji,t++;let r=Ji;const s=To(n);for(;q8(s,r)===1;)if(r++>1e3)throw new Error("Cannot find square root: probably non-prime P");if(t===1)return xb;let i=s.pow(r,e);const a=(e+Wt)/Ji;return function(u,h){if(u.is0(h))return h;if(q8(u,h)!==1)throw new Error("Cannot find square root");let f=t,p=u.mul(u.ONE,i),m=u.pow(h,e),w=u.pow(h,a);for(;!u.eql(m,u.ONE);){if(u.is0(m))return u.ZERO;let x=1,S=u.sqr(m);for(;!u.eql(S,u.ONE);)if(x++,S=u.sqr(S),x===f)throw new Error("Cannot find square root");const E=Wt<<BigInt(f-x-1),A=u.pow(p,E);f=x,p=u.sqr(A),m=u.mul(m,p),w=u.mul(w,A)}return w}}function WR(n){return n%yb===mb?xb:n%vb===wb?KR:n%bb===HR?qR(n):Sb(n)}const GR=(n,e)=>(mt(n,e)&Wt)===Wt,QR=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function YR(n){const e={ORDER:"bigint",MASK:"bigint",BYTES:"number",BITS:"number"},t=QR.reduce((r,s)=>(r[s]="function",r),e);return yl(n,t),n}function XR(n,e,t){if(t<kn)throw new Error("invalid exponent, negatives unsupported");if(t===kn)return n.ONE;if(t===Wt)return e;let r=n.ONE,s=e;for(;t>kn;)t&Wt&&(r=n.mul(r,s)),s=n.sqr(s),t>>=Wt;return r}function Eb(n,e,t=!1){const r=new Array(e.length).fill(t?n.ZERO:void 0),s=e.reduce((a,c,u)=>n.is0(c)?a:(r[u]=a,n.mul(a,c)),n.ONE),i=n.inv(s);return e.reduceRight((a,c,u)=>n.is0(c)?a:(r[u]=n.mul(a,r[u]),n.mul(a,c)),i),r}function q8(n,e){const t=(n.ORDER-Wt)/Ji,r=n.pow(e,t),s=n.eql(r,n.ONE),i=n.eql(r,n.ZERO),a=n.eql(r,n.neg(n.ONE));if(!s&&!i&&!a)throw new Error("invalid Legendre symbol result");return s?1:i?0:-1}function Cb(n,e){e!==void 0&&io(e);const t=e!==void 0?e:n.toString(2).length,r=Math.ceil(t/8);return{nBitLength:t,nByteLength:r}}function To(n,e,t=!1,r={}){if(n<=kn)throw new Error("invalid field: expected ORDER > 0, got "+n);let s,i,a=!1,c;if(typeof e=="object"&&e!=null){if(r.sqrt||t)throw new Error("cannot specify opts in two arguments");const m=e;m.BITS&&(s=m.BITS),m.sqrt&&(i=m.sqrt),typeof m.isLE=="boolean"&&(t=m.isLE),typeof m.modFromBytes=="boolean"&&(a=m.modFromBytes),c=m.allowedLengths}else typeof e=="number"&&(s=e),r.sqrt&&(i=r.sqrt);const{nBitLength:u,nByteLength:h}=Cb(n,s);if(h>2048)throw new Error("invalid field: expected ORDER of <= 2048 bytes");let f;const p=Object.freeze({ORDER:n,isLE:t,BITS:u,BYTES:h,MASK:Uu(u),ZERO:kn,ONE:Wt,allowedLengths:c,create:m=>mt(m,n),isValid:m=>{if(typeof m!="bigint")throw new Error("invalid field element: expected bigint, got "+typeof m);return kn<=m&&m<n},is0:m=>m===kn,isValidNot0:m=>!p.is0(m)&&p.isValid(m),isOdd:m=>(m&Wt)===Wt,neg:m=>mt(-m,n),eql:(m,w)=>m===w,sqr:m=>mt(m*m,n),add:(m,w)=>mt(m+w,n),sub:(m,w)=>mt(m-w,n),mul:(m,w)=>mt(m*w,n),pow:(m,w)=>XR(p,m,w),div:(m,w)=>mt(m*K8(w,n),n),sqrN:m=>m*m,addN:(m,w)=>m+w,subN:(m,w)=>m-w,mulN:(m,w)=>m*w,inv:m=>K8(m,n),sqrt:i||(m=>(f||(f=WR(n)),f(p,m))),toBytes:m=>t?Jm(m,h):Xm(m,h),fromBytes:(m,w=!0)=>{if(c){if(!c.includes(m.length)||m.length>h)throw new Error("Field.fromBytes: expected "+c+" bytes, got "+m.length);const S=new Uint8Array(h);S.set(m,t?0:S.length-m.length),m=S}if(m.length!==h)throw new Error("Field.fromBytes: expected "+h+" bytes, got "+m.length);let x=t?fo(m):y1(m);if(a&&(x=mt(x,n)),!w&&!p.isValid(x))throw new Error("invalid field element: outside of range 0..ORDER");return x},invertBatch:m=>Eb(p,m),cmov:(m,w,x)=>x?w:m});return Object.freeze(p)}function kb(n){if(typeof n!="bigint")throw new Error("field order must be bigint");const e=n.toString(2).length;return Math.ceil(e/8)}function Ab(n){const e=kb(n);return e+Math.ceil(e/2)}function JR(n,e,t=!1){const r=n.length,s=kb(e),i=Ab(e);if(r<16||r<i||r>1024)throw new Error("expected "+i+"-1024 bytes of input, got "+r);const a=t?fo(n):y1(n),c=mt(a,e-Wt)+Wt;return t?Jm(c,s):Xm(c,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const za=BigInt(0),Zi=BigInt(1);function mf(n,e){const t=e.negate();return n?t:e}function eo(n,e){const t=Eb(n.Fp,e.map(r=>r.Z));return e.map((r,s)=>n.fromAffine(r.toAffine(t[s])))}function Pb(n,e){if(!Number.isSafeInteger(n)||n<=0||n>e)throw new Error("invalid window size, expected [1.."+e+"], got W="+n)}function d2(n,e){Pb(n,e);const t=Math.ceil(e/n)+1,r=2**(n-1),s=2**n,i=Uu(n),a=BigInt(n);return{windows:t,windowSize:r,mask:i,maxNumber:s,shiftBy:a}}function W8(n,e,t){const{windowSize:r,mask:s,maxNumber:i,shiftBy:a}=t;let c=Number(n&s),u=n>>a;c>r&&(c-=i,u+=Zi);const h=e*r,f=h+Math.abs(c)-1,p=c===0,m=c<0,w=e%2!==0;return{nextN:u,offset:f,isZero:p,isNeg:m,isNegF:w,offsetF:h}}function ZR(n,e){if(!Array.isArray(n))throw new Error("array expected");n.forEach((t,r)=>{if(!(t instanceof e))throw new Error("invalid point at index "+r)})}function eL(n,e){if(!Array.isArray(n))throw new Error("array of scalars expected");n.forEach((t,r)=>{if(!e.isValid(t))throw new Error("invalid scalar at index "+r)})}const h2=new WeakMap,Tb=new WeakMap;function f2(n){return Tb.get(n)||1}function G8(n){if(n!==za)throw new Error("invalid wNAF")}class _b{constructor(e,t){this.BASE=e.BASE,this.ZERO=e.ZERO,this.Fn=e.Fn,this.bits=t}_unsafeLadder(e,t,r=this.ZERO){let s=e;for(;t>za;)t&Zi&&(r=r.add(s)),s=s.double(),t>>=Zi;return r}precomputeWindow(e,t){const{windows:r,windowSize:s}=d2(t,this.bits),i=[];let a=e,c=a;for(let u=0;u<r;u++){c=a,i.push(c);for(let h=1;h<s;h++)c=c.add(a),i.push(c);a=c.double()}return i}wNAF(e,t,r){if(!this.Fn.isValid(r))throw new Error("invalid scalar");let s=this.ZERO,i=this.BASE;const a=d2(e,this.bits);for(let c=0;c<a.windows;c++){const{nextN:u,offset:h,isZero:f,isNeg:p,isNegF:m,offsetF:w}=W8(r,c,a);r=u,f?i=i.add(mf(m,t[w])):s=s.add(mf(p,t[h]))}return G8(r),{p:s,f:i}}wNAFUnsafe(e,t,r,s=this.ZERO){const i=d2(e,this.bits);for(let a=0;a<i.windows&&r!==za;a++){const{nextN:c,offset:u,isZero:h,isNeg:f}=W8(r,a,i);if(r=c,!h){const p=t[u];s=s.add(f?p.negate():p)}}return G8(r),s}getPrecomputes(e,t,r){let s=h2.get(t);return s||(s=this.precomputeWindow(t,e),e!==1&&(typeof r=="function"&&(s=r(s)),h2.set(t,s))),s}cached(e,t,r){const s=f2(e);return this.wNAF(s,this.getPrecomputes(s,e,r),t)}unsafe(e,t,r,s){const i=f2(e);return i===1?this._unsafeLadder(e,t,s):this.wNAFUnsafe(i,this.getPrecomputes(i,e,r),t,s)}createCache(e,t){Pb(t,this.bits),Tb.set(e,t),h2.delete(e)}hasCache(e){return f2(e)!==1}}function tL(n,e,t,r){let s=e,i=n.ZERO,a=n.ZERO;for(;t>za||r>za;)t&Zi&&(i=i.add(s)),r&Zi&&(a=a.add(s)),s=s.double(),t>>=Zi,r>>=Zi;return{p1:i,p2:a}}function Db(n,e,t,r){ZR(t,n),eL(r,e);const s=t.length,i=r.length;if(s!==i)throw new Error("arrays of points and scalars must have equal length");const a=n.ZERO,c=gb(BigInt(s));let u=1;c>12?u=c-3:c>4?u=c-2:c>0&&(u=2);const h=Uu(u),f=new Array(Number(h)+1).fill(a),p=Math.floor((e.BITS-1)/u)*u;let m=a;for(let w=p;w>=0;w-=u){f.fill(a);for(let S=0;S<i;S++){const E=r[S],A=Number(E>>BigInt(w)&h);f[A]=f[A].add(t[S])}let x=a;for(let S=f.length-1,E=a;S>0;S--)E=E.add(f[S]),x=x.add(E);if(m=m.add(x),w!==0)for(let S=0;S<u;S++)m=m.double()}return m}function Q8(n,e,t){if(e){if(e.ORDER!==n)throw new Error("Field.ORDER must match order: Fp == p, Fn == n");return YR(e),e}else return To(n,{isLE:t})}function Ib(n,e,t={},r){if(r===void 0&&(r=n==="edwards"),!e||typeof e!="object")throw new Error(`expected valid ${n} CURVE object`);for(const u of["p","n","h"]){const h=e[u];if(!(typeof h=="bigint"&&h>za))throw new Error(`CURVE.${u} must be positive bigint`)}const s=Q8(e.p,t.Fp,r),i=Q8(e.n,t.Fn,r),c=["Gx","Gy","a",n==="weierstrass"?"b":"d"];for(const u of c)if(!s.isValid(e[u]))throw new Error(`CURVE.${u} must be valid field element of CURVE.Fp`);return e=Object.freeze(Object.assign({},e)),{CURVE:e,Fp:s,Fn:i}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const si=BigInt(0),Ot=BigInt(1),p2=BigInt(2),nL=BigInt(8);function rL(n,e,t,r){const s=n.sqr(t),i=n.sqr(r),a=n.add(n.mul(e.a,s),i),c=n.add(n.ONE,n.mul(e.d,n.mul(s,i)));return n.eql(a,c)}function sL(n,e={}){const t=Ib("edwards",n,e,e.FpFnLE),{Fp:r,Fn:s}=t;let i=t.CURVE;const{h:a}=i;yl(e,{},{uvRatio:"function"});const c=p2<<BigInt(s.BYTES*8)-Ot,u=E=>r.create(E),h=e.uvRatio||((E,A)=>{try{return{isValid:!0,value:r.sqrt(r.div(E,A))}}catch{return{isValid:!1,value:si}}});if(!rL(r,i,i.Gx,i.Gy))throw new Error("bad curve params: generator point");function f(E,A,P=!1){const k=P?Ot:si;return nu("coordinate "+E,A,k,c),A}function p(E){if(!(E instanceof x))throw new Error("ExtendedPoint expected")}const m=gf((E,A)=>{const{X:P,Y:k,Z:F}=E,I=E.is0();A==null&&(A=I?nL:r.inv(F));const V=u(P*A),Q=u(k*A),D=r.mul(F,A);if(I)return{x:si,y:Ot};if(D!==Ot)throw new Error("invZ was invalid");return{x:V,y:Q}}),w=gf(E=>{const{a:A,d:P}=i;if(E.is0())throw new Error("bad point: ZERO");const{X:k,Y:F,Z:I,T:V}=E,Q=u(k*k),D=u(F*F),R=u(I*I),Y=u(R*R),J=u(Q*A),X=u(R*u(J+D)),B=u(Y+u(P*u(Q*D)));if(X!==B)throw new Error("bad point: equation left != right (1)");const O=u(k*F),L=u(I*V);if(O!==L)throw new Error("bad point: equation left != right (2)");return!0});class x{constructor(A,P,k,F){this.X=f("x",A),this.Y=f("y",P),this.Z=f("z",k,!0),this.T=f("t",F),Object.freeze(this)}static CURVE(){return i}static fromAffine(A){if(A instanceof x)throw new Error("extended point not allowed");const{x:P,y:k}=A||{};return f("x",P),f("y",k),new x(P,k,Ot,u(P*k))}static fromBytes(A,P=!1){const k=r.BYTES,{a:F,d:I}=i;A=H8(yr(A,k,"point")),ho(P,"zip215");const V=H8(A),Q=A[k-1];V[k-1]=Q&-129;const D=fo(V),R=P?c:r.ORDER;nu("point.y",D,si,R);const Y=u(D*D),J=u(Y-Ot),X=u(I*Y-F);let{isValid:B,value:O}=h(J,X);if(!B)throw new Error("bad point: invalid y coordinate");const L=(O&Ot)===Ot,K=(Q&128)!==0;if(!P&&O===si&&K)throw new Error("bad point: x=0 and x_0=1");return K!==L&&(O=u(-O)),x.fromAffine({x:O,y:D})}static fromHex(A,P=!1){return x.fromBytes(at("point",A),P)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(A=8,P=!0){return S.createCache(this,A),P||this.multiply(p2),this}assertValidity(){w(this)}equals(A){p(A);const{X:P,Y:k,Z:F}=this,{X:I,Y:V,Z:Q}=A,D=u(P*Q),R=u(I*F),Y=u(k*Q),J=u(V*F);return D===R&&Y===J}is0(){return this.equals(x.ZERO)}negate(){return new x(u(-this.X),this.Y,this.Z,u(-this.T))}double(){const{a:A}=i,{X:P,Y:k,Z:F}=this,I=u(P*P),V=u(k*k),Q=u(p2*u(F*F)),D=u(A*I),R=P+k,Y=u(u(R*R)-I-V),J=D+V,X=J-Q,B=D-V,O=u(Y*X),L=u(J*B),K=u(Y*B),G=u(X*J);return new x(O,L,G,K)}add(A){p(A);const{a:P,d:k}=i,{X:F,Y:I,Z:V,T:Q}=this,{X:D,Y:R,Z:Y,T:J}=A,X=u(F*D),B=u(I*R),O=u(Q*k*J),L=u(V*Y),K=u((F+I)*(D+R)-X-B),G=L-O,$=L+O,j=u(B-P*X),H=u(K*G),T=u($*j),N=u(K*j),Z=u(G*$);return new x(H,T,Z,N)}subtract(A){return this.add(A.negate())}multiply(A){if(!s.isValidNot0(A))throw new Error("invalid scalar: expected 1 <= sc < curve.n");const{p:P,f:k}=S.cached(this,A,F=>eo(x,F));return eo(x,[P,k])[0]}multiplyUnsafe(A,P=x.ZERO){if(!s.isValid(A))throw new Error("invalid scalar: expected 0 <= sc < curve.n");return A===si?x.ZERO:this.is0()||A===Ot?this:S.unsafe(this,A,k=>eo(x,k),P)}isSmallOrder(){return this.multiplyUnsafe(a).is0()}isTorsionFree(){return S.unsafe(this,i.n).is0()}toAffine(A){return m(this,A)}clearCofactor(){return a===Ot?this:this.multiplyUnsafe(a)}toBytes(){const{x:A,y:P}=this.toAffine(),k=r.toBytes(P);return k[k.length-1]|=A&Ot?128:0,k}toHex(){return oo(this.toBytes())}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get ex(){return this.X}get ey(){return this.Y}get ez(){return this.Z}get et(){return this.T}static normalizeZ(A){return eo(x,A)}static msm(A,P){return Db(x,s,A,P)}_setWindowSize(A){this.precompute(A)}toRawBytes(){return this.toBytes()}}x.BASE=new x(i.Gx,i.Gy,Ot,u(i.Gx*i.Gy)),x.ZERO=new x(si,Ot,Ot,si),x.Fp=r,x.Fn=s;const S=new _b(x,s.BITS);return x.BASE.precompute(8),x}function iL(n,e,t={}){if(typeof e!="function")throw new Error('"hash" function param is required');yl(t,{},{adjustScalarBytes:"function",randomBytes:"function",domain:"function",prehash:"function",mapToCurve:"function"});const{prehash:r}=t,{BASE:s,Fp:i,Fn:a}=n,c=t.randomBytes||Po,u=t.adjustScalarBytes||(R=>R),h=t.domain||((R,Y,J)=>{if(ho(J,"phflag"),Y.length||J)throw new Error("Contexts/pre-hash are not supported");return R});function f(R){return a.create(fo(R))}function p(R){const Y=k.secretKey;R=at("private key",R,Y);const J=at("hashed private key",e(R),2*Y),X=u(J.slice(0,Y)),B=J.slice(Y,2*Y),O=f(X);return{head:X,prefix:B,scalar:O}}function m(R){const{head:Y,prefix:J,scalar:X}=p(R),B=s.multiply(X),O=B.toBytes();return{head:Y,prefix:J,scalar:X,point:B,pointBytes:O}}function w(R){return m(R).pointBytes}function x(R=Uint8Array.of(),...Y){const J=Fr(...Y);return f(e(h(J,at("context",R),!!r)))}function S(R,Y,J={}){R=at("message",R),r&&(R=r(R));const{prefix:X,scalar:B,pointBytes:O}=m(Y),L=x(J.context,X,R),K=s.multiply(L).toBytes(),G=x(J.context,K,O,R),$=a.create(L+G*B);if(!a.isValid($))throw new Error("sign failed: invalid s");const j=Fr(K,a.toBytes($));return yr(j,k.signature,"result")}const E={zip215:!0};function A(R,Y,J,X=E){const{context:B,zip215:O}=X,L=k.signature;R=at("signature",R,L),Y=at("message",Y),J=at("publicKey",J,k.publicKey),O!==void 0&&ho(O,"zip215"),r&&(Y=r(Y));const K=L/2,G=R.subarray(0,K),$=fo(R.subarray(K,L));let j,H,T;try{j=n.fromBytes(J,O),H=n.fromBytes(G,O),T=s.multiplyUnsafe($)}catch{return!1}if(!O&&j.isSmallOrder())return!1;const N=x(B,H.toBytes(),j.toBytes(),Y);return H.add(j.multiplyUnsafe(N)).subtract(T).clearCofactor().is0()}const P=i.BYTES,k={secretKey:P,publicKey:P,signature:2*P,seed:P};function F(R=c(k.seed)){return yr(R,k.seed,"seed")}function I(R){const Y=D.randomSecretKey(R);return{secretKey:Y,publicKey:w(Y)}}function V(R){return Bu(R)&&R.length===a.BYTES}function Q(R,Y){try{return!!n.fromBytes(R,Y)}catch{return!1}}const D={getExtendedPublicKey:m,randomSecretKey:F,isValidSecretKey:V,isValidPublicKey:Q,toMontgomery(R){const{y:Y}=n.fromBytes(R),J=k.publicKey,X=J===32;if(!X&&J!==57)throw new Error("only defined for 25519 and 448");const B=X?i.div(Ot+Y,Ot-Y):i.div(Y-Ot,Y+Ot);return i.toBytes(B)},toMontgomeryPriv(R){const Y=k.secretKey;yr(R,Y);const J=e(R.subarray(0,Y));return u(J).subarray(0,Y)},randomPrivateKey:F,precompute(R=8,Y=n.BASE){return Y.precompute(R,!1)}};return Object.freeze({keygen:I,getPublicKey:w,sign:S,verify:A,utils:D,Point:n,lengths:k})}function oL(n){const e={a:n.a,d:n.d,p:n.Fp.ORDER,n:n.n,h:n.h,Gx:n.Gx,Gy:n.Gy},t=n.Fp,r=To(e.n,n.nBitLength,!0),s={Fp:t,Fn:r,uvRatio:n.uvRatio},i={randomBytes:n.randomBytes,adjustScalarBytes:n.adjustScalarBytes,domain:n.domain,prehash:n.prehash,mapToCurve:n.mapToCurve};return{CURVE:e,curveOpts:s,hash:n.hash,eddsaOpts:i}}function aL(n,e){const t=e.Point;return Object.assign({},e,{ExtendedPoint:t,CURVE:n,nBitLength:t.Fn.BITS,nByteLength:t.Fn.BYTES})}function lL(n){const{CURVE:e,curveOpts:t,hash:r,eddsaOpts:s}=oL(n),i=sL(e,t),a=iL(i,r,s);return aL(n,a)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const xc=BigInt(0),fa=BigInt(1),vh=BigInt(2);function cL(n){return yl(n,{adjustScalarBytes:"function",powPminus2:"function"}),Object.freeze({...n})}function uL(n){const e=cL(n),{P:t,type:r,adjustScalarBytes:s,powPminus2:i,randomBytes:a}=e,c=r==="x25519";if(!c&&r!=="x448")throw new Error("invalid type");const u=a||Po,h=c?255:448,f=c?32:56,p=BigInt(c?9:5),m=BigInt(c?121665:39081),w=c?vh**BigInt(254):vh**BigInt(447),x=c?BigInt(8)*vh**BigInt(251)-fa:BigInt(4)*vh**BigInt(445)-fa,S=w+x+fa,E=B=>mt(B,t),A=P(p);function P(B){return Jm(E(B),f)}function k(B){const O=at("u coordinate",B,f);return c&&(O[31]&=127),E(fo(O))}function F(B){return fo(s(at("scalar",B,f)))}function I(B,O){const L=D(k(O),F(B));if(L===xc)throw new Error("invalid private or public key received");return P(L)}function V(B){return I(B,A)}function Q(B,O,L){const K=E(B*(O-L));return O=E(O-K),L=E(L+K),{x_2:O,x_3:L}}function D(B,O){nu("u",B,xc,t),nu("scalar",O,w,S);const L=O,K=B;let G=fa,$=xc,j=B,H=fa,T=xc;for(let Z=BigInt(h-1);Z>=xc;Z--){const oe=L>>Z&fa;T^=oe,{x_2:G,x_3:j}=Q(T,G,j),{x_2:$,x_3:H}=Q(T,$,H),T=oe;const ie=G+$,ae=E(ie*ie),me=G-$,ve=E(me*me),ge=ae-ve,De=j+H,At=j-H,Jr=E(At*ie),kr=E(De*me),Fo=Jr+kr,Tl=Jr-kr;j=E(Fo*Fo),H=E(K*E(Tl*Tl)),G=E(ae*ve),$=E(ge*(ae+E(m*ge)))}({x_2:G,x_3:j}=Q(T,G,j)),{x_2:$,x_3:H}=Q(T,$,H);const N=i($);return E(G*N)}const R={secretKey:f,publicKey:f,seed:f},Y=(B=u(f))=>(_s(B,R.seed),B);function J(B){const O=Y(B);return{secretKey:O,publicKey:V(O)}}return{keygen:J,getSharedSecret:(B,O)=>I(B,O),getPublicKey:B=>V(B),scalarMult:I,scalarMultBase:V,utils:{randomSecretKey:Y,randomPrivateKey:Y},GuBytes:A.slice(),lengths:R}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const dL=BigInt(1),Y8=BigInt(2),hL=BigInt(3),fL=BigInt(5),pL=BigInt(8),e3=BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffed"),Nb={p:e3,n:BigInt("0x1000000000000000000000000000000014def9dea2f79cd65812631a5cf5d3ed"),h:pL,a:BigInt("0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffec"),d:BigInt("0x52036cee2b6ffe738cc740797779e89800700a4d4141d8ab75eb4dca135978a3"),Gx:BigInt("0x216936d3cd6e53fec0a4e231fdd6dc5c692cc7609525a7b2c9562d608f25d51a"),Gy:BigInt("0x6666666666666666666666666666666666666666666666666666666666666658")};function Mb(n){const e=BigInt(10),t=BigInt(20),r=BigInt(40),s=BigInt(80),i=e3,c=n*n%i*n%i,u=ht(c,Y8,i)*c%i,h=ht(u,dL,i)*n%i,f=ht(h,fL,i)*h%i,p=ht(f,e,i)*f%i,m=ht(p,t,i)*p%i,w=ht(m,r,i)*m%i,x=ht(w,s,i)*w%i,S=ht(x,s,i)*w%i,E=ht(S,e,i)*f%i;return{pow_p_5_8:ht(E,Y8,i)*n%i,b2:c}}function Rb(n){return n[0]&=248,n[31]&=127,n[31]|=64,n}const X8=BigInt("19681161376707505956807079304988542015446066515923890162744021073123829784752");function gL(n,e){const t=e3,r=mt(e*e*e,t),s=mt(r*r*e,t),i=Mb(n*s).pow_p_5_8;let a=mt(n*r*i,t);const c=mt(e*a*a,t),u=a,h=mt(a*X8,t),f=c===n,p=c===mt(-n,t),m=c===mt(-n*X8,t);return f&&(a=u),(p||m)&&(a=h),GR(a,t)&&(a=mt(-a,t)),{isValid:f||p,value:a}}const Lb=To(Nb.p,{isLE:!0}),mL={...Nb,Fp:Lb,hash:fb,adjustScalarBytes:Rb,uvRatio:gL},ks=lL(mL),bh=(()=>{const n=Lb.ORDER;return uL({P:n,type:"x25519",powPminus2:e=>{const{pow_p_5_8:t,b2:r}=Mb(e);return mt(ht(t,hL,n)*r,n)},adjustScalarBytes:Rb})})();class J8 extends Error{constructor(e="An error occurred while verifying a message"){super(e),this.name="VerificationError"}}class yL extends Error{constructor(e="Missing Web Crypto API"){super(e),this.name="WebCryptoMissingError"}}const po={get(n=globalThis){const e=n.crypto;if(e?.subtle==null)throw new yL("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api");return e}},Ob=32,t3=64,_g=32;let _a;const Bb=(async()=>{try{return await po.get().subtle.generateKey({name:"Ed25519"},!0,["sign","verify"]),!0}catch{return!1}})();function wL(){const n=ks.utils.randomPrivateKey(),e=ks.getPublicKey(n);return{privateKey:kL(n,e),publicKey:e}}async function vL(n,e){let t;n.length===t3?t=n.subarray(0,32):t=n;const r={crv:"Ed25519",kty:"OKP",x:pe(n.subarray(32),"base64url"),d:pe(t,"base64url"),ext:!0,key_ops:["sign"]},s=await po.get().subtle.importKey("jwk",r,{name:"Ed25519"},!0,["sign"]),i=await po.get().subtle.sign({name:"Ed25519"},s,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(i,0,i.byteLength)}function bL(n,e){const t=n.subarray(0,_g);return ks.sign(e instanceof Uint8Array?e:e.subarray(),t)}async function xL(n,e){return _a==null&&(_a=await Bb),_a?vL(n,e):bL(n,e)}async function SL(n,e,t){if(n.buffer instanceof ArrayBuffer){const r=await po.get().subtle.importKey("raw",n.buffer,{name:"Ed25519"},!1,["verify"]);return await po.get().subtle.verify({name:"Ed25519"},r,e,t instanceof Uint8Array?t:t.subarray())}throw new TypeError("WebCrypto does not support SharedArrayBuffer for Ed25519 keys")}function EL(n,e,t){return ks.verify(e,t instanceof Uint8Array?t:t.subarray(),n)}async function CL(n,e,t){return _a==null&&(_a=await Bb),_a?SL(n,e,t):EL(n,e,t)}function kL(n,e){const t=new Uint8Array(t3);for(let r=0;r<_g;r++)t[r]=n[r],t[_g+r]=e[r];return t}function n3(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}let Fb=class{type="Ed25519";raw;constructor(e){this.raw=r3(e,Ob)}toMultihash(){return xr.digest(ws(this))}toCID(){return Be.createV1(114,this.toMultihash())}toString(){return bt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Ve(this.raw,e.raw)}verify(e,t,r){r?.signal?.throwIfAborted();const s=CL(this.raw,t,e);return n3(s)?s.then(i=>(r?.signal?.throwIfAborted(),i)):s}},AL=class{type="Ed25519";raw;publicKey;constructor(e,t){this.raw=r3(e,t3),this.publicKey=new Fb(t)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Ve(this.raw,e.raw)}sign(e,t){t?.signal?.throwIfAborted();const r=xL(this.raw,e);return n3(r)?r.then(s=>(t?.signal?.throwIfAborted(),s)):(t?.signal?.throwIfAborted(),r)}};function Ub(n){return n=r3(n,Ob),new Fb(n)}async function PL(){const{privateKey:n,publicKey:e}=wL();return new AL(n,e)}function r3(n,e){if(n=Uint8Array.from(n??[]),n.length!==e)throw new Ae(`Key must be a Uint8Array of length ${e}, got ${n.length}`);return n}const TL=Math.pow(2,7),_L=Math.pow(2,14),DL=Math.pow(2,21),s3=Math.pow(2,28),i3=Math.pow(2,35),o3=Math.pow(2,42),a3=Math.pow(2,49),je=128,rn=127;function Ft(n){if(n<TL)return 1;if(n<_L)return 2;if(n<DL)return 3;if(n<s3)return 4;if(n<i3)return 5;if(n<o3)return 6;if(n<a3)return 7;if(Number.MAX_SAFE_INTEGER!=null&&n>Number.MAX_SAFE_INTEGER)throw new RangeError("Could not encode varint");return 8}function yf(n,e,t=0){switch(Ft(n)){case 8:e[t++]=n&255|je,n/=128;case 7:e[t++]=n&255|je,n/=128;case 6:e[t++]=n&255|je,n/=128;case 5:e[t++]=n&255|je,n/=128;case 4:e[t++]=n&255|je,n>>>=7;case 3:e[t++]=n&255|je,n>>>=7;case 2:e[t++]=n&255|je,n>>>=7;case 1:{e[t++]=n&255,n>>>=7;break}default:throw new Error("unreachable")}return e}function IL(n,e,t=0){switch(Ft(n)){case 8:e.set(t++,n&255|je),n/=128;case 7:e.set(t++,n&255|je),n/=128;case 6:e.set(t++,n&255|je),n/=128;case 5:e.set(t++,n&255|je),n/=128;case 4:e.set(t++,n&255|je),n>>>=7;case 3:e.set(t++,n&255|je),n>>>=7;case 2:e.set(t++,n&255|je),n>>>=7;case 1:{e.set(t++,n&255),n>>>=7;break}default:throw new Error("unreachable")}return e}function Vb(n,e){let t=n[e],r=0;if(r+=t&rn,t<je||(t=n[e+1],r+=(t&rn)<<7,t<je)||(t=n[e+2],r+=(t&rn)<<14,t<je)||(t=n[e+3],r+=(t&rn)<<21,t<je)||(t=n[e+4],r+=(t&rn)*s3,t<je)||(t=n[e+5],r+=(t&rn)*i3,t<je)||(t=n[e+6],r+=(t&rn)*o3,t<je)||(t=n[e+7],r+=(t&rn)*a3,t<je))return r;throw new RangeError("Could not decode varint")}function NL(n,e){let t=n.get(e),r=0;if(r+=t&rn,t<je||(t=n.get(e+1),r+=(t&rn)<<7,t<je)||(t=n.get(e+2),r+=(t&rn)<<14,t<je)||(t=n.get(e+3),r+=(t&rn)<<21,t<je)||(t=n.get(e+4),r+=(t&rn)*s3,t<je)||(t=n.get(e+5),r+=(t&rn)*i3,t<je)||(t=n.get(e+6),r+=(t&rn)*o3,t<je)||(t=n.get(e+7),r+=(t&rn)*a3,t<je))return r;throw new RangeError("Could not decode varint")}function mi(n,e,t=0){return e==null&&(e=Sr(Ft(n))),e instanceof Uint8Array?yf(n,e,t):IL(n,e,t)}function _o(n,e=0){return n instanceof Uint8Array?Vb(n,e):NL(n,e)}const l3=new Float32Array([-0]),ui=new Uint8Array(l3.buffer);function ML(n,e,t){l3[0]=n,e[t]=ui[0],e[t+1]=ui[1],e[t+2]=ui[2],e[t+3]=ui[3]}function RL(n,e){return ui[0]=n[e],ui[1]=n[e+1],ui[2]=n[e+2],ui[3]=n[e+3],l3[0]}const c3=new Float64Array([-0]),sn=new Uint8Array(c3.buffer);function LL(n,e,t){c3[0]=n,e[t]=sn[0],e[t+1]=sn[1],e[t+2]=sn[2],e[t+3]=sn[3],e[t+4]=sn[4],e[t+5]=sn[5],e[t+6]=sn[6],e[t+7]=sn[7]}function OL(n,e){return sn[0]=n[e],sn[1]=n[e+1],sn[2]=n[e+2],sn[3]=n[e+3],sn[4]=n[e+4],sn[5]=n[e+5],sn[6]=n[e+6],sn[7]=n[e+7],c3[0]}const BL=BigInt(Number.MAX_SAFE_INTEGER),FL=BigInt(Number.MIN_SAFE_INTEGER);class on{lo;hi;constructor(e,t){this.lo=e|0,this.hi=t|0}toNumber(e=!1){if(!e&&this.hi>>>31>0){const t=~this.lo+1>>>0;let r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(t+r*4294967296)}return this.lo+this.hi*4294967296}toBigInt(e=!1){if(e)return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n);if(this.hi>>>31){const t=~this.lo+1>>>0;let r=~this.hi>>>0;return t===0&&(r=r+1>>>0),-(BigInt(t)+(BigInt(r)<<32n))}return BigInt(this.lo>>>0)+(BigInt(this.hi>>>0)<<32n)}toString(e=!1){return this.toBigInt(e).toString()}zzEncode(){const e=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^e)>>>0,this.lo=(this.lo<<1^e)>>>0,this}zzDecode(){const e=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^e)>>>0,this.hi=(this.hi>>>1^e)>>>0,this}length(){const e=this.lo,t=(this.lo>>>28|this.hi<<4)>>>0,r=this.hi>>>24;return r===0?t===0?e<16384?e<128?1:2:e<2097152?3:4:t<16384?t<128?5:6:t<2097152?7:8:r<128?9:10}static fromBigInt(e){if(e===0n)return ao;if(e<BL&&e>FL)return this.fromNumber(Number(e));const t=e<0n;t&&(e=-e);let r=e>>32n,s=e-(r<<32n);return t&&(r=~r|0n,s=~s|0n,++s>Z8&&(s=0n,++r>Z8&&(r=0n))),new on(Number(s),Number(r))}static fromNumber(e){if(e===0)return ao;const t=e<0;t&&(e=-e);let r=e>>>0,s=(e-r)/4294967296>>>0;return t&&(s=~s>>>0,r=~r>>>0,++r>4294967295&&(r=0,++s>4294967295&&(s=0))),new on(r,s)}static from(e){return typeof e=="number"?on.fromNumber(e):typeof e=="bigint"?on.fromBigInt(e):typeof e=="string"?on.fromBigInt(BigInt(e)):e.low!=null||e.high!=null?new on(e.low>>>0,e.high>>>0):ao}}const ao=new on(0,0);ao.toBigInt=function(){return 0n};ao.zzEncode=ao.zzDecode=function(){return this};ao.length=function(){return 1};const Z8=4294967296n;function UL(n){let e=0,t=0;for(let r=0;r<n.length;++r)t=n.charCodeAt(r),t<128?e+=1:t<2048?e+=2:(t&64512)===55296&&(n.charCodeAt(r+1)&64512)===56320?(++r,e+=4):e+=3;return e}function VL(n,e,t){if(t-e<1)return"";let s;const i=[];let a=0,c;for(;e<t;)c=n[e++],c<128?i[a++]=c:c>191&&c<224?i[a++]=(c&31)<<6|n[e++]&63:c>239&&c<365?(c=((c&7)<<18|(n[e++]&63)<<12|(n[e++]&63)<<6|n[e++]&63)-65536,i[a++]=55296+(c>>10),i[a++]=56320+(c&1023)):i[a++]=(c&15)<<12|(n[e++]&63)<<6|n[e++]&63,a>8191&&((s??(s=[])).push(String.fromCharCode.apply(String,i)),a=0);return s!=null?(a>0&&s.push(String.fromCharCode.apply(String,i.slice(0,a))),s.join("")):String.fromCharCode.apply(String,i.slice(0,a))}function jb(n,e,t){const r=t;let s,i;for(let a=0;a<n.length;++a)s=n.charCodeAt(a),s<128?e[t++]=s:s<2048?(e[t++]=s>>6|192,e[t++]=s&63|128):(s&64512)===55296&&((i=n.charCodeAt(a+1))&64512)===56320?(s=65536+((s&1023)<<10)+(i&1023),++a,e[t++]=s>>18|240,e[t++]=s>>12&63|128,e[t++]=s>>6&63|128,e[t++]=s&63|128):(e[t++]=s>>12|224,e[t++]=s>>6&63|128,e[t++]=s&63|128);return t-r}function hr(n,e){return RangeError(`index out of range: ${n.pos} + ${e??1} > ${n.len}`)}function xh(n,e){return(n[e-4]|n[e-3]<<8|n[e-2]<<16|n[e-1]<<24)>>>0}class jL{buf;pos;len;_slice=Uint8Array.prototype.subarray;constructor(e){this.buf=e,this.pos=0,this.len=e.length}uint32(){let e=4294967295;if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,hr(this,10);return e}int32(){return this.uint32()|0}sint32(){const e=this.uint32();return e>>>1^-(e&1)|0}bool(){return this.uint32()!==0}fixed32(){if(this.pos+4>this.len)throw hr(this,4);return xh(this.buf,this.pos+=4)}sfixed32(){if(this.pos+4>this.len)throw hr(this,4);return xh(this.buf,this.pos+=4)|0}float(){if(this.pos+4>this.len)throw hr(this,4);const e=RL(this.buf,this.pos);return this.pos+=4,e}double(){if(this.pos+8>this.len)throw hr(this,4);const e=OL(this.buf,this.pos);return this.pos+=8,e}bytes(){const e=this.uint32(),t=this.pos,r=this.pos+e;if(r>this.len)throw hr(this,e);return this.pos+=e,t===r?new Uint8Array(0):this.buf.subarray(t,r)}string(){const e=this.bytes();return VL(e,0,e.length)}skip(e){if(typeof e=="number"){if(this.pos+e>this.len)throw hr(this,e);this.pos+=e}else do if(this.pos>=this.len)throw hr(this);while((this.buf[this.pos++]&128)!==0);return this}skipType(e){switch(e){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(e=this.uint32()&7)!==4;)this.skipType(e);break;case 5:this.skip(4);break;default:throw Error(`invalid wire type ${e} at offset ${this.pos}`)}return this}readLongVarint(){const e=new on(0,0);let t=0;if(this.len-this.pos>4){for(;t<4;++t)if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e;if(e.lo=(e.lo|(this.buf[this.pos]&127)<<28)>>>0,e.hi=(e.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return e;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw hr(this);if(e.lo=(e.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return e}return e.lo=(e.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,e}if(this.len-this.pos>4){for(;t<5;++t)if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}else for(;t<5;++t){if(this.pos>=this.len)throw hr(this);if(e.hi=(e.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return e}throw Error("invalid varint encoding")}readFixed64(){if(this.pos+8>this.len)throw hr(this,8);const e=xh(this.buf,this.pos+=4),t=xh(this.buf,this.pos+=4);return new on(e,t)}int64(){return this.readLongVarint().toBigInt()}int64Number(){return this.readLongVarint().toNumber()}int64String(){return this.readLongVarint().toString()}uint64(){return this.readLongVarint().toBigInt(!0)}uint64Number(){const e=Vb(this.buf,this.pos);return this.pos+=Ft(e),e}uint64String(){return this.readLongVarint().toString(!0)}sint64(){return this.readLongVarint().zzDecode().toBigInt()}sint64Number(){return this.readLongVarint().zzDecode().toNumber()}sint64String(){return this.readLongVarint().zzDecode().toString()}fixed64(){return this.readFixed64().toBigInt()}fixed64Number(){return this.readFixed64().toNumber()}fixed64String(){return this.readFixed64().toString()}sfixed64(){return this.readFixed64().toBigInt()}sfixed64Number(){return this.readFixed64().toNumber()}sfixed64String(){return this.readFixed64().toString()}}function $L(n){return new jL(n instanceof Uint8Array?n:n.subarray())}function We(n,e,t){const r=$L(n);return e.decode(r,void 0,t)}function zL(n){let r,s=8192;return function(a){if(a<1||a>4096)return Sr(a);s+a>8192&&(r=Sr(8192),s=0);const c=r.subarray(s,s+=a);return(s&7)!==0&&(s=(s|7)+1),c}}class Tc{fn;len;next;val;constructor(e,t,r){this.fn=e,this.len=t,this.next=void 0,this.val=r}}function g2(){}class HL{head;tail;len;next;constructor(e){this.head=e.head,this.tail=e.tail,this.len=e.len,this.next=e.states}}const KL=zL();function qL(n){return globalThis.Buffer!=null?Sr(n):KL(n)}class Dg{len;head;tail;states;constructor(){this.len=0,this.head=new Tc(g2,0,0),this.tail=this.head,this.states=null}_push(e,t,r){return this.tail=this.tail.next=new Tc(e,t,r),this.len+=t,this}uint32(e){return this.len+=(this.tail=this.tail.next=new GL((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this}int32(e){return e<0?this._push(Sh,10,on.fromNumber(e)):this.uint32(e)}sint32(e){return this.uint32((e<<1^e>>31)>>>0)}uint64(e){const t=on.fromBigInt(e);return this._push(Sh,t.length(),t)}uint64Number(e){return this._push(yf,Ft(e),e)}uint64String(e){return this.uint64(BigInt(e))}int64(e){return this.uint64(e)}int64Number(e){return this.uint64Number(e)}int64String(e){return this.uint64String(e)}sint64(e){const t=on.fromBigInt(e).zzEncode();return this._push(Sh,t.length(),t)}sint64Number(e){const t=on.fromNumber(e).zzEncode();return this._push(Sh,t.length(),t)}sint64String(e){return this.sint64(BigInt(e))}bool(e){return this._push(m2,1,e?1:0)}fixed32(e){return this._push(Sc,4,e>>>0)}sfixed32(e){return this.fixed32(e)}fixed64(e){const t=on.fromBigInt(e);return this._push(Sc,4,t.lo)._push(Sc,4,t.hi)}fixed64Number(e){const t=on.fromNumber(e);return this._push(Sc,4,t.lo)._push(Sc,4,t.hi)}fixed64String(e){return this.fixed64(BigInt(e))}sfixed64(e){return this.fixed64(e)}sfixed64Number(e){return this.fixed64Number(e)}sfixed64String(e){return this.fixed64String(e)}float(e){return this._push(ML,4,e)}double(e){return this._push(LL,8,e)}bytes(e){const t=e.length>>>0;return t===0?this._push(m2,1,0):this.uint32(t)._push(QL,t,e)}string(e){const t=UL(e);return t!==0?this.uint32(t)._push(jb,t,e):this._push(m2,1,0)}fork(){return this.states=new HL(this),this.head=this.tail=new Tc(g2,0,0),this.len=0,this}reset(){return this.states!=null?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Tc(g2,0,0),this.len=0),this}ldelim(){const e=this.head,t=this.tail,r=this.len;return this.reset().uint32(r),r!==0&&(this.tail.next=e.next,this.tail=t,this.len+=r),this}finish(){let e=this.head.next;const t=qL(this.len);let r=0;for(;e!=null;)e.fn(e.val,t,r),r+=e.len,e=e.next;return t}}function m2(n,e,t){e[t]=n&255}function WL(n,e,t){for(;n>127;)e[t++]=n&127|128,n>>>=7;e[t]=n}class GL extends Tc{next;constructor(e,t){super(WL,e,t),this.next=void 0}}function Sh(n,e,t){for(;n.hi!==0;)e[t++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)e[t++]=n.lo&127|128,n.lo=n.lo>>>7;e[t++]=n.lo}function Sc(n,e,t){e[t]=n&255,e[t+1]=n>>>8&255,e[t+2]=n>>>16&255,e[t+3]=n>>>24}function QL(n,e,t){e.set(n,t)}globalThis.Buffer!=null&&(Dg.prototype.bytes=function(n){const e=n.length>>>0;return this.uint32(e),e>0&&this._push(YL,e,n),this},Dg.prototype.string=function(n){const e=globalThis.Buffer.byteLength(n);return this.uint32(e),e>0&&this._push(XL,e,n),this});function YL(n,e,t){e.set(n,t)}function XL(n,e,t){n.length<40?jb(n,e,t):e.utf8Write!=null?e.utf8Write(n,t):e.set(we(n),t)}function JL(){return new Dg}function Ge(n,e){const t=JL();return e.encode(n,t,{lengthDelimited:!1}),t.finish()}var wf;(function(n){n[n.VARINT=0]="VARINT",n[n.BIT64=1]="BIT64",n[n.LENGTH_DELIMITED=2]="LENGTH_DELIMITED",n[n.START_GROUP=3]="START_GROUP",n[n.END_GROUP=4]="END_GROUP",n[n.BIT32=5]="BIT32"})(wf||(wf={}));function $b(n,e,t,r){return{name:n,type:e,encode:t,decode:r}}function Ds(n){function e(s){if(n[s.toString()]==null)throw new Error("Invalid enum value");return n[s]}const t=function(i,a){const c=e(i);a.int32(c)},r=function(i){const a=i.int32();return e(a)};return $b("enum",wf.VARINT,t,r)}function Qe(n,e){return $b("message",wf.LENGTH_DELIMITED,n,e)}class qr extends Error{code="ERR_MAX_LENGTH";name="MaxLengthError"}class e7 extends Error{code="ERR_MAX_SIZE";name="MaxSizeError"}var qt;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.secp256k1="secp256k1",n.ECDSA="ECDSA"})(qt||(qt={}));var Ig;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.secp256k1=2]="secp256k1",n[n.ECDSA=3]="ECDSA"})(Ig||(Ig={}));(function(n){n.codec=()=>Ds(Ig)})(qt||(qt={}));var Ha;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),qt.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.Type=qt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Ha||(Ha={}));var t7;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),qt.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.Type=qt.codec().decode(t);break}case 2:{i.Data=t.bytes();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(t7||(t7={}));function w1(n){if(isNaN(n)||n<=0)throw new Ae("random bytes length must be a Number bigger than 0");return Po(n)}const Da=hb;class ZL{type="RSA";jwk;_raw;_multihash;constructor(e,t){this.jwk=e,this._multihash=t}get raw(){return this._raw==null&&(this._raw=sO(this.jwk)),this._raw}toMultihash(){return this._multihash}toCID(){return Be.createV1(114,this._multihash)}toString(){return bt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Ve(this.raw,e.raw)}verify(e,t,r){return aO(this.jwk,t,e,r)}}const eO=18,tO=1062,nO=Uint8Array.from([48,13,6,9,42,134,72,134,247,13,1,1,1,5,0]);function rO(n){const e=m1(n[1],{offset:0});return{kty:"RSA",n:pe(e[0],"base64url"),e:pe(e[1],"base64url")}}function sO(n){if(n.n==null||n.e==null)throw new Ae("JWK was missing components");return Uc([nO,sb(Uc([Pg(we(n.n,"base64url")),Pg(we(n.e,"base64url"))]))]).subarray()}function iO(n,e){if(n.byteLength>=tO)throw new lf("Key size is too large");const t=m1(n,{offset:0});return oO(t,n,e)}function oO(n,e,t){const r=rO(n);if(t==null){const s=Da(Ha.encode({Type:qt.RSA,Data:e}));t=$a(eO,s)}return new ZL(r,t)}async function aO(n,e,t,r){const s=await po.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);r?.signal?.throwIfAborted();const i=await po.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},s,e,t instanceof Uint8Array?t:t.subarray());return r?.signal?.throwIfAborted(),i}class zb extends lb{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,Fu(e);const r=tu(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,i=new Uint8Array(s);i.set(r.length>s?e.create().update(r).digest():r);for(let a=0;a<i.length;a++)i[a]^=54;this.iHash.update(i),this.oHash=e.create();for(let a=0;a<i.length;a++)i[a]^=106;this.oHash.update(i),Ei(i)}update(e){return ff(this),this.iHash.update(e),this}digestInto(e){ff(this),_s(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:r,finished:s,destroyed:i,blockLen:a,outputLen:c}=this;return e=e,e.finished=s,e.destroyed=i,e.blockLen=a,e.outputLen=c,e.oHash=t._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const Vu=(n,e,t)=>new zb(n,e).update(t).digest();Vu.create=(n,e)=>new zb(n,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const n7=(n,e)=>(n+(n>=0?e:-e)/Hb)/e;function lO(n,e,t){const[[r,s],[i,a]]=e,c=n7(a*n,t),u=n7(-s*n,t);let h=n-c*r-u*i,f=-c*s-u*a;const p=h<gs,m=f<gs;p&&(h=-h),m&&(f=-f);const w=Uu(Math.ceil(gb(t)/2))+Ia;if(h<gs||h>=w||f<gs||f>=w)throw new Error("splitScalar (endomorphism): failed, k="+n);return{k1neg:p,k1:h,k2neg:m,k2:f}}function Ng(n){if(!["compact","recovered","der"].includes(n))throw new Error('Signature format must be "compact", "recovered", or "der"');return n}function y2(n,e){const t={};for(let r of Object.keys(e))t[r]=n[r]===void 0?e[r]:n[r];return ho(t.lowS,"lowS"),ho(t.prehash,"prehash"),t.format!==void 0&&Ng(t.format),t}class cO extends Error{constructor(e=""){super(e)}}const fs={Err:cO,_tlv:{encode:(n,e)=>{const{Err:t}=fs;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length&1)throw new t("tlv.encode: unpadded data");const r=e.length/2,s=wh(r);if(s.length/2&128)throw new t("tlv.encode: long form length too big");const i=r>127?wh(s.length/2|128):"";return wh(n)+i+s+e},decode(n,e){const{Err:t}=fs;let r=0;if(n<0||n>256)throw new t("tlv.encode: wrong tag");if(e.length<2||e[r++]!==n)throw new t("tlv.decode: wrong tlv");const s=e[r++],i=!!(s&128);let a=0;if(!i)a=s;else{const u=s&127;if(!u)throw new t("tlv.decode(long): indefinite length not supported");if(u>4)throw new t("tlv.decode(long): byte length is too big");const h=e.subarray(r,r+u);if(h.length!==u)throw new t("tlv.decode: length bytes not complete");if(h[0]===0)throw new t("tlv.decode(long): zero leftmost byte");for(const f of h)a=a<<8|f;if(r+=u,a<128)throw new t("tlv.decode(long): not minimal encoding")}const c=e.subarray(r,r+a);if(c.length!==a)throw new t("tlv.decode: wrong value length");return{v:c,l:e.subarray(r+a)}}},_int:{encode(n){const{Err:e}=fs;if(n<gs)throw new e("integer: negative integers are not allowed");let t=wh(n);if(Number.parseInt(t[0],16)&8&&(t="00"+t),t.length&1)throw new e("unexpected DER parsing assertion: unpadded hex");return t},decode(n){const{Err:e}=fs;if(n[0]&128)throw new e("invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("invalid signature integer: unnecessary leading zero");return y1(n)}},toSig(n){const{Err:e,_int:t,_tlv:r}=fs,s=at("signature",n),{v:i,l:a}=r.decode(48,s);if(a.length)throw new e("invalid signature: left bytes after parsing");const{v:c,l:u}=r.decode(2,i),{v:h,l:f}=r.decode(2,u);if(f.length)throw new e("invalid signature: left bytes after parsing");return{r:t.decode(c),s:t.decode(h)}},hexFromSig(n){const{_tlv:e,_int:t}=fs,r=e.encode(2,t.encode(n.r)),s=e.encode(2,t.encode(n.s)),i=r+s;return e.encode(48,i)}},gs=BigInt(0),Ia=BigInt(1),Hb=BigInt(2),Eh=BigInt(3),uO=BigInt(4);function Ea(n,e){const{BYTES:t}=n;let r;if(typeof e=="bigint")r=e;else{let s=at("private key",e);try{r=n.fromBytes(s)}catch{throw new Error(`invalid private key: expected ui8a of size ${t}, got ${typeof e}`)}}if(!n.isValidNot0(r))throw new Error("invalid private key: out of range [1..N-1]");return r}function dO(n,e={}){const t=Ib("weierstrass",n,e),{Fp:r,Fn:s}=t;let i=t.CURVE;const{h:a,n:c}=i;yl(e,{},{allowInfinityPoint:"boolean",clearCofactor:"function",isTorsionFree:"function",fromBytes:"function",toBytes:"function",endo:"object",wrapPrivateKey:"boolean"});const{endo:u}=e;if(u&&(!r.is0(i.a)||typeof u.beta!="bigint"||!Array.isArray(u.basises)))throw new Error('invalid endo: expected "beta": bigint and "basises": array');const h=qb(r,s);function f(){if(!r.isOdd)throw new Error("compression is not supported: Field does not have .isOdd()")}function p(X,B,O){const{x:L,y:K}=B.toAffine(),G=r.toBytes(L);if(ho(O,"isCompressed"),O){f();const $=!r.isOdd(K);return Fr(Kb($),G)}else return Fr(Uint8Array.of(4),G,r.toBytes(K))}function m(X){yr(X,void 0,"Point");const{publicKey:B,publicKeyUncompressed:O}=h,L=X.length,K=X[0],G=X.subarray(1);if(L===B&&(K===2||K===3)){const $=r.fromBytes(G);if(!r.isValid($))throw new Error("bad point: is not on curve, wrong x");const j=S($);let H;try{H=r.sqrt(j)}catch(Z){const oe=Z instanceof Error?": "+Z.message:"";throw new Error("bad point: is not on curve, sqrt error"+oe)}f();const T=r.isOdd(H);return(K&1)===1!==T&&(H=r.neg(H)),{x:$,y:H}}else if(L===O&&K===4){const $=r.BYTES,j=r.fromBytes(G.subarray(0,$)),H=r.fromBytes(G.subarray($,$*2));if(!E(j,H))throw new Error("bad point: is not on curve");return{x:j,y:H}}else throw new Error(`bad point: got length ${L}, expected compressed=${B} or uncompressed=${O}`)}const w=e.toBytes||p,x=e.fromBytes||m;function S(X){const B=r.sqr(X),O=r.mul(B,X);return r.add(r.add(O,r.mul(X,i.a)),i.b)}function E(X,B){const O=r.sqr(B),L=S(X);return r.eql(O,L)}if(!E(i.Gx,i.Gy))throw new Error("bad curve params: generator point");const A=r.mul(r.pow(i.a,Eh),uO),P=r.mul(r.sqr(i.b),BigInt(27));if(r.is0(r.add(A,P)))throw new Error("bad curve params: a or b");function k(X,B,O=!1){if(!r.isValid(B)||O&&r.is0(B))throw new Error(`bad point coordinate ${X}`);return B}function F(X){if(!(X instanceof R))throw new Error("ProjectivePoint expected")}function I(X){if(!u||!u.basises)throw new Error("no endo");return lO(X,u.basises,s.ORDER)}const V=gf((X,B)=>{const{X:O,Y:L,Z:K}=X;if(r.eql(K,r.ONE))return{x:O,y:L};const G=X.is0();B==null&&(B=G?r.ONE:r.inv(K));const $=r.mul(O,B),j=r.mul(L,B),H=r.mul(K,B);if(G)return{x:r.ZERO,y:r.ZERO};if(!r.eql(H,r.ONE))throw new Error("invZ was invalid");return{x:$,y:j}}),Q=gf(X=>{if(X.is0()){if(e.allowInfinityPoint&&!r.is0(X.Y))return;throw new Error("bad point: ZERO")}const{x:B,y:O}=X.toAffine();if(!r.isValid(B)||!r.isValid(O))throw new Error("bad point: x or y not field elements");if(!E(B,O))throw new Error("bad point: equation left != right");if(!X.isTorsionFree())throw new Error("bad point: not in prime-order subgroup");return!0});function D(X,B,O,L,K){return O=new R(r.mul(O.X,X),O.Y,O.Z),B=mf(L,B),O=mf(K,O),B.add(O)}class R{constructor(B,O,L){this.X=k("x",B),this.Y=k("y",O,!0),this.Z=k("z",L),Object.freeze(this)}static CURVE(){return i}static fromAffine(B){const{x:O,y:L}=B||{};if(!B||!r.isValid(O)||!r.isValid(L))throw new Error("invalid affine point");if(B instanceof R)throw new Error("projective point not allowed");return r.is0(O)&&r.is0(L)?R.ZERO:new R(O,L,r.ONE)}static fromBytes(B){const O=R.fromAffine(x(yr(B,void 0,"point")));return O.assertValidity(),O}static fromHex(B){return R.fromBytes(at("pointHex",B))}get x(){return this.toAffine().x}get y(){return this.toAffine().y}precompute(B=8,O=!0){return J.createCache(this,B),O||this.multiply(Eh),this}assertValidity(){Q(this)}hasEvenY(){const{y:B}=this.toAffine();if(!r.isOdd)throw new Error("Field doesn't support isOdd");return!r.isOdd(B)}equals(B){F(B);const{X:O,Y:L,Z:K}=this,{X:G,Y:$,Z:j}=B,H=r.eql(r.mul(O,j),r.mul(G,K)),T=r.eql(r.mul(L,j),r.mul($,K));return H&&T}negate(){return new R(this.X,r.neg(this.Y),this.Z)}double(){const{a:B,b:O}=i,L=r.mul(O,Eh),{X:K,Y:G,Z:$}=this;let j=r.ZERO,H=r.ZERO,T=r.ZERO,N=r.mul(K,K),Z=r.mul(G,G),oe=r.mul($,$),ie=r.mul(K,G);return ie=r.add(ie,ie),T=r.mul(K,$),T=r.add(T,T),j=r.mul(B,T),H=r.mul(L,oe),H=r.add(j,H),j=r.sub(Z,H),H=r.add(Z,H),H=r.mul(j,H),j=r.mul(ie,j),T=r.mul(L,T),oe=r.mul(B,oe),ie=r.sub(N,oe),ie=r.mul(B,ie),ie=r.add(ie,T),T=r.add(N,N),N=r.add(T,N),N=r.add(N,oe),N=r.mul(N,ie),H=r.add(H,N),oe=r.mul(G,$),oe=r.add(oe,oe),N=r.mul(oe,ie),j=r.sub(j,N),T=r.mul(oe,Z),T=r.add(T,T),T=r.add(T,T),new R(j,H,T)}add(B){F(B);const{X:O,Y:L,Z:K}=this,{X:G,Y:$,Z:j}=B;let H=r.ZERO,T=r.ZERO,N=r.ZERO;const Z=i.a,oe=r.mul(i.b,Eh);let ie=r.mul(O,G),ae=r.mul(L,$),me=r.mul(K,j),ve=r.add(O,L),ge=r.add(G,$);ve=r.mul(ve,ge),ge=r.add(ie,ae),ve=r.sub(ve,ge),ge=r.add(O,K);let De=r.add(G,j);return ge=r.mul(ge,De),De=r.add(ie,me),ge=r.sub(ge,De),De=r.add(L,K),H=r.add($,j),De=r.mul(De,H),H=r.add(ae,me),De=r.sub(De,H),N=r.mul(Z,ge),H=r.mul(oe,me),N=r.add(H,N),H=r.sub(ae,N),N=r.add(ae,N),T=r.mul(H,N),ae=r.add(ie,ie),ae=r.add(ae,ie),me=r.mul(Z,me),ge=r.mul(oe,ge),ae=r.add(ae,me),me=r.sub(ie,me),me=r.mul(Z,me),ge=r.add(ge,me),ie=r.mul(ae,ge),T=r.add(T,ie),ie=r.mul(De,ge),H=r.mul(ve,H),H=r.sub(H,ie),ie=r.mul(ve,ae),N=r.mul(De,N),N=r.add(N,ie),new R(H,T,N)}subtract(B){return this.add(B.negate())}is0(){return this.equals(R.ZERO)}multiply(B){const{endo:O}=e;if(!s.isValidNot0(B))throw new Error("invalid scalar: out of range");let L,K;const G=$=>J.cached(this,$,j=>eo(R,j));if(O){const{k1neg:$,k1:j,k2neg:H,k2:T}=I(B),{p:N,f:Z}=G(j),{p:oe,f:ie}=G(T);K=Z.add(ie),L=D(O.beta,N,oe,$,H)}else{const{p:$,f:j}=G(B);L=$,K=j}return eo(R,[L,K])[0]}multiplyUnsafe(B){const{endo:O}=e,L=this;if(!s.isValid(B))throw new Error("invalid scalar: out of range");if(B===gs||L.is0())return R.ZERO;if(B===Ia)return L;if(J.hasCache(this))return this.multiply(B);if(O){const{k1neg:K,k1:G,k2neg:$,k2:j}=I(B),{p1:H,p2:T}=tL(R,L,G,j);return D(O.beta,H,T,K,$)}else return J.unsafe(L,B)}multiplyAndAddUnsafe(B,O,L){const K=this.multiplyUnsafe(O).add(B.multiplyUnsafe(L));return K.is0()?void 0:K}toAffine(B){return V(this,B)}isTorsionFree(){const{isTorsionFree:B}=e;return a===Ia?!0:B?B(R,this):J.unsafe(this,c).is0()}clearCofactor(){const{clearCofactor:B}=e;return a===Ia?this:B?B(R,this):this.multiplyUnsafe(a)}isSmallOrder(){return this.multiplyUnsafe(a).is0()}toBytes(B=!0){return ho(B,"isCompressed"),this.assertValidity(),w(R,this,B)}toHex(B=!0){return oo(this.toBytes(B))}toString(){return`<Point ${this.is0()?"ZERO":this.toHex()}>`}get px(){return this.X}get py(){return this.X}get pz(){return this.Z}toRawBytes(B=!0){return this.toBytes(B)}_setWindowSize(B){this.precompute(B)}static normalizeZ(B){return eo(R,B)}static msm(B,O){return Db(R,s,B,O)}static fromPrivateKey(B){return R.BASE.multiply(Ea(s,B))}}R.BASE=new R(i.Gx,i.Gy,r.ONE),R.ZERO=new R(r.ZERO,r.ONE,r.ZERO),R.Fp=r,R.Fn=s;const Y=s.BITS,J=new _b(R,e.endo?Math.ceil(Y/2):Y);return R.BASE.precompute(8),R}function Kb(n){return Uint8Array.of(n?2:3)}function qb(n,e){return{secretKey:e.BYTES,publicKey:1+n.BYTES,publicKeyUncompressed:1+2*n.BYTES,publicKeyHasPrefix:!0,signature:2*e.BYTES}}function hO(n,e={}){const{Fn:t}=n,r=e.randomBytes||Po,s=Object.assign(qb(n.Fp,t),{seed:Ab(t.ORDER)});function i(w){try{return!!Ea(t,w)}catch{return!1}}function a(w,x){const{publicKey:S,publicKeyUncompressed:E}=s;try{const A=w.length;return x===!0&&A!==S||x===!1&&A!==E?!1:!!n.fromBytes(w)}catch{return!1}}function c(w=r(s.seed)){return JR(yr(w,s.seed,"seed"),t.ORDER)}function u(w,x=!0){return n.BASE.multiply(Ea(t,w)).toBytes(x)}function h(w){const x=c(w);return{secretKey:x,publicKey:u(x)}}function f(w){if(typeof w=="bigint")return!1;if(w instanceof n)return!0;const{secretKey:x,publicKey:S,publicKeyUncompressed:E}=s;if(t.allowedLengths||x===S)return;const A=at("key",w).length;return A===S||A===E}function p(w,x,S=!0){if(f(w)===!0)throw new Error("first arg must be private key");if(f(x)===!1)throw new Error("second arg must be public key");const E=Ea(t,w);return n.fromHex(x).multiply(E).toBytes(S)}return Object.freeze({getPublicKey:u,getSharedSecret:p,keygen:h,Point:n,utils:{isValidSecretKey:i,isValidPublicKey:a,randomSecretKey:c,isValidPrivateKey:i,randomPrivateKey:c,normPrivateKeyToScalar:w=>Ea(t,w),precompute(w=8,x=n.BASE){return x.precompute(w,!1)}},lengths:s})}function fO(n,e,t={}){Fu(e),yl(t,{},{hmac:"function",lowS:"boolean",randomBytes:"function",bits2int:"function",bits2int_modN:"function"});const r=t.randomBytes||Po,s=t.hmac||((O,...L)=>Vu(e,O,Fr(...L))),{Fp:i,Fn:a}=n,{ORDER:c,BITS:u}=a,{keygen:h,getPublicKey:f,getSharedSecret:p,utils:m,lengths:w}=hO(n,t),x={prehash:!1,lowS:typeof t.lowS=="boolean"?t.lowS:!1,format:void 0,extraEntropy:!1},S="compact";function E(O){const L=c>>Ia;return O>L}function A(O,L){if(!a.isValidNot0(L))throw new Error(`invalid signature ${O}: out of range 1..Point.Fn.ORDER`);return L}function P(O,L){Ng(L);const K=w.signature,G=L==="compact"?K:L==="recovered"?K+1:void 0;return yr(O,G,`${L} signature`)}class k{constructor(L,K,G){this.r=A("r",L),this.s=A("s",K),G!=null&&(this.recovery=G),Object.freeze(this)}static fromBytes(L,K=S){P(L,K);let G;if(K==="der"){const{r:T,s:N}=fs.toSig(yr(L));return new k(T,N)}K==="recovered"&&(G=L[0],K="compact",L=L.subarray(1));const $=a.BYTES,j=L.subarray(0,$),H=L.subarray($,$*2);return new k(a.fromBytes(j),a.fromBytes(H),G)}static fromHex(L,K){return this.fromBytes(pf(L),K)}addRecoveryBit(L){return new k(this.r,this.s,L)}recoverPublicKey(L){const K=i.ORDER,{r:G,s:$,recovery:j}=this;if(j==null||![0,1,2,3].includes(j))throw new Error("recovery id invalid");if(c*Hb<K&&j>1)throw new Error("recovery id is ambiguous for h>1 curve");const T=j===2||j===3?G+c:G;if(!i.isValid(T))throw new Error("recovery id 2 or 3 invalid");const N=i.toBytes(T),Z=n.fromBytes(Fr(Kb((j&1)===0),N)),oe=a.inv(T),ie=I(at("msgHash",L)),ae=a.create(-ie*oe),me=a.create($*oe),ve=n.BASE.multiplyUnsafe(ae).add(Z.multiplyUnsafe(me));if(ve.is0())throw new Error("point at infinify");return ve.assertValidity(),ve}hasHighS(){return E(this.s)}toBytes(L=S){if(Ng(L),L==="der")return pf(fs.hexFromSig(this));const K=a.toBytes(this.r),G=a.toBytes(this.s);if(L==="recovered"){if(this.recovery==null)throw new Error("recovery bit must be present");return Fr(Uint8Array.of(this.recovery),K,G)}return Fr(K,G)}toHex(L){return oo(this.toBytes(L))}assertValidity(){}static fromCompact(L){return k.fromBytes(at("sig",L),"compact")}static fromDER(L){return k.fromBytes(at("sig",L),"der")}normalizeS(){return this.hasHighS()?new k(this.r,a.neg(this.s),this.recovery):this}toDERRawBytes(){return this.toBytes("der")}toDERHex(){return oo(this.toBytes("der"))}toCompactRawBytes(){return this.toBytes("compact")}toCompactHex(){return oo(this.toBytes("compact"))}}const F=t.bits2int||function(L){if(L.length>8192)throw new Error("input is too large");const K=y1(L),G=L.length*8-u;return G>0?K>>BigInt(G):K},I=t.bits2int_modN||function(L){return a.create(F(L))},V=Uu(u);function Q(O){return nu("num < 2^"+u,O,gs,V),a.toBytes(O)}function D(O,L){return yr(O,void 0,"message"),L?yr(e(O),void 0,"prehashed message"):O}function R(O,L,K){if(["recovered","canonical"].some(ae=>ae in K))throw new Error("sign() legacy options not supported");const{lowS:G,prehash:$,extraEntropy:j}=y2(K,x);O=D(O,$);const H=I(O),T=Ea(a,L),N=[Q(T),Q(H)];if(j!=null&&j!==!1){const ae=j===!0?r(w.secretKey):j;N.push(at("extraEntropy",ae))}const Z=Fr(...N),oe=H;function ie(ae){const me=F(ae);if(!a.isValidNot0(me))return;const ve=a.inv(me),ge=n.BASE.multiply(me).toAffine(),De=a.create(ge.x);if(De===gs)return;const At=a.create(ve*a.create(oe+De*T));if(At===gs)return;let Jr=(ge.x===De?0:2)|Number(ge.y&Ia),kr=At;return G&&E(At)&&(kr=a.neg(At),Jr^=1),new k(De,kr,Jr)}return{seed:Z,k2sig:ie}}function Y(O,L,K={}){O=at("message",O);const{seed:G,k2sig:$}=R(O,L,K);return $R(e.outputLen,a.BYTES,s)(G,$)}function J(O){let L;const K=typeof O=="string"||Bu(O),G=!K&&O!==null&&typeof O=="object"&&typeof O.r=="bigint"&&typeof O.s=="bigint";if(!K&&!G)throw new Error("invalid signature, expected Uint8Array, hex string or Signature instance");if(G)L=new k(O.r,O.s);else if(K){try{L=k.fromBytes(at("sig",O),"der")}catch($){if(!($ instanceof fs.Err))throw $}if(!L)try{L=k.fromBytes(at("sig",O),"compact")}catch{return!1}}return L||!1}function X(O,L,K,G={}){const{lowS:$,prehash:j,format:H}=y2(G,x);if(K=at("publicKey",K),L=D(at("message",L),j),"strict"in G)throw new Error("options.strict was renamed to lowS");const T=H===void 0?J(O):k.fromBytes(at("sig",O),H);if(T===!1)return!1;try{const N=n.fromBytes(K);if($&&T.hasHighS())return!1;const{r:Z,s:oe}=T,ie=I(L),ae=a.inv(oe),me=a.create(ie*ae),ve=a.create(Z*ae),ge=n.BASE.multiplyUnsafe(me).add(N.multiplyUnsafe(ve));return ge.is0()?!1:a.create(ge.x)===Z}catch{return!1}}function B(O,L,K={}){const{prehash:G}=y2(K,x);return L=D(L,G),k.fromBytes(O,"recovered").recoverPublicKey(L).toBytes()}return Object.freeze({keygen:h,getPublicKey:f,getSharedSecret:p,utils:m,lengths:w,Point:n,sign:Y,verify:X,recoverPublicKey:B,Signature:k,hash:e})}function pO(n){const e={a:n.a,b:n.b,p:n.Fp.ORDER,n:n.n,h:n.h,Gx:n.Gx,Gy:n.Gy},t=n.Fp;let r=n.allowedPrivateKeyLengths?Array.from(new Set(n.allowedPrivateKeyLengths.map(a=>Math.ceil(a/2)))):void 0;const s=To(e.n,{BITS:n.nBitLength,allowedLengths:r,modFromBytes:n.wrapPrivateKey}),i={Fp:t,Fn:s,allowInfinityPoint:n.allowInfinityPoint,endo:n.endo,isTorsionFree:n.isTorsionFree,clearCofactor:n.clearCofactor,fromBytes:n.fromBytes,toBytes:n.toBytes};return{CURVE:e,curveOpts:i}}function gO(n){const{CURVE:e,curveOpts:t}=pO(n),r={hmac:n.hmac,randomBytes:n.randomBytes,lowS:n.lowS,bits2int:n.bits2int,bits2int_modN:n.bits2int_modN};return{CURVE:e,curveOpts:t,hash:n.hash,ecdsaOpts:r}}function mO(n,e){const t=e.Point;return Object.assign({},e,{ProjectivePoint:t,CURVE:Object.assign({},n,Cb(t.Fn.ORDER,t.Fn.BITS))})}function yO(n){const{CURVE:e,curveOpts:t,hash:r,ecdsaOpts:s}=gO(n),i=dO(e,t),a=fO(i,r,s);return mO(n,a)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function wO(n,e){const t=r=>yO({...n,hash:r});return{...t(e),create:t}}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const u3={p:BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),n:BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),h:BigInt(1),a:BigInt(0),b:BigInt(7),Gx:BigInt("0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798"),Gy:BigInt("0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")},vO={beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),basises:[[BigInt("0x3086d221a7d46bcde86c90e49284eb15"),-BigInt("0xe4437ed6010e88286f547fa90abfe4c3")],[BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),BigInt("0x3086d221a7d46bcde86c90e49284eb15")]]},r7=BigInt(2);function bO(n){const e=u3.p,t=BigInt(3),r=BigInt(6),s=BigInt(11),i=BigInt(22),a=BigInt(23),c=BigInt(44),u=BigInt(88),h=n*n*n%e,f=h*h*n%e,p=ht(f,t,e)*f%e,m=ht(p,t,e)*f%e,w=ht(m,r7,e)*h%e,x=ht(w,s,e)*w%e,S=ht(x,i,e)*x%e,E=ht(S,c,e)*S%e,A=ht(E,u,e)*E%e,P=ht(A,c,e)*S%e,k=ht(P,t,e)*f%e,F=ht(k,a,e)*x%e,I=ht(F,r,e)*h%e,V=ht(I,r7,e);if(!Mg.eql(Mg.sqr(V),n))throw new Error("Cannot find square root");return V}const Mg=To(u3.p,{sqrt:bO}),Vn=wO({...u3,Fp:Mg,lowS:!0,endo:vO},hb);function xO(n,e,t,r){const s=mn.digest(t instanceof Uint8Array?t:t.subarray());if(n3(s))return s.then(({digest:i})=>(r?.signal?.throwIfAborted(),Vn.verify(e,i,n))).catch(i=>{throw i.name==="AbortError"?i:new J8(String(i))});try{return r?.signal?.throwIfAborted(),Vn.verify(e,s.digest,n)}catch(i){throw new J8(String(i))}}let SO=class{type="secp256k1";raw;_key;constructor(e){this._key=CO(e),this.raw=EO(this._key)}toMultihash(){return xr.digest(ws(this))}toCID(){return Be.createV1(114,this.toMultihash())}toString(){return bt.encode(this.toMultihash().bytes).substring(1)}equals(e){return e==null||!(e.raw instanceof Uint8Array)?!1:Ve(this.raw,e.raw)}verify(e,t,r){return xO(this._key,t,e,r)}};function Wb(n){return new SO(n)}function EO(n){return Vn.ProjectivePoint.fromHex(n).toRawBytes(!0)}function CO(n){try{return Vn.ProjectivePoint.fromHex(n),n}catch(e){throw new lf(String(e))}}async function kO(n,e){return PL()}function Do(n,e){const{Type:t,Data:r}=Ha.decode(n),s=r??new Uint8Array;switch(t){case qt.RSA:return iO(s,e);case qt.Ed25519:return Ub(s);case qt.secp256k1:return Wb(s);case qt.ECDSA:return ib(s);default:throw new Km}}function AO(n){const{Type:e,Data:t}=Ha.decode(n.digest),r=t??new Uint8Array;switch(e){case qt.Ed25519:return Ub(r);case qt.secp256k1:return Wb(r);case qt.ECDSA:return ib(r);default:throw new Km}}function ws(n){return Ha.encode({Type:qt[n.type],Data:n.raw})}const Gb=Symbol.for("nodejs.util.inspect.custom"),PO=114;let d3=class{type;multihash;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[jm]=!0;toString(){return this.string==null&&(this.string=bt.encode(this.multihash.bytes).slice(1)),this.string}toMultihash(){return this.multihash}toCID(){return Be.createV1(PO,this.multihash)}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return Ve(this.multihash.bytes,e);if(typeof e=="string")return this.toString()===e;if(e?.toMultihash()?.bytes!=null)return Ve(this.multihash.bytes,e.toMultihash().bytes);throw new Error("not valid Id")}[Gb](){return`PeerId(${this.toString()})`}};class Qb extends d3{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class Yb extends d3{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.publicKey}}class Xb extends d3{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.publicKey}}const TO=2336;class Jb{type="url";multihash;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=xr.digest(we(this.url))}[Gb](){return`PeerId(${this.url})`}[jm]=!0;toString(){return this.toCID().toString()}toMultihash(){return this.multihash}toCID(){return Be.createV1(TO,this.toMultihash())}toJSON(){return this.toString()}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=pe(e)),e.toString()===this.toString())}}const _O=114,s7=2336;function sr(n,e){let t;if(n.charAt(0)==="1"||n.charAt(0)==="Q")t=jn(bt.decode(`z${n}`));else{if(n.startsWith("k51qzi5uqu5")||n.startsWith("kzwfwjn5ji4")||n.startsWith("k2k4r8")||n.startsWith("bafz"))return ju(Be.parse(n));throw new Ae('Please pass a multibase decoder for strings that do not start with "1" or "Q"')}return Xr(t)}function v1(n){if(n.type==="Ed25519")return new Yb({multihash:n.toCID().multihash,publicKey:n});if(n.type==="secp256k1")return new Xb({multihash:n.toCID().multihash,publicKey:n});if(n.type==="RSA")return new Qb({multihash:n.toCID().multihash,publicKey:n});throw new Km}function DO(n){return v1(n.publicKey)}function Xr(n){if(NO(n))return new Qb({multihash:n});if(IO(n))try{const e=AO(n);if(e.type==="Ed25519")return new Yb({multihash:n,publicKey:e});if(e.type==="secp256k1")return new Xb({multihash:n,publicKey:e})}catch{const t=pe(n.digest);return new Jb(new URL(t))}throw new NN("Supplied PeerID Multihash is invalid")}function ju(n){if(n?.multihash==null||n.version==null||n.version===1&&n.code!==_O&&n.code!==s7)throw new IN("Supplied PeerID CID is invalid");if(n.code===s7){const e=pe(n.multihash.digest);return new Jb(new URL(e))}return Xr(n.multihash)}function IO(n){return n.code===xr.code}function NO(n){return n.code===mn.code}function vf(n){if(typeof n!="object"||n===null)return!1;const e=Object.getPrototypeOf(n);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in n)&&!(Symbol.iterator in n)}const{hasOwnProperty:Zb}=Object.prototype,{propertyIsEnumerable:MO}=Object,Ka=(n,e,t)=>{Object.defineProperty(n,e,{value:t,writable:!0,enumerable:!0,configurable:!0})},RO=void 0,i7={concatArrays:!1,ignoreUndefined:!1},b1=n=>{const e=[];for(const t in n)Zb.call(n,t)&&e.push(t);if(Object.getOwnPropertySymbols){const t=Object.getOwnPropertySymbols(n);for(const r of t)MO.call(n,r)&&e.push(r)}return e};function wl(n){return Array.isArray(n)?LO(n):vf(n)?OO(n):n}function LO(n){const e=n.slice(0,0);return b1(n).forEach(t=>{Ka(e,t,wl(n[t]))}),e}function OO(n){const e=Object.getPrototypeOf(n)===null?Object.create(null):{};return b1(n).forEach(t=>{Ka(e,t,wl(n[t]))}),e}const ex=(n,e,t,r)=>(t.forEach(s=>{typeof e[s]>"u"&&r.ignoreUndefined||(s in n&&n[s]!==Object.getPrototypeOf(n)?Ka(n,s,Rg(n[s],e[s],r)):Ka(n,s,wl(e[s])))}),n),BO=(n,e,t)=>{let r=n.slice(0,0),s=0;return[n,e].forEach(i=>{const a=[];for(let c=0;c<i.length;c++)Zb.call(i,c)&&(a.push(String(c)),i===n?Ka(r,s++,i[c]):Ka(r,s++,wl(i[c])));r=ex(r,i,b1(i).filter(c=>!a.includes(c)),t)}),r};function Rg(n,e,t){return t.concatArrays&&Array.isArray(n)&&Array.isArray(e)?BO(n,e,t):!vf(e)||!vf(n)?wl(e):ex(n,e,b1(e),t)}function tx(...n){const e=Rg(wl(i7),this!==RO&&this||{},i7);let t={_:{}};for(const r of n)if(r!==void 0){if(!vf(r))throw new TypeError("`"+r+"` is not an Option Object");t=Rg(t,{_:r},e)}return t._}class qe extends Event{type;detail;constructor(e,t){super(e),this.type=e,this.detail=t}}var w2={exports:{}},o7;function FO(){return o7||(o7=1,function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function s(u,h,f){this.fn=u,this.context=h,this.once=f||!1}function i(u,h,f,p,m){if(typeof f!="function")throw new TypeError("The listener must be a function");var w=new s(f,p||u,m),x=t?t+h:h;return u._events[x]?u._events[x].fn?u._events[x]=[u._events[x],w]:u._events[x].push(w):(u._events[x]=w,u._eventsCount++),u}function a(u,h){--u._eventsCount===0?u._events=new r:delete u._events[h]}function c(){this._events=new r,this._eventsCount=0}c.prototype.eventNames=function(){var h=[],f,p;if(this._eventsCount===0)return h;for(p in f=this._events)e.call(f,p)&&h.push(t?p.slice(1):p);return Object.getOwnPropertySymbols?h.concat(Object.getOwnPropertySymbols(f)):h},c.prototype.listeners=function(h){var f=t?t+h:h,p=this._events[f];if(!p)return[];if(p.fn)return[p.fn];for(var m=0,w=p.length,x=new Array(w);m<w;m++)x[m]=p[m].fn;return x},c.prototype.listenerCount=function(h){var f=t?t+h:h,p=this._events[f];return p?p.fn?1:p.length:0},c.prototype.emit=function(h,f,p,m,w,x){var S=t?t+h:h;if(!this._events[S])return!1;var E=this._events[S],A=arguments.length,P,k;if(E.fn){switch(E.once&&this.removeListener(h,E.fn,void 0,!0),A){case 1:return E.fn.call(E.context),!0;case 2:return E.fn.call(E.context,f),!0;case 3:return E.fn.call(E.context,f,p),!0;case 4:return E.fn.call(E.context,f,p,m),!0;case 5:return E.fn.call(E.context,f,p,m,w),!0;case 6:return E.fn.call(E.context,f,p,m,w,x),!0}for(k=1,P=new Array(A-1);k<A;k++)P[k-1]=arguments[k];E.fn.apply(E.context,P)}else{var F=E.length,I;for(k=0;k<F;k++)switch(E[k].once&&this.removeListener(h,E[k].fn,void 0,!0),A){case 1:E[k].fn.call(E[k].context);break;case 2:E[k].fn.call(E[k].context,f);break;case 3:E[k].fn.call(E[k].context,f,p);break;case 4:E[k].fn.call(E[k].context,f,p,m);break;default:if(!P)for(I=1,P=new Array(A-1);I<A;I++)P[I-1]=arguments[I];E[k].fn.apply(E[k].context,P)}}return!0},c.prototype.on=function(h,f,p){return i(this,h,f,p,!1)},c.prototype.once=function(h,f,p){return i(this,h,f,p,!0)},c.prototype.removeListener=function(h,f,p,m){var w=t?t+h:h;if(!this._events[w])return this;if(!f)return a(this,w),this;var x=this._events[w];if(x.fn)x.fn===f&&(!m||x.once)&&(!p||x.context===p)&&a(this,w);else{for(var S=0,E=[],A=x.length;S<A;S++)(x[S].fn!==f||m&&!x[S].once||p&&x[S].context!==p)&&E.push(x[S]);E.length?this._events[w]=E.length===1?E[0]:E:a(this,w)}return this},c.prototype.removeAllListeners=function(h){var f;return h?(f=t?t+h:h,this._events[f]&&a(this,f)):(this._events=new r,this._eventsCount=0),this},c.prototype.off=c.prototype.removeListener,c.prototype.addListener=c.prototype.on,c.prefixed=t,c.EventEmitter=c,n.exports=c}(w2)),w2.exports}var UO=FO();const VO=_u(UO);class nx extends Error{constructor(e){super(e),this.name="TimeoutError"}}let jO=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const a7=n=>globalThis.DOMException===void 0?new jO(n):new DOMException(n),l7=n=>{const e=n.reason===void 0?a7("This operation was aborted."):n.reason;return e instanceof Error?e:a7(e)};function x1(n,e){const{milliseconds:t,fallback:r,message:s,customTimers:i={setTimeout,clearTimeout}}=e;let a,c;const h=new Promise((f,p)=>{if(typeof t!="number"||Math.sign(t)!==1)throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${t}\``);if(e.signal){const{signal:w}=e;w.aborted&&p(l7(w)),c=()=>{p(l7(w))},w.addEventListener("abort",c,{once:!0})}if(t===Number.POSITIVE_INFINITY){n.then(f,p);return}const m=new nx;a=i.setTimeout.call(void 0,()=>{if(r){try{f(r())}catch(w){p(w)}return}typeof n.cancel=="function"&&n.cancel(),s===!1?f():s instanceof Error?p(s):(m.message=s??`Promise timed out after ${t} milliseconds`,p(m))},t),(async()=>{try{f(await n)}catch(w){p(w)}})()}).finally(()=>{h.clear(),c&&e.signal&&e.signal.removeEventListener("abort",c)});return h.clear=()=>{i.clearTimeout.call(void 0,a),a=void 0},h}function $O(n,e,t){let r=0,s=n.length;for(;s>0;){const i=Math.trunc(s/2);let a=r+i;t(n[a],e)<=0?(r=++a,s-=i+1):s=i}return r}let zO=class{#e=[];enqueue(e,t){t={priority:0,...t};const r={priority:t.priority,id:t.id,run:e};if(this.size===0||this.#e[this.size-1].priority>=t.priority){this.#e.push(r);return}const s=$O(this.#e,r,(i,a)=>a.priority-i.priority);this.#e.splice(s,0,r)}setPriority(e,t){const r=this.#e.findIndex(i=>i.id===e);if(r===-1)throw new ReferenceError(`No promise function with the id "${e}" exists in the queue.`);const[s]=this.#e.splice(r,1);this.enqueue(s.run,{priority:t,id:e})}dequeue(){return this.#e.shift()?.run}filter(e){return this.#e.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this.#e.length}};class HO extends VO{#e;#n;#t=0;#f;#a;#p=0;#s;#l;#r;#g;#i=0;#c;#o;#m;#v=1n;timeout;constructor(e){if(super(),e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:zO,...e},!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#e=e.carryoverConcurrencyCount,this.#n=e.intervalCap===Number.POSITIVE_INFINITY||e.interval===0,this.#f=e.intervalCap,this.#a=e.interval,this.#r=new e.queueClass,this.#g=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#m=e.throwOnTimeout===!0,this.#o=e.autoStart===!1}get#b(){return this.#n||this.#t<this.#f}get#x(){return this.#i<this.#c}#S(){this.#i--,this.#u(),this.emit("next")}#E(){this.#w(),this.#y(),this.#l=void 0}get#C(){const e=Date.now();if(this.#s===void 0){const t=this.#p-e;if(t<0)this.#t=this.#e?this.#i:0;else return this.#l===void 0&&(this.#l=setTimeout(()=>{this.#E()},t)),!0}return!1}#u(){if(this.#r.size===0)return this.#s&&clearInterval(this.#s),this.#s=void 0,this.emit("empty"),this.#i===0&&this.emit("idle"),!1;if(!this.#o){const e=!this.#C;if(this.#b&&this.#x){const t=this.#r.dequeue();return t?(this.emit("active"),t(),e&&this.#y(),!0):!1}}return!1}#y(){this.#n||this.#s!==void 0||(this.#s=setInterval(()=>{this.#w()},this.#a),this.#p=Date.now()+this.#a)}#w(){this.#t===0&&this.#i===0&&this.#s&&(clearInterval(this.#s),this.#s=void 0),this.#t=this.#e?this.#i:0,this.#d()}#d(){for(;this.#u(););}get concurrency(){return this.#c}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#c=e,this.#d()}async#k(e){return new Promise((t,r)=>{e.addEventListener("abort",()=>{r(e.reason)},{once:!0})})}setPriority(e,t){this.#r.setPriority(e,t)}async add(e,t={}){return t.id??=(this.#v++).toString(),t={timeout:this.timeout,throwOnTimeout:this.#m,...t},new Promise((r,s)=>{this.#r.enqueue(async()=>{this.#i++,this.#t++;try{t.signal?.throwIfAborted();let i=e({signal:t.signal});t.timeout&&(i=x1(Promise.resolve(i),{milliseconds:t.timeout})),t.signal&&(i=Promise.race([i,this.#k(t.signal)]));const a=await i;r(a),this.emit("completed",a)}catch(i){if(i instanceof nx&&!t.throwOnTimeout){r();return}s(i),this.emit("error",i)}finally{this.#S()}},t),this.emit("add"),this.#u()})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this.#o?(this.#o=!1,this.#d(),this):this}pause(){this.#o=!0}clear(){this.#r=new this.#g}async onEmpty(){this.#r.size!==0&&await this.#h("empty")}async onSizeLessThan(e){this.#r.size<e||await this.#h("next",()=>this.#r.size<e)}async onIdle(){this.#i===0&&this.#r.size===0||await this.#h("idle")}async#h(e,t){return new Promise(r=>{const s=()=>{t&&!t()||(this.off(e,s),r())};this.on(e,s)})}get size(){return this.#r.size}sizeBy(e){return this.#r.filter(e).length}get pending(){return this.#i}get isPaused(){return this.#o}}function rx(n){const e=[Ci.A];return n==null?e:Array.isArray(n)?n.length===0?e:n:[n]}const sx=60;function ix(n){return{Status:n.Status??0,TC:n.TC??n.flag_tc??!1,RD:n.RD??n.flag_rd??!1,RA:n.RA??n.flag_ra??!1,AD:n.AD??n.flag_ad??!1,CD:n.CD??n.flag_cd??!1,Question:(n.Question??n.questions??[]).map(e=>({name:e.name,type:Ci[e.type]})),Answer:(n.Answer??n.answers??[]).map(e=>({name:e.name,type:Ci[e.type],TTL:e.TTL??e.ttl??sx,data:e.data instanceof Uint8Array?pe(e.data):e.data}))}}const KO=4;function c7(n,e={}){const t=new HO({concurrency:e.queryConcurrency??KO});return async(r,s={})=>{const i=new URLSearchParams;i.set("name",r),rx(s.types).forEach(c=>{i.append("type",Ci[c])}),s.onProgress?.(new qe("dns:query",{detail:r}));const a=await t.add(async()=>{const c=await fetch(`${n}?${i}`,{headers:{accept:"application/dns-json"},signal:s?.signal});if(c.status!==200)throw new Error(`Unexpected HTTP status: ${c.status} - ${c.statusText}`);const u=ix(await c.json());return s.onProgress?.(new qe("dns:response",{detail:u})),u},{signal:s.signal});if(a==null)throw new Error("No DNS response received");return a}}function qO(){return[c7("https://cloudflare-dns.com/dns-query"),c7("https://dns.google/resolve")]}var v2,u7;function WO(){return u7||(u7=1,v2=function(n){if(!n)throw Error("hashlru must have a max value, of type number, greater than 0");var e=0,t=Object.create(null),r=Object.create(null);function s(i,a){t[i]=a,e++,e>=n&&(e=0,r=t,t=Object.create(null))}return{has:function(i){return t[i]!==void 0||r[i]!==void 0},remove:function(i){t[i]!==void 0&&(t[i]=void 0),r[i]!==void 0&&(r[i]=void 0)},get:function(i){var a=t[i];if(a!==void 0)return a;if((a=r[i])!==void 0)return s(i,a),a},set:function(i,a){t[i]!==void 0?t[i]=a:s(i,a)},clear:function(){t=Object.create(null),r=Object.create(null)}}}),v2}var GO=WO();const QO=_u(GO);class YO{lru;constructor(e){this.lru=QO(e)}get(e,t){let r=!0;const s=[];for(const i of t){const a=this.getAnswers(e,i);if(a.length===0){r=!1;break}s.push(...a)}if(r)return ix({answers:s})}getAnswers(e,t){const r=`${e.toLowerCase()}-${t}`,s=this.lru.get(r);if(s!=null){const i=s.filter(a=>a.expires>Date.now()).map(({expires:a,value:c})=>({...c,TTL:Math.round((a-Date.now())/1e3),type:Ci[c.type]}));return i.length===0&&this.lru.remove(r),i}return[]}add(e,t){const r=`${e.toLowerCase()}-${t.type}`,s=this.lru.get(r)??[];s.push({expires:Date.now()+(t.TTL??sx)*1e3,value:t}),this.lru.set(r,s)}remove(e,t){const r=`${e.toLowerCase()}-${t}`;this.lru.remove(r)}clear(){this.lru.clear()}}function XO(n){return new YO(n)}const JO=1e3;let ZO=class{resolvers;cache;constructor(e){this.resolvers={},this.cache=XO(e.cacheSize??JO),Object.entries(e.resolvers??{}).forEach(([t,r])=>{Array.isArray(r)||(r=[r]),t.endsWith(".")||(t=`${t}.`),this.resolvers[t]=r}),this.resolvers["."]==null&&(this.resolvers["."]=qO())}async query(e,t={}){const r=rx(t.types),s=t.cached!==!1?this.cache.get(e,r):void 0;if(s!=null)return t.onProgress?.(new qe("dns:cache",{detail:s})),s;const i=`${e.split(".").pop()}.`,a=(this.resolvers[i]??this.resolvers["."]).sort(()=>Math.random()>.5?-1:1),c=[];for(const u of a){if(t.signal?.aborted===!0)break;try{const h=await u(e,{...t,types:r});for(const f of h.Answer)this.cache.add(e,f);return h}catch(h){c.push(h),t.onProgress?.(new qe("dns:error",{detail:h}))}}throw c.length===1?c[0]:new AggregateError(c,`DNS lookup of ${e} ${r} failed`)}};var Ci;(function(n){n[n.A=1]="A",n[n.CNAME=5]="CNAME",n[n.TXT=16]="TXT",n[n.AAAA=28]="AAAA"})(Ci||(Ci={}));function eB(n={}){return new ZO(n)}class er extends Error{static name="InvalidMultiaddrError";name="InvalidMultiaddrError"}class ru extends Error{static name="ValidationError";name="ValidationError"}class tB extends Error{static name="InvalidParametersError";name="InvalidParametersError"}class nB extends Error{static name="UnknownProtocolError";name="UnknownProtocolError"}class rB{index=0;input="";new(e){return this.index=0,this.input=e,this}readAtomically(e){const t=this.index,r=e();return r===void 0&&(this.index=t),r}parseWith(e){const t=e();if(this.index===this.input.length)return t}peekChar(){if(!(this.index>=this.input.length))return this.input[this.index]}readChar(){if(!(this.index>=this.input.length))return this.input[this.index++]}readGivenChar(e){return this.readAtomically(()=>{const t=this.readChar();if(t===e)return t})}readSeparator(e,t,r){return this.readAtomically(()=>{if(!(t>0&&this.readGivenChar(e)===void 0))return r()})}readNumber(e,t,r,s){return this.readAtomically(()=>{let i=0,a=0;const c=this.peekChar();if(c===void 0)return;const u=c==="0",h=2**(8*s)-1;for(;;){const f=this.readAtomically(()=>{const p=this.readChar();if(p===void 0)return;const m=Number.parseInt(p,e);if(!Number.isNaN(m))return m});if(f===void 0)break;if(i*=e,i+=f,i>h||(a+=1,t!==void 0&&a>t))return}if(a!==0)return!r&&u&&a>1?void 0:i})}readIPv4Addr(){return this.readAtomically(()=>{const e=new Uint8Array(4);for(let t=0;t<e.length;t++){const r=this.readSeparator(".",t,()=>this.readNumber(10,3,!1,1));if(r===void 0)return;e[t]=r}return e})}readIPv6Addr(){const e=t=>{for(let r=0;r<t.length/2;r++){const s=r*2;if(r<t.length-3){const a=this.readSeparator(":",r,()=>this.readIPv4Addr());if(a!==void 0)return t[s]=a[0],t[s+1]=a[1],t[s+2]=a[2],t[s+3]=a[3],[s+4,!0]}const i=this.readSeparator(":",r,()=>this.readNumber(16,4,!0,2));if(i===void 0)return[s,!1];t[s]=i>>8,t[s+1]=i&255}return[t.length,!1]};return this.readAtomically(()=>{const t=new Uint8Array(16),[r,s]=e(t);if(r===16)return t;if(s||this.readGivenChar(":")===void 0||this.readGivenChar(":")===void 0)return;const i=new Uint8Array(14),a=16-(r+2),[c]=e(i.subarray(0,a));return t.set(i.subarray(0,c),16-c),t})}readIPAddr(){return this.readIPv4Addr()??this.readIPv6Addr()}}const ox=45,sB=15,qa=new rB;function ax(n){if(!(n.length>sB))return qa.new(n).parseWith(()=>qa.readIPv4Addr())}function lx(n){if(n.includes("%")&&(n=n.split("%")[0]),!(n.length>ox))return qa.new(n).parseWith(()=>qa.readIPv6Addr())}function Lg(n,e=!1){if(n.includes("%")&&(n=n.split("%")[0]),n.length>ox)return;const t=qa.new(n).parseWith(()=>qa.readIPAddr());if(t)return e&&t.length===4?Uint8Array.from([0,0,0,0,0,0,0,0,0,0,255,255,t[0],t[1],t[2],t[3]]):t}function Wa(n){return!!ax(n)}function cx(n){return!!lx(n)}const go=4,vs=6,bf=273,iB=33,nr=41,Io=42,h3=43,$u=53,zu=54,vl=55,Hu=56,oB=132,aB=301,lB=302,ux=400,He=421,cB=444,uB=445,dB=446,hB=447,Na=448,dx=449,fB=454,hx=460,fx=461,px=465,su=466,Ma=480,pB=481,Og=443,f3=477,gx=478,gB=479,mB=277,yB=275,wB=276,mx=280,Kh=281,No=290,yx=777;function d7(n){return e=>pe(e,n)}function h7(n){return e=>we(e,n)}function _c(n){return new DataView(n.buffer).getUint16(n.byteOffset).toString()}function Ca(n){const e=new ArrayBuffer(2);return new DataView(e).setUint16(0,typeof n=="string"?parseInt(n):n),new Uint8Array(e)}function vB(n){const e=n.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==16)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion address.`);const t=we(e[0],"base32"),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Ca(r);return Cs([t,s],t.length+s.length)}function bB(n){const e=n.split(":");if(e.length!==2)throw new Error(`failed to parse onion addr: ["'${e.join('", "')}'"]' does not contain a port number`);if(e[0].length!==56)throw new Error(`failed to parse onion addr: ${e[0]} not a Tor onion3 address.`);const t=gi.decode(`b${e[0]}`),r=parseInt(e[1],10);if(r<1||r>65536)throw new Error("Port number is not in range(1, 65536)");const s=Ca(r);return Cs([t,s],t.length+s.length)}function f7(n){const e=n.subarray(0,n.length-2),t=n.subarray(n.length-2),r=pe(e,"base32"),s=_c(t);return`${r}:${s}`}const wx=function(n){n=n.toString().trim();const e=new Uint8Array(4);return n.split(/\./g).forEach((t,r)=>{const s=parseInt(t,10);if(isNaN(s)||s<0||s>255)throw new er("Invalid byte value in IP address");e[r]=s}),e},xB=function(n){let e=0;n=n.toString().trim();const t=n.split(":",8);let r;for(r=0;r<t.length;r++){const i=Wa(t[r]);let a;i&&(a=wx(t[r]),t[r]=pe(a.subarray(0,2),"base16")),a!=null&&++r<8&&t.splice(r,0,pe(a.subarray(2,4),"base16"))}if(t[0]==="")for(;t.length<8;)t.unshift("0");else if(t[t.length-1]==="")for(;t.length<8;)t.push("0");else if(t.length<8){for(r=0;r<t.length&&t[r]!=="";r++);const i=[r,1];for(r=9-t.length;r>0;r--)i.push("0");t.splice.apply(t,i)}const s=new Uint8Array(e+16);for(r=0;r<t.length;r++){t[r]===""&&(t[r]="0");const i=parseInt(t[r],16);if(isNaN(i)||i<0||i>65535)throw new er("Invalid byte value in IP address");s[e++]=i>>8&255,s[e++]=i&255}return s},SB=function(n){if(n.byteLength!==4)throw new er("IPv4 address was incorrect length");const e=[];for(let t=0;t<n.byteLength;t++)e.push(n[t]);return e.join(".")},EB=function(n){if(n.byteLength!==16)throw new er("IPv6 address was incorrect length");const e=[];for(let r=0;r<n.byteLength;r+=2){const s=n[r],i=n[r+1],a=`${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;e.push(a)}const t=e.join(":");try{const r=new URL(`http://[${t}]`);return r.hostname.substring(1,r.hostname.length-1)}catch{throw new er(`Invalid IPv6 address "${t}"`)}};function CB(n){try{const e=new URL(`http://[${n}]`);return e.hostname.substring(1,e.hostname.length-1)}catch{throw new er(`Invalid IPv6 address "${n}"`)}}const b2=Object.values(eu).map(n=>n.decoder),kB=function(){let n=b2[0].or(b2[1]);return b2.slice(2).forEach(e=>n=n.or(e)),n}();function AB(n){return kB.decode(n)}function PB(n){return e=>n.encoder.encode(e)}function TB(n){if(parseInt(n).toString()!==n)throw new ru("Value must be an integer")}function _B(n){if(n<0)throw new ru("Value must be a positive integer, or zero")}function DB(n){return e=>{if(e>n)throw new ru(`Value must be smaller than or equal to ${n}`)}}function IB(...n){return e=>{for(const t of n)t(e)}}const Ch=IB(TB,_B,DB(65535)),tn=-1;class NB{protocolsByCode=new Map;protocolsByName=new Map;getProtocol(e){let t;if(typeof e=="string"?t=this.protocolsByName.get(e):t=this.protocolsByCode.get(e),t==null)throw new nB(`Protocol ${e} was unknown`);return t}addProtocol(e){this.protocolsByCode.set(e.code,e),this.protocolsByName.set(e.name,e),e.aliases?.forEach(t=>{this.protocolsByName.set(t,e)})}removeProtocol(e){const t=this.protocolsByCode.get(e);t!=null&&(this.protocolsByCode.delete(t.code),this.protocolsByName.delete(t.name),t.aliases?.forEach(r=>{this.protocolsByName.delete(r)}))}}const zr=new NB,MB=[{code:go,name:"ip4",size:32,valueToBytes:wx,bytesToValue:SB,validate:n=>{if(!Wa(n))throw new ru(`Invalid IPv4 address "${n}"`)}},{code:vs,name:"tcp",size:16,valueToBytes:Ca,bytesToValue:_c,validate:Ch},{code:bf,name:"udp",size:16,valueToBytes:Ca,bytesToValue:_c,validate:Ch},{code:iB,name:"dccp",size:16,valueToBytes:Ca,bytesToValue:_c,validate:Ch},{code:nr,name:"ip6",size:128,valueToBytes:xB,bytesToValue:EB,stringToValue:CB,validate:n=>{if(!cx(n))throw new ru(`Invalid IPv6 address "${n}"`)}},{code:Io,name:"ip6zone",size:tn},{code:h3,name:"ipcidr",size:8,bytesToValue:d7("base10"),valueToBytes:h7("base10")},{code:$u,name:"dns",size:tn,resolvable:!0},{code:zu,name:"dns4",size:tn,resolvable:!0},{code:vl,name:"dns6",size:tn,resolvable:!0},{code:Hu,name:"dnsaddr",size:tn,resolvable:!0},{code:oB,name:"sctp",size:16,valueToBytes:Ca,bytesToValue:_c,validate:Ch},{code:aB,name:"udt"},{code:lB,name:"utp"},{code:ux,name:"unix",size:tn,path:!0,stringToValue:n=>decodeURIComponent(n),valueToString:n=>encodeURIComponent(n)},{code:He,name:"p2p",aliases:["ipfs"],size:tn,bytesToValue:d7("base58btc"),valueToBytes:n=>n.startsWith("Q")||n.startsWith("1")?h7("base58btc")(n):Be.parse(n).multihash.bytes},{code:cB,name:"onion",size:96,bytesToValue:f7,valueToBytes:vB},{code:uB,name:"onion3",size:296,bytesToValue:f7,valueToBytes:bB},{code:dB,name:"garlic64",size:tn},{code:hB,name:"garlic32",size:tn},{code:Na,name:"tls"},{code:dx,name:"sni",size:tn},{code:fB,name:"noise"},{code:hx,name:"quic"},{code:fx,name:"quic-v1"},{code:px,name:"webtransport"},{code:su,name:"certhash",size:tn,bytesToValue:PB(tb),valueToBytes:AB},{code:Ma,name:"http"},{code:pB,name:"http-path",size:tn,stringToValue:n=>`/${decodeURIComponent(n)}`,valueToString:n=>encodeURIComponent(n.substring(1))},{code:Og,name:"https"},{code:f3,name:"ws"},{code:gx,name:"wss"},{code:gB,name:"p2p-websocket-star"},{code:mB,name:"p2p-stardust"},{code:yB,name:"p2p-webrtc-star"},{code:wB,name:"p2p-webrtc-direct"},{code:mx,name:"webrtc-direct"},{code:Kh,name:"webrtc"},{code:No,name:"p2p-circuit"},{code:yx,name:"memory",size:tn}];MB.forEach(n=>{zr.addProtocol(n)});function RB(n){const e=[];let t=0;for(;t<n.length;){const r=_o(n,t),s=zr.getProtocol(r),i=Ft(r),a=FB(s,n,t+i);let c=0;a>0&&s.size===tn&&(c=Ft(a));const u=i+c+a,h={code:r,name:s.name,bytes:n.subarray(t,t+u)};if(a>0){const f=t+i+c,p=n.subarray(f,f+a);h.value=s.bytesToValue?.(p)??pe(p)}e.push(h),t+=u}return e}function LB(n){let e=0;const t=[];for(const r of n){if(r.bytes==null){const s=zr.getProtocol(r.code),i=Ft(r.code);let a,c=0,u=0;r.value!=null&&(a=s.valueToBytes?.(r.value)??we(r.value),c=a.byteLength,s.size===tn&&(u=Ft(c)));const h=new Uint8Array(i+u+c);let f=0;yf(r.code,h,f),f+=i,a!=null&&(s.size===tn&&(yf(c,h,f),f+=u),h.set(a,f)),r.bytes=h}t.push(r.bytes),e+=r.bytes.byteLength}return Cs(t,e)}function OB(n){if(n.charAt(0)!=="/")throw new er('String multiaddr must start with "/"');const e=[];let t="protocol",r="",s="";for(let i=1;i<n.length;i++){const a=n.charAt(i);a!=="/"&&(t==="protocol"?s+=n.charAt(i):r+=n.charAt(i));const c=i===n.length-1;if(a==="/"||c){const u=zr.getProtocol(s);if(t==="protocol"){if(u.size==null||u.size===0){e.push({code:u.code,name:u.name}),r="",s="",t="protocol";continue}else if(c)throw new er(`Component ${s} was missing value`);t="value"}else if(t==="value"){const h={code:u.code,name:u.name};if(u.size!=null&&u.size!==0){if(r==="")throw new er(`Component ${s} was missing value`);h.value=u.stringToValue?.(r)??r}e.push(h),r="",s="",t="protocol"}}}if(s!==""&&r!=="")throw new er("Incomplete multiaddr");return e}function BB(n){return`/${n.flatMap(e=>{if(e.value==null)return e.name;const t=zr.getProtocol(e.code);if(t==null)throw new er(`Unknown protocol code ${e.code}`);return[e.name,t.valueToString?.(e.value)??e.value]}).join("/")}`}function FB(n,e,t){return n.size==null||n.size===0?0:n.size>0?n.size/8:_o(e,t)}const UB=Symbol.for("nodejs.util.inspect.custom"),vx=Symbol.for("@multiformats/multiaddr"),VB=[$u,zu,vl,Hu];class jB extends Error{constructor(e="No available resolver"){super(e),this.name="NoAvailableResolverError"}}function $B(n){if(n==null&&(n="/"),S1(n))return n.getComponents();if(n instanceof Uint8Array)return RB(n);if(typeof n=="string")return n=n.replace(/\/(\/)+/,"/").replace(/(\/)+$/,""),n===""&&(n="/"),OB(n);if(Array.isArray(n))return n;throw new er("Must be a string, Uint8Array, Component[], or another Multiaddr")}class ka{[vx]=!0;#e;#n;#t;constructor(e="/",t={}){this.#e=$B(e),t.validate!==!1&&zB(this)}get bytes(){return this.#t==null&&(this.#t=LB(this.#e)),this.#t}toString(){return this.#n==null&&(this.#n=BB(this.#e)),this.#n}toJSON(){return this.toString()}toOptions(){let e,t,r,s,i="";for(const{code:c,name:u,value:h}of this.#e)c===Io&&(i=`%${h??""}`),VB.includes(c)&&(t="tcp",s=443,r=`${h??""}${i}`,e=c===vl?6:4),(c===vs||c===bf)&&(t=u==="tcp"?"tcp":"udp",s=parseInt(h??"")),(c===go||c===nr)&&(t="tcp",r=`${h??""}${i}`,e=c===nr?6:4);if(e==null||t==null||r==null||s==null)throw new Error('multiaddr must have a valid format: "/{ip4, ip6, dns4, dns6, dnsaddr}/{address}/{tcp, udp}/{port}".');return{family:e,host:r,transport:t,port:s}}getComponents(){return[...this.#e]}protos(){return this.#e.map(({code:e,value:t})=>{const r=zr.getProtocol(e);return{code:e,size:r.size??0,name:r.name,resolvable:!!r.resolvable,path:!!r.path}})}protoCodes(){return this.#e.map(({code:e})=>e)}protoNames(){return this.#e.map(({name:e})=>e)}tuples(){return this.#e.map(({code:e,value:t})=>{if(t==null)return[e];const r=zr.getProtocol(e),s=[e];return t!=null&&s.push(r.valueToBytes?.(t)??we(t)),s})}stringTuples(){return this.#e.map(({code:e,value:t})=>t==null?[e]:[e,t])}encapsulate(e){const t=new ka(e);return new ka([...this.#e,...t.getComponents()],{validate:!1})}decapsulate(e){const t=e.toString(),r=this.toString(),s=r.lastIndexOf(t);if(s<0)throw new tB(`Address ${this.toString()} does not contain subaddress: ${e.toString()}`);return new ka(r.slice(0,s),{validate:!1})}decapsulateCode(e){let t;for(let r=this.#e.length-1;r>-1;r--)if(this.#e[r].code===e){t=r;break}return new ka(this.#e.slice(0,t),{validate:!1})}getPeerId(){try{let e=[];this.#e.forEach(({code:r,value:s})=>{r===He&&e.push([r,s]),r===No&&(e=[])});const t=e.pop();if(t?.[1]!=null){const r=t[1];return r[0]==="Q"||r[0]==="1"?pe(bt.decode(`z${r}`),"base58btc"):pe(Be.parse(r).multihash.bytes,"base58btc")}return null}catch{return null}}getPath(){for(const e of this.#e)if(zr.getProtocol(e.code).path)return e.value??null;return null}equals(e){return Ve(this.bytes,e.bytes)}async resolve(e){const t=this.protos().find(i=>i.resolvable);if(t==null)return[this];const r=eF.get(t.name);if(r==null)throw new jB(`no available resolver for ${t.name}`);return(await r(this,e)).map(i=>Pe(i))}nodeAddress(){const e=this.toOptions();if(e.transport!=="tcp"&&e.transport!=="udp")throw new Error(`multiaddr must have a valid format - no protocol with name: "${e.transport}". Must have a valid transport protocol: "{tcp, udp}"`);return{family:e.family,address:e.host,port:e.port}}isThinWaistAddress(){return!(this.#e.length!==2||this.#e[0].code!==go&&this.#e[0].code!==nr||this.#e[1].code!==vs&&this.#e[1].code!==bf)}[UB](){return`Multiaddr(${this.toString()})`}}function zB(n){n.getComponents().forEach(e=>{const t=zr.getProtocol(e.code);e.value!=null&&t.validate?.(e.value)})}function HB(n,e,t){let r=0;for(const s of n)if(!(r<e)){if(r>t)break;if(s!==255)return!1;r++}return!0}function KB(n,e,t,r){let s=0;for(const i of n)if(!(s<t)){if(s>r)break;if(i!==e[s])return!1;s++}return!0}function qB(n){switch(n.length){case iu:return n.join(".");case ou:{const e=[];for(let t=0;t<n.length;t++)t%2===0&&e.push(n[t].toString(16).padStart(2,"0")+n[t+1].toString(16).padStart(2,"0"));return e.join(":")}default:throw new Error("Invalid ip length")}}function WB(n){let e=0;for(let[t,r]of n.entries()){if(r===255){e+=8;continue}for(;(r&128)!=0;)e++,r=r<<1;if((r&128)!=0)return-1;for(let s=t+1;s<n.length;s++)if(n[s]!=0)return-1;break}return e}function GB(n){let e="0x";for(const t of n)e+=(t>>4).toString(16)+(t&15).toString(16);return e}const iu=4,ou=16,QB=new Uint8Array([0,0,0,0,0,0,0,0,0,0,255,255]);function bx(n,e){e.length===ou&&n.length===iu&&HB(e,0,11)&&(e=e.slice(12)),e.length===iu&&n.length===ou&&KB(n,QB,0,11)&&(n=n.slice(12));const t=n.length;if(t!=e.length)throw new Error("Failed to mask ip");const r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=n[s]&e[s];return r}function YB(n,e){if(typeof e=="string"&&(e=Lg(e)),e==null)throw new Error("Invalid ip");if(e.length!==n.network.length)return!1;for(let t=0;t<e.length;t++)if((n.network[t]&n.mask[t])!==(e[t]&n.mask[t]))return!1;return!0}function XB(n){const[e,t]=n.split("/");if(!e||!t)throw new Error("Failed to parse given CIDR: "+n);let r=iu,s=ax(e);if(s==null&&(r=ou,s=lx(e),s==null))throw new Error("Failed to parse given CIDR: "+n);const i=parseInt(t,10);if(Number.isNaN(i)||String(i).length!==t.length||i<0||i>r*8)throw new Error("Failed to parse given CIDR: "+n);const a=xx(i,8*r);return{network:bx(s,a),mask:a}}function xx(n,e){if(e!==8*iu&&e!==8*ou)throw new Error("Invalid CIDR mask");if(n<0||n>e)throw new Error("Invalid CIDR mask");const t=e/8,r=new Uint8Array(t);for(let s=0;s<t;s++){if(n>=8){r[s]=255,n-=8;continue}r[s]=255-(255>>n),n=0}return r}class Sx{constructor(e,t){if(t==null)({network:this.network,mask:this.mask}=XB(e));else{const r=Lg(e);if(r==null)throw new Error("Failed to parse network");t=String(t);const s=parseInt(t,10);if(Number.isNaN(s)||String(s).length!==t.length||s<0||s>r.length*8){const i=Lg(t);if(i==null)throw new Error("Failed to parse mask");this.mask=i}else this.mask=xx(s,8*r.length);this.network=bx(r,this.mask)}}contains(e){return YB({network:this.network,mask:this.mask},e)}toString(){const e=WB(this.mask),t=e!==-1?String(e):GB(this.mask);return qB(this.network)+"/"+t}}function JB(n,e){return new Sx(n).contains(e)}function ZB(n){let e,t;if(n.getComponents().forEach(r=>{(r.name==="ip4"||r.name==="ip6")&&(t=r.value),r.name==="ipcidr"&&(e=r.value)}),e==null||t==null)throw new Error("Invalid multiaddr");return new Sx(t,e)}const eF=new Map;function S1(n){return!!n?.[vx]}function Pe(n){return new ka(n)}function E1(n){const e=zr.getProtocol(n);return{code:e.code,size:e.size??0,name:e.name,resolvable:!!e.resolvable,path:!!e.path}}class tF{dns;canResolve(e){return e.getComponents().some(({name:t})=>t==="dnsaddr")}async resolve(e,t){const r=e.getComponents().find(u=>u.name==="dnsaddr")?.value;if(r==null)return[e];const i=await this.getDNS(t).query(`_dnsaddr.${r}`,{signal:t?.signal,types:[Ci.TXT]}),a=e.getComponents().find(u=>u.name==="p2p")?.value,c=[];for(const u of i.Answer){const h=u.data.replace(/["']/g,"").trim().split("=")[1];h!=null&&(a!=null&&!h.includes(a)||c.push(Pe(h)))}return c}getDNS(e){return e.dns!=null?e.dns:(this.dns==null&&(this.dns=eB()),this.dns)}}const p3=new tF;var nF={};const rF={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:n=>n},connectionManager:{resolvers:{dnsaddr:p3}},transportManager:{faultTolerance:Xc.FATAL_ALL}};async function sF(n){const e=tx(rF,n);if(e.connectionProtector===null&&nF?.LIBP2P_FORCE_PNET!=null)throw new Ae("Private network is enforced, but no protector was provided");return e}const Ga=1e3,Qa=Ga*60,Ya=Qa*60,mo=Ya*24,iF=mo*7,oF=mo*365.25;function Ex(n,e){try{if(typeof n=="string"&&n.length>0)return aF(n);if(typeof n=="number"&&isFinite(n))return e?.long?cF(n):lF(n);throw new Error("Value is not a string or number.")}catch(t){const r=uF(t)?`${t.message}. value=${JSON.stringify(n)}`:"An unknown error has occured.";throw new Error(r)}}function aF(n){if(n=String(n),n.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(n);if(!e)return NaN;const t=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return t*oF;case"weeks":case"week":case"w":return t*iF;case"days":case"day":case"d":return t*mo;case"hours":case"hour":case"hrs":case"hr":case"h":return t*Ya;case"minutes":case"minute":case"mins":case"min":case"m":return t*Qa;case"seconds":case"second":case"secs":case"sec":case"s":return t*Ga;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:throw new Error(`The unit ${r} was matched, but no matching case exists.`)}}function lF(n){const e=Math.abs(n);return e>=mo?`${Math.round(n/mo)}d`:e>=Ya?`${Math.round(n/Ya)}h`:e>=Qa?`${Math.round(n/Qa)}m`:e>=Ga?`${Math.round(n/Ga)}s`:`${n}ms`}function cF(n){const e=Math.abs(n);return e>=mo?kh(n,e,mo,"day"):e>=Ya?kh(n,e,Ya,"hour"):e>=Qa?kh(n,e,Qa,"minute"):e>=Ga?kh(n,e,Ga,"second"):`${n} ms`}function kh(n,e,t,r){const s=e>=t*1.5;return`${Math.round(n/t)} ${r}${s?"s":""}`}function uF(n){return typeof n=="object"&&n!==null&&"message"in n}function dF(n){t.debug=t,t.default=t,t.coerce=u,t.disable=i,t.enable=s,t.enabled=a,t.humanize=Ex,t.destroy=h,Object.keys(n).forEach(f=>{t[f]=n[f]}),t.names=[],t.skips=[],t.formatters={};function e(f){let p=0;for(let m=0;m<f.length;m++)p=(p<<5)-p+f.charCodeAt(m),p|=0;return t.colors[Math.abs(p)%t.colors.length]}t.selectColor=e;function t(f){let p,m=null,w,x;function S(...E){if(!S.enabled)return;const A=S,P=Number(new Date),k=P-(p||P);A.diff=k,A.prev=p,A.curr=P,p=P,E[0]=t.coerce(E[0]),typeof E[0]!="string"&&E.unshift("%O");let F=0;E[0]=E[0].replace(/%([a-zA-Z%])/g,(V,Q)=>{if(V==="%%")return"%";F++;const D=t.formatters[Q];if(typeof D=="function"){const R=E[F];V=D.call(A,R),E.splice(F,1),F--}return V}),t.formatArgs.call(A,E),(A.log||t.log).apply(A,E)}return S.namespace=f,S.useColors=t.useColors(),S.color=t.selectColor(f),S.extend=r,S.destroy=t.destroy,Object.defineProperty(S,"enabled",{enumerable:!0,configurable:!1,get:()=>m!==null?m:(w!==t.namespaces&&(w=t.namespaces,x=t.enabled(f)),x),set:E=>{m=E}}),typeof t.init=="function"&&t.init(S),S}function r(f,p){const m=t(this.namespace+(typeof p>"u"?":":p)+f);return m.log=this.log,m}function s(f){t.save(f),t.namespaces=f,t.names=[],t.skips=[];let p;const m=(typeof f=="string"?f:"").split(/[\s,]+/),w=m.length;for(p=0;p<w;p++)m[p]&&(f=m[p].replace(/\*/g,".*?"),f[0]==="-"?t.skips.push(new RegExp("^"+f.substr(1)+"$")):t.names.push(new RegExp("^"+f+"$")))}function i(){const f=[...t.names.map(c),...t.skips.map(c).map(p=>"-"+p)].join(",");return t.enable(""),f}function a(f){if(f[f.length-1]==="*")return!0;let p,m;for(p=0,m=t.skips.length;p<m;p++)if(t.skips[p].test(f))return!1;for(p=0,m=t.names.length;p<m;p++)if(t.names[p].test(f))return!0;return!1}function c(f){return f.toString().substring(2,f.toString().length-2).replace(/\.\*\?$/,"*")}function u(f){return f instanceof Error?f.stack??f.message:f}function h(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.setupFormatters(t.formatters),t.enable(t.load()),t}var hF={};const xf=vF(),fF=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function pF(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/(edge|trident)\/(\d+)/)!=null?!1:typeof document<"u"&&document.documentElement?.style?.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/firefox\/(\d+)/)!=null&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent?.toLowerCase().match(/applewebkit\/(\d+)/)}function gF(n){if(n[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+n[0]+(this.useColors?"%c ":" ")+"+"+Ex(this.diff),!this.useColors)return;const e="color: "+this.color;n.splice(1,0,e,"color: inherit");let t=0,r=0;n[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(r=t))}),n.splice(r,0,e)}const mF=console.debug??console.log??(()=>{});function yF(n){try{n?xf?.setItem("debug",n):xf?.removeItem("debug")}catch{}}function wF(){let n;try{n=xf?.getItem("debug")}catch{}return!n&&typeof globalThis.process<"u"&&"env"in globalThis.process&&(n=hF.DEBUG),n}function vF(){try{return localStorage}catch{}}function bF(n){n.j=function(e){try{return JSON.stringify(e)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}}const Bn=dF({formatArgs:gF,save:yF,load:wF,useColors:pF,setupFormatters:bF,colors:fF,storage:xf,log:mF});Bn.formatters.b=n=>n==null?"undefined":bt.baseEncode(n);Bn.formatters.t=n=>n==null?"undefined":gi.baseEncode(n);Bn.formatters.m=n=>n==null?"undefined":Gm.baseEncode(n);Bn.formatters.p=n=>n==null?"undefined":n.toString();Bn.formatters.c=n=>n==null?"undefined":n.toString();Bn.formatters.k=n=>n==null?"undefined":n.toString();Bn.formatters.a=n=>n==null?"undefined":n.toString();Bn.formatters.e=n=>n==null?"undefined":p7(n.stack)??p7(n.message)??n.toString();function xF(n){const e=()=>{};return e.enabled=!1,e.color="",e.diff=0,e.log=()=>{},e.namespace=n,e.destroy=()=>!0,e.extend=()=>e,e}function Cx(){return{forComponent(n){return SF(n)}}}function SF(n){let e=xF(`${n}:trace`);return Bn.enabled(`${n}:trace`)&&Bn.names.map(t=>t.toString()).find(t=>t.includes(":trace"))!=null&&(e=Bn(`${n}:trace`)),Object.assign(Bn(n),{error:Bn(`${n}:error`),trace:e})}function p7(n){if(n!=null&&(n=n.trim(),n.length!==0))return n}function Vc(n,e){const t={[Symbol.iterator]:()=>t,next:()=>{const r=n.next(),s=r.value;return r.done===!0||s==null?{done:!0,value:void 0}:{done:!1,value:e(s)}}};return t}function x2(n){const e=jn(bt.decode(`z${n}`));return Xr(e)}class Mo{map;constructor(e){if(this.map=new Map,e!=null)for(const[t,r]of e.entries())this.map.set(t.toString(),{key:t,value:r})}[Symbol.iterator](){return this.entries()}clear(){this.map.clear()}delete(e){return this.map.delete(e.toString())}entries(){return Vc(this.map.entries(),e=>[e[1].key,e[1].value])}forEach(e){this.map.forEach((t,r)=>{e(t.value,t.key,this)})}get(e){return this.map.get(e.toString())?.value}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),{key:e,value:t})}keys(){return Vc(this.map.values(),e=>e.key)}values(){return Vc(this.map.values(),e=>e.value)}get size(){return this.map.size}}class bs{set;constructor(e){if(this.set=new Set,e!=null)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[Symbol.iterator](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return Vc(this.set.entries(),e=>{const t=x2(e[0]);return[t,t]})}forEach(e){this.set.forEach(t=>{const r=x2(t);e(r,r,this)})}has(e){return this.set.has(e.toString())}values(){return Vc(this.set.values(),e=>x2(e))}intersection(e){const t=new bs;for(const r of e)this.has(r)&&t.add(r);return t}difference(e){const t=new bs;for(const r of this)e.has(r)||t.add(r);return t}union(e){const t=new bs;for(const r of e)t.add(r);for(const r of this)t.add(r);return t}}function EF(n,e,t,r){Fu(n);const s=CR({dkLen:32,asyncTick:10},r),{c:i,dkLen:a,asyncTick:c}=s;if(io(i),io(a),io(c),i<1)throw new Error("iterations (c) should be >= 1");const u=V8(e),h=V8(t),f=new Uint8Array(a),p=Vu.create(n,u),m=p._cloneInto().update(h);return{c:i,dkLen:a,asyncTick:c,DK:f,PRF:p,PRFSalt:m}}function CF(n,e,t,r,s){return n.destroy(),e.destroy(),r&&r.destroy(),Ei(s),t}async function kF(n,e,t,r){const{c:s,dkLen:i,asyncTick:a,DK:c,PRF:u,PRFSalt:h}=EF(n,e,t,r);let f;const p=new Uint8Array(4),m=Hh(p),w=new Uint8Array(u.outputLen);for(let x=1,S=0;S<i;x++,S+=u.outputLen){const E=c.subarray(S,S+u.outputLen);m.setInt32(0,x,!1),(f=h._cloneInto(f)).update(p).digestInto(w),E.set(w.subarray(0,E.length)),await ER(s-1,a,()=>{u._cloneInto(f).update(w).digestInto(w);for(let A=0;A<E.length;A++)E[A]^=w[A]})}return CF(u,h,c,f,w)}const AF=fb,g3={32:16777619n,64:1099511628211n,128:309485009821345068724781371n,256:374144419156711147060143317175368453031918731002211n,512:35835915874844867368919076489095108449946327955754392558399825615420669938882575126094039892345713852759n,1024:5016456510113118655434598811035278955030765345404790744303017523831112055108147451509157692220295382716162651878526895249385292291816524375083746691371804094271873160484737966720260389217684476157468082573n},kx={32:2166136261n,64:14695981039346656037n,128:144066263297769815596495629667062367629n,256:100029257958052580907070968620625704837092796014241193945225284501741471925557n,512:9659303129496669498009435400716310466090418745672637896108374329434462657994582932197716438449813051892206539805784495328239340083876191928701583869517785n,1024:14197795064947621068722070641403218320880622795441933960878474914617582723252296732303717722150864096521202355549365628174669108571814760471015076148029755969804077320157692458563003215304957150157403644460363550505412711285966361610267868082893823963790439336411086884584107735010676915n},Ax=new globalThis.TextEncoder;function PF(n,e){const t=g3[e];let r=kx[e];for(let s=0;s<n.length;s++)r^=BigInt(n[s]),r=BigInt.asUintN(e,r*t);return r}function TF(n,e,t){if(t.length===0)throw new Error("The `utf8Buffer` option must have a length greater than zero");const r=g3[e];let s=kx[e],i=n;for(;i.length>0;){const a=Ax.encodeInto(i,t);i=i.slice(a.read);for(let c=0;c<a.written;c++)s^=BigInt(t[c]),s=BigInt.asUintN(e,s*r)}return s}function _F(n,{size:e=32,utf8Buffer:t}={}){if(!g3[e])throw new Error("The `size` option must be one of 32, 64, 128, 256, 512, or 1024");if(typeof n=="string"){if(t)return TF(n,e,t);n=Ax.encode(n)}return PF(n,e)}const m3={hash:n=>Number(_F(n,{size:32})),hashV:(n,e)=>DF(m3.hash(n,e))};function DF(n){let e=n.toString(16);return e.length%2===1&&(e=`0${e}`),we(e,"base16")}const Px=64;class to{fp;h;seed;constructor(e,t,r,s=2){if(s>Px)throw new TypeError("Invalid Fingerprint Size");const i=t.hashV(e,r),a=Fe(s);for(let c=0;c<a.length;c++)a[c]=i[c];a.length===0&&(a[0]=7),this.fp=a,this.h=t,this.seed=r}hash(){return this.h.hash(this.fp,this.seed)}equals(e){return e?.fp instanceof Uint8Array?Ve(this.fp,e.fp):!1}}function Sf(n,e){return Math.floor(Math.random()*(e-n))+n}class Ah{contents;constructor(e){this.contents=new Array(e).fill(null)}has(e){if(!(e instanceof to))throw new TypeError("Invalid Fingerprint");return this.contents.some(t=>e.equals(t))}add(e){if(!(e instanceof to))throw new TypeError("Invalid Fingerprint");for(let t=0;t<this.contents.length;t++)if(this.contents[t]==null)return this.contents[t]=e,!0;return!0}swap(e){if(!(e instanceof to))throw new TypeError("Invalid Fingerprint");const t=Sf(0,this.contents.length-1),r=this.contents[t];return this.contents[t]=e,r}remove(e){if(!(e instanceof to))throw new TypeError("Invalid Fingerprint");const t=this.contents.findIndex(r=>e.equals(r));return t>-1?(this.contents[t]=null,!0):!1}}const IF=500;class g7{bucketSize;filterSize;fingerprintSize;buckets;count;hash;seed;constructor(e){this.filterSize=e.filterSize,this.bucketSize=e.bucketSize??4,this.fingerprintSize=e.fingerprintSize??2,this.count=0,this.buckets=[],this.hash=e.hash??m3,this.seed=e.seed??Sf(0,Math.pow(2,10))}add(e){typeof e=="string"&&(e=we(e));const t=new to(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,s=(r^t.hash())%this.filterSize;if(this.buckets[r]==null&&(this.buckets[r]=new Ah(this.bucketSize)),this.buckets[s]==null&&(this.buckets[s]=new Ah(this.bucketSize)),this.buckets[r].add(t)||this.buckets[s].add(t))return this.count++,!0;const i=[r,s];let a=i[Sf(0,i.length-1)];this.buckets[a]==null&&(this.buckets[a]=new Ah(this.bucketSize));for(let c=0;c<IF;c++){const u=this.buckets[a].swap(t);if(u!=null&&(a=(a^u.hash())%this.filterSize,this.buckets[a]==null&&(this.buckets[a]=new Ah(this.bucketSize)),this.buckets[a].add(u)))return this.count++,!0}return!1}has(e){typeof e=="string"&&(e=we(e));const t=new to(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[r]?.has(t)??!1;if(s)return s;const i=(r^t.hash())%this.filterSize;return this.buckets[i]?.has(t)??!1}remove(e){typeof e=="string"&&(e=we(e));const t=new to(e,this.hash,this.seed,this.fingerprintSize),r=this.hash.hash(e,this.seed)%this.filterSize,s=this.buckets[r]?.remove(t)??!1;if(s)return this.count--,s;const i=(r^t.hash())%this.filterSize,a=this.buckets[i]?.remove(t)??!1;return a&&this.count--,a}get reliable(){return Math.floor(100*(this.count/this.filterSize))<=90}}const NF={1:.5,2:.84,4:.95,8:.98};function MF(n=.001){return n>.002?2:n>1e-5?4:8}function RF(n,e=.001){const t=MF(e),r=NF[t],s=Math.round(n/r),i=Math.min(Math.ceil(Math.log2(1/e)+Math.log2(2*t)),Px);return{filterSize:s,bucketSize:t,fingerprintSize:i}}class LF{filterSize;bucketSize;fingerprintSize;scale;filterSeries;hash;seed;constructor(e){this.bucketSize=e.bucketSize??4,this.filterSize=e.filterSize??(1<<18)/this.bucketSize,this.fingerprintSize=e.fingerprintSize??2,this.scale=e.scale??2,this.hash=e.hash??m3,this.seed=e.seed??Sf(0,Math.pow(2,10)),this.filterSeries=[new g7({filterSize:this.filterSize,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed})]}add(e){if(typeof e=="string"&&(e=we(e)),this.has(e))return!0;let t=this.filterSeries.find(r=>r.reliable);if(t==null){const r=this.filterSize*Math.pow(this.scale,this.filterSeries.length);t=new g7({filterSize:r,bucketSize:this.bucketSize,fingerprintSize:this.fingerprintSize,hash:this.hash,seed:this.seed}),this.filterSeries.push(t)}return t.add(e)}has(e){typeof e=="string"&&(e=we(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].has(e))return!0;return!1}remove(e){typeof e=="string"&&(e=we(e));for(let t=0;t<this.filterSeries.length;t++)if(this.filterSeries[t].remove(e))return!0;return!1}get count(){return this.filterSeries.reduce((e,t)=>e+t.count,0)}}function Xa(n,e=.001,t){return new LF({...RF(n,e)})}class OF{filter;constructor(e,t){this.filter=Xa(e,t)}has(e){return this.filter.has(e.toMultihash().bytes)}add(e){this.filter.add(e.toMultihash().bytes)}remove(e){this.filter.remove?.(e.toMultihash().bytes)}}function BF(n,e=.001){return new OF(n,e)}class FF extends Mo{metric;constructor(e){super();const{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function Tx(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new FF({name:e,metrics:t}):r=new Mo,r}var Ef;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&t.payload.byteLength>0&&(r.uint32(26),r.bytes(t.payload)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={publicKey:Fe(0),payloadType:Fe(0),payload:Fe(0),signature:Fe(0)},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=t.bytes();break}case 5:{i.signature=t.bytes();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Ef||(Ef={}));class UF extends Error{constructor(e="Invalid signature"){super(e),this.name="InvalidSignatureError"}}class xs{static createFromProtobuf=e=>{const t=Ef.decode(e),r=Do(t.publicKey);return new xs({publicKey:r,payloadType:t.payloadType,payload:t.payload,signature:t.signature})};static seal=async(e,t,r)=>{if(t==null)throw new Error("Missing private key");const s=e.domain,i=e.codec,a=e.marshal(),c=m7(s,i,a),u=await t.sign(c.subarray(),r);return new xs({publicKey:t.publicKey,payloadType:i,payload:a,signature:u})};static openAndCertify=async(e,t,r)=>{const s=xs.createFromProtobuf(e);if(!await s.validate(t,r))throw new UF("Envelope signature is not valid for the given domain");return s};publicKey;payloadType;payload;signature;marshaled;constructor(e){const{publicKey:t,payloadType:r,payload:s,signature:i}=e;this.publicKey=t,this.payloadType=r,this.payload=s,this.signature=i}marshal(){return this.marshaled==null&&(this.marshaled=Ef.encode({publicKey:ws(this.publicKey),payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return e==null?!1:Ve(this.marshal(),e.marshal())}async validate(e,t){const r=m7(e,this.payloadType,this.payload);return this.publicKey.verify(r.subarray(),this.signature,t)}}const m7=(n,e,t)=>{const r=we(n),s=mi(r.byteLength),i=mi(e.length),a=mi(t.length);return new Ie(s,r,i,e,a,t)};function VF(n,e){const t=(r,s)=>r.toString().localeCompare(s.toString());return n.length!==e.length?!1:(e.sort(t),n.sort(t).every((r,s)=>e[s].equals(r)))}const jF="libp2p-peer-record",$F=Uint8Array.from([3,1]);var Cf;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=Qe((s,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),s.multiaddr!=null&&s.multiaddr.byteLength>0&&(i.uint32(10),i.bytes(s.multiaddr)),a.lengthDelimited!==!1&&i.ldelim()},(s,i,a={})=>{const c={multiaddr:Fe(0)},u=i==null?s.len:s.pos+i;for(;s.pos<u;){const h=s.uint32();switch(h>>>3){case 1:{c.multiaddr=s.bytes();break}default:{s.skipType(h&7);break}}}return c})),r),t.encode=s=>Ge(s,t.codec()),t.decode=(s,i)=>We(s,t.codec(),i)})(n.AddressInfo||(n.AddressInfo={}));let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.peerId!=null&&t.peerId.byteLength>0&&(r.uint32(10),r.bytes(t.peerId)),t.seq!=null&&t.seq!==0n&&(r.uint32(16),r.uint64(t.seq)),t.addresses!=null)for(const i of t.addresses)r.uint32(26),n.AddressInfo.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={peerId:Fe(0),seq:0n,addresses:[]},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.peerId=t.bytes();break}case 2:{i.seq=t.uint64();break}case 3:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new qr('Decode error - map field "addresses" had too many elements');i.addresses.push(n.AddressInfo.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Cf||(Cf={}));class tr{static createFromProtobuf=e=>{const t=Cf.decode(e),r=Xr(jn(t.peerId)),s=(t.addresses??[]).map(a=>Pe(a.multiaddr)),i=t.seq;return new tr({peerId:r,multiaddrs:s,seqNumber:i})};static DOMAIN=jF;static CODEC=$F;peerId;multiaddrs;seqNumber;domain=tr.DOMAIN;codec=tr.CODEC;marshaled;constructor(e){const{peerId:t,multiaddrs:r,seqNumber:s}=e;this.peerId=t,this.multiaddrs=r??[],this.seqNumber=s??BigInt(Date.now())}marshal(){return this.marshaled==null&&(this.marshaled=Cf.encode({peerId:this.peerId.toMultihash().bytes,seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map(e=>({multiaddr:e.bytes}))})),this.marshaled}equals(e){return!(!(e instanceof tr)||!this.peerId.equals(e.peerId)||this.seqNumber!==e.seqNumber||!VF(this.multiaddrs,e.multiaddrs))}}function zF(n){return n[Symbol.asyncIterator]!=null}function kf(n){if(zF(n))return(async()=>{const t=[];for await(const r of n)t.push(r);return t})();const e=[];for(const t of n)e.push(t);return e}let Ja=class extends Error{static name="AbortError";name="AbortError";constructor(e="The operation was aborted",...t){super(e,...t)}};function Ke(){const n={};return n.promise=new Promise((e,t)=>{n.resolve=e,n.reject=t}),n}class y7{buffer;mask;top;btm;next;constructor(e){if(!(e>0)||(e-1&e)!==0)throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return this.buffer[this.top]!==void 0?!1:(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(e!==void 0)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return this.buffer[this.btm]===void 0}}class S2{size;hwm;head;tail;constructor(e={}){this.hwm=e.splitLimit??16,this.head=new y7(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return e?.byteLength!=null?e.byteLength:1}push(e){if(e?.value!=null&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new y7(2*this.head.buffer.length),this.head.push(e)}}shift(){let e=this.tail.shift();if(e===void 0&&this.tail.next!=null){const t=this.tail.next;this.tail.next=null,this.tail=t,e=this.tail.shift()}return e?.value!=null&&(this.size-=this.calculateSize(e.value)),e}isEmpty(){return this.head.isEmpty()}}let HF=class extends Error{type;code;constructor(e,t){super(e??"The operation was aborted"),this.type="aborted",this.code=t??"ABORT_ERR"}};function _i(n={}){return KF(t=>{const r=t.shift();if(r==null)return{done:!0};if(r.error!=null)throw r.error;return{done:r.done===!0,value:r.value}},n)}function KF(n,e){e=e??{};let t=e.onEnd,r=new S2,s,i,a,c=Ke();const u=async()=>{try{return r.isEmpty()?a?{done:!0}:await new Promise((E,A)=>{i=P=>{i=null,r.push(P);try{E(n(r))}catch(k){A(k)}return s}}):n(r)}finally{r.isEmpty()&&queueMicrotask(()=>{c.resolve(),c=Ke()})}},h=E=>i!=null?i(E):(r.push(E),s),f=E=>(r=new S2,i!=null?i({error:E}):(r.push({error:E}),s)),p=E=>{if(a)return s;if(e?.objectMode!==!0&&E?.byteLength==null)throw new Error("objectMode was not true but tried to push non-Uint8Array value");return h({done:!1,value:E})},m=E=>a?s:(a=!0,E!=null?f(E):h({done:!0})),w=()=>(r=new S2,m(),{done:!0}),x=E=>(m(E),{done:!0});if(s={[Symbol.asyncIterator](){return this},next:u,return:w,throw:x,push:p,end:m,get readableLength(){return r.size},onEmpty:async E=>{const A=E?.signal;if(A?.throwIfAborted(),r.isEmpty())return;let P,k;A!=null&&(P=new Promise((F,I)=>{k=()=>{I(new HF)},A.addEventListener("abort",k)}));try{await Promise.race([c.promise,P])}finally{k!=null&&A!=null&&A?.removeEventListener("abort",k)}}},t==null)return s;const S=s;return s={[Symbol.asyncIterator](){return this},next(){return S.next()},throw(E){return S.throw(E),t!=null&&(t(E),t=void 0),{done:!0}},return(){return S.return(),t!=null&&(t(),t=void 0),{done:!0}},push:p,end(E){return S.end(E),t!=null&&(t(E),t=void 0),s},get readableLength(){return S.readableLength},onEmpty:E=>S.onEmpty(E)},s}async function Ss(n,e,t,r){const s=new Ja(r?.errorMessage);r?.errorCode!=null&&(s.code=r.errorCode);const i=r?.errorEvent??"error";return t?.aborted===!0?Promise.reject(s):new Promise((a,c)=>{function u(){C2(t,"abort",p),C2(n,e,h),C2(n,i,f)}const h=m=>{try{if(r?.filter?.(m)===!1)return}catch(w){u(),c(w);return}u(),a(m)},f=m=>{if(u(),m instanceof Error){c(m);return}c(m.detail??r?.error??new Error(`The "${r?.errorEvent}" event was emitted but the event had no '.detail' field. Pass an 'error' option to race-event to change this message.`))},p=()=>{u(),c(s)};E2(t,"abort",p),E2(n,e,h),E2(n,i,f)})}function E2(n,e,t){n!=null&&(_x(n)?n.addEventListener(e,t):n.addListener(e,t))}function C2(n,e,t){n!=null&&(_x(n)?n.removeEventListener(e,t):n.removeListener(e,t))}function _x(n){return typeof n.addEventListener=="function"&&typeof n.removeEventListener=="function"}let qF=class extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}},w7=class extends Error{type;code;constructor(e,t,r){super(e??"The operation was aborted"),this.type="aborted",this.name=r??"AbortError",this.code=t??"ABORT_ERR"}};async function Dt(n,e,t){if(e==null)return n;if(e.aborted)return n.catch(()=>{}),Promise.reject(new w7(t?.errorMessage,t?.errorCode,t?.errorName));let r;const s=new w7(t?.errorMessage,t?.errorCode,t?.errorName);try{return await Promise.race([n,new Promise((i,a)=>{r=()=>{a(s)},e.addEventListener("abort",r)})])}finally{r!=null&&e.removeEventListener("abort",r)}}let WF=class{deferred;signal;constructor(e){this.signal=e,this.deferred=Promise.withResolvers(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new Ja)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}};function GF(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}let QF=class{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=GF(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>t&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new Ja),this.cleanup())}async join(e={}){const t=new WF(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Dt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}};function v7(n,e){let t;const r=function(){const s=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(s,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}let b7=class extends ln{concurrency;maxSize;queue;pending;sort;autoStart;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,this.autoStart=e.autoStart??!0,this.sort=e.sort,this.queue=[],this.emitEmpty=v7(this.emitEmpty.bind(this),1),this.emitIdle=v7(this.emitIdle.bind(this),1)}[Symbol.asyncIterator](){return this.toGenerator()}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.safeDispatchEvent("next"),this.autoStart&&this.tryToStartAnother()}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}start(){this.autoStart===!1&&(this.autoStart=!0,this.tryToStartAnother())}pause(){this.autoStart=!1}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new qF;const r=new QF(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.autoStart&&this.tryToStartAnother(),r.join(t).then(s=>(this.safeDispatchEvent("success",{detail:{job:r,result:s}}),s)).catch(s=>{if(r.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===r){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("failure",{detail:{job:r,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new Ja)}),this.clear()}async onEmpty(e){this.size!==0&&await Ss(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Ss(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Ss(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=_i({objectMode:!0}),r=u=>{u!=null?this.abort():this.clear(),t.end(u)},s=u=>{u.detail!=null&&t.push(u.detail.result)},i=u=>{r(u.detail.error)},a=()=>{r()},c=()=>{r(new Ja("Queue aborted"))};this.addEventListener("success",s),this.addEventListener("failure",i),this.addEventListener("idle",a),e?.signal?.addEventListener("abort",c);try{yield*t}finally{this.removeEventListener("success",s),this.removeEventListener("failure",i),this.removeEventListener("idle",a),e?.signal?.removeEventListener("abort",c),r()}}};const Dx="lock:worker:request-read",Ix="lock:worker:abort-read-request",Nx="lock:worker:release-read",Mx="lock:master:grant-read",Rx="lock:master:error-read",Lx="lock:worker:request-write",Ox="lock:worker:abort-write-request",Bx="lock:worker:release-write",Fx="lock:master:grant-write",Ux="lock:master:error-write",Vx="lock:worker:finalize",jx="mortice",YF={singleProcess:!1},x7=(n,e,t,r,s,i,a,c,u)=>h=>{if(h.data==null)return;const f={type:h.data.type,name:h.data.name,identifier:h.data.identifier};f.type===s&&n.safeDispatchEvent(t,{detail:{name:f.name,identifier:f.identifier,handler:async()=>{e.postMessage({type:u,name:f.name,identifier:f.identifier}),await new Promise(p=>{const m=w=>{if(w?.data==null)return;const x={type:w.data.type,name:w.data.name,identifier:w.data.identifier};x.type===c&&x.identifier===f.identifier&&(e.removeEventListener("message",m),p())};e.addEventListener("message",m)})},onError:p=>{e.postMessage({type:a,name:f.name,identifier:f.identifier,error:{message:p.message,name:p.name,stack:p.stack}})}}}),f.type===i&&n.safeDispatchEvent(r,{detail:{name:f.name,identifier:f.identifier}}),f.type===Vx&&n.safeDispatchEvent("finalizeRequest",{detail:{name:f.name}})},XF=(n=10)=>Math.random().toString().substring(2,n+2);class JF{name;channel;constructor(e){this.name=e,this.channel=new BroadcastChannel(jx)}readLock(e){return this.sendRequest(Dx,Ix,Mx,Rx,Nx,e)}writeLock(e){return this.sendRequest(Lx,Ox,Fx,Ux,Bx,e)}finalize(){this.channel.postMessage({type:Vx,name:this.name}),this.channel.close()}async sendRequest(e,t,r,s,i,a){a?.signal?.throwIfAborted();const c=XF();return this.channel.postMessage({type:e,identifier:c,name:this.name}),new Promise((u,h)=>{const f=()=>{this.channel.postMessage({type:t,identifier:c,name:this.name})};a?.signal?.addEventListener("abort",f,{once:!0});const p=m=>{if(m.data?.identifier===c&&(m.data?.type===r&&(this.channel.removeEventListener("message",p),a?.signal?.removeEventListener("abort",f),u(()=>{this.channel.postMessage({type:i,identifier:c,name:this.name})})),m.data.type===s)){this.channel.removeEventListener("message",p),a?.signal?.removeEventListener("abort",f);const w=new Error;m.data.error!=null&&(w.message=m.data.error.message,w.name=m.data.error.name,w.stack=m.data.error.stack),h(w)}};this.channel.addEventListener("message",p)})}}const ZF=n=>{if(n=Object.assign({},YF,n),!!globalThis.document||n.singleProcess){const t=new BroadcastChannel(jx),r=new ln;return t.addEventListener("message",x7(r,t,"requestReadLock","abortReadLockRequest",Dx,Ix,Rx,Nx,Mx)),t.addEventListener("message",x7(r,t,"requestWriteLock","abortWriteLockRequest",Lx,Ox,Ux,Bx,Fx)),r}return new JF(n.name)},no=new Map;let Ec;function $x(n){return typeof n?.readLock=="function"&&typeof n?.writeLock=="function"}function eU(n){if(Ec==null&&(Ec=ZF(n),!$x(Ec))){const e=Ec;e.addEventListener("requestReadLock",t=>{const r=t.detail.name,s=t.detail.identifier,i=no.get(r);if(i==null)return;const a=new AbortController,c=u=>{u.detail.name!==r||u.detail.identifier!==s||a.abort()};e.addEventListener("abortReadLockRequest",c),i.readLock({signal:a.signal}).then(async u=>{await t.detail.handler().finally(()=>{u()})}).catch(u=>{t.detail.onError(u)}).finally(()=>{e.removeEventListener("abortReadLockRequest",c)})}),e.addEventListener("requestWriteLock",t=>{const r=t.detail.name,s=t.detail.identifier,i=no.get(r);if(i==null)return;const a=new AbortController,c=u=>{u.detail.name!==r||u.detail.identifier!==s||a.abort()};e.addEventListener("abortWriteLockRequest",c),i.writeLock({signal:a.signal}).then(async u=>{await t.detail.handler().finally(()=>{u()})}).catch(u=>{t.detail.onError(u)}).finally(()=>{e.removeEventListener("abortWriteLockRequest",c)})}),e.addEventListener("finalizeRequest",t=>{const r=t.detail.name,s=no.get(r);s?.finalize()})}return Ec}async function k2(n,e){let t,r;const s=new Promise((a,c)=>{t=a,r=c}),i=()=>{r(new Ja)};return e?.signal?.addEventListener("abort",i,{once:!0}),n.add(async()=>{await new Promise(a=>{t(()=>{e?.signal?.removeEventListener("abort",i),a()})})},{signal:e?.signal}).catch(a=>{r(a)}),s}const tU=(n,e)=>{let t=no.get(n);if(t!=null)return t;const r=eU(e);if($x(r))return t=r,no.set(n,t),t;const s=new b7({concurrency:1});let i;return t={async readLock(a){if(i!=null)return k2(i,a);i=new b7({concurrency:e.concurrency,autoStart:!1});const c=i,u=k2(i,a);return s.add(async()=>{c.start(),await c.onIdle().then(()=>{i===c&&(i=null)})}),u},async writeLock(a){return i=null,k2(s,a)},finalize:()=>{no.delete(n)},queue:s},no.set(n,t),e.autoFinalize===!0&&s.addEventListener("idle",()=>{t.finalize()},{once:!0}),t},nU={name:"lock",concurrency:1/0,singleProcess:!1,autoFinalize:!1};function rU(n){const e=Object.assign({},nU,n);return tU(e.name,e)}const sU=36e5,iU=216e5;var ro;(function(n){(function(t){let r;t.codec=()=>(r==null&&(r=Qe((s,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&s.value.byteLength>0&&(i.uint32(18),i.bytes(s.value)),a.lengthDelimited!==!1&&i.ldelim()},(s,i,a={})=>{const c={key:"",value:Fe(0)},u=i==null?s.len:s.pos+i;for(;s.pos<u;){const h=s.uint32();switch(h>>>3){case 1:{c.key=s.string();break}case 2:{c.value=s.bytes();break}default:{s.skipType(h&7);break}}}return c})),r),t.encode=s=>Ge(s,t.codec()),t.decode=(s,i)=>We(s,t.codec(),i)})(n.Peer$metadataEntry||(n.Peer$metadataEntry={})),function(t){let r;t.codec=()=>(r==null&&(r=Qe((s,i,a={})=>{a.lengthDelimited!==!1&&i.fork(),s.key!=null&&s.key!==""&&(i.uint32(10),i.string(s.key)),s.value!=null&&(i.uint32(18),Pf.codec().encode(s.value,i)),a.lengthDelimited!==!1&&i.ldelim()},(s,i,a={})=>{const c={key:""},u=i==null?s.len:s.pos+i;for(;s.pos<u;){const h=s.uint32();switch(h>>>3){case 1:{c.key=s.string();break}case 2:{c.value=Pf.codec().decode(s,s.uint32(),{limits:a.limits?.value});break}default:{s.skipType(h&7);break}}}return c})),r),t.encode=s=>Ge(s,t.codec()),t.decode=(s,i)=>We(s,t.codec(),i)}(n.Peer$tagsEntry||(n.Peer$tagsEntry={}));let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.addresses!=null)for(const i of t.addresses)r.uint32(10),Af.codec().encode(i,r);if(t.protocols!=null)for(const i of t.protocols)r.uint32(18),r.string(i);if(t.publicKey!=null&&(r.uint32(34),r.bytes(t.publicKey)),t.peerRecordEnvelope!=null&&(r.uint32(42),r.bytes(t.peerRecordEnvelope)),t.metadata!=null&&t.metadata.size!==0)for(const[i,a]of t.metadata.entries())r.uint32(50),n.Peer$metadataEntry.codec().encode({key:i,value:a},r);if(t.tags!=null&&t.tags.size!==0)for(const[i,a]of t.tags.entries())r.uint32(58),n.Peer$tagsEntry.codec().encode({key:i,value:a},r);t.updated!=null&&(r.uint32(64),r.uint64Number(t.updated)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={addresses:[],protocols:[],metadata:new Map,tags:new Map},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{if(s.limits?.addresses!=null&&i.addresses.length===s.limits.addresses)throw new qr('Decode error - map field "addresses" had too many elements');i.addresses.push(Af.codec().decode(t,t.uint32(),{limits:s.limits?.addresses$}));break}case 2:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new qr('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 4:{i.publicKey=t.bytes();break}case 5:{i.peerRecordEnvelope=t.bytes();break}case 6:{if(s.limits?.metadata!=null&&i.metadata.size===s.limits.metadata)throw new e7('Decode error - map field "metadata" had too many elements');const u=n.Peer$metadataEntry.codec().decode(t,t.uint32());i.metadata.set(u.key,u.value);break}case 7:{if(s.limits?.tags!=null&&i.tags.size===s.limits.tags)throw new e7('Decode error - map field "tags" had too many elements');const u=n.Peer$tagsEntry.codec().decode(t,t.uint32(),{limits:{value:s.limits?.tags$value}});i.tags.set(u.key,u.value);break}case 8:{i.updated=t.uint64Number();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(ro||(ro={}));var Af;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.multiaddr!=null&&t.multiaddr.byteLength>0&&(r.uint32(10),r.bytes(t.multiaddr)),t.isCertified!=null&&(r.uint32(16),r.bool(t.isCertified)),t.observed!=null&&(r.uint32(24),r.uint64Number(t.observed)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={multiaddr:Fe(0)},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.multiaddr=t.bytes();break}case 2:{i.isCertified=t.bool();break}case 3:{i.observed=t.uint64Number();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Af||(Af={}));var Pf;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.value!=null&&t.value!==0&&(r.uint32(8),r.uint32(t.value)),t.expiry!=null&&(r.uint32(16),r.uint64(t.expiry)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={value:0},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.value=t.uint32();break}case 2:{i.expiry=t.uint64();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Pf||(Pf={}));function oU(n,e){if(n.publicKey!=null||e.publicKey==null)return n;let t;n.type==="RSA"&&(t=n.toMultihash());const r=Do(e.publicKey,t);return v1(r)}function aU(n,e,t){const r=ro.decode(e);return Dc(n,r,t)}function Dc(n,e,t){const r=new Map,s=BigInt(Date.now());for(const[i,a]of e.tags.entries())a.expiry!=null&&a.expiry<s||r.set(i,a);return{...e,id:oU(n,e),addresses:e.addresses.filter(({observed:i})=>i!=null&&i>Date.now()-t).map(({multiaddr:i,isCertified:a})=>({multiaddr:Pe(i),isCertified:a??!1})),metadata:e.metadata,peerRecordEnvelope:e.peerRecordEnvelope??void 0,tags:r}}function lU(n,e){return cU(n.addresses,e.addresses)&&uU(n.protocols,e.protocols)&&dU(n.publicKey,e.publicKey)&&hU(n.peerRecordEnvelope,e.peerRecordEnvelope)&&fU(n.metadata,e.metadata)&&pU(n.tags,e.tags)}function cU(n,e){return Hx(n,e,(t,r)=>!(t.isCertified!==r.isCertified||!Ve(t.multiaddr,r.multiaddr)))}function uU(n,e){return Hx(n,e,(t,r)=>t===r)}function dU(n,e){return zx(n,e)}function hU(n,e){return zx(n,e)}function fU(n,e){return Kx(n,e,(t,r)=>Ve(t,r))}function pU(n,e){return Kx(n,e,(t,r)=>t.value===r.value&&t.expiry===r.expiry)}function zx(n,e){return n==null&&e==null?!0:n!=null&&e!=null?Ve(n,e):!1}function Hx(n,e,t){if(n.length!==e.length)return!1;for(let r=0;r<n.length;r++)if(!t(n[r],e[r]))return!1;return!0}function Kx(n,e,t){if(n.size!==e.size)return!1;for(const[r,s]of n.entries()){const i=e.get(r);if(i==null||!t(s,i))return!1}return!0}const us="/",qx=new TextEncoder().encode(us),Ph=qx[0];class zt{_buf;constructor(e,t){if(typeof e=="string")this._buf=we(e);else if(e instanceof Uint8Array)this._buf=e;else throw new Error("Invalid key, should be String of Uint8Array");if(t==null&&(t=!0),t&&this.clean(),this._buf.byteLength===0||this._buf[0]!==Ph)throw new Error("Invalid key")}toString(e="utf8"){return pe(this._buf,e)}uint8Array(){return this._buf}get[Symbol.toStringTag](){return`Key(${this.toString()})`}static withNamespaces(e){return new zt(e.join(us))}static random(){return new zt(Math.random().toString().substring(2))}static asKey(e){return e instanceof Uint8Array||typeof e=="string"?new zt(e):typeof e.uint8Array=="function"?new zt(e.uint8Array()):null}clean(){if((this._buf==null||this._buf.byteLength===0)&&(this._buf=qx),this._buf[0]!==Ph){const e=new Uint8Array(this._buf.byteLength+1);e.fill(Ph,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===Ph;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),r=e.list();for(let s=0;s<t.length;s++){if(r.length<s+1)return!1;const i=t[s],a=r[s];if(i<a)return!0;if(i>a)return!1}return t.length<r.length}reverse(){return zt.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(us).slice(1)}type(){return gU(this.baseNamespace())}name(){return mU(this.baseNamespace())}instance(e){return new zt(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(us)||(e+=us),e+=this.type(),new zt(e)}parent(){const e=this.list();return e.length===1?new zt(us):new zt(e.slice(0,-1).join(us))}child(e){return this.toString()===us?e:e.toString()===us?this:new zt(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()===this.toString()?!1:e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()===this.toString()?!1:this.toString().startsWith(e.toString())}isTopLevel(){return this.list().length===1}concat(...e){return zt.withNamespaces([...this.namespaces(),...yU(e.map(t=>t.namespaces()))])}}function gU(n){const e=n.split(":");return e.length<2?"":e.slice(0,-1).join(":")}function mU(n){const e=n.split(":");return e[e.length-1]}function yU(n){return[].concat(...n)}const Wx="/peers/";function Th(n){if(!Bc(n)||n.type==null)throw new Ae("Invalid PeerId");const e=n.toCID().toString();return new zt(`${Wx}${e}`)}async function wU(n,e,t,r,s){const i=new Map;for(const a of t){if(a==null)continue;if(a.multiaddr instanceof Uint8Array&&(a.multiaddr=Pe(a.multiaddr)),!S1(a.multiaddr))throw new Ae("Multiaddr was invalid");if(!await e(n,a.multiaddr,s))continue;const c=a.isCertified??!1,u=a.multiaddr.toString(),h=i.get(u);h!=null?a.isCertified=h.isCertified||c:i.set(u,{multiaddr:a.multiaddr,isCertified:c})}return[...i.values()].sort((a,c)=>a.multiaddr.toString().localeCompare(c.multiaddr.toString())).map(({isCertified:a,multiaddr:c})=>{const u=c.getPeerId();return n.equals(u)&&(c=c.decapsulate(Pe(`/p2p/${n}`))),{isCertified:a,multiaddr:c.bytes}})}async function A2(n,e,t,r){if(e==null)throw new Ae("Invalid PeerData");if(e.publicKey!=null&&n.publicKey!=null&&!e.publicKey.equals(n.publicKey))throw new Ae("publicKey bytes do not match peer id publicKey bytes");const s=r.existingPeer?.peer;if(s!=null&&!n.equals(s.id))throw new Ae("peer id did not match existing peer id");let i=s?.addresses??[],a=new Set(s?.protocols??[]),c=s?.metadata??new Map,u=s?.tags??new Map,h=s?.peerRecordEnvelope;if(t==="patch"){if((e.multiaddrs!=null||e.addresses!=null)&&(i=[],e.multiaddrs!=null&&i.push(...e.multiaddrs.map(m=>({isCertified:!1,multiaddr:m}))),e.addresses!=null&&i.push(...e.addresses)),e.protocols!=null&&(a=new Set(e.protocols)),e.metadata!=null){const m=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);c=_h(m,{validate:S7})}if(e.tags!=null){const m=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags);u=_h(m,{validate:E7,map:C7})}e.peerRecordEnvelope!=null&&(h=e.peerRecordEnvelope)}if(t==="merge"){if(e.multiaddrs!=null&&i.push(...e.multiaddrs.map(m=>({isCertified:!1,multiaddr:m}))),e.addresses!=null&&i.push(...e.addresses),e.protocols!=null&&(a=new Set([...a,...e.protocols])),e.metadata!=null){const m=e.metadata instanceof Map?[...e.metadata.entries()]:Object.entries(e.metadata);for(const[w,x]of m)x==null?c.delete(w):c.set(w,x);c=_h([...c.entries()],{validate:S7})}if(e.tags!=null){const m=e.tags instanceof Map?[...e.tags.entries()]:Object.entries(e.tags),w=new Map(u);for(const[x,S]of m)S==null?w.delete(x):w.set(x,S);u=_h([...w.entries()],{validate:E7,map:C7})}e.peerRecordEnvelope!=null&&(h=e.peerRecordEnvelope)}let f;s?.id.publicKey!=null?f=ws(s.id.publicKey):e.publicKey!=null?f=ws(e.publicKey):n.publicKey!=null&&(f=ws(n.publicKey));const p={addresses:await wU(n,r.addressFilter??(async()=>!0),i,r.existingPeer?.peerPB.addresses,r),protocols:[...a.values()].sort((m,w)=>m.localeCompare(w)),metadata:c,tags:u,publicKey:f,peerRecordEnvelope:h};return p.addresses.forEach(m=>{m.observed=r.existingPeer?.peerPB.addresses?.find(w=>Ve(w.multiaddr,w.multiaddr))?.observed??Date.now()}),n.type!=="RSA"&&delete p.publicKey,p}function _h(n,e){const t=new Map;for(const[r,s]of n)s!=null&&e.validate(r,s);for(const[r,s]of n.sort(([i],[a])=>i.localeCompare(a)))s!=null&&t.set(r,e.map?.(r,s)??s);return t}function S7(n,e){if(typeof n!="string")throw new Ae("Metadata key must be a string");if(!(e instanceof Uint8Array))throw new Ae("Metadata value must be a Uint8Array")}function E7(n,e){if(typeof n!="string")throw new Ae("Tag name must be a string");if(e.value!=null){if(parseInt(`${e.value}`,10)!==e.value)throw new Ae("Tag value must be an integer");if(e.value<0||e.value>100)throw new Ae("Tag value must be between 0-100")}if(e.ttl!=null){if(parseInt(`${e.ttl}`,10)!==e.ttl)throw new Ae("Tag ttl must be an integer");if(e.ttl<0)throw new Ae("Tag ttl must be between greater than 0")}}function C7(n,e){let t;e.expiry!=null&&(t=e.expiry),e.ttl!=null&&(t=BigInt(Date.now()+Number(e.ttl)));const r={value:e.value??0};return t!=null&&(r.expiry=t),r}function Gx(n){const e=n.toString().split("/")[2],t=Be.parse(e,gi);return ju(t)}function P2(n,e,t){const r=Gx(n);return aU(r,e,t)}function vU(n,e){return{prefix:Wx,filters:(n.filters??[]).map(t=>({key:r,value:s})=>t(P2(r,s,e))),orders:(n.orders??[]).map(t=>(r,s)=>t(P2(r.key,r.value,e),P2(s.key,s.value,e)))}}class bU{peerId;datastore;locks;addressFilter;log;maxAddressAge;maxPeerAge;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.locks=Tx({name:"libp2p_peer_store_locks",metrics:e.metrics}),this.maxAddressAge=t.maxAddressAge??sU,this.maxPeerAge=t.maxPeerAge??iU}getLock(e){let t=this.locks.get(e);return t==null&&(t={refs:0,lock:rU({name:e.toString(),singleProcess:!0})},this.locks.set(e,t)),t.refs++,t}maybeRemoveLock(e,t){t.refs--,t.refs===0&&(t.lock.finalize(),this.locks.delete(e))}async getReadLock(e,t){const r=this.getLock(e);try{const s=await r.lock.readLock(t);return()=>{s(),this.maybeRemoveLock(e,r)}}catch(s){throw this.maybeRemoveLock(e,r),s}}async getWriteLock(e,t){const r=this.getLock(e);try{const s=await r.lock.writeLock(t);return()=>{s(),this.maybeRemoveLock(e,r)}}catch(s){throw this.maybeRemoveLock(e,r),s}}async has(e,t){try{return await this.load(e,t),!0}catch(r){if(r.name!=="NotFoundError")throw r}return!1}async delete(e,t){this.peerId.equals(e)||await this.datastore.delete(Th(e),t)}async load(e,t){const r=Th(e),s=await this.datastore.get(r,t),i=ro.decode(s);if(this.#t(e,i))throw await this.datastore.delete(r,t),new Si;return Dc(e,i,this.peerId.equals(e)?1/0:this.maxAddressAge)}async save(e,t,r){const s=await this.#e(e,r),i=await A2(e,t,"patch",{...r,addressFilter:this.addressFilter});return this.#n(e,i,s)}async patch(e,t,r){const s=await this.#e(e,r),i=await A2(e,t,"patch",{...r,addressFilter:this.addressFilter,existingPeer:s});return this.#n(e,i,s)}async merge(e,t,r){const s=await this.#e(e,r),i=await A2(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:s});return this.#n(e,i,s)}async*all(e){for await(const{key:t,value:r}of this.datastore.query(vU(e??{},this.maxAddressAge),e)){const s=Gx(t);if(s.equals(this.peerId))continue;const i=ro.decode(r);if(this.#t(s,i)){await this.datastore.delete(t,e);continue}yield Dc(s,i,this.peerId.equals(s)?1/0:this.maxAddressAge)}}async#e(e,t){try{const r=Th(e),s=await this.datastore.get(r,t),i=ro.decode(s);if(this.#t(e,i))throw await this.datastore.delete(r,t),new Si;return{peerPB:i,peer:Dc(e,i,this.maxAddressAge)}}catch(r){r.name!=="NotFoundError"&&this.log.error("invalid peer data found in peer store - %e",r)}}async#n(e,t,r,s){t.updated=Date.now();const i=ro.encode(t);return await this.datastore.put(Th(e),i,s),{peer:Dc(e,t,this.maxAddressAge),previous:r?.peer,updated:r==null||!lU(t,r.peerPB)}}#t(e,t){if(t.updated==null)return!0;if(this.peerId.equals(e))return!1;const r=t.updated<Date.now()-this.maxPeerAge,s=Date.now()-this.maxAddressAge,i=t.addresses.filter(a=>a.observed!=null&&a.observed>s);return r&&i.length===0}}class xU{store;events;peerId;log;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new bU(e,t)}[Symbol.toStringTag]="@libp2p/peer-store";async forEach(e,t){for await(const r of this.store.all(t))e(r)}async all(e){return kf(this.store.all(e))}async delete(e,t){const r=await this.store.getReadLock(e,t);try{await this.store.delete(e,t)}finally{r()}}async has(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.has(e,t)}finally{this.log.trace("has release read lock"),r?.()}}async get(e,t){const r=await this.store.getReadLock(e,t);try{return await this.store.load(e,t)}finally{r?.()}}async getInfo(e,t){const r=await this.get(e,t);return{id:r.id,multiaddrs:r.addresses.map(({multiaddr:s})=>s)}}async save(e,t,r){const s=await this.store.getWriteLock(e,r);try{const i=await this.store.save(e,t,r);return this.#e(e,i),i.peer}finally{s?.()}}async patch(e,t,r){const s=await this.store.getWriteLock(e,r);try{const i=await this.store.patch(e,t,r);return this.#e(e,i),i.peer}finally{s?.()}}async merge(e,t,r){const s=await this.store.getWriteLock(e,r);try{const i=await this.store.merge(e,t,r);return this.#e(e,i),i.peer}finally{s?.()}}async consumePeerRecord(e,t,r){const s=Bc(t)?t:Bc(t?.expectedPeer)?t.expectedPeer:void 0,i=Bc(t)||t===void 0?r:t,a=await xs.openAndCertify(e,tr.DOMAIN,i),c=ju(a.publicKey.toCID());if(s?.equals(c)===!1)return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",s,c),!1;const u=tr.createFromProtobuf(a.payload);let h;try{h=await this.get(c,i)}catch(f){if(f.name!=="NotFoundError")throw f}if(h?.peerRecordEnvelope!=null){const f=xs.createFromProtobuf(h.peerRecordEnvelope),p=tr.createFromProtobuf(f.payload);if(p.seqNumber>=u.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",p.seqNumber,u.seqNumber),!1}return await this.patch(u.peerId,{peerRecordEnvelope:e,addresses:u.multiaddrs.map(f=>({isCertified:!0,multiaddr:f}))},i),!0}#e(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}}function SU(n,e={}){return new xU(n,e)}class Tf extends Error{static name="NotFoundError";static code="ERR_NOT_FOUND";name=Tf.name;code=Tf.code;constructor(e="Not Found"){super(e)}}function EU(n){return n[Symbol.asyncIterator]!=null}function au(n){if(EU(n))return(async()=>{for await(const e of n);})();for(const e of n);}function y3(n){const[e,t]=n[Symbol.asyncIterator]!=null?[n[Symbol.asyncIterator](),Symbol.asyncIterator]:[n[Symbol.iterator](),Symbol.iterator],r=[];return{peek:()=>e.next(),push:s=>{r.push(s)},next:()=>r.length>0?{done:!1,value:r.shift()}:e.next(),[t](){return this}}}function CU(n){return n[Symbol.asyncIterator]!=null}function pa(n,e){let t=0;if(CU(n))return async function*(){for await(const u of n)await e(u,t++)&&(yield u)}();const r=y3(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const a=e(s,t++);if(typeof a.then=="function")return async function*(){await a&&(yield s);for(const u of r)await e(u,t++)&&(yield u)}();const c=e;return function*(){a===!0&&(yield s);for(const u of r)c(u,t++)&&(yield u)}()}function kU(n){return n[Symbol.asyncIterator]!=null}function k7(n,e){return kU(n)?async function*(){yield*(await kf(n)).sort(e)}():function*(){yield*kf(n).sort(e)}()}function AU(n){return n[Symbol.asyncIterator]!=null}function Bg(n,e){return AU(n)?async function*(){let t=0;if(!(e<1)){for await(const r of n)if(yield r,t++,t===e)return}}():function*(){let t=0;if(!(e<1)){for(const r of n)if(yield r,t++,t===e)return}}()}class PU{put(e,t,r){return Promise.reject(new Error(".put is not implemented"))}get(e,t){return Promise.reject(new Error(".get is not implemented"))}has(e,t){return Promise.reject(new Error(".has is not implemented"))}delete(e,t){return Promise.reject(new Error(".delete is not implemented"))}async*putMany(e,t={}){for await(const{key:r,value:s}of e)await this.put(r,s,t),yield r}async*getMany(e,t={}){for await(const r of e)yield{key:r,value:await this.get(r,t)}}async*deleteMany(e,t={}){for await(const r of e)await this.delete(r,t),yield r}batch(){let e=[],t=[];return{put(r,s){e.push({key:r,value:s})},delete(r){t.push(r)},commit:async r=>{await au(this.putMany(e,r)),e=[],await au(this.deleteMany(t,r)),t=[]}}}async*_all(e,t){throw new Error("._all is not implemented")}async*_allKeys(e,t){throw new Error("._allKeys is not implemented")}query(e,t){let r=this._all(e,t);if(e.prefix!=null){const s=e.prefix;r=pa(r,i=>i.key.toString().startsWith(s))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>pa(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>k7(s,i),r)),e.offset!=null){let s=0;const i=e.offset;r=pa(r,()=>s++>=i)}return e.limit!=null&&(r=Bg(r,e.limit)),r}queryKeys(e,t){let r=this._allKeys(e,t);if(e.prefix!=null){const s=e.prefix;r=pa(r,i=>i.toString().startsWith(s))}if(Array.isArray(e.filters)&&(r=e.filters.reduce((s,i)=>pa(s,i),r)),Array.isArray(e.orders)&&(r=e.orders.reduce((s,i)=>k7(s,i),r)),e.offset!=null){const s=e.offset;let i=0;r=pa(r,()=>i++>=s)}return e.limit!=null&&(r=Bg(r,e.limit)),r}}class TU extends PU{data;constructor(){super(),this.data=new Map}put(e,t,r){return r?.signal?.throwIfAborted(),this.data.set(e.toString(),t),e}get(e,t){t?.signal?.throwIfAborted();const r=this.data.get(e.toString());if(r==null)throw new Tf;return r}has(e,t){return t?.signal?.throwIfAborted(),this.data.has(e.toString())}delete(e,t){t?.signal?.throwIfAborted(),this.data.delete(e.toString())}*_all(e,t){t?.signal?.throwIfAborted();for(const[r,s]of this.data.entries())yield{key:new zt(r),value:s},t?.signal?.throwIfAborted()}*_allKeys(e,t){t?.signal?.throwIfAborted();for(const r of this.data.keys())yield new zt(r),t?.signal?.throwIfAborted()}}function Fg(n,e){let t;const r=function(){const s=function(){t=void 0,n()};clearTimeout(t),t=setTimeout(s,e)};return r.start=()=>{},r.stop=()=>{clearTimeout(t)},r}var ga={},A7;function _U(){return A7||(A7=1,(function(){var n,e,t,r,s,i,a,c;c=function(u){var h,f,p,m;return h=(u&255<<24)>>>24,f=(u&255<<16)>>>16,p=(u&65280)>>>8,m=u&255,[h,f,p,m].join(".")},a=function(u){var h,f,p,m,w,x;for(h=[],p=m=0;m<=3&&u.length!==0;p=++m){if(p>0){if(u[0]!==".")throw new Error("Invalid IP");u=u.substring(1)}x=e(u),w=x[0],f=x[1],u=u.substring(f),h.push(w)}if(u.length!==0)throw new Error("Invalid IP");switch(h.length){case 1:if(h[0]>4294967295)throw new Error("Invalid IP");return h[0]>>>0;case 2:if(h[0]>255||h[1]>16777215)throw new Error("Invalid IP");return(h[0]<<24|h[1])>>>0;case 3:if(h[0]>255||h[1]>255||h[2]>65535)throw new Error("Invalid IP");return(h[0]<<24|h[1]<<16|h[2])>>>0;case 4:if(h[0]>255||h[1]>255||h[2]>255||h[3]>255)throw new Error("Invalid IP");return(h[0]<<24|h[1]<<16|h[2]<<8|h[3])>>>0;default:throw new Error("Invalid IP")}},t=function(u){return u.charCodeAt(0)},r=t("0"),i=t("a"),s=t("A"),e=function(u){var h,f,p,m,w;for(m=0,h=10,f="9",p=0,u.length>1&&u[p]==="0"&&(u[p+1]==="x"||u[p+1]==="X"?(p+=2,h=16):"0"<=u[p+1]&&u[p+1]<="9"&&(p++,h=8,f="7")),w=p;p<u.length;){if("0"<=u[p]&&u[p]<=f)m=m*h+(t(u[p])-r)>>>0;else if(h===16)if("a"<=u[p]&&u[p]<="f")m=m*h+(10+t(u[p])-i)>>>0;else if("A"<=u[p]&&u[p]<="F")m=m*h+(10+t(u[p])-s)>>>0;else break;else break;if(m>4294967295)throw new Error("too large");p++}if(p===w)throw new Error("empty octet");return[m,p]},n=function(){function u(h,f){var p,m,w;if(typeof h!="string")throw new Error("Missing `net' parameter");if(f||(w=h.split("/",2),h=w[0],f=w[1]),f||(f=32),typeof f=="string"&&f.indexOf(".")>-1){try{this.maskLong=a(f)}catch{throw new Error("Invalid mask: "+f)}for(p=m=32;m>=0;p=--m)if(this.maskLong===4294967295<<32-p>>>0){this.bitmask=p;break}}else if(f||f===0)this.bitmask=parseInt(f,10),this.maskLong=0,this.bitmask>0&&(this.maskLong=4294967295<<32-this.bitmask>>>0);else throw new Error("Invalid mask: empty");try{this.netLong=(a(h)&this.maskLong)>>>0}catch{throw new Error("Invalid net address: "+h)}if(!(this.bitmask<=32))throw new Error("Invalid mask for ip4: "+f);this.size=Math.pow(2,32-this.bitmask),this.base=c(this.netLong),this.mask=c(this.maskLong),this.hostmask=c(~this.maskLong),this.first=this.bitmask<=30?c(this.netLong+1):this.base,this.last=this.bitmask<=30?c(this.netLong+this.size-2):c(this.netLong+this.size-1),this.broadcast=this.bitmask<=30?c(this.netLong+this.size-1):void 0}return u.prototype.contains=function(h){return typeof h=="string"&&(h.indexOf("/")>0||h.split(".").length!==4)&&(h=new u(h)),h instanceof u?this.contains(h.base)&&this.contains(h.broadcast||h.last):(a(h)&this.maskLong)>>>0===(this.netLong&this.maskLong)>>>0},u.prototype.next=function(h){return h==null&&(h=1),new u(c(this.netLong+this.size*h),this.mask)},u.prototype.forEach=function(h){var f,p,m;for(m=a(this.first),p=a(this.last),f=0;m<=p;)h(c(m),m,f),f++,m++},u.prototype.toString=function(){return this.base+"/"+this.bitmask},u}(),ga.ip2long=a,ga.long2ip=c,ga.Netmask=n}).call(ga)),ga}var DU=_U();const IU=["0.0.0.0/8","10.0.0.0/8","100.64.0.0/10","127.0.0.0/8","169.254.0.0/16","172.16.0.0/12","192.0.0.0/24","192.0.0.0/29","192.0.0.8/32","192.0.0.9/32","192.0.0.10/32","192.0.0.170/32","192.0.0.171/32","192.0.2.0/24","192.31.196.0/24","192.52.193.0/24","192.88.99.0/24","192.168.0.0/16","192.175.48.0/24","198.18.0.0/15","198.51.100.0/24","203.0.113.0/24","240.0.0.0/4","255.255.255.255/32"],NU=IU.map(n=>new DU.Netmask(n));function w3(n){for(const e of NU)if(e.contains(n))return!0;return!1}function MU(n){return/^::ffff:([0-9a-fA-F]{1,4}):([0-9a-fA-F]{1,4})$/.test(n)}function RU(n){const e=n.split(":");if(e.length<2)return!1;const t=e[e.length-1].padStart(4,"0"),r=e[e.length-2].padStart(4,"0"),s=`${parseInt(r.substring(0,2),16)}.${parseInt(r.substring(2),16)}.${parseInt(t.substring(0,2),16)}.${parseInt(t.substring(2),16)}`;return w3(s)}function LU(n){return/^::ffff:([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)}function OU(n){const e=n.split(":"),t=e[e.length-1];return w3(t)}function BU(n){return/^::$/.test(n)||/^::1$/.test(n)||/^64:ff9b::([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/.test(n)||/^100::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001::([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:2[0-9a-fA-F]:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2001:db8:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^2002:([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4}):?([0-9a-fA-F]{0,4})$/.test(n)||/^f[c-d]([0-9a-fA-F]{2,2}):/i.test(n)||/^fe[8-9a-bA-B][0-9a-fA-F]:/i.test(n)||/^ff([0-9a-fA-F]{2,2}):/i.test(n)}function bl(n){if(Wa(n))return w3(n);if(MU(n))return RU(n);if(LU(n))return OU(n);if(cx(n))return BU(n)}const et=n=>({match:e=>{const t=e[0];return t==null||t.code!==n||t.value!=null?!1:e.slice(1)}}),Ce=(n,e)=>({match:t=>{const r=t[0];return r?.code!==n||r.value==null||e!=null&&r.value!==e?!1:t.slice(1)}}),Ue=n=>({match:e=>{const t=n.match(e);return t===!1?e:t}}),pn=(...n)=>({match:e=>{let t;for(const r of n){const s=r.match(e);s!==!1&&(t==null||s.length<t.length)&&(t=s)}return t??!1}}),$e=(...n)=>({match:e=>{for(const t of n){const r=t.match(e);if(r===!1)return!1;e=r}return e}});function Je(...n){function e(s){if(s==null)return!1;let i=s.getComponents();for(const a of n){const c=a.match(i);if(c===!1)return!1;i=c}return i}function t(s){return e(s)!==!1}function r(s){const i=e(s);return i===!1?!1:i.length===0}return{matchers:n,matches:t,exactMatch:r}}const FU=Ce(He),UU=Je(FU),C1=Ce(zu),k1=Ce(vl),A1=Ce(Hu),v3=Ce($u);Je(C1,Ue(Ce(He)));Je(k1,Ue(Ce(He)));Je(A1,Ue(Ce(He)));Je(pn(v3,A1,C1,k1),Ue(Ce(He)));const Qx=$e(Ce(go),Ue(Ce(h3))),Yx=$e(Ue(Ce(Io)),Ce(nr),Ue(Ce(h3))),b3=pn(Qx,Yx),yo=pn(b3,v3,C1,k1,A1),VU=Je(pn(b3,$e(pn(v3,A1,C1,k1),Ue(Ce(He))))),P7=Je(Qx),T7=Je(Yx);Je(b3);const x3=$e(yo,Ce(vs)),Ku=$e(yo,Ce(bf)),_f=Je($e(x3,Ue(Ce(He))));Je(Ku);const S3=$e(Ku,et(hx),Ue(Ce(He))),P1=$e(Ku,et(fx),Ue(Ce(He))),jU=pn(S3,P1);Je(S3);const $U=Je(P1),Ug=pn(yo,x3,Ku,S3,P1),Xx=pn($e(Ug,et(f3),Ue(Ce(He)))),lu=Je(Xx),Jx=pn($e(Ug,et(gx),Ue(Ce(He))),$e(Ug,et(Na),Ue(Ce(dx)),et(f3),Ue(Ce(He)))),Df=Je(Jx),Zx=$e(Ku,et(mx),Ue(Ce(su)),Ue(Ce(su)),Ue(Ce(He))),_7=Je(Zx),eS=$e(P1,et(px),Ue(Ce(su)),Ue(Ce(su)),Ue(Ce(He))),D7=Je(eS),If=pn(Xx,Jx,$e(x3,Ue(Ce(He))),$e(jU,Ue(Ce(He))),$e(yo,Ue(Ce(He))),Zx,eS,Ce(He)),tS=Je(If),zU=$e(If,et(No),Ce(He)),cu=Je(zU),HU=pn($e(If,et(No),et(Kh),Ue(Ce(He))),$e(If,et(Kh),Ue(Ce(He))),$e(et(Kh),Ue(Ce(He)))),Vg=Je(HU),KU=pn($e(yo,Ce(vs),et(Ma),Ue(Ce(He))),$e(yo,et(Ma),Ue(Ce(He))));Je(KU);const qU=$e(yo,pn($e(Ce(vs,"443"),et(Ma)),$e(Ce(vs),et(Og)),$e(Ce(vs),et(Na),et(Ma)),$e(et(Na),et(Ma)),et(Na),et(Og)),Ue(Ce(He)));Je(qU);const WU=pn($e(Ce(yx),Ue(Ce(He))));Je(WU);const GU=pn($e(Ce(ux),Ue(Ce(He))));Je(GU);class QU extends Map{metric;constructor(e){super();const{name:t,metrics:r}=e;this.metric=r.registerMetric(t),this.updateComponentMetric()}set(e,t){return super.set(e,t),this.updateComponentMetric(),this}delete(e){const t=super.delete(e);return this.updateComponentMetric(),t}clear(){super.clear(),this.updateComponentMetric()}updateComponentMetric(){this.metric.update(this.size)}}function As(n){const{name:e,metrics:t}=n;let r;return t!=null?r=new QU({name:e,metrics:t}):r=new Map,r}const I7=864e13,YU=448,T2=449,XU=53,JU=54,ZU=55,eV=56;class tV{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:dns-mappings"),this.mappings=As({name:"libp2p_address_manager_dns_mappings",metrics:e.metrics})}has(e){const t=this.findHost(e);for(const r of this.mappings.values())if(r.domain===t)return!0;return!1}add(e,t){t.forEach(r=>{this.log("add DNS mapping %s to %s",r,e);const s=bl(r)===!0;this.mappings.set(r,{domain:e,verified:s,expires:s?I7-Date.now():0,lastVerified:s?I7-Date.now():void 0})})}remove(e){const t=this.findHost(e);let r=!1;for(const[s,i]of this.mappings.entries())i.domain===t&&(this.log("removing %s to %s DNS mapping %e",s,i.domain,new Error("where")),this.mappings.delete(s),r=r||i.verified);return r}getAll(e){const t=[];for(let r=0;r<e.length;r++){const i=e[r].multiaddr.stringTuples(),a=i[0][1];if(a!=null)for(const[c,u]of this.mappings.entries()){if(a!==c)continue;this.maybeAddSNITuple(i,u.domain)&&(e.splice(r,1),r--,t.push({multiaddr:Pe(`/${i.map(f=>[E1(f[0]).name,f[1]].join("/")).join("/")}`),verified:u.verified,type:"dns-mapping",expires:u.expires,lastVerified:u.lastVerified}))}}return t}maybeAddSNITuple(e,t){for(let r=0;r<e.length;r++)if(e[r][0]===YU&&e[r+1]?.[0]!==T2)return e.splice(r+1,0,[T2,t]),!0;return!1}confirm(e,t){const r=this.findHost(e);let s=!1;for(const[i,a]of this.mappings.entries())a.domain===r&&(this.log("marking %s to %s DNS mapping as verified",i,a.domain),s=a.verified,a.verified=!0,a.expires=Date.now()+t,a.lastVerified=Date.now());return s}unconfirm(e,t){const r=this.findHost(e);let s=!1;for(const[i,a]of this.mappings.entries())a.domain===r&&(this.log("removing verification of %s to %s DNS mapping",i,a.domain),s=s||a.verified,a.verified=!1,a.expires=Date.now()+t);return s}findHost(e){for(const t of e.stringTuples())if(t[0]===T2||t[0]===XU||t[0]===JU||t[0]===ZU||t[0]===eV)return t[1]}}const _2=4,D2=41,I2=6,nV=273;class rV{log;mappings;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:ip-mappings"),this.mappings=As({name:"libp2p_address_manager_ip_mappings",metrics:e.metrics})}has(e){const t=e.stringTuples();for(const r of this.mappings.values())for(const s of r)if(s.externalIp===t[0][1])return!0;return!1}add(e,t,r,s=t,i="tcp"){const a=`${e}-${t}-${i}`,c=this.mappings.get(a)??[],u={internalIp:e,internalPort:t,externalIp:r,externalPort:s,externalFamily:Wa(r)?4:6,protocol:i,verified:!1,expires:0};c.push(u),this.mappings.set(a,c)}remove(e){const t=e.stringTuples(),r=t[0][1]??"",s=t[1][0]===I2?"tcp":"udp",i=parseInt(t[1][1]??"0");let a=!1;for(const[c,u]of this.mappings.entries()){for(let h=0;h<u.length;h++){const f=u[h];f.externalIp===r&&f.externalPort===i&&f.protocol===s&&(this.log("removing %s:%s to %s:%s %s IP mapping",f.externalIp,f.externalPort,r,i,s),a=a||f.verified,u.splice(h,1),h--)}u.length===0&&this.mappings.delete(c)}return a}getAll(e){const t=[];for(const{multiaddr:r}of e){const s=r.stringTuples();let i;if((s[0][0]===_2||s[0][0]===D2)&&s[1][0]===I2?i=`${s[0][1]}-${s[1][1]}-tcp`:(s[0][0]===_2||s[0][0]===D2)&&s[1][0]===nV&&(i=`${s[0][1]}-${s[1][1]}-udp`),i==null)continue;const a=this.mappings.get(i);if(a!=null)for(const c of a)s[0][0]=c.externalFamily===4?_2:D2,s[0][1]=c.externalIp,s[1][1]=`${c.externalPort}`,t.push({multiaddr:Pe(`/${s.map(u=>[E1(u[0]).name,u[1]].join("/")).join("/")}`),verified:c.verified,type:"ip-mapping",expires:c.expires,lastVerified:c.lastVerified})}return t}confirm(e,t){const s=e.stringTuples()[0][1];let i=!1;for(const a of this.mappings.values())for(const c of a)c.externalIp===s&&(this.log("marking %s to %s IP mapping as verified",c.internalIp,c.externalIp),i=c.verified,c.verified=!0,c.expires=Date.now()+t,c.lastVerified=Date.now());return i}unconfirm(e,t){const r=e.stringTuples(),s=r[0][1]??"",i=r[1][0]===I2?"tcp":"udp",a=parseInt(r[1][1]??"0");let c=!1;for(const u of this.mappings.values())for(let h=0;h<u.length;h++){const f=u[h];f.externalIp===s&&f.externalPort===a&&f.protocol===i&&(this.log("removing verification of %s:%s to %s:%s %s IP mapping",f.externalIp,f.externalPort,s,a,i),c=c||f.verified,f.verified=!1,f.expires=Date.now()+t)}return c}}function sV(n){try{for(const{code:e,value:t}of n.getComponents())if(e!==Io&&t!=null){if(e===go)return t.startsWith("169.254.");if(e===nr)return t.toLowerCase().startsWith("fe80")}}catch{}return!1}function nS(n){try{for(const{code:e}of n.getComponents())if(e!==Io)return e===go||e===nr}catch{}return!1}function uu(n){try{if(!nS(n))return!1;const[[,e]]=n.stringTuples();return e==null?!1:bl(e)??!1}catch{}return!0}const iV={maxObservedAddresses:10};class oV{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=As({name:"libp2p_address_manager_observed_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??iV.maxObservedAddresses}has(e){return this.addresses.has(e.toString())}removePrefixed(e){for(const t of this.addresses.keys())t.toString().startsWith(e)&&this.addresses.delete(t)}add(e){this.addresses.size!==this.maxObservedAddresses&&(uu(e)||sV(e)||(this.log("adding observed address %a",e),this.addresses.set(e.toString(),{verified:!1,expires:0})))}getAll(){return Array.from(this.addresses).map(([e,t])=>({multiaddr:Pe(e),verified:t.verified,type:"observed",expires:t.expires,lastVerified:t.lastVerified}))}remove(e){const t=this.addresses.get(e.toString())?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(e.toString()),t}confirm(e,t){const r=e.toString(),s=this.addresses.get(r)??{verified:!1,expires:Date.now()+t,lastVerified:Date.now()},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.log("marking observed address %a as verified",r),this.addresses.set(r,s),i}}const aV=[go,nr,$u,zu,vl,Hu];function N7(n){try{for(const{code:e}of n.getComponents())if(e!==Io)return aV.includes(e)}catch{}return!1}const lV={maxObservedAddresses:10};class cV{log;addresses;maxObservedAddresses;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:address-manager:observed-addresses"),this.addresses=As({name:"libp2p_address_manager_transport_addresses",metrics:e.metrics}),this.maxObservedAddresses=t.maxObservedAddresses??lV.maxObservedAddresses}get(e,t){if(uu(e))return{multiaddr:e,verified:!0,type:"transport",expires:Date.now()+t,lastVerified:Date.now()};const r=this.toKey(e);let s=this.addresses.get(r);return s==null&&(s={verified:!N7(e),expires:0},this.addresses.set(r,s)),{multiaddr:e,verified:s.verified,type:"transport",expires:s.expires,lastVerified:s.lastVerified}}has(e){const t=this.toKey(e);return this.addresses.has(t)}remove(e){const t=this.toKey(e),r=this.addresses.get(t)?.verified??!1;return this.log("removing observed address %a",e),this.addresses.delete(t),r}confirm(e,t){const r=this.toKey(e),s=this.addresses.get(r)??{verified:!1,expires:0,lastVerified:0},i=s.verified;return s.verified=!0,s.expires=Date.now()+t,s.lastVerified=Date.now(),this.addresses.set(r,s),i}unconfirm(e,t){const r=this.toKey(e),s=this.addresses.get(r)??{verified:!1,expires:0},i=s.verified;return s.verified=!1,s.expires=Date.now()+t,this.addresses.set(r,s),i}toKey(e){if(N7(e)){const t=e.toOptions();return`${t.host}-${t.port}-${t.transport}`}return e.toString()}}const M7=6e4,R7={addressVerificationTTL:M7*10,addressVerificationRetry:M7*5},uV=n=>n;function N2(n,e){const t=n.getPeerId();return t!=null&&sr(t).equals(e)&&(n=n.decapsulate(Pe(`/p2p/${e.toString()}`))),n}class dV{log;components;listen;announce;appendAnnounce;announceFilter;observed;dnsMappings;ipMappings;transportAddresses;observedAddressFilter;addressVerificationTTL;addressVerificationRetry;constructor(e,t={}){const{listen:r=[],announce:s=[],appendAnnounce:i=[]}=t;this.components=e,this.log=e.logger.forComponent("libp2p:address-manager"),this.listen=r.map(a=>a.toString()),this.announce=new Set(s.map(a=>a.toString())),this.appendAnnounce=new Set(i.map(a=>a.toString())),this.observed=new oV(e,t),this.dnsMappings=new tV(e,t),this.ipMappings=new rV(e,t),this.transportAddresses=new cV(e,t),this.announceFilter=t.announceFilter??uV,this.observedAddressFilter=Xa(1024),this.addressVerificationTTL=t.addressVerificationTTL??R7.addressVerificationTTL,this.addressVerificationRetry=t.addressVerificationRetry??R7.addressVerificationRetry,this._updatePeerStoreAddresses=Fg(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",()=>{this._updatePeerStoreAddresses()}),e.events.addEventListener("transport:close",()=>{this._updatePeerStoreAddresses()})}[Symbol.toStringTag]="@libp2p/address-manager";_updatePeerStoreAddresses(){const e=this.getAddresses().map(t=>t.getPeerId()===this.components.peerId.toString()?t.decapsulate(`/p2p/${this.components.peerId.toString()}`):t);this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch(t=>{this.log.error("error updating addresses",t)})}getListenAddrs(){return Array.from(this.listen).map(e=>Pe(e))}getAnnounceAddrs(){return Array.from(this.announce).map(e=>Pe(e))}getAppendAnnounceAddrs(){return Array.from(this.appendAnnounce).map(e=>Pe(e))}getObservedAddrs(){return this.observed.getAll().map(e=>e.multiaddr)}addObservedAddr(e){const t=e.stringTuples(),r=`${t[0][1]}:${t[1][1]}`;this.observedAddressFilter.has(r)||(this.observedAddressFilter.add(r),e=N2(e,this.components.peerId),!this.ipMappings.has(e)&&(this.dnsMappings.has(e)||this.observed.add(e)))}confirmObservedAddr(e,t){e=N2(e,this.components.peerId);let r=!0;(t?.type==="transport"||this.transportAddresses.has(e))&&!this.transportAddresses.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(t?.type==="dns-mapping"||this.dnsMappings.has(e))&&!this.dnsMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(t?.type==="ip-mapping"||this.ipMappings.has(e))&&!this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1),(t?.type==="observed"||this.observed.has(e))&&(this.maybeUpgradeToIPMapping(e)?(this.ipMappings.confirm(e,t?.ttl??this.addressVerificationTTL),r=!1):!this.observed.confirm(e,t?.ttl??this.addressVerificationTTL)&&r&&(r=!1)),r||this._updatePeerStoreAddresses()}removeObservedAddr(e,t){e=N2(e,this.components.peerId),this.observed.has(e)&&this.observed.remove(e),this.transportAddresses.has(e)&&this.transportAddresses.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.dnsMappings.has(e)&&this.dnsMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry),this.ipMappings.has(e)&&this.ipMappings.unconfirm(e,t?.ttl??this.addressVerificationRetry)}getAddresses(){const e=new Set,t=this.getAddressesWithMetadata().filter(r=>{if(!r.verified)return!1;const s=r.multiaddr.toString();return e.has(s)?!1:(e.add(s),!0)}).map(r=>r.multiaddr);return this.announceFilter(t.map(r=>{const s=Pe(r);return s.getComponents().pop()?.value===this.components.peerId.toString()?s:s.encapsulate(`/p2p/${this.components.peerId.toString()}`)}))}getAddressesWithMetadata(){const e=this.getAnnounceAddrs();if(e.length>0)return this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(e)}),e.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()}));let t=[];t=t.concat(this.components.transportManager.getAddrs().map(s=>this.transportAddresses.get(s,this.addressVerificationTTL)));const r=this.getAppendAnnounceAddrs();return r.length>0&&(this.components.transportManager.getListeners().forEach(s=>{s.updateAnnounceAddrs(r)}),t=t.concat(r.map(s=>({multiaddr:s,verified:!0,type:"announce",expires:Date.now()+this.addressVerificationTTL,lastVerified:Date.now()})))),t=t.concat(this.observed.getAll()),t=t.concat(this.ipMappings.getAll(t)),t=t.concat(this.dnsMappings.getAll(t)),t}addDNSMapping(e,t){this.dnsMappings.add(e,t)}removeDNSMapping(e){this.dnsMappings.remove(Pe(`/dns/${e}`))&&this._updatePeerStoreAddresses()}addPublicAddressMapping(e,t,r,s=t,i="tcp"){this.ipMappings.add(e,t,r,s,i),this.observed.removePrefixed(`/ip${Wa(r)?4:6}/${r}/${i}/${s}`)}removePublicAddressMapping(e,t,r,s=t,i="tcp"){this.ipMappings.remove(Pe(`/ip${Wa(r)?4:6}/${r}/${i}/${s}`))&&this._updatePeerStoreAddresses()}maybeUpgradeToIPMapping(e){if(this.ipMappings.has(e))return!1;const t=e.toOptions();if(t.family===6||t.host==="127.0.0.1"||bl(t.host)===!0)return!1;const r=this.components.transportManager.getListeners(),s=[i=>lu.exactMatch(i)||Df.exactMatch(i),i=>_f.exactMatch(i),i=>$U.exactMatch(i)];for(const i of s){if(!i(e))continue;const a=r.filter(h=>h.getAddrs().filter(f=>f.toOptions().family===4&&i(f)).length>0);if(a.length!==1)continue;const c=a[0].getAddrs().filter(h=>h.toOptions().host!=="127.0.0.1").pop();if(c==null)continue;const u=c.toOptions();return this.observed.remove(e),this.ipMappings.add(u.host,u.port,t.host,t.port,t.transport),!0}return!1}}var L7;(function(n){n.NOT_STARTED_YET="The libp2p node is not started yet",n.NOT_FOUND="Not found"})(L7||(L7={}));class hV extends Error{constructor(e="Missing service"){super(e),this.name="MissingServiceError"}}class fV extends Error{constructor(e="Unmet service dependencies"){super(e),this.name="UnmetServiceDependenciesError"}}class M2 extends Error{constructor(e="No content routers available"){super(e),this.name="NoContentRoutersError"}}class O7 extends Error{constructor(e="No peer routers available"){super(e),this.name="NoPeerRoutersError"}}class pV extends Error{constructor(e="Should not try to find self"){super(e),this.name="QueriedForSelfError"}}class gV extends Error{constructor(e="Unhandled protocol error"){super(e),this.name="UnhandledProtocolError"}}class mV extends Error{constructor(e="Duplicate protocol handler error"){super(e),this.name="DuplicateProtocolHandlerError"}}class B7 extends Error{constructor(e="Dial denied error"){super(e),this.name="DialDeniedError"}}class yV extends Error{constructor(e="No transport was configured to listen on this address"){super(e),this.name="UnsupportedListenAddressError"}}class wV extends Error{constructor(e="Configured listen addresses could not be listened on"){super(e),this.name="UnsupportedListenAddressesError"}}class vV extends Error{constructor(e="No valid addresses"){super(e),this.name="NoValidAddressesError"}}class bV extends Error{constructor(e="Connection intercepted"){super(e),this.name="ConnectionInterceptedError"}}class xV extends Error{constructor(e="Connection denied"){super(e),this.name="ConnectionDeniedError"}}class Dh extends Error{constructor(e="Stream is not multiplexed"){super(e),this.name="MuxerUnavailableError"}}class Ih extends Error{constructor(e="Encryption failed"){super(e),this.name="EncryptionFailedError"}}class SV extends Error{constructor(e="Transport unavailable"){super(e),this.name="TransportUnavailableError"}}class EV extends Error{constructor(e="Max recursive depth reached"){super(e),this.name="RecursionLimitError"}}class CV{components={};_started=!1;constructor(e={}){this.components={};for(const[t,r]of Object.entries(e))this.components[t]=r;this.components.logger==null&&(this.components.logger=Cx())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter(t=>qm(t)).map(async t=>{await t[e]?.()}))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const kV=["metrics","connectionProtector","dns"],AV=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function PV(n={}){const e=new CV(n);return new Proxy(e,{get(r,s,i){if(typeof s=="string"&&!AV.includes(s)){const a=e.components[s];if(a==null&&!kV.includes(s))throw new hV(`${s} not set`);return a}return Reflect.get(r,s,i)},set(r,s,i){return typeof s=="string"?e.components[s]=i:Reflect.set(r,s,i),!0}})}function TV(n){const e={};for(const t of Object.values(n.components))for(const r of _V(t))e[r]=!0;for(const t of Object.values(n.components))for(const r of DV(t))if(e[r]!==!0)throw new fV(`Service "${IV(t)}" required capability "${r}" but it was not provided by any component, you may need to add additional configuration when creating your node.`)}function _V(n){return Array.isArray(n?.[br])?n[br]:[]}function DV(n){return Array.isArray(n?.[Zc])?n[Zc]:[]}function IV(n){return n?.[Symbol.toStringTag]??n?.toString()??"unknown"}const NV=4,MV=41;function RV(n={}){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{if(lu.matches(e))return!1;const t=e.stringTuples();return t[0][0]===NV||t[0][0]===MV?!!bl(`${t[0][1]}`):!1},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...n}}const F7=()=>{const n=new Error("Delay aborted");return n.name="AbortError",n},LV=new WeakMap;function OV({clearTimeout:n,setTimeout:e}={}){return(t,{value:r,signal:s}={})=>{if(s?.aborted)return Promise.reject(F7());let i,a,c;const u=n??clearTimeout,h=()=>{u(i),c(F7())},f=()=>{s&&s.removeEventListener("abort",h)},p=new Promise((m,w)=>{a=()=>{f(),m(r)},c=w,i=(e??setTimeout)(a,t)});return s&&s.addEventListener("abort",h,{once:!0}),LV.set(p,()=>{u(i),i=null,a()}),p}}const BV=OV();class FV extends Error{remainingPoints;msBeforeNext;consumedPoints;isFirstInDuration;constructor(e="Rate limit exceeded",t){super(e),this.name="RateLimitError",this.remainingPoints=t.remainingPoints,this.msBeforeNext=t.msBeforeNext,this.consumedPoints=t.consumedPoints,this.isFirstInDuration=t.isFirstInDuration}}class UV extends Error{static name="QueueFullError";constructor(e="The queue was full"){super(e),this.name="QueueFullError"}}class VV{memoryStorage;points;duration;blockDuration;execEvenly;execEvenlyMinDelayMs;keyPrefix;constructor(e={}){this.points=e.points??4,this.duration=e.duration??1,this.blockDuration=e.blockDuration??0,this.execEvenly=e.execEvenly??!1,this.execEvenlyMinDelayMs=e.execEvenlyMinDelayMs??this.duration*1e3/this.points,this.keyPrefix=e.keyPrefix??"rlflx",this.memoryStorage=new jV}async consume(e,t=1,r={}){const s=this.getKey(e),i=this._getKeySecDuration(r);let a=this.memoryStorage.incrby(s,t,i);if(a.remainingPoints=Math.max(this.points-a.consumedPoints,0),a.consumedPoints>this.points)throw this.blockDuration>0&&a.consumedPoints<=this.points+t&&(a=this.memoryStorage.set(s,a.consumedPoints,this.blockDuration)),new FV("Rate limit exceeded",a);if(this.execEvenly&&a.msBeforeNext>0&&!a.isFirstInDuration){let c=Math.ceil(a.msBeforeNext/(a.remainingPoints+2));c<this.execEvenlyMinDelayMs&&(c=a.consumedPoints*this.execEvenlyMinDelayMs),await BV(c)}return a}penalty(e,t=1,r={}){const s=this.getKey(e),i=this._getKeySecDuration(r),a=this.memoryStorage.incrby(s,t,i);return a.remainingPoints=Math.max(this.points-a.consumedPoints,0),a}reward(e,t=1,r={}){const s=this.getKey(e),i=this._getKeySecDuration(r),a=this.memoryStorage.incrby(s,-t,i);return a.remainingPoints=Math.max(this.points-a.consumedPoints,0),a}block(e,t){const r=t*1e3,s=this.points+1;return this.memoryStorage.set(this.getKey(e),s,t),{remainingPoints:0,msBeforeNext:r===0?-1:r,consumedPoints:s,isFirstInDuration:!1}}set(e,t,r=0){const s=(r>=0?r:this.duration)*1e3;return this.memoryStorage.set(this.getKey(e),t,r),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:t,isFirstInDuration:!1}}get(e){const t=this.memoryStorage.get(this.getKey(e));return t!=null&&(t.remainingPoints=Math.max(this.points-t.consumedPoints,0)),t}delete(e){this.memoryStorage.delete(this.getKey(e))}_getKeySecDuration(e){return e?.customDuration!=null&&e.customDuration>=0?e.customDuration:this.duration}getKey(e){return this.keyPrefix.length>0?`${this.keyPrefix}:${e}`:e}parseKey(e){return e.substring(this.keyPrefix.length)}}class jV{storage;constructor(){this.storage=new Map}incrby(e,t,r){const s=this.storage.get(e);if(s!=null){const i=s.expiresAt!=null?s.expiresAt.getTime()-new Date().getTime():-1;return s.expiresAt==null||i>0?(s.value+=t,{remainingPoints:0,msBeforeNext:i,consumedPoints:s.value,isFirstInDuration:!1}):this.set(e,t,r)}return this.set(e,t,r)}set(e,t,r){const s=r*1e3,i=this.storage.get(e);i!=null&&clearTimeout(i.timeoutId);const a={value:t,expiresAt:s>0?new Date(Date.now()+s):void 0};return this.storage.set(e,a),s>0&&(a.timeoutId=setTimeout(()=>{this.storage.delete(e)},s),a.timeoutId.unref!=null&&a.timeoutId.unref()),{remainingPoints:0,msBeforeNext:s===0?-1:s,consumedPoints:a.value,isFirstInDuration:!0}}get(e){const t=this.storage.get(e);if(t!=null)return{remainingPoints:0,msBeforeNext:t.expiresAt!=null?t.expiresAt.getTime()-new Date().getTime():-1,consumedPoints:t.value,isFirstInDuration:!1}}delete(e){const t=this.storage.get(e);return t!=null?(t.timeoutId!=null&&clearTimeout(t.timeoutId),this.storage.delete(e),!0):!1}}function rS(n){if(Bc(n))return{peerId:n,multiaddrs:[]};let e=Array.isArray(n)?n:[n],t;if(e.length>0){const r=e[0].getPeerId();t=r==null?void 0:sr(r),e.forEach(s=>{if(!S1(s))throw new zm("Invalid multiaddr");const i=s.getPeerId();if(i==null){if(t!=null)throw new Ae("Multiaddrs must all have the same peer id or have no peer id")}else{const a=sr(i);if(t?.equals(a)!==!0)throw new Ae("Multiaddrs must all have the same peer id or have no peer id")}})}return e=e.filter(r=>!UU.exactMatch(r)),{peerId:t,multiaddrs:e}}const $V=["/ipfs/id/1.0.0","/ipfs/id/push/1.0.0","/libp2p/autonat/1.0.0","/libp2p/dcutr"];async function zV(n,e){const t=n?.streams?.map(s=>s.protocol)??[],r=e?.closableProtocols??$V;if(!(t.filter(s=>s!=null&&!r.includes(s)).length>0))try{await n?.close(e)}catch(s){n?.abort(s)}}function jg(n){try{let e;typeof n=="string"?e=Pe(n):e=n;const t=new Set([...e.getComponents().map(r=>r.name)]);if(!t.has("ipcidr")){const s=t.has("ip6")?"/ipcidr/128":"/ipcidr/32";e=e.encapsulate(s)}return ZB(e)}catch{throw new Error(`Can't convert to IpNet, Invalid multiaddr format: ${n}`)}}class HV{connectionManager;peerStore;allow;events;log;constructor(e,t={}){this.allow=(t.allow??[]).map(r=>jg(r)),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager:connection-pruner"),this.maybePruneConnections=this.maybePruneConnections.bind(this)}start(){this.events.addEventListener("connection:open",this.maybePruneConnections)}stop(){this.events.removeEventListener("connection:open",this.maybePruneConnections)}maybePruneConnections(){this._maybePruneConnections().catch(e=>{this.log.error("error while pruning connections %e",e)})}async _maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,r=this.connectionManager.getMaxConnections();if(this.log("checking max connections limit %d/%d",t,r),t<=r)return;const s=new Mo;for(const u of e){const h=u.remotePeer;if(!s.has(h)){s.set(h,0);try{const f=await this.peerStore.get(h);s.set(h,[...f.tags.values()].reduce((p,m)=>p+m.value,0))}catch(f){f.name!=="NotFoundError"&&this.log.error("error loading peer tags",f)}}}const i=this.sortConnections(e,s),a=Math.max(t-r,0),c=[];for(const u of i)if(this.log("too many connections open - closing a connection to %p",u.remotePeer),this.allow.some(f=>f.contains(u.remoteAddr.nodeAddress().address))||c.push(u),c.length===a)break;await Promise.all(c.map(async u=>{await zV(u,{signal:AbortSignal.timeout(1e3)})})),this.events.safeDispatchEvent("connection:prune",{detail:c})}sortConnections(e,t){return e.sort((r,s)=>{const i=r.timeline.open,a=s.timeline.open;return i<a?1:i>a?-1:0}).sort((r,s)=>r.direction==="outbound"&&s.direction==="inbound"?1:r.direction==="inbound"&&s.direction==="outbound"?-1:0).sort((r,s)=>r.streams.length>s.streams.length?1:r.streams.length<s.streams.length?-1:0).sort((r,s)=>{const i=t.get(r.remotePeer)??0,a=t.get(s.remotePeer)??0;return i>a?1:i<a?-1:0})}}const sS=1e4,KV=1e4,U7=1e4,iS=25,qV=5,WV=10,GV=5,QV="last-dial-failure",YV="last-dial-success",oS=500,XV=32,JV=100,aS=50;class ZV{deferred;signal;constructor(e){this.signal=e,this.deferred=Ke(),this.onAbort=this.onAbort.bind(this),this.signal?.addEventListener("abort",this.onAbort)}onAbort(){this.deferred.reject(this.signal?.reason??new xi)}cleanup(){this.signal?.removeEventListener("abort",this.onAbort)}}function ej(){return`${parseInt(String(Math.random()*1e9),10).toString()}${Date.now()}`}class tj{id;fn;options;recipients;status;timeline;controller;constructor(e,t){this.id=ej(),this.status="queued",this.fn=e,this.options=t,this.recipients=[],this.timeline={created:Date.now()},this.controller=new AbortController,this.controller.signal,this.onAbort=this.onAbort.bind(this)}abort(e){this.controller.abort(e)}onAbort(){this.recipients.reduce((t,r)=>t&&r.signal?.aborted===!0,!0)&&(this.controller.abort(new xi),this.cleanup())}async join(e={}){const t=new ZV(e.signal);return this.recipients.push(t),e.signal?.addEventListener("abort",this.onAbort),t.deferred.promise}async run(){this.status="running",this.timeline.started=Date.now();try{this.controller.signal.throwIfAborted();const e=await Dt(this.fn({...this.options??{},signal:this.controller.signal}),this.controller.signal);this.recipients.forEach(t=>{t.deferred.resolve(e)}),this.status="complete"}catch(e){this.recipients.forEach(t=>{t.deferred.reject(e)}),this.status="errored"}finally{this.timeline.finished=Date.now(),this.cleanup()}}cleanup(){this.recipients.forEach(e=>{e.cleanup(),e.signal?.removeEventListener("abort",this.onAbort)})}}class qu extends ln{concurrency;maxSize;queue;pending;sort;constructor(e={}){super(),this.concurrency=e.concurrency??Number.POSITIVE_INFINITY,this.maxSize=e.maxSize??Number.POSITIVE_INFINITY,this.pending=0,e.metricName!=null&&e.metrics?.registerMetricGroup(e.metricName,{calculate:()=>({size:this.queue.length,running:this.pending,queued:this.queue.length-this.pending})}),this.sort=e.sort,this.queue=[],this.emitEmpty=Fg(this.emitEmpty.bind(this),1),this.emitIdle=Fg(this.emitIdle.bind(this),1)}emitEmpty(){this.size===0&&this.safeDispatchEvent("empty")}emitIdle(){this.running===0&&this.safeDispatchEvent("idle")}tryToStartAnother(){if(this.size===0)return this.emitEmpty(),this.running===0&&this.emitIdle(),!1;if(this.pending<this.concurrency){let e;for(const t of this.queue)if(t.status==="queued"){e=t;break}return e==null?!1:(this.safeDispatchEvent("active"),this.pending++,e.run().finally(()=>{for(let t=0;t<this.queue.length;t++)if(this.queue[t]===e){this.queue.splice(t,1);break}this.pending--,this.tryToStartAnother(),this.safeDispatchEvent("next")}),!0)}return!1}enqueue(e){this.queue.push(e),this.sort!=null&&this.queue.sort(this.sort)}async add(e,t){if(t?.signal?.throwIfAborted(),this.size===this.maxSize)throw new UV;const r=new tj(e,t);return this.enqueue(r),this.safeDispatchEvent("add"),this.tryToStartAnother(),r.join(t).then(s=>(this.safeDispatchEvent("completed",{detail:s}),this.safeDispatchEvent("success",{detail:{job:r,result:s}}),s)).catch(s=>{if(r.status==="queued"){for(let i=0;i<this.queue.length;i++)if(this.queue[i]===r){this.queue.splice(i,1);break}}throw this.safeDispatchEvent("error",{detail:s}),this.safeDispatchEvent("failure",{detail:{job:r,error:s}}),s})}clear(){this.queue.splice(0,this.queue.length)}abort(){this.queue.forEach(e=>{e.abort(new xi)}),this.clear()}async onEmpty(e){this.size!==0&&await Ss(this,"empty",e?.signal)}async onSizeLessThan(e,t){this.size<e||await Ss(this,"next",t?.signal,{filter:()=>this.size<e})}async onIdle(e){this.pending===0&&this.size===0||await Ss(this,"idle",e?.signal)}get size(){return this.queue.length}get queued(){return this.queue.length-this.pending}get running(){return this.pending}async*toGenerator(e){e?.signal?.throwIfAborted();const t=_i({objectMode:!0}),r=u=>{u!=null?this.abort():this.clear(),t.end(u)},s=u=>{u.detail!=null&&t.push(u.detail)},i=u=>{r(u.detail)},a=()=>{r()},c=()=>{r(new xi("Queue aborted"))};this.addEventListener("completed",s),this.addEventListener("error",i),this.addEventListener("idle",a),e?.signal?.addEventListener("abort",c);try{yield*t}finally{this.removeEventListener("completed",s),this.removeEventListener("error",i),this.removeEventListener("idle",a),e?.signal?.removeEventListener("abort",c),r()}}}class nj extends qu{constructor(e={}){super({...e,sort:(t,r)=>t.options.priority>r.options.priority?-1:t.options.priority<r.options.priority?1:0})}}function An(n){const e=new globalThis.AbortController;function t(){e.abort();for(const i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}for(const i of n){if(i?.aborted===!0){t();break}i?.addEventListener!=null&&i.addEventListener("abort",t)}function r(){for(const i of n)i?.removeEventListener!=null&&i.removeEventListener("abort",t)}const s=e.signal;return s.clear=r,s}function rj(n){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(n)||/^::1$/.test(n)}function V7(n){if(!nS(n))return!1;const{address:e}=n.nodeAddress();return rj(e)}function sj(n,e){const t=_f.exactMatch(n.multiaddr),r=_f.exactMatch(e.multiaddr);if(t&&!r)return-1;if(!t&&r)return 1;const s=Df.exactMatch(n.multiaddr),i=Df.exactMatch(e.multiaddr);if(s&&!i)return-1;if(!s&&i)return 1;const a=lu.exactMatch(n.multiaddr),c=lu.exactMatch(e.multiaddr);if(a&&!c)return-1;if(!a&&c)return 1;const u=Vg.exactMatch(n.multiaddr),h=Vg.exactMatch(e.multiaddr);if(u&&!h)return-1;if(!u&&h)return 1;const f=_7.exactMatch(n.multiaddr),p=_7.exactMatch(e.multiaddr);if(f&&!p)return-1;if(!f&&p)return 1;const m=D7.exactMatch(n.multiaddr),w=D7.exactMatch(e.multiaddr);return m&&!w?-1:!m&&w?1:0}function ij(n,e){const t=V7(n.multiaddr),r=V7(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function oj(n,e){const t=uu(n.multiaddr),r=uu(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function aj(n,e){return n.isCertified&&!e.isCertified?-1:!n.isCertified&&e.isCertified?1:0}function lj(n,e){const t=cu.exactMatch(n.multiaddr),r=cu.exactMatch(e.multiaddr);return t&&!r?1:!t&&r?-1:0}function cj(n){return n.sort(sj).sort(aj).sort(lj).sort(oj).sort(ij)}async function lS(n,e,t){const r=t.depth??0;if(r>(t.maxRecursiveDepth??XV))throw new EV("Max recursive depth reached");let s=!1;const i=[];for(const a of Object.values(e))if(a.canResolve(n)){s=!0;const c=await a.resolve(n,t);for(const u of c)i.push(...await lS(u,e,{...t,depth:r+1}))}return s===!1&&i.push(n),i}const Cc={maxParallelDials:aS,maxDialQueueLength:oS,maxPeerAddrsToDial:iS,dialTimeout:sS,resolvers:{dnsaddr:p3}};class uj{queue;components;addressSorter;maxPeerAddrsToDial;maxDialQueueLength;dialTimeout;shutDownController;connections;log;resolvers;constructor(e,t={}){this.addressSorter=t.addressSorter,this.maxPeerAddrsToDial=t.maxPeerAddrsToDial??Cc.maxPeerAddrsToDial,this.maxDialQueueLength=t.maxDialQueueLength??Cc.maxDialQueueLength,this.dialTimeout=t.dialTimeout??Cc.dialTimeout,this.connections=t.connections??new Mo,this.log=e.logger.forComponent("libp2p:connection-manager:dial-queue"),this.components=e,this.resolvers=t.resolvers??Cc.resolvers,this.shutDownController=new AbortController,this.shutDownController.signal,this.queue=new nj({concurrency:t.maxParallelDials??Cc.maxParallelDials,metricName:"libp2p_dial_queue",metrics:e.metrics}),this.queue.addEventListener("error",r=>{r.detail?.name!==xi.name&&this.log.error("error in dial queue - %e",r.detail)})}start(){this.shutDownController=new AbortController,this.shutDownController.signal}stop(){this.shutDownController.abort(),this.queue.abort()}async dial(e,t={}){const{peerId:r,multiaddrs:s}=rS(e),i=Array.from(this.connections.values()).flat().find(c=>t.force===!0||c.limits!=null?!1:c.remotePeer.equals(r)?!0:s.find(u=>u.equals(c.remoteAddr)));if(i?.status==="open")return this.log("already connected to %a",i.remoteAddr),t.onProgress?.(new qe("dial-queue:already-connected")),i;const a=this.queue.queue.find(c=>{if(r?.equals(c.options.peerId)===!0)return!0;const u=c.options.multiaddrs;if(u==null)return!1;for(const h of s)if(u.has(h.toString()))return!0;return!1});if(a!=null){this.log("joining existing dial target for %p",r);for(const c of s)a.options.multiaddrs.add(c.toString());return t.onProgress?.(new qe("dial-queue:already-in-dial-queue")),a.join(t)}if(this.queue.size>=this.maxDialQueueLength)throw new Fc("Dial queue is full");return this.log("creating dial target for %p",r,s.map(c=>c.toString())),t.onProgress?.(new qe("dial-queue:add-to-dial-queue")),this.queue.add(async c=>{c.onProgress?.(new qe("dial-queue:start-dial"));const u=An([this.shutDownController.signal,c.signal]);try{return await this.dialPeer(c,u)}finally{u.clear()}},{peerId:r,priority:t.priority??cS,multiaddrs:new Set(s.map(c=>c.toString())),signal:t.signal??AbortSignal.timeout(this.dialTimeout),onProgress:t.onProgress})}async dialPeer(e,t){const r=e.peerId,s=e.multiaddrs,i=new Set;let a=e.multiaddrs.size===0,c=0,u=0;const h=[];for(this.log("starting dial to %p",r);a||s.size>0;){u++,a=!1;const f=[],p=new Set(e.multiaddrs);s.clear(),this.log("calculating addrs to dial %p from %s",r,[...p]);const m=await this.calculateMultiaddrs(r,p,{...e,signal:t});for(const w of m){if(i.has(w.multiaddr.toString())){this.log.trace("skipping previously failed multiaddr %a while dialing %p",w.multiaddr,r);continue}f.push(w)}this.log("%s dial to %p with %s",u===1?"starting":"continuing",r,f.map(w=>w.multiaddr.toString())),e?.onProgress?.(new qe("dial-queue:calculated-addresses",f));for(const w of f){if(c===this.maxPeerAddrsToDial)throw this.log("dialed maxPeerAddrsToDial (%d) addresses for %p, not trying any others",c,e.peerId),new Fc("Peer had more than maxPeerAddrsToDial");c++;try{const x=await this.components.transportManager.dial(w.multiaddr,{...e,signal:t});this.log("dial to %a succeeded",w.multiaddr);try{await this.components.peerStore.merge(x.remotePeer,{multiaddrs:[x.remoteAddr],metadata:{[YV]:we(Date.now().toString())}})}catch(S){this.log.error("could not update last dial failure key for %p",r,S)}return x}catch(x){if(this.log.error("dial failed to %a",w.multiaddr,x),i.add(w.multiaddr.toString()),r!=null)try{await this.components.peerStore.merge(r,{metadata:{[QV]:we(Date.now().toString())}})}catch(S){this.log.error("could not update last dial failure key for %p",r,S)}if(t.aborted)throw new h1(x.message);h.push(x)}}}throw h.length===1?h[0]:new AggregateError(h,"All multiaddr dials failed")}async calculateMultiaddrs(e,t=new Set,r={}){const s=[...t].map(p=>({multiaddr:Pe(p),isCertified:!1}));if(e!=null){if(this.components.peerId.equals(e))throw new Fc("Tried to dial self");if(await this.components.connectionGater.denyDialPeer?.(e)===!0)throw new B7("The dial request is blocked by gater.allowDialPeer");if(s.length===0){this.log("loading multiaddrs for %p",e);try{const p=await this.components.peerStore.get(e);s.push(...p.addresses),this.log("loaded multiaddrs for %p",e,s.map(({multiaddr:m})=>m.toString()))}catch(p){if(p.name!=="NotFoundError")throw p}}if(s.length===0){this.log("looking up multiaddrs for %p in the peer routing",e);try{const p=await this.components.peerRouting.findPeer(e,r);this.log("found multiaddrs for %p in the peer routing",e,s.map(({multiaddr:m})=>m.toString())),s.push(...p.multiaddrs.map(m=>({multiaddr:m,isCertified:!1})))}catch(p){p.name==="NoPeerRoutersError"?this.log("no peer routers configured",e):this.log.error("looking up multiaddrs for %p in the peer routing failed - %e",e,p)}}}let i=(await Promise.all(s.map(async p=>{const m=await lS(p.multiaddr,this.resolvers,{dns:this.components.dns,log:this.log,...r});return m.length===1&&m[0].equals(p.multiaddr)?p:m.map(w=>({multiaddr:w,isCertified:!1}))}))).flat();if(e!=null){const p=`/p2p/${e.toString()}`;i=i.map(m=>m.multiaddr.getComponents().pop()?.name!=="p2p"?{multiaddr:m.multiaddr.encapsulate(p),isCertified:m.isCertified}:m)}const a=i.filter(p=>{if(this.components.transportManager.dialTransportForMultiaddr(p.multiaddr)==null)return!1;const m=p.multiaddr.getPeerId();return e!=null&&m!=null?e.equals(m):!0}),c=new Map;for(const p of a){const m=p.multiaddr.toString(),w=c.get(m);if(w!=null){w.isCertified=w.isCertified||p.isCertified||!1;continue}c.set(m,p)}const u=[...c.values()];if(u.length===0)throw new vV("The dial request has no valid addresses");const h=[];for(const p of u)this.components.connectionGater.denyDialMultiaddr!=null&&await this.components.connectionGater.denyDialMultiaddr(p.multiaddr)||h.push(p);const f=this.addressSorter==null?cj(h):h.sort(this.addressSorter);if(f.length===0)throw new B7("The connection gater denied all addresses in the dial request");return this.log.trace("addresses for %p before filtering",e??"unknown peer",i.map(({multiaddr:p})=>p.toString())),this.log.trace("addresses for %p after filtering",e??"unknown peer",f.map(({multiaddr:p})=>p.toString())),f}async isDialable(e,t={}){Array.isArray(e)||(e=[e]);try{const r=await this.calculateMultiaddrs(void 0,new Set(e.map(s=>s.toString())),t);return t.runOnLimitedConnection===!1?r.find(s=>!cu.matches(s.multiaddr))!=null:!0}catch(r){this.log.trace("error calculating if multiaddr(s) were dialable",r)}return!1}}class du extends qu{has(e){return this.find(e)!=null}find(e){return this.queue.find(t=>e.equals(t.options.peerId))}}var R2={},L2,j7;function dj(){if(j7)return L2;j7=1;function n(e,t){typeof t=="boolean"&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}return L2=n,n.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},n.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},n.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(r===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);else return!1;var s=this;return this._timer=setTimeout(function(){s._attempts++,s._operationTimeoutCb&&(s._timeout=setTimeout(function(){s._operationTimeoutCb(s._attempts)},s._operationTimeout),s._options.unref&&s._timeout.unref()),s._fn(s._attempts)},r),this._options.unref&&this._timer.unref(),!0},n.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},n.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},n.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},n.prototype.start=n.prototype.try,n.prototype.errors=function(){return this._errors},n.prototype.attempts=function(){return this._attempts},n.prototype.mainError=function(){if(this._errors.length===0)return null;for(var e={},t=null,r=0,s=0;s<this._errors.length;s++){var i=this._errors[s],a=i.message,c=(e[a]||0)+1;e[a]=c,c>=r&&(t=i,r=c)}return t},L2}var $7;function hj(){return $7||($7=1,function(n){var e=dj();n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)r[s]=t[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<r.retries;a++)i.push(this.createTimeout(a,r));return t&&t.forever&&!i.length&&i.push(this.createTimeout(a,r)),i.sort(function(c,u){return c-u}),i},n.createTimeout=function(t,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(t,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var c=s[a],u=t[c];t[c]=(function(f){var p=n.operation(r),m=Array.prototype.slice.call(arguments,1),w=m.pop();m.push(function(x){p.retry(x)||(x&&(arguments[0]=p.mainError()),w.apply(this,arguments))}),p.attempt(function(){f.apply(t,m)})}).bind(t,u),t[c].options=r}}}(R2)),R2}var O2,z7;function fj(){return z7||(z7=1,O2=hj()),O2}var pj=fj();const gj=_u(pj),mj=Object.prototype.toString,yj=n=>mj.call(n)==="[object Error]",wj=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed","terminated"]);function vj(n){return n&&yj(n)&&n.name==="TypeError"&&typeof n.message=="string"?n.message==="Load failed"?n.stack===void 0:wj.has(n.message):!1}let bj=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}};const H7=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n};async function xj(n,e){return new Promise((t,r)=>{e={...e},e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.retries??=10;const s=gj.operation(e),i=()=>{s.stop(),r(e.signal?.reason)};e.signal&&!e.signal.aborted&&e.signal.addEventListener("abort",i,{once:!0});const a=()=>{e.signal?.removeEventListener("abort",i),s.stop()};s.attempt(async c=>{try{const u=await n(c);a(),t(u)}catch(u){try{if(!(u instanceof Error))throw new TypeError(`Non-error was thrown: "${u}". You should only throw errors.`);if(u instanceof bj)throw u.originalError;if(u instanceof TypeError&&!vj(u))throw u;if(H7(u,c,e),await e.shouldRetry(u)||(s.stop(),r(u)),await e.onFailedAttempt(u),!s.retry(u))throw s.mainError()}catch(h){H7(h,c,e),a(),r(h)}}})})}class Sj{log;queue;started;peerStore;retries;retryInterval;backoffFactor;connectionManager;events;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:reconnect-queue"),this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.queue=new du({concurrency:t.maxParallelReconnects??GV,metricName:"libp2p_reconnect_queue",metrics:e.metrics}),this.started=!1,this.retries=t.retries??5,this.backoffFactor=t.backoffFactor,this.retryInterval=t.retryInterval,this.events=e.events,e.events.addEventListener("peer:disconnect",r=>{this.maybeReconnect(r.detail).catch(s=>{this.log.error("failed to maybe reconnect to %p - %e",r.detail,s)})})}async maybeReconnect(e){if(!this.started)return;const t=await this.peerStore.get(e);K7(t)&&(this.queue.has(e)||this.queue.add(async r=>{await xj(async s=>{if(this.started)try{await this.connectionManager.openConnection(e,{signal:r?.signal})}catch(i){throw this.log("reconnecting to %p attempt %d of %d failed - %e",e,s,this.retries,i),i}},{signal:r?.signal,retries:this.retries,factor:this.backoffFactor,minTimeout:this.retryInterval})},{peerId:e}).catch(async r=>{this.log.error("failed to reconnect to %p - %e",e,r);const s={};[...t.tags.keys()].forEach(i=>{i.startsWith(d1)&&(s[i]=void 0)}),await this.peerStore.merge(e,{tags:s}),this.events.safeDispatchEvent("peer:reconnect-failure",{detail:e})}).catch(async r=>{this.log.error("failed to remove keep-alive tag from %p - %e",e,r)}))}start(){this.started=!0}async afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>K7(t)]});await Promise.all(e.map(async t=>{await this.connectionManager.openConnection(t.id).catch(r=>{this.log.error(r)})}))}).catch(e=>{this.log.error(e)})}stop(){this.started=!1,this.queue.abort()}}function K7(n){for(const e of n.tags.keys())if(e.startsWith(d1))return!0;return!1}const cS=50,B2={maxConnections:JV,inboundConnectionThreshold:qV,maxIncomingPendingConnections:WV};class Ej{started;connections;allow;deny;maxIncomingPendingConnections;incomingPendingConnections;outboundPendingConnections;maxConnections;dialQueue;reconnectQueue;connectionPruner;inboundConnectionRateLimiter;peerStore;metrics;events;log;peerId;constructor(e,t={}){if(this.maxConnections=t.maxConnections??B2.maxConnections,this.maxConnections<1)throw new Ae("Connection Manager maxConnections must be greater than 0");this.connections=new Mo,this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,this.log=e.logger.forComponent("libp2p:connection-manager"),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.allow=(t.allow??[]).map(r=>jg(r)),this.deny=(t.deny??[]).map(r=>jg(r)),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=t.maxIncomingPendingConnections??B2.maxIncomingPendingConnections,this.outboundPendingConnections=0,this.inboundConnectionRateLimiter=new VV({points:t.inboundConnectionThreshold??B2.inboundConnectionThreshold,duration:1}),this.connectionPruner=new HV({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{allow:t.allow?.map(r=>Pe(r))}),this.dialQueue=new uj(e,{addressSorter:t.addressSorter,maxParallelDials:t.maxParallelDials??aS,maxDialQueueLength:t.maxDialQueueLength??oS,maxPeerAddrsToDial:t.maxPeerAddrsToDial??iS,dialTimeout:t.dialTimeout??sS,resolvers:t.resolvers??{dnsaddr:p3},connections:this.connections}),this.reconnectQueue=new Sj({events:e.events,peerStore:e.peerStore,logger:e.logger,connectionManager:this},{retries:t.reconnectRetries,retryInterval:t.reconnectRetryInterval,backoffFactor:t.reconnectBackoffFactor,maxParallelReconnects:t.maxParallelReconnects})}[Symbol.toStringTag]="@libp2p/connection-manager";async start(){this.metrics?.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,"inbound pending":this.incomingPendingConnections,outbound:0,"outbound pending":this.outboundPendingConnections};for(const t of this.connections.values())for(const r of t)e[r.direction]++;return e}}),this.metrics?.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const t of this.connections.values())for(const r of t)for(const s of r.streams){const i=`${s.direction} ${s.protocol??"unnegotiated"}`;e[i]=(e[i]??0)+1}return e}}),this.metrics?.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const r of this.connections.values())for(const s of r){const i={};for(const a of s.streams){const c=`${a.direction} ${a.protocol??"unnegotiated"}`;i[c]=(i[c]??0)+1}for(const[a,c]of Object.entries(i))e[a]=e[a]??[],e[a].push(c)}const t={};for(let[r,s]of Object.entries(e)){s=s.sort((a,c)=>a-c);const i=Math.floor(s.length*.9);t[r]=s[i]}return t}}),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),await Jc(this.dialQueue,this.reconnectQueue,this.connectionPruner),this.started=!0,this.log("started")}async stop(){this.events.removeEventListener("connection:open",this.onConnect),this.events.removeEventListener("connection:close",this.onDisconnect),await f1(this.reconnectQueue,this.dialQueue,this.connectionPruner);const e=[];for(const t of this.connections.values())for(const r of t)e.push((async()=>{try{await r.close()}catch(s){this.log.error(s)}})());this.log("closing %d connections",e.length),await Promise.all(e),this.connections.clear(),this.log("stopped")}getMaxConnections(){return this.maxConnections}setMaxConnections(e){if(this.maxConnections<1)throw new Ae("Connection Manager maxConnections must be greater than 0");let t=!1;e<this.maxConnections&&(t=!0),this.maxConnections=e,t&&this.connectionPruner.maybePruneConnections()}onConnect(e){this._onConnect(e).catch(t=>{this.log.error(t)})}async _onConnect(e){const{detail:t}=e;if(!this.started){await t.close();return}if(t.status!=="open")return;const r=t.remotePeer,s=!this.connections.has(r),i=this.connections.get(r)??[];i.push(t),this.connections.set(r,i),r.publicKey!=null&&r.type==="RSA"&&await this.peerStore.patch(r,{publicKey:r.publicKey}),s&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e,r=t.remotePeer,i=(this.connections.get(r)??[]).filter(a=>a.id!==t.id);this.connections.set(r,i),i.length===0&&(this.log("onDisconnect remove all connections for peer %p",r),this.connections.delete(r),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){if(e!=null)return this.connections.get(e)??[];let t=[];for(const r of this.connections.values())t=t.concat(r);return t}getConnectionsMap(){return this.connections}async openConnection(e,t={}){if(!this.started)throw new cf("Not started");this.outboundPendingConnections++;try{t.signal?.throwIfAborted();const{peerId:r}=rS(e);if(this.peerId.equals(r))throw new qv("Can not dial self");if(r!=null&&t.force!==!0){this.log("dial %p",r);const c=this.getConnections(r).find(u=>u.limits==null);if(c!=null)return this.log("had an existing non-limited connection to %p",r),t.onProgress?.(new qe("dial-queue:already-connected")),c}const s=await this.dialQueue.dial(e,{...t,priority:t.priority??cS});if(s.status!=="open")throw new Hv("Remote closed connection during opening");let i=this.connections.get(s.remotePeer);i==null&&(i=[],this.connections.set(s.remotePeer,i));let a=!1;for(const c of i)if(c.id===s.id&&(a=!0),t.force!==!0&&c.id!==s.id&&c.remoteAddr.equals(s.remoteAddr))return s.abort(new zm("Duplicate multiaddr connection")),c;return a||i.push(s),s}finally{this.outboundPendingConnections--}}async closeConnections(e,t={}){const r=this.connections.get(e)??[];await Promise.all(r.map(async s=>{try{await s.close(t)}catch(i){s.abort(i)}}))}async acceptIncomingConnection(e){if(this.deny.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.log("connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some(s=>s.contains(e.remoteAddr.nodeAddress().address)))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return this.log("connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const s=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(s,1)}catch{return this.log("connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,s),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):(this.log("connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){const e={queued:"queued",running:"active",errored:"error",complete:"success"};return this.dialQueue.queue.queue.map(t=>({id:t.id,status:e[t.status],peerId:t.options.peerId,multiaddrs:[...t.options.multiaddrs].map(r=>Pe(r))}))}async isDialable(e,t={}){return this.dialQueue.isDialable(e,t)}}class F2{movingAverage;variance;deviation;forecast;timeSpan;previousTime;constructor(e){this.timeSpan=e,this.movingAverage=0,this.variance=0,this.deviation=0,this.forecast=0}alpha(e,t){return 1-Math.exp(-(e-t)/this.timeSpan)}push(e,t=Date.now()){if(this.previousTime!=null){const r=this.alpha(t,this.previousTime),s=e-this.movingAverage,i=r*s;this.movingAverage=r*e+(1-r)*this.movingAverage,this.variance=(1-r)*(this.variance+s*i),this.deviation=Math.sqrt(this.variance),this.forecast=this.movingAverage+r*s}else this.movingAverage=e;this.previousTime=t}}const Cj=1.2,kj=2,Aj=5e3,Pj=6e4,Tj=5e3;class hu{success;failure;next;metric;timeoutMultiplier;failureMultiplier;minTimeout;maxTimeout;constructor(e={}){const t=e.interval??Tj;this.success=new F2(t),this.failure=new F2(t),this.next=new F2(t),this.failureMultiplier=e.failureMultiplier??kj,this.timeoutMultiplier=e.timeoutMultiplier??Cj,this.minTimeout=e.minTimeout??Aj,this.maxTimeout=e.maxTimeout??Pj,e.metricName!=null&&(this.metric=e.metrics?.registerMetricGroup(e.metricName))}getTimeoutSignal(e={}){let t=Math.round(this.next.movingAverage*(e.timeoutFactor??this.timeoutMultiplier));t<this.minTimeout&&(t=this.minTimeout),t>this.maxTimeout&&(t=this.maxTimeout);const r=AbortSignal.timeout(t),s=An([e.signal,r]);return s.start=Date.now(),s.timeout=t,s}cleanUp(e){const t=Date.now()-e.start;e.aborted?(this.failure.push(t),this.next.push(t*this.failureMultiplier),this.metric?.update({failureMovingAverage:this.failure.movingAverage,failureDeviation:this.failure.deviation,failureForecast:this.failure.forecast,failureVariance:this.failure.variance,failure:t})):(this.success.push(t),this.next.push(t),this.metric?.update({successMovingAverage:this.success.movingAverage,successDeviation:this.success.deviation,successForecast:this.success.forecast,successVariance:this.success.variance,success:t}))}}let _j=class{readNext;haveNext;ended;nextResult;error;constructor(){this.ended=!1,this.readNext=Ke(),this.haveNext=Ke()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Ke(),e}async throw(e){return this.ended=!0,this.error=e,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw this.error??new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Ke(),await Dt(this.readNext.promise,t?.signal,t)}};function uS(){return new _j}let Dj=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function Nf(n,e){const t=uS();n.sink(t).catch(async a=>{await t.end(a)}),n.sink=async a=>{for await(const c of a)await t.push(c);await t.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const s=new Ie;return{read:async a=>{if(a?.signal?.throwIfAborted(),a?.bytes==null){const{done:u,value:h}=await Dt(r.next(),a?.signal);return u===!0?null:h}for(;s.byteLength<a.bytes;){const{value:u,done:h}=await Dt(r.next(),a?.signal);if(h===!0)throw new Dj("unexpected end of input");s.append(u)}const c=s.sublist(0,a.bytes);return s.consume(a.bytes),c},write:async(a,c)=>{c?.signal?.throwIfAborted(),a instanceof Uint8Array?await t.push(a,c):await t.push(a.subarray(),c)},unwrap:()=>{if(s.byteLength>0){const a=n.source;n.source=async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*a}()}return n}}}const Ij=1e4,Nj="1.0.0",Mj="ping",Rj="ipfs",q7=32,Lj=!0;class Oj{protocol;components;log;heartbeatInterval;pingIntervalMs;abortController;timeout;abortConnectionOnPingFailure;constructor(e,t={}){this.components=e,this.protocol=`/${t.protocolPrefix??Rj}/${Mj}/${Nj}`,this.log=e.logger.forComponent("libp2p:connection-monitor"),this.pingIntervalMs=t.pingInterval??Ij,this.abortConnectionOnPingFailure=t.abortConnectionOnPingFailure??Lj,this.timeout=new hu({...t.pingTimeout??{},metrics:e.metrics,metricName:"libp2p_connection_monitor_ping_time_milliseconds"})}[Symbol.toStringTag]="@libp2p/connection-monitor";[br]=["@libp2p/connection-monitor"];start(){this.abortController=new AbortController,this.abortController.signal,this.heartbeatInterval=setInterval(()=>{this.components.connectionManager.getConnections().forEach(e=>{Promise.resolve().then(async()=>{let t=Date.now();try{const r=this.timeout.getTimeoutSignal({signal:this.abortController?.signal}),s=await e.newStream(this.protocol,{signal:r,runOnLimitedConnection:!0}),i=Nf(s);t=Date.now(),await Promise.all([i.write(w1(q7),{signal:r}),i.read({bytes:q7,signal:r})]),e.rtt=Date.now()-t,await i.unwrap().close({signal:r})}catch(r){if(r.name!=="UnsupportedProtocolError")throw r;e.rtt=(Date.now()-t)/2}}).catch(t=>{this.log.error("error during heartbeat",t),this.abortConnectionOnPingFailure?(this.log.error("aborting connection due to ping failure"),e.abort(t)):this.log("connection ping failed, but not aborting due to abortConnectionOnPingFailure flag")})})},this.pingIntervalMs)}stop(){this.abortController?.abort(),this.heartbeatInterval!=null&&clearInterval(this.heartbeatInterval)}}function Bj(n){return n[Symbol.asyncIterator]!=null}async function Fj(n,e,t){try{await Promise.all(n.map(async r=>{for await(const s of r)await e.push(s,{signal:t}),t.throwIfAborted()})),await e.end(void 0,{signal:t})}catch(r){await e.end(r,{signal:t}).catch(()=>{})}}async function*Uj(n){const e=new AbortController,t=uS();Fj(n,t,e.signal).catch(()=>{});try{yield*t}finally{e.abort()}}function*Vj(n){for(const e of n)yield*e}function fu(...n){const e=[];for(const t of n)Bj(t)||e.push(t);return e.length===n.length?Vj(e):Uj(n)}class jj{routers;started;components;constructor(e,t){this.routers=t.routers??[],this.started=!1,this.components=e,this.findProviders=e.metrics?.traceFunction("libp2p.contentRouting.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()}),getAttributesFromYieldedValue:(r,s)=>({...s,providers:[...Array.isArray(s.providers)?s.providers:[],r.id.toString()]})})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.contentRouting.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()})})??this.provide,this.cancelReprovide=e.metrics?.traceFunction("libp2p.contentRouting.cancelReprovide",this.cancelReprovide.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,cid:r.toString()})})??this.cancelReprovide,this.put=e.metrics?.traceFunction("libp2p.contentRouting.put",this.put.bind(this),{optionsIndex:2,getAttributesFromArgs:([r])=>({key:pe(r,"base36")})})??this.put,this.get=e.metrics?.traceFunction("libp2p.contentRouting.get",this.get.bind(this),{optionsIndex:1,getAttributesFromArgs:([r])=>({key:pe(r,"base36")})})??this.get}[Symbol.toStringTag]="@libp2p/content-routing";isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}async*findProviders(e,t={}){if(this.routers.length===0)throw new M2("No content routers available");const r=this,s=new bs;for await(const i of fu(...r.routers.filter(a=>a.findProviders instanceof Function).map(a=>a.findProviders(e,t))))i!=null&&(i.multiaddrs.length>0&&await this.components.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id)&&(s.add(i.id),yield i))}async provide(e,t={}){if(this.routers.length===0)throw new M2("No content routers available");await Promise.all(this.routers.filter(r=>r.provide instanceof Function).map(async r=>{await r.provide(e,t)}))}async cancelReprovide(e,t={}){if(this.routers.length===0)throw new M2("No content routers available");await Promise.all(this.routers.filter(r=>r.cancelReprovide instanceof Function).map(async r=>{await r.cancelReprovide(e,t)}))}async put(e,t,r){if(!this.isStarted())throw new cf;await Promise.all(this.routers.filter(s=>s.put instanceof Function).map(async s=>{await s.put(e,t,r)}))}async get(e,t){if(!this.isStarted())throw new cf;return Promise.any(this.routers.filter(r=>r.get instanceof Function).map(async r=>r.get(e,t)))}}const Nh=globalThis.CustomEvent??Event;async function*E3(n,e={}){let t=e.concurrency??1/0;t<1&&(t=1/0);const r=e.ordered??!1,s=new EventTarget,i=[];let a=Ke(),c=Ke(),u=!1,h,f=!1;s.addEventListener("task-complete",()=>{c.resolve()}),Promise.resolve().then(async()=>{try{for await(const x of n){if(i.length===t&&(a=Ke(),await a.promise),f)break;const S={done:!1};i.push(S),x().then(E=>{S.done=!0,S.ok=!0,S.value=E,s.dispatchEvent(new Nh("task-complete"))},E=>{S.done=!0,S.err=E,s.dispatchEvent(new Nh("task-complete"))})}u=!0,s.dispatchEvent(new Nh("task-complete"))}catch(x){h=x,s.dispatchEvent(new Nh("task-complete"))}});function p(){return r?i[0]?.done:!!i.find(x=>x.done)}function*m(){for(;i.length>0&&i[0].done;){const x=i[0];if(i.shift(),x.ok)yield x.value;else throw f=!0,a.resolve(),x.err;a.resolve()}}function*w(){for(;p();)for(let x=0;x<i.length;x++)if(i[x].done){const S=i[x];if(i.splice(x,1),x--,S.ok)yield S.value;else throw f=!0,a.resolve(),S.err;a.resolve()}}for(;;){if(p()||(c=Ke(),await c.promise),h!=null||(r?yield*m():yield*w(),h!=null))throw h;if(u&&i.length===0)break}}class $j{log;peerId;peerStore;routers;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:peer-routing"),this.peerId=e.peerId,this.peerStore=e.peerStore,this.routers=t.routers??[],this.findPeer=e.metrics?.traceFunction("libp2p.peerRouting.findPeer",this.findPeer.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,peer:r.toString()})})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.peerRouting.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1,getAttributesFromArgs:([r],s)=>({...s,key:pe(r,"base36")}),getAttributesFromYieldedValue:(r,s)=>({...s,peers:[...Array.isArray(s.peers)?s.peers:[],r.id.toString()]})})??this.getClosestPeers}[Symbol.toStringTag]="@libp2p/peer-routing";async findPeer(e,t){if(this.routers.length===0)throw new O7("No peer routers available");if(e.toString()===this.peerId.toString())throw new pV("Should not try to find self");const r=this,s=fu(...this.routers.filter(i=>i.findPeer instanceof Function).map(i=>async function*(){try{yield await i.findPeer(e,t)}catch(a){r.log.error(a)}}()));for await(const i of s)if(i!=null)return i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),i;throw new Si}async*getClosestPeers(e,t={}){if(this.routers.length===0)throw new O7("No peer routers available");const r=this,s=Xa(1024);for await(const i of E3(async function*(){const a=fu(...r.routers.filter(c=>c.getClosestPeers instanceof Function).map(c=>c.getClosestPeers(e,t)));for await(let c of a)yield async()=>{if(c.multiaddrs.length===0)try{c=await r.findPeer(c.id,{...t,useCache:!1})}catch(u){r.log.error("could not find peer multiaddrs",u);return}return c}}()))i!=null&&(i.multiaddrs.length>0&&await this.peerStore.merge(i.id,{multiaddrs:i.multiaddrs},t),!s.has(i.id.toMultihash().bytes)&&(s.add(i.id.toMultihash().bytes),yield i))}}class zj extends ln{peerRouting;log;walking;walkers;shutdownController;walkController;needNext;constructor(e){super(),this.log=e.logger.forComponent("libp2p:random-walk"),this.peerRouting=e.peerRouting,this.walkers=0,this.walking=!1,this.shutdownController=new AbortController,this.shutdownController.signal}[Symbol.toStringTag]="@libp2p/random-walk";start(){this.shutdownController=new AbortController,this.shutdownController.signal}stop(){this.shutdownController.abort()}async*walk(e){this.walking||this.startWalk(),this.walkers++;const t=An([this.shutdownController.signal,e?.signal]);try{for(;;)this.needNext?.resolve(),this.needNext=Ke(),yield(await Ss(this,"walk:peer",t,{errorEvent:"walk:error"})).detail}finally{t.clear(),this.walkers--,this.walkers===0&&(this.walkController?.abort(),this.walkController=void 0)}}startWalk(){this.walking=!0,this.walkController=new AbortController,this.walkController.signal;const e=An([this.walkController.signal,this.shutdownController.signal]),t=Date.now();let r=0;Promise.resolve().then(async()=>{for(this.log("start walk");this.walkers>0;)try{const s=w1(32);let i=Date.now();for await(const a of this.peerRouting.getClosestPeers(s,{signal:e}))e.aborted&&this.log("aborting walk"),e.throwIfAborted(),this.log("found peer %p after %dms for %d walkers",a.id,Date.now()-i,this.walkers),r++,this.safeDispatchEvent("walk:peer",{detail:a}),this.walkers===1&&this.needNext!=null&&(this.log("wait for need next"),await Dt(this.needNext.promise,e)),i=Date.now();this.log("walk iteration for %b and %d walkers finished, found %d peers",s,this.walkers,r)}catch(s){this.log.error("random walk errored",s),this.safeDispatchEvent("walk:error",{detail:s})}this.log("no walkers left, ended walk")}).catch(s=>{this.log.error("random walk errored",s)}).finally(()=>{this.log("finished walk, found %d peers after %dms",r,Date.now()-t),this.walking=!1})}}const dS=32,hS=64;class Hj{log;topologies;handlers;components;constructor(e){this.components=e,this.log=e.logger.forComponent("libp2p:registrar"),this.topologies=new Map,e.metrics?.registerMetricGroup("libp2p_registrar_topologies",{calculate:()=>{const t={};for(const[r,s]of this.topologies)t[r]=s.size;return t}}),this.handlers=As({name:"libp2p_registrar_protocol_handlers",metrics:e.metrics}),this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}[Symbol.toStringTag]="@libp2p/registrar";getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(t==null)throw new gV(`No handler registered for protocol ${e}`);return t}getTopologies(e){const t=this.topologies.get(e);return t==null?[]:[...t.values()]}async handle(e,t,r){if(this.handlers.has(e)&&r?.force!==!0)throw new mV(`Handler already registered for protocol ${e}`);const s=tx.bind({ignoreUndefined:!0})({maxInboundStreams:dS,maxOutboundStreams:hS},r);this.handlers.set(e,{handler:t,options:s}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]},r)}async unhandle(e,t){(Array.isArray(e)?e:[e]).forEach(s=>{this.handlers.delete(s)}),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()},t)}async register(e,t){if(t==null)throw new Ae("invalid topology");const r=`${(Math.random()*1e9).toString(36)}${Date.now()}`;let s=this.topologies.get(e);return s==null&&(s=new Map,this.topologies.set(e,s)),s.set(r,t),r}unregister(e){for(const[t,r]of this.topologies.entries())r.has(e)&&(r.delete(e),r.size===0&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail,r={signal:AbortSignal.timeout(5e3)};this.components.peerStore.get(t,r).then(s=>{for(const i of s.protocols){const a=this.topologies.get(i);if(a!=null)for(const c of a.values())c.filter?.has(t)!==!1&&(c.filter?.remove(t),c.onDisconnect?.(t))}}).catch(s=>{s.name!=="NotFoundError"&&this.log.error("could not inform topologies of disconnecting peer %p",t,s)})}_onPeerUpdate(e){const{peer:t,previous:r}=e.detail,s=(r?.protocols??[]).filter(i=>!t.protocols.includes(i));for(const i of s){const a=this.topologies.get(i);if(a!=null)for(const c of a.values())c.filter?.has(t.id)!==!1&&(c.filter?.remove(t.id),c.onDisconnect?.(t.id))}}_onPeerIdentify(e){const t=e.detail.protocols,r=e.detail.connection,s=e.detail.peerId;for(const i of t){const a=this.topologies.get(i);if(a!=null)for(const c of a.values())r.limits!=null&&c.notifyOnLimitedConnection!==!0||c.filter?.has(s)!==!0&&(c.filter?.add(s),c.onConnect?.(s,r))}}}class Kj{log;components;transports;listeners;faultTolerance;started;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:transports"),this.components=e,this.started=!1,this.transports=As({name:"libp2p_transport_manager_transports",metrics:this.components.metrics}),this.listeners=As({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=t.faultTolerance??Xc.FATAL_ALL}[Symbol.toStringTag]="@libp2p/transport-manager";add(e){const t=e[Symbol.toStringTag];if(t==null)throw new Ae("Transport must have a valid tag");if(this.transports.has(t))throw new Ae(`There is already a transport with the tag ${t}`);this.log("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,r]of this.listeners)for(this.log("closing listeners for %s",t);r.length>0;){const s=r.pop();s!=null&&e.push(s.close())}await Promise.all(e),this.log("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const r=this.dialTransportForMultiaddr(e);if(r==null)throw new SV(`No transport available for address ${String(e)}`);return t?.onProgress?.(new qe("transport-manager:selected-transport",r[Symbol.toStringTag])),r.dial(e,{...t,upgrader:this.components.upgrader})}getAddrs(){let e=[];for(const t of this.listeners.values())for(const r of t)e=[...e,...r.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}dialTransportForMultiaddr(e){for(const t of this.transports.values())if(t.dialFilter([e]).length>0)return t}listenTransportForMultiaddr(e){for(const t of this.transports.values())if(t.listenFilter([e]).length>0)return t}async listen(e){if(!this.isStarted())throw new cf("Not started");if(e==null||e.length===0){this.log("no addresses were provided for listening, this node is dial only");return}const t={errors:new Map,ipv4:{success:0,attempts:0},ipv6:{success:0,attempts:0}};e.forEach(i=>{t.errors.set(i.toString(),new yV)});const r=[];for(const[i,a]of this.transports.entries()){const c=a.listenFilter(e);for(const u of c){this.log("creating listener for %s on %a",i,u);const h=a.createListener({upgrader:this.components.upgrader});let f=this.listeners.get(i)??[];f==null&&(f=[],this.listeners.set(i,f)),f.push(h),h.addEventListener("listening",()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:h})}),h.addEventListener("close",()=>{const p=f.findIndex(m=>m===h);f.splice(p,1),this.components.events.safeDispatchEvent("transport:close",{detail:h})}),P7.matches(u)?t.ipv4.attempts++:T7.matches(u)&&t.ipv6.attempts++,r.push(h.listen(u).then(()=>{t.errors.delete(u.toString()),P7.matches(u)&&t.ipv4.success++,T7.matches(u)&&t.ipv6.success++},p=>{throw this.log.error("transport %s could not listen on address %a - %e",i,u,p),t.errors.set(u.toString(),p),p}))}}const s=await Promise.allSettled(r);if(!(s.length>0&&s.every(i=>i.status==="fulfilled"))){if(this.ipv6Unsupported(t)){this.log("all IPv4 addresses succeed but all IPv6 failed");return}if(this.faultTolerance===Xc.NO_FATAL){this.log("failed to listen on any address but fault tolerance allows this");return}throw new wV(`Some configured addresses failed to be listened on, you may need to remove one or more listen addresses from your configuration or set \`transportManager.faultTolerance\` to NO_FATAL:
${[...t.errors.entries()].map(([i,a])=>`
  ${i}: ${`${a.stack??a}`.split(`
`).join(`
  `)}
`).join("")}`)}}ipv6Unsupported(e){if(e.ipv4.attempts===0||e.ipv6.attempts===0)return!1;const t=e.ipv4.attempts===e.ipv4.success,r=e.ipv6.success===0;return t&&r}async remove(e){const t=this.listeners.get(e)??[];this.log.trace("removing transport %s",e);const r=[];for(this.log.trace("closing listeners for %s",e);t.length>0;){const s=t.pop();s!=null&&r.push(s.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const Cn="/multistream/1.0.0",C3=1024;let qj=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},Wj=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},Gj=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"};function T1(n,e={}){const t=Nf(n,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ft(e.maxDataLength));const r=e?.lengthDecoder??_o,s=e?.lengthEncoder??mi;return{read:async a=>{let c=-1;const u=new Ie;for(;;){u.append(await t.read({...a,bytes:1}));try{c=r(u)}catch(h){if(h instanceof RangeError)continue;throw h}if(c<0)throw new qj("Invalid message length");if(e?.maxLengthLength!=null&&u.byteLength>e.maxLengthLength)throw new Gj("message length length too long");if(c>-1)break}if(e?.maxDataLength!=null&&c>e.maxDataLength)throw new Wj("message length too long");return t.read({...a,bytes:c})},write:async(a,c)=>{await t.write(new Ie(s(a.byteLength),a),c)},writeV:async(a,c)=>{const u=new Ie(...a.flatMap(h=>[s(h.byteLength),h]));await t.write(u,c)},unwrap:()=>t.unwrap()}}const Qj=we(`
`);async function Ic(n,e,t){await n.write(e,t)}async function Yj(n,e,t){await n.writeV(e,t)}async function Xj(n,e){const t=await n.read(e);if(t.byteLength===0||t.get(t.byteLength-1)!==Qj[0])throw e.log.error("Invalid mss message - missing newline",t),new Kt("Missing newline");return t.sublist(0,-1)}async function Ra(n,e){const t=await Xj(n,e);return pe(t.subarray())}async function U2(n,e,t){if(e=Array.isArray(e)?[...e]:[e],e.length===1&&t.negotiateFully===!1)return Jj(n,e[0],t);const r=T1(n,{...t,maxDataLength:C3}),s=e.shift();if(s==null)throw new Error("At least one protocol must be specified");t.log.trace('select: write ["%s", "%s"]',Cn,s);const i=we(`${Cn}
`),a=we(`${s}
`);await Yj(r,[i,a],t),t.log.trace("select: reading multistream-select header");let c=await Ra(r,t);if(t.log.trace('select: read "%s"',c),c===Cn&&(t.log.trace("select: reading protocol response"),c=await Ra(r,t),t.log.trace('select: read "%s"',c)),c===s)return{stream:r.unwrap(),protocol:s};for(const u of e){t.log.trace('select: write "%s"',u),await Ic(r,we(`${u}
`),t),t.log.trace("select: reading protocol response");const h=await Ra(r,t);if(t.log.trace('select: read "%s" for "%s"',h,u),h===u)return{stream:r.unwrap(),protocol:u}}throw new Hm("protocol selection failed")}function Jj(n,e,t){const r=n.sink.bind(n),s=n.source;let i=!1,a=!1;const c=Ke();let u=!1,h=!1;const f=Ke();let p=!1,m=!1;const w=Ke(),x=T1({sink:r,source:s},{...t,maxDataLength:C3});n.sink=async P=>{const{sink:k}=x.unwrap();await k(async function*(){let F=!1;for await(const I of P){if(h&&await f.promise,u)yield I;else{h=!0,t.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',Cn,e,I.byteLength);const V=`${e}
`;yield new Ie(Uint8Array.from([19]),we(`${Cn}
`),mi(V.length),we(V),I).subarray(),t.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',Cn,e,I.byteLength),u=!0,h=!1,f.resolve(),S().catch(Q=>{t.log.error("could not finish optimistic protocol negotiation of %s",e,Q)})}F=!0}F||await S()}())};async function S(){if(a){t.log.trace("optimistic: already negotiating %s stream",e),await c.promise;return}a=!0;try{u||(t.log.trace("optimistic: doing send protocol for %s stream",e),await E()),p||(t.log.trace("optimistic: doing read protocol for %s stream",e),await A())}finally{a=!1,i=!0,c.resolve()}}async function E(){if(h){await f.promise;return}h=!0;try{t.log.trace('optimistic: write ["%s", "%s", data] in source',Cn,e),await x.writeV([we(`${Cn}
`),we(`${e}
`)]),t.log.trace('optimistic: wrote ["%s", "%s", data] in source',Cn,e)}finally{u=!0,h=!1,f.resolve()}}async function A(){if(m){await w.promise;return}m=!0;try{t.log.trace("optimistic: reading multistream select header");let P=await Ra(x,t);if(t.log.trace('optimistic: read multistream select header "%s"',P),P===Cn&&(P=await Ra(x,t)),t.log.trace('optimistic: read protocol "%s", expecting "%s"',P,e),P!==e)throw new Hm("protocol selection failed")}finally{p=!0,m=!1,w.resolve()}}if(n.source=async function*(){await S(),t.log.trace('optimistic: reading data from "%s" stream',e),yield*x.unwrap().source}(),n.closeRead!=null){const P=n.closeRead.bind(n);n.closeRead=async k=>{i||await S().catch(F=>{t.log.error("could not negotiate protocol before close read",F)}),await P(k)}}if(n.closeWrite!=null){const P=n.closeWrite.bind(n);n.closeWrite=async k=>{i||await S().catch(F=>{t.log.error("could not negotiate protocol before close write",F)}),await P(k)}}if(n.close!=null){const P=n.close.bind(n);n.close=async k=>{const F=[];h&&F.push(f.promise),m&&F.push(w.promise),F.length>0?await Dt(Promise.all(F),k?.signal):(i=!0,a=!1,c.resolve()),await P(k)}}return{stream:n,protocol:e}}const Zj=8,k3=1024*1024*4;let e$=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},fS=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},t$=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},W7=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};function pS(n){return n[Symbol.asyncIterator]!=null}function gS(n,e){if(n.byteLength>e)throw new fS("Message length too long")}const _1=n=>{const e=Ft(n),t=Sr(e);return mi(n,t),_1.bytes=e,t};_1.bytes=0;function Mf(n,e){e=e??{};const t=e.lengthEncoder??_1,r=e?.maxDataLength??k3;function*s(i){gS(i,r);const a=t(i.byteLength);a instanceof Uint8Array?yield a:yield*a,i instanceof Uint8Array?yield i:yield*i}return pS(n)?async function*(){for await(const i of n)yield*s(i)}():function*(){for(const i of n)yield*s(i)}()}Mf.single=(n,e)=>{e=e??{};const t=e.lengthEncoder??_1,r=e?.maxDataLength??k3;return gS(n,r),new Ie(t(n.byteLength),n)};var Gi;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(Gi||(Gi={}));const A3=n=>{const e=_o(n);return A3.bytes=Ft(e),e};A3.bytes=0;function $g(n,e){const t=new Ie;let r=Gi.LENGTH,s=-1;const i=e?.lengthDecoder??A3,a=e?.maxLengthLength??Zj,c=e?.maxDataLength??k3;function*u(){for(;t.byteLength>0;){if(r===Gi.LENGTH)try{if(s=i(t),s<0)throw new e$("Invalid message length");if(s>c)throw new fS("Message length too long");const h=i.bytes;t.consume(h),e?.onLength!=null&&e.onLength(s),r=Gi.DATA}catch(h){if(h instanceof RangeError){if(t.byteLength>a)throw new t$("Message length length too long");break}throw h}if(r===Gi.DATA){if(t.byteLength<s)break;const h=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(h),yield h,r=Gi.LENGTH}}}return pS(n)?async function*(){for await(const h of n)t.append(h),yield*u();if(t.byteLength>0)throw new W7("Unexpected end of input")}():function*(){for(const h of n)t.append(h),yield*u();if(t.byteLength>0)throw new W7("Unexpected end of input")}()}$g.fromReader=(n,e)=>{let t=1;const r=async function*(){for(;;)try{const{done:i,value:a}=await n.next(t);if(i===!0)return;a!=null&&(yield a)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return $g(r,{...e??{},onLength:i=>{t=i}})};async function V2(n,e,t){e=Array.isArray(e)?e:[e],t.log.trace("handle: available protocols %s",e);const r=T1(n,{...t,maxDataLength:C3,maxLengthLength:2});for(;;){t.log.trace("handle: reading incoming string");const s=await Ra(r,t);if(t.log.trace('handle: read "%s"',s),s===Cn){t.log.trace('handle: respond with "%s" for "%s"',Cn,s),await Ic(r,we(`${Cn}
`),t),t.log.trace('handle: responded with "%s" for "%s"',Cn,s);continue}if(e.includes(s))return t.log.trace('handle: respond with "%s" for "%s"',s,s),await Ic(r,we(`${s}
`),t),t.log.trace('handle: responded with "%s" for "%s"',s,s),{stream:r.unwrap(),protocol:s};if(s==="ls"){const i=new Ie(...e.map(a=>Mf.single(we(`${a}
`))),we(`
`));t.log.trace('handle: respond with "%s" for %s',e,s),await Ic(r,i,t),t.log.trace('handle: responded with "%s" for %s',e,s);continue}t.log.trace('handle: respond with "na" for "%s"',s),await Ic(r,we(`na
`),t),t.log('handle: responded with "na" for "%s"',s)}}const n$=500;class r${id;remoteAddr;remotePeer;direction;timeline;multiplexer;encryption;status;limits;log;tags;_newStream;_close;_abort;_getStreams;constructor(e){const{remoteAddr:t,remotePeer:r,newStream:s,close:i,abort:a,getStreams:c}=e;this.id=`${parseInt(String(Math.random()*1e9)).toString(36)}${Date.now()}`,this.remoteAddr=t,this.remotePeer=r,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.limits=e.limits,this.log=e.logger.forComponent(`libp2p:connection:${this.direction}:${this.id}`),this.remoteAddr.getPeerId()==null&&(this.remoteAddr=this.remoteAddr.encapsulate(`/p2p/${this.remotePeer}`)),this._newStream=s,this._close=i,this._abort=a,this._getStreams=c,this.tags=[]}[Symbol.toStringTag]="Connection";[TN]=!0;get streams(){return this._getStreams()}async newStream(e,t){if(this.status==="closing")throw new _N("the connection is being closed");if(this.status==="closed")throw new Hv("the connection is closed");if(Array.isArray(e)||(e=[e]),this.limits!=null&&t?.runOnLimitedConnection!==!0)throw new Wv("Cannot open protocol stream on limited connection");const r=await this._newStream(e,t);return r.direction="outbound",r}async close(e={}){if(!(this.status==="closed"||this.status==="closing")){if(this.log("closing connection to %a",this.remoteAddr),this.status="closing",e.signal==null){const t=AbortSignal.timeout(n$);e={...e,signal:t}}try{this.log.trace("closing underlying transport"),await this._close(e),this.log.trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){this.log.error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){this.status!=="closed"&&(this.log.error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this._abort(e),this.status="closed",this.timeline.close=Date.now())}}function s$(n){return new r$(n)}function i$(n,e){try{const{options:t}=e.getHandler(n);return t.maxInboundStreams}catch(t){if(t.name!=="UnhandledProtocolError")throw t}return dS}function o$(n,e,t={}){try{const{options:r}=e.getHandler(n);if(r.maxOutboundStreams!=null)return r.maxOutboundStreams}catch(r){if(r.name!=="UnhandledProtocolError")throw r}return t.maxOutboundStreams??hS}function G7(n,e,t){let r=0;return t.streams.forEach(s=>{s.direction===e&&s.protocol===n&&r++}),r}class a${components;connectionEncrypters;streamMuxers;inboundUpgradeTimeout;inboundStreamProtocolNegotiationTimeout;outboundStreamProtocolNegotiationTimeout;events;metrics;constructor(e,t){this.components=e,this.connectionEncrypters=As({name:"libp2p_upgrader_connection_encrypters",metrics:this.components.metrics}),t.connectionEncrypters.forEach(r=>{this.connectionEncrypters.set(r.protocol,r)}),this.streamMuxers=As({name:"libp2p_upgrader_stream_multiplexers",metrics:this.components.metrics}),t.streamMuxers.forEach(r=>{this.streamMuxers.set(r.protocol,r)}),this.inboundUpgradeTimeout=t.inboundUpgradeTimeout??KV,this.inboundStreamProtocolNegotiationTimeout=t.inboundStreamProtocolNegotiationTimeout??U7,this.outboundStreamProtocolNegotiationTimeout=t.outboundStreamProtocolNegotiationTimeout??U7,this.events=e.events,this.metrics={dials:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_total"),errors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dial_errors_total"),inboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_inbound_errors_total"),outboundErrors:e.metrics?.registerCounterGroup("libp2p_connection_manager_dials_outbound_errors_total")}}[Symbol.toStringTag]="@libp2p/upgrader";async shouldBlockConnection(e,...t){const r=this.components.connectionGater[e];if(r==null)return;if(await r.apply(this.components.connectionGater,t)===!0)throw new bV(`The multiaddr connection is blocked by gater.${e}`)}createInboundAbortSignal(e){return An([AbortSignal.timeout(this.inboundUpgradeTimeout),e])}async upgradeInbound(e,t){let r=!1;const s=this.createInboundAbortSignal(t.signal);try{if(this.metrics.dials?.increment({inbound:!0}),r=await Dt(this.components.connectionManager.acceptIncomingConnection(e),s),!r)throw new xV("Connection denied");await Dt(this.shouldBlockConnection("denyInboundConnection",e),s),await this._performUpgrade(e,"inbound",{...t,signal:s})}catch(i){throw this.metrics.errors?.increment({inbound:!0}),this.metrics.inboundErrors?.increment({[i.name??"Error"]:!0}),i}finally{s.clear(),r&&this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){try{this.metrics.dials?.increment({outbound:!0});const r=e.remoteAddr.getPeerId();let s;r!=null&&(s=sr(r),await Dt(this.shouldBlockConnection("denyOutboundConnection",s,e),t.signal));let i="outbound";return t.initiator===!1&&(i="inbound"),await this._performUpgrade(e,i,t)}catch(r){throw this.metrics.errors?.increment({outbound:!0}),this.metrics.outboundErrors?.increment({[r.name??"Error"]:!0}),r}}async _performUpgrade(e,t,r){let s,i,a,c,u;this.components.metrics?.trackMultiaddrConnection(e),e.log.trace("starting the %s connection upgrade",t);let h=e;if(r?.skipProtection!==!0){const f=this.components.connectionProtector;f!=null&&(e.log("protecting the %s connection",t),h=await f.protect(e,r))}try{if(s=h,r?.skipEncryption!==!0){r?.onProgress?.(new qe(`upgrader:encrypt-${t}-connection`)),{conn:s,remotePeer:i,protocol:u,streamMuxer:c}=await(t==="inbound"?this._encryptInbound(h,r):this._encryptOutbound(h,r));const f={...h,...s};await this.shouldBlockConnection(t==="inbound"?"denyInboundEncryptedConnection":"denyOutboundEncryptedConnection",i,f)}else{const f=e.remoteAddr.getPeerId();if(f==null)throw new zm(`${t} connection that skipped encryption must have a peer id`);const p=sr(f);u="native",i=p}if(i.equals(this.components.peerId)){const f=new qv("Can not dial self");throw e.abort(f),f}if(a=s,r?.muxerFactory!=null)c=r.muxerFactory;else if(c==null&&this.streamMuxers.size>0){r?.onProgress?.(new qe(`upgrader:multiplex-${t}-connection`));const f=await(t==="inbound"?this._multiplexInbound({...h,...s},this.streamMuxers,r):this._multiplexOutbound({...h,...s},this.streamMuxers,r));c=f.muxerFactory,a=f.stream}}catch(f){throw e.log.error("failed to upgrade inbound connection %s %a - %e",t==="inbound"?"from":"to",e.remoteAddr,f),f}return await this.shouldBlockConnection(t==="inbound"?"denyInboundUpgradedConnection":"denyOutboundUpgradedConnection",i,e),e.log("successfully upgraded %s connection",t),this._createConnection({cryptoProtocol:u,direction:t,maConn:e,upgradedConn:a,muxerFactory:c,remotePeer:i,limits:r?.limits})}_createConnection(e){const{cryptoProtocol:t,direction:r,maConn:s,upgradedConn:i,remotePeer:a,muxerFactory:c,limits:u}=e;let h,f,p;c!=null&&(h=c.createStreamMuxer({direction:r,onIncomingStream:x=>{if(p==null)return;const S=AbortSignal.timeout(this.inboundStreamProtocolNegotiationTimeout);Promise.resolve().then(async()=>{const E=this.components.registrar.getProtocols(),{stream:A,protocol:P}=await V2(x,E,{signal:S,log:x.log,yieldBytes:!1});if(p==null)return;p.log("incoming stream opened on %s",P);const k=i$(P,this.components.registrar);if(G7(P,"inbound",p)===k){const I=new RN(`Too many inbound protocol streams for protocol "${P}" - limit ${k}`);throw x.abort(I),I}x.source=A.source,x.sink=A.sink,x.protocol=P,A.closeWrite!=null&&(x.closeWrite=A.closeWrite),A.closeRead!=null&&(x.closeRead=A.closeRead),A.close!=null&&(x.close=A.close),await this.components.peerStore.merge(a,{protocols:[P]},{signal:S}),this.components.metrics?.trackProtocolStream(x,p),this._onStream({connection:p,stream:x,protocol:P})}).catch(async E=>{p.log.error("error handling incoming stream id %s - %e",x.id,E),x.timeline.close==null&&await x.close({signal:S}).catch(A=>x.abort(A))})}}),f=async(x,S={})=>{if(h==null)throw new Dh("Connection is not multiplexed");p.log.trace("starting new stream for protocols %s",x);const E=await h.newStream();p.log.trace("started new stream %s for protocols %s",E.id,x);try{if(S.signal==null){E.log("no abort signal was passed while trying to negotiate protocols %s falling back to default timeout",x);const I=AbortSignal.timeout(this.outboundStreamProtocolNegotiationTimeout);S={...S,signal:I}}E.log.trace("selecting protocol from protocols %s",x);const{stream:A,protocol:P}=await U2(E,x,{...S,log:E.log,yieldBytes:!0});E.log.trace("selected protocol %s",P);const k=o$(P,this.components.registrar,S),F=G7(P,"outbound",p);if(F>=k){const I=new Gv(`Too many outbound protocol streams for protocol "${P}" - ${F}/${k}`);throw E.abort(I),I}return await this.components.peerStore.merge(a,{protocols:[P]}),E.source=A.source,E.sink=A.sink,E.protocol=P,A.closeWrite!=null&&(E.closeWrite=A.closeWrite),A.closeRead!=null&&(E.closeRead=A.closeRead),A.close!=null&&(E.close=A.close),this.components.metrics?.trackProtocolStream(E,p),E}catch(A){throw p.log.error("could not create new outbound stream on connection %s %a for protocols %s - %e",r==="inbound"?"from":"to",e.maConn.remoteAddr,x,A),E.timeline.close==null&&E.abort(A),A}},Promise.all([h.sink(i.source),i.sink(h.source)]).catch(x=>{p.log.error("error piping data through muxer - %e",x)}));const m=s.timeline;s.timeline=new Proxy(m,{set:(...x)=>(x[1]==="close"&&x[2]!=null&&m.close==null&&(async()=>{try{p.status==="open"&&await p.close()}catch(S){p.log.error("error closing connection after timeline close %e",S)}finally{this.events.safeDispatchEvent("connection:close",{detail:p})}})().catch(S=>{p.log.error("error thrown while dispatching connection:close event %e",S)}),Reflect.set(...x))}),s.timeline.upgraded=Date.now();const w=()=>{throw new Dh("Connection is not multiplexed")};return p=s$({remoteAddr:s.remoteAddr,remotePeer:a,status:"open",direction:r,timeline:s.timeline,multiplexer:h?.protocol,encryption:t,limits:u,logger:this.components.logger,newStream:f??w,getStreams:()=>h?.streams??[],close:async x=>{await h?.close(x),await s.close(x)},abort:x=>{s.abort(x),h?.abort(x)}}),this.events.safeDispatchEvent("connection:open",{detail:p}),p.__maConnTimeline=m,p}_onStream(e){const{connection:t,stream:r,protocol:s}=e,{handler:i,options:a}=this.components.registrar.getHandler(s);if(t.limits!=null&&a.runOnLimitedConnection!==!0)throw new Wv("Cannot open protocol stream on limited connection");i({connection:t,stream:r})}async _encryptInbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{const{stream:s,protocol:i}=await V2(e,r,{...t,log:e.log}),a=this.connectionEncrypters.get(i);if(a==null)throw new Ih(`no crypto module found for ${i}`);return e.log("encrypting inbound connection to %a using %s",e.remoteAddr,i),{...await a.secureInbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting inbound connection from %a failed",e.remoteAddr,s),new Ih(s.message)}}async _encryptOutbound(e,t){const r=Array.from(this.connectionEncrypters.keys());try{e.log.trace("selecting encrypter from %s",r);const{stream:s,protocol:i}=await U2(e,r,{...t,log:e.log,yieldBytes:!0}),a=this.connectionEncrypters.get(i);if(a==null)throw new Ih(`no crypto module found for ${i}`);return e.log("encrypting outbound connection to %a using %s",e.remoteAddr,i),{...await a.secureOutbound(s,t),protocol:i}}catch(s){throw e.log.error("encrypting outbound connection to %a failed",e.remoteAddr,s),new Ih(s.message)}}async _multiplexOutbound(e,t,r){const s=Array.from(t.keys());e.log("outbound selecting muxer %s",s);try{e.log.trace("selecting stream muxer from %s",s);const{stream:i,protocol:a}=await U2(e,s,{...r,log:e.log,yieldBytes:!0});e.log("selected %s as muxer protocol",a);const c=t.get(a);return{stream:i,muxerFactory:c}}catch(i){throw e.log.error("error multiplexing outbound connection",i),new Dh(String(i))}}async _multiplexInbound(e,t,r){const s=Array.from(t.keys());e.log("inbound handling muxers %s",s);try{const{stream:i,protocol:a}=await V2(e,s,{...r,log:e.log}),c=t.get(a);return{stream:i,muxerFactory:c}}catch(i){throw e.log.error("error multiplexing inbound connection",i),new Dh(String(i))}}getConnectionEncrypters(){return this.connectionEncrypters}getStreamMuxers(){return this.streamMuxers}}const mS="2.9.0",yS="js-libp2p";function l$(n,e){return`${n??yS}/${e??mS} browser/${globalThis.navigator.userAgent}`}class c$ extends ln{peerId;peerStore;contentRouting;peerRouting;metrics;services;logger;status;components;log;constructor(e){super(),this.status="stopped";const t=new ln,r=t.dispatchEvent.bind(t);t.dispatchEvent=h=>{const f=r(h),p=this.dispatchEvent(new CustomEvent(h.type,{detail:h.detail}));return f||p},this.peerId=e.peerId,this.logger=e.logger??Cx(),this.log=this.logger.forComponent("libp2p"),this.services={};const s=e.nodeInfo?.name??yS,i=e.nodeInfo?.version??mS,a=this.components=PV({peerId:e.peerId,privateKey:e.privateKey,nodeInfo:{name:s,version:i,userAgent:e.nodeInfo?.userAgent??l$(s,i)},logger:this.logger,events:t,datastore:e.datastore??new TU,connectionGater:RV(e.connectionGater),dns:e.dns});e.metrics!=null&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),this.peerStore=this.configureComponent("peerStore",SU(a,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),a.events.addEventListener("peer:update",h=>{if(h.detail.previous==null){const f={id:h.detail.peer.id,multiaddrs:h.detail.peer.addresses.map(p=>p.multiaddr)};a.events.safeDispatchEvent("peer:discovery",{detail:f})}}),e.connectionProtector!=null&&this.configureComponent("connectionProtector",e.connectionProtector(a)),this.components.upgrader=new a$(this.components,{connectionEncrypters:(e.connectionEncrypters??[]).map((h,f)=>this.configureComponent(`connection-encryption-${f}`,h(this.components))),streamMuxers:(e.streamMuxers??[]).map((h,f)=>this.configureComponent(`stream-muxers-${f}`,h(this.components))),inboundUpgradeTimeout:e.connectionManager?.inboundUpgradeTimeout,inboundStreamProtocolNegotiationTimeout:e.connectionManager?.inboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout,outboundStreamProtocolNegotiationTimeout:e.connectionManager?.outboundStreamProtocolNegotiationTimeout??e.connectionManager?.protocolNegotiationTimeout}),this.configureComponent("transportManager",new Kj(this.components,e.transportManager)),this.configureComponent("connectionManager",new Ej(this.components,e.connectionManager)),e.connectionMonitor?.enabled!==!1&&this.configureComponent("connectionMonitor",new Oj(this.components,e.connectionMonitor)),this.configureComponent("registrar",new Hj(this.components)),this.configureComponent("addressManager",new dV(this.components,e.addresses));const c=(e.peerRouters??[]).map((h,f)=>this.configureComponent(`peer-router-${f}`,h(this.components)));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new $j(this.components,{routers:c}));const u=(e.contentRouters??[]).map((h,f)=>this.configureComponent(`content-router-${f}`,h(this.components)));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new jj(this.components,{routers:u})),this.configureComponent("randomWalk",new zj(this.components)),(e.peerDiscovery??[]).forEach((h,f)=>{this.configureComponent(`peer-discovery-${f}`,h(this.components)).addEventListener("peer",m=>{this.#e(m)})}),e.transports?.forEach((h,f)=>{this.components.transportManager.add(this.configureComponent(`transport-${f}`,h(this.components)))}),e.services!=null)for(const h of Object.keys(e.services)){const f=e.services[h],p=f(this.components);if(p==null){this.log.error("service factory %s returned null or undefined instance",h);continue}this.services[h]=p,this.configureComponent(h,p),p[vg]!=null&&(this.log("registering service %s for content routing",h),u.push(p[vg])),p[bg]!=null&&(this.log("registering service %s for peer routing",h),c.push(p[bg])),p[af]!=null&&(this.log("registering service %s for peer discovery",h),p[af].addEventListener?.("peer",m=>{this.#e(m)}))}TV(a)}configureComponent(e,t){return t==null&&this.log.error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if(this.status==="stopped"){this.status="starting",this.log("libp2p is starting");try{await this.components.beforeStart?.(),await this.components.start(),await this.components.afterStart?.(),this.status="started",this.safeDispatchEvent("start",{detail:this}),this.log("libp2p has started")}catch(e){throw this.log.error("An error occurred starting libp2p",e),this.status="started",await this.stop(),e}}}async stop(){this.status==="started"&&(this.log("libp2p is stopping"),this.status="stopping",await this.components.beforeStop?.(),await this.components.stop(),await this.components.afterStop?.(),this.status="stopped",this.safeDispatchEvent("stop",{detail:this}),this.log("libp2p has stopped"))}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new bs;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e,t={}){return this.components.connectionManager.openConnection(e,{priority:75,...t})}async dialProtocol(e,t,r={}){if(t==null)throw new Ae("no protocols were provided to open a stream");if(t=Array.isArray(t)?t:[t],t.length===0)throw new Ae("no protocols were provided to open a stream");return(await this.dial(e,r)).newStream(t,r)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e,t={}){S1(e)&&(e=sr(e.getPeerId()??"")),await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e,t={}){if(this.log("getPublicKey %p",e),e.publicKey!=null)return e.publicKey;try{const a=await this.peerStore.get(e,t);if(a.id.publicKey!=null)return a.id.publicKey}catch(a){if(a.name!=="NotFoundError")throw a}const r=Cs([we("/pk/"),e.toMultihash().bytes]),s=await this.contentRouting.get(r,t),i=Do(s);return await this.peerStore.patch(e,{publicKey:i},t),i}async handle(e,t,r){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async s=>{await this.components.registrar.handle(s,t,r)}))}async unhandle(e,t){Array.isArray(e)||(e=[e]),await Promise.all(e.map(async r=>{await this.components.registrar.unhandle(r,t)}))}async register(e,t,r){return this.components.registrar.register(e,t,r)}unregister(e){this.components.registrar.unregister(e)}async isDialable(e,t={}){return this.components.connectionManager.isDialable(e,t)}#e(e){const{detail:t}=e;if(t.id.toString()===this.peerId.toString()){this.log.error("peer discovery mechanism discovered self");return}this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs}).catch(r=>{this.log.error(r)})}}async function u$(n={}){n.privateKey??=await kO();const e=new c$({...await sF(n),peerId:DO(n.privateKey)});return n.start!==!1&&await e.start(),e}var En;(function(n){(function(r){r.FIN="FIN",r.STOP_SENDING="STOP_SENDING",r.RESET="RESET",r.FIN_ACK="FIN_ACK"})(n.Flag||(n.Flag={}));let e;(function(r){r[r.FIN=0]="FIN",r[r.STOP_SENDING=1]="STOP_SENDING",r[r.RESET=2]="RESET",r[r.FIN_ACK=3]="FIN_ACK"})(e||(e={})),function(r){r.codec=()=>Ds(e)}(n.Flag||(n.Flag={}));let t;n.codec=()=>(t==null&&(t=Qe((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.flag!=null&&(s.uint32(8),n.Flag.codec().encode(r.flag,s)),r.message!=null&&(s.uint32(18),s.bytes(r.message)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const a={},c=s==null?r.len:r.pos+s;for(;r.pos<c;){const u=r.uint32();switch(u>>>3){case 1:{a.flag=n.Flag.codec().decode(r);break}case 2:{a.message=r.bytes();break}default:{r.skipType(u&7);break}}}return a})),t),n.encode=r=>Ge(r,n.codec()),n.decode=(r,s)=>We(r,n.codec(),s)})(En||(En={}));const d$=["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478","stun:stun.cloudflare.com:3478","stun:stun.services.mozilla.com:3478"];Array.from("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890");const h$=2*1024*1024,f$=30*1e3,wS=16*1024;function p$(n=wS){const e=Ft(n-Ft(n)),t=1+Ft(Object.keys(En.Flag).length-1),r=1,s=n-e-t-r,i=Ft(s);return e+t+r+i}const g$=p$(),m$=5e3,y$=5e3,w$=3e4,vS="/webrtc",zg="/webrtc-signaling/0.0.1";var Q7=function(n,e,t){if(t||arguments.length===2)for(var r=0,s=e.length,i;r<s;r++)(i||!(r in e))&&(i||(i=Array.prototype.slice.call(e,0,r)),i[r]=e[r]);return n.concat(i||Array.prototype.slice.call(e))},v$=function(){function n(e,t,r){this.name=e,this.version=t,this.os=r,this.type="browser"}return n}(),b$=function(){function n(e){this.version=e,this.type="node",this.name="node",this.os=process.platform}return n}(),x$=function(){function n(e,t,r,s){this.name=e,this.version=t,this.os=r,this.bot=s,this.type="bot-device"}return n}(),S$=function(){function n(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null}return n}(),E$=function(){function n(){this.type="react-native",this.name="react-native",this.version=null,this.os=null}return n}(),C$=/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/,k$=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,Y7=3,A$=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",C$]],X7=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function P$(n){return typeof document>"u"&&typeof navigator<"u"&&navigator.product==="ReactNative"?new E$:typeof navigator<"u"?_$(navigator.userAgent):I$()}function T$(n){return n!==""&&A$.reduce(function(e,t){var r=t[0],s=t[1];if(e)return e;var i=s.exec(n);return!!i&&[r,i]},!1)}function _$(n){var e=T$(n);if(!e)return null;var t=e[0],r=e[1];if(t==="searchbot")return new S$;var s=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);s?s.length<Y7&&(s=Q7(Q7([],s,!0),N$(Y7-s.length),!0)):s=[];var i=s.join("."),a=D$(n),c=k$.exec(n);return c&&c[1]?new x$(t,i,a,c[1]):new v$(t,i,a)}function D$(n){for(var e=0,t=X7.length;e<t;e++){var r=X7[e],s=r[0],i=r[1],a=i.exec(n);if(a)return s}return null}function I$(){var n=typeof process<"u"&&process.version;return n?new b$(process.version.slice(1)):null}function N$(n){for(var e=[],t=0;t<n;t++)e.push("0");return e}const J7=P$(),bS=J7!=null&&J7.name==="firefox",xS=async function*(){},SS=async n=>{};function M$(n,e,t=w$,r){n.readyState==="open"&&Promise.resolve().then(async()=>{if(n.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",e,n.bufferedAmount);const s=Ke();let i=!1;n.bufferedAmountLowThreshold=0;const a=()=>{i||(r.log("%s drain channel closed before drain",e),s.resolve())};n.addEventListener("close",a,{once:!0}),n.addEventListener("bufferedamountlow",()=>{i=!0,n.removeEventListener("close",a),s.resolve()}),await x1(s.promise,{milliseconds:t})}}).then(async()=>{n.readyState==="open"&&n.close()}).catch(s=>{r.log.error("error closing outbound stream",s)})}async function Z7(n){return n=n??{},typeof n=="function"&&(n=await n()),n.iceServers=n.iceServers??d$.map(e=>({urls:[e]})),n}class e9{log;peerConnection;remoteAddr;timeline;metrics;source=xS();sink=SS;constructor(e,t){this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const r=this.peerConnection,s=r.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",r.connectionState,"initial state",s),(r.connectionState==="disconnected"||r.connectionState==="failed"||r.connectionState==="closed")&&(this.timeline.close=Date.now())}}async close(e){this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({close:!0})}abort(e){this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),this.metrics?.increment({abort:!0})}}function ES(n){if(n!=null){if(typeof n[Symbol.iterator]=="function")return n[Symbol.iterator]();if(typeof n[Symbol.asyncIterator]=="function")return n[Symbol.asyncIterator]();if(typeof n.next=="function")return n}throw new Error("argument is not an iterator or iterable")}function R$(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}function L$(n,e){const t=ES(n).return?.();R$(t)&&t.catch(r=>{e.error("could not cause iterator to return",r)})}const O$=5e3;function j2(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}class CS{id;direction;timeline;protocol;metadata;source;status;readStatus;writeStatus;log;sinkController;sinkEnd;closed;endErr;streamSource;onEnd;onCloseRead;onCloseWrite;onReset;onAbort;sendCloseWriteTimeout;sendingData;constructor(e){this.sinkController=new AbortController,this.sinkEnd=Ke(),this.closed=Ke(),this.log=e.log,this.status="open",this.readStatus="ready",this.writeStatus="ready",this.id=e.id,this.metadata=e.metadata??{},this.direction=e.direction,this.timeline={open:Date.now()},this.sendCloseWriteTimeout=e.sendCloseWriteTimeout??O$,this.onEnd=e.onEnd,this.onCloseRead=e.onCloseRead,this.onCloseWrite=e.onCloseWrite,this.onReset=e.onReset,this.onAbort=e.onAbort,this.source=this.streamSource=_i({onEnd:t=>{t!=null?this.log.trace("source ended with error",t):this.log.trace("source ended"),this.onSourceEnd(t)}}),this.sink=this.sink.bind(this)}async sink(e){if(this.writeStatus!=="ready")throw new xg(`writable end state is "${this.writeStatus}" not "ready"`);try{this.writeStatus="writing";const t={signal:this.sinkController.signal};if(this.direction==="outbound"){const s=this.sendNewStream(t);j2(s)&&await s}const r=()=>{L$(e,this.log)};try{this.sinkController.signal.addEventListener("abort",r),this.log.trace("sink reading from source");for await(let s of e){s=s instanceof Uint8Array?new Ie(s):s;const i=this.sendData(s,t);j2(i)&&(this.sendingData=Ke(),await i,this.sendingData.resolve(),this.sendingData=void 0)}}finally{this.sinkController.signal.removeEventListener("abort",r)}this.log.trace('sink finished reading from source, write status is "%s"',this.writeStatus),this.writeStatus==="writing"&&(this.writeStatus="closing",this.log.trace("send close write to remote"),await this.sendCloseWrite({signal:AbortSignal.timeout(this.sendCloseWriteTimeout)}),this.writeStatus="closed"),this.onSinkEnd()}catch(t){throw this.log.trace("sink ended with error, calling abort with error",t),this.abort(t),t}finally{this.log.trace("resolve sink end"),this.sinkEnd.resolve()}}onSourceEnd(e){this.timeline.closeRead==null&&(this.timeline.closeRead=Date.now(),this.readStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseRead?.(),this.timeline.closeWrite!=null?(this.log.trace("source and sink ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("source ended, waiting for sink to end"))}onSinkEnd(e){this.timeline.closeWrite==null&&(this.timeline.closeWrite=Date.now(),this.writeStatus="closed",e!=null&&this.endErr==null&&(this.endErr=e),this.onCloseWrite?.(),this.timeline.closeRead!=null?(this.log.trace("sink and source ended"),this.timeline.close=Date.now(),this.status!=="aborted"&&this.status!=="reset"&&(this.status="closed"),this.onEnd!=null&&this.onEnd(this.endErr),this.closed.resolve()):this.log.trace("sink ended, waiting for source to end"))}async close(e){this.status==="open"&&(this.log.trace("closing gracefully"),this.status="closing",await Dt(Promise.all([this.closeWrite(e),this.closeRead(e),this.closed.promise]),e?.signal),this.status="closed",this.log.trace("closed gracefully"))}async closeRead(e={}){if(this.readStatus==="closing"||this.readStatus==="closed")return;this.log.trace('closing readable end of stream with starting read status "%s"',this.readStatus);const t=this.readStatus;this.readStatus="closing",this.status!=="reset"&&this.status!=="aborted"&&this.timeline.closeRead==null&&(this.log.trace("send close read to remote"),await this.sendCloseRead(e)),t==="ready"&&(this.log.trace("ending internal source queue with %d queued bytes",this.streamSource.readableLength),this.streamSource.end()),this.log.trace("closed readable end of stream")}async closeWrite(e={}){this.writeStatus==="closing"||this.writeStatus==="closed"||(this.log.trace('closing writable end of stream with starting write status "%s"',this.writeStatus),this.writeStatus==="ready"&&(this.log.trace("sink was never sunk, sink an empty array"),await Dt(this.sink([]),e.signal)),this.writeStatus==="writing"&&(this.sendingData!=null&&await Dt(this.sendingData.promise,e.signal),this.log.trace("aborting source passed to .sink"),this.sinkController.abort(),await Dt(this.sinkEnd.promise,e.signal)),this.writeStatus="closed",this.log.trace("closed writable end of stream"))}abort(e){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;this.log("abort with error",e),this.log("try to send reset to remote");const t=this.sendReset();j2(t)&&t.catch(r=>{this.log.error("error sending reset message",r)}),this.status="aborted",this.timeline.abort=Date.now(),this._closeSinkAndSource(e),this.onAbort?.(e)}reset(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset")return;const e=new DN("stream reset");this.status="reset",this.timeline.reset=Date.now(),this._closeSinkAndSource(e),this.onReset?.()}_closeSinkAndSource(e){this._closeSink(e),this._closeSource(e)}_closeSink(e){this.writeStatus==="writing"&&(this.log.trace("end sink source"),this.sinkController.abort()),this.onSinkEnd(e)}_closeSource(e){this.readStatus!=="closing"&&this.readStatus!=="closed"&&(this.log.trace("ending source with %d bytes to be read by consumer",this.streamSource.readableLength),this.readStatus="closing",this.streamSource.end(e))}remoteCloseWrite(){if(this.readStatus==="closing"||this.readStatus==="closed"){this.log("received remote close write but local source is already closed");return}this.log.trace("remote close write"),this._closeSource()}remoteCloseRead(){if(this.writeStatus==="closing"||this.writeStatus==="closed"){this.log("received remote close read but local sink is already closed");return}this.log.trace("remote close read"),this._closeSink()}destroy(){if(this.status==="closed"||this.status==="aborted"||this.status==="reset"){this.log("received destroy but we are already closed");return}this.log.trace("stream destroyed"),this._closeSinkAndSource()}sourcePush(e){this.streamSource.push(e)}sourceReadableLength(){return this.streamSource.readableLength}}class B$ extends CS{channel;incomingData;maxBufferedAmount;bufferedAmountLowEventTimeout;maxMessageSize;receiveFinAck;finAckTimeout;openTimeout;closeController;constructor(e){const t=e.onEnd;switch(e.onEnd=s=>{this.log.trace('readable and writeable ends closed with status "%s"',this.status),Promise.resolve(async()=>{if(!(this.timeline.abort!=null||this.timeline.reset!==null))try{await x1(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(i){this.log.error("error receiving FIN_ACK",i)}}).then(()=>{this.incomingData.end(),t?.(s)}).catch(i=>{this.log.error("error ending stream",i)}).finally(()=>{this.channel.close()})},super(e),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=_i(),this.bufferedAmountLowEventTimeout=e.bufferedAmountLowEventTimeout??f$,this.maxBufferedAmount=e.maxBufferedAmount??h$,this.maxMessageSize=(e.maxMessageSize??wS)-g$,this.receiveFinAck=Ke(),this.finAckTimeout=e.closeTimeout??m$,this.openTimeout=e.openTimeout??y$,this.closeController=new AbortController,this.channel.readyState){case"open":this.timeline.open=new Date().getTime();break;case"closed":case"closing":(this.timeline.close===void 0||this.timeline.close===0)&&(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new xg("Unknown datachannel state")}this.channel.onopen=s=>{this.timeline.open=new Date().getTime()},this.channel.onclose=s=>{this.log.trace("received onclose event"),this.closeController.abort(),this.receiveFinAck.resolve(),this.close().catch(i=>{this.log.error("error closing stream after channel closed",i)})},this.channel.onerror=s=>{this.log.trace("received onerror event"),this.closeController.abort();const i=s.error;this.abort(i)},this.channel.onmessage=async s=>{const{data:i}=s;i===null||i.byteLength===0||this.incomingData.push(new Uint8Array(i,0,i.byteLength))};const r=this;Promise.resolve().then(async()=>{for await(const s of $g(this.incomingData)){const i=r.processIncomingProtobuf(s);i!=null&&r.sourcePush(new Ie(i))}}).catch(s=>{this.log.error("error processing incoming data channel messages",s)})}sendNewStream(){}async _sendMessage(e,t=!0){if(this.channel.readyState==="closed"||this.channel.readyState==="closing")throw new xg(`Invalid datachannel state - ${this.channel.readyState}`);if(this.channel.readyState!=="open"){const r=AbortSignal.timeout(this.openTimeout),s=An([this.closeController.signal,r]);try{this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await Ss(this.channel,"open",s)}finally{s.clear()}this.log('channel state is now "%s", sending data',this.channel.readyState)}if(t&&this.channel.bufferedAmount>this.maxBufferedAmount){const r=AbortSignal.timeout(this.bufferedAmountLowEventTimeout),s=An([this.closeController.signal,r]);try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await Ss(this.channel,"bufferedamountlow",s)}catch(i){throw r.aborted?new h1(`Timed out waiting for DataChannel buffer to clear after ${this.bufferedAmountLowEventTimeout}ms`):i}finally{s.clear()}}try{this.log.trace('sending message, channel state "%s"',this.channel.readyState),this.channel.send(e.subarray())}catch(r){this.log.error("error while sending message",r)}}async sendData(e){const t=e.byteLength;for(e=e.sublist();e.byteLength>0;){const r=Math.min(e.byteLength,this.maxMessageSize),s=e.subarray(0,r),i=En.encode({message:s}),a=Mf.single(i);this.log.trace("sending %d/%d bytes on channel",s.byteLength,t),await this._sendMessage(a),e.consume(r)}this.log.trace('finished sending data, channel state "%s"',this.channel.readyState)}async sendReset(){try{await this._sendFlag(En.Flag.RESET)}catch(e){this.log.error("failed to send reset - %e",e)}finally{this.channel.close()}}async sendCloseWrite(e){if(this.channel.readyState!=="open"){this.receiveFinAck.resolve();return}if(await this._sendFlag(En.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Dt(this.receiveFinAck.promise,e?.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorName:"FinAckNotReceivedError"})}catch(r){this.log.error("failed to await FIN_ACK",r)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){this.channel.readyState==="open"&&await this._sendFlag(En.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=En.decode(e);if(t.flag!==void 0&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===En.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(En.Flag.FIN_ACK).catch(r=>{this.log.error("error sending FIN_ACK immediately",r)})),t.flag===En.Flag.RESET&&this.reset(),t.flag===En.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===En.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),this.readStatus==="ready")return t.message}async _sendFlag(e){if(this.channel.readyState!=="open")return this.log.trace('not sending flag %s because channel is "%s" and not "open"',e.toString(),this.channel.readyState),!1;this.log.trace("sending flag %s",e.toString());const t=En.encode({flag:e}),r=Mf.single(t);try{return await this._sendMessage(r,!1),!0}catch(s){this.log.error("could not send flag %s - %e",e.toString(),s)}return!1}}function Hg(n){const{channel:e,direction:t,handshake:r}=n;return new B$({id:`${e.id}`,log:n.logger.forComponent(`libp2p:webrtc:stream:${r===!0?"handshake":t}:${e.id}`),...n})}class kS{protocol;peerConnection;bufferedStreams=[];metrics;dataChannelOptions;components;log;constructor(e,t){this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=t.protocol??vS,this.dataChannelOptions=t.dataChannelOptions??{},this.log=e.logger.forComponent("libp2p:webrtc:muxerfactory"),this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',r.id),r.label==="init"){this.log.trace("closing early init channel"),r.close();return}const s={},i=Hg({channel:r,direction:"inbound",onEnd:a=>{s.onEnd(a)},logger:e.logger,...this.dataChannelOptions});s.stream=i,s.channel=r,s.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter(a=>a.stream.id!==i.id)},this.bufferedStreams.push(s)}}createStreamMuxer(e){return new F$(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}class F${init;streams;protocol;log;peerConnection;dataChannelOptions;metrics;logger;constructor(e,t){this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map(r=>r.stream),this.peerConnection=t.peerConnection,this.protocol=t.protocol??vS,this.metrics=t.metrics,this.dataChannelOptions=t.dataChannelOptions??{},this.peerConnection.ondatachannel=({channel:r})=>{if(this.log.trace("incoming datachannel with channel id %d",r.id),r.label==="init"){this.log.trace("closing init channel"),r.close();return}const s=r.id,i=Hg({channel:r,direction:"inbound",onEnd:()=>{this.#e(i,r),this.log("incoming channel %s ended",s)},logger:this.logger,...this.dataChannelOptions});this.streams.push(i),this.metrics?.increment({incoming_stream:!0}),t?.onIncomingStream?.(i)},this.init.streams.length>0&&queueMicrotask(()=>{this.init.streams.forEach(r=>{r.onEnd=()=>{this.log("incoming early channel %s ended with state %s",r.channel.id,r.channel.readyState),this.#e(r.stream,r.channel)},this.metrics?.increment({incoming_stream:!0}),this.init?.onIncomingStream?.(r.stream)})})}#e(e,t){this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),M$(t,`${e.direction} ${e.id} ${e.protocol}`,this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter(r=>r.id!==e.id),this.metrics?.increment({stream_end:!0}),this.init?.onStreamEnd?.(e)}async close(e){try{await Promise.all(this.streams.map(async t=>t.close(e)))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}source=xS();sink=SS;newStream(){const e=this.peerConnection.createDataChannel(""),t=e.id;this.log.trace("opened outgoing datachannel with channel id %s",t);const r=Hg({channel:e,direction:"outbound",onEnd:()=>{this.#e(r,e),this.log("outgoing channel %s ended",t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(r),this.metrics?.increment({outgoing_stream:!0}),r}}const AS=globalThis.RTCPeerConnection,PS=globalThis.RTCSessionDescription,U$=globalThis.RTCIceCandidate;function Wr(n,e){const t=T1(n,e),r={read:async(s,i)=>{const a=await t.read(i);return s.decode(a)},write:async(s,i,a)=>{await t.write(i.encode(s),a)},writeV:async(s,i,a)=>{await t.writeV(s.map(c=>i.encode(c)),a)},pb:s=>({read:async i=>r.read(s,i),write:async(i,a)=>r.write(i,s,a),writeV:async(i,a)=>r.writeV(i,s,a),unwrap:()=>r}),unwrap:()=>t.unwrap()};return r}class V$ extends Error{constructor(e){super(`WebRTC transport error: ${e}`),this.name="WebRTCTransportError"}}class di extends V${constructor(e="SDP handshake failed"){super(e),this.name="SDPHandshakeFailedError"}}var wr;(function(n){(function(r){r.SDP_OFFER="SDP_OFFER",r.SDP_ANSWER="SDP_ANSWER",r.ICE_CANDIDATE="ICE_CANDIDATE"})(n.Type||(n.Type={}));let e;(function(r){r[r.SDP_OFFER=0]="SDP_OFFER",r[r.SDP_ANSWER=1]="SDP_ANSWER",r[r.ICE_CANDIDATE=2]="ICE_CANDIDATE"})(e||(e={})),function(r){r.codec=()=>Ds(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=Qe((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.data!=null&&(s.uint32(18),s.string(r.data)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const a={},c=s==null?r.len:r.pos+s;for(;r.pos<c;){const u=r.uint32();switch(u>>>3){case 1:{a.type=n.Type.codec().decode(r);break}case 2:{a.data=r.string();break}default:{r.skipType(u&7);break}}}return a})),t),n.encode=r=>Ge(r,n.codec()),n.decode=(r,s)=>We(r,n.codec(),s)})(wr||(wr={}));const TS=async(n,e,t)=>{try{const r=Ke();for(j$(n,r);;){const s=await Promise.race([r.promise,e.read({signal:t.signal}).catch(()=>{})]);if(s==null){t.signal?.throwIfAborted();break}if(s.type!==wr.Type.ICE_CANDIDATE)throw new Kt("ICE candidate message expected");const i=JSON.parse(s.data??"null");if(i===""||i===null){t.onProgress?.(new qe("webrtc:end-of-ice-candidates")),t.log.trace("end-of-candidates received");continue}const a=new U$(i);t.log.trace("%s received new ICE candidate %o",t.direction,i);try{t.onProgress?.(new qe("webrtc:add-ice-candidate",a.candidate)),await n.addIceCandidate(a)}catch(c){t.log.error("%s bad candidate received",t.direction,i,c)}}}catch(r){if(t.log.error("%s error parsing ICE candidate",t.direction,r),t.signal?.aborted===!0&&P3(n)!=="connected")throw r}};function P3(n){return bS?n.iceConnectionState:n.connectionState}function j$(n,e){n[bS?"oniceconnectionstatechange":"onconnectionstatechange"]=t=>{switch(P3(n)){case"connected":e.resolve();break;case"failed":case"disconnected":case"closed":e.reject(new Kv("RTCPeerConnection was closed"));break}}}async function $$({rtcConfiguration:n,dataChannel:e,signal:t,metrics:r,multiaddr:s,connectionManager:i,transportManager:a,log:c,logger:u,onProgress:h}){const{circuitAddress:f,targetPeer:p}=K$(s);r?.dialerEvents.increment({open:!0}),c.trace("dialing circuit address: %a",f);const m=i.getConnections(p);let w;m.length===0?(h?.(new qe("webrtc:dial-relay")),w=await a.dial(f,{signal:t,onProgress:h})):(h?.(new qe("webrtc:reuse-relay-connection")),w=m[0]),h?.(new qe("webrtc:open-signaling-stream"));const x=await w.newStream(zg,{signal:t,runOnLimitedConnection:!0}),S=Wr(x).pb(wr),E=new AS(n),A=new kS({logger:u},{peerConnection:E,dataChannelOptions:e});try{const P=E.createDataChannel("init");E.onicecandidate=({candidate:V})=>{const Q=JSON.stringify(V?.toJSON()??null);c.trace("initiator sending ICE candidate %o",V),S.write({type:wr.Type.ICE_CANDIDATE,data:Q},{signal:t}).catch(D=>{c.error("error sending ICE candidate",D)})},E.onicecandidateerror=V=>{c.error("initiator ICE candidate error",V)};const k=await E.createOffer().catch(V=>{throw c.error("could not execute createOffer",V),new di("Failed to set createOffer")});c.trace("initiator send SDP offer %s",k.sdp),h?.(new qe("webrtc:send-sdp-offer")),await S.write({type:wr.Type.SDP_OFFER,data:k.sdp},{signal:t}),await E.setLocalDescription(k).catch(V=>{throw c.error("could not execute setLocalDescription",V),new di("Failed to set localDescription")}),h?.(new qe("webrtc:read-sdp-answer")),c.trace("initiator read SDP answer");const F=await S.read({signal:t});if(F.type!==wr.Type.SDP_ANSWER)throw new di("Remote should send an SDP answer");c.trace("initiator received SDP answer %s",F.data);const I=new PS({type:"answer",sdp:F.data});return await E.setRemoteDescription(I).catch(V=>{throw c.error("could not execute setRemoteDescription",V),new di("Failed to set remoteDescription")}),c.trace("initiator read candidates until connected"),h?.(new qe("webrtc:read-ice-candidates")),await TS(E,S,{direction:"initiator",signal:t,log:c,onProgress:h}),c.trace("initiator connected, closing init channel"),P.close(),h?.(new qe("webrtc:close-signaling-stream")),c.trace("closing signaling channel"),await x.close({signal:t}),c.trace("initiator connected to remote address %s",s),{remoteAddress:s,peerConnection:E,muxerFactory:A}}catch(P){throw c.error("outgoing signaling error",P),E.close(),x.abort(P),P}finally{E.onicecandidate=null,E.onicecandidateerror=null}}const t9=Je(tS.matchers[0],et(No));class T3 extends ln{transportManager;shutdownController;events;constructor(e,t){super(),this.transportManager=e.transportManager,this.events=e.events,this.shutdownController=t.shutdownController,this.onTransportListening=this.onTransportListening.bind(this)}async listen(){this.events.addEventListener("transport:listening",this.onTransportListening)}onTransportListening(e){e.detail.getAddrs().filter(r=>t9.exactMatch(r)).map(r=>r.encapsulate("/webrtc")).length>0&&this.safeDispatchEvent("listening")}getAddrs(){return this.transportManager.getListeners().filter(e=>!(e instanceof T3)).map(e=>e.getAddrs().filter(t=>t9.exactMatch(t)).map(t=>t.encapsulate("/webrtc"))).flat()}updateAnnounceAddrs(){}async close(){this.events.removeEventListener("transport:listening",this.onTransportListening),this.shutdownController.abort(),queueMicrotask(()=>{this.safeDispatchEvent("close")})}}async function z$({peerConnection:n,stream:e,signal:t,connection:r,log:s}){s.trace("new inbound signaling stream");const i=Wr(e).pb(wr);try{n.onicecandidate=({candidate:f})=>{const p=JSON.stringify(f?.toJSON()??null);s.trace("recipient sending ICE candidate %s",p),i.write({type:wr.Type.ICE_CANDIDATE,data:p},{signal:t}).catch(m=>{s.error("error sending ICE candidate",m)})},s.trace("recipient read SDP offer");const c=await i.read({signal:t});if(c.type!==wr.Type.SDP_OFFER)throw new di(`expected message type SDP_OFFER, received: ${c.type??"undefined"} `);s.trace("recipient received SDP offer %s",c.data);const u=new PS({type:"offer",sdp:c.data});await n.setRemoteDescription(u).catch(f=>{throw s.error("could not execute setRemoteDescription",f),new di("Failed to set remoteDescription")});const h=await n.createAnswer().catch(f=>{throw s.error("could not execute createAnswer",f),new di("Failed to create answer")});s.trace("recipient send SDP answer %s",h.sdp),await i.write({type:wr.Type.SDP_ANSWER,data:h.sdp},{signal:t}),await n.setLocalDescription(h).catch(f=>{throw s.error("could not execute setLocalDescription",f),new di("Failed to set localDescription")}),s.trace("recipient read candidates until connected"),await TS(n,i,{direction:"recipient",signal:t,log:s})}catch(c){if(P3(n)!=="connected")throw s.error("error while handling signaling stream from peer %a",r.remoteAddr,c),n.close(),c;s("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",r.remoteAddr,c)}const a=Pe(`/webrtc/p2p/${r.remoteAddr.getPeerId()}`);return s.trace("recipient connected to remote address %s",a),{remoteAddress:a}}class H${components;init;log;_started=!1;metrics;shutdownController;constructor(e,t={}){this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,this.shutdownController.signal,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}[$m]=!0;[Symbol.toStringTag]="@libp2p/webrtc";[br]=["@libp2p/transport"];[Zc]=["@libp2p/identify","@libp2p/circuit-relay-v2-transport"];isStarted(){return this._started}async start(){await this.components.registrar.handle(zg,e=>{const t=this.components.upgrader.createInboundAbortSignal(this.shutdownController.signal);this._onProtocol(e,t).catch(r=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,r)}).finally(()=>{t.clear()})},{runOnLimitedConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(zg),this._started=!1}createListener(e){return new T3(this.components,{shutdownController:this.shutdownController})}listenFilter(e){return e.filter(Vg.exactMatch)}dialFilter(e){return this.listenFilter(e)}async dial(e,t){this.log.trace("dialing address: %a",e);const{remoteAddress:r,peerConnection:s,muxerFactory:i}=await $$({rtcConfiguration:await Z7(this.init.rtcConfiguration),dataChannel:this.init.dataChannel,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log,logger:this.components.logger,onProgress:t.onProgress}),a=new e9(this.components,{peerConnection:s,timeline:{open:Date.now()},remoteAddr:r,metrics:this.metrics?.dialerEvents}),c=await t.upgrader.upgradeOutbound(a,{skipProtection:!0,skipEncryption:!0,muxerFactory:i,onProgress:t.onProgress,signal:t.signal});return this._closeOnShutdown(s,a),c}async _onProtocol({connection:e,stream:t},r){const s=new AS(await Z7(this.init.rtcConfiguration)),i=new kS(this.components,{peerConnection:s,dataChannelOptions:this.init.dataChannel});try{const{remoteAddress:a}=await z$({peerConnection:s,connection:e,stream:t,signal:r,log:this.log});await t.close({signal:r});const c=new e9(this.components,{peerConnection:s,timeline:{open:new Date().getTime()},remoteAddr:a,metrics:this.metrics?.listenerEvents});await this.components.upgrader.upgradeInbound(c,{skipEncryption:!0,skipProtection:!0,muxerFactory:i,signal:r}),this._closeOnShutdown(s,c)}catch(a){throw this.log.error("incoming signaling error",a),s.close(),t.abort(a),a}}_closeOnShutdown(e,t){const r=()=>{t.close().catch(s=>{this.log.error("could not close WebRTCMultiaddrConnection",s)})};this.shutdownController.signal.addEventListener("abort",r),e.addEventListener("close",()=>{this.shutdownController.signal.removeEventListener("abort",r)})}}function K$(n){const e=n.getComponents().filter(({name:r})=>r==="p2p").map(({value:r})=>r).pop();if(e==null)throw new Ae("Destination peer id was missing");return{circuitAddress:Pe(n.getComponents().filter(({name:r})=>r!=="webrtc")),targetPeer:sr(e)}}/*!
 * MIT License
 * 
 * Copyright (c) 2017-2024 Peculiar Ventures, LLC
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 * 
 */const q$="[object ArrayBuffer]";class Xe{static isArrayBuffer(e){return Object.prototype.toString.call(e)===q$}static toArrayBuffer(e){return this.isArrayBuffer(e)?e:e.byteLength===e.buffer.byteLength||e.byteOffset===0&&e.byteLength===e.buffer.byteLength?e.buffer:this.toUint8Array(e.buffer).slice(e.byteOffset,e.byteOffset+e.byteLength).buffer}static toUint8Array(e){return this.toView(e,Uint8Array)}static toView(e,t){if(e.constructor===t)return e;if(this.isArrayBuffer(e))return new t(e);if(this.isArrayBufferView(e))return new t(e.buffer,e.byteOffset,e.byteLength);throw new TypeError("The provided value is not of type '(ArrayBuffer or ArrayBufferView)'")}static isBufferSource(e){return this.isArrayBufferView(e)||this.isArrayBuffer(e)}static isArrayBufferView(e){return ArrayBuffer.isView(e)||e&&this.isArrayBuffer(e.buffer)}static isEqual(e,t){const r=Xe.toUint8Array(e),s=Xe.toUint8Array(t);if(r.length!==s.byteLength)return!1;for(let i=0;i<r.length;i++)if(r[i]!==s[i])return!1;return!0}static concat(...e){let t;Array.isArray(e[0])&&!(e[1]instanceof Function)||Array.isArray(e[0])&&e[1]instanceof Function?t=e[0]:e[e.length-1]instanceof Function?t=e.slice(0,e.length-1):t=e;let r=0;for(const a of t)r+=a.byteLength;const s=new Uint8Array(r);let i=0;for(const a of t){const c=this.toUint8Array(a);s.set(c,i),i+=c.length}return e[e.length-1]instanceof Function?this.toView(s,e[e.length-1]):s.buffer}}const $2="string",W$=/^[0-9a-f\s]+$/i,G$=/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/,Q$=/^[a-zA-Z0-9-_]+$/;class n9{static fromString(e){const t=unescape(encodeURIComponent(e)),r=new Uint8Array(t.length);for(let s=0;s<t.length;s++)r[s]=t.charCodeAt(s);return r.buffer}static toString(e){const t=Xe.toUint8Array(e);let r="";for(let i=0;i<t.length;i++)r+=String.fromCharCode(t[i]);return decodeURIComponent(escape(r))}}class Nr{static toString(e,t=!1){const r=Xe.toArrayBuffer(e),s=new DataView(r);let i="";for(let a=0;a<r.byteLength;a+=2){const c=s.getUint16(a,t);i+=String.fromCharCode(c)}return i}static fromString(e,t=!1){const r=new ArrayBuffer(e.length*2),s=new DataView(r);for(let i=0;i<e.length;i++)s.setUint16(i*2,e.charCodeAt(i),t);return r}}class yt{static isHex(e){return typeof e===$2&&W$.test(e)}static isBase64(e){return typeof e===$2&&G$.test(e)}static isBase64Url(e){return typeof e===$2&&Q$.test(e)}static ToString(e,t="utf8"){const r=Xe.toUint8Array(e);switch(t.toLowerCase()){case"utf8":return this.ToUtf8String(r);case"binary":return this.ToBinary(r);case"hex":return this.ToHex(r);case"base64":return this.ToBase64(r);case"base64url":return this.ToBase64Url(r);case"utf16le":return Nr.toString(r,!0);case"utf16":case"utf16be":return Nr.toString(r);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromString(e,t="utf8"){if(!e)return new ArrayBuffer(0);switch(t.toLowerCase()){case"utf8":return this.FromUtf8String(e);case"binary":return this.FromBinary(e);case"hex":return this.FromHex(e);case"base64":return this.FromBase64(e);case"base64url":return this.FromBase64Url(e);case"utf16le":return Nr.fromString(e,!0);case"utf16":case"utf16be":return Nr.fromString(e);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToBase64(e){const t=Xe.toUint8Array(e);if(typeof btoa<"u"){const r=this.ToString(t,"binary");return btoa(r)}else return Buffer.from(t).toString("base64")}static FromBase64(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!yt.isBase64(t))throw new TypeError("Argument 'base64Text' is not Base64 encoded");return typeof atob<"u"?this.FromBinary(atob(t)):new Uint8Array(Buffer.from(t,"base64")).buffer}static FromBase64Url(e){const t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!yt.isBase64Url(t))throw new TypeError("Argument 'base64url' is not Base64Url encoded");return this.FromBase64(this.Base64Padding(t.replace(/\-/g,"+").replace(/\_/g,"/")))}static ToBase64Url(e){return this.ToBase64(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/\=/g,"")}static FromUtf8String(e,t=yt.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.FromBinary(e);case"utf8":return n9.fromString(e);case"utf16":case"utf16be":return Nr.fromString(e);case"utf16le":case"usc2":return Nr.fromString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static ToUtf8String(e,t=yt.DEFAULT_UTF8_ENCODING){switch(t){case"ascii":return this.ToBinary(e);case"utf8":return n9.toString(e);case"utf16":case"utf16be":return Nr.toString(e);case"utf16le":case"usc2":return Nr.toString(e,!0);default:throw new Error(`Unknown type of encoding '${t}'`)}}static FromBinary(e){const t=e.length,r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);return r.buffer}static ToBinary(e){const t=Xe.toUint8Array(e);let r="";for(let s=0;s<t.length;s++)r+=String.fromCharCode(t[s]);return r}static ToHex(e){const t=Xe.toUint8Array(e);let r="";const s=t.length;for(let i=0;i<s;i++){const a=t[i];a<16&&(r+="0"),r+=a.toString(16)}return r}static FromHex(e){let t=this.formatString(e);if(!t)return new ArrayBuffer(0);if(!yt.isHex(t))throw new TypeError("Argument 'hexString' is not HEX encoded");t.length%2&&(t=`0${t}`);const r=new Uint8Array(t.length/2);for(let s=0;s<t.length;s=s+2){const i=t.slice(s,s+2);r[s/2]=parseInt(i,16)}return r.buffer}static ToUtf16String(e,t=!1){return Nr.toString(e,t)}static FromUtf16String(e,t=!1){return Nr.fromString(e,t)}static Base64Padding(e){const t=4-e.length%4;if(t<4)for(let r=0;r<t;r++)e+="=";return e}static formatString(e){return e?.replace(/[\n\r\t ]/g,"")||""}}yt.DEFAULT_UTF8_ENCODING="utf8";/*!
 Copyright (c) Peculiar Ventures, LLC
*/function Za(n,e){let t=0;if(n.length===1)return n[0];for(let r=n.length-1;r>=0;r--)t+=n[n.length-1-r]*Math.pow(2,e*r);return t}function wo(n,e,t=-1){const r=t;let s=n,i=0,a=Math.pow(2,e);for(let c=1;c<8;c++){if(n<a){let u;if(r<0)u=new ArrayBuffer(c),i=c;else{if(r<c)return new ArrayBuffer(0);u=new ArrayBuffer(r),i=r}const h=new Uint8Array(u);for(let f=c-1;f>=0;f--){const p=Math.pow(2,f*e);h[i-f-1]=Math.floor(s/p),s-=h[i-f-1]*p}return u}a*=Math.pow(2,e)}return new ArrayBuffer(0)}function Kg(...n){let e=0,t=0;for(const i of n)e+=i.length;const r=new ArrayBuffer(e),s=new Uint8Array(r);for(const i of n)s.set(i,t),t+=i.length;return s}function _S(){const n=new Uint8Array(this.valueHex);if(this.valueHex.byteLength>=2){const c=n[0]===255&&n[1]&128,u=n[0]===0&&(n[1]&128)===0;(c||u)&&this.warnings.push("Needlessly long format")}const e=new ArrayBuffer(this.valueHex.byteLength),t=new Uint8Array(e);for(let c=0;c<this.valueHex.byteLength;c++)t[c]=0;t[0]=n[0]&128;const r=Za(t,8),s=new ArrayBuffer(this.valueHex.byteLength),i=new Uint8Array(s);for(let c=0;c<this.valueHex.byteLength;c++)i[c]=n[c];return i[0]&=127,Za(i,8)-r}function Y$(n){const e=n<0?n*-1:n;let t=128;for(let r=1;r<8;r++){if(e<=t){if(n<0){const a=t-e,c=wo(a,8,r),u=new Uint8Array(c);return u[0]|=128,c}let s=wo(e,8,r),i=new Uint8Array(s);if(i[0]&128){const a=s.slice(0),c=new Uint8Array(a);s=new ArrayBuffer(s.byteLength+1),i=new Uint8Array(s);for(let u=0;u<a.byteLength;u++)i[u+1]=c[u];i[0]=0}return s}t*=Math.pow(2,8)}return new ArrayBuffer(0)}function X$(n,e){if(n.byteLength!==e.byteLength)return!1;const t=new Uint8Array(n),r=new Uint8Array(e);for(let s=0;s<t.length;s++)if(t[s]!==r[s])return!1;return!0}function Ln(n,e){const t=n.toString(10);if(e<t.length)return"";const r=e-t.length,s=new Array(r);for(let a=0;a<r;a++)s[a]="0";return s.join("").concat(t)}/*!
 * Copyright (c) 2014, GMO GlobalSign
 * Copyright (c) 2015-2022, Peculiar Ventures
 * All rights reserved.
 * 
 * Author 2014-2019, Yury Strozhevsky
 * 
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * * Redistributions of source code must retain the above copyright notice, this
 *   list of conditions and the following disclaimer.
 * 
 * * Redistributions in binary form must reproduce the above copyright notice, this
 *   list of conditions and the following disclaimer in the documentation and/or
 *   other materials provided with the distribution.
 * 
 * * Neither the name of the copyright holder nor the names of its
 *   contributors may be used to endorse or promote products derived from
 *   this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
 * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 * 
 */function Rf(){if(typeof BigInt>"u")throw new Error("BigInt is not defined. Your environment doesn't implement BigInt.")}function _3(n){let e=0,t=0;for(let s=0;s<n.length;s++){const i=n[s];e+=i.byteLength}const r=new Uint8Array(e);for(let s=0;s<n.length;s++){const i=n[s];r.set(new Uint8Array(i),t),t+=i.byteLength}return r.buffer}function Is(n,e,t,r){return e instanceof Uint8Array?e.byteLength?t<0?(n.error="Wrong parameter: inputOffset less than zero",!1):r<0?(n.error="Wrong parameter: inputLength less than zero",!1):e.byteLength-t-r<0?(n.error="End of input reached before message was fully decoded (inconsistent offset and length values)",!1):!0:(n.error="Wrong parameter: inputBuffer has zero length",!1):(n.error="Wrong parameter: inputBuffer must be 'Uint8Array'",!1)}class D3{constructor(){this.items=[]}write(e){this.items.push(e)}final(){return _3(this.items)}}const kc=[new Uint8Array([1])],r9="0123456789",xl="",Cr=new ArrayBuffer(0),I3=new Uint8Array(0),pu="EndOfContent",DS="OCTET STRING",IS="BIT STRING";function Ns(n){var e;return e=class extends n{get valueHex(){return this.valueHexView.slice().buffer}set valueHex(r){this.valueHexView=new Uint8Array(r)}constructor(...r){var s;super(...r);const i=r[0]||{};this.isHexOnly=(s=i.isHexOnly)!==null&&s!==void 0?s:!1,this.valueHexView=i.valueHex?Xe.toUint8Array(i.valueHex):I3}fromBER(r,s,i){const a=r instanceof ArrayBuffer?new Uint8Array(r):r;if(!Is(this,a,s,i))return-1;const c=s+i;return this.valueHexView=a.subarray(s,c),this.valueHexView.length?(this.blockLength=i,c):(this.warnings.push("Zero buffer length"),s)}toBER(r=!1){return this.isHexOnly?r?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.byteLength===this.valueHexView.buffer.byteLength?this.valueHexView.buffer:this.valueHexView.slice().buffer:(this.error="Flag 'isHexOnly' is not set, abort",Cr)}toJSON(){return{...super.toJSON(),isHexOnly:this.isHexOnly,valueHex:yt.ToHex(this.valueHexView)}}},e.NAME="hexBlock",e}class Ro{static blockName(){return this.NAME}get valueBeforeDecode(){return this.valueBeforeDecodeView.slice().buffer}set valueBeforeDecode(e){this.valueBeforeDecodeView=new Uint8Array(e)}constructor({blockLength:e=0,error:t=xl,warnings:r=[],valueBeforeDecode:s=I3}={}){this.blockLength=e,this.error=t,this.warnings=r,this.valueBeforeDecodeView=Xe.toUint8Array(s)}toJSON(){return{blockName:this.constructor.NAME,blockLength:this.blockLength,error:this.error,warnings:this.warnings,valueBeforeDecode:yt.ToHex(this.valueBeforeDecodeView)}}}Ro.NAME="baseBlock";class Tn extends Ro{fromBER(e,t,r){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}toBER(e,t){throw TypeError("User need to make a specific function in a class which extends 'ValueBlock'")}}Tn.NAME="valueBlock";class NS extends Ns(Ro){constructor({idBlock:e={}}={}){var t,r,s,i;super(),e?(this.isHexOnly=(t=e.isHexOnly)!==null&&t!==void 0?t:!1,this.valueHexView=e.valueHex?Xe.toUint8Array(e.valueHex):I3,this.tagClass=(r=e.tagClass)!==null&&r!==void 0?r:-1,this.tagNumber=(s=e.tagNumber)!==null&&s!==void 0?s:-1,this.isConstructed=(i=e.isConstructed)!==null&&i!==void 0?i:!1):(this.tagClass=-1,this.tagNumber=-1,this.isConstructed=!1)}toBER(e=!1){let t=0;switch(this.tagClass){case 1:t|=0;break;case 2:t|=64;break;case 3:t|=128;break;case 4:t|=192;break;default:return this.error="Unknown tag class",Cr}if(this.isConstructed&&(t|=32),this.tagNumber<31&&!this.isHexOnly){const s=new Uint8Array(1);if(!e){let i=this.tagNumber;i&=31,t|=i,s[0]=t}return s.buffer}if(!this.isHexOnly){const s=wo(this.tagNumber,7),i=new Uint8Array(s),a=s.byteLength,c=new Uint8Array(a+1);if(c[0]=t|31,!e){for(let u=0;u<a-1;u++)c[u+1]=i[u]|128;c[a]=i[a-1]}return c.buffer}const r=new Uint8Array(this.valueHexView.byteLength+1);if(r[0]=t|31,!e){const s=this.valueHexView;for(let i=0;i<s.length-1;i++)r[i+1]=s[i]|128;r[this.valueHexView.byteLength]=s[s.length-1]}return r.buffer}fromBER(e,t,r){const s=Xe.toUint8Array(e);if(!Is(this,s,t,r))return-1;const i=s.subarray(t,t+r);if(i.length===0)return this.error="Zero buffer length",-1;switch(i[0]&192){case 0:this.tagClass=1;break;case 64:this.tagClass=2;break;case 128:this.tagClass=3;break;case 192:this.tagClass=4;break;default:return this.error="Unknown tag class",-1}this.isConstructed=(i[0]&32)===32,this.isHexOnly=!1;const c=i[0]&31;if(c!==31)this.tagNumber=c,this.blockLength=1;else{let u=1,h=this.valueHexView=new Uint8Array(255),f=255;for(;i[u]&128;){if(h[u-1]=i[u]&127,u++,u>=i.length)return this.error="End of input reached before message was fully decoded",-1;if(u===f){f+=255;const m=new Uint8Array(f);for(let w=0;w<h.length;w++)m[w]=h[w];h=this.valueHexView=new Uint8Array(f)}}this.blockLength=u+1,h[u-1]=i[u]&127;const p=new Uint8Array(u);for(let m=0;m<u;m++)p[m]=h[m];h=this.valueHexView=new Uint8Array(u),h.set(p),this.blockLength<=9?this.tagNumber=Za(h,7):(this.isHexOnly=!0,this.warnings.push("Tag too long, represented as hex-coded"))}if(this.tagClass===1&&this.isConstructed)switch(this.tagNumber){case 1:case 2:case 5:case 6:case 9:case 13:case 14:case 23:case 24:case 31:case 32:case 33:case 34:return this.error="Constructed encoding used for primitive type",-1}return t+this.blockLength}toJSON(){return{...super.toJSON(),tagClass:this.tagClass,tagNumber:this.tagNumber,isConstructed:this.isConstructed}}}NS.NAME="identificationBlock";class MS extends Ro{constructor({lenBlock:e={}}={}){var t,r,s;super(),this.isIndefiniteForm=(t=e.isIndefiniteForm)!==null&&t!==void 0?t:!1,this.longFormUsed=(r=e.longFormUsed)!==null&&r!==void 0?r:!1,this.length=(s=e.length)!==null&&s!==void 0?s:0}fromBER(e,t,r){const s=Xe.toUint8Array(e);if(!Is(this,s,t,r))return-1;const i=s.subarray(t,t+r);if(i.length===0)return this.error="Zero buffer length",-1;if(i[0]===255)return this.error="Length block 0xFF is reserved by standard",-1;if(this.isIndefiniteForm=i[0]===128,this.isIndefiniteForm)return this.blockLength=1,t+this.blockLength;if(this.longFormUsed=!!(i[0]&128),this.longFormUsed===!1)return this.length=i[0],this.blockLength=1,t+this.blockLength;const a=i[0]&127;if(a>8)return this.error="Too big integer",-1;if(a+1>i.length)return this.error="End of input reached before message was fully decoded",-1;const c=t+1,u=s.subarray(c,c+a);return u[a-1]===0&&this.warnings.push("Needlessly long encoded length"),this.length=Za(u,8),this.longFormUsed&&this.length<=127&&this.warnings.push("Unnecessary usage of long length form"),this.blockLength=a+1,t+this.blockLength}toBER(e=!1){let t,r;if(this.length>127&&(this.longFormUsed=!0),this.isIndefiniteForm)return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=128),t;if(this.longFormUsed){const s=wo(this.length,8);if(s.byteLength>127)return this.error="Too big length",Cr;if(t=new ArrayBuffer(s.byteLength+1),e)return t;const i=new Uint8Array(s);r=new Uint8Array(t),r[0]=s.byteLength|128;for(let a=0;a<s.byteLength;a++)r[a+1]=i[a];return t}return t=new ArrayBuffer(1),e===!1&&(r=new Uint8Array(t),r[0]=this.length),t}toJSON(){return{...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,longFormUsed:this.longFormUsed,length:this.length}}}MS.NAME="lengthBlock";const ue={};class gn extends Ro{constructor({name:e=xl,optional:t=!1,primitiveSchema:r,...s}={},i){super(s),this.name=e,this.optional=t,r&&(this.primitiveSchema=r),this.idBlock=new NS(s),this.lenBlock=new MS(s),this.valueBlock=i?new i(s):new Tn(s)}fromBER(e,t,r){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}toBER(e,t){const r=t||new D3;t||RS(this);const s=this.idBlock.toBER(e);if(r.write(s),this.lenBlock.isIndefiniteForm)r.write(new Uint8Array([128]).buffer),this.valueBlock.toBER(e,r),r.write(new ArrayBuffer(2));else{const i=this.valueBlock.toBER(e);this.lenBlock.length=i.byteLength;const a=this.lenBlock.toBER(e);r.write(a),r.write(i)}return t?Cr:r.final()}toJSON(){const e={...super.toJSON(),idBlock:this.idBlock.toJSON(),lenBlock:this.lenBlock.toJSON(),valueBlock:this.valueBlock.toJSON(),name:this.name,optional:this.optional};return this.primitiveSchema&&(e.primitiveSchema=this.primitiveSchema.toJSON()),e}toString(e="ascii"){return e==="ascii"?this.onAsciiEncoding():yt.ToHex(this.toBER())}onAsciiEncoding(){const e=this.constructor.NAME,t=yt.ToHex(this.valueBlock.valueBeforeDecodeView);return`${e} : ${t}`}isEqual(e){if(this===e)return!0;if(!(e instanceof this.constructor))return!1;const t=this.toBER(),r=e.toBER();return X$(t,r)}}gn.NAME="BaseBlock";function RS(n){var e;if(n instanceof ue.Constructed)for(const t of n.valueBlock.value)RS(t)&&(n.lenBlock.isIndefiniteForm=!0);return!!(!((e=n.lenBlock)===null||e===void 0)&&e.isIndefiniteForm)}class LS extends gn{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor({value:e=xl,...t}={},r){super(t,r),e&&this.fromString(e)}fromBER(e,t,r){const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.fromBuffer(this.valueBlock.valueHexView),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){return`${this.constructor.NAME} : '${this.valueBlock.value}'`}}LS.NAME="BaseStringBlock";class OS extends Ns(Tn){constructor({isHexOnly:e=!0,...t}={}){super(t),this.isHexOnly=e}}OS.NAME="PrimitiveValueBlock";var BS;class FS extends gn{constructor(e={}){super(e,OS),this.idBlock.isConstructed=!1}}BS=FS;ue.Primitive=BS;FS.NAME="PRIMITIVE";function J$(n,e){if(n instanceof e)return n;const t=new e;return t.idBlock=n.idBlock,t.lenBlock=n.lenBlock,t.warnings=n.warnings,t.valueBeforeDecodeView=n.valueBeforeDecodeView,t}function D1(n,e=0,t=n.length){const r=e;let s=new gn({},Tn);const i=new Ro;if(!Is(i,n,e,t))return s.error=i.error,{offset:-1,result:s};if(!n.subarray(e,e+t).length)return s.error="Zero buffer length",{offset:-1,result:s};let c=s.idBlock.fromBER(n,e,t);if(s.idBlock.warnings.length&&s.warnings.concat(s.idBlock.warnings),c===-1)return s.error=s.idBlock.error,{offset:-1,result:s};if(e=c,t-=s.idBlock.blockLength,c=s.lenBlock.fromBER(n,e,t),s.lenBlock.warnings.length&&s.warnings.concat(s.lenBlock.warnings),c===-1)return s.error=s.lenBlock.error,{offset:-1,result:s};if(e=c,t-=s.lenBlock.blockLength,!s.idBlock.isConstructed&&s.lenBlock.isIndefiniteForm)return s.error="Indefinite length form used for primitive encoding form",{offset:-1,result:s};let u=gn;switch(s.idBlock.tagClass){case 1:if(s.idBlock.tagNumber>=37&&s.idBlock.isHexOnly===!1)return s.error="UNIVERSAL 37 and upper tags are reserved by ASN.1 standard",{offset:-1,result:s};switch(s.idBlock.tagNumber){case 0:if(s.idBlock.isConstructed&&s.lenBlock.length>0)return s.error="Type [UNIVERSAL 0] is reserved",{offset:-1,result:s};u=ue.EndOfContent;break;case 1:u=ue.Boolean;break;case 2:u=ue.Integer;break;case 3:u=ue.BitString;break;case 4:u=ue.OctetString;break;case 5:u=ue.Null;break;case 6:u=ue.ObjectIdentifier;break;case 10:u=ue.Enumerated;break;case 12:u=ue.Utf8String;break;case 13:u=ue.RelativeObjectIdentifier;break;case 14:u=ue.TIME;break;case 15:return s.error="[UNIVERSAL 15] is reserved by ASN.1 standard",{offset:-1,result:s};case 16:u=ue.Sequence;break;case 17:u=ue.Set;break;case 18:u=ue.NumericString;break;case 19:u=ue.PrintableString;break;case 20:u=ue.TeletexString;break;case 21:u=ue.VideotexString;break;case 22:u=ue.IA5String;break;case 23:u=ue.UTCTime;break;case 24:u=ue.GeneralizedTime;break;case 25:u=ue.GraphicString;break;case 26:u=ue.VisibleString;break;case 27:u=ue.GeneralString;break;case 28:u=ue.UniversalString;break;case 29:u=ue.CharacterString;break;case 30:u=ue.BmpString;break;case 31:u=ue.DATE;break;case 32:u=ue.TimeOfDay;break;case 33:u=ue.DateTime;break;case 34:u=ue.Duration;break;default:{const h=s.idBlock.isConstructed?new ue.Constructed:new ue.Primitive;h.idBlock=s.idBlock,h.lenBlock=s.lenBlock,h.warnings=s.warnings,s=h}}break;case 2:case 3:case 4:default:u=s.idBlock.isConstructed?ue.Constructed:ue.Primitive}return s=J$(s,u),c=s.fromBER(n,e,s.lenBlock.isIndefiniteForm?t:s.lenBlock.length),s.valueBeforeDecodeView=n.subarray(r,r+s.blockLength),{offset:c,result:s}}function US(n){if(!n.byteLength){const e=new gn({},Tn);return e.error="Input buffer has zero length",{offset:-1,result:e}}return D1(Xe.toUint8Array(n).slice(),0,n.byteLength)}function Z$(n,e){return n?1:e}class yi extends Tn{constructor({value:e=[],isIndefiniteForm:t=!1,...r}={}){super(r),this.value=e,this.isIndefiniteForm=t}fromBER(e,t,r){const s=Xe.toUint8Array(e);if(!Is(this,s,t,r))return-1;if(this.valueBeforeDecodeView=s.subarray(t,t+r),this.valueBeforeDecodeView.length===0)return this.warnings.push("Zero buffer length"),t;let i=t;for(;Z$(this.isIndefiniteForm,r)>0;){const a=D1(s,i,r);if(a.offset===-1)return this.error=a.result.error,this.warnings.concat(a.result.warnings),-1;if(i=a.offset,this.blockLength+=a.result.blockLength,r-=a.result.blockLength,this.value.push(a.result),this.isIndefiniteForm&&a.result.constructor.NAME===pu)break}return this.isIndefiniteForm&&(this.value[this.value.length-1].constructor.NAME===pu?this.value.pop():this.warnings.push("No EndOfContent block encoded")),i}toBER(e,t){const r=t||new D3;for(let s=0;s<this.value.length;s++)this.value[s].toBER(e,r);return t?Cr:r.final()}toJSON(){const e={...super.toJSON(),isIndefiniteForm:this.isIndefiniteForm,value:[]};for(const t of this.value)e.value.push(t.toJSON());return e}}yi.NAME="ConstructedValueBlock";var VS;class Sl extends gn{constructor(e={}){super(e,yi),this.idBlock.isConstructed=!0}fromBER(e,t,r){this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm;const s=this.valueBlock.fromBER(e,t,this.lenBlock.isIndefiniteForm?r:this.lenBlock.length);return s===-1?(this.error=this.valueBlock.error,s):(this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.valueBlock.error.length||(this.blockLength+=this.valueBlock.blockLength),s)}onAsciiEncoding(){const e=[];for(const r of this.valueBlock.value)e.push(r.toString("ascii").split(`
`).map(s=>`  ${s}`).join(`
`));const t=this.idBlock.tagClass===3?`[${this.idBlock.tagNumber}]`:this.constructor.NAME;return e.length?`${t} :
${e.join(`
`)}`:`${t} :`}}VS=Sl;ue.Constructed=VS;Sl.NAME="CONSTRUCTED";class jS extends Tn{fromBER(e,t,r){return t}toBER(e){return Cr}}jS.override="EndOfContentValueBlock";var $S;class zS extends gn{constructor(e={}){super(e,jS),this.idBlock.tagClass=1,this.idBlock.tagNumber=0}}$S=zS;ue.EndOfContent=$S;zS.NAME=pu;var HS;class gu extends gn{constructor(e={}){super(e,Tn),this.idBlock.tagClass=1,this.idBlock.tagNumber=5}fromBER(e,t,r){return this.lenBlock.length>0&&this.warnings.push("Non-zero length of value block for Null type"),this.idBlock.error.length||(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length||(this.blockLength+=this.lenBlock.blockLength),this.blockLength+=r,t+r>e.byteLength?(this.error="End of input reached before message was fully decoded (inconsistent offset and length values)",-1):t+r}toBER(e,t){const r=new ArrayBuffer(2);if(!e){const s=new Uint8Array(r);s[0]=5,s[1]=0}return t&&t.write(r),r}onAsciiEncoding(){return`${this.constructor.NAME}`}}HS=gu;ue.Null=HS;gu.NAME="NULL";class KS extends Ns(Tn){get value(){for(const e of this.valueHexView)if(e>0)return!0;return!1}set value(e){this.valueHexView[0]=e?255:0}constructor({value:e,...t}={}){super(t),t.valueHex?this.valueHexView=Xe.toUint8Array(t.valueHex):this.valueHexView=new Uint8Array(1),e&&(this.value=e)}fromBER(e,t,r){const s=Xe.toUint8Array(e);return Is(this,s,t,r)?(this.valueHexView=s.subarray(t,t+r),r>1&&this.warnings.push("Boolean value encoded in more then 1 octet"),this.isHexOnly=!0,_S.call(this),this.blockLength=r,t+r):-1}toBER(){return this.valueHexView.slice()}toJSON(){return{...super.toJSON(),value:this.value}}}KS.NAME="BooleanValueBlock";var qS;let WS=class extends gn{getValue(){return this.valueBlock.value}setValue(e){this.valueBlock.value=e}constructor(e={}){super(e,KS),this.idBlock.tagClass=1,this.idBlock.tagNumber=1}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.getValue}`}};qS=WS;ue.Boolean=qS;WS.NAME="BOOLEAN";class GS extends Ns(yi){constructor({isConstructed:e=!1,...t}={}){super(t),this.isConstructed=e}fromBER(e,t,r){let s=0;if(this.isConstructed){if(this.isHexOnly=!1,s=yi.prototype.fromBER.call(this,e,t,r),s===-1)return s;for(let i=0;i<this.value.length;i++){const a=this.value[i].constructor.NAME;if(a===pu){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, OCTET STRING may consists of OCTET STRINGs only",-1}if(a!==DS)return this.error="OCTET STRING may consists of OCTET STRINGs only",-1}}else this.isHexOnly=!0,s=super.fromBER(e,t,r),this.blockLength=r;return s}toBER(e,t){return this.isConstructed?yi.prototype.toBER.call(this,e,t):e?new ArrayBuffer(this.valueHexView.byteLength):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),isConstructed:this.isConstructed}}}GS.NAME="OctetStringValueBlock";var N3;class Aa extends gn{constructor({idBlock:e={},lenBlock:t={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},GS),this.idBlock.tagClass=1,this.idBlock.tagNumber=4}fromBER(e,t,r){if(this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,r===0)return this.idBlock.error.length===0&&(this.blockLength+=this.idBlock.blockLength),this.lenBlock.error.length===0&&(this.blockLength+=this.lenBlock.blockLength),t;if(!this.valueBlock.isConstructed){const i=(e instanceof ArrayBuffer?new Uint8Array(e):e).subarray(t,t+r);try{if(i.byteLength){const a=D1(i,0,i.byteLength);a.offset!==-1&&a.offset===r&&(this.valueBlock.value=[a.result])}}catch{}}return super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Sl.prototype.onAsciiEncoding.call(this);const e=this.constructor.NAME,t=yt.ToHex(this.valueBlock.valueHexView);return`${e} : ${t}`}getValue(){if(!this.idBlock.isConstructed)return this.valueBlock.valueHexView.slice().buffer;const e=[];for(const t of this.valueBlock.value)t instanceof N3&&e.push(t.valueBlock.valueHexView);return Xe.concat(e)}}N3=Aa;ue.OctetString=N3;Aa.NAME=DS;class QS extends Ns(yi){constructor({unusedBits:e=0,isConstructed:t=!1,...r}={}){super(r),this.unusedBits=e,this.isConstructed=t,this.blockLength=this.valueHexView.byteLength}fromBER(e,t,r){if(!r)return t;let s=-1;if(this.isConstructed){if(s=yi.prototype.fromBER.call(this,e,t,r),s===-1)return s;for(const c of this.value){const u=c.constructor.NAME;if(u===pu){if(this.isIndefiniteForm)break;return this.error="EndOfContent is unexpected, BIT STRING may consists of BIT STRINGs only",-1}if(u!==IS)return this.error="BIT STRING may consists of BIT STRINGs only",-1;const h=c.valueBlock;if(this.unusedBits>0&&h.unusedBits>0)return this.error='Using of "unused bits" inside constructive BIT STRING allowed for least one only',-1;this.unusedBits=h.unusedBits}return s}const i=Xe.toUint8Array(e);if(!Is(this,i,t,r))return-1;const a=i.subarray(t,t+r);if(this.unusedBits=a[0],this.unusedBits>7)return this.error="Unused bits for BitString must be in range 0-7",-1;if(!this.unusedBits){const c=a.subarray(1);try{if(c.byteLength){const u=D1(c,0,c.byteLength);u.offset!==-1&&u.offset===r-1&&(this.value=[u.result])}}catch{}}return this.valueHexView=a.subarray(1),this.blockLength=a.length,t+r}toBER(e,t){if(this.isConstructed)return yi.prototype.toBER.call(this,e,t);if(e)return new ArrayBuffer(this.valueHexView.byteLength+1);if(!this.valueHexView.byteLength)return Cr;const r=new Uint8Array(this.valueHexView.length+1);return r[0]=this.unusedBits,r.set(this.valueHexView,1),r.buffer}toJSON(){return{...super.toJSON(),unusedBits:this.unusedBits,isConstructed:this.isConstructed}}}QS.NAME="BitStringValueBlock";var YS;class M3 extends gn{constructor({idBlock:e={},lenBlock:t={},...r}={}){var s,i;(s=r.isConstructed)!==null&&s!==void 0||(r.isConstructed=!!(!((i=r.value)===null||i===void 0)&&i.length)),super({idBlock:{isConstructed:r.isConstructed,...e},lenBlock:{...t,isIndefiniteForm:!!r.isIndefiniteForm},...r},QS),this.idBlock.tagClass=1,this.idBlock.tagNumber=3}fromBER(e,t,r){return this.valueBlock.isConstructed=this.idBlock.isConstructed,this.valueBlock.isIndefiniteForm=this.lenBlock.isIndefiniteForm,super.fromBER(e,t,r)}onAsciiEncoding(){if(this.valueBlock.isConstructed||this.valueBlock.value&&this.valueBlock.value.length)return Sl.prototype.onAsciiEncoding.call(this);{const e=[],t=this.valueBlock.valueHexView;for(const a of t)e.push(a.toString(2).padStart(8,"0"));const r=e.join(""),s=this.constructor.NAME,i=r.substring(0,r.length-this.valueBlock.unusedBits);return`${s} : ${i}`}}}YS=M3;ue.BitString=YS;M3.NAME=IS;var XS;function ez(n,e){const t=new Uint8Array([0]),r=new Uint8Array(n),s=new Uint8Array(e);let i=r.slice(0);const a=i.length-1,c=s.slice(0),u=c.length-1;let h=0;const f=u<a?a:u;let p=0;for(let m=f;m>=0;m--,p++){switch(!0){case p<c.length:h=i[a-p]+c[u-p]+t[0];break;default:h=i[a-p]+t[0]}switch(t[0]=h/10,!0){case p>=i.length:i=Kg(new Uint8Array([h%10]),i);break;default:i[a-p]=h%10}}return t[0]>0&&(i=Kg(t,i)),i}function s9(n){if(n>=kc.length)for(let e=kc.length;e<=n;e++){const t=new Uint8Array([0]);let r=kc[e-1].slice(0);for(let s=r.length-1;s>=0;s--){const i=new Uint8Array([(r[s]<<1)+t[0]]);t[0]=i[0]/10,r[s]=i[0]%10}t[0]>0&&(r=Kg(t,r)),kc.push(r)}return kc[n]}function tz(n,e){let t=0;const r=new Uint8Array(n),s=new Uint8Array(e),i=r.slice(0),a=i.length-1,c=s.slice(0),u=c.length-1;let h,f=0;for(let p=u;p>=0;p--,f++)switch(h=i[a-f]-c[u-f]-t,!0){case h<0:t=1,i[a-f]=h+10;break;default:t=0,i[a-f]=h}if(t>0)for(let p=a-u+1;p>=0;p--,f++)if(h=i[a-f]-t,h<0)t=1,i[a-f]=h+10;else{t=0,i[a-f]=h;break}return i.slice()}class R3 extends Ns(Tn){setValueHex(){this.valueHexView.length>=4?(this.warnings.push("Too big Integer for decoding, hex only"),this.isHexOnly=!0,this._valueDec=0):(this.isHexOnly=!1,this.valueHexView.length>0&&(this._valueDec=_S.call(this)))}constructor({value:e,...t}={}){super(t),this._valueDec=0,t.valueHex&&this.setValueHex(),e!==void 0&&(this.valueDec=e)}set valueDec(e){this._valueDec=e,this.isHexOnly=!1,this.valueHexView=new Uint8Array(Y$(e))}get valueDec(){return this._valueDec}fromDER(e,t,r,s=0){const i=this.fromBER(e,t,r);if(i===-1)return i;const a=this.valueHexView;return a[0]===0&&(a[1]&128)!==0?this.valueHexView=a.subarray(1):s!==0&&a.length<s&&(s-a.length>1&&(s=a.length+1),this.valueHexView=a.subarray(s-a.length)),i}toDER(e=!1){const t=this.valueHexView;switch(!0){case(t[0]&128)!==0:{const r=new Uint8Array(this.valueHexView.length+1);r[0]=0,r.set(t,1),this.valueHexView=r}break;case(t[0]===0&&(t[1]&128)===0):this.valueHexView=this.valueHexView.subarray(1);break}return this.toBER(e)}fromBER(e,t,r){const s=super.fromBER(e,t,r);return s===-1||this.setValueHex(),s}toBER(e){return e?new ArrayBuffer(this.valueHexView.length):this.valueHexView.slice().buffer}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}toString(){const e=this.valueHexView.length*8-1;let t=new Uint8Array(this.valueHexView.length*8/3),r=0,s;const i=this.valueHexView;let a="",c=!1;for(let u=i.byteLength-1;u>=0;u--){s=i[u];for(let h=0;h<8;h++){if((s&1)===1)switch(r){case e:t=tz(s9(r),t),a="-";break;default:t=ez(t,s9(r))}r++,s>>=1}}for(let u=0;u<t.length;u++)t[u]&&(c=!0),c&&(a+=r9.charAt(t[u]));return c===!1&&(a+=r9.charAt(0)),a}}XS=R3;R3.NAME="IntegerValueBlock";Object.defineProperty(XS.prototype,"valueHex",{set:function(n){this.valueHexView=new Uint8Array(n),this.setValueHex()},get:function(){return this.valueHexView.slice().buffer}});var jc;class Ht extends gn{constructor(e={}){super(e,R3),this.idBlock.tagClass=1,this.idBlock.tagNumber=2}toBigInt(){return Rf(),BigInt(this.valueBlock.toString())}static fromBigInt(e){Rf();const t=BigInt(e),r=new D3,s=t.toString(16).replace(/^-/,""),i=new Uint8Array(yt.FromHex(s));if(t<0){const c=new Uint8Array(i.length+(i[0]&128?1:0));c[0]|=128;const h=BigInt(`0x${yt.ToHex(c)}`)+t,f=Xe.toUint8Array(yt.FromHex(h.toString(16)));f[0]|=128,r.write(f)}else i[0]&128&&r.write(new Uint8Array([0])),r.write(i);return new jc({valueHex:r.final()})}convertToDER(){const e=new jc({valueHex:this.valueBlock.valueHexView});return e.valueBlock.toDER(),e}convertFromDER(){return new jc({valueHex:this.valueBlock.valueHexView[0]===0?this.valueBlock.valueHexView.subarray(1):this.valueBlock.valueHexView})}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()}`}}jc=Ht;ue.Integer=jc;Ht.NAME="INTEGER";var JS;class ZS extends Ht{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=10}}JS=ZS;ue.Enumerated=JS;ZS.NAME="ENUMERATED";class qg extends Ns(Tn){constructor({valueDec:e=-1,isFirstSid:t=!1,...r}={}){super(r),this.valueDec=e,this.isFirstSid=t}fromBER(e,t,r){if(!r)return t;const s=Xe.toUint8Array(e);if(!Is(this,s,t,r))return-1;const i=s.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let c=0;c<r&&(this.valueHexView[c]=i[c]&127,this.blockLength++,(i[c]&128)!==0);c++);const a=new Uint8Array(this.blockLength);for(let c=0;c<this.blockLength;c++)a[c]=this.valueHexView[c];return this.valueHexView=a,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Za(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}set valueBigInt(e){Rf();let t=BigInt(e).toString(2);for(;t.length%7;)t="0"+t;const r=new Uint8Array(t.length/7);for(let s=0;s<r.length;s++)r[s]=parseInt(t.slice(s*7,s*7+7),2)+(s+1<r.length?128:0);this.fromBER(r.buffer,0,r.length)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength-1;a++)i[a]=s[a]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=wo(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Cr;const r=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let a=0;a<i;a++)r[a]=s[a]|128;r[i]=s[i]}return r}toString(){let e="";if(this.isHexOnly)e=yt.ToHex(this.valueHexView);else if(this.isFirstSid){let t=this.valueDec;this.valueDec<=39?e="0.":this.valueDec<=79?(e="1.",t-=40):(e="2.",t-=80),e+=t.toString()}else e=this.valueDec.toString();return e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec,isFirstSid:this.isFirstSid}}}qg.NAME="sidBlock";class eE extends Tn{constructor({value:e=xl,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let s=t;for(;r>0;){const i=new qg;if(s=i.fromBER(e,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.value.length===0&&(i.isFirstSid=!0),this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(e){const t=[];for(let r=0;r<this.value.length;r++){const s=this.value[r].toBER(e);if(s.byteLength===0)return this.error=this.value[r].error,Cr;t.push(s)}return _3(t)}fromString(e){this.value=[];let t=0,r=0,s="",i=!1;do if(r=e.indexOf(".",t),r===-1?s=e.substring(t):s=e.substring(t,r),t=r+1,i){const a=this.value[0];let c=0;switch(a.valueDec){case 0:break;case 1:c=40;break;case 2:c=80;break;default:this.value=[];return}const u=parseInt(s,10);if(isNaN(u))return;a.valueDec=u+c,i=!1}else{const a=new qg;if(s>Number.MAX_SAFE_INTEGER){Rf();const c=BigInt(s);a.valueBigInt=c}else if(a.valueDec=parseInt(s,10),isNaN(a.valueDec))return;this.value.length||(a.isFirstSid=!0,i=!0),this.value.push(a)}while(r!==-1)}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(e=`${e}.`),t?(s=`{${s}}`,this.value[r].isFirstSid?e=`2.{${s} - 80}`:e+=s):e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}eE.NAME="ObjectIdentifierValueBlock";var tE;class li extends gn{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,eE),this.idBlock.tagClass=1,this.idBlock.tagNumber=6}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}tE=li;ue.ObjectIdentifier=tE;li.NAME="OBJECT IDENTIFIER";class Wg extends Ns(Ro){constructor({valueDec:e=0,...t}={}){super(t),this.valueDec=e}fromBER(e,t,r){if(r===0)return t;const s=Xe.toUint8Array(e);if(!Is(this,s,t,r))return-1;const i=s.subarray(t,t+r);this.valueHexView=new Uint8Array(r);for(let c=0;c<r&&(this.valueHexView[c]=i[c]&127,this.blockLength++,(i[c]&128)!==0);c++);const a=new Uint8Array(this.blockLength);for(let c=0;c<this.blockLength;c++)a[c]=this.valueHexView[c];return this.valueHexView=a,(i[this.blockLength-1]&128)!==0?(this.error="End of input reached before message was fully decoded",-1):(this.valueHexView[0]===0&&this.warnings.push("Needlessly long format of SID encoding"),this.blockLength<=8?this.valueDec=Za(this.valueHexView,7):(this.isHexOnly=!0,this.warnings.push("Too big SID for decoding, hex only")),t+this.blockLength)}toBER(e){if(this.isHexOnly){if(e)return new ArrayBuffer(this.valueHexView.byteLength);const s=this.valueHexView,i=new Uint8Array(this.blockLength);for(let a=0;a<this.blockLength-1;a++)i[a]=s[a]|128;return i[this.blockLength-1]=s[this.blockLength-1],i.buffer}const t=wo(this.valueDec,7);if(t.byteLength===0)return this.error="Error during encoding SID value",Cr;const r=new Uint8Array(t.byteLength);if(!e){const s=new Uint8Array(t),i=t.byteLength-1;for(let a=0;a<i;a++)r[a]=s[a]|128;r[i]=s[i]}return r.buffer}toString(){let e="";return this.isHexOnly?e=yt.ToHex(this.valueHexView):e=this.valueDec.toString(),e}toJSON(){return{...super.toJSON(),valueDec:this.valueDec}}}Wg.NAME="relativeSidBlock";class nE extends Tn{constructor({value:e=xl,...t}={}){super(t),this.value=[],e&&this.fromString(e)}fromBER(e,t,r){let s=t;for(;r>0;){const i=new Wg;if(s=i.fromBER(e,s,r),s===-1)return this.blockLength=0,this.error=i.error,s;this.blockLength+=i.blockLength,r-=i.blockLength,this.value.push(i)}return s}toBER(e,t){const r=[];for(let s=0;s<this.value.length;s++){const i=this.value[s].toBER(e);if(i.byteLength===0)return this.error=this.value[s].error,Cr;r.push(i)}return _3(r)}fromString(e){this.value=[];let t=0,r=0,s="";do{r=e.indexOf(".",t),r===-1?s=e.substring(t):s=e.substring(t,r),t=r+1;const i=new Wg;if(i.valueDec=parseInt(s,10),isNaN(i.valueDec))return!0;this.value.push(i)}while(r!==-1);return!0}toString(){let e="",t=!1;for(let r=0;r<this.value.length;r++){t=this.value[r].isHexOnly;let s=this.value[r].toString();r!==0&&(e=`${e}.`),t&&(s=`{${s}}`),e+=s}return e}toJSON(){const e={...super.toJSON(),value:this.toString(),sidArray:[]};for(let t=0;t<this.value.length;t++)e.sidArray.push(this.value[t].toJSON());return e}}nE.NAME="RelativeObjectIdentifierValueBlock";var rE;class sE extends gn{getValue(){return this.valueBlock.toString()}setValue(e){this.valueBlock.fromString(e)}constructor(e={}){super(e,nE),this.idBlock.tagClass=1,this.idBlock.tagNumber=13}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.valueBlock.toString()||"empty"}`}toJSON(){return{...super.toJSON(),value:this.getValue()}}}rE=sE;ue.RelativeObjectIdentifier=rE;sE.NAME="RelativeObjectIdentifier";var iE;class hn extends Sl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=16}}iE=hn;ue.Sequence=iE;hn.NAME="SEQUENCE";var oE;let aE=class extends Sl{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=17}};oE=aE;ue.Set=oE;aE.NAME="SET";class lE extends Ns(Tn){constructor({...e}={}){super(e),this.isHexOnly=!0,this.value=xl}toJSON(){return{...super.toJSON(),value:this.value}}}lE.NAME="StringValueBlock";class cE extends lE{}cE.NAME="SimpleStringValueBlock";class $n extends LS{constructor({...e}={}){super(e,cE)}fromBuffer(e){this.valueBlock.value=String.fromCharCode.apply(null,Xe.toUint8Array(e))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.charCodeAt(s);this.valueBlock.value=e}}$n.NAME="SIMPLE STRING";class uE extends $n{fromBuffer(e){this.valueBlock.valueHexView=Xe.toUint8Array(e);try{this.valueBlock.value=yt.ToUtf8String(e)}catch(t){this.warnings.push(`Error during "decodeURIComponent": ${t}, using raw string`),this.valueBlock.value=yt.ToBinary(e)}}fromString(e){this.valueBlock.valueHexView=new Uint8Array(yt.FromUtf8String(e)),this.valueBlock.value=e}}uE.NAME="Utf8StringValueBlock";var dE;class Lo extends uE{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=12}}dE=Lo;ue.Utf8String=dE;Lo.NAME="UTF8String";class hE extends $n{fromBuffer(e){this.valueBlock.value=yt.ToUtf16String(e),this.valueBlock.valueHexView=Xe.toUint8Array(e)}fromString(e){this.valueBlock.value=e,this.valueBlock.valueHexView=new Uint8Array(yt.FromUtf16String(e))}}hE.NAME="BmpStringValueBlock";var fE;class pE extends hE{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=30}}fE=pE;ue.BmpString=fE;pE.NAME="BMPString";class gE extends $n{fromBuffer(e){const t=ArrayBuffer.isView(e)?e.slice().buffer:e.slice(0),r=new Uint8Array(t);for(let s=0;s<r.length;s+=4)r[s]=r[s+3],r[s+1]=r[s+2],r[s+2]=0,r[s+3]=0;this.valueBlock.value=String.fromCharCode.apply(null,new Uint32Array(t))}fromString(e){const t=e.length,r=this.valueBlock.valueHexView=new Uint8Array(t*4);for(let s=0;s<t;s++){const i=wo(e.charCodeAt(s),8),a=new Uint8Array(i);if(a.length>4)continue;const c=4-a.length;for(let u=a.length-1;u>=0;u--)r[s*4+u+c]=a[u]}this.valueBlock.value=e}}gE.NAME="UniversalStringValueBlock";var mE;class yE extends gE{constructor({...e}={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=28}}mE=yE;ue.UniversalString=mE;yE.NAME="UniversalString";var wE;class vE extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=18}}wE=vE;ue.NumericString=wE;vE.NAME="NumericString";var bE;class xE extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=19}}bE=xE;ue.PrintableString=bE;xE.NAME="PrintableString";var SE;class EE extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=20}}SE=EE;ue.TeletexString=SE;EE.NAME="TeletexString";var CE;class kE extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=21}}CE=kE;ue.VideotexString=CE;kE.NAME="VideotexString";var AE;class PE extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=22}}AE=PE;ue.IA5String=AE;PE.NAME="IA5String";var TE;class _E extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=25}}TE=_E;ue.GraphicString=TE;_E.NAME="GraphicString";var DE;class L3 extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=26}}DE=L3;ue.VisibleString=DE;L3.NAME="VisibleString";var IE;class NE extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=27}}IE=NE;ue.GeneralString=IE;NE.NAME="GeneralString";var ME;class RE extends $n{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=29}}ME=RE;ue.CharacterString=ME;RE.NAME="CharacterString";var LE;class O3 extends L3{constructor({value:e,valueDate:t,...r}={}){if(super(r),this.year=0,this.month=0,this.day=0,this.hour=0,this.minute=0,this.second=0,e){this.fromString(e),this.valueBlock.valueHexView=new Uint8Array(e.length);for(let s=0;s<e.length;s++)this.valueBlock.valueHexView[s]=e.charCodeAt(s)}t&&(this.fromDate(t),this.valueBlock.valueHexView=new Uint8Array(this.toBuffer())),this.idBlock.tagClass=1,this.idBlock.tagNumber=23}fromBuffer(e){this.fromString(String.fromCharCode.apply(null,Xe.toUint8Array(e)))}toBuffer(){const e=this.toString(),t=new ArrayBuffer(e.length),r=new Uint8Array(t);for(let s=0;s<e.length;s++)r[s]=e.charCodeAt(s);return t}fromDate(e){this.year=e.getUTCFullYear(),this.month=e.getUTCMonth()+1,this.day=e.getUTCDate(),this.hour=e.getUTCHours(),this.minute=e.getUTCMinutes(),this.second=e.getUTCSeconds()}toDate(){return new Date(Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second))}fromString(e){const r=/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})Z/ig.exec(e);if(r===null){this.error="Wrong input string for conversion";return}const s=parseInt(r[1],10);s>=50?this.year=1900+s:this.year=2e3+s,this.month=parseInt(r[2],10),this.day=parseInt(r[3],10),this.hour=parseInt(r[4],10),this.minute=parseInt(r[5],10),this.second=parseInt(r[6],10)}toString(e="iso"){if(e==="iso"){const t=new Array(7);return t[0]=Ln(this.year<2e3?this.year-1900:this.year-2e3,2),t[1]=Ln(this.month,2),t[2]=Ln(this.day,2),t[3]=Ln(this.hour,2),t[4]=Ln(this.minute,2),t[5]=Ln(this.second,2),t[6]="Z",t.join("")}return super.toString(e)}onAsciiEncoding(){return`${this.constructor.NAME} : ${this.toDate().toISOString()}`}toJSON(){return{...super.toJSON(),year:this.year,month:this.month,day:this.day,hour:this.hour,minute:this.minute,second:this.second}}}LE=O3;ue.UTCTime=LE;O3.NAME="UTCTime";var OE;class BE extends O3{constructor(e={}){var t;super(e),(t=this.millisecond)!==null&&t!==void 0||(this.millisecond=0),this.idBlock.tagClass=1,this.idBlock.tagNumber=24}fromDate(e){super.fromDate(e),this.millisecond=e.getUTCMilliseconds()}toDate(){const e=Date.UTC(this.year,this.month-1,this.day,this.hour,this.minute,this.second,this.millisecond);return new Date(e)}fromString(e){let t=!1,r="",s="",i=0,a,c=0,u=0;if(e[e.length-1]==="Z")r=e.substring(0,e.length-1),t=!0;else{const p=new Number(e[e.length-1]);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");r=e}if(t){if(r.indexOf("+")!==-1)throw new Error("Wrong input string for conversion");if(r.indexOf("-")!==-1)throw new Error("Wrong input string for conversion")}else{let p=1,m=r.indexOf("+"),w="";if(m===-1&&(m=r.indexOf("-"),p=-1),m!==-1){if(w=r.substring(m+1),r=r.substring(0,m),w.length!==2&&w.length!==4)throw new Error("Wrong input string for conversion");let x=parseInt(w.substring(0,2),10);if(isNaN(x.valueOf()))throw new Error("Wrong input string for conversion");if(c=p*x,w.length===4){if(x=parseInt(w.substring(2,4),10),isNaN(x.valueOf()))throw new Error("Wrong input string for conversion");u=p*x}}}let h=r.indexOf(".");if(h===-1&&(h=r.indexOf(",")),h!==-1){const p=new Number(`0${r.substring(h)}`);if(isNaN(p.valueOf()))throw new Error("Wrong input string for conversion");i=p.valueOf(),s=r.substring(0,h)}else s=r;switch(!0){case s.length===8:if(a=/(\d{4})(\d{2})(\d{2})/ig,h!==-1)throw new Error("Wrong input string for conversion");break;case s.length===10:if(a=/(\d{4})(\d{2})(\d{2})(\d{2})/ig,h!==-1){let p=60*i;this.minute=Math.floor(p),p=60*(p-this.minute),this.second=Math.floor(p),p=1e3*(p-this.second),this.millisecond=Math.floor(p)}break;case s.length===12:if(a=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})/ig,h!==-1){let p=60*i;this.second=Math.floor(p),p=1e3*(p-this.second),this.millisecond=Math.floor(p)}break;case s.length===14:if(a=/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/ig,h!==-1){const p=1e3*i;this.millisecond=Math.floor(p)}break;default:throw new Error("Wrong input string for conversion")}const f=a.exec(s);if(f===null)throw new Error("Wrong input string for conversion");for(let p=1;p<f.length;p++)switch(p){case 1:this.year=parseInt(f[p],10);break;case 2:this.month=parseInt(f[p],10);break;case 3:this.day=parseInt(f[p],10);break;case 4:this.hour=parseInt(f[p],10)+c;break;case 5:this.minute=parseInt(f[p],10)+u;break;case 6:this.second=parseInt(f[p],10);break;default:throw new Error("Wrong input string for conversion")}if(t===!1){const p=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second,this.millisecond);this.year=p.getUTCFullYear(),this.month=p.getUTCMonth(),this.day=p.getUTCDay(),this.hour=p.getUTCHours(),this.minute=p.getUTCMinutes(),this.second=p.getUTCSeconds(),this.millisecond=p.getUTCMilliseconds()}}toString(e="iso"){if(e==="iso"){const t=[];return t.push(Ln(this.year,4)),t.push(Ln(this.month,2)),t.push(Ln(this.day,2)),t.push(Ln(this.hour,2)),t.push(Ln(this.minute,2)),t.push(Ln(this.second,2)),this.millisecond!==0&&(t.push("."),t.push(Ln(this.millisecond,3))),t.push("Z"),t.join("")}return super.toString(e)}toJSON(){return{...super.toJSON(),millisecond:this.millisecond}}}OE=BE;ue.GeneralizedTime=OE;BE.NAME="GeneralizedTime";var FE;class UE extends Lo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=31}}FE=UE;ue.DATE=FE;UE.NAME="DATE";var VE;class jE extends Lo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=32}}VE=jE;ue.TimeOfDay=VE;jE.NAME="TimeOfDay";var $E;class zE extends Lo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=33}}$E=zE;ue.DateTime=$E;zE.NAME="DateTime";var HE;class KE extends Lo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=34}}HE=KE;ue.Duration=HE;KE.NAME="Duration";var qE;class WE extends Lo{constructor(e={}){super(e),this.idBlock.tagClass=1,this.idBlock.tagNumber=14}}qE=WE;ue.TIME=qE;WE.NAME="TIME";function i9(){const n=Ke();let e=!1;return{sink:async t=>{if(e)throw new Error("already piped");e=!0,n.resolve(t)},source:async function*(){yield*await n.promise}()}}function nz(){const n=i9(),e=i9();return[{source:n.source,sink:e.sink},{source:e.source,sink:n.sink}]}function I1(n,...e){if(n==null)throw new Error("Empty pipeline");if(z2(n)){const r=n;n=()=>r.source}else if(QE(n)||GE(n)){const r=n;n=()=>r}const t=[n,...e];if(t.length>1&&z2(t[t.length-1])&&(t[t.length-1]=t[t.length-1].sink),t.length>2)for(let r=1;r<t.length-1;r++)z2(t[r])&&(t[r]=sz(t[r]));return rz(...t)}const rz=(...n)=>{let e;for(;n.length>0;)e=n.shift()(e);return e},GE=n=>n?.[Symbol.asyncIterator]!=null,QE=n=>n?.[Symbol.iterator]!=null,z2=n=>n==null?!1:n.sink!=null&&n.source!=null,sz=n=>e=>{const t=n.sink(e);if(t?.then!=null){const r=_i({objectMode:!0});t.then(()=>{r.end()},a=>{r.end(a)});let s;const i=n.source;if(GE(i))s=async function*(){yield*i,r.end()};else if(QE(i))s=function*(){yield*i,r.end()};else throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");return fu(r,s())}return n.source};function iz(n,e,t){return Fu(n),t===void 0&&(t=new Uint8Array(n.outputLen)),Vu(n,tu(t),tu(e))}const H2=Uint8Array.from([0]),o9=Uint8Array.of();function oz(n,e,t,r=32){Fu(n),io(r);const s=n.outputLen;if(r>255*s)throw new Error("Length should be <= 255*HashLen");const i=Math.ceil(r/s);t===void 0&&(t=o9);const a=new Uint8Array(i*s),c=Vu.create(n,e),u=c._cloneInto(),h=new Uint8Array(c.outputLen);for(let f=0;f<i;f++)H2[0]=f+1,u.update(f===0?o9:h).update(t).update(H2).digestInto(h),a.set(h,s*f),c._cloneInto(u);return c.destroy(),u.destroy(),Ei(h,H2),a.slice(0,r)}function el(n,e){if(n.length!==e.length)throw new Error("Inputs should have the same length");const t=Sr(n.length);for(let r=0;r<n.length;r++)t[r]=n[r]^e[r];return t}function az(n){return e=>new H$(e,n)}const lz=[vs,$u,Hu,zu,vl];function a9(n){return YE("sni",n)?.value}function l9(n){const e=YE("tcp",n)?.value;return e==null?"":`:${e}`}function YE(n,e){return e.find(t=>t.name===n)}function c9(n){return n.some(({code:e})=>e===Na)}function fr(n,e){const t=XE[n.name];if(t==null)throw new Error(`Can't interpret protocol ${n.name}`);const r=t(n,e);return n.code===nr?`[${r}]`:r}const XE={ip4:(n,e)=>n.value,ip6:(n,e)=>e.length===0?n.value:`[${n.value}]`,tcp:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`tcp://${fr(t,e)}:${n.value}`},udp:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`udp://${fr(t,e)}:${n.value}`},dnsaddr:(n,e)=>n.value,dns4:(n,e)=>n.value,dns6:(n,e)=>n.value,dns:(n,e)=>n.value,ipfs:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${fr(t,e)}`},p2p:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return`${fr(t,e)}`},http:(n,e)=>{const t=c9(e),r=a9(e),s=l9(e);if(t&&r!=null)return`https://${r}${s}`;const i=t?"https://":"http://",a=e.pop();if(a==null)throw new Error("Unexpected end of multiaddr");let c=fr(a,e);return c=c?.replace("tcp://",""),`${i}${c}`},"http-path":(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");const r=fr(t,e),s=decodeURIComponent(n.value??"");return`${r}${s}`},tls:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return fr(t,e)},sni:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");return fr(t,e)},https:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let r=fr(t,e);return r=r?.replace("tcp://",""),`https://${r}`},ws:(n,e)=>{const t=c9(e),r=a9(e),s=l9(e);if(t&&r!=null)return`wss://${r}${s}`;const i=t?"wss://":"ws://",a=e.pop();if(a==null)throw new Error("Unexpected end of multiaddr");let c=fr(a,e);return c=c?.replace("tcp://",""),`${i}${c}`},wss:(n,e)=>{const t=e.pop();if(t==null)throw new Error("Unexpected end of multiaddr");let r=fr(t,e);return r=r?.replace("tcp://",""),`wss://${r}`}};function cz(n,e){const r=Pe(n).getComponents(),s=r.pop();if(s==null)throw new Error("Unexpected end of multiaddr");const i=XE[s.name];if(i==null)throw new Error(`No interpreter found for ${s.name}`);let a=i(s,r)??"";return lz.includes(s.code)&&(a=a.replace(/^.*:\/\//,""),s.value==="443"?a=`https://${a}`:a=`http://${a}`),(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("ws://")||a.startsWith("wss://"))&&(a=new URL(a).toString(),a.endsWith("/")&&(a=a.substring(0,a.length-1))),a}const uz=async n=>{if(n.readyState>=2)throw new Error("socket closed");n.readyState!==1&&await new Promise((e,t)=>{function r(){n.removeEventListener("open",s),n.removeEventListener("error",i)}function s(){r(),e()}function i(a){r(),t(a.error??new Error(`connect ECONNREFUSED ${n.url}`))}n.addEventListener("open",s),n.addEventListener("error",i)})},dz=(n,e)=>(e=e??{},e.closeOnEnd=e.closeOnEnd!==!1,async r=>{for await(const s of r){try{await uz(n)}catch(i){if(i.message==="socket closed")break;throw i}if(n.readyState===n.CLOSING||n.readyState===n.CLOSED)break;n.send(s)}e.closeOnEnd!=null&&n.readyState<=1&&await new Promise((s,i)=>{n.addEventListener("close",a=>{if(a.wasClean||a.code===1006)s();else{const c=Object.assign(new Error("ws error"),{event:a});i(c)}}),setTimeout(()=>{n.close()})})});var ma={},Ac={},u9;function hz(){if(u9)return Ac;u9=1,Object.defineProperty(Ac,"__esModule",{value:!0});class n{constructor(){this.pullQueue=[],this.pushQueue=[],this.eventHandlers={},this.isPaused=!1,this.isStopped=!1}push(r){if(this.isStopped)return;const s={value:r,done:!1};if(this.pullQueue.length){const i=this.pullQueue.shift();i&&i.resolve(s)}else this.pushQueue.push(Promise.resolve(s)),this.highWaterMark!==void 0&&this.pushQueue.length>=this.highWaterMark&&!this.isPaused&&(this.isPaused=!0,this.eventHandlers.highWater?this.eventHandlers.highWater():console&&console.warn(`EventIterator queue reached ${this.pushQueue.length} items`))}stop(){if(!this.isStopped){this.isStopped=!0,this.remove();for(const r of this.pullQueue)r.resolve({value:void 0,done:!0});this.pullQueue.length=0}}fail(r){if(!this.isStopped)if(this.isStopped=!0,this.remove(),this.pullQueue.length){for(const s of this.pullQueue)s.reject(r);this.pullQueue.length=0}else{const s=Promise.reject(r);s.catch(()=>{}),this.pushQueue.push(s)}}remove(){Promise.resolve().then(()=>{this.removeCallback&&this.removeCallback()})}[Symbol.asyncIterator](){return{next:r=>{const s=this.pushQueue.shift();return s?(this.lowWaterMark!==void 0&&this.pushQueue.length<=this.lowWaterMark&&this.isPaused&&(this.isPaused=!1,this.eventHandlers.lowWater&&this.eventHandlers.lowWater()),s):this.isStopped?Promise.resolve({value:void 0,done:!0}):new Promise((i,a)=>{this.pullQueue.push({resolve:i,reject:a})})},return:()=>(this.isStopped=!0,this.pushQueue.length=0,this.remove(),Promise.resolve({value:void 0,done:!0}))}}}class e{constructor(r,{highWaterMark:s=100,lowWaterMark:i=1}={}){const a=new n;a.highWaterMark=s,a.lowWaterMark=i,a.removeCallback=r({push:c=>a.push(c),stop:()=>a.stop(),fail:c=>a.fail(c),on:(c,u)=>{a.eventHandlers[c]=u}})||(()=>{}),this[Symbol.asyncIterator]=()=>a[Symbol.asyncIterator](),Object.freeze(this)}}return Ac.EventIterator=e,Ac.default=e,Ac}var d9;function fz(){if(d9)return ma;d9=1,Object.defineProperty(ma,"__esModule",{value:!0});const n=hz();ma.EventIterator=n.EventIterator;function e(t,r,s){return new n.EventIterator(({push:i})=>(this.addEventListener(t,i,r),()=>this.removeEventListener(t,i,r)),s)}return ma.subscribe=e,ma.default=n.EventIterator,ma}var pz=fz();function h9(n){return n instanceof ArrayBuffer||n?.constructor?.name==="ArrayBuffer"&&typeof n?.byteLength=="number"}const gz=n=>{n.binaryType="arraybuffer";const e=async()=>{await new Promise((i,a)=>{if(r){i();return}if(s!=null){a(s);return}const c=f=>{n.removeEventListener("open",u),n.removeEventListener("error",h),f()},u=()=>{c(i)},h=f=>{c(()=>{a(f.error??new Error(`connect ECONNREFUSED ${n.url}`))})};n.addEventListener("open",u),n.addEventListener("error",h)})},t=async function*(){const i=new pz.EventIterator(({push:a,stop:c,fail:u})=>{const h=p=>{let m=null;typeof p.data=="string"&&(m=we(p.data)),h9(p.data)&&(m=new Uint8Array(p.data)),p.data instanceof Uint8Array&&(m=p.data),m!=null&&a(m)},f=p=>{u(p.error??new Error("Socket error"))};return n.addEventListener("message",h),n.addEventListener("error",f),n.addEventListener("close",c),()=>{n.removeEventListener("message",h),n.removeEventListener("error",f),n.removeEventListener("close",c)}},{highWaterMark:1/0});await e();for await(const a of i)yield h9(a)?new Uint8Array(a):a}();let r=n.readyState===1,s;return n.addEventListener("open",()=>{r=!0,s=null}),n.addEventListener("close",()=>{r=!1,s=null}),n.addEventListener("error",i=>{r||(s=i.error??new Error(`connect ECONNREFUSED ${n.url}`))}),Object.assign(t,{connected:e})},mz=(n,e)=>{e=e??{};const t=gz(n);let r=e.remoteAddress,s=e.remotePort;if(n.url!=null)try{const a=new URL(n.url);r=a.hostname,s=parseInt(a.port,10)}catch{}if(r==null||s==null)throw new Error("Remote connection did not have address and/or port");return{sink:dz(n,e),source:t,connected:async()=>{await t.connected()},close:async()=>{(n.readyState===n.CONNECTING||n.readyState===n.OPEN)&&await new Promise(a=>{n.addEventListener("close",()=>{a()}),n.close()})},destroy:()=>{n.terminate!=null?n.terminate():n.close()},remoteAddress:r,remotePort:s,socket:n}},yz=WebSocket,wz={"http:":"ws:","https:":"wss:"},f9="ws:",vz=(n,e)=>{if(n.startsWith("//")&&(n=`${e?.protocol??f9}${n}`),n.startsWith("/")&&e!=null){const r=e.protocol??f9,s=e.host,i=e.port!=null&&s?.endsWith(`:${e.port}`)!==!0?`:${e.port}`:"";n=`${r}//${s}${i}${n}`}const t=new URL(n);for(const[r,s]of Object.entries(wz))t.protocol===r&&(t.protocol=s);return t};function bz(n,e){const t=typeof window>"u"?void 0:window.location;e=e??{};const r=vz(n,t),s=new yz(r.toString(),e.websocket);return mz(s,e)}function xz(n){return n.filter(e=>Df.exactMatch(e)||lu.exactMatch(e))}function Sz(){throw new Error("WebSocket Servers can not be created in the browser!")}const Ez=500;function Cz(n,e,t){const r=t.logger.forComponent("libp2p:websockets:maconn"),s=t.metrics,i=t.metricPrefix??"",a={log:r,async sink(c){try{await n.sink(async function*(){for await(const u of c)u instanceof Uint8Array?yield u:yield u.subarray()}())}catch(u){u.type!=="aborted"&&r.error(u)}},source:n.source,remoteAddr:e,timeline:{open:Date.now()},async close(c={}){const u=Date.now();if(c.signal==null){const f=AbortSignal.timeout(Ez);c={...c,signal:f}}const h=()=>{const{host:f,port:p}=a.remoteAddr.toOptions();r("timeout closing stream to %s:%s after %dms, destroying it manually",f,p,Date.now()-u),this.abort(new xi("Socket close timeout"))};c.signal?.addEventListener("abort",h);try{await n.close()}catch(f){r.error("error closing WebSocket gracefully",f),this.abort(f)}finally{c.signal?.removeEventListener("abort",h),a.timeline.close=Date.now()}},abort(c){const{host:u,port:h}=a.remoteAddr.toOptions();r("timeout closing stream to %s:%s due to error",u,h,c),n.destroy(),a.timeline.close=Date.now(),s?.increment({[`${i}error`]:!0})}};return n.socket.addEventListener("close",()=>{s?.increment({[`${i}close`]:!0}),a.timeline.close==null&&(a.timeline.close=Date.now())},{once:!0}),a}let kz=class{log;init;logger;metrics;components;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:websockets"),this.logger=e.logger,this.components=e,this.init=t,e.metrics!=null&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_websockets_dialer_events_total",{label:"event",help:"Total count of WebSockets dialer events by type"})})}[$m]=!0;[Symbol.toStringTag]="@libp2p/websockets";[br]=["@libp2p/transport"];async dial(e,t){this.log("dialing %s",e),t=t??{};const r=await this._connect(e,t),s=Cz(r,e,{logger:this.logger,metrics:this.metrics?.dialerEvents});this.log("new outbound connection %s",s.remoteAddr);const i=await t.upgrader.upgradeOutbound(s,t);return this.log("outbound connection %s upgraded",s.remoteAddr),i}async _connect(e,t){t?.signal?.throwIfAborted();const r=e.toOptions();this.log("dialing %s:%s",r.host,r.port);const s=Ke(),i=bz(cz(e),this.init);i.socket.addEventListener("error",()=>{const a=new Kv(`Could not connect to ${e.toString()}`);this.log.error("connection error:",a),this.metrics?.dialerEvents.increment({error:!0}),s.reject(a)});try{t.onProgress?.(new qe("websockets:open-connection")),await Dt(Promise.race([i.connected(),s.promise]),t.signal)}catch(a){throw t.signal?.aborted&&this.metrics?.dialerEvents.increment({abort:!0}),i.close().catch(c=>{this.log.error("error closing raw socket",c)}),a}return this.log("connected %s",e),this.metrics?.dialerEvents.increment({connect:!0}),i}createListener(e){return Sz({logger:this.logger,events:this.components.events,metrics:this.components.metrics},{...this.init,...e})}listenFilter(e){return e=Array.isArray(e)?e:[e],this.init?.filter!=null?this.init?.filter(e):xz(e)}dialFilter(e){return this.listenFilter(e)}};function Az(n={}){return e=>new kz(e,n)}const Pz=290,Tz=1,JE=2e3,_z=100,Mh=`${d1}-circuit-relay`;BigInt(1<<17);const Lf="/libp2p/circuit/relay/0.2.0/hop",p9="/libp2p/circuit/relay/0.2.0/stop",g9=300,Dz=4096,Iz=.001;var tl;(function(n){(function(r){r.RESERVE="RESERVE",r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.RESERVE=0]="RESERVE",r[r.CONNECT=1]="CONNECT",r[r.STATUS=2]="STATUS"})(e||(e={})),function(r){r.codec=()=>Ds(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=Qe((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),nl.codec().encode(r.peer,s)),r.reservation!=null&&(s.uint32(26),Of.codec().encode(r.reservation,s)),r.limit!=null&&(s.uint32(34),rl.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(40),fn.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const a={},c=s==null?r.len:r.pos+s;for(;r.pos<c;){const u=r.uint32();switch(u>>>3){case 1:{a.type=n.Type.codec().decode(r);break}case 2:{a.peer=nl.codec().decode(r,r.uint32(),{limits:i.limits?.peer});break}case 3:{a.reservation=Of.codec().decode(r,r.uint32(),{limits:i.limits?.reservation});break}case 4:{a.limit=rl.codec().decode(r,r.uint32(),{limits:i.limits?.limit});break}case 5:{a.status=fn.codec().decode(r);break}default:{r.skipType(u&7);break}}}return a})),t),n.encode=r=>Ge(r,n.codec()),n.decode=(r,s)=>We(r,n.codec(),s)})(tl||(tl={}));var ds;(function(n){(function(r){r.CONNECT="CONNECT",r.STATUS="STATUS"})(n.Type||(n.Type={}));let e;(function(r){r[r.CONNECT=0]="CONNECT",r[r.STATUS=1]="STATUS"})(e||(e={})),function(r){r.codec=()=>Ds(e)}(n.Type||(n.Type={}));let t;n.codec=()=>(t==null&&(t=Qe((r,s,i={})=>{i.lengthDelimited!==!1&&s.fork(),r.type!=null&&(s.uint32(8),n.Type.codec().encode(r.type,s)),r.peer!=null&&(s.uint32(18),nl.codec().encode(r.peer,s)),r.limit!=null&&(s.uint32(26),rl.codec().encode(r.limit,s)),r.status!=null&&(s.uint32(32),fn.codec().encode(r.status,s)),i.lengthDelimited!==!1&&s.ldelim()},(r,s,i={})=>{const a={},c=s==null?r.len:r.pos+s;for(;r.pos<c;){const u=r.uint32();switch(u>>>3){case 1:{a.type=n.Type.codec().decode(r);break}case 2:{a.peer=nl.codec().decode(r,r.uint32(),{limits:i.limits?.peer});break}case 3:{a.limit=rl.codec().decode(r,r.uint32(),{limits:i.limits?.limit});break}case 4:{a.status=fn.codec().decode(r);break}default:{r.skipType(u&7);break}}}return a})),t),n.encode=r=>Ge(r,n.codec()),n.decode=(r,s)=>We(r,n.codec(),s)})(ds||(ds={}));var nl;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.addrs!=null)for(const i of t.addrs)r.uint32(18),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={id:Fe(0),addrs:[]},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new qr('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(nl||(nl={}));var Of;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.expire!=null&&t.expire!==0n&&(r.uint32(8),r.uint64(t.expire)),t.addrs!=null)for(const i of t.addrs)r.uint32(18),r.bytes(i);t.voucher!=null&&(r.uint32(26),Ff.codec().encode(t.voucher,r)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={expire:0n,addrs:[]},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.expire=t.uint64();break}case 2:{if(s.limits?.addrs!=null&&i.addrs.length===s.limits.addrs)throw new qr('Decode error - map field "addrs" had too many elements');i.addrs.push(t.bytes());break}case 3:{i.voucher=Ff.codec().decode(t,t.uint32(),{limits:s.limits?.voucher});break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Of||(Of={}));var rl;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.duration!=null&&(r.uint32(8),r.uint32(t.duration)),t.data!=null&&(r.uint32(16),r.uint64(t.data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.duration=t.uint32();break}case 2:{i.data=t.uint64();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(rl||(rl={}));var fn;(function(n){n.UNUSED="UNUSED",n.OK="OK",n.RESERVATION_REFUSED="RESERVATION_REFUSED",n.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",n.PERMISSION_DENIED="PERMISSION_DENIED",n.CONNECTION_FAILED="CONNECTION_FAILED",n.NO_RESERVATION="NO_RESERVATION",n.MALFORMED_MESSAGE="MALFORMED_MESSAGE",n.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"})(fn||(fn={}));var Gg;(function(n){n[n.UNUSED=0]="UNUSED",n[n.OK=100]="OK",n[n.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",n[n.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",n[n.PERMISSION_DENIED=202]="PERMISSION_DENIED",n[n.CONNECTION_FAILED=203]="CONNECTION_FAILED",n[n.NO_RESERVATION=204]="NO_RESERVATION",n[n.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",n[n.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"})(Gg||(Gg={}));(function(n){n.codec=()=>Ds(Gg)})(fn||(fn={}));var Bf;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.relay!=null&&t.relay.byteLength>0&&(r.uint32(10),r.bytes(t.relay)),t.peer!=null&&t.peer.byteLength>0&&(r.uint32(18),r.bytes(t.peer)),t.expiration!=null&&t.expiration!==0n&&(r.uint32(24),r.uint64(t.expiration)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={relay:Fe(0),peer:Fe(0),expiration:0n},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.relay=t.bytes();break}case 2:{i.peer=t.bytes();break}case 3:{i.expiration=t.uint64();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Bf||(Bf={}));var Ff;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.publicKey!=null&&t.publicKey.byteLength>0&&(r.uint32(10),r.bytes(t.publicKey)),t.payloadType!=null&&t.payloadType.byteLength>0&&(r.uint32(18),r.bytes(t.payloadType)),t.payload!=null&&(r.uint32(26),Bf.codec().encode(t.payload,r)),t.signature!=null&&t.signature.byteLength>0&&(r.uint32(42),r.bytes(t.signature)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={publicKey:Fe(0),payloadType:Fe(0),signature:Fe(0)},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.publicKey=t.bytes();break}case 2:{i.payloadType=t.bytes();break}case 3:{i.payload=Bf.codec().decode(t,t.uint32(),{limits:s.limits?.payload});break}case 5:{i.signature=t.bytes();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Ff||(Ff={}));class m9 extends Error{static name="HadEnoughRelaysError";name="HadEnoughRelaysError"}class Nz extends Error{static name="DoubleRelayError";name="DoubleRelayError"}class Mz extends Error{static name="RelayQueueFullError";name="RelayQueueFullError"}function y9(n){const e=n*BigInt(1e3),t=new Date().getTime();return Number(e-BigInt(t))}class w9{expires;bytes;constructor(e){e?.duration!=null&&e?.duration!==0&&(this.expires=Date.now()+e.duration*1e3),this.bytes=e?.data,this.bytes===0n&&(this.bytes=void 0),this.onData=this.onData.bind(this)}onData(e){this.bytes!=null&&(this.bytes-=BigInt(e.byteLength),this.bytes<0n&&(this.bytes=0n))}getLimits(){if(this.expires==null&&this.bytes==null)return;const e={};if(this.bytes!=null){const t=this;Object.defineProperty(e,"bytes",{get(){return t.bytes}})}if(this.expires!=null){const t=this;Object.defineProperty(e,"seconds",{get(){return Math.round(((t.expires??0)-Date.now())/1e3)}})}return e}}const ZE=Je($e(tS.matchers[0],et(No))),eC=Je(et(No));function Rz(n){return n[Symbol.asyncIterator]!=null}function v9(n){return n?.then!=null}function tC(n,e){let t=0;if(Rz(n))return async function*(){for await(const u of n){const h=e(u,t++);v9(h)&&await h,yield u}}();const r=y3(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();if(typeof e(s,t++)?.then=="function")return async function*(){yield s;for(const u of r){const h=e(u,t++);v9(h)&&await h,yield u}}();const c=e;return function*(){yield s;for(const u of r)c(u,t++),yield u}()}function b9(n){const{stream:e,remoteAddr:t,logger:r,onDataRead:s,onDataWrite:i}=n,a=r.forComponent("libp2p:stream:converter");let c=!1,u=!1;const h=e.close.bind(e);e.close=async x=>{await h(x),w(!0)};const f=e.abort.bind(e);e.abort=x=>{f(x),w(!0)};const p=e.sink.bind(e);e.sink=async x=>{try{await p(I1(x,S=>tC(S,E=>i?.(E))))}catch(S){S.type!=="aborted"&&a.error("%s error in sink",t,S)}finally{u=!0,w()}};const m={log:a,sink:e.sink,source:async function*(){try{for await(const x of e.source)s?.(x),yield x}finally{c=!0,w()}}(),remoteAddr:t,timeline:{open:Date.now(),close:void 0},close:e.close,abort:e.abort};function w(x){x===!0&&(c=!0,u=!0),c&&u&&m.timeline.close==null&&(m.timeline.close=Date.now())}return m}class Lz extends ln{components;started;running;topologyId;log;discoveryController;filter;queue;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.components=e,this.started=!1,this.running=!1,this.filter=t.filter,this.discoveryController=new AbortController,this.discoveryController.signal,this.dialPeer=this.dialPeer.bind(this),this.onPeer=this.onPeer.bind(this)}isStarted(){return this.started}async start(){this.topologyId=await this.components.registrar.register(Lf,{filter:this.filter,onConnect:e=>{this.log.trace("discovered relay %p queue (length: %d, active %d)",e,this.queue?.size,this.queue?.running),this.safeDispatchEvent("relay:discover",{detail:e})}}),this.started=!0}stop(){this.topologyId!=null&&this.components.registrar.unregister(this.topologyId),this.running&&this.stopDiscovery(),this.started=!1}startDiscovery(){this.running||(this.log("start discovery"),this.running=!0,this.discoveryController=new AbortController,this.discoveryController.signal,this.components.events.addEventListener("peer:discovery",this.onPeer),Promise.resolve().then(async()=>{this.log("searching peer store for relays");const e=await this.components.peerStore.all({filters:[r=>r.protocols.includes(Lf)],orders:[()=>Math.random()<.5?1:-1,(r,s)=>{const i=x9(r),a=x9(s);return i>a?-1:a>i?1:0}]});for(const r of e)this.log.trace("found relay peer %p in peer store",r.id),this.safeDispatchEvent("relay:discover",{detail:r.id});this.log("found %d relay peers in peer store",e.length);const t=this.queue=new du({concurrency:5});this.log("start random walk");for await(const r of this.components.randomWalk.walk({signal:this.discoveryController.signal})){if(this.log.trace("found random peer %p",r.id),t.has(r.id)){this.log.trace("random peer %p was already in queue",r.id);continue}if(this.components.connectionManager.getConnections(r.id)?.length>0){this.log.trace("random peer %p was already connected",r.id);continue}if(!await this.components.connectionManager.isDialable(r.multiaddrs)){this.log.trace("random peer %p was not dialable",r.id,r.multiaddrs.map(s=>s.toString()));continue}t.queued>10&&(this.log.trace("wait for space in queue for %p",r.id),await t.onSizeLessThan(10,{signal:this.discoveryController.signal})),this.log("adding random peer %p to dial queue (length: %d, active %d)",r.id,t.size,t.running),t.add(this.dialPeer,{peerId:r.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to random peer %p",r.id,s)})}this.log("stop random walk"),await t.onIdle()}).catch(e=>{this.discoveryController.signal.aborted||this.log.error("failed when finding relays on the network",e)}))}stopDiscovery(){this.log("stop discovery"),this.running=!1,this.discoveryController?.abort(),this.queue?.clear(),this.components.events.removeEventListener("peer:discovery",this.onPeer)}onPeer(e){this.log.trace("maybe dialing discovered peer %p - %e",e.detail.id),this.maybeDialPeer(e).catch(t=>{this.log.trace("error dialing discovered peer %p - %e",e.detail.id,t)})}async maybeDialPeer(e){if(this.queue==null)return;const t=e.detail.id,r=e.detail.multiaddrs;if(this.queue.has(t)){this.log.trace("random peer %p was already in queue",t);return}if(this.components.connectionManager.getConnections(t)?.length>0){this.log.trace("random peer %p was already connected",t);return}if(!await this.components.connectionManager.isDialable(r)){this.log.trace("random peer %p was not dialable",t);return}this.queue?.add(this.dialPeer,{peerId:e.detail.id,signal:this.discoveryController.signal}).catch(s=>{this.log.error("error opening connection to discovered peer %p",e.detail.id,s)})}async dialPeer({peerId:e,signal:t}){const r=An([AbortSignal.timeout(5e3),t]);try{await this.components.connectionManager.openConnection(e,{signal:r})}finally{r.clear()}}}function x9(n){const e=n.metadata.get("last-dial-success");return e==null?0:new Date(pe(e)).getTime()}class Oz extends ln{connectionManager;addressManager;reservationStore;listeningAddrs;log;listenTimeout;reservationId;relay;constructor(e,t={}){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.addressManager=e.addressManager,this.reservationStore=e.reservationStore,this.listeningAddrs=[],this.listenTimeout=t.listenTimeout??JE,this.reservationStore.addEventListener("relay:removed",this._onRemoveRelayPeer),this.reservationStore.addEventListener("relay:created-reservation",this._onAddRelayPeer)}_onRemoveRelayPeer=e=>{this.log("relay removed %p our relay %p",e.detail.relay,this.relay,this.relay?.equals(e.detail.relay)),this.relay?.equals(e.detail.relay)===!0&&(this.log("relay peer removed %p",e.detail.relay),this.listeningAddrs.forEach(t=>{this.addressManager.removeObservedAddr(t)}),this.listeningAddrs=[],this.safeDispatchEvent("listening"))};_onAddRelayPeer=e=>{const{details:t}=e.detail;t.type!=="configured"&&t.id===this.reservationId&&this.addedRelay(e.detail)};async listen(e){if(eC.exactMatch(e))this.log("searching for circuit relay servers"),this.reservationId=this.reservationStore.reserveRelay();else if(ZE.exactMatch(e)){this.log("listen on specific relay server %a",e);const t=AbortSignal.timeout(this.listenTimeout),r=e.decapsulate("/p2p-circuit"),s=await this.connectionManager.openConnection(r,{signal:t});if(!this.reservationStore.hasReservation(s.remotePeer)){this.log("making reservation on peer %p",s.remotePeer);const i=await this.reservationStore.addRelay(s.remotePeer,"configured");this.addedRelay(i)}}else throw new Sg(`Could not listen on p2p-circuit address "${e}"`)}getAddrs(){return[...this.listeningAddrs.values()].flat()}updateAnnounceAddrs(){}async close(){this.reservationStore.cancelReservations(),this.listeningAddrs=[],this.reservationStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),queueMicrotask(()=>{this.safeDispatchEvent("close")})}addedRelay(e){this.log("relay peer added %p",e.relay),this.relay=e.relay,this.listeningAddrs=e.details.reservation.addrs.map(t=>Pe(t).encapsulate("/p2p-circuit")),this.listeningAddrs.forEach(t=>{this.addressManager.confirmObservedAddr(t,{type:"transport"})}),queueMicrotask(()=>{this.safeDispatchEvent("listening")})}}function Bz(n){return new Oz(n)}const Fz="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let Uz=(n=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(n|=0));for(;n--;)e+=Fz[t[n]&63];return e};const Vz=60*1e3*10,jz=60*1e3*5,$z=30*1e3;class zz extends ln{peerId;connectionManager;peerStore;events;reserveQueue;reservations;pendingReservations;maxReservationQueueLength;reservationCompletionTimeout;started;log;relayFilter;constructor(e,t){super(),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Mo,this.pendingReservations=[],this.maxReservationQueueLength=t?.maxReservationQueueLength??_z,this.reservationCompletionTimeout=t?.reservationCompletionTimeout??JE,this.started=!1,this.relayFilter=Xa(100),this.reserveQueue=new du({concurrency:t?.reservationConcurrency??Tz,metricName:"libp2p_relay_reservation_queue",metrics:e.metrics}),this.events.addEventListener("connection:close",r=>{[...this.reservations.values()].find(i=>i.connection===r.detail.id)!=null&&this.#n(r.detail.remotePeer).catch(i=>{this.log("could not remove relay %p - %e",r.detail,i)})})}isStarted(){return this.started}start(){this.started=!0}afterStart(){Promise.resolve().then(async()=>{const e=await this.peerStore.all({filters:[t=>t.tags.has(Mh)]});this.log("removing tag from %d old relays",e.length),await Promise.all(e.map(async t=>{await this.peerStore.merge(t.id,{tags:{[Mh]:void 0}})})),this.log("redialing %d old relays",e.length),await Promise.all(e.map(async t=>this.addRelay(t.id,"discovered"))),this.#t()}).catch(e=>{this.log.error(e)})}stop(){this.reserveQueue.clear(),this.reservations.forEach(({timeout:e})=>{clearTimeout(e)}),this.reservations.clear(),this.started=!1}reserveRelay(){const e=Uz();return this.pendingReservations.push(e),this.#t(),e}async addRelay(e,t){if(this.peerId.equals(e))throw this.log.trace("not trying to use self as relay"),new Sg("Cannot use self as relay");if(this.reserveQueue.size>this.maxReservationQueueLength)throw new Mz("The reservation queue is full");const r=this.reserveQueue.find(e);if(r!=null)return this.log.trace("potential relay peer %p is already in the reservation queue",e),r.join();if(this.relayFilter.has(e.toMultihash().bytes))throw new Sg("The relay was previously invalid");return this.log.trace("try to reserve relay slot with %p",e),this.reserveQueue.add(async()=>{const s=Date.now();try{const i=this.reservations.get(e);if(i!=null){const x=this.connectionManager.getConnections(e);let S=!1;if(x.length===0&&this.log("already have relay reservation with %p but we are no longer connected",e),x.map(E=>E.id).includes(i.connection)&&(this.log("already have relay reservation with %p and the original connection is still open",e),S=!0),S&&y9(i.reservation.expire)>Vz)return this.log("already have relay reservation with %p but we are still connected and it does not expire soon",e),{relay:e,details:i};await this.#n(e)}if(t==="discovered"&&this.pendingReservations.length===0)throw new m9("Not making reservation on discovered relay because we do not need any more relays");const a=AbortSignal.timeout(this.reservationCompletionTimeout);const c=await this.connectionManager.openConnection(e,{signal:a});if(cu.matches(c.remoteAddr))throw new Nz("not creating reservation over relayed connection");const u=await this.#e(c,{signal:a}),h=y9(u.expire);this.log("created reservation on relay peer %p, expiry date is %s",e,new Date(Date.now()+h).toString());const f=Math.min(Math.max(h-jz,$z),Math.pow(2,31)-1),p=setTimeout(()=>{this.log("refresh reservation to relay %p",e),this.addRelay(e,t).catch(async x=>{this.log.error("could not refresh reservation to relay %p - %e",e,x),await this.#n(e)}).catch(x=>{this.log.error("could not remove expired reservation to relay %p - %e",e,x)})},f);let m;if(t==="discovered"){const x=this.pendingReservations.pop();if(x==null)throw new m9("Made reservation on relay but did not need any more discovered relays");m={timeout:p,reservation:u,type:t,connection:c.id,id:x}}else m={timeout:p,reservation:u,type:t,connection:c.id};this.reservations.set(e,m),await this.peerStore.merge(e,{tags:{[Mh]:{value:1,ttl:h}}}),this.#t();const w={relay:e,details:m};return this.safeDispatchEvent("relay:created-reservation",{detail:w}),w}catch(i){throw t==="discovered"&&i.name==="HadEnoughRelaysError"||this.log.error("could not reserve slot on %p after %dms - %e",e,Date.now()-s,i),(i.name==="DialError"||i.name==="UnsupportedProtocolError")&&this.relayFilter.add(e.toMultihash().bytes),this.#n(e).catch(a=>{this.log.error("could not remove reservation on %p after reserving slot failed - %e",e,a)}),i}},{peerId:e})}hasReservation(e){return this.reservations.has(e)}getReservation(e){return this.reservations.get(e)?.reservation}reservationCount(e){return e==null?this.reservations.size:[...this.reservations.values()].reduce((t,r)=>(r.type===e&&t++,t),0)}cancelReservations(){[...this.reservations.values()].forEach(e=>{clearTimeout(e.timeout)}),this.reservations.clear()}async#e(e,t){t.signal?.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const r=await e.newStream(Lf,t),i=Wr(r).pb(tl);this.log.trace("send RESERVE to %p",e.remotePeer),await i.write({type:tl.Type.RESERVE},t);let a;try{this.log.trace("reading response from %p",e.remotePeer),a=await i.read(t)}catch(u){throw r.abort(u),u}finally{r.status!=="closed"&&await r.close(t)}if(this.log.trace("read response %o",a),a.status===fn.OK&&a.reservation!=null){const u=new Set;u.add(e.remoteAddr.toString());for(const h of a.reservation.addrs){let f=Pe(h);f.getPeerId()==null&&(f=f.encapsulate(`/p2p/${e.remotePeer}`)),f=Pe(f.toString().replace(`/p2p/${e.remotePeer}/p2p/${e.remotePeer}`,`/p2p/${e.remotePeer}`)),u.add(f.toString())}return a.reservation.addrs=[...u].map(h=>Pe(h).bytes),a.reservation}const c=`reservation failed with status ${a.status??"undefined"}`;throw this.log.error(c),new Error(c)}async#n(e){const t=this.reservations.get(e);t!=null&&(this.log("removing relay reservation with %p from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),t.type==="discovered"&&this.pendingReservations.push(t.id),await this.peerStore.merge(e,{tags:{[Mh]:void 0}}),this.safeDispatchEvent("relay:removed",{detail:{relay:e,details:t}}),this.#t())}#t(){if(this.pendingReservations.length===0){this.log.trace("have discovered enough relays"),this.reserveQueue.clear(),this.safeDispatchEvent("relay:found-enough-relays");return}this.relayFilter=Xa(100),this.log("not discovered enough relays %d/%d",this.reservations.size,this.pendingReservations.length),this.safeDispatchEvent("relay:not-enough-relays")}}const Hz=n=>{if(n.peer==null)return!1;try{n.peer.addrs.forEach(Pe)}catch{return!1}return!0},S9={maxInboundStopStreams:g9,maxOutboundStopStreams:g9};class Kz{discovery;registrar;peerStore;connectionManager;transportManager;peerId;upgrader;addressManager;connectionGater;reservationStore;logger;maxInboundStopStreams;maxOutboundStopStreams;started;log;shutdownController;constructor(e,t={}){this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=t.maxInboundStopStreams??S9.maxInboundStopStreams,this.maxOutboundStopStreams=t.maxOutboundStopStreams??S9.maxOutboundStopStreams,this.shutdownController=new AbortController,this.discovery=new Lz(e,{filter:t.discoveryFilter??BF(Dz,Iz)}),this.discovery.addEventListener("relay:discover",r=>{this.reservationStore.addRelay(r.detail,"discovered").catch(s=>{s.name!=="HadEnoughRelaysError"&&s.name!=="RelayQueueFullError"&&this.log.error("could not add discovered relay %p",r.detail,s)})}),this.reservationStore=new zz(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",()=>{this.discovery?.startDiscovery()}),this.reservationStore.addEventListener("relay:found-enough-relays",()=>{this.discovery?.stopDiscovery()}),this.started=!1}[Symbol.toStringTag]="@libp2p/circuit-relay-v2-transport";[br]=["@libp2p/transport","@libp2p/circuit-relay-v2-transport"];get[Zc](){return this.discovery!=null?["@libp2p/identify"]:[]}[$m]=!0;isStarted(){return this.started}async start(){this.shutdownController=new AbortController,this.shutdownController.signal,await this.registrar.handle(p9,e=>{const t=this.upgrader.createInboundAbortSignal(this.shutdownController.signal);this.onStop(e,t).catch(r=>{this.log.error("error while handling STOP protocol",r),e.stream.abort(r)}).finally(()=>{t.clear()})},{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnLimitedConnection:!0}),await Jc(this.discovery,this.reservationStore),this.started=!0}async stop(){this.shutdownController.abort(),await f1(this.discovery,this.reservationStore),await this.registrar.unhandle(p9),this.started=!1}async dial(e,t){if(e.protoCodes().filter(w=>w===Pz).length!==1){const w="Invalid circuit relay address";throw this.log.error(w,e),new Fc(w)}const r=e.toString().split("/p2p-circuit"),s=Pe(r[0]),i=Pe(r[r.length-1]),a=s.getPeerId(),c=i.getPeerId();if(a==null||c==null){const w=`ircuit relay dial to ${e.toString()} failed as address did not have both relay and destination PeerIDs`;throw this.log.error(`c${w}`),new Fc(`C${w}`)}const u=sr(a),h=sr(c);let p=this.connectionManager.getConnections(u)[0];p==null?(await this.peerStore.merge(u,{multiaddrs:[s]}),t.onProgress?.(new qe("circuit-relay:open-connection")),p=await this.connectionManager.openConnection(u,t)):t.onProgress?.(new qe("circuit-relay:reuse-connection"));let m;try{t.onProgress?.(new qe("circuit-relay:open-hop-stream")),m=await p.newStream(Lf,t);const w=Wr(m),x=w.pb(tl);t.onProgress?.(new qe("circuit-relay:write-connect-message")),await x.write({type:tl.Type.CONNECT,peer:{id:h.toMultihash().bytes,addrs:[Pe(i).bytes]}},t),t.onProgress?.(new qe("circuit-relay:read-connect-response"));const S=await x.read(t);if(S.status!==fn.OK)throw new Kt(`failed to connect via relay with status ${S?.status?.toString()??"undefined"}`);const E=new w9(S.limit),A=b9({stream:w.unwrap(),remoteAddr:e,localAddr:s.encapsulate(`/p2p-circuit/p2p/${this.peerId.toString()}`),logger:this.logger,onDataRead:E.onData,onDataWrite:E.onData});return this.log("new outbound relayed connection %a",A.remoteAddr),await this.upgrader.upgradeOutbound(A,{...t,limits:E.getLimits()})}catch(w){throw this.log.error("circuit relay dial to destination %p via relay %p failed",h,u,w),m?.abort(w),w}}createListener(e){return Bz({peerId:this.peerId,connectionManager:this.connectionManager,addressManager:this.addressManager,reservationStore:this.reservationStore,logger:this.logger})}listenFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>ZE.exactMatch(t)||eC.exactMatch(t))}dialFilter(e){return e=Array.isArray(e)?e:[e],e.filter(t=>cu.exactMatch(t))}async onStop({connection:e,stream:t},r){if(!this.reservationStore.hasReservation(e.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([e.remoteAddr.encapsulate("/p2p-circuit")])}catch(f){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",f)}const s=Wr(t).pb(ds),i=await s.read({signal:r});if(this.log("new circuit relay v2 stop stream from %p with type %s",e.remotePeer,i.type),i?.type===void 0){this.log.error("type was missing from circuit v2 stop protocol request from %s",e.remotePeer),await s.write({type:ds.Type.STATUS,status:fn.MALFORMED_MESSAGE},{signal:r}),await t.close();return}if(i.type!==ds.Type.CONNECT){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:ds.Type.STATUS,status:fn.UNEXPECTED_MESSAGE},{signal:r}),await t.close();return}if(!Hz(i)){this.log.error("invalid stop connect request via peer %p",e.remotePeer),await s.write({type:ds.Type.STATUS,status:fn.MALFORMED_MESSAGE},{signal:r}),await t.close({signal:r});return}const a=Xr(jn(i.peer.id));if(await this.connectionGater.denyInboundRelayedConnection?.(e.remotePeer,a)===!0){this.log.error("connection gater denied inbound relayed connection from %p",e.remotePeer),await s.write({type:ds.Type.STATUS,status:fn.PERMISSION_DENIED},{signal:r}),await t.close({signal:r});return}this.log.trace("sending success response to %p",e.remotePeer),await s.write({type:ds.Type.STATUS,status:fn.OK},{signal:r});const c=new w9(i.limit),u=e.remoteAddr.encapsulate(`/p2p-circuit/p2p/${a.toString()}`);this.addressManager.getAddresses()[0];const h=b9({stream:s.unwrap().unwrap(),remoteAddr:u,logger:this.logger,onDataRead:c.onData,onDataWrite:c.onData});this.log("new inbound relayed connection %a",h.remoteAddr),await this.upgrader.upgradeInbound(h,{limits:c.getLimits(),signal:r}),this.log("%s connection %a upgraded","inbound",h.remoteAddr)}}function qz(n={}){return e=>new Kz(e,n)}const B3=Symbol.for("@libp2p/peer-id");function Wz(n){return n!=null&&!!n[B3]}let it=class extends Error{code;props;constructor(e,t,r){super(e),this.code=t,this.name=r?.name??"CodeError",this.props=r??{}}};const Gz=Symbol.for("@libp2p/service-capabilities");function Di(n){return n==null?!1:typeof n.then=="function"&&typeof n.catch=="function"&&typeof n.finally=="function"}const mu=32,ai=64,Uf=32;function Qz(){const n=ks.utils.randomPrivateKey(),e=ks.getPublicKey(n);return{privateKey:nC(n,e),publicKey:e}}function Yz(n){if(n.length!==Uf)throw new TypeError('"seed" must be 32 bytes in length.');if(!(n instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const e=n,t=ks.getPublicKey(e);return{privateKey:nC(e,t),publicKey:t}}function Xz(n,e){const t=n.subarray(0,Uf);return ks.sign(e instanceof Uint8Array?e:e.subarray(),t)}function Jz(n,e,t){return ks.verify(e,t instanceof Uint8Array?t:t.subarray(),n)}function nC(n,e){const t=new Uint8Array(ai);for(let r=0;r<Uf;r++)t[r]=n[r],t[Uf+r]=e[r];return t}const Er={get(n=globalThis){const e=n.crypto;if(e?.subtle==null)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},K2={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};function Zz(n){const e="AES-GCM";let t=16;const r=12,s="SHA-256",i=16,a=32767,c=Er.get();t*=8;async function u(p,m){const w=c.getRandomValues(new Uint8Array(i)),x=c.getRandomValues(new Uint8Array(r)),S={name:e,iv:x};typeof m=="string"&&(m=we(m));let E;if(m.length===0){E=await c.subtle.importKey("jwk",K2,{name:"AES-GCM"},!0,["encrypt"]);try{const P={name:"PBKDF2",salt:w,iterations:a,hash:{name:s}},k=await c.subtle.importKey("raw",m,{name:"PBKDF2"},!1,["deriveKey"]);E=await c.subtle.deriveKey(P,k,{name:e,length:t},!0,["encrypt"])}catch{E=await c.subtle.importKey("jwk",K2,{name:"AES-GCM"},!0,["encrypt"])}}else{const P={name:"PBKDF2",salt:w,iterations:a,hash:{name:s}},k=await c.subtle.importKey("raw",m,{name:"PBKDF2"},!1,["deriveKey"]);E=await c.subtle.deriveKey(P,k,{name:e,length:t},!0,["encrypt"])}const A=await c.subtle.encrypt(S,E,p);return Cs([w,S.iv,new Uint8Array(A)])}async function h(p,m){const w=p.subarray(0,i),x=p.subarray(i,i+r),S=p.subarray(i+r),E={name:e,iv:x};typeof m=="string"&&(m=we(m));let A;if(m.length===0)try{const k={name:"PBKDF2",salt:w,iterations:a,hash:{name:s}},F=await c.subtle.importKey("raw",m,{name:"PBKDF2"},!1,["deriveKey"]);A=await c.subtle.deriveKey(k,F,{name:e,length:t},!0,["decrypt"])}catch{A=await c.subtle.importKey("jwk",K2,{name:"AES-GCM"},!0,["decrypt"])}else{const k={name:"PBKDF2",salt:w,iterations:a,hash:{name:s}},F=await c.subtle.importKey("raw",m,{name:"PBKDF2"},!1,["deriveKey"]);A=await c.subtle.deriveKey(k,F,{name:e,length:t},!0,["decrypt"])}const P=await c.subtle.decrypt(E,A,S);return new Uint8Array(P)}return{encrypt:u,decrypt:h}}async function F3(n,e){const r=await Zz().encrypt(n,e);return Gm.encode(r)}var kt;(function(n){n.RSA="RSA",n.Ed25519="Ed25519",n.Secp256k1="Secp256k1"})(kt||(kt={}));var Qg;(function(n){n[n.RSA=0]="RSA",n[n.Ed25519=1]="Ed25519",n[n.Secp256k1=2]="Secp256k1"})(Qg||(Qg={}));(function(n){n.codec=()=>Ds(Qg)})(kt||(kt={}));var sl;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),kt.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const s={},i=r==null?t.len:t.pos+r;for(;t.pos<i;){const a=t.uint32();switch(a>>>3){case 1:s.Type=kt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(a&7);break}}return s})),e),n.encode=t=>Ge(t,n.codec()),n.decode=t=>We(t,n.codec())})(sl||(sl={}));var il;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.Type!=null&&(r.uint32(8),kt.codec().encode(t.Type,r)),t.Data!=null&&(r.uint32(18),r.bytes(t.Data)),s.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const s={},i=r==null?t.len:t.pos+r;for(;t.pos<i;){const a=t.uint32();switch(a>>>3){case 1:s.Type=kt.codec().decode(t);break;case 2:s.Data=t.bytes();break;default:t.skipType(a&7);break}}return s})),e),n.encode=t=>Ge(t,n.codec()),n.decode=t=>We(t,n.codec())})(il||(il={}));class U3{_key;constructor(e){this._key=ol(e,mu)}verify(e,t){return Jz(this._key,t,e)}marshal(){return this._key}get bytes(){return sl.encode({Type:kt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return Ve(this.bytes,e.bytes)}hash(){const e=mn.digest(this.bytes);return Di(e)?e.then(({bytes:t})=>t):e.bytes}}class yu{_key;_publicKey;constructor(e,t){this._key=ol(e,ai),this._publicKey=ol(t,mu)}sign(e){return Xz(this._key,e)}get public(){return new U3(this._publicKey)}marshal(){return this._key}get bytes(){return il.encode({Type:kt.Ed25519,Data:this.marshal()}).subarray()}equals(e){return Ve(this.bytes,e.bytes)}async hash(){const e=mn.digest(this.bytes);let t;return Di(e)?{bytes:t}=await e:t=e.bytes,t}async id(){const e=xr.digest(this.public.bytes);return bt.encode(e.bytes).substring(1)}async export(e,t="libp2p-key"){if(t==="libp2p-key")return F3(this.bytes,e);throw new it(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function eH(n){if(n.length>ai){n=ol(n,ai+mu);const r=n.subarray(0,ai),s=n.subarray(ai,n.length);return new yu(r,s)}n=ol(n,ai);const e=n.subarray(0,ai),t=n.subarray(mu);return new yu(e,t)}function tH(n){return n=ol(n,mu),new U3(n)}async function nH(){const{privateKey:n,publicKey:e}=Qz();return new yu(n,e)}async function rH(n){const{privateKey:e,publicKey:t}=Yz(n);return new yu(e,t)}function ol(n,e){if(n=Uint8Array.from(n??[]),n.length!==e)throw new it(`Key must be a Uint8Array of length ${e}, got ${n.length}`,"ERR_INVALID_KEY_TYPE");return n}const sH=Object.freeze(Object.defineProperty({__proto__:null,Ed25519PrivateKey:yu,Ed25519PublicKey:U3,generateKeyPair:nH,generateKeyPairFromSeed:rH,unmarshalEd25519PrivateKey:eH,unmarshalEd25519PublicKey:tH},Symbol.toStringTag,{value:"Module"}));function Yg(n){if(isNaN(n)||n<=0)throw new it("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Po(n)}function iH(n){const{result:e}=US(n),t=e.valueBlock.value;return{n:pe(Rr(t[1].toBigInt()),"base64url"),e:pe(Rr(t[2].toBigInt()),"base64url"),d:pe(Rr(t[3].toBigInt()),"base64url"),p:pe(Rr(t[4].toBigInt()),"base64url"),q:pe(Rr(t[5].toBigInt()),"base64url"),dp:pe(Rr(t[6].toBigInt()),"base64url"),dq:pe(Rr(t[7].toBigInt()),"base64url"),qi:pe(Rr(t[8].toBigInt()),"base64url"),kty:"RSA",alg:"RS256"}}function oH(n){if(n.n==null||n.e==null||n.d==null||n.p==null||n.q==null||n.dp==null||n.dq==null||n.qi==null)throw new it("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new hn({value:[new Ht({value:0}),Ht.fromBigInt(Lr(we(n.n,"base64url"))),Ht.fromBigInt(Lr(we(n.e,"base64url"))),Ht.fromBigInt(Lr(we(n.d,"base64url"))),Ht.fromBigInt(Lr(we(n.p,"base64url"))),Ht.fromBigInt(Lr(we(n.q,"base64url"))),Ht.fromBigInt(Lr(we(n.dp,"base64url"))),Ht.fromBigInt(Lr(we(n.dq,"base64url"))),Ht.fromBigInt(Lr(we(n.qi,"base64url")))]}).toBER();return new Uint8Array(t,0,t.byteLength)}function aH(n){const{result:e}=US(n),t=e.valueBlock.value[1].valueBlock.value[0].valueBlock.value;return{kty:"RSA",n:pe(Rr(t[0].toBigInt()),"base64url"),e:pe(Rr(t[1].toBigInt()),"base64url")}}function lH(n){if(n.n==null||n.e==null)throw new it("JWK was missing components","ERR_INVALID_PARAMETERS");const t=new hn({value:[new hn({value:[new li({value:"1.2.840.113549.1.1.1"}),new gu]}),new M3({valueHex:new hn({value:[Ht.fromBigInt(Lr(we(n.n,"base64url"))),Ht.fromBigInt(Lr(we(n.e,"base64url")))]}).toBER()})]}).toBER();return new Uint8Array(t,0,t.byteLength)}function Rr(n){let e=n.toString(16);e.length%2>0&&(e=`0${e}`);const t=e.length/2,r=new Uint8Array(t);let s=0,i=0;for(;s<t;)r[s]=parseInt(e.slice(i,i+2),16),s+=1,i+=2;return r}function Lr(n){const e=[];return n.forEach(function(t){let r=t.toString(16);r.length%2>0&&(r=`0${r}`),e.push(r)}),BigInt("0x"+e.join(""))}const cH=16,E9=32,C9=1e4;async function uH(n,e){const t=Er.get(),s=new hn({value:[new Ht({value:0}),new hn({value:[new li({value:"1.2.840.113549.1.1.1"}),new gu]}),new Aa({valueHex:n.marshal()})]}).toBER(),i=new Uint8Array(s,0,s.byteLength),a=Yg(cH),c=await kF(AF,e,a,{c:C9,dkLen:E9}),u=Yg(16),h=await t.subtle.importKey("raw",c,"AES-CBC",!1,["encrypt"]),f=await t.subtle.encrypt({name:"AES-CBC",iv:u},h,i),p=new hn({value:[new Aa({valueHex:a}),new Ht({value:C9}),new Ht({value:E9}),new hn({value:[new li({value:"1.2.840.113549.2.11"}),new gu]})]}),m=new hn({value:[new li({value:"1.2.840.113549.1.5.13"}),new hn({value:[new hn({value:[new li({value:"1.2.840.113549.1.5.12"}),p]}),new hn({value:[new li({value:"2.16.840.1.101.3.4.1.42"}),new Aa({valueHex:u})]})]})]}),x=new hn({value:[m,new Aa({valueHex:f})]}).toBER(),S=new Uint8Array(x,0,x.byteLength);return["-----BEGIN ENCRYPTED PRIVATE KEY-----",...pe(S,"base64pad").split(/(.{64})/).filter(Boolean),"-----END ENCRYPTED PRIVATE KEY-----"].join(`
`)}async function dH(n){const e=await Er.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:n,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),t=await sC(e);return{privateKey:t[0],publicKey:t[1]}}async function rC(n){const t=[await Er.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await pH(n)],r=await sC({privateKey:t[0],publicKey:t[1]});return{privateKey:r[0],publicKey:r[1]}}async function hH(n,e){const t=await Er.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await Er.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},t,e instanceof Uint8Array?e:e.subarray());return new Uint8Array(r,0,r.byteLength)}async function fH(n,e,t){const r=await Er.get().subtle.importKey("jwk",n,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return Er.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,e,t instanceof Uint8Array?t:t.subarray())}async function sC(n){if(n.privateKey==null||n.publicKey==null)throw new it("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([Er.get().subtle.exportKey("jwk",n.privateKey),Er.get().subtle.exportKey("jwk",n.publicKey)])}async function pH(n){return Er.get().subtle.importKey("jwk",{kty:n.kty,n:n.n,e:n.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function V3(n){if(n.kty!=="RSA")throw new it("invalid key type","ERR_INVALID_KEY_TYPE");if(n.n==null)throw new it("invalid key modulus","ERR_INVALID_KEY_MODULUS");return we(n.n,"base64url").length*8}const Wu=8192;class j3{_key;constructor(e){this._key=e}verify(e,t){return fH(this._key,t,e)}marshal(){return lH(this._key)}get bytes(){return sl.encode({Type:kt.RSA,Data:this.marshal()}).subarray()}equals(e){return Ve(this.bytes,e.bytes)}hash(){const e=mn.digest(this.bytes);return Di(e)?e.then(({bytes:t})=>t):e.bytes}}class N1{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t}genSecret(){return Yg(16)}sign(e){return hH(this._key,e)}get public(){if(this._publicKey==null)throw new it("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new j3(this._publicKey)}marshal(){return oH(this._key)}get bytes(){return il.encode({Type:kt.RSA,Data:this.marshal()}).subarray()}equals(e){return Ve(this.bytes,e.bytes)}hash(){const e=mn.digest(this.bytes);return Di(e)?e.then(({bytes:t})=>t):e.bytes}async id(){const e=await this.public.hash();return pe(e,"base58btc")}async export(e,t="pkcs-8"){if(t==="pkcs-8")return uH(this,e);if(t==="libp2p-key")return F3(this.bytes,e);throw new it(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}async function gH(n){const e=iH(n);if(V3(e)>Wu)throw new it("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await rC(e);return new N1(t.privateKey,t.publicKey)}function mH(n){const e=aH(n);if(V3(e)>Wu)throw new it("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new j3(e)}async function yH(n){if(V3(n)>Wu)throw new it("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await rC(n);return new N1(e.privateKey,e.publicKey)}async function wH(n){if(n>Wu)throw new it("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const e=await dH(n);return new N1(e.privateKey,e.publicKey)}const vH=Object.freeze(Object.defineProperty({__proto__:null,MAX_RSA_KEY_SIZE:Wu,RsaPrivateKey:N1,RsaPublicKey:j3,fromJwk:yH,generateKeyPair:wH,unmarshalRsaPrivateKey:gH,unmarshalRsaPublicKey:mH},Symbol.toStringTag,{value:"Module"}));function bH(){return Vn.utils.randomPrivateKey()}function xH(n,e){const t=mn.digest(e instanceof Uint8Array?e:e.subarray());if(Di(t))return t.then(({digest:r})=>Vn.sign(r,n).toDERRawBytes()).catch(r=>{throw new it(String(r),"ERR_INVALID_INPUT")});try{return Vn.sign(t.digest,n).toDERRawBytes()}catch(r){throw new it(String(r),"ERR_INVALID_INPUT")}}function SH(n,e,t){const r=mn.digest(t instanceof Uint8Array?t:t.subarray());if(Di(r))return r.then(({digest:s})=>Vn.verify(e,s,n)).catch(s=>{throw new it(String(s),"ERR_INVALID_INPUT")});try{return Vn.verify(e,r.digest,n)}catch(s){throw new it(String(s),"ERR_INVALID_INPUT")}}function EH(n){return Vn.ProjectivePoint.fromHex(n).toRawBytes(!0)}function CH(n){try{Vn.getPublicKey(n,!0)}catch(e){throw new it(String(e),"ERR_INVALID_PRIVATE_KEY")}}function iC(n){try{Vn.ProjectivePoint.fromHex(n)}catch(e){throw new it(String(e),"ERR_INVALID_PUBLIC_KEY")}}function kH(n){try{return Vn.getPublicKey(n,!0)}catch(e){throw new it(String(e),"ERR_INVALID_PRIVATE_KEY")}}class $3{_key;constructor(e){iC(e),this._key=e}verify(e,t){return SH(this._key,t,e)}marshal(){return EH(this._key)}get bytes(){return sl.encode({Type:kt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return Ve(this.bytes,e.bytes)}async hash(){const e=mn.digest(this.bytes);let t;return Di(e)?{bytes:t}=await e:t=e.bytes,t}}class z3{_key;_publicKey;constructor(e,t){this._key=e,this._publicKey=t??kH(e),CH(this._key),iC(this._publicKey)}sign(e){return xH(this._key,e)}get public(){return new $3(this._publicKey)}marshal(){return this._key}get bytes(){return il.encode({Type:kt.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return Ve(this.bytes,e.bytes)}hash(){const e=mn.digest(this.bytes);return Di(e)?e.then(({bytes:t})=>t):e.bytes}async id(){const e=await this.public.hash();return pe(e,"base58btc")}async export(e,t="libp2p-key"){if(t==="libp2p-key")return F3(this.bytes,e);throw new it(`export format '${t}' is not supported`,"ERR_INVALID_EXPORT_FORMAT")}}function AH(n){return new z3(n)}function PH(n){return new $3(n)}async function TH(){const n=bH();return new z3(n)}const _H=Object.freeze(Object.defineProperty({__proto__:null,Secp256k1PrivateKey:z3,Secp256k1PublicKey:$3,generateKeyPair:TH,unmarshalSecp256k1PrivateKey:AH,unmarshalSecp256k1PublicKey:PH},Symbol.toStringTag,{value:"Module"})),lo={rsa:vH,ed25519:sH,secp256k1:_H};function oC(n){const e=Object.keys(lo).join(" / ");return new it(`invalid or unsupported key type ${n}. Must be ${e}`,"ERR_UNSUPPORTED_KEY_TYPE")}function DH(n){const e=sl.decode(n),t=e.Data??new Uint8Array;switch(e.Type){case kt.RSA:return lo.rsa.unmarshalRsaPublicKey(t);case kt.Ed25519:return lo.ed25519.unmarshalEd25519PublicKey(t);case kt.Secp256k1:return lo.secp256k1.unmarshalSecp256k1PublicKey(t);default:throw oC(e.Type??"unknown")}}async function k9(n){const e=il.decode(n),t=e.Data??new Uint8Array;switch(e.Type){case kt.RSA:return lo.rsa.unmarshalRsaPrivateKey(t);case kt.Ed25519:return lo.ed25519.unmarshalEd25519PrivateKey(t);case kt.Secp256k1:return lo.secp256k1.unmarshalSecp256k1PrivateKey(t);default:throw oC(e.Type??"RSA")}}const aC=Symbol.for("nodejs.util.inspect.custom"),IH=Object.values(eu).map(n=>n.decoder).reduce((n,e)=>n.or(e),eu.identity.decoder),lC=114,H3=36,K3=37;class q3{type;multihash;privateKey;publicKey;string;constructor(e){this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[Symbol.toStringTag](){return`PeerId(${this.toString()})`}[B3]=!0;toString(){return this.string==null&&(this.string=bt.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return Be.createV1(lC,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){if(e==null)return!1;if(e instanceof Uint8Array)return Ve(this.multihash.bytes,e);if(typeof e=="string")return MH(e).equals(this);if(e?.multihash?.bytes!=null)return Ve(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[aC](){return`PeerId(${this.toString()})`}}class M1 extends q3{type="RSA";publicKey;constructor(e){super({...e,type:"RSA"}),this.publicKey=e.publicKey}}class R1 extends q3{type="Ed25519";publicKey;constructor(e){super({...e,type:"Ed25519"}),this.publicKey=e.multihash.digest}}class L1 extends q3{type="secp256k1";publicKey;constructor(e){super({...e,type:"secp256k1"}),this.publicKey=e.multihash.digest}}const Xg=2336;class NH{type="url";multihash;privateKey;publicKey;url;constructor(e){this.url=e.toString(),this.multihash=xr.digest(we(this.url))}[aC](){return`PeerId(${this.url})`}[B3]=!0;toString(){return this.toCID().toString()}toCID(){return Be.createV1(Xg,this.multihash)}toBytes(){return this.toCID().bytes}equals(e){return e==null?!1:(e instanceof Uint8Array&&(e=pe(e)),e.toString()===this.toString())}}function MH(n,e){if(n.charAt(0)==="1"||n.charAt(0)==="Q"){const t=jn(bt.decode(`z${n}`));return n.startsWith("12D")?new R1({multihash:t}):n.startsWith("16U")?new L1({multihash:t}):new M1({multihash:t})}return RH(IH.decode(n))}function RH(n){try{const e=jn(n);if(e.code===xr.code){if(e.digest.length===H3)return new R1({multihash:e});if(e.digest.length===K3)return new L1({multihash:e})}if(e.code===mn.code)return new M1({multihash:e})}catch{return LH(Be.decode(n))}throw new Error("Supplied PeerID CID is invalid")}function LH(n){if(n?.multihash==null||n.version==null||n.version===1&&n.code!==lC&&n.code!==Xg)throw new Error("Supplied PeerID CID is invalid");if(n.code===Xg){const t=pe(n.multihash.digest);return new NH(new URL(t))}const e=n.multihash;if(e.code===mn.code)return new M1({multihash:n.multihash});if(e.code===xr.code){if(e.digest.length===H3)return new R1({multihash:n.multihash});if(e.digest.length===K3)return new L1({multihash:n.multihash})}throw new Error("Supplied PeerID CID is invalid")}async function A9(n,e){return n.length===H3?new R1({multihash:$a(xr.code,n),privateKey:e}):n.length===K3?new L1({multihash:$a(xr.code,n),privateKey:e}):new M1({multihash:await mn.digest(n),publicKey:n,privateKey:e})}function OH(n){return n[Symbol.asyncIterator]!=null}let BH=class extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"},FH=class extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"},UH=class extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"},P9=class extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"};const VH=8,jH=1024*1024*4;var Qi;(function(n){n[n.LENGTH=0]="LENGTH",n[n.DATA=1]="DATA"})(Qi||(Qi={}));const W3=n=>{const e=_o(n);return W3.bytes=Ft(e),e};W3.bytes=0;function Jg(n,e){const t=new Ie;let r=Qi.LENGTH,s=-1;const i=e?.lengthDecoder??W3,a=e?.maxLengthLength??VH,c=e?.maxDataLength??jH;function*u(){for(;t.byteLength>0;){if(r===Qi.LENGTH)try{if(s=i(t),s<0)throw new BH("Invalid message length");if(s>c)throw new FH("Message length too long");const h=i.bytes;t.consume(h),e?.onLength!=null&&e.onLength(s),r=Qi.DATA}catch(h){if(h instanceof RangeError){if(t.byteLength>a)throw new UH("Message length length too long");break}throw h}if(r===Qi.DATA){if(t.byteLength<s)break;const h=t.sublist(0,s);t.consume(s),e?.onData!=null&&e.onData(h),yield h,r=Qi.LENGTH}}}return OH(n)?async function*(){for await(const h of n)t.append(h),yield*u();if(t.byteLength>0)throw new P9("Unexpected end of input")}():function*(){for(const h of n)t.append(h),yield*u();if(t.byteLength>0)throw new P9("Unexpected end of input")}()}Jg.fromReader=(n,e)=>{let t=1;const r=async function*(){for(;;)try{const{done:i,value:a}=await n.next(t);if(i===!0)return;a!=null&&(yield a)}catch(i){if(i.code==="ERR_UNDER_READ")return{done:!0,value:null};throw i}finally{t=1}}();return Jg(r,{...e??{},onLength:i=>{t=i}})};class $H{readNext;haveNext;ended;nextResult;constructor(){this.ended=!1,this.readNext=Ke(),this.haveNext=Ke()}[Symbol.asyncIterator](){return this}async next(){if(this.nextResult==null&&await this.haveNext.promise,this.nextResult==null)throw new Error("HaveNext promise resolved but nextResult was undefined");const e=this.nextResult;return this.nextResult=void 0,this.readNext.resolve(),this.readNext=Ke(),e}async throw(e){return this.ended=!0,e!=null&&(this.haveNext.promise.catch(()=>{}),this.haveNext.reject(e)),{done:!0,value:void 0}}async return(){const e={done:!0,value:void 0};return this.ended=!0,this.nextResult=e,this.haveNext.resolve(),e}async push(e,t){await this._push(e,t)}async end(e,t){e!=null?await this.throw(e):await this._push(void 0,t)}async _push(e,t){if(e!=null&&this.ended)throw new Error("Cannot push value onto an ended pushable");for(;this.nextResult!=null;)await this.readNext.promise;e!=null?this.nextResult={done:!1,value:e}:(this.ended=!0,this.nextResult={done:!0,value:void 0}),this.haveNext.resolve(),this.haveNext=Ke(),await Dt(this.readNext.promise,t?.signal,t)}}function zH(){return new $H}class HH extends Error{name="UnexpectedEOFError";code="ERR_UNEXPECTED_EOF"}class KH extends Error{code;constructor(e,t){super(e),this.code=t}}class qH extends KH{type;constructor(e){super(e,"ABORT_ERR"),this.type="aborted",this.name="AbortError"}}function WH(n,e){const t=zH();n.sink(t).catch(async a=>{await t.end(a)}),n.sink=async a=>{for await(const c of a)await t.push(c);await t.end()};let r=n.source;n.source[Symbol.iterator]!=null?r=n.source[Symbol.iterator]():n.source[Symbol.asyncIterator]!=null&&(r=n.source[Symbol.asyncIterator]());const s=new Ie;return{read:async(a,c)=>{c?.signal?.throwIfAborted();let u;const h=new Promise((f,p)=>{u=()=>{p(new qH("Read aborted"))},c?.signal?.addEventListener("abort",u)});try{if(a==null){const{done:p,value:m}=await Promise.race([r.next(),h]);return p===!0?new Ie:m}for(;s.byteLength<a;){const{value:p,done:m}=await Promise.race([r.next(),h]);if(m===!0)throw new HH("unexpected end of input");s.append(p)}const f=s.sublist(0,a);return s.consume(a),f}finally{u!=null&&c?.signal?.removeEventListener("abort",u)}},write:async(a,c)=>{c?.signal?.throwIfAborted(),a instanceof Uint8Array?await t.push(a,c):await t.push(a.subarray(),c)},unwrap:()=>{if(s.byteLength>0){const a=n.source;n.source=async function*(){e?.yieldBytes===!1?yield s:yield*s,yield*a}()}return n}}}class GH extends Error{name="InvalidMessageLengthError";code="ERR_INVALID_MSG_LENGTH"}class QH extends Error{name="InvalidDataLengthError";code="ERR_MSG_DATA_TOO_LONG"}class YH extends Error{name="InvalidDataLengthLengthError";code="ERR_MSG_LENGTH_TOO_LONG"}function T9(n,e={}){const t=WH(n,e);e.maxDataLength!=null&&e.maxLengthLength==null&&(e.maxLengthLength=Ft(e.maxDataLength));const r=e?.lengthDecoder??_o,s=e?.lengthEncoder??mi;return{read:async a=>{let c=-1;const u=new Ie;for(;;){u.append(await t.read(1,a));try{c=r(u)}catch(h){if(h instanceof RangeError)continue;throw h}if(c<0)throw new GH("Invalid message length");if(e?.maxLengthLength!=null&&u.byteLength>e.maxLengthLength)throw new YH("message length length too long");if(c>-1)break}if(e?.maxDataLength!=null&&c>e.maxDataLength)throw new QH("message length too long");return t.read(c,a)},write:async(a,c)=>{await t.write(new Ie(s(a.byteLength),a),c)},writeV:async(a,c)=>{const u=new Ie(...a.flatMap(h=>[s(h.byteLength),h]));await t.write(u,c)},unwrap:()=>t.unwrap()}}var XH={};const wu=65535,_9=wu-16,Gu=!!XH?.DUMP_SESSION_KEYS;function q2(n){if(!Number.isSafeInteger(n)||n<0)throw new Error(`positive integer expected, not ${n}`)}function D9(n){if(typeof n!="boolean")throw new Error(`boolean expected, not ${n}`)}function cC(n){return n instanceof Uint8Array||n!=null&&typeof n=="object"&&n.constructor.name==="Uint8Array"}function Vr(n,...e){if(!cC(n))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(n.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${n.length}`)}function I9(n,e=!0){if(n.destroyed)throw new Error("Hash instance has been destroyed");if(e&&n.finished)throw new Error("Hash#digest() has already been called")}function JH(n,e){Vr(n);const t=e.outputLen;if(n.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const wi=n=>new Uint32Array(n.buffer,n.byteOffset,Math.floor(n.byteLength/4)),ZH=n=>new DataView(n.buffer,n.byteOffset,n.byteLength),eK=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!eK)throw new Error("Non little-endian hardware is not supported");function tK(n){if(typeof n!="string")throw new Error(`string expected, got ${typeof n}`);return new Uint8Array(new TextEncoder().encode(n))}function Zg(n){if(typeof n=="string")n=tK(n);else if(cC(n))n=em(n);else throw new Error(`Uint8Array expected, got ${typeof n}`);return n}function nK(n,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(n,e)}function rK(n,e){if(n.length!==e.length)return!1;let t=0;for(let r=0;r<n.length;r++)t|=n[r]^e[r];return t===0}const sK=(n,e)=>(Object.assign(e,n),e);function N9(n,e,t,r){if(typeof n.setBigUint64=="function")return n.setBigUint64(e,t,r);const s=BigInt(32),i=BigInt(4294967295),a=Number(t>>s&i),c=Number(t&i),u=4,h=0;n.setUint32(e+u,a,r),n.setUint32(e+h,c,r)}function em(n){return Uint8Array.from(n)}function al(...n){for(let e=0;e<n.length;e++)n[e].fill(0)}const uC=n=>Uint8Array.from(n.split("").map(e=>e.charCodeAt(0))),iK=uC("expand 16-byte k"),oK=uC("expand 32-byte k"),aK=wi(iK),dC=wi(oK);dC.slice();function Oe(n,e){return n<<e|n>>>32-e}function tm(n){return n.byteOffset%4===0}const Rh=64,lK=16,hC=2**32-1,M9=new Uint32Array;function cK(n,e,t,r,s,i,a,c){const u=s.length,h=new Uint8Array(Rh),f=wi(h),p=tm(s)&&tm(i),m=p?wi(s):M9,w=p?wi(i):M9;for(let x=0;x<u;a++){if(n(e,t,r,f,a,c),a>=hC)throw new Error("arx: counter overflow");const S=Math.min(Rh,u-x);if(p&&S===Rh){const E=x/4;if(x%4!==0)throw new Error("arx: invalid block position");for(let A=0,P;A<lK;A++)P=E+A,w[P]=m[P]^f[A];x+=Rh;continue}for(let E=0,A;E<S;E++)A=x+E,i[A]=s[A]^h[E];x+=S}}function uK(n,e){const{allowShortKeys:t,extendNonceFn:r,counterLength:s,counterRight:i,rounds:a}=nK({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof n!="function")throw new Error("core must be a function");return q2(s),q2(a),D9(i),D9(t),(c,u,h,f,p=0)=>{Vr(c),Vr(u),Vr(h);const m=h.length;if(f===void 0&&(f=new Uint8Array(m)),Vr(f),q2(p),p<0||p>=hC)throw new Error("arx: counter overflow");if(f.length<m)throw new Error(`arx: output (${f.length}) is shorter than data (${m})`);const w=[];let x=c.length,S,E;if(x===32)w.push(S=em(c)),E=dC;else if(x===16&&t)S=new Uint8Array(32),S.set(c),S.set(c,16),E=aK,w.push(S);else throw new Error(`arx: invalid 32-byte key, got length=${x}`);tm(u)||w.push(u=em(u));const A=wi(S);if(r){if(u.length!==24)throw new Error("arx: extended nonce must be 24 bytes");r(E,A,wi(u.subarray(0,16)),A),u=u.subarray(16)}const P=16-s;if(P!==u.length)throw new Error(`arx: nonce must be ${P} or 16 bytes`);if(P!==12){const F=new Uint8Array(12);F.set(u,i?0:12-u.length),u=F,w.push(u)}const k=wi(u);return cK(n,E,A,k,h,f,p,a),al(...w),f}}const $t=(n,e)=>n[e++]&255|(n[e++]&255)<<8;class dK{constructor(e){this.blockLen=16,this.outputLen=16,this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.pos=0,this.finished=!1,e=Zg(e),Vr(e,32);const t=$t(e,0),r=$t(e,2),s=$t(e,4),i=$t(e,6),a=$t(e,8),c=$t(e,10),u=$t(e,12),h=$t(e,14);this.r[0]=t&8191,this.r[1]=(t>>>13|r<<3)&8191,this.r[2]=(r>>>10|s<<6)&7939,this.r[3]=(s>>>7|i<<9)&8191,this.r[4]=(i>>>4|a<<12)&255,this.r[5]=a>>>1&8190,this.r[6]=(a>>>14|c<<2)&8191,this.r[7]=(c>>>11|u<<5)&8065,this.r[8]=(u>>>8|h<<8)&8191,this.r[9]=h>>>5&127;for(let f=0;f<8;f++)this.pad[f]=$t(e,16+2*f)}process(e,t,r=!1){const s=r?0:2048,{h:i,r:a}=this,c=a[0],u=a[1],h=a[2],f=a[3],p=a[4],m=a[5],w=a[6],x=a[7],S=a[8],E=a[9],A=$t(e,t+0),P=$t(e,t+2),k=$t(e,t+4),F=$t(e,t+6),I=$t(e,t+8),V=$t(e,t+10),Q=$t(e,t+12),D=$t(e,t+14);let R=i[0]+(A&8191),Y=i[1]+((A>>>13|P<<3)&8191),J=i[2]+((P>>>10|k<<6)&8191),X=i[3]+((k>>>7|F<<9)&8191),B=i[4]+((F>>>4|I<<12)&8191),O=i[5]+(I>>>1&8191),L=i[6]+((I>>>14|V<<2)&8191),K=i[7]+((V>>>11|Q<<5)&8191),G=i[8]+((Q>>>8|D<<8)&8191),$=i[9]+(D>>>5|s),j=0,H=j+R*c+Y*(5*E)+J*(5*S)+X*(5*x)+B*(5*w);j=H>>>13,H&=8191,H+=O*(5*m)+L*(5*p)+K*(5*f)+G*(5*h)+$*(5*u),j+=H>>>13,H&=8191;let T=j+R*u+Y*c+J*(5*E)+X*(5*S)+B*(5*x);j=T>>>13,T&=8191,T+=O*(5*w)+L*(5*m)+K*(5*p)+G*(5*f)+$*(5*h),j+=T>>>13,T&=8191;let N=j+R*h+Y*u+J*c+X*(5*E)+B*(5*S);j=N>>>13,N&=8191,N+=O*(5*x)+L*(5*w)+K*(5*m)+G*(5*p)+$*(5*f),j+=N>>>13,N&=8191;let Z=j+R*f+Y*h+J*u+X*c+B*(5*E);j=Z>>>13,Z&=8191,Z+=O*(5*S)+L*(5*x)+K*(5*w)+G*(5*m)+$*(5*p),j+=Z>>>13,Z&=8191;let oe=j+R*p+Y*f+J*h+X*u+B*c;j=oe>>>13,oe&=8191,oe+=O*(5*E)+L*(5*S)+K*(5*x)+G*(5*w)+$*(5*m),j+=oe>>>13,oe&=8191;let ie=j+R*m+Y*p+J*f+X*h+B*u;j=ie>>>13,ie&=8191,ie+=O*c+L*(5*E)+K*(5*S)+G*(5*x)+$*(5*w),j+=ie>>>13,ie&=8191;let ae=j+R*w+Y*m+J*p+X*f+B*h;j=ae>>>13,ae&=8191,ae+=O*u+L*c+K*(5*E)+G*(5*S)+$*(5*x),j+=ae>>>13,ae&=8191;let me=j+R*x+Y*w+J*m+X*p+B*f;j=me>>>13,me&=8191,me+=O*h+L*u+K*c+G*(5*E)+$*(5*S),j+=me>>>13,me&=8191;let ve=j+R*S+Y*x+J*w+X*m+B*p;j=ve>>>13,ve&=8191,ve+=O*f+L*h+K*u+G*c+$*(5*E),j+=ve>>>13,ve&=8191;let ge=j+R*E+Y*S+J*x+X*w+B*m;j=ge>>>13,ge&=8191,ge+=O*p+L*f+K*h+G*u+$*c,j+=ge>>>13,ge&=8191,j=(j<<2)+j|0,j=j+H|0,H=j&8191,j=j>>>13,T+=j,i[0]=H,i[1]=T,i[2]=N,i[3]=Z,i[4]=oe,i[5]=ie,i[6]=ae,i[7]=me,i[8]=ve,i[9]=ge}finalize(){const{h:e,pad:t}=this,r=new Uint16Array(10);let s=e[1]>>>13;e[1]&=8191;for(let c=2;c<10;c++)e[c]+=s,s=e[c]>>>13,e[c]&=8191;e[0]+=s*5,s=e[0]>>>13,e[0]&=8191,e[1]+=s,s=e[1]>>>13,e[1]&=8191,e[2]+=s,r[0]=e[0]+5,s=r[0]>>>13,r[0]&=8191;for(let c=1;c<10;c++)r[c]=e[c]+s,s=r[c]>>>13,r[c]&=8191;r[9]-=8192;let i=(s^1)-1;for(let c=0;c<10;c++)r[c]&=i;i=~i;for(let c=0;c<10;c++)e[c]=e[c]&i|r[c];e[0]=(e[0]|e[1]<<13)&65535,e[1]=(e[1]>>>3|e[2]<<10)&65535,e[2]=(e[2]>>>6|e[3]<<7)&65535,e[3]=(e[3]>>>9|e[4]<<4)&65535,e[4]=(e[4]>>>12|e[5]<<1|e[6]<<14)&65535,e[5]=(e[6]>>>2|e[7]<<11)&65535,e[6]=(e[7]>>>5|e[8]<<8)&65535,e[7]=(e[8]>>>8|e[9]<<5)&65535;let a=e[0]+t[0];e[0]=a&65535;for(let c=1;c<8;c++)a=(e[c]+t[c]|0)+(a>>>16)|0,e[c]=a&65535;al(r)}update(e){I9(this);const{buffer:t,blockLen:r}=this;e=Zg(e);const s=e.length;for(let i=0;i<s;){const a=Math.min(r-this.pos,s-i);if(a===r){for(;r<=s-i;i+=r)this.process(e,i);continue}t.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===r&&(this.process(t,0,!1),this.pos=0)}return this}destroy(){al(this.h,this.r,this.buffer,this.pad)}digestInto(e){I9(this),JH(e,this),this.finished=!0;const{buffer:t,h:r}=this;let{pos:s}=this;if(s){for(t[s++]=1;s<16;s++)t[s]=0;this.process(t,0,!0)}this.finalize();let i=0;for(let a=0;a<8;a++)e[i++]=r[a]>>>0,e[i++]=r[a]>>>8;return e}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const r=e.slice(0,t);return this.destroy(),r}}function hK(n){const e=(r,s)=>n(s).update(Zg(r)).digest(),t=n(new Uint8Array(32));return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=r=>n(r),e}const fK=hK(n=>new dK(n));function pK(n,e,t,r,s,i=20){let a=n[0],c=n[1],u=n[2],h=n[3],f=e[0],p=e[1],m=e[2],w=e[3],x=e[4],S=e[5],E=e[6],A=e[7],P=s,k=t[0],F=t[1],I=t[2],V=a,Q=c,D=u,R=h,Y=f,J=p,X=m,B=w,O=x,L=S,K=E,G=A,$=P,j=k,H=F,T=I;for(let Z=0;Z<i;Z+=2)V=V+Y|0,$=Oe($^V,16),O=O+$|0,Y=Oe(Y^O,12),V=V+Y|0,$=Oe($^V,8),O=O+$|0,Y=Oe(Y^O,7),Q=Q+J|0,j=Oe(j^Q,16),L=L+j|0,J=Oe(J^L,12),Q=Q+J|0,j=Oe(j^Q,8),L=L+j|0,J=Oe(J^L,7),D=D+X|0,H=Oe(H^D,16),K=K+H|0,X=Oe(X^K,12),D=D+X|0,H=Oe(H^D,8),K=K+H|0,X=Oe(X^K,7),R=R+B|0,T=Oe(T^R,16),G=G+T|0,B=Oe(B^G,12),R=R+B|0,T=Oe(T^R,8),G=G+T|0,B=Oe(B^G,7),V=V+J|0,T=Oe(T^V,16),K=K+T|0,J=Oe(J^K,12),V=V+J|0,T=Oe(T^V,8),K=K+T|0,J=Oe(J^K,7),Q=Q+X|0,$=Oe($^Q,16),G=G+$|0,X=Oe(X^G,12),Q=Q+X|0,$=Oe($^Q,8),G=G+$|0,X=Oe(X^G,7),D=D+B|0,j=Oe(j^D,16),O=O+j|0,B=Oe(B^O,12),D=D+B|0,j=Oe(j^D,8),O=O+j|0,B=Oe(B^O,7),R=R+Y|0,H=Oe(H^R,16),L=L+H|0,Y=Oe(Y^L,12),R=R+Y|0,H=Oe(H^R,8),L=L+H|0,Y=Oe(Y^L,7);let N=0;r[N++]=a+V|0,r[N++]=c+Q|0,r[N++]=u+D|0,r[N++]=h+R|0,r[N++]=f+Y|0,r[N++]=p+J|0,r[N++]=m+X|0,r[N++]=w+B|0,r[N++]=x+O|0,r[N++]=S+L|0,r[N++]=E+K|0,r[N++]=A+G|0,r[N++]=P+$|0,r[N++]=k+j|0,r[N++]=F+H|0,r[N++]=I+T|0}const gK=uK(pK,{counterRight:!1,counterLength:4,allowShortKeys:!1}),mK=new Uint8Array(16),R9=(n,e)=>{n.update(e);const t=e.length%16;t&&n.update(mK.subarray(t))},yK=new Uint8Array(32);function L9(n,e,t,r,s){const i=n(e,t,yK),a=fK.create(i);s&&R9(a,s),R9(a,r);const c=new Uint8Array(16),u=ZH(c);N9(u,0,BigInt(s?s.length:0),!0),N9(u,8,BigInt(r.length),!0),a.update(c);const h=a.digest();return al(i,c),h}const wK=n=>(e,t,r)=>(Vr(e,32),Vr(t),{encrypt(i,a){const c=i.length,u=c+16;a?Vr(a,u):a=new Uint8Array(u),n(e,t,i,a,1);const h=L9(n,e,t,a.subarray(0,-16),r);return a.set(h,c),al(h),a},decrypt(i,a){const c=i.length,u=c-16;if(c<16)throw new Error("encrypted data must be at least 16 bytes");a?Vr(a,u):a=new Uint8Array(u);const h=i.subarray(0,-16),f=i.subarray(-16),p=L9(n,e,t,h,r);if(!rK(f,p))throw new Error("invalid tag");return n(e,t,h,a,1),al(p),a}}),O9=sK({blockSize:64,nonceLength:12,tagLength:16},wK(gK)),vK={hashSHA256(n){return Da(n.subarray())},getHKDF(n,e){const t=iz(Da,e,n),s=oz(Da,t,void 0,96),i=s.subarray(0,32),a=s.subarray(32,64),c=s.subarray(64,96);return[i,a,c]},generateX25519KeyPair(){const n=bh.utils.randomPrivateKey();return{publicKey:bh.getPublicKey(n),privateKey:n}},generateX25519KeyPairFromSeed(n){return{publicKey:bh.getPublicKey(n),privateKey:n}},generateX25519SharedKey(n,e){return bh.getSharedSecret(n.subarray(),e.subarray())},chaCha20Poly1305Encrypt(n,e,t,r){return O9(r,e,t).encrypt(n.subarray())},chaCha20Poly1305Decrypt(n,e,t,r,s){return O9(r,e,t).decrypt(n.subarray(),s)}},bK=vK;function xK(n){return{generateKeypair:n.generateX25519KeyPair,dh:(e,t)=>n.generateX25519SharedKey(e.privateKey,t).subarray(0,32),encrypt:n.chaCha20Poly1305Encrypt,decrypt:n.chaCha20Poly1305Decrypt,hash:n.hashSHA256,hkdf:n.getHKDF}}const Vf=n=>{const e=Sr(2);return e[0]=n>>8,e[1]=n,e};Vf.bytes=2;const qh=n=>{if(n.length<2)throw RangeError("Could not decode int16BE");if(n instanceof Uint8Array){let e=0;return e+=n[0]<<8,e+=n[1],e}return n.getUint16(0)};qh.bytes=2;function SK(n){return{xxHandshakeSuccesses:n.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:n.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:n.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:n.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:n.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}function fC(n,e){!e.enabled||!Gu||(n?(e(`LOCAL_STATIC_PUBLIC_KEY ${pe(n.publicKey,"hex")}`),e(`LOCAL_STATIC_PRIVATE_KEY ${pe(n.privateKey,"hex")}`)):e("Missing local static keys."))}function pC(n,e){!e.enabled||!Gu||(n?(e(`LOCAL_PUBLIC_EPHEMERAL_KEY ${pe(n.publicKey,"hex")}`),e(`LOCAL_PRIVATE_EPHEMERAL_KEY ${pe(n.privateKey,"hex")}`)):e("Missing local ephemeral keys."))}function EK(n,e){!e.enabled||!Gu||e(n?`REMOTE_STATIC_PUBLIC_KEY ${pe(n.subarray(),"hex")}`:"Missing remote static public key.")}function gC(n,e){!e.enabled||!Gu||e(n?`REMOTE_EPHEMERAL_PUBLIC_KEY ${pe(n.subarray(),"hex")}`:"Missing remote ephemeral keys.")}function mC(n,e,t){!t.enabled||!Gu||(t(`CIPHER_STATE_1 ${n.n.getUint64()} ${n.k&&pe(n.k,"hex")}`),t(`CIPHER_STATE_2 ${e.n.getUint64()} ${e.k&&pe(e.k,"hex")}`))}class G3 extends Error{code;constructor(e="Unexpected Peer"){super(e),this.code=G3.code}static code="ERR_UNEXPECTED_PEER"}class $c extends Error{code;constructor(e="Invalid crypto exchange"){super(e),this.code=$c.code}static code="ERR_INVALID_CRYPTO_EXCHANGE"}const CK=0,kK=4294967295,AK="Cipherstate has reached maximum n, a new handshake must be performed";class PK{n;bytes;view;constructor(e=CK){this.n=e,this.bytes=Fe(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>kK)throw new Error(AK)}}const La=Fe(0);class Lh{k;n;crypto;constructor(e,t=void 0,r=0){this.crypto=e,this.k=t,this.n=new PK(r)}hasKey(){return!!this.k}encryptWithAd(e,t){if(!this.hasKey())return t;this.n.assertValue();const r=this.crypto.encrypt(t,this.n.getBytes(),e,this.k);return this.n.increment(),r}decryptWithAd(e,t,r){if(!this.hasKey())return t;this.n.assertValue();const s=this.crypto.decrypt(t,this.n.getBytes(),e,this.k,r);return this.n.increment(),s}}class TK{cs;ck;h;crypto;constructor(e,t){this.crypto=e;const r=we(t,"utf-8");this.h=DK(e,r),this.ck=this.h,this.cs=new Lh(e)}mixKey(e){const[t,r]=this.crypto.hkdf(this.ck,e);this.ck=t,this.cs=new Lh(this.crypto,r)}mixHash(e){this.h=this.crypto.hash(new Ie(this.h,e))}encryptAndHash(e){const t=this.cs.encryptWithAd(this.h,e);return this.mixHash(t),t}decryptAndHash(e){const t=this.cs.decryptWithAd(this.h,e);return this.mixHash(e),t}split(){const[e,t]=this.crypto.hkdf(this.ck,La);return[new Lh(this.crypto,e),new Lh(this.crypto,t)]}}class _K{ss;s;e;rs;re;initiator;crypto;constructor(e){const{crypto:t,protocolName:r,prologue:s,initiator:i,s:a,e:c,rs:u,re:h}=e;this.crypto=t,this.ss=new TK(t,r),this.ss.mixHash(s),this.initiator=i,this.s=a,this.e=c,this.rs=u,this.re=h}writeE(){if(this.e)throw new Error("ephemeral keypair is already set");const e=this.crypto.generateKeypair();return this.ss.mixHash(e.publicKey),this.e=e,e.publicKey}writeS(){if(!this.s)throw new Error("static keypair is not set");return this.ss.encryptAndHash(this.s.publicKey)}writeEE(){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.re))}writeES(){if(this.initiator){if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}else{if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}}writeSE(){if(this.initiator){if(!this.s)throw new Error("static keypair is not set");if(!this.re)throw new Error("remote ephemeral public key is not set");this.ss.mixKey(this.crypto.dh(this.s,this.re))}else{if(!this.e)throw new Error("ephemeral keypair is not set");if(!this.rs)throw new Error("remote static public key is not set");this.ss.mixKey(this.crypto.dh(this.e,this.rs))}}readE(e,t=0){if(this.re)throw new Error("remote ephemeral public key is already set");if(e.byteLength<t+32)throw new Error("message is not long enough");this.re=e.sublist(t,t+32),this.ss.mixHash(this.re)}readS(e,t=0){if(this.rs)throw new Error("remote static public key is already set");const r=32+(this.ss.cs.hasKey()?16:0);if(e.byteLength<t+r)throw new Error("message is not long enough");const s=e.sublist(t,t+r);return this.rs=this.ss.decryptAndHash(s),r}readEE(){this.writeEE()}readES(){this.writeES()}readSE(){this.writeSE()}}class yC extends _K{writeMessageA(e){return new Ie(this.writeE(),this.ss.encryptAndHash(e))}writeMessageB(e){const t=this.writeE();this.writeEE();const r=this.writeS();return this.writeES(),new Ie(t,r,this.ss.encryptAndHash(e))}writeMessageC(e){const t=this.writeS();return this.writeSE(),new Ie(t,this.ss.encryptAndHash(e))}readMessageA(e){try{return this.readE(e),this.ss.decryptAndHash(e.sublist(32))}catch(t){throw new $c(`handshake stage 0 validation fail: ${t.message}`)}}readMessageB(e){try{this.readE(e),this.readEE();const t=this.readS(e,32);return this.readES(),this.ss.decryptAndHash(e.sublist(32+t))}catch(t){throw new $c(`handshake stage 1 validation fail: ${t.message}`)}}readMessageC(e){try{const t=this.readS(e);return this.readSE(),this.ss.decryptAndHash(e.sublist(t))}catch(t){throw new $c(`handshake stage 2 validation fail: ${t.message}`)}}}function DK(n,e){if(e.length<=32){const t=Fe(32);return t.set(e),t}else return n.hash(e)}var jf;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.webtransportCerthashes!=null)for(const i of t.webtransportCerthashes)r.uint32(10),r.bytes(i);s.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const s={webtransportCerthashes:[]},i=r==null?t.len:t.pos+r;for(;t.pos<i;){const a=t.uint32();switch(a>>>3){case 1:{s.webtransportCerthashes.push(t.bytes());break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Ge(t,n.codec()),n.decode=t=>We(t,n.codec())})(jf||(jf={}));var $f;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.identityKey!=null&&t.identityKey.byteLength>0&&(r.uint32(10),r.bytes(t.identityKey)),t.identitySig!=null&&t.identitySig.byteLength>0&&(r.uint32(18),r.bytes(t.identitySig)),t.extensions!=null&&(r.uint32(34),jf.codec().encode(t.extensions,r)),s.lengthDelimited!==!1&&r.ldelim()},(t,r)=>{const s={identityKey:Fe(0),identitySig:Fe(0)},i=r==null?t.len:t.pos+r;for(;t.pos<i;){const a=t.uint32();switch(a>>>3){case 1:{s.identityKey=t.bytes();break}case 2:{s.identitySig=t.bytes();break}case 4:{s.extensions=jf.codec().decode(t,t.uint32());break}default:{t.skipType(a&7);break}}}return s})),e),n.encode=t=>Ge(t,n.codec()),n.decode=t=>We(t,n.codec())})($f||($f={}));async function wC(n,e,t){const r=await n.sign(bC(e));return $f.encode({identityKey:n.public.bytes,identitySig:r,extensions:t})}async function vC(n,e,t){try{const r=$f.decode(n);if(t){const a=t.subarray();if(!Ve(a,r.identityKey))throw new Error(`Payload identity key ${pe(r.identityKey,"hex")} does not match expected remote identity key ${pe(a,"hex")}`)}if(!e)throw new Error("Remote static does not exist");const s=bC(e);if(!await DH(r.identityKey).verify(s,r.identitySig))throw new Error("Invalid payload signature");return r}catch(r){throw new G3(r.message)}}function bC(n){const e=we("noise-libp2p-static-key:");return n instanceof Uint8Array?Cs([e,n],e.length+n.length):(n.prepend(e),n)}async function IK(n,e){const{log:t,connection:r,crypto:s,privateKey:i,prologue:a,s:c,remoteIdentityKey:u,extensions:h}=n,f=await wC(i,c.publicKey,h),p=new yC({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!0,prologue:a,s:c});fC(p.s,t),t.trace("Stage 0 - Initiator starting to send first message."),await r.write(p.writeMessageA(La),e),t.trace("Stage 0 - Initiator finished sending first message."),pC(p.e,t),t.trace("Stage 1 - Initiator waiting to receive first message from responder...");const m=p.readMessageB(await r.read(e));t.trace("Stage 1 - Initiator received the message."),gC(p.re,t),EK(p.rs,t),t.trace("Initiator going to check remote's signature...");const w=await vC(m,p.rs,u);t.trace("All good with the signature!"),t.trace("Stage 2 - Initiator sending third handshake message."),await r.write(p.writeMessageC(f),e),t.trace("Stage 2 - Initiator sent message with signed payload.");const[x,S]=p.ss.split();return mC(x,S,t),{payload:w,encrypt:E=>x.encryptWithAd(La,E),decrypt:(E,A)=>S.decryptWithAd(La,E,A)}}async function NK(n,e){const{log:t,connection:r,crypto:s,privateKey:i,prologue:a,s:c,remoteIdentityKey:u,extensions:h}=n,f=await wC(i,c.publicKey,h),p=new yC({crypto:s,protocolName:"Noise_XX_25519_ChaChaPoly_SHA256",initiator:!1,prologue:a,s:c});fC(p.s,t),t.trace("Stage 0 - Responder waiting to receive first message."),p.readMessageA(await r.read(e)),t.trace("Stage 0 - Responder received first message."),gC(p.re,t),t.trace("Stage 1 - Responder sending out first message with signed payload and static key."),await r.write(p.writeMessageB(f),e),t.trace("Stage 1 - Responder sent the second handshake message with signed payload."),pC(p.e,t),t.trace("Stage 2 - Responder waiting for third handshake message...");const m=p.readMessageC(await r.read(e));t.trace("Stage 2 - Responder received the message, finished handshake.");const w=await vC(m,p.rs,u),[x,S]=p.ss.split();return mC(x,S,t),{payload:w,encrypt:E=>S.encryptWithAd(La,E),decrypt:(E,A)=>x.decryptWithAd(La,E,A)}}const B9=16;function MK(n,e){return async function*(t){for await(const r of t)for(let s=0;s<r.length;s+=_9){let i=s+_9;i>r.length&&(i=r.length);let a;r instanceof Uint8Array?a=n.encrypt(r.subarray(s,i)):a=n.encrypt(r.sublist(s,i)),e?.encryptedPackets.increment(),yield new Ie(Vf(a.byteLength),a)}}}function RK(n,e){return async function*(t){for await(const r of t)for(let s=0;s<r.length;s+=wu){let i=s+wu;if(i>r.length&&(i=r.length),i-B9<s)throw new Error("Invalid chunk");const a=r.sublist(s,i),c=r.subarray(s,i-B9);try{const u=n.decrypt(a,c);e?.decryptedPackets.increment(),yield u}catch(u){throw e?.decryptErrors.increment(),u}}}}class LK{protocol="/noise";crypto;prologue;staticKey;extensions;metrics;components;constructor(e,t={}){const{staticNoiseKey:r,extensions:s,crypto:i,prologueBytes:a}=t,{metrics:c}=e;this.components=e;const u=i??bK;this.crypto=xK(u),this.extensions=s,this.metrics=c?SK(c):void 0,r?this.staticKey=u.generateX25519KeyPairFromSeed(r):this.staticKey=u.generateX25519KeyPair(),this.prologue=a??Fe(0)}[Symbol.toStringTag]="@chainsafe/libp2p-noise";[Gz]=["@libp2p/connection-encryption","@chainsafe/libp2p-noise"];async secureOutbound(...e){const{localPeer:t,connection:r,remotePeer:s,signal:i}=this.parseArgs(e),a=T9(r,{lengthEncoder:Vf,lengthDecoder:qh,maxDataLength:wu});if(!t.privateKey)throw new it("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const c=await k9(t.privateKey),u=s?.publicKey,h=await this.performHandshakeInitiator(a,c,u,{signal:i}),f=await this.createSecureConnection(a,h);return r.source=f.source,r.sink=f.sink,{conn:r,remoteExtensions:h.payload.extensions,remotePeer:await A9(h.payload.identityKey)}}async secureInbound(...e){const{localPeer:t,connection:r,remotePeer:s,signal:i}=this.parseArgs(e),a=T9(r,{lengthEncoder:Vf,lengthDecoder:qh,maxDataLength:wu});if(!t.privateKey)throw new it("local peerId does not contain private key","ERR_NO_PRIVATE_KEY");const c=await k9(t.privateKey),u=s?.publicKey,h=await this.performHandshakeResponder(a,c,u,{signal:i}),f=await this.createSecureConnection(a,h);return r.source=f.source,r.sink=f.sink,{conn:r,remoteExtensions:h.payload.extensions,remotePeer:await A9(h.payload.identityKey)}}async performHandshakeInitiator(e,t,r,s){let i;try{i=await IK({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async performHandshakeResponder(e,t,r,s){let i;try{i=await NK({connection:e,privateKey:t,remoteIdentityKey:r,log:this.components.logger.forComponent("libp2p:noise:xxhandshake"),crypto:this.crypto,prologue:this.prologue,s:this.staticKey,extensions:this.extensions},s),this.metrics?.xxHandshakeSuccesses.increment()}catch(a){throw this.metrics?.xxHandshakeErrors.increment(),a}return i}async createSecureConnection(e,t){const[r,s]=nz(),i=e.unwrap();return await I1(r,MK(t,this.metrics),i,a=>Jg(a,{lengthDecoder:qh}),RK(t,this.metrics),r),s}parseArgs(e){return Wz(e[0])?{localPeer:e[0],connection:e[1],remotePeer:e[2]}:{localPeer:this.components.peerId,connection:e[0],remotePeer:e[1]?.remotePeer,signal:e[1]?.signal}}}function OK(n={}){return e=>new LK(e,n)}class Pa extends Error{static name="InvalidFrameError";constructor(e="The frame was invalid"){super(e),this.name="InvalidFrameError"}}class xC extends Error{static name="UnrequestedPingError";constructor(e="Unrequested ping error"){super(e),this.name="UnrequestedPingError"}}class SC extends Error{static name="NotMatchingPingError";constructor(e="Unrequested ping error"){super(e),this.name="NotMatchingPingError"}}class BK extends Error{static name="InvalidStateError";constructor(e="Invalid state"){super(e),this.name="InvalidStateError"}}class FK extends Error{static name="StreamAlreadyExistsError";constructor(e="Strean already exists"){super(e),this.name="StreamAlreadyExistsError"}}class UK extends Error{static name="DecodeInvalidVersionError";constructor(e="Decode invalid version"){super(e),this.name="DecodeInvalidVersionError"}}class VK extends Error{static name="BothClientsError";constructor(e="Both clients"){super(e),this.name="BothClientsError"}}class EC extends Error{static name="ReceiveWindowExceededError";constructor(e="Receive window exceeded"){super(e),this.name="ReceiveWindowExceededError"}}const jK=new Set([Pa.name,xC.name,SC.name,FK.name,UK.name,VK.name,EC.name]),Q3=256*1024,$K=16*1024*1024,zK={enableKeepAlive:!0,keepAliveInterval:3e4,maxInboundStreams:1e3,maxOutboundStreams:1e3,initialStreamWindowSize:Q3,maxStreamWindowSize:$K,maxMessageSize:64*1024};function HK(n){if(n.keepAliveInterval<=0)throw new Ae("keep-alive interval must be positive");if(n.maxInboundStreams<0)throw new Ae("max inbound streams must be larger or equal 0");if(n.maxOutboundStreams<0)throw new Ae("max outbound streams must be larger or equal 0");if(n.initialStreamWindowSize<Q3)throw new Ae("InitialStreamWindowSize must be larger or equal 256 kB");if(n.maxStreamWindowSize<n.initialStreamWindowSize)throw new Ae("MaxStreamWindowSize must be larger than the InitialStreamWindowSize");if(n.maxStreamWindowSize>2**32-1)throw new Ae("MaxStreamWindowSize must be less than equal MAX_UINT32");if(n.maxMessageSize<1024)throw new Ae("MaxMessageSize must be greater than a kilobyte")}var _t;(function(n){n[n.Data=0]="Data",n[n.WindowUpdate=1]="WindowUpdate",n[n.Ping=2]="Ping",n[n.GoAway=3]="GoAway"})(_t||(_t={}));var gt;(function(n){n[n.SYN=1]="SYN",n[n.ACK=2]="ACK",n[n.FIN=4]="FIN",n[n.RST=8]="RST"})(gt||(gt={}));Object.values(gt).filter(n=>typeof n!="string");const KK=0;var Or;(function(n){n[n.NormalTermination=0]="NormalTermination",n[n.ProtocolError=1]="ProtocolError",n[n.InternalError=2]="InternalError"})(Or||(Or={}));const zc=12,F9=2**24;function qK(n){if(n[0]!==KK)throw new Pa("Invalid frame version");return{type:n[1],flag:(n[2]<<8)+n[3],streamID:n[4]*F9+(n[5]<<16)+(n[6]<<8)+n[7],length:n[8]*F9+(n[9]<<16)+(n[10]<<8)+n[11]}}let WK=class{source;buffer;frameInProgress;constructor(e){this.source=GK(e),this.buffer=new Ie,this.frameInProgress=!1}async*emitFrames(){for await(const e of this.source)for(this.buffer.append(e);;){const t=this.readHeader();if(t===void 0)break;const{type:r,length:s}=t;r===_t.Data?(this.frameInProgress=!0,yield{header:t,readData:this.readBytes.bind(this,s)}):yield{header:t}}}readHeader(){if(this.frameInProgress)throw new BK("decoding frame already in progress");if(this.buffer.length<zc)return;const e=qK(this.buffer.subarray(0,zc));return this.buffer.consume(zc),e}async readBytes(e){if(this.buffer.length<e){for await(const r of this.source)if(this.buffer.append(r),this.buffer.length>=e)break}const t=this.buffer.sublist(0,e);return this.buffer.consume(e),this.frameInProgress=!1,t}};function GK(n){if(n[Symbol.iterator]!==void 0){const e=n[Symbol.iterator]();return e.return=void 0,{[Symbol.iterator](){return e}}}else if(n[Symbol.asyncIterator]!==void 0){const e=n[Symbol.asyncIterator]();return e.return=void 0,{[Symbol.asyncIterator](){return e}}}else throw new Error("a source must be either an iterable or an async iterable")}function U9(n){const e=new Uint8Array(zc);return e[1]=n.type,e[2]=n.flag>>>8,e[3]=n.flag,e[4]=n.streamID>>>24,e[5]=n.streamID>>>16,e[6]=n.streamID>>>8,e[7]=n.streamID,e[8]=n.length>>>24,e[9]=n.length>>>16,e[10]=n.length>>>8,e[11]=n.length,e}var pr;(function(n){n[n.Init=0]="Init",n[n.SYNSent=1]="SYNSent",n[n.SYNReceived=2]="SYNReceived",n[n.Established=3]="Established",n[n.Finished=4]="Finished"})(pr||(pr={}));class QK extends CS{name;state;config;_id;sendWindowCapacity;sendWindowCapacityUpdate;recvWindow;recvWindowCapacity;epochStart;getRTT;sendFrame;constructor(e){super({...e,onEnd:t=>{this.state=pr.Finished,e.onEnd?.(t)}}),this.config=e.config,this._id=parseInt(e.id,10),this.name=e.name,this.state=e.state,this.sendWindowCapacity=Q3,this.recvWindow=this.config.initialStreamWindowSize,this.recvWindowCapacity=this.recvWindow,this.epochStart=Date.now(),this.getRTT=e.getRTT,this.sendFrame=e.sendFrame,this.source=tC(this.source,()=>{this.sendWindowUpdate()})}async sendNewStream(){}async sendData(e,t={}){for(e=e.sublist();e.byteLength!==0;){if(this.sendWindowCapacity===0&&(this.log?.trace("wait for send window capacity, status %s",this.status),await this.waitForSendWindowCapacity(t),this.status==="closed"||this.status==="aborted"||this.status==="reset")){this.log?.trace("%s while waiting for send window capacity",this.status);return}const r=Math.min(this.sendWindowCapacity,this.config.maxMessageSize-zc,e.length),s=this.getSendFlags();this.sendFrame({type:_t.Data,flag:s,streamID:this._id,length:r},e.sublist(0,r)),this.sendWindowCapacity-=r,e.consume(r)}}async sendReset(){this.sendFrame({type:_t.WindowUpdate,flag:gt.RST,streamID:this._id,length:0})}async sendCloseWrite(){const e=this.getSendFlags()|gt.FIN;this.sendFrame({type:_t.WindowUpdate,flag:e,streamID:this._id,length:0})}async sendCloseRead(){}async waitForSendWindowCapacity(e={}){if(this.sendWindowCapacity>0)return;let t,r;const s=()=>{this.status==="open"||this.status==="closing"?r(new xi("Stream aborted")):t()};e.signal?.addEventListener("abort",s);try{await new Promise((i,a)=>{this.sendWindowCapacityUpdate=()=>{i()},r=a,t=i})}finally{e.signal?.removeEventListener("abort",s)}}handleWindowUpdate(e){this.log?.trace("stream received window update id=%s",this._id),this.processFlags(e.flag);const t=this.sendWindowCapacity;this.sendWindowCapacity+=e.length,t===0&&e.length>0&&this.sendWindowCapacityUpdate?.()}async handleData(e,t){if(this.log?.trace("stream received data id=%s",this._id),this.processFlags(e.flag),this.recvWindowCapacity<e.length)throw new EC("Receive window exceeded");const r=await t();this.recvWindowCapacity-=e.length,this.sourcePush(r)}processFlags(e){(e&gt.ACK)===gt.ACK&&this.state===pr.SYNSent&&(this.state=pr.Established),(e&gt.FIN)===gt.FIN&&this.remoteCloseWrite(),(e&gt.RST)===gt.RST&&this.reset()}getSendFlags(){switch(this.state){case pr.Init:return this.state=pr.SYNSent,gt.SYN;case pr.SYNReceived:return this.state=pr.Established,gt.ACK;default:return 0}}sendWindowUpdate(){const e=this.getSendFlags(),t=Date.now(),r=this.getRTT();if(e===0&&r>-1&&t-this.epochStart<r*4&&(this.recvWindow=Math.min(this.recvWindow*2,this.config.maxStreamWindowSize)),this.recvWindowCapacity>=this.recvWindow&&e===0)return;const s=this.recvWindow-this.recvWindowCapacity;this.recvWindowCapacity=this.recvWindow,this.epochStart=t,this.sendFrame({type:_t.WindowUpdate,flag:e,streamID:this._id,length:s})}}const CC="/yamux/1.0.0",YK=500;class XK{protocol=CC;_components;_init;constructor(e,t={}){this._components=e,this._init=t}[Symbol.toStringTag]="@chainsafe/libp2p-yamux";[br]=["@libp2p/stream-multiplexing"];createStreamMuxer(e){return new JK(this._components,{...this._init,...e})}}class JK{protocol=CC;source;sink;config;log;logger;closeController;nextStreamID;_streams;nextPingID;activePing;rtt;client;localGoAway;remoteGoAway;numInboundStreams;numOutboundStreams;onIncomingStream;onStreamEnd;constructor(e,t){this.client=t.direction==="outbound",this.config={...zK,...t},this.logger=e.logger,this.log=this.logger.forComponent("libp2p:yamux"),HK(this.config),this.closeController=new AbortController,this.closeController.signal,this.onIncomingStream=t.onIncomingStream,this.onStreamEnd=t.onStreamEnd,this._streams=new Map,this.source=_i({onEnd:()=>{this.log?.trace("muxer source ended"),this._streams.forEach(r=>{r.destroy()})}}),this.sink=async r=>{const s=()=>{const c=ES(r);if(c.return!=null){const u=c.return();ZK(u)&&u.catch(h=>{this.log?.("could not cause sink source to return",h)})}};let i,a;try{const c=new WK(r);try{this.closeController.signal.addEventListener("abort",s);for await(const u of c.emitFrames())await this.handleFrame(u.header,u.readData)}finally{this.closeController.signal.removeEventListener("abort",s)}i=Or.NormalTermination}catch(c){jK.has(c.name)?(this.log?.error("protocol error in sink",c),i=Or.ProtocolError):(this.log?.error("internal error in sink",c),i=Or.InternalError),a=c}this.log?.trace("muxer sink ended"),a!=null?this.abort(a,i):await this.close({reason:i})},this.numInboundStreams=0,this.numOutboundStreams=0,this.nextStreamID=this.client?1:2,this.nextPingID=0,this.rtt=-1,this.log?.trace("muxer created"),this.config.enableKeepAlive&&this.keepAliveLoop().catch(r=>this.log?.error("keepalive error: %s",r)),this.ping().catch(r=>this.log?.error("ping error: %s",r))}get streams(){return Array.from(this._streams.values())}newStream(e){if(this.remoteGoAway!==void 0)throw new wc("Muxer closed remotely");if(this.localGoAway!==void 0)throw new wc("Muxer closed locally");const t=this.nextStreamID;if(this.nextStreamID+=2,this.numOutboundStreams>=this.config.maxOutboundStreams)throw new Gv("max outbound streams exceeded");this.log?.trace("new outgoing stream id=%s",t);const r=this._newStream(t,e,pr.Init,"outbound");return this._streams.set(t,r),this.numOutboundStreams++,r.sendWindowUpdate(),r}async ping(){if(this.remoteGoAway!==void 0)throw new wc("Muxer closed remotely");if(this.localGoAway!==void 0)throw new wc("Muxer closed locally");if(this.activePing===void 0){let e=()=>{};this.activePing={id:this.nextPingID++,promise:new Promise((s,i)=>{const a=()=>{i(new wc("Muxer closed locally"))};this.closeController.signal.addEventListener("abort",a,{once:!0}),e=()=>{this.closeController.signal.removeEventListener("abort",a),s()}}),resolve:e};const t=Date.now();this.sendPing(this.activePing.id);try{await this.activePing.promise}finally{delete this.activePing}const r=Date.now();this.rtt=r-t}else await this.activePing.promise;return this.rtt}getRTT(){return this.rtt}async close(e={}){if(this.closeController.signal.aborted)return;const t=e?.reason??Or.NormalTermination;if(this.log?.trace("muxer close reason=%s",t),e.signal==null){const r=AbortSignal.timeout(YK);e={...e,signal:r}}try{await Promise.all([...this._streams.values()].map(async r=>r.close(e))),this.sendGoAway(t),this._closeMuxer()}catch(r){this.abort(r)}}abort(e,t){if(!this.closeController.signal.aborted){t=t??Or.InternalError,this.log?.error("muxer abort reason=%s error=%s",t,e);for(const r of this._streams.values())r.abort(e);this.sendGoAway(t),this._closeMuxer()}}isClosed(){return this.closeController.signal.aborted}_closeMuxer(){this.closeController.abort(),this.source.end()}_newStream(e,t,r,s){if(this._streams.get(e)!=null)throw new Ae("Stream already exists with that id");const i=new QK({id:e.toString(),name:t,state:r,direction:s,sendFrame:this.sendFrame.bind(this),onEnd:()=>{this.closeStream(e),this.onStreamEnd?.(i)},log:this.logger.forComponent(`libp2p:yamux:${s}:${e}`),config:this.config,getRTT:this.getRTT.bind(this)});return i}closeStream(e){this.client===(e%2===0)?this.numInboundStreams--:this.numOutboundStreams--,this._streams.delete(e)}async keepAliveLoop(){for(this.log?.trace("muxer keepalive enabled interval=%s",this.config.keepAliveInterval);;){let e;try{await Dt(new Promise(t=>{e=setTimeout(t,this.config.keepAliveInterval)}),this.closeController.signal),this.ping().catch(t=>this.log?.error("ping error: %s",t))}catch{clearInterval(e);return}}}async handleFrame(e,t){const{streamID:r,type:s,length:i}=e;if(this.log?.trace("received frame %o",e),r===0)switch(s){case _t.Ping:{this.handlePing(e);return}case _t.GoAway:{this.handleGoAway(i);return}default:throw new Pa("Invalid frame type")}else switch(e.type){case _t.Data:case _t.WindowUpdate:{await this.handleStreamMessage(e,t);return}default:throw new Pa("Invalid frame type")}}handlePing(e){if(e.flag===gt.SYN)this.log?.trace("received ping request pingId=%s",e.length),this.sendPing(e.length,gt.ACK);else if(e.flag===gt.ACK)this.log?.trace("received ping response pingId=%s",e.length),this.handlePingResponse(e.length);else throw new Pa("Invalid frame flag")}handlePingResponse(e){if(this.activePing===void 0)throw new xC("ping not requested");if(this.activePing.id!==e)throw new SC("ping doesn't match our id");this.activePing.resolve()}handleGoAway(e){this.log?.trace("received GoAway reason=%s",Or[e]??"unknown"),this.remoteGoAway=e;for(const t of this._streams.values())t.reset();this._closeMuxer()}async handleStreamMessage(e,t){const{streamID:r,flag:s,type:i}=e;(s&gt.SYN)===gt.SYN&&this.incomingStream(r);const a=this._streams.get(r);if(a===void 0){if(i===_t.Data){if(this.log?.("discarding data for stream id=%s",r),t===void 0)throw new Error("unreachable");await t()}else this.log?.trace("frame for missing stream id=%s",r);return}switch(i){case _t.WindowUpdate:{a.handleWindowUpdate(e);return}case _t.Data:{if(t===void 0)throw new Error("unreachable");await a.handleData(e,t);return}default:throw new Error("unreachable")}}incomingStream(e){if(this.client!==(e%2===0))throw new Ae("Both endpoints are clients");if(this._streams.has(e))return;if(this.log?.trace("new incoming stream id=%s",e),this.localGoAway!==void 0){this.sendFrame({type:_t.WindowUpdate,flag:gt.RST,streamID:e,length:0});return}if(this.numInboundStreams>=this.config.maxInboundStreams){this.log?.("maxIncomingStreams exceeded, forcing stream reset"),this.sendFrame({type:_t.WindowUpdate,flag:gt.RST,streamID:e,length:0});return}const t=this._newStream(e,void 0,pr.SYNReceived,"inbound");this.numInboundStreams++,this._streams.set(e,t),this.onIncomingStream?.(t)}sendFrame(e,t){if(this.log?.trace("sending frame %o",e),e.type===_t.Data){if(t===void 0)throw new Pa("Invalid frame");this.source.push(new Ie(U9(e),t))}else this.source.push(U9(e))}sendPing(e,t=gt.SYN){t===gt.SYN?this.log?.trace("sending ping request pingId=%s",e):this.log?.trace("sending ping response pingId=%s",e),this.sendFrame({type:_t.Ping,flag:t,streamID:0,length:e})}sendGoAway(e=Or.NormalTermination){this.log?.("sending GoAway reason=%s",Or[e]),this.localGoAway=e,this.sendFrame({type:_t.GoAway,flag:0,streamID:0,length:e})}}function ZK(n){return n!=null&&typeof n.then=="function"}function eq(n={}){return e=>new XK(e,n)}const El=1e3,Y3=60*El,Qu=60*Y3,tq=36*Qu,nq="/ipfs/kad/1.0.0",rq=48*Qu,sq=24*Qu,iq=10,oq=16384,aq=Qu,V9=Qu,lq=10*El,kC=20,O1=10,cq=5*Y3,uq=El,dq=5*El,hq=5*Y3,fq=30*El,pq=180*El,j9=`${d1}-kad-dht`;var zf;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.key!=null&&t.key.byteLength>0&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&t.value.byteLength>0&&(r.uint32(18),r.bytes(t.value)),t.timeReceived!=null&&t.timeReceived!==""&&(r.uint32(42),r.string(t.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={key:Fe(0),value:Fe(0),timeReceived:""},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(zf||(zf={}));function gq(n){const e=n.getUTCFullYear(),t=String(n.getUTCMonth()+1).padStart(2,"0"),r=String(n.getUTCDate()).padStart(2,"0"),s=String(n.getUTCHours()).padStart(2,"0"),i=String(n.getUTCMinutes()).padStart(2,"0"),a=String(n.getUTCSeconds()).padStart(2,"0"),c=n.getUTCMilliseconds(),u=String(c*1e3*1e3).padStart(9,"0");return`${e}-${t}-${r}T${s}:${i}:${a}.${u}Z`}function mq(n){const e=new RegExp("(\\d{4})-(\\d{2})-(\\d{2})T(\\d{2}):(\\d{2}):(\\d{2})\\.(\\d+)Z"),t=String(n).trim().match(e);if(t==null)throw new Error("Invalid format");const r=parseInt(t[1],10),s=parseInt(t[2],10)-1,i=parseInt(t[3],10),a=parseInt(t[4],10),c=parseInt(t[5],10),u=parseInt(t[6],10),h=parseInt(t[7].slice(0,-6),10);return new Date(Date.UTC(r,s,i,a,c,u,h))}class rr{key;value;timeReceived;constructor(e,t,r){if(!(e instanceof Uint8Array))throw new Error("key must be a Uint8Array");if(!(t instanceof Uint8Array))throw new Error("value must be a Uint8Array");this.key=e,this.value=t,this.timeReceived=r}serialize(){return zf.encode(this.prepareSerialize())}prepareSerialize(){return{key:this.key,value:this.value,timeReceived:gq(this.timeReceived)}}static deserialize(e){const t=zf.decode(e);return new rr(t.key,t.value,new Date(t.timeReceived))}static fromDeserialized(e){const t=mq(e.timeReceived);if(e.key==null)throw new Error("key missing from deserialized object");if(e.value==null)throw new Error("value missing from deserialized object");return new rr(e.key,e.value,t)}}function yq(n){return n[Symbol.asyncIterator]!=null}function X3(n,e){let t=0;if(yq(n))return async function*(){for await(const u of n)yield e(u,t++)}();const r=y3(n),{value:s,done:i}=r.next();if(i===!0)return function*(){}();const a=e(s,t++);if(typeof a.then=="function")return async function*(){yield await a;for(const u of r)yield e(u,t++)}();const c=e;return function*(){yield a;for(const u of r)yield c(u,t++)}()}class Hf extends Error{constructor(e="Query error"){super(e),this.name="QueryError"}}class wq extends Error{constructor(e="Invalid record"){super(e),this.name="InvalidRecordError"}}class vq extends Error{constructor(e="No selector function configured for prefix"){super(e),this.name="MissingSelectorError"}}var $9;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{s.lengthDelimited!==!1&&r.fork(),t.key!=null&&(r.uint32(10),r.bytes(t.key)),t.value!=null&&(r.uint32(18),r.bytes(t.value)),t.author!=null&&(r.uint32(26),r.bytes(t.author)),t.signature!=null&&(r.uint32(34),r.bytes(t.signature)),t.timeReceived!=null&&(r.uint32(42),r.string(t.timeReceived)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.key=t.bytes();break}case 2:{i.value=t.bytes();break}case 3:{i.author=t.bytes();break}case 4:{i.signature=t.bytes();break}case 5:{i.timeReceived=t.string();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})($9||($9={}));var lt;(function(n){n.PUT_VALUE="PUT_VALUE",n.GET_VALUE="GET_VALUE",n.ADD_PROVIDER="ADD_PROVIDER",n.GET_PROVIDERS="GET_PROVIDERS",n.FIND_NODE="FIND_NODE",n.PING="PING"})(lt||(lt={}));var Kf;(function(n){n[n.PUT_VALUE=0]="PUT_VALUE",n[n.GET_VALUE=1]="GET_VALUE",n[n.ADD_PROVIDER=2]="ADD_PROVIDER",n[n.GET_PROVIDERS=3]="GET_PROVIDERS",n[n.FIND_NODE=4]="FIND_NODE",n[n.PING=5]="PING"})(Kf||(Kf={}));(function(n){n.codec=()=>Ds(Kf)})(lt||(lt={}));var ll;(function(n){n.NOT_CONNECTED="NOT_CONNECTED",n.CONNECTED="CONNECTED",n.CAN_CONNECT="CAN_CONNECT",n.CANNOT_CONNECT="CANNOT_CONNECT"})(ll||(ll={}));var nm;(function(n){n[n.NOT_CONNECTED=0]="NOT_CONNECTED",n[n.CONNECTED=1]="CONNECTED",n[n.CAN_CONNECT=2]="CAN_CONNECT",n[n.CANNOT_CONNECT=3]="CANNOT_CONNECT"})(nm||(nm={}));(function(n){n.codec=()=>Ds(nm)})(ll||(ll={}));var Ta;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.id!=null&&t.id.byteLength>0&&(r.uint32(10),r.bytes(t.id)),t.multiaddrs!=null)for(const i of t.multiaddrs)r.uint32(18),r.bytes(i);t.connection!=null&&(r.uint32(24),ll.codec().encode(t.connection,r)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={id:Fe(0),multiaddrs:[]},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.id=t.bytes();break}case 2:{if(s.limits?.multiaddrs!=null&&i.multiaddrs.length===s.limits.multiaddrs)throw new qr('Decode error - map field "multiaddrs" had too many elements');i.multiaddrs.push(t.bytes());break}case 3:{i.connection=ll.codec().decode(t);break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Ta||(Ta={}));var Oa;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.type!=null&&Kf[t.type]!==0&&(r.uint32(8),lt.codec().encode(t.type,r)),t.clusterLevel!=null&&(r.uint32(80),r.int32(t.clusterLevel)),t.key!=null&&(r.uint32(18),r.bytes(t.key)),t.record!=null&&(r.uint32(26),r.bytes(t.record)),t.closer!=null)for(const i of t.closer)r.uint32(66),Ta.codec().encode(i,r);if(t.providers!=null)for(const i of t.providers)r.uint32(74),Ta.codec().encode(i,r);s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={type:lt.PUT_VALUE,closer:[],providers:[]},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 1:{i.type=lt.codec().decode(t);break}case 10:{i.clusterLevel=t.int32();break}case 2:{i.key=t.bytes();break}case 3:{i.record=t.bytes();break}case 8:{if(s.limits?.closer!=null&&i.closer.length===s.limits.closer)throw new qr('Decode error - map field "closer" had too many elements');i.closer.push(Ta.codec().decode(t,t.uint32(),{limits:s.limits?.closer$}));break}case 9:{if(s.limits?.providers!=null&&i.providers.length===s.limits.providers)throw new qr('Decode error - map field "providers" had too many elements');i.providers.push(Ta.codec().decode(t,t.uint32(),{limits:s.limits?.providers$}));break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(Oa||(Oa={}));function z9(n,e={}){const t={...n,name:"SEND_QUERY",type:0,messageName:n.type,messageType:n.type};return e.onProgress?.(new CustomEvent("kad-dht:query:send-query",{detail:t})),t}function rm(n,e={}){const t={...n,name:"PEER_RESPONSE",type:1,messageName:n.messageType,closer:n.closer??[],providers:n.providers??[]};return e.onProgress?.(new CustomEvent("kad-dht:query:peer-response",{detail:t})),t}function W2(n,e={}){const t={...n,name:"FINAL_PEER",type:2};return e.onProgress?.(new CustomEvent("kad-dht:query:final-peer",{detail:t})),t}function cl(n,e={}){const t={...n,name:"QUERY_ERROR",type:3};return e.onProgress?.(new CustomEvent("kad-dht:query:query-error",{detail:t})),t}function H9(n,e={}){const t={...n,name:"PROVIDER",type:4};return e.onProgress?.(new CustomEvent("kad-dht:query:provider",{detail:t})),t}function sm(n,e={}){const t={...n,name:"VALUE",type:5};return e.onProgress?.(new CustomEvent("kad-dht:query:value",{detail:t})),t}function K9(n,e={}){const t={...n,name:"DIAL_PEER",type:7};return e.onProgress?.(new CustomEvent("kad-dht:query:dial-peer",{detail:t})),t}function bq(n,e={}){const t={...n,name:"PATH_ENDED",type:8};return e.onProgress?.(new CustomEvent("kad-dht:query:path-ended",{detail:t})),t}function xq(n,e,t){if(t.length===0)throw new Ae("No records given");const s=pe(e).split("/");if(s.length<3)throw new Ae("Record key does not have a selector function");const i=n[s[1].toString()];if(i==null)throw new vq(`No selector function configured for key type "${s[1]}"`);return t.length===1?0:i(e,t)}function Sq(n,e){return 0}const Eq={pk:Sq};async function J3(n,e,t){const r=e.key,i=pe(r).split("/");if(i.length<3)return;const a=n[i[1].toString()];if(a==null)throw new Ae(`No validator available for key type "${i[1]}"`);await a(r,e.value,t)}const Cq=async(n,e,t)=>{if(!(n instanceof Uint8Array))throw new Ae('"key" must be a Uint8Array');if(n.byteLength<5)throw new Ae("Invalid public key record");if(pe(n.subarray(0,4))!=="/pk/")throw new Ae("key was not prefixed with /pk/");const s=Do(e),i=n.slice(4);if(!Ve(i,s.toMultihash().bytes))throw new Ae("public key does not match passed in key")},kq={pk:Cq},Aq=we("/pk/");function Pq(n){return{...n,multiaddrs:n.multiaddrs.filter(e=>{const[[t,r]]=e.stringTuples();if(t===53||t===54||t===55)return r!=="localhost";if(t!==4&&t!==6||r==null)return!1;const s=bl(r);return s==null?!0:!s})}}async function vu(n,e){const t=await mn.digest(n);return e?.signal?.throwIfAborted(),t.digest}async function Ps(n,e){return vu(n.toMultihash().bytes,e)}function Hc(n,e){return new zt(`${n}/${pe(e,"base32")}`,!1)}function Tq(n){return Cs([Aq,n.toMultihash().bytes])}function _q(n){return pe(n.subarray(0,4))==="/pk/"}function Dq(n){const e=jn(n.subarray(4));return Xr(e)}function q9(n,e){const t=new Date;return new rr(n,e,t).serialize()}const Iq=290,Nq=54,Mq=55,Rq=56,Lq=4,Oq=41;function Bq(n){const e=n.stringTuples();for(const t of e)if(t[0]===Iq)return!1;if(e[0][0]===Nq||e[0][0]===Mq||e[0][0]===Rq)return!0;if(e[0][0]===Lq||e[0][0]===Oq){const t=bl(`${e[0][1]}`);return t==null||!t}return!1}function AC(n){const e=n.toString().split("/"),t=e.pop(),r=e.pop();if(t==null||r==null)throw new Error(`incorrectly formatted provider entry key in datastore: ${n.toString()}`);return{cid:Be.createV1(XM,jn(we(r,"base32"))),peerId:sr(t)}}function G2(n,e,t){const r=typeof e=="string"?e:pe(e.multihash.bytes,"base32"),s=[n,r];return t!=null&&s.push(t.toString()),new zt(s.join("/"))}function PC(n){return new Date(_o(n))}function ya(n,e,t){return async function*(...r){const s=e.queryTime?.timer(t),i=e.errorTime?.timer(t);let a=!1;try{e.queries?.increment({[t]:!0}),yield*n(...r)}catch(c){throw a=!0,i?.(),e.errors?.increment({[t]:!0}),c}finally{e.queries?.decrement({[t]:!0}),a||s?.()}}}function TC(n,e,t){return async function(...r){const s=e?.queryTime?.timer(t),i=e?.errorTime?.timer(t);let a=!1;try{return e.queries?.increment({[t]:!0}),await n(...r)}catch(c){throw a=!0,i?.(),e.errors?.increment({[t]:!0}),c}finally{e.queries?.decrement({[t]:!0}),a||s?.()}}}class Fq{log;components;validators;selectors;peerRouting;queryManager;network;datastorePrefix;constructor(e,t){const{validators:r,selectors:s,peerRouting:i,queryManager:a,network:c,logPrefix:u}=t;this.components=e,this.log=e.logger.forComponent(`${u}:content-fetching`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r,this.selectors=s,this.peerRouting=i,this.queryManager=a,this.network=c,this.get=e.metrics?.traceFunction("libp2p.kadDHT.get",this.get.bind(this),{optionsIndex:1})??this.get,this.put=e.metrics?.traceFunction("libp2p.kadDHT.put",this.put.bind(this),{optionsIndex:2})??this.put}async getLocal(e,t){this.log("getLocal %b",e);const r=Hc(this.datastorePrefix,e);this.log("fetching record for key %k",r);const s=await this.components.datastore.get(r,t);this.log("found %k in local datastore",r);const i=rr.deserialize(s);return await J3(this.validators,i,t),i}async*sendCorrectionRecord(e,t,r,s){this.log("sendCorrection for %b",e);const i=q9(e,r);for(const{value:a,from:c}of t){if(Ve(a,r)){this.log("record was ok");continue}if(this.components.peerId.equals(c)){try{const f=Hc(this.datastorePrefix,e);this.log(`Storing corrected record for key ${f.toString()}`),await this.components.datastore.put(f,i.subarray(),s)}catch(f){this.log.error("Failed error correcting self",f)}continue}let u=!1;const h={type:lt.PUT_VALUE,key:e,record:i};for await(const f of this.network.sendRequest(c,h,s))f.name==="PEER_RESPONSE"&&f.record!=null&&Ve(f.record.value,rr.deserialize(i).value)&&(u=!0),yield f;if(!u)throw new Hf("Could not send correction");this.log.error("Failed error correcting entry")}}async*put(e,t,r){this.log("put key %b value %b",e,t);const s=q9(e,t),i=Hc(this.datastorePrefix,e);this.log(`storing record for key ${i.toString()}`),await this.components.datastore.put(i,s.subarray(),r),yield*I1(this.peerRouting.getClosestPeers(e,{...r,signal:r.signal}),a=>X3(a,c=>async()=>{if(c.name!=="FINAL_PEER")return[c];const u=[],h={type:lt.PUT_VALUE,key:e,record:s};this.log("send put to %p",c.peer.id);for await(const f of this.network.sendRequest(c.peer.id,h,{...r,path:c.path}))u.push(f),f.name==="PEER_RESPONSE"&&(f.record!=null&&Ve(f.record.value,rr.deserialize(s).value)||u.push(cl({from:c.peer.id,error:new Hf("Value not put correctly"),path:f.path},r)));return u}),a=>E3(a,{ordered:!1,concurrency:O1}),async function*(a){for await(const c of a)yield*c})}async*get(e,t){this.log("get %b",e);const r=[];for await(const c of this.getMany(e,t)){if(c.name==="VALUE"){r.push(c);continue}yield c}if(r.length===0)return;const s=r.map(c=>c.value);let i=0;try{i=xq(this.selectors,e,s)}catch(c){if(c.name!=="InvalidParametersError")throw c}const a=s[i];if(this.log("GetValue %b %b",e,a),a==null)throw new Si("Best value was not found");yield*this.sendCorrectionRecord(e,r,a,{...t,path:{index:-1,queued:0,running:0,total:0}}),yield r[i]}async*getMany(e,t={}){this.log("getMany values for %b",e);try{const i=await this.getLocal(e,t);yield sm({value:i.value,from:this.components.peerId,path:{index:-1,running:0,queued:0,total:0}},t)}catch(i){this.log("error getting local value for %b",e,i)}const r=this,s=async function*({peer:i,signal:a,path:c}){for await(const u of r.peerRouting.getValueOrPeers(i.id,e,{...t,signal:a,path:c}))yield u,u.name==="PEER_RESPONSE"&&u.record!=null&&(yield sm({from:i.id,value:u.record.value,path:c},t))};yield*this.queryManager.run(e,s,t)}}function Uq(n,e){return{id:n.id.toMultihash().bytes,multiaddrs:(n.multiaddrs??[]).map(r=>r.bytes),connection:e}}function Oh(n){if(n.id==null)throw new Error("Invalid peer in message");const e=jn(n.id);return{id:Xr(e),multiaddrs:(n.multiaddrs??[]).map(t=>Pe(t))}}class Vq{log;components;network;peerRouting;queryManager;routingTable;providers;constructor(e,t){const{network:r,peerRouting:s,queryManager:i,routingTable:a,providers:c,logPrefix:u}=t;this.components=e,this.log=e.logger.forComponent(`${u}:content-routing`),this.network=r,this.peerRouting=s,this.queryManager=i,this.routingTable=a,this.providers=c,this.findProviders=e.metrics?.traceFunction("libp2p.kadDHT.findProviders",this.findProviders.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,f)=>(h.name==="PROVIDER"&&(f.providers??=[],f.providers.push(...h.providers.map(p=>p.id.toString()))),f)})??this.findProviders,this.provide=e.metrics?.traceFunction("libp2p.kadDHT.provide",this.provide.bind(this),{optionsIndex:1,getAttributesFromYieldedValue:(h,f)=>(h.name==="PEER_RESPONSE"&&h.messageName==="ADD_PROVIDER"&&(f.providers??=[],f.providers.push(h.from.toString())),f)})??this.provide}async*provide(e,t,r={}){this.log("provide %s",e);const s=e.multihash.bytes;await this.providers.addProvider(e,this.components.peerId,r);const i={type:lt.ADD_PROVIDER,key:s,providers:[Uq({id:this.components.peerId,multiaddrs:t})]};let a=0;const c=this;async function*u(p){try{c.log("sending provider record for %s to %p",e,p.peer.id);for await(const m of c.network.sendMessage(p.peer.id,i,{...r,path:p.path}))m.name==="PEER_RESPONSE"&&(c.log("sent provider record for %s to %p",e,p.peer.id),a++),yield m}catch(m){c.log.error("error sending provide record to peer %p",p.peer.id,m),yield cl({from:p.peer.id,error:m,path:p.path},r)}}const h=_i({objectMode:!0}),f=new qu({concurrency:O1});f.addEventListener("idle",()=>{h.end()}),f.addEventListener("error",p=>{this.log.error("error publishing provider record to peer - %e",p)}),f.add(async()=>{const p=[];for await(const m of this.peerRouting.getClosestPeers(s,r))h.push(m),m.name==="FINAL_PEER"&&p.push(m);p.forEach(m=>{f.add(async()=>{for await(const w of u(m))h.push(w)}).catch(w=>{this.log.error("error publishing provider record to peer - %e",w)})})}).catch(p=>{h.end(p)}),yield*h,this.log("sent provider records to %d peers",a)}async*findProviders(e,t){const r=this.routingTable.kBucketSize;let s=0;const i=e.multihash.bytes,a=this;this.log("findProviders %c",e);const c=await this.providers.getProviders(e,t);if(c.length>0){const f=[];for(const p of c.slice(0,r))try{const m=await this.components.peerStore.get(p,t);f.push({id:p,multiaddrs:m.addresses.map(({multiaddr:w})=>w)})}catch(m){if(m.name!=="NotFoundError")throw m;this.log("no peer store entry for %p",p)}if(yield rm({from:this.components.peerId,messageType:lt.GET_PROVIDERS,providers:f,path:{index:-1,queued:0,running:0,total:0}},t),yield H9({from:this.components.peerId,providers:f,path:{index:-1,queued:0,running:0,total:0}},t),s+=f.length,s>=r)return}const u=async function*({peer:f,signal:p,path:m}){const w={type:lt.GET_PROVIDERS,key:i};yield*a.network.sendRequest(f.id,w,{...t,signal:p,path:m})},h=new bs(c);for await(const f of this.queryManager.run(i,u,t))if(yield f,f.name==="PEER_RESPONSE"){this.log("Found %d provider entries for %c and %d closer peers",f.providers.length,e,f.closer.length);const p=[];for(const m of f.providers)h.has(m.id)||(h.add(m.id),p.push(m));if(p.length>0&&(yield H9({from:f.from,providers:p,path:f.path},t),s+=p.length,s>=r))return}}}class jq extends ln{log;protocol;running;components;timeout;metrics;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:network`),this.running=!1,this.protocol=t.protocol,this.timeout=new hu({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_network_message_send_times_milliseconds`}),this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_outbound_rpc_errors_total`)},this.sendRequest=e.metrics?.traceFunction("libp2p.kadDHT.sendRequest",this.sendRequest.bind(this),{optionsIndex:2,getAttributesFromArgs([r,s],i){return{...i,to:r.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(r,s)=>(r.name==="PEER_RESPONSE"&&(r.providers.length>0&&r.providers.forEach((i,a)=>{s[`providers-${a}`]=i.id.toString()}),r.closer.length>0&&r.closer.forEach((i,a)=>{s[`closer-${a}`]=i.id.toString()})),s)})??this.sendRequest,this.sendMessage=e.metrics?.traceFunction("libp2p.kadDHT.sendMessage",this.sendMessage.bind(this),{optionsIndex:2,getAttributesFromArgs([r,s],i){return{...i,to:r.toString(),"message type":`${s.type}`}},getAttributesFromYieldedValue:(r,s)=>(r.name==="PEER_RESPONSE"&&(r.providers.length>0&&r.providers.forEach((i,a)=>{s[`providers-${a}`]=i.id.toString()}),r.closer.length>0&&r.closer.forEach((i,a)=>{s[`closer-${a}`]=i.id.toString()})),s)})??this.sendMessage}async start(){this.running||(this.running=!0)}async stop(){this.running=!1}isStarted(){return this.running}async*sendRequest(e,t,r){if(!this.running)return;const s=t.type;if(s==null)throw new Ae("Message type was missing");let i;const a=this.timeout.getTimeoutSignal(r);r={...r,signal:a};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield K9({peer:e,path:r.path},r),i=await(await this.components.connectionManager.openConnection(e,r)).newStream(this.protocol,r),this.log("sending %s to %p",t.type,e),yield z9({to:e,type:s,path:r.path},r);const u=await this._writeReadMessage(i,t,r);i.close(r).catch(h=>{this.log.error("error closing stream to %p",e,h),i?.abort(h)}),yield rm({from:e,messageType:u.type,closer:u.closer.map(Oh),providers:u.providers.map(Oh),record:u.record==null?void 0:rr.deserialize(u.record),path:r.path},r)}catch(c){this.metrics.errors?.increment({[s]:!0}),i?.abort(c),r.signal?.aborted!==!0&&this.log.error("could not send %s to %p - %e",t.type,e,c),yield cl({from:e,error:c,path:r.path},r)}finally{this.timeout.cleanUp(a)}}async*sendMessage(e,t,r){if(!this.running)return;const s=t.type;if(s==null)throw new Ae("Message type was missing");let i;const a=this.timeout.getTimeoutSignal(r);r={...r,signal:a};try{this.metrics.operations?.increment({[s]:!0}),this.log("dialling %p",e),yield K9({peer:e,path:r.path},r),i=await(await this.components.connectionManager.openConnection(e,r)).newStream(this.protocol,r),this.log("sending %s to %p",t.type,e),yield z9({to:e,type:s,path:r.path},r),await this._writeMessage(i,t,r),i.close(r).catch(u=>{this.log.error("error closing stream to %p",e,u),i?.abort(u)}),yield rm({from:e,messageType:s,path:r.path},r)}catch(c){this.metrics.errors?.increment({[s]:!0}),i?.abort(c),yield cl({from:e,error:c,path:r.path},r)}finally{this.timeout.cleanUp(a)}}async _writeMessage(e,t,r){await Wr(e).write(t,Oa,r)}async _writeReadMessage(e,t,r){const s=Wr(e);await s.write(t,Oa,r);const i=await s.read(Oa,r);return i.closer.forEach(a=>{this.safeDispatchEvent("peer",{detail:Oh(a)})}),i.providers.forEach(a=>{this.safeDispatchEvent("peer",{detail:Oh(a)})}),i}}function Kc(n,e){if(n.byteLength!==e.byteLength)throw new Error("Inputs should have the same length");for(let t=0;t<n.byteLength;t++)if(n[t]!==e[t])return n[t]<e[t]?-1:1;return 0}class Z3{originDhtKey;capacity;peerDistances;constructor(e,t){this.originDhtKey=e,this.capacity=t,this.peerDistances=[]}get length(){return this.peerDistances.length}get peers(){return[...this.peerDistances]}async add(e,t={index:-1,queued:0,running:0,total:0},r){const s=await Ps(e.id,r);this.addWithKadId(e,s,t)}addWithKadId(e,t,r={index:-1,queued:0,running:0,total:0}){if(this.peerDistances.find(a=>a.peer.id.equals(e.id))!=null)return;const s={peer:e,distance:el(this.originDhtKey,t),path:r};if(this.peerDistances.length===this.capacity){const a=this.peerDistances[this.peerDistances.length-1];if(a!=null&&Kc(s.distance,a.distance)!==-1)return}let i=!1;for(let a=0;a<this.peerDistances.length;a++){const c=Kc(this.peerDistances[a].distance,s.distance);if(c===0||c===1){i=!0,this.peerDistances.splice(a,0,s);break}}i||this.peerDistances.push(s),this.peerDistances=this.peerDistances.slice(0,this.capacity)}async isCloser(e,t){if(this.length===0)return!0;const r=await Ps(e,t),s=el(r,this.originDhtKey),i=this.peerDistances[this.peerDistances.length-1].distance;return Kc(s,i)===-1}async anyCloser(e,t){return e.length===0?!1:Promise.any(e.map(async r=>this.isCloser(r,t)))}}class $q{log;routingTable;network;validators;queryManager;components;constructor(e,t){this.routingTable=t.routingTable,this.network=t.network,this.validators=t.validators,this.queryManager=t.queryManager,this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:peer-routing`),this.findPeer=e.metrics?.traceFunction("libp2p.kadDHT.findPeer",this.findPeer.bind(this),{optionsIndex:1})??this.findPeer,this.getClosestPeers=e.metrics?.traceFunction("libp2p.kadDHT.getClosestPeers",this.getClosestPeers.bind(this),{optionsIndex:1})??this.getClosestPeers}async findPeerLocal(e,t){let r;const s=await this.routingTable.find(e,t);if(s!=null){this.log("findPeerLocal found %p in routing table",e);try{r=await this.components.peerStore.get(s,t)}catch(i){if(i.name!=="NotFoundError")throw i}}if(r==null)try{r=await this.components.peerStore.get(e,t)}catch(i){if(i.name!=="NotFoundError")throw i}if(r!=null)return this.log("findPeerLocal found %p in peer store",e),{id:r.id,multiaddrs:r.addresses.map(i=>i.multiaddr)}}async*_getValueSingle(e,t,r){const s={type:lt.GET_VALUE,key:t};yield*this.network.sendRequest(e,s,r)}async*getPublicKeyFromNode(e,t={}){const r=Tq(e),s={index:-1,queued:0,running:0,total:0};for await(const i of this._getValueSingle(e,r,{...t,path:s}))if(yield i,i.name==="PEER_RESPONSE"&&i.record!=null){const a=Do(i.record.value),c=v1(a);if(!c.equals(e))throw new lf("public key does not match id");if(c.publicKey==null)throw new lf("public key missing");yield sm({from:e,value:i.record.value,path:s},t)}throw new Hf(`Node not responding with its public key: ${e.toString()}`)}async*findPeer(e,t={}){if(this.log("findPeer %p",e),t.useCache!==!1){const s=await this.findPeerLocal(e,t);if(s!=null){this.log("found local"),yield W2({from:this.components.peerId,peer:s,path:{index:-1,queued:0,running:0,total:0}},t);return}}let r=!1;if(t.useNetwork!==!1){const s=this,i=async function*({peer:a,signal:c,path:u}){const h={type:lt.FIND_NODE,key:e.toMultihash().bytes};for await(const f of s.network.sendRequest(a.id,h,{...t,signal:c,path:u}))if(yield f,f.name==="PEER_RESPONSE"){const p=f.closer.find(m=>m.id.equals(e));p!=null&&(yield W2({from:f.from,peer:p,path:f.path},t))}};for await(const a of this.queryManager.run(e.toMultihash().bytes,i,t))a.name==="FINAL_PEER"&&(r=!0),yield a}if(!r)throw new Si("Not found")}async*getClosestPeers(e,t={}){this.log("getClosestPeers to %b",e);const r=await vu(e,t),s=new Z3(r,this.routingTable.kBucketSize),i=this,a=async function*({peer:c,path:u,peerKadId:h,signal:f}){i.log("getClosestPeers asking %p",c.id);const p={type:lt.FIND_NODE,key:e};yield*i.network.sendRequest(c.id,p,{...t,signal:f,path:u}),s.addWithKadId(c,h,u)};yield*this.queryManager.run(e,a,t),this.log("found %d peers close to %b",s.length,e);for(let{peer:c,path:u}of s.peers)try{if(c.multiaddrs.length===0&&(c=await i.components.peerStore.getInfo(c.id,t)),c.multiaddrs.length===0)continue;yield W2({from:this.components.peerId,peer:await i.components.peerStore.getInfo(c.id,t),path:{index:u.index,queued:0,running:0,total:0}},t)}catch{continue}}async*getValueOrPeers(e,t,r){for await(const s of this._getValueSingle(e,t,r)){if(s.name==="PEER_RESPONSE"&&s.record!=null)try{await this._verifyRecordOnline(s.record,r)}catch{const a="invalid record received, discarded";this.log(a),yield cl({from:s.from,error:new Hf(a),path:r.path},r);continue}yield s}}async _verifyRecordOnline(e,t){if(e.timeReceived==null)throw new wq("invalid record received");await J3(this.validators,new rr(e.key,e.value,e.timeReceived),t)}async getClosestPeersOffline(e,t){const r=[];try{const a=jn(e),c=Xr(a),u=await this.components.peerStore.get(c,t);r.push({id:u.id,multiaddrs:u.addresses.map(({multiaddr:h})=>h)})}catch{}const s=await vu(e,t),i=this.routingTable.closestPeers(s,t);for(const a of i)try{r.push(await this.components.peerStore.getInfo(a,t))}catch(c){if(c.name!=="NotFoundError")throw c}return r.length>0?this.log("getClosestPeersOffline returning the %d closest peer(s) %b we know",r.length,e):this.log("getClosestPeersOffline could not any peers close to %b with %d peers in the routing table",e,this.routingTable.size),r}}class zq{log;datastore;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:providers`),this.datastorePrefix=`${t.datastorePrefix}/provider`,this.datastore=e.datastore}async addProvider(e,t,r){this.log.trace("%p provides %s",t,e),await this.writeProviderEntry(e,t,r)}async removeProvider(e,t,r){const s=G2(this.datastorePrefix,e,t);this.log.trace("%p no longer provides %s",t,e),await this.datastore.delete(s,r)}async getProviders(e,t){this.log.trace("get providers for %c",e);const r=await this.loadProviders(e,t);return this.log.trace("got %d providers for %c",r.size,e),[...r.keys()]}async writeProviderEntry(e,t,r){const s=G2(this.datastorePrefix,e,t),i=mi(r?.time?.getTime()??Date.now());await this.datastore.put(s,i,r)}async loadProviders(e,t){const r=new Mo,s=G2(this.datastorePrefix,e);for await(const i of this.datastore.query({prefix:s.toString()},t)){const{peerId:a}=AC(i.key);r.set(a,PC(i.value))}return r}}const Hq=n=>{const e=n.addEventListener||n.on||n.addListener,t=n.removeEventListener||n.off||n.removeListener;if(!e||!t)throw new TypeError("Emitter is not compatible");return{addListener:e.bind(n),removeListener:t.bind(n)}};function Kq(n,e,t){let r;const s=new Promise((i,a)=>{if(t={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...t},!(t.count>=0&&(t.count===Number.POSITIVE_INFINITY||Number.isInteger(t.count))))throw new TypeError("The `count` option should be at least 0 or more");t.signal?.throwIfAborted();const c=[e].flat(),u=[],{addListener:h,removeListener:f}=Hq(n),p=(...w)=>{const x=t.multiArgs?w:w[0];t.filter&&!t.filter(x)||(u.push(x),t.count===u.length&&(r(),i(u)))},m=w=>{r(),a(w)};r=()=>{for(const w of c)f(w,p);for(const w of t.rejectionEvents)f(w,m)};for(const w of c)h(w,p);for(const w of t.rejectionEvents)h(w,m);t.signal&&t.signal.addEventListener("abort",()=>{m(t.signal.reason)},{once:!0}),t.resolveImmediately&&i(u)});if(s.cancel=r,typeof t.timeout=="number"){const i=x1(s,{milliseconds:t.timeout});return i.cancel=r,i}return s}function qq(n,e,t){typeof t=="function"&&(t={filter:t}),t={...t,count:1,resolveImmediately:!1};const r=Kq(n,e,t),s=r.then(i=>i[0]);return s.cancel=r.cancel,s}async function*Wq(n){const{key:e,startingPeers:t,ourPeerId:r,query:s,alpha:i,path:a,numPaths:c,log:u,peersSeen:h,connectionManager:f,signal:p}=n,m=_i({objectMode:!0}),w=new qu({concurrency:i,sort:(E,A)=>Kc(E.options.distance,A.options.distance)});w.addEventListener("idle",()=>{m.push(bq({path:{index:a,queued:w.queued,running:w.running,total:w.size}},n)),m.end()}),w.addEventListener("error",E=>{u.error("error during query - %e",E.detail)});const x=()=>{w.abort(),m.end(new xi)};p.addEventListener("abort",x);try{let A=function(P,k){if(P==null)return;h.add(P.id.toMultihash().bytes);const F=el(k,E);w.add(async()=>{try{for await(const I of s({...n,key:e,peer:P,path:{index:a,queued:w.queued,running:w.running,total:w.size},numPaths:c,peerKadId:k,signal:p})){if(I.name==="PEER_RESPONSE")for(const V of I.closer){if(h.has(V.id.toMultihash().bytes)){u("already seen %p in query",V.id);continue}if(r.equals(V.id)){u("not querying ourselves");continue}if(!await f.isDialable(V.multiaddrs)){u("not querying undialable peer");continue}const Q=await Ps(V.id,{signal:p}),D=el(Q,E);if(Kc(D,F)!==-1){u("skipping %p as they are not closer to %b than %p",V.id,e,P);continue}u("querying closer peer %p",V.id),A(V,Q)}m.push({...I,path:{index:a,queued:w.queued,running:w.running,total:w.size}})}}catch(I){m.push(cl({from:P.id,error:I,path:{index:a,queued:w.queued,running:w.running-1,total:w.size-1}},n))}},{distance:F}).catch(I=>{u.error("error during query - %e",I)})};var S=A;const E=await vu(e,{signal:p});await Promise.all(t.map(async P=>{A({id:P,multiaddrs:[]},await Ps(P,{signal:p}))})),yield*m}finally{p.removeEventListener("abort",x)}}class Gq{disjointPaths;alpha;shutDownController;running;logger;peerId;connectionManager;routingTable;initialQuerySelfHasRun;logPrefix;allowQueryWithZeroPeers;constructor(e,t){this.logPrefix=t.logPrefix,this.disjointPaths=t.disjointPaths??kC,this.alpha=t.alpha??O1,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.routingTable=t.routingTable,this.logger=e.logger,this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.allowQueryWithZeroPeers=t.allowQueryWithZeroPeers??!1,this.shutDownController=new AbortController,this.shutDownController.signal,this.running=!1}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutDownController=new AbortController,this.shutDownController.signal,void 0)}async stop(){this.running=!1,this.shutDownController.abort()}async*run(e,t,r={}){if(!this.running)throw new Error("QueryManager not started");if(r.signal==null){const u=AbortSignal.timeout(pq);r={...r,signal:u}}const s=new AbortController,i=An([this.shutDownController.signal,s.signal,r.signal]);s.signal;const a=this.logger.forComponent(`${this.logPrefix}:query:`+pe(e,"base58btc"));let c=!1;try{this.routingTable.size===0&&!this.allowQueryWithZeroPeers&&(a("routing table was empty, waiting for some peers before running%s query",r.isSelfQuery===!0?" self":""),await qq(this.routingTable,"peer:add",{signal:i,filter:w=>!this.peerId.equals(w.detail)}),a("routing table has peers, continuing with%s query",r.isSelfQuery===!0?" self":"")),r.isSelfQuery!==!0&&this.initialQuerySelfHasRun!=null&&(a("waiting for initial self query before continuing"),await Dt(this.initialQuerySelfHasRun.promise,i),this.initialQuerySelfHasRun=void 0),a("query:start");const u=await vu(e,{signal:i}),h=this.routingTable.closestPeers(u,{count:this.routingTable.kBucketSize}),f=h.sort(()=>Math.random()>.5?1:-1).reduce((w,x,S)=>(w[S%this.disjointPaths].push(x),w),new Array(this.disjointPaths).fill(0).map(()=>[])).filter(w=>w.length>0);if(h.length===0){a.error("running query with no peers");return}const p=Xa(1024),m=f.map((w,x)=>Wq({...r,key:e,startingPeers:w,ourPeerId:this.peerId,signal:i,query:t,path:x,numPaths:f.length,alpha:this.alpha,log:a,peersSeen:p,onProgress:r.onProgress,connectionManager:this.connectionManager}));for await(const w of fu(...m)){if(w.name==="QUERY_ERROR"&&a.error("query error",w.error),w.name==="PEER_RESPONSE")for(const x of[...w.closer,...w.providers])await this.connectionManager.isDialable(x.multiaddrs,{signal:i})&&await this.routingTable.add(x.id,{signal:i});i.throwIfAborted(),yield w}c=!0}catch(u){if(this.running)throw u}finally{c||(a("query exited early"),s.abort()),i.clear(),a("query finished")}}}function Qq(n){return n[Symbol.asyncIterator]!=null}function _C(n){if(Qq(n))return(async()=>{let e=0;for await(const t of n)e++;return e})();{let e=0;for(const t of n)e++;return e}}class Yq{log;peerId;peerRouting;events;count;interval;initialInterval;queryTimeout;running;timeoutId;controller;initialQuerySelfHasRun;querySelfPromise;constructor(e,t){this.peerId=e.peerId,this.log=e.logger.forComponent(`${t.logPrefix}:query-self`),this.events=e.events,this.running=!1,this.peerRouting=t.peerRouting,this.count=t.count??kC,this.interval=t.interval??cq,this.initialInterval=t.initialInterval??uq,this.queryTimeout=t.queryTimeout??dq,this.initialQuerySelfHasRun=t.initialQuerySelfHasRun,this.querySelf=TC(this.querySelf.bind(this),t.operationMetrics,"SELF_QUERY")}isStarted(){return this.running}start(){this.running||(this.running=!0,clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.initialInterval))}stop(){this.running=!1,this.timeoutId!=null&&clearTimeout(this.timeoutId),this.controller!=null&&this.controller.abort()}async querySelf(){if(!this.running){this.log("skip self-query because we are not started");return}if(this.querySelfPromise!=null)return this.log("joining existing self query"),this.querySelfPromise.promise;if(this.querySelfPromise=Ke(),this.running){this.controller=new AbortController;const e=[this.controller.signal];if(this.initialQuerySelfHasRun==null){const r=AbortSignal.timeout(this.queryTimeout);e.push(r)}const t=An(e);this.controller.signal;try{this.log("run self-query, look for %d peers timing out after %dms",this.count,this.queryTimeout);const r=Date.now(),s=await I1(this.peerRouting.getClosestPeers(this.peerId.toMultihash().bytes,{signal:t,isSelfQuery:!0}),a=>Bg(a,this.count),async a=>_C(a));t?.throwIfAborted();const i=Date.now()-r;this.log("self-query found %d peers in %dms",s,i),this.events.dispatchEvent(new CustomEvent("kad-dht:query:self",{detail:{peers:s,duration:i}}))}catch(r){this.log.error("self-query error",r)}finally{t.clear(),this.initialQuerySelfHasRun!=null&&(this.initialQuerySelfHasRun.resolve(),this.initialQuerySelfHasRun=void 0)}}this.querySelfPromise.resolve(),this.querySelfPromise=void 0,this.running&&(this.timeoutId=setTimeout(()=>{this.querySelf().catch(e=>{this.log.error("error running self-query",e)})},this.interval))}}class Xq extends ln{log;reprovideQueue;maxQueueSize;datastore;timeout;reprovideTimeout;running;shutdownController;reprovideThreshold;contentRouting;datastorePrefix;addressManager;validity;interval;peerId;constructor(e,t){super(),this.log=e.logger.forComponent(`${t.logPrefix}:reprovider`),this.peerId=e.peerId,this.reprovideQueue=new qu({concurrency:t.concurrency??iq,metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_queue`}),this.reprovideTimeout=new hu({...t.timeout??{},metrics:e.metrics,metricName:`${t.metricsPrefix}_reprovide_timeout_milliseconds`}),this.datastore=e.datastore,this.addressManager=e.addressManager,this.datastorePrefix=`${t.datastorePrefix}/provider`,this.reprovideThreshold=t.threshold??sq,this.maxQueueSize=t.maxQueueSize??oq,this.validity=t.validity??rq,this.interval=t.interval??aq,this.contentRouting=t.contentRouting,this.running=!1,this.reprovide=TC(this.reprovide.bind(this),t.operationMetrics,"PROVIDE")}start(){this.running||(this.running=!0,this.shutdownController=new AbortController,this.shutdownController.signal,this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(V9)}).catch(e=>{this.log.error("error running reprovide/cleanup - %e",e)})},this.interval))}stop(){this.running=!1,this.reprovideQueue.clear(),clearTimeout(this.timeout),this.shutdownController?.abort()}async cleanUp(e){try{this.safeDispatchEvent("reprovide:start");for await(const t of this.datastore.query({prefix:this.datastorePrefix},e))try{const{cid:r,peerId:s}=AC(t.key),i=PC(t.value).getTime(),a=i+this.validity,c=Date.now(),u=c>a;this.log.trace("comparing: %d < %d = %s %s",i,c-this.validity,u,u?"(expired)":""),u&&await this.datastore.delete(t.key,e),this.peerId.equals(s)&&c-a<this.reprovideThreshold&&this.queueReprovide(r).catch(h=>{this.log.error("could not reprovide %c - %e",r,h)})}catch(r){this.log.error("error processing datastore key %s - %e",t.key,r.message)}this.log("reprovide/cleanup successful")}finally{this.safeDispatchEvent("reprovide:end"),this.running&&(this.timeout=setTimeout(()=>{this.cleanUp({signal:AbortSignal.timeout(V9)}).catch(t=>{this.log.error("error running re-provide - %e",t)})},this.interval))}}async queueReprovide(e,t){if(!this.running)return;this.log.trace("waiting for queue capacity before adding %c to re-provide queue",e),await this.reprovideQueue.onSizeLessThan(this.maxQueueSize,t);const r=this.reprovideQueue.queue.find(s=>s.options.cid.equals(e));if(r!=null)return this.log.trace("not adding %c to re-provide queue - already in queue",e),r.join();this.log.trace("adding %c to re-provide queue",e),this.reprovideQueue.add(async s=>{if(s.signal?.throwIfAborted(),!this.running)return;this.log.trace("re-providing %c",e);const i=this.reprovideTimeout.getTimeoutSignal(s);try{await this.reprovide(s.cid,s)}finally{this.reprovideTimeout.cleanUp(i)}this.log.trace("re-provided %c",e)},{signal:this.shutdownController?.signal,cid:e}).catch(s=>{this.log.error("could not re-provide key %c - %e",e,s)})}async reprovide(e,t){await au(this.contentRouting.provide(e,this.addressManager.getAddresses(),t))}}const Jq=20,Zq=5e3,eW="kad-close",tW=50;class nW{routingTable;components;closestPeers;newPeers;refreshInterval;peerSetSize;timeout;closeTagName;closeTagValue;log;running;constructor(e,t){this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.routingTable=t.routingTable,this.refreshInterval=t.refreshInterval??Zq,this.peerSetSize=t.peerSetSize??Jq,this.closeTagName=t.closeTagName??eW,this.closeTagValue=t.closeTagValue??tW,this.closestPeers=new bs,this.onPeerPing=this.onPeerPing.bind(this),this.running=!1}async start(){if(this.running)return;this.running=!0;const e=await Ps(this.components.peerId);this.newPeers=new Z3(e,this.peerSetSize),this.routingTable.addEventListener("peer:ping",this.onPeerPing),this.timeout=setInterval(()=>{this.updatePeerTags().catch(t=>{this.log.error("error updating peer tags - %e",t)})},this.refreshInterval)}stop(){this.running=!1,this.routingTable.removeEventListener("peer:ping",this.onPeerPing),clearTimeout(this.timeout)}onPeerPing(e){this.newPeers?.add({id:e.detail,multiaddrs:[]}).catch(t=>{this.log.error("error adding peer to distance list - %e",t)})}async updatePeerTags(){const e=new bs(this.newPeers?.peers.map(({peer:s})=>s.id)),t=e.difference(this.closestPeers),r=this.closestPeers.difference(e);this.closestPeers=e,await Promise.all([...[...t].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:{value:this.closeTagValue},[j9]:{value:1}}})}),...[...r].map(async s=>{await this.components.peerStore.merge(s,{tags:{[this.closeTagName]:void 0,[j9]:void 0}})})])}}function Wh(n){return Array.isArray(n?.peers)}class rW{peerId;root;localPeer;prefixLength;splitThreshold;kBucketSize;numberOfNodesToPing;lastPingThreshold;ping;verify;onAdd;onRemove;onMove;addingPeerMap;constructor(e,t){this.peerId=e.peerId,this.prefixLength=t.prefixLength??oW,this.kBucketSize=t.kBucketSize??e4,this.splitThreshold=t.splitThreshold??this.kBucketSize,this.numberOfNodesToPing=t.numberOfOldContactsToPing??cW,this.lastPingThreshold=t.lastPingThreshold??fW,this.ping=t.ping,this.verify=t.verify,this.onAdd=t.onAdd,this.onRemove=t.onRemove,this.addingPeerMap=Tx({name:`${t.metricsPrefix}_adding_peer_map`,metrics:e.metrics}),this.root={prefix:"",depth:0,peers:[]}}async start(){await this.addSelfPeer(this.peerId)}stop(){this.addingPeerMap.clear(),this.root={prefix:"",depth:0,peers:[]}}async addSelfPeer(e,t){this.localPeer={peerId:e,kadId:await Ps(e,t),lastPing:Date.now()}}async add(e,t){const r={peerId:e,kadId:await Ps(e,t),lastPing:0},s=this.addingPeerMap.get(e);if(s!=null)return s;try{const i=this._add(r,t);this.addingPeerMap.set(e,i),await i}finally{this.addingPeerMap.delete(e)}}async _add(e,t){const r=this._determineBucket(e.kadId);if(this._indexOf(r,e.kadId)>-1)return;if(r.peers.length===this.splitThreshold&&r.depth<this.prefixLength){await this._split(r,t),await this._add(e,t);return}if(r.peers.length<this.kBucketSize){if(!iW(e,this.lastPingThreshold)){r.peers.push(e),await this.onAdd?.(e,r,t);return}await this.verify(e,t)&&(e.lastPing=Date.now(),await this._add(e,t));return}const s=r.peers.filter(a=>!(a.peerId.equals(this.localPeer?.peerId)||a.lastPing>Date.now()-this.lastPingThreshold)).sort((a,c)=>a.lastPing<c.lastPing?-1:a.lastPing>c.lastPing?1:0).slice(0,this.numberOfNodesToPing);let i=!1;for await(const a of this.ping(s,t))i=!0,await this.remove(a.kadId,t);i&&await this._add(e,t)}*closest(e,t){const r=new Z3(e,t?.count??this.kBucketSize);for(const s of this.toIterable())t?.exclude?.some(i=>i.equals(s.peerId))!==!0&&r.addWithKadId({id:s.peerId,multiaddrs:[]},s.kadId);yield*X3(r.peers,({peer:s})=>s.id)}count(){function e(t){if(Wh(t))return t.peers.length;let r=0;return t.left!=null&&(r+=e(t.left)),t.right!=null&&(r+=e(t.right)),r}return e(this.root)}get(e){const t=this._determineBucket(e),r=this._indexOf(t,e);return t.peers[r]}async remove(e,t){const r=this._determineBucket(e),s=this._indexOf(r,e);if(s>-1){const i=r.peers.splice(s,1)[0];await this.onRemove?.(i,r,t)}}*toIterable(){function*e(t){if(Wh(t)){yield*t.peers;return}yield*e(t.left),yield*e(t.right)}yield*e(this.root)}distance(e,t){return BigInt("0x"+pe(el(e,t),"base16"))}_determineBucket(e){const t=pe(e,"base2");function r(s,i=0){return Wh(s)?s:t[i]==="0"?r(s.left,i+1):r(s.right,i+1)}return r(this.root)}_indexOf(e,t){return e.peers.findIndex(r=>Ve(r.kadId,t))}async _split(e,t){const r={prefix:"0",depth:e.depth+1,peers:[]},s={prefix:"1",depth:e.depth+1,peers:[]};for(const i of e.peers)pe(i.kadId,"base2")[e.depth]==="0"?(r.peers.push(i),await this.onMove?.(i,e,r,t)):(s.peers.push(i),await this.onMove?.(i,e,s,t));sW(e,r,s)}}function sW(n,e,t){return delete n.peers,n.left=e,n.right=t,n.prefix===""&&(delete n.depth,delete n.prefix),!0}function iW(n,e){return n.lastPing<Date.now()-e}const e4=20,oW=6,aW=20,lW=100,cW=3,uW=20,dW=100,W9="kad-peer",hW=1,fW=6e5,pW=!0,gW=1e3;class mW extends ln{kBucketSize;kb;network;closestPeerTagger;log;components;running;pingNewContactTimeout;pingNewContactQueue;pingOldContactTimeout;pingOldContactQueue;populateFromDatastoreOnStart;populateFromDatastoreLimit;protocol;peerTagName;peerTagValue;metrics;shutdownController;constructor(e,t){super(),this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:routing-table`),this.kBucketSize=t.kBucketSize??e4,this.running=!1,this.protocol=t.protocol,this.network=t.network,this.peerTagName=t.peerTagName??W9,this.peerTagValue=t.peerTagValue??hW,this.pingOldContacts=this.pingOldContacts.bind(this),this.verifyNewContact=this.verifyNewContact.bind(this),this.peerAdded=this.peerAdded.bind(this),this.peerRemoved=this.peerRemoved.bind(this),this.populateFromDatastoreOnStart=t.populateFromDatastoreOnStart??pW,this.populateFromDatastoreLimit=t.populateFromDatastoreLimit??gW,this.shutdownController=new AbortController,this.pingOldContactQueue=new du({concurrency:t.pingOldContactConcurrency??uW,metricName:`${t.metricsPrefix}_ping_old_contact_queue`,metrics:this.components.metrics,maxSize:t.pingOldContactMaxQueueSize??dW}),this.pingOldContactTimeout=new hu({...t.pingOldContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_old_contact_time_milliseconds`}),this.pingNewContactQueue=new du({concurrency:t.pingNewContactConcurrency??aW,metricName:`${t.metricsPrefix}_ping_new_contact_queue`,metrics:this.components.metrics,maxSize:t.pingNewContactMaxQueueSize??lW}),this.pingNewContactTimeout=new hu({...t.pingNewContactTimeout??{},metrics:this.components.metrics,metricName:`${t.metricsPrefix}_routing_table_ping_new_contact_time_milliseconds`}),this.kb=new rW(e,{kBucketSize:t.kBucketSize,prefixLength:t.prefixLength,splitThreshold:t.splitThreshold,numberOfOldContactsToPing:t.numberOfOldContactsToPing,lastPingThreshold:t.lastPingThreshold,ping:this.pingOldContacts,verify:this.verifyNewContact,onAdd:this.peerAdded,onRemove:this.peerRemoved,metricsPrefix:t.metricsPrefix}),this.closestPeerTagger=new nW(this.components,{logPrefix:t.logPrefix,routingTable:this,peerSetSize:t.closestPeerSetSize,refreshInterval:t.closestPeerSetRefreshInterval,closeTagName:t.closeTagName,closeTagValue:t.closeTagValue}),this.components.metrics!=null&&(this.metrics={routingTableSize:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_size`),routingTableKadBucketTotal:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_total`),routingTableKadBucketAverageOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_average_occupancy`),routingTableKadBucketMinOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_min_occupancy`),routingTableKadBucketMaxOccupancy:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_occupancy`),routingTableKadBucketMaxDepth:this.components.metrics.registerMetric(`${t.metricsPrefix}_routing_table_kad_bucket_max_depth`),kadBucketEvents:this.components.metrics.registerCounterGroup(`${t.metricsPrefix}_kad_bucket_events_total`)})}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.shutdownController=new AbortController,await Jc(this.closestPeerTagger,this.kb))}async afterStart(){let e=0;Promise.resolve().then(async()=>{if(!this.populateFromDatastoreOnStart)return;const t=An([this.shutdownController.signal,AbortSignal.timeout(2e4)]);try{for(const r of await this.components.peerStore.all({filters:[s=>s.protocols.includes(this.protocol)&&s.tags.has(W9)],limit:this.populateFromDatastoreLimit,signal:t})){if(!this.running)return;try{await this.add(r.id,{signal:t}),e++}catch{this.log("failed to add peer %p to routing table, removing kad-dht peer tags - %e"),await this.components.peerStore.merge(r.id,{tags:{[this.peerTagName]:void 0}})}}}finally{t.clear()}this.log("added %d peer store peers to the routing table",e)}).catch(t=>{this.log.error("error adding %d, peer store peers to the routing table - %e",e,t)})}async stop(){this.running=!1,await f1(this.closestPeerTagger,this.kb),this.pingOldContactQueue.abort(),this.pingNewContactQueue.abort(),this.shutdownController.abort()}async peerAdded(e,t,r){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:{value:this.peerTagValue}}},r),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_added:!0}),this.safeDispatchEvent("peer:add",{detail:e.peerId})}async peerRemoved(e,t,r){this.components.peerId.equals(e.peerId)||await this.components.peerStore.merge(e.peerId,{tags:{[this.peerTagName]:void 0}},r),this.updateMetrics(),this.metrics?.kadBucketEvents.increment({peer_removed:!0}),this.safeDispatchEvent("peer:remove",{detail:e.peerId})}async*pingOldContacts(e,t){if(!this.running)return;const r=[];for(const s of e){if(this.kb.get(s.kadId)==null){this.log("asked to ping contact %p that was not in routing table",s.peerId);continue}this.metrics?.kadBucketEvents.increment({ping_old_contact:!0}),r.push(async()=>{const i=this.pingOldContactQueue.find(s.peerId);if(i!=null)return this.log("asked to ping contact %p was already being pinged",s.peerId),await i.join(t)?void 0:s;if(!await this.pingOldContactQueue.add(async c=>{const u=this.pingOldContactTimeout.getTimeoutSignal(),h=An([u,this.shutdownController.signal,c?.signal]);try{return await this.pingContact(s,c)}catch{return this.metrics?.kadBucketEvents.increment({ping_old_contact_error:!0}),!0}finally{this.pingOldContactTimeout.cleanUp(u),h.clear()}},{peerId:s.peerId,signal:t?.signal}))return s})}for await(const s of E3(r))s!=null&&(yield s)}async verifyNewContact(e,t){const r=this.pingNewContactTimeout.getTimeoutSignal(),s=An([r,this.shutdownController.signal,t?.signal]);try{const i=this.pingNewContactQueue.find(e.peerId);return i!=null?(this.log("joining existing ping to add new peer %p to routing table",e.peerId),await i.join({signal:s})):await this.pingNewContactQueue.add(async a=>(this.metrics?.kadBucketEvents.increment({ping_new_contact:!0}),this.log("pinging new peer %p before adding to routing table",e.peerId),this.pingContact(e,a)),{peerId:e.peerId,signal:s})}catch{return this.log.trace("tried to add peer %p but they were not online",e.peerId),this.metrics?.kadBucketEvents.increment({ping_new_contact_error:!0}),!1}finally{this.pingNewContactTimeout.cleanUp(r),s.clear()}}async pingContact(e,t){try{return this.log("pinging contact %p",e.peerId),await this.components.ping.ping(e.peerId,t),this.log("contact %p ping ok",e.peerId),this.safeDispatchEvent("peer:ping",{detail:e.peerId}),!0}catch(r){return this.log("error pinging old contact %p - %e",e.peerId,r),!1}}get size(){return this.kb==null?0:this.kb.count()}async find(e,t){const r=await Ps(e,t);return this.kb.get(r)?.peerId}closestPeer(e){const t=this.closestPeers(e,{count:1});if(t.length>0)return t[0]}closestPeers(e,t){return this.kb==null?[]:[...this.kb.closest(e,t)]}async add(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");await this.kb.add(e,t)}async remove(e,t){if(this.kb==null)throw new Error("RoutingTable is not started");const r=await Ps(e,t);await this.kb.remove(r,t)}updateMetrics(){if(this.metrics==null||this.kb==null)return;let e=0,t=0,r=0,s=20,i=0;function a(c){if(Wh(c)){c.depth>r&&(r=c.depth),t++,e+=c.peers.length,c.peers.length<s&&(s=c.peers.length),c.peers.length>i&&(i=c.peers.length);return}a(c.left),a(c.right)}a(this.kb.root),this.metrics.routingTableSize.update(e),this.metrics.routingTableKadBucketTotal.update(t),this.metrics.routingTableKadBucketAverageOccupancy.update(Math.round(e/t)),this.metrics.routingTableKadBucketMinOccupancy.update(s),this.metrics.routingTableKadBucketMaxOccupancy.update(i),this.metrics.routingTableKadBucketMaxDepth.update(r)}}const yW=[77591,22417,43971,28421,740,29829,71467,228973,196661,78537,27689,36431,44415,14362,19456,106025,96308,2882,49509,21149,87173,131409,75844,23676,121838,30291,17492,2953,7564,110620,129477,127283,53113,72417,165166,109690,21200,102125,24049,71504,90342,25307,72039,26812,26715,32264,133800,71161,88956,171987,51779,24425,16671,30251,186294,247761,14202,2121,8465,35024,4876,85917,169730,3638,256836,96184,943,18678,6583,52907,35807,112254,214097,18796,11595,9243,23554,887,268203,382004,24590,111335,11625,16619,29039,102425,69006,97976,92362,32552,63717,41433,128974,137630,59943,10019,13986,35430,33665,108037,43799,43280,38195,29078,58629,18265,14425,46832,235538,40830,77881,110717,58937,3463,325358,51300,47623,117252,19007,10170,20540,91237,294813,4951,79841,56232,36270,128547,69209,66275,100156,32063,73531,34439,80937,28892,44466,88595,216307,32583,49620,16605,82127,45807,21630,78726,20235,40163,111007,96926,5567,72083,21665,58844,39419,179767,48328,42662,51550,5251,37811,49608,81056,50854,55513,20922,18891,197409,164656,32593,71449,220474,58919,85682,67854,13758,35066,3565,61905,214793,119572,141419,21504,10302,27354,67003,46131,32668,15165,64871,34450,17821,2757,11452,34189,5160,12257,85523,560,53385,65887,119549,135620,312353,115979,122356,10867,193231,124537,54783,90675,120791,4715,142253,50943,17271,43358,25331,4917,120566,34580,12878,33786,160528,32523,4869,301307,104817,81491,23276,8832,97911,31265,52065,7998,49622,9715,43998,34091,84587,20664,69041,29419,53205,10838,58288,116145,6185,5154,141795,35924,21307,144738,43730,12085,8279,10002,119,133779,199668,72938,31768,39176,67875,38453,9700,44144,4121,116048,41733,12868,82669,92308,128,34262,11332,7712,90764,36141,13553,71312,77470,117314,96549,49135,23602,54468,28605,6327,62308,17171,67531,21319,14105,894,107722,46157,8503,51069,100472,45138,15246,14577,35609,191464,1757,13364,161349,32067,91705,81144,52339,5408,91066,21983,14157,100545,4372,26630,129112,1423,29676,213626,4397,88436,99190,6877,49958,26122,114348,60661,29818,293118,50042,179738,16400,163423,89627,31040,43973,36638,45952,5153,1894,109322,1898,134021,12402,112077,68309,190269,69866,31938,107383,11522,105232,11248,14868,39852,71707,186525,16530,38162,106212,11700,5130,16608,26998,59586,108399,230033,43683,48135,82179,2073,5015,196684,189293,16378,23452,8301,35640,11632,214551,29240,57644,33137,91949,55157,52384,117313,5090,17717,89668,49363,82238,241035,66216,29066,184088,97206,62820,26595,4241,135635,173672,8202,459,71355,146294,29587,3008,135385,141203,14803,6634,45094,69362,50925,546,51884,62011,83296,234584,44515,56050,89476,87751,19373,12691,149923,19794,13833,35846,87557,58339,2884,19145,25647,12224,11024,77338,64608,122297,53025,7205,36189,36294,170779,21750,7739,173883,75192,35664,224240,113121,30181,26267,27036,117827,92015,106516,55628,203549,67949,60462,60844,35911,20457,1820,920,19773,8738,73173,181993,38521,98254,76257,46008,92796,5384,26868,151566,22124,2411,15919,186872,180021,28099,152961,78811,80237,62352,102653,74259,184890,16792,123702,224945,29940,19512,75283,14059,112691,92811,233329,20411,138569,53341,109802,50600,134528,66747,5529,166531,31578,64732,67189,1596,126357,967,167999,206598,109752,119431,207825,78791,91938,10301,27311,24233,252343,28831,32812,66002,112267,90895,8786,8095,16824,22866,21813,60507,174833,19549,130985,117051,52110,6938,81923,123864,38061,919,18680,53534,46739,112893,161529,85429,26761,11900,81121,91968,15390,217947,56524,1713,6654,37089,85630,138866,61850,16491,75577,16884,98296,73523,6140,44645,6062,36366,29844,57946,37932,42472,5266,20834,19309,33753,127182,134259,35810,41805,45878,312001,14881,47757,49251,120050,44252,3708,25856,107864,120347,1228,36550,41682,34496,47025,8393,173365,246526,12894,161607,35670,90785,126572,2095,124731,157033,58694,554,12786,9642,4817,16136,47864,174698,66992,4639,69284,10625,40710,27763,51738,30404,264105,137904,109882,52487,42824,57514,2740,10479,146799,107390,16586,88038,174951,9410,16185,44158,5568,40658,46108,12763,97385,26175,108859,664,230732,67470,46663,14395,50750,141320,93140,15361,47997,55784,6791,307840,118569,107326,18056,58281,260415,54691,8790,73332,45633,7511,45674,143373,14031,11799,94491,35646,96544,14560,26049,32983,25791,83814,42094,231370,63955,139212,2359,169908,3108,183486,105867,28197,32941,124968,26402,88267,149768,23053,3078,19091,52924,25383,19209,111548,97361,3959,24880,235061,9099,24921,161254,151405,20508,7159,34381,20133,11434,74036,19974,34769,36585,1076,22454,17354,38727,235160,111547,96454,117448,156940,91330,37299,7310,26915,117060,51369,22620,61861,322264,106850,111694,15091,2624,40345,300446,177064,1707,27389,54792,327783,132669,183543,59003,17744,20603,151134,106923,53084,71803,279424,319816,11579,21946,16728,38274,72711,5085,83391,88646,40159,25027,34680,10752,12988,54126,30365,18338,100445,230674,44874,84974,143877,123253,139372,28082,91477,144002,13096,219729,46016,50029,42377,14601,6660,58244,58978,23918,88206,113611,64452,17541,41032,10942,12021,49189,10978,40175,37156,10947,71709,106894,112538,57007,137486,150608,152719,40615,7746,279716,13101,19524,28708,40578,72320,1096,182051,94527,51275,22833,45164,81917,77519,48508,5421,140302,37845,149830,5587,27579,5357,428725,248187,6326,206760,39814,32585,89923,44341,288753,284443,96368,31201,94189,119504,20359,52073,103216,179,27934,32801,96035,34111,34309,101326,18198,20704,210266,37643,27880,141873,106e3,19414,56614,167714,66483,107885,86602,4379,20796,75467,4987,5017,118857,26003,34308,114428,29198,6686,29697,73632,3739,69795,16798,41504,7207,30722,21436,36735,28067,28545,3239,11221,36031,41889,100010,19247,317673,29495,174554,6424,129725,53845,94986,7955,59676,2604,191497,19735,102214,62954,23844,11872,179525,261436,34492,428,78404,142035,16747,17246,27578,37021,33672,57944,26056,135760,2369,61674,122066,31327,19374,157065,40553,130982,69619,71290,38855,72100,92903,95940,51422,165999,65713,57873,50726,7288,20272,2081,42326,22624,81120,57914,79352,19447,1684,72302,11774,302559,161481,96396,13692,414988,3721,79066,56627,46883,21150,11747,12184,5856,113458,176117,84416,52079,27933,3354,59765,141359,2212,216309,2555,23458,196722,142463,45701,44548,28798,19418,215,29916,9396,10574,114226,84475,13520,18694,34056,4524,90302,62930,13539,19407,77209,7728,38088,9535,2263,23875,183945,17750,26274,67172,10585,28042,22199,7478,51331,66030,26774,192929,31434,25850,50197,52926,178158,4679,181256,70184,229600,9959,105594,72158,73974,2726,35085,78087,23284,35568,51713,155676,5401,27254,11966,17569,223253,71993,103357,111477,55722,30504,26034,46774,35392,36285,214814,41143,163465,1051,16094,81044,6636,76489,179102,20712,39178,35683,125177,54219,30617,52994,25324,50123,2543,87529,58995,10688,125199,12388,60158,125481,131646,7642,133350,65874,3438,97277,101450,10075,56344,116821,50778,60547,98016,106135,13859,14255,16300,77373,173521,8285,45932,37426,4054,114295,55947,7703,39114,52,51119,128135,19714,60715,9554,50492,88180,2823,118271,52993,122625,97919,23859,37895,25040,33614,32102,20431,3577,9275,15686,43031,157741,110358,1884,40291,125391,13736,5008,64881,87336,77381,70711,43032,49155,118587,70494,4318,10168,30126,12580,10524,280104,104001,145413,2862,84140,6603,106005,13566,12780,11251,42830,571,179910,82443,13146,469,42714,32591,265217,424024,92553,54721,134100,6007,15242,114681,59030,16718,85465,200214,85982,55174,165013,23493,56964,82529,109150,32706,27568,82442,5350,14976,13165,44890,60021,21343,33978,17264,4655,22328,27819,75730,16567,55483,14510,17926,45827,150609,3704,7385,272531,161543,76904,122163,52405,2039,19165,41623,14423,228354,3369,176360,85491,7122,35789,303724,4465,13628,2233,55311,118771,20713,10006,221519,45115,71021,35650,29775,7337,10864,20665,21142,1746,15080,1624,32449,10905,105743,229797,7701,3940,22997,178467,57208,389057,39683,59403,63344,63125,54847,69691,18336,56448,3362,37202,18282,29648,138224,35867,10495,5911,28814,26653,31514,176702,26550,45621,11734,4525,40543,73944,121080,27858,155561,14887,44670,30742,8796,107455,113472,56369,75581,183777,240095,133699,153299,8768,160464,26058,49078,103971,21875,71486,44888,17156,9678,89541,123019,102337,3972,83930,21245,87852,109660,287918,183019,686,10100,39177,283941,11274,24736,26793,26214,25995,77011,141580,4070,23742,46285,46632,30700,26669,19056,35951,115575,174034,56097,35463,87425,24575,44245,38701,82317,85922,281616,100333,147697,61503,7730,84330,8530,59917,61597,17173,9092,32658,90288,193136,39023,20381,56654,31132,7779,1919,1375,117128,30819,11169,40938,23935,115201,101155,151034,4835,11231,74550,89388,59951,91704,107312,167882,115062,12732,72738,88703,464019,158267,57995,60496,737,14371,123867,4174,243339,159946,7568,16025,134556,110916,38103,191,80226,88794,29688,27230,10454,76308,57647,77409,113483,66864,14745,19808,12023,46583,84805,16015,17102,2231,20611,3547,95740,250131,34559,108894,8498,15853,159169,148920,20942,2813,93160,45188,210613,45531,52587,149062,39782,28194,57849,60965,84954,89766,84453,100927,16501,27658,165311,103841,54192,207341,19558,20084,319622,5672,205467,98462,61849,36279,13609,147177,24726,165015,209489,59591,31157,6551,117580,75060,141146,277310,21072,22023,106474,63041,137443,122965,68371,5383,42146,98961,113467,30863,23794,4843,99630,30392,82679,13699,241612,33601,93146,24319,18643,32155,95669,40440,15333,34089,67799,142144,58245,38633,114531,117400,77861,188726,5507,2568,8853,10987,107222,2663,2421,11530,13345,30075,41785,118661,104786,17459,12490,16281,71936,193555,17431,5944,71758,26485,77317,20803,367167,158,7362,93430,11735,172445,46002,11532,54482,930,62911,2235,23004,179236,4764,101859,208113,22477,55163,95579,14098,67320,162556,90709,156949,3826,57492,4025,34092,87442,104565,6718,186015,28214,14209,10039,107186,233912,58877,81637,55265,39828,6194,145813,50831,105849,4974,88319,122296,10272,197216,95714,51540,72418,23324,91555,8743,140452,250249,51666,34124,7229,38592,129641,78169,174242,22464,149964,51450,14034,10026,95376,26190,120062,14401,8700,265,31386,143573,7203,229889,61567,4227,140981,2466,72052,10787,10062,30958,6099,38471,30103,23202,208101,70847,467,58934,32271,32984,36637,24107,30771,17109,73353,13650,2098,157040,67366,66904,106018,265380,107238,18535,44025,32681,144983,62505,91295,56120,3082,77508,10322,63023,36700,81885,224127,16721,45023,239261,111272,13852,7866,149243,204199,32309,22084,42029,38316,126644,104973,14406,43454,67322,61310,15789,40285,24026,181047,6301,70927,23319,115823,27248,66693,115875,278566,63007,146844,56841,59007,87368,180001,22370,42114,80605,12022,10374,308,25079,14689,12618,63368,7936,264973,212291,136713,95999,105801,18965,32075,48700,52230,35119,96912,32992,8586,16606,101333,101812,14969,39930,759,193090,27387,42914,12937,5058,62646,64528,38624,25743,37502,3716,4435,30352,178687,26461,132611,42002,138442,35833,59582,16345,8048,60319,49349,309,47800,49739,90482,26405,34470,63786,32479,85028,39866,47846,11649,23934,29466,2816,42864,31828,7410,74885,49632,47629,111801,90749,19536,18767,105764,59606,21223,10746,76298,22220,39408,7190,79654,64856,11602,82156,272765,17079,70089,245473,51813,184407,384678,1576,122249,5064,27481,6188,25790,74361,27541,318284,45430,31488,620,93579,45723,192118,22670,51913,4162,70244,35966,26397,16199,50899,209613,121702,287507,2993,36101,132229,67345,33062,76295,118628,78705,52316,34375,107083,107454,44863,127561,33964,3073,154010,190914,55967,39074,6272,31047,5550,41123,26154,98638,47110,19998,148091,50229,31329,59900,195442,19106,61347,73497,70015,682,45850,25776,38022,148951,6288,37411,232526,109277,27286,32342,9262,5220,16651,23175,46740,129438,78614,121925,66914,88710,127952,5563,21500,34521,10739,14863,191006,62956,17359,16749,67027,56284,69134,43301,35039,58883,54466,60823,404451,75743,59856,86979,7923,34273,83785,32142,7693,268986,197428,282681,17049,22346,22990,92245,107180,3357,37104,96724,49153,7683,31197,43267,82231,164276,23696,20848,188364,22309,24821,158707,1018,22514,70922,27792,45589,59709,10765,736,35218,63479,51987,24275,63588,55361,92929,81964,4658,20122,12330,44058,13065,311456,72224,8337,211229,38979,22590,138478,52757,32595,133600,8838,31549,94412,43391,90056,1585,94802,127271,6223,31889,137038,132910,2165,57616,230152,6080,10748,36737,74579,134062,50525,180532,119270,34556,76155,82394,52595,29258,31435,87820,67996,26943,183878,38007,2410,13526,180297,69856,3503,187396,167700,7838,16701,9199,56267,3661,37407,65994,23767,5708,62508,221700,67088,86978,46776,84434,32088,5612,9149,88244,21685,95151,46750,189612,2979,506311,2594,3628,40074,105039,78243,28523,6651,38058,71999,30992,12764,68261,108991,6165,26450,61961,13400,22426,7490,60890,109623,2070,12958,50355,67979,257096,7213,42578,52121,35716,65461,7516,124758,39268,302,64712,14977,1467,219452,2840,34229,11121,21602,19270,63574,8024,1532,17331,79839,78885,52029,180767,57957,6069,91265,61380,55767,8927,32881,287603,22149,35029,68876,6428,199567,46926,13412,104132,21434,366616,45060,110046,81924,128910,45886,52821,130416,29416,77342,21762,67329,121432,79924,11724,38625,81006,102033,28338,13326,3250,82056,82526,38212,21112,12382,111495,3263,7414,86274,93490,40844,30224,45212,24019,48411,71367,24941,76729,57776,3769,38114,202019,197745,31953,237533,33270,201580,255648,100798,44741,32241,98468,106931,10085,15090,170358,33154,66787,18819,69760,25061,234005,82660,6295,131975,16874,9076,4094,25005,17740,40908,19533,220019,44330,99792,50040,19619,13950,55228,24423,31253,95308,103177,184795,28590,82285,5059,3210,75525,49894,70007,56178,10580,36051,139681,21617,98736,3555,106306,164189,37352,63915,47824,24883,145530,61904,28444,11483,19837,145446,30420,112972,85939,11835,191233,2262,20705,58630,1753,148334,1197,144714,6887,11223,107667,60879,77914,4151,57417,81594,96681,169430,1784,20444,95138,254041,27038,596,7117,72808,13759,3353,126776,21074,55322,27081,36942,39547,139830,179275,4453,713,8722,71399,19204,25785,22794,23923,104114,11291,25458,102309,88396,75288,230440,206396,104551,58447,130857,37247,94734,31548,176529,226077,65159,20104,10096,66881,94191,237909,27109,37404,1520,27421,25220,113003,23423,24884,50585,6286,231877,150800,11789,3226,90004,60642,5053,202400,61442,132531,175329,57138,30116,103847,9973,75367,16452,32360,59119,21246,10191,164804,23305,61051,37348,154530,13214,5468,50403,66754,130976,50559,80515,14436,155492,84017,5472,43107,41240,2890,90431,70188,382,76234,48040,50211,281038,237007,32115,142178,1536,22761,96429,1811,31243,1679,49143,55209,17402,235054,61494,7462,77030,34925,87609,78002,9499,9027,73289,201078,101379,63544,27666,5469,10642,30029,49816,132979,95620,58086,351930,116300,2110,2043,30845,6154,11279,16727,4122,2277,27281,4971,3650,39060,61970,65951,39674,75686,38151,11370,130809,177895,32665,63725,122267,7857,39618,118483,44792,157755,178624,136994,24260,41308,22471,12404,21707,12486,30473,52781,50246,20247,39065,909,56825,103158,128603,31542,1089,41935,32744,12428,37963,84420,33134,72921,208449,42622,168151,127335,147107,46699,38216,12591,94342,85814,31423,24944,2605,87542,67473,192551,4496,56321,91819,17630,6300,256183,114569,202090,33209,35289,34897,24967,40520,43470,5344,10199,34810,14283,10381,10017,62923,49924,23233,64539,13051,35686,19698,11570,135555,120868,44924,87065,52318,52335,47586,140906,245885,109834,78668,9065,46990,25258,72022,61243,40838,4545,146387,10537,11557,17470,36930,68104,46711,24264,79401,81043,18225,120488,24746,84338,81652,28266,13776,21878,46973,1047,230465,73357,95777,24973,210160,62210,58404,110633,169651,6937,41870,9909,26822,191062,76553,27519,96256,239070,2478,205678,67955,58532,20601,50120,19148,78501,195724,110740,8249,109665,27446,30568,57631,31425,49752,32820,65504,50079,3663,102256,219898,23849,211315,14645,4359,91767,9528,12449,49366,7941,49763,107848,8930,27086,50686,9744,10447,81935,39513,46514,1670,29229,6172,22312,137280,97759,9806,14445,22976,56458,73391,34983,93760,174219,52573,33149,59747,2429,136277,75123,165263,91040,7446,57632,48633,97140,246081,84766,151684,79918,93268,120346,54059,54875,77858,32996,103590,45276,11968,19600,25849,17159,132907,42828,16817,4913,99462,103303,27395,5737,74184,20749,21160,14377,77062,131403,158735,10999,27799,77785,9320,34366,51593,61070,33746,47048,29268,36675,30262,53297,9832,82e3,20188,122292,39917,7331,18160,68301,185935,134830,15031,4935,10004,165845,185534,46923,30109,44134,122631,18874,22903,112790,26561,18549,348902,82871,140345,255565,135390,63556,103747,145055,179600,145662,296111,61661,211987,23952,52342,126343,48450,32919,44277,82185,9591,62139,205363,376969,394874,108461,18040,120885,14798,39863,16571,16794,58271,81025,55206,14640,118656,6361,44092,85970,6262,153863,108244,180200,72264,79947,38044,10050,5735,61221,80712,5471,115689,11391,11661,184257,20010,60116,30320,19327,134598,45455,27542,18004,125092,452272,1549,91523,46567,180063,156026,2608,11174,58848,37788,65907,80194,30490,5786,40775,119519,106241,11323,156297,8425,61495,2617,29675,2425,59886,112582,49142,59618,4863,50597,86710,50650,168632,27693,85641,83643,18993,25768,84284,28090,93592,36627,312804,43381,9887,9402,100931,97165,3311,173330,66805,28935,4963,184460,3201,78102,19126,21607,37496,24938,22615,16153,32862,134792,153318,61120,6067,2812,12826,12792,23825,37559,64662,202250,102694,155488,85881,149193,46233,65383,15521,106982,11358,176786,25752,39717,34208,24510,32464,77742,39371,72028,138229,60688,71386,102834,132477,2208,11548,63670,271279,28351,30338,38620,32491,99845,143885,152266,13252,2825,178663,108097,1775,78201,14897,113573,163346,62292,171129,22183,96598,38733,64971,166776,117445,9968,146393,44677,74867,20908,97328,12761,25656,26785,9148,112344,26115,99176,110121,22437,49547,6180,79320,5835,31392,43328,33377,75870,119860,69497,80273,7325,155219,43167,111173,28347,20222,3763,71752,55041,47252,14618,28088,15012,97805,194698,54636,2036,41349,6173,96604,61530,51859,43782,13361,24334,22668,24792,7070,23441,16789,3209,36211,208475,26242,32880,122181,182407,21444,31060,88459,29929,77907,12716,10934,97005,20599,31690,8403,58445,30303,22700,10336,86731,103115,337709,72556,46788,112566,47684,67089,53548,36874,56487,41387,125985,26893,40071,106683,73712,18787,40105,72992,67246,137276,50802,36790,70328,138827,22466,39263,183295,29858,50975,9322,57397,10654,24364,30383,55799,41600,23584,127295,296610,129078,143558,244131,86397,36049,1085,80677,3820,108139,5476,34767,24683,7758,13060,7239,131671,250593,59556,103392,29810,4188,252323,39404,116877,7651,43600,40338,13554,157253,39196,25978,144387,61211,234,50104,6129,10449,93777,9240,356378,274148,4439,72970,3724,147770,78680,62570,115877,40027,40547,36817,224392,64609,34795,165027,67440,2477,37206,23431,50754,164797,46018,94995,170982,27051,7957,22767,3674,27900,56419,18930,60701,41302,2692,84749,339721,61996,111094,80221,50129,1045,8153,62945,19202,8250,37208,37418,32560,79477,41106,88569,33963,36693,5892,30570,1581,66471,49647,11922,160717,29442,5643,114865,82962,95982,132098,22633,22838,94726,54556,28566,205039,162340,33216,16849,35847,221339,94851,26533,71469,1805,3804,12935,45483,71020,36310,65381,192960,34240,35165,59773,1248,46954,155332,96864,4246,388800,16129,57133,74592,44807,442014,38203,42574,80818,91592,26377,36424,65760,977,77387,22628,147610,28018,30561,98454,6969,119628,63648,18170,36854,26601,64018,22027,37279,51395,152934,21153,9430,58760,194742,5330,55115,34158,28917,174111,13171,122326,1526,43896,66094,25325,4234,148354,11450,275,18999,112191,44365,22723,68409,8733,57746,96565,75007,14196,108844,29475,88599,177563,100792,106156,86323,93726,14248,135341,194131,40126,47099,14779,8272,39597,95983,171398,65882,28052,10393,47213,40689,22120,72212,106829,34964,109146,753,648,21660,30047,17527,181025,5619,145357,4085,216883,9359,186951,24779,53931,24545,36197,223296,62628,168101,4243,107313,30321,26642,13049,51059,31027,107912,807,73550,26551,84369,122422,165872,49754,74213,234264,33151,52014,33100,87183,22365,52500,40013,23302,5652,72723,21404,26107,48434,587,94049,168493,96418,32871,70860,31709,25128,443,71597,166253,15670,70994,26341,133675,28280,75491,54756,47955,56028,26182,11952,113272,472197,64640,110753,17919,337,50642,22576,142,87371,53391,93210,126694,15285,19642,85667,14148,1506,42092,52962,33243,11970,20734,135843,57044,58880,13002,219134,22876,64754,232519,4257,43120,321573,24799,64526,124728,52579,81472,70831,276848,17403,74359,23021,182101,74597,23744,148267,12055,7976,5349,11772,67540,167347,65318,18720,127832,108238,22828,90233,9987,259080,118185,73209,79270,13775,90100,137742,90799,70569,15699,19961,9087,67475,57872,39731,8810,134897,131868,146849,19898,3334,2281,167061,91073,60356,467742,74712,188,53179,137679,92769,29241,9537,132595,80119,1041,88962,5976,40171,44911,102859,139059,104558,98987,47761,19272,71472,113864,175377,73338,10857,23402,23758,1591,139864,5644,4076,118760,16427,134198,18853,20291,100849,37423,22038,36677,19071,195521,57445,11069,31869,55718,66882,148490,44,41296,75242,49704,166810,9906,20943,122258,49112,105667,15969,10344,6408,187694,21399,72742,58970,14867,14376,81889,41856,23225,15042,56993,16074,131389,74276,72407,53875,383108,53597,37363,68993,44854,122548,430927,198279,38430,80409,12245,2981,628,2818,17760,37437,238229,7968,46892,2200,3730,34190,65983,37959,112291,87850,70827,6522,20750,73913,111621,41652,19587,2780,58668,25916,85259,18200,168962,95781,42445,102050,7776,57662,103313,47742,96358,41964,66174,100396,29069,204735,19679,27978,7479,40264,22534,61183,36081,107436,58223,14680,23002,101311,24716,124108,12908,5646,31750,40380,14215,232799,102772,14122,96775,61398,50917,12096,149880,67833,598749,124194,155871,49216,790,14677,65319,56917,7440,145744,95701,12206,49405,129269,76199,45732,9767,11058,9047,210885,11051,7392,26307,2130,8132,147526,20802,232698,115660,50060,59789,57344,107623,80343,112676,23291,9866,160971,34032,118291,15719,59730,164911,28975,2659,58046,78480,21854,66209,53863,109085,116045,29021,46481,107552,22130,18764,70254,31272,11300,52460,43933,84738,20721,53869,190840,79673,105300,7561,321817,66924,13940,33281,101046,183181,32176,71878,5678,62924,79535,56646,40303,19559,27703,93042,73368,42187,3670,37376,46440,7023,36816,109628,20680,5940,276440,275233,170848,112093,136996,14984,20226,111441,77693,112960,48577,39370,55707,50314,123404,26570,54281,61372,123391,4857,35928,246740,132507,106646,44241,7196,92258,9825,37688,51197,303141,5590,15476,132986,10955,85782,34486,26696,7991,28813,18858,39546,11703,11365,38185,5716,93555,11925,40121,60002,6985,10976,171384,3887,43394,13337,56346,6381,252336,39573,75042,53711,1028,31781,44295,95925,131713,7214,68125,43571,70954,213234,1628,8760,13391,65485,17320,56038,1710,25248,60803,57399,19839,3870,326,281556,50945,72400,21460,316244,75619,56246,98775,481,13513,55765,50427,7388,123519,32929,57908,27124,61316,101097,57467,30228,48792,10788,20402,37318,50526,155730,34456,158065,145305,17832,43733,64052,4506,35072,205355,177028,184004,187081,68616,35938,83703,10367,36892,93186,260137,51934,89970,4985,23445,26755,21558,7948,78741,23376,124405,85594,68596,57536,49351,12619,56593,132668,99924,109728,71844,71935,196018,65464,17617,14987,89701,143773,33997,8687,22701,33258,2914,4436,72108,85610,9671,49067,2327,82988,1361,1672,44033,35777,30269,24057,10605,82236,616,15793,13919,47249,112086,116698,9484,80207,90574,33304,68624,93127,56101,42210,160929,4827,38995,38095,4701,125119,5027,33680,9236,231236,14135,87837,23318,70261,78893,30151,81482,14332,1084,74256,27532,46644,79185,3148,62615,6981,55672,31668,36825,1849,14536,37446,14738,23779,43058,162749,72199,1168,21346,5592,85932,85302,9668,18351,57135,150360,2080,228015,77953,34670,119302,151751,31009,106725,84265,45214,59289,74178,113071,263206,111009,4021,44449,188119,192629,123592,392506,292847,114487,12831,205858,9852,20780,79648,75767,357014,97721,18166,21005,67950,33226,204009,16536,2987,11335,66717,144910,47950,17262,55060,15063,2934,51038,26775,178497,66008,3427,49433,128592,20036,157553,63861,3089,23015,51210,28696,35933,49942,71135,231518,99620,17248,21835,176536,20676,16944,38700,165831,233253,295625,36723,13023,52745,10907,19423,67972,125868,95473,82875,1183,108455,52685,33417,64095,21433,52438,33191,127809,44505,211823,7810,2752,95548,162031,7185,91196,47563,61721,33359,17897,23682,42806,178101,22874,49707,199897,75419,82456,8618,11171,79712,116847,18783,44190,46564,5346,59046,95032,7893,14916,3214,26800,24172,121453,34362,10250,17408,18888,4840,68696,22831,13162,36005,32512,14800,62357,41723,45046,27247,37486,5372,2564,34261,298500,66509,133920,89138,31305,117697,19097,108304,81386,84106,23802,46411,63304,946,51417,41777,41041,19501,115864,60743,294354,37955,94165,18116,1156,17937,20645,57114,90804,58042,48643,92288,9861,2557,88546,61333,101008,12853,5148,87856,4152,144503,73841,18718,9789,147565,10846,42085,12789,30223,8993,56352,67203,2448,28215,6052,23540,126319,75933,36689,80235,23231,23561,21383,38800,77548,102798,21234,31468,158608,46188,63960,191679,8051,67014,11185,170078,42186,28827,34777,41930,212079,12421,34750,24111,110344,73918,45171,70826,141949,40063,23979,24254,37309,26724,27179,24718,83648,54938,14591,17425,29525,102675,48975,48654,12316,8929,60640,41709,50168,63264,89812,50716,48632,38755,138583,160123,55579,71829,24230,233277,46322,39650,166388,34718,24108,98252,7031,106695,62498,18258,35062,217827,78731,34824,33354,19520,60852,2432,60224,8587,2836,62955,702,20227,42285,40560,95592,62486,11094,53035,143291,18842,46177,77994,1770,9657,107422,172915,32655,128716,25886,25164,156740,119928,165875,85817,11007,89110,33956,12652,65156,180266,8494,36889,19958,20955,96,1264,118288,135769,44754,86671,5632,19026,168220,289120,33569,93821,66144,70635,7687,5642,2714,55445,56636,71545,184182,93133,7332,37389,12643,52315,22729,11014,158742,17050,152889,50178,34601,41945,52136,9948,26914,63548,95721,115951,40759,8960,158258,38938,49232,48325,42234,81523,253019,66128,40978,20048,238048,38760,62928,122560,118532,43687,137472,163689,26680,9878,17448,51035,16211,60834,36749,29178,14241,59868,150086,2305,26477,42422,34342,165341,83279,33894,14257,29928,12743,13957,125571,89134,66712,10952,16507,147839,30146,7249,16565,45399,39874,114565,215780,31990,230881,171477,102,196546,44538,10880,84948,281705,86651,10617,31395,2342,453658,43569,60561,132901,21845,17727,58556,258242,22262,58728,4008,77997,11806,37431,30599,81375,109137,185787,114085,217292,97453,169085,30593,60212,11544,102056,65580,2384,91655,4855,95725,7295,157994,16228,20669,53276,141590,105246,17334,25440,76067,17967,39321,38911,11362,28559,63807,21627,26468,85816,40120,1025,15234,58319,69516,66512,124548,75845,78873,22137,46681,51242,85683,32909,76747,35555,43396,101465,1765,73094,1077,2962,39028,66777,57831,42048,15828,13962,36041,63657,52412,5242,58846,2141,5506,219012,134451,3936,182230,17558,17153,152237,22621,49377,170216,35257,68233,65374,6510,11126,212151,7184,2480,22517,3437,33073,30156,16557,3768,55067,86829,91e3,12350,148650,66017,79424,70885,49066,28250,21369,51213,34533,11510,3258,18176,18465,84413,6315,36411,163765,4346,356,107618,598,13727,285026,162695,8749,14583,7132,63521,184253,32378,25991,5604,30961,53675,4874,84693,5086,34811,26978,56564,7904,33519,51221,113942,69253,6664,125563,22055,220680,102008,742,51930,19494,176108,44424,35123,13025,75685,11759,74335,22250,181453,131147,16984,132115,154311,11991,76452,52609,85351,196,30969,9198,74919,2529,56838,71779,29187,116304,3504,62330,41190,86153,28393,254926,104228,105189,13264,84359,3574,12415,8534,57147,10175,188174,59504,60932,66318,16407,107921,17638,99103,49278,28403,39786,145865,8462,3558,43406,142271,29139,21989,36552,93955,72365,7176,13556,106185,37957,321774,17782,129017,51154,27938,24952,1935,39366,2791,33489,41582,56078,24558,9311,5449,218786,27808,190429,68013,36020,86003,29735,3404,87348,119357,115714,2324,86796,81973,40992,43376,93621,28784,16808,36367,2517,2909,191926,24978,55303,53308,205724,60068,3098,21375,64784,23949,26579,63121,12319,80145,39967,97861,6757,70143,67642,37082,34698,69140,122883,46151,62187,80934,429,19437,135071,137885,222647,13331,154065,327,61778,74257,40116,37493,14855,85079,237641,42342,102164,199965,71204,4662,29368,5042,113914,122214,8955,13149,102503,43173,5659,163787,69003,307084,63392,171080,21390,81918,86666,36622,24126,28887,5736,28054,207170,163428,79891,346467,95363,38980,111806,80828,9200,19288,294896,114468,87405,111715,141705,7015,72754,68463,48738,243147,33397,101210,37051,98801,82847,20397,4940,185559,18716,54718,83491,11725,40803,1128,12128,23060,5174,7745,67007,46701,1571,27807,180186,256996,18975,16837,7877,212758,250379,15440,87954,57755,24719,124057,83461,258,50864,8874,29038,71289,31627,15429,9005,4061,113851,107716,82819,13651,79656,117851,17539,111446,12938,39724,190787,4352,15402,21070,62708,8539,23777,73853,13552,38810,86117,16285,56400,1718,75342,142863,29033,378,110113,180321,32586,23606,26393,160984,207987,23783,8406,16904,24596,47274,11693,46539,60524,78595,48423,31718,20170,9009,146268,15183,191060,172765,1349,138436,37365,10970,40509,225817,20021,70394,152138,21541,66559,66544,89352,2725,17258,91345,7313,3815,115868,8660,40362,4071,103524,39388,118275,21950,6549,38226,32754,209574,29201,43495,18028,20296,40597,18370,47520,202450,24134,2219,8195,69545,38041,136934,46374,19041,159811,84865,58620,846,98749,13569,30714,97246,32186,4479,27355,92973,35214,151491,75963,37631,1561,27200,238083,23182,60756,12291,25766,39355,102333,87362,65741,59906,19538,201575,48772,102938,24438,292580,39964,66366,9004,61379,50548,37622,38732,28379,68180,76622,17488,69849,5963,7219,48143,43413,55358,540,58691,29506,19245,52193,48621,5518,13048,118625,44755,191081,42061,89197,2259,60665,66994,71210,51232,3585,142096,55024,7892,8345,58653,463307,65658,64319,137941,136323,53499,12746,43492,6978,95163,29925,60175,5128,7352,41463,184756,121146,20473,18426,4598,5309,54580,14277,121151,10691,56711,43880,63409,76682,11830,172218,264898,32632,66536,81062,31649,25788,92774,60222,11100,63159,9432,224657,25240,53613,152,138620,163829,2397,85345,12501,37507,64932,38575,43522,65789,80198,78796,35226,3851,108891,73311,3060,28391,93671,39663,46142,30982,66041,37281,68157,26553,71872,81142,211527,39747,118119,22695,2859,11066,20232,168911,7933,197005,17066,111071,44434,133994,120798,12766,227798,45756,132852,29917,36076,55352,65281,129800,41958,18944,84678,18580,168093,132621,39997,54092,27740,32354,3770,114118,103242,43918,15899,18574,145944,3190,123469,219903,24169,100571,62403,16776,92779,14535,17168,16475,14304,37231,1712,28218,242754,61688,28980,1318,51359,222657,99200,67989,31772,23932,35351,201251,49041,27306,19128,40135,3986,77333,19649,120683,151927,21081,7076,78375,77501,101599,8011,89585,96715,58179,5378,102138,106793,26051,217276,4197,16297,27014,46721,13322,22806,5278,29629,70632,9647,71519,58818,40603,128530,8903,36770,56900,31483,26935,43845,34265,34920,87658,6114,84767,64250,47318,50720,19264,162514,33357,13117,6705,46696,75032,71054,87004,42035,69138,11903,99854,102328,19611,34525,69312,6431,49842,101600,133178,108751,41829,89939,225664,48916,99556,9195,130387,5960,36857,116724,53518,94002,39077,53996,6945,22261,64291,8314,152785,57588,16522,9091,5048,87671,35441,39509,1945,12423,158923,178413,37549,14095,1475,73188,62878,4819,24012,68534,42606,4010,120809,57497,59564,101758,103718,32701,80116,12345,95834,46918,21468,53213,15665,31200,3867,5140,96013,250744,21016,10069,13968,35449,180829,27683,39704,59956,22893,3115,26293,32785,75934,62445,141162,62720,2018,83638,19949,114012,95006,3330,99829,130935,309272,9565,55874,121727,37017,23586,319858,40970,27602,8625,112329,61060,100088,118525,25922,16232,1907,60671,51583,44553,80993,5262,94679,8676,940,20736,11823,3020,16476,12340,152600,97416,3703,25744,66826,16245,16876,46446,84798,74227,176020,45192,61955,75496,23946,23626,40372,26036,6149,11822,30582,16541,41914,82385,232823,40921,80773,14930,3631,7517,39619,4348,36180,126106,138939,62611,1477,113512,47321,25052,14546,118881,29060,23589,128322,36795,18401,137921,104699,267929,36194,172791,18113,4766,188215,30083,332586,94089,5805,77909,22194,68234,154976,43220,40660,70001,184893,138095,11128,103010,22663,5108,212615,8485,5565,49222,54614,26530,42639,16319,55062,152662,105595,21114,22216,10294,68158,10436,86950,7206,62115,3977,3657,59874,456,118617,18156,106663,112229,80992,17442,8217,55551,5133,34344,251927,51153,39364,201321,7816,66803,23057,156724,145664,14276,95705,979,2796,6875,13429,212525,50602,26276,28284,3424,19465,52397,46963,31420,51399,206476,92317,48851,637,100820,83349,10317,60227,21972,6908,282439,32857,224767,95629,83882,42106,87338,69757,29840,68709,37665,45244,114577,49188,175943,54009,186746,106158,70168,3358,234002,50555,9221,129338,9562,20118,32923,78479,118280,65752,4977,10474,102174,60947,129006,10570,83451,8598,8078,159367,123785,80438,16742,5905,5281,181513,42402,6977,163136,93179,42191,14968,50421,112401,105440,33456,57347,121611,4221,94954,36517,24046,27796,6255,33394,72990,135408,116627,1233,57874,25654,95419,68156,401399,313338,55208,45573,93124,119251,47200,38196,11909,130667,45391,73904,64964,167846,4137,115606,52036,62214,7969,160925,7187,1132,134835,40309,73195,64494,80472,444841,61111,26500,45323,40743,53625,52797,22659,15631,29739,36706,28841,39147,102836,26794,10536,14845,87305,45874,12241,127587,83833,57183,79722,30844,41304,84655,20825,92500,3722,25655,27811,10157,81634,31362,34088,92487,70123,22190,185100,72658,139035,192523,88241,2078,230490,44528,85638,100198,22088,29982,291233,241062,13865,4445,137791,37835,107218,31726,19718,38234,72528,23046,19177,66695,5109,17251,28077,5617,21554,47839,72425,133825,1486,73065,181275,141508,21768,62971,63082,2512,34200,9904,120309,6392,91243,68416,268253,41199,116757,138551,185526,41246,28986,4093,19057,17295,4148,245766,122360,35356,112075,20301,75441,10998,7977,19769,62922,937,63547,100196,26427,157820,20983,236696,22935,8140,90315,156004,47204,140973,7726,45097,52725,22636,23436,257282,105247,522,88389,216031,202204,46812,211666,19693,68828,81691,45925,11256,30292,372,5236,167826,88328,232776,151611,5360,82104,18841,80393,25465,18285,20320,72377,31730,33160,45803,38715,27705,37379,24163,18360,103586,4015,32305,269494,91252,20080,36567,54650,7797,57073,12650,31164,42209,6375,261663,105528,81661,106002,2800,5375,17247,43151,4442,15727,194619,100855,144898,62320,78465,39929,16454,1967,28311,61363,17219,9395,8745,121445,76939,80385,162380,22009,54191,44248,16299,122830,48151,74429,78291,64755,14238,44966,2511,17712,67954,93583,829,105899,49935,84750,11591,33185,85447,42717,27409,208542,28965,62052,52525,5597,25694,65594,16343,63224,276188,12475,9331,127507,38522,57287,24128,133161,79723,105548,133695,48917,27558,43278,46520,13778,141954,110785,83366,17715,46317,105763,66298,147013,41086,94180,16478,220447,44611,730,19722,78975,117889,125643,26254,16574,18480,65006,15806,38549,246418,46052,36056,8440,34984,30170,3163,59800,4458,115442,4283,41970,33507,104078,1653,22,121158,276486,3655,6338,24048,133421,23641,2161,24422,36006,8086,10675,181474,12307,29514,59143,14729,52509,87128,122470,19446,80852,33314,24573,119864,14237,9652,57779,6612,51851,15284,98871,90581,124466,156831,21190,22015,71380,161906,87247,69201,18392,17908,108470,72962,40719,14338,17911,95260,43339,20610,78916,20710,72451,11315,31448,17263,58853,178878,48111,116002,45497,80506,82605,85880,36300,121755,25215,36118,301929,88728,405223,276136,553,34704,212438,49970,78329,922,20711,25036,257130,38295,145369,18128,15385,30829,55656,48345,8012,3561,28004,122041,192900,58338,112508,41085,29976,87040,47117,23905,4336,92061,138880,97407,42083,172121,6256,25192,172671,5,93568,1420,12677,31605,56743,40620,6015,78415,231077,31298,80026,13902,19048,24924,170586,32955,176119,87859,36731,6773,27711,24658,26475,115216,133207,93250,95820,88522,8317,5714,124047,55219,86860,19677,23961,22928,162209,8904,225992,359835,56084,96201,29392,96558,86071,93643,55114,13347,8183,95129,82012,2017,123336,34219,115554,157159,47747,101684,41008,18735,193781,104151,226906,7552,179874,124113,31159,21162,44010,14771,51268,166128,31382,73124,77438,92830,205709,12113,1292,38937,13114,1334,2118,15597,69581,14449,21934,76618,48728,67038,14967,51495,24243,87736,147249,26720,11119,46063,43749,5843,44147,152629,133428,65703,14269,45604,57982,28672,55616,45957,8438,95433,37698,220862,132034,39456,61870,4161,26501,73560,56418,9845,4654,20916,10456,88920,119358,9015,65931,96507,48029,38534,21676,109081,43078,34943,25089,6131,28766,23665,5477,10255,16695,67,45778,42443,42770,29534,23733,100513,62617,42630,48746,14191,43753,50295,26007,8792,57243,43119,54725,164253,58250,112304,131796,25165,4651,3188,24831,47748,3705,19540,13211,102095,5593,18699,23666,32005,117571,33541,60584,74573,86311,99443,25172,27222,168938,7143,11853,53560,18834,19960,86522,28217,53266,117700,72989,34323,18721,66450,34346,74056,47217,202002,46269,9429,68582,75458,37823,82843,96652,32549,145144,27958,19820,158086,31955,201406,135379,31207,192545,12950,51704,9094,248263,76147,64028,110009,79407,89345,99284,223492,47966,26848,15359,201137,2861,110507,71231,72297,31851,118777,71039,151051,240855,16333,50766,14727,7939,4149,80908,418780,88378,59276,1327,7284,38576,79814,65820,42199,84860,49574,62596,12396,70598,40117,8648,7994,16836,7630,14047,359699,106878,525,29037,28064,13380,11675,50669,74216,103539,180314,27449,56299,172344,19274,7301,246099,32043,19422,36506,129317,6806,30140,4614,46639,66926,932,86600,6322,27847,233103,10541,39025,34887,3517,12972,26220,2031,66561,115015,48658,47596,12714,33845,3893,16165,35237,89983,14769,11962,147224,47018,29977,27979,5552,82338,86023,131368,1218,24853,237840,132193,15455,40873,3668,65351,53388,15229,59889,272245,47934,11858,34347,18038,90853,86981,300602,19343,114181,29362,84921,6095,106059,79472,38015,1206,48741,6208,8e4,21916,17423,6002,108083,24479,34931,56661,9511,26995,100694,163853,35997,81254,58321,18919,171890,86877,91341,74503,70477,53412,7027,59281,39892,131302,5864,15947,61301,67466,162369,47956,27874,35624,282324,21270,111847,102548,41482,30955,116737,28264,8592,55458,22301,75090,29821,30697,51709,3041,19208,8038,24634,30467,87509,126428,19389,18814,152686,20701,83474,45832,80891,105808,11378,153223,120770,98186,150633,49838,9141,12755,30962,5260,74490,21256,31678,65062,33326,289838,187831,20595,89768,2805,58535,10844,70085,12090,2451,138068,98544,24461,4511,6754,41684,28203,3383,65355,82833,30161,83924,234361,128424,28921,222594,33975,125491,34069,11508,67464,144226,41850,98703,34371,7901,21254,38398,65651,23549,53883,213340,123269,12028,71764,177701,28758,2623,68395,11549,15232,68603,9660,63116,36079,57093,31198,20475,48467,89984,35619,186847,107469,31389,43631,73867,41949,68841,114250,1605,30564,63403,17588,27680,99533,12641,70325,50428,73426,78379,11855,91651,72081,91720,60198,15743,12065,83398,140046,6761,46598,45900,5068,886,62448,148968,37347,19405,9680,15819,43496,63370,75667,163700,37639,3633,22774,34341,183131,134335,37200,23915,7054,14194,12970,26438,13350,285521,25594,8219,104410,91039,168804,138480,149734,15907,33818,61132,60082,4622,110187,56736,13551,73571,3945,73463,65498,17758,263266,17593,2710,27585,54469,38200,45367,63754,28881,3473,12791,98287,31895,65787,4463,94536,24951,36332,59901,28803,52130,86403,7668,181822,74831,18977,9850,177206,145485,109798,7292,31421,26280,77211,58511,12507,127004,11113,147,8729,56208,43066,79926,129937,31345,83947,39915,46146,98763,42566,1337,13192,18323,105163,80570,117753,16555,72883,11077,159438,40764,70933,83329,26066,12276,72059,21655,173836,126713,69454,153482,91585,70644,102558,110483,6764,127864,190133,3961,101798,20945,71138,82402,90884,69669,44753,923,16939,59700,164258,25969,27082,31399,43846,6306,246093,51342,6153,151581,202801,182731,56475,162188,89426,141356,14355,121815,27536,28023,65257,77523,106668,127314,24947,12790,38796,169698,23555,10725,44573,183083,42088,62716,43265,105958,32050,44067,50118,1668,3874,6243,318411,16599,1691,94999,52378,28671,216728,123258,2059,34969,69225,5913,136280,171443,141515,91662,22175,135282,80020,92270,1663,4808,4482,3495,34691,5226,109830,108512,17342,107488,11606,123190,100247,29666,146527,113014,15794,30894,13224,39585,243192,22351,9903,7836,47699,11078,25468,122291,48821,26780,122679,75521,81450,630,4895,92900,55074,74293,17441,3563,111657,103102,51613,12318,52370,36191,68245,34269,40445,41354,122901,168604,182500,62012,42557,11259,24428,115113,86345,12362,3909,78430,86852,134602,20459,47853,93879,22577,7659,3688,38555,13349,17381,56715,91639,12493,10895,92438,3142,37057,28928,2004,36427,32268,34222,209974,10432,67436,41989,173518,107930,27079,62729,30908,55558,5828,45031,14902,53546,8204,144263,60255,14520,88212,86582,109589,69356,8064,47449,8505,66558,16886,4844,52817,111260,215129,12941,91118,650,20770,6273,73089,40618,62790,2873,35002,14023,97208,19386,102646,36993,143736,135457,35385,113601,17893,32627,84439,100619,56016,6581,57264,172160,45452,111710,203627,70131,24100,322787,1996,35665,70078,22358,90922,83658,4097,63200,58499,14542,99153,52159,6615,12414,63415,31986,16823,1579,65405,137809,8841,16898,48082,259,33014,42375,12260,179850,73667,91389,98882,29532,17311,326251,41092,5928,20742,44964,48019,43505,9317,49265,6643,192712,48424,163487,19861,20113,70848,31928,105333,23685,78563,14638,54755,7158,24142,44018,20774,125255,20331,24280,10163,1285,2336,39851,4299,117269,46714,63816,87779,159624,11731,9971,990,137317,108831,50994,74554,162680,23640,131597,146962,170620,34829,91205,21184,1913,63616,18427,93136,156592,17519,67565,115882,138220,78622,88535,18115,2711,33554,109492,54298,971,24914,25863,36363,45715,27099,194995,14299,178181,111488,72395,322385,157719,130787,11897,81843,83999,11369,49280,118604,40922,61332,110343,53407,75639,40582,300440,54722,25637,13694,48248,48278,194521,56203,52779,48783,72627,10953,376,16733,280238,26351,230789,15132,25168,137270,3588,63704,73376,94031,74284,19443,159557,9697,39901,13351,119050,15406,146455,3460,29556,75195,37673,102524,92329,47289,98413,15311,100684,56345,7116,95480,11590,7200,167,23610,58426,17730,136656,27944,53151,2701,8824,103124,3017,90744,113588,53216,79736,65940,26931,498,29568,80540,143543,21292,1740,59268,16561,180816,42323,50174,40890,52866,10703,57169,4700,17191,4424,93511,49698,166650,26972,48631,165169,82879,69326,202970,4007,2376,231325,139592,22119,62851,37504,68816,58345,67398,186643,43331,277416,53749,15746,23102,17432,4793,151138,48822,54265,48203,198688,14305,54287,2291,18018,113378,123260,7180,97549,87027,120085,2920,76080,8190,102005,5641,64580,14955,59802,54028,58884,19367,81779,412567,85957,97053,103637,78871,29364,27637,141728,4767,30686,112738,130146,42745,12730,105040,14844,232,210944,36581,152317,135543,29744,3129,55647,58149,46319,27265,17499,28005,59948,7170,34138,5702,293047,110892,408,91760,218674,18469,46095,81403,14389,4610,35672,73060,11006,74848,104820,118143,190357,20043,105358,141735,5115,27093,45924,123073,52599,29433,9616,238350,78610,24851,58858,26769,31969,24613,18294,4982,32735,39639,143563,112073,202205,12567,4873,88601,44897,81503,101648,81362,34662,85277,17574,48173,21435,221188,40215,39576,80786,26544,64668,81841,10731,37733,247986,149188,127703,495,18382,54388,72446,43071,30974,198723,89608,41360,190,33045,8386,31658,19992,237838,119015,137622,50890,100913,6460,116233,267230,26621,104129,65114,14190,41542,14888,85962,23342,23041,26453,43725,71809,45186,4770,46452,53894,56616,221286,18973,9038,109299,55365,19366,26863,18808,60909,69353,41738,83463,12100,68561,72860,3980,13796,49340,12332,31311,27418,4255,53430,18976,45523,510,14224,30477,26581,4530,3651,101663,139840,22709,150861,31996,63923,120623,262522,3076,10528,2929,14672,130238,18087,9816,121894,100308,25085,55111,14565,18952,53293,2042,369988,23674,61789,133529,28783,108293,35477,47119,36448,71049,40015,33055,78598,198442,1833,159937,40654,77444,189245,113153,8621,18599,38553,35223,166072,2375,11659,21786,89523,6032,12116,63046,159398,18454,3678,32521,47626,11411,103527,38896,42946,15696,26370,10185,8413,37080,165583,4331,63555,14907,72220,50056,6623,62236,36565,49783,10049,17503,100581,55951,146244,24724,9626,17969,25524,109300,173965,99994,101056,46459,43647,53737,277968,8347,123521,74858,33829,44762,77574,877,81377,222525,123532,30602,43881,53145,2973,16284,81940,61281,127044,63620,9875,14756,114829,19032,9202,52759,119141,23928,120551,19607,3599,33401,76821,73233,117430,39968,36539,7071,5446,121735,194059,15206,45283,6706,15603,65615,1207,165723,92275,34773,104447,8396,32353,205240,164323,13600,60555,79205,25532,22907,33410,57480,107111,69630,32137,47832,70913,33161,20321,2371,117348,10714,86246,1625,11763,17900,268,78457,99175,97940,101092,86660,32221,14041,128504,125080,53744,124263,31017,13897,403,31859,21964,5633,111630,5547,77329,17961,18241,84995,25984,12983,67491,62168,47262,5241,297,51191,7351,8967,147212,82060,16821,782,11033,82431,62957,5026,43459,77963,203477,53528,6247,191852,87774,74164,215654,13467,1522,219964,28589,244104,16242,117821,67725,72570,156792,17186,15979,26990,44128,193014,35276,57125,16212,166451,68017,6905,77608,16364,53777,75921,76426,37975,26203,269296,64099,84122,12077,38533,830,4407,20139,963,43028,38902,42911,37503,83343,85045,16979,1165,60835,137387,58380,86990,110066,134540,56331,193845,81238,17922,163093,38744,110641,12502,56404,34862,26865,125964,12965,111648,25547,7771,27196,136980,9555,29551,107158,57885,18831,37705,35505,101742,13970,102109,62548,124657,23328,11124,89592,146376,248050,6241,22033,18337,80685,29898,11908,216623,67721,106162,146610,21377,15085,91552,42041,62560,122532,125336,102365,121537,142559,29693,223919,11515,110495,18776,22494,5895,185059,103592,229351,51220,100102,37027,257855,29359,54123,36066,106493,12244,79258,32002,432,56205,94836,90182,6726,14762,29391,48938,26864,38083,60364,3310,60192,14766,205567,57504,110760,22649,24666,46333,21517,3430,13135,28873,27052,158809,11597,20529,6695,23138,22960,37137,45574,6545,305877,43423,26153,24769,59844,14501,10430,134352,56169,13213,103432,49523,35181,13435,12408,129475,64620,230854,77390,51990,15653,83248,33466,44571,117828,51481,2187,10559,68019,18021,54895,48247,18354,33737,4554,108595,37288,39767,116707,9175,3726,108877,21616,83684,49862,1938,8543,276466,20134,108498,48770,102254,31914,131520,185291,100559,51890,209,19526,76471,50544,71814,99351,8172,198526,28816,20419,9109,98389,136777,76479,75596,30635,165417,48216,120220,25955,211071,39314,24308,32164,2559,146280,43403,9233,17947,90585,1786,86920,125662,2457,64741,32152,32918,122882,78538,44001,31723,56426,23375,103172,88177,145697,52506,49319,68016,31664,41488,18486,110400,7030,28241,986,109199,19900,42147,56864,65287,49183,7858,24e3,30453,840,16673,25907,68916,89927,6309,158335,36407,199737,130464,13137,59603,201778,195292,21015,42466,179062,172561,89492,11075,180407,31868,72493,20998,60217,9865,19530,39274,130266,54539,21623,12535,13505,40641,73375,4087,85633,2153,3117,70680,55788,92096,47509,98493,37490,271936,151475,3032,16171,96642,34106,78425,125761,19591,3366,19316,54508,24183,50786,194248,91528,33253,34622,108355,41741,705,3814,3883,108929,13203,67831,10142,59754,68208,29128,84820,56880,38794,24972,48571,40821,40476,18137,164254,24064,236309,79181,11282,395,39169,2013,51587,28551,9645,701,109513,115899,113566,12762,62045,58322,103726,41343,40866,244102,143816,2490,70346,40973,52618,15412,30720,104315,38917,42027,93676,17513,107418,20706,123890,13399,97727,24044,87962,65606,44250,98044,65276,74790,101473,19350,91570,1326,87790,172042,7577,100813,86896,85891,41512,108130,27794,14875,71431,12835,156250,58135,3759,22476,42176,115873,34686,56523,73643,108505,51491,20838,12721,32863,45700,29496,13700,34294,55360,29206,155942,123812,7706,163234,203,132720,49358,144431,8130,175788,35818,3270,76832,25710,54095,97274,28779,94621,74396,19092,128242,58067,20885,14670,93255,15107,63291,23654,126900,129421,59294,262659,9798,3251,67344,28600,44629,50672,29072,26999,31526,23183,49175,165843,175455,17282,175411,32022,45989,30298,90690,78118,83156,23749,35636,31317,7069,80381,94561,133756,14960,97404,6138,41065,78041,32843,16601,34123,9559,146529,123377,96395,54441,42012,84257,123541,10745,22139,106459,11720,150883,172651,154996,110538,4728,53447,25704,2009,71152,119354,21166,66604,1429,216162,8637,122250,63520,27180,29172,36124,276428,107787,77184,4680,14952,104903,24418,14793,51561,52931,8371,26342,48526,7118,92066,67280,40653,8847,34597,105438,14198,50163,61188,146286,50315,41205,170829,161496,585,197359,95056,1687,365794,91349,48507,5804,49263,5146,104902,96365,117343,132222,46084,96919,16875,8073,262381,79982,52663,13928,16056,153908,15145,109256,132308,18763,24904,167644,13618,40750,18686,147124,114709,150038,52849,2938,12568,48617,8778,5459,44202,44591,74914,17183,248689,13878,7822,80060,23116,194037,18487,2067,7798,43077,33678,244028,31320,74273,2794,19466,8218,36280,183997,48124,19416,29656,19280,98734,7715,18311,30701,133602,150307,126956,7378,2933,79903,13178,12593,86571,26604,92446,13574,44205,65699,427599,21118,8245,14407,27877,47936,33542,7916,26460,117762,21596,37818,2249,127359,209394,60044,47677,308089,36791,154971,31417,6998,150042,174360,12255,43009,29335,48739,3912,101398,53340,2580,146939,151295,45360,125275,15273,45383,27456,48761,23314,8750,60801,85823,104759,27894,123685,66968,39480,26917,55290,83305,2696,98390,57569,145853,340733,4919,20024,52268,30884,7413,203685,70989,112855,4129,50536,349518,68205,332641,159581,135361,236026,37563,176404,64899,6578,122033,63871,1850,85234,82089,66124,74145,121098,107351,12687,36881,117334,13136,14698,85933,93866,18047,32620,310,15094,46e3,88451,23632,36645,27940,87618,80520,58892,20976,27702,140090,96075,67841,103292,238964,87778,107338,17019,83427,67522,7302,8261,47570,116787,8730,80484,61772,174422,56005,131193,52875,14588,28471,59817,9586,15720,158155,51307,109734,15196,11025,59331,3884,52626,102602,84797,25158,27314,4437,20488,76214,189248,35023,114952,157376,2827,62439,102878,129749,36405,10329,109339,108633,36662,1254,13267,5470,87105,58004,15397,10434,159667,21864,52022,179464,3013,32147,31496,116832,18494,105502,129227,107267,50033,13481,9954,24267,22141,16257,116154,36185,950,115685,11305,176708,2048,178671,112573,287867,162328,497663,95170,50979,193861,50987,30368,136257,31830,46549,15119,169876,23788,17462,249887,57377,1949,35448,14791,43769,210091,3783,34612,282103,88380,245190,5457,20491,98908,11402,86899,117916,16028,162584,60644,320177,156096,31065,55876,22e3,77655,9992,23397,13757,317623,63978,215255,2443,17648,93231,27388,104529,93807,55505,140477,12046,112040,70887,40152,94365,112353,25063,114679,266061,71248,119555,15589,2244,617,14129,211431,70110,100652,7777,4383,85911,89221,21010,120615,58357,86405,37554,41647,18,15143,69662,60491,14714,186134,148344,42347,5410,168175,44535,42449,343894,129417,99682,20659,27272,140483,63455,222159,17536,13722,42637,62324,11976,114691,148109,2283,32057,182393,4295,147364,33705,2075,44303,30274,28331,63740,69740,29148,10346,44862,33716,73937,153333,12930,38784,247159,2515,41053,20256,83368,256189,54639,115240,5096,24661,175419,153552,26516,141,138176,63885,34115,47222,55709,2765,28479,38875,236608,12229,22921,77291,54426,45388,2860,57787,114579,295139,105782,17826,71066,19119,54364,69385,16568,12323,28057,33346,34919,124763,155533,101386,31644,8627,49001,303600,29868,63213,9103,77280,71333,9696,138789,37059,24823,5057,21352,32368,114208,56803,19424,10445,58514,8661,209508,26187,171838,10460,63454,14016,122504,41328,21329,46618,32493,38225,7855,31763,7945,29876,8734,6438,24205,97490,139977,130740,47323,33195,85390,57194,13813,60600,21313,96251,7699,27584,170521,139271,1363,4402,336738,129223,84983,69150,13147,3590,163929,207225,155260,55916,20288,4503,8398,98490,11773,27512,37113,84976,86558,28365,11756,116005,182148,13733,115313,47644,67208,85069,9347,14995,226141,14704,101835,41159,35314,13113,63526,214039,29978,50446,83339,17440,129441,72522,118641,97816,24907,73844,15717,118884,167255,96509,162793,30847,36849,51297,78974,77793,10427,1873,2972,9999,35074,28190,64297,146836,46298,60038,163007,108919,61219,2403,75022,127339,4233,110389,69022,9833,128097,88016,79390,222936,22570,94657,28462,56956,38803,81536,30474,152794,19566,16481,147408,74574,81895,20731,1918,1366,76367,187321,54494,24366,21690,61696,33283,107477,77499,31112,414383,74362,18463,218441,120929,59848,258629,201924,69269,454,19989,13054,59894,3623,58908,20681,35723,78523,102680,38988,184112,108087,50944,132704,52966,21699,18860,96349,201411,82697,85395,95658,5093,6427,177894,44191,32755,26961,155739,6249,31310,81030,26574,84311,120155,86730,113535,7424,48888,13516,45747,98098,20077,183995,81945,43210,26704,40420,75831,45648,11180,6855,57927,65528,124096,34851,2598,156633,107572,127352,38169,123845,60142,62722,105584,232364,23211,68120,1601,22169,89299,747,258039,80572,7258,152249,11862,101204,8834,121434,33761,19175,133142,46343,40178,48723,3589,41977,30210,38868,62257,10087,82658,87827,90646,16415,47552,351723,28298,72225,91146,272760,1701,11295,1652,109651,300747,51863,198800,29446,11794,32345,37538,22356,33102,37590,113544,37970,11478,179743,25454,103417,59905,221970,105196,145604,7817,164809,102360,16974,75840,255333,56902,6659,1954,645,59400,67769,7689,18675,5215,13793,20536,27852,3387,29523,259718,16860,94625,43143,29245,15848,233581,22685,63631,78557,22836,133302,84513,1348,51826,47129,98836,58284,1830,1749,94642,10933,6145,12506,10975,13879,103781,144434,10268,28409,32346,52968,121567,107374,77268,23686,35097,10501,155275,15303,47136,21102,168741,55332,90385,15996,84817,681,137803,25054,142275,6163,38175,8056,124296,240642,65621,4934,178205,16101,62803,60964,18230,100622,76465,44689,14545,9543,47514,16852,93380,28048,12047,107106,37575,101485,77047,57326,34819,96137,76916,6469,46264,115983,75768,87668,69942,13027,165,8373,114231,26434,52844,42799,182044,23580,146254,38081,43236,33883,146220,382894,14606,46035,36481,166621,35417,95382,2957,59384,60428,36358,66343,75378,22267,22950,83528,17577,56474,25285,4619,179691,75355,95836,53295,34588,171410,4487,14679,84208,44015,18562,109133,54101,11531,86052,174479,303157,28095,9953,35642,14564,39802,16145,77606,117406,53038,121117,53624,22062,1212,7632,127157,237292,189087,10478,127345,102515,181997,86752,87623,10966,121602,68783,68681,83042,114380,138349,191305,67176,50085,39016,1427,42384,1412,67118,122616,72389,25260,2237,13576,137346,19938,20304,2191,68759,5373,61364,238507,75814,23931,69565,38993,131741,38364,12528,87762,5679,129853,5310,186831,32653,90338,260176,389531,108118,26843,43985,50175,30563,25106,56965,18130,140428,4542,165503,117991,24219,229605,1819,129663,1240,3797,76093,18398,71339,51919,93043,27175,47060,216257,6483,35051,1217,16512,80798,129064,13225,69339,8548,237079,72298,2575,34280,51379,117910,55671,53345,247552,29486,39328,140821,34681,57045,60177,5004,90269,78522,2479,322607,48474,61296,13057,31558,4678,59271,6699,27044,31988,35944,12503,83480,4389,136508,3781,114121,70279,4488,155829,42214,2898,68191,75695,305850,45041,74344,106509,30087,17429,93292,12477,290,23080,114802,35714,18751,26554,105424,17775,2144,2412,100610,65192,113975,52975,180272,135050,129815,76238,106483,21440,63186,4260,46189,9711,28249,4169,23429,23390,8324,141585,63809,67668,38457,38063,39226,59972,1189,203916,62368,14403,16949,61767,85801,1739,40147,35049,76757,33124,62102,15780,103593,103009,53484,22952,67973,114645,6566,5245,50462,7601,8288,3513,194571,80276,1908,54592,5124,58571,2513,6800,273997,193904,1119,17991,117245,2508,129156,82366,26278,71465,63341,56943,39662,106116,94966,156875,9736,2204,122308,94418,27134,1280,24539,49022,45314,3764,50904,46424,30699,28087,293839,9400,33646,40165,822,147499,50263,116179,29085,11863,31314,5578,17797,5104,12454,1604,15342,219206,10232,67800,94261,25872,13565,90339,78971,75377,26649,41184,47695,11514,35369,20767,14227,41953,309396,148270,147938,33074,14453,27499,109019,39018,25738,240196,158931,52820,8612,95853,21524,137010,84901,70869,70021,116794,48404,38771,6732,1070,70990,187297,49140,5238,576,3564,253975,16027,16483,2811,37775,19034,25259,4053,2e3,70083,95774,19713,33431,92703,91314,42381,288770,48194,95985,3991,77418,13406,241328,245086,56533,35275,62725,9246,51924,70181,95331,16163,31410,79016,39312,120878,119371,275987,80124,27712,9186,220,23598,146167,85209,68238,282190,57048,31273,30555,80913,17594,75779,59160,135002,101219,189377,29225,96735,60126,62522,104e3,27620,86814,17240,147533,11001,5425,43682,410,49460,87270,69480,46315,59448,1816,76201,9431,11788,87960,29063,65539,47347,11678,33846,7008,196704,9895,6753,8633,120892,59970,572824,115934,6646,202559,892,48351,37611,251282,57823,67263,57750,26527,34485,90747,7685,88370,6144,64182,1709,41969,21458,62327,181657,49247,225330,122600,114574,107124,85361,111833,63243,71420,15655,191178,72430,18063,51425,54002,12364,53225,86557,18193,97580,41232,138398,67821,128724,8944,233212,101353,52099,42127,14006,120107,32789,32132,3498,18123,33758,56058,5779,128760,59888,98869,18445,84702,51911,13234,218379,20093,39031,8074,70195,20708,23462,24355,131384,60189,26390,10403,41060,7140,10781,49410,42261,87202,82566,41663,43105,60276,2768,5733,74176,28329,2297,145430,131632,83615,122915,105441,655,224102,5284,136426,67763,16294,188511,32538,61049,27893,3394,13951,159099,28542,17930,145360,9492,190122,32285,78855,26440,13570,58648,73908,4239,124561,2444,74172,53131,11468,10794,73566,11623,35343,64710,30481,4163,10328,38309,29901,10538,154377,76132,92405,24839,11679,3465,13449,11637,7824,2337,57754,1260,14458,41118,19878,38661,13416,159180,37074,163164,54137,28627,52134,184900,8520,40385,29546,30502,22386,66527,107458,6850,24022,47983,30603,35083,8934,304066,39500,9,28261,33026,77251,9374,44833,116312,34990,29236,63563,125639,135405,165398,159055,55690,88141,69643,236964,31983,25572,20436,36746,60896,31850,16179,11828,5888,3043,66368,9750,31167,7915,53111,36430,1333,64344,93659,20061,60596,180191,51630,6792,30244,43509,101058,22409,420,44210,109783,43223,27030,72477,72831,32679,29235,7675,47556,12258,39907,149412,84926,118247,24692,71717,105038,86009,45941,41189,89453,29856,52543,30627,226798,67303,59230,67415,34408,1367,99685,16867,128419,52147,4111,125381,117881,16173,44093,102224,31575,23234,24870,83790,127407,239098,3200,994,1255,100903,242275,117266,55116,38205,16140,29662,11307,40414,208793,123355,56470,4862,75600,30119,58218,70828,24075,26974,7802,192353,4851,5475,78720,66596,3409,28573,64396,30381,30690,59859,88256,5406,99945,103064,34463,37727,24238,86643,60088,4057,23741,5967,162904,38240,28356,93858,25510,122879,6897,3278,7057,11971,4400,35461,211413,21395,59615,39471,87233,55795,128426,3051,22470,41950,14705,3974,180108,80476,78442,204996,91987,15634,67610,139015,142373,35611,51134,10387,4353,153456,57749,181039,14183,68447,151532,21107,36452,20551,3186,46247,46383,129666,88736,140662,146243,2066,8360,7978,64818,106963,17896,47801,10723,114821,223295,74192,3293,3393,16987,74064,11277,91622,4270,29828,27951,387869,103235,1374,61988,120083,477,145892,128378,11779,211263,61354,18221,17869,46530,83061,108538,157981,90608,67199,95080,49064,195814,12302,66307,10348,231346,160732,112859,63633,146558,21271,31037,198802,47622,12862,95710,3910,77850,73961,85585,34752,61e3,4082,24595,103679,71107,8208,79568,150019,16615,24961,139857,32664,197366,4559,54735,32696,4126,162019,75698,13916,70108,159638,19834,9349,24675,175560,49643,18206,52459,27992,10809,88865,401975,133172,29e3,34558,30915,3658,25834,42430,36562,125265,18182,10155,40149,97082,208980,19575,60853,90529,66545,9600,789,46420,2317,88593,55595,98980,115302,5742,169155,1073,177901,3472,11189,63711,78643,65472,50459,127979,93,42202,67053,21720,157650,11145,141378,42033,22824,85705,79114,35584,15974,1510,54172,28562,12451,104226,19190,97151,73024,20948,5151,81741,21499,29006,84183,198074,54003,45120,170125,26240,35177,28389,64863,79974,60778,176915,232183,45342,2038,80253,41564,40703,32689,5430,100689,5366,23007,134279,14266,26712,73993,24934,64242,52113,102887,61801,46415,201049,54251,62133,122757,164883,30815,139966,2319,30842,766,13362,10287,134518,86111,81665,82440,28333,43019,18963,8804,161944,23439,102144,101145,80029,39052,248708,30350,117340,11878,128467,974,138625,63961,5237,74778,61834,67040,43814,13690,65947,33809,232476,115258,181745,28824,94013,9510,10246,93722,81976,7217,114383,3493,16014,69045,72692,12145,80981,9507,6692,1620,60820,330444,35474,33962,4797,7053,295463,46445,27026,12491,77988,49524,35675,90947,29114,166705,101385,133782,32704,6186,84595,176031,185623,45966,151302,63069,1699,107491,947,15458,74452,196212,6046,10498,12163,10239,35191,243951,9277,9090,29539,54460,22820,26514,112549,60372,51753,48756,21812,70861,260326,41,44222,10441,16961,48148,138771,216194,5914,52153,53400,212036,56519,26245,10117,45888,15294,138019,90913,26368,43842,42111,23348,6082,194845,161089,156206,51546,11647,30759,302912,262094,8635,78876,26535,35283,54183,31183,85484,147873,12989,5197,6356,72894,65347,20150,27370,73787,1493,45918,12366,190217,20724,13858,10981,67449,81213,7553,14115,72242,271517,11842,48310,88743,143726,22177,3290,243231,58452,62937,12592,1654,40066,33477,13751,9921,128442,15868,7106,75236,83773,10775,36938,10482,170465,17368,17469,161508,32752,98340,800,19824,264456,3901,87319,2867,26782,9630,113102,185815,24197,44584,86366,40224,3636,140916,31731,267731,9567,53678,72984,29389,27963,17106,50282,284911,60170,8322,12608,23374,89652,5268,39044,229766,8869,151350,31436,177342,12269,183212,120418,116270,2843,78888,69192,7865,184099,1086,129897,18383,70508,20242,18508,229924,124569,35749,50589,55626,9884,83115,40971,30671,18135,14452,38861,17844,201826,5549,26413,17189,13561,38539,10679,143331,3314,36785,171194,49685,187713,67506,4618,104039,17060,195080,50648,33159,19238,67559,134840,28599,157523,17130,38064,117398,94355,31918,13575,34538,40326,13997,3494,348283,62481,26862,3603,104426,244363,153709,112487,304612,199674,41239,35545,54869,293005,28223,26277,26899,4533,18518,15492,38587,80488,70485,160395,263,60162,11382,222152,4696,250751,51921,182609,10707,48463,46243,1227,49111,111564,46502,33342,56846,68541,63559,858,139927,16654,229375,76759,26478,33205,95828,23399,92945,2637,35630,28470,143992,50214,14174,21456,166191,65665,1711,21594,78019,97599,111701,36,147151,110246,189022,43021,30397,40757,131935,42065,73335,48039,26596,28984,15102,2361,7421,202167,69744,43766,52826,3642,83304,33873,75140,63169,192389,36551,92748,13039,123959,233220,21738,84447,77230,20228,187852,19095,25799,92136,108774,29237,53947,2299,118106,2687,8830,42331,202924,33667,2023,73763,30704,19363,19779,16737,35629,48081,24068,101013,162338,291912,13749,24745,328289,167679,70086,48299,23306,16732,17801,43322,54589,3586,63653,43624,53474,925,109177,251316,43805,13082,19511,86565,142182,92461,17117,101033,103319,64589,4022,4351,235897,5352,82705,107142,46391,156084,5860,61365,10558,13045,7717,18357,33922,12590,33065,6928,46993,783,46937,67846,8952,26295,6107,119656,18799,17458,50747,4229,179559,112727,118080,20683,41464,125468,51560,49749,44231,7359,35339,62988,136487,67015,5208,29150,24956,105186,48858,6143,18097,6972,16404,73489,58742,97196,36357,164616,5834,32267,13746,147733,15113,132091,34127,106298,39729,106426,22294,9780,15602,36213,71502,42808,66802,599,60755,5851,39120,67363,108623,126368,72770,91263,32486,30596,151717,7951,52002,43103,11768,68942,40901,39344,24037,127500,116890,48403,16926,86750,17745,48648,159545,34460,58419,5634,114317,67865,31462,23352,24010,98185,125708,69686,68337,13610,26271,70691,2980,4768,27225,102402,75453,28106,8104,6931,1176,6274,6475,112635,22498,6176,238686,26832,28893,90319,14441,15682,15087,39517,45270,109134,104440,45965,47645,81772,7876,52683,87720,12898,4505,185665,2769,113401,15664,57592,105229,137381,97059,119268,6876,43309,33886,128363,35476,144249,67013,143587,83367,25703,91436,59347,53236,2289,16519,19844,46309,58558,99834,23313,218816,231303,36388,51333,183535,109792,139277,54306,90139,18235,8275,32710,37677,82464,86025,92204,88842,117723,37570,128723,234242,76350,73795,34896,148247,58424,11105,11744,45746,63372,17118,49772,199520,81902,38004,22911,33752,3125,1995,53792,4689,26909,108150,146062,69674,41811,161444,84855,8999,28561,16731,93937,3189,21967,24890,22943,1356,145300,51569,28802,517,118679,31703,40607,48098,108854,25003,10233,73969,177495,5248,24516,215347,146192,48712,60626,69188,40735,5866,586,101541,6509,47590,52129,5969,222045,110933,25733,24223,65339,62812,2414,155418,35819,16022,78423,43138,20995,128255,240673,46745,236093,72176,57085,97841,61248,107,36068,193177,105427,55726,215229,20446,47228,100420,87091,14429,121708,23605,21157,187721,21880,2997,203976,99166,95068,25877,7724,98925,83401,4829,13182,18229,13718,239662,38653,116505,153497,30589,89029,38962,181302,43853,78872,180301,4786,248240,7401,106136,112590,77745,19731,60880,77789,125748,135487,5975,48627,34084,12419,215770,47557,254582,10364,106495,21856,67539,88981,38805,21428,48732,42316,12149,16078,52808,25327,51322,33850,51147,12253,122354,46077,56483,254553,115417,81834,150991,94662,86668,7381,12841,100650,18218,15741,22372,68294,50705,15535,84660,61887,22553,72299,31361,24824,17743,46820,64288,31582,77006,111674,116384,30760,80920,86149,77192,51979,79691,60342,122805,103800,240873,160744,233114,78962,54920,8608,3484,316104,72548,24337,5088,230040,21926,10172,36838,26,86221,83458,102176,12062,17571,41929,41170,28428,68239,41750,103930,2634,18313,53019,34825,97837,63115,24606,73157,152474,14715,91439,37033,109806,140259,30668,174760,380,135597,95673,136073,65073,134249,13829,17279,122305,4420,46444,10237,64848,203623,70728,10349,182885,65075,24519,25783,40318,34139,22222,63394,55266,102764,41422,20126,65100,90408,53640,35128,48932,11192,38935,96839,34782,39492,19396,41332,6250,5511,19492,51304,25936,104466,54099,73771,86115,5080,7669,30891,111700,13931,25276,72289,135447,14820,258641,25265,31005,281179,75286,393,95359,14623,13584,6680,101227,80173,44933,76666,54542,13244,39348,458,25379,109451,134348,81143,6959,65554,12027,51311,8716,57589,140731,28467,23316,17272,30458,25980,55229,77197,83798,28302,114784,7428,34548,26241,14712,39336,103304,18928,54080,12870,334,87722,15208,16895,142098,114262,39820,83913,57817,28682,7721,14900,108672,11250,62246,42849,415188,1724,26555,24549,25505,26443,107450,145899,61035,43528,6901,60726,65906,267741,21338,147590,42079,18924,73017,135236,15393,5206,4026,84185,1531,5988,113890,82647,303391,7386,69844,71611,189865,76523,31877,13315,19314,198575,32821,1928,67641,25913,104475,103489,3297,70391,18406,15446,113347,19295,93790,27856,1792,167471,116449,8541,4408,41757,63233,25765,86680,64501,27034,24816,34975,6079,4486,49693,36229,16917,21581,62426,27862,11612,54284,35702,194034,355,24277,48262,87411,70504,310164,118018,12516,47559,43502,57433,107139,9290,66533,80863,14634,34312,91725,28606,21342,67241,72355,43244,375789,37402,174015,105070,8342,44167,67494,1890,16365,11723,271002,1865,47918,8350,45564,27742,25110,125803,8553,49504,81925,62211,4534,15491,19011,80373,206920,667,102405,128623,245524,5553,113309,192739,65766,19567,22832,261958,29679,21293,71134,20962,105123,24721,860,21752,33448,18372,157167,94822,35770,173224,232737,75729,28937,46828,28062,25453,5207,140366,36665,30652,6169,67920,150458,92040,23186,184604,92330,20891,176492,49427,27828,38305,42495,143982,49560,25503,90043,29747,65328,47830,12932,11068,77721,9003,25213,94205,140426,46090,89945,138173,192691,33329,112232,129905,35709,27514,1841,19957,31411,127476,53572,17497,173549,55063,175135,19841,69314,5192,237921,117660,150697,4060,273045,50414,98940,65348,153665,164423,58804,156695,48994,213928,86036,28608,8355,39574,34540,16927,135680,18374,151587,10830,53805,16878,16623,4282,48030,8537,14986,46102,13062,72897,72,33050,108227,39451,45935,651,113320,40535,95176,57450,48843,5003,19019,10407,211163,3848,1068,4988,32091,30095,41692,15099,43602,107434,50744,7627,171349,16313,150832,352665,207750,33937,38256,51091,156e3,87889,90663,84175,24908,114900,50365,31494,83829,5398,169342,47521,54818,18935,8356,43094,41212,174536,10082,92550,6678,60614,23355,69721,14796,34149,128830,58187,3179,208,40325,28399,225029,401412,51150,31580,207268,6657,10993,69818,64282,289845,23308,12961,38447,6681,52944,31855,2572,47646,120728,179148,37240,45196,218274,4816,3695,21961,50084,35209,18073,51452,27004,6100,33941,1377,84831,171214,85,141510,9078,99227,32610,6417,11718,49868,65579,87902,73018,49062,46280,61742,21512,40862,107733,15941,29168,157765,144919,14487,5767,158014,140070,7241,573,71584,16921,223566,40331,179473,35081,47926,140885,41508,52104,59180,42310,32811,29048,123517,102413,80208,10104,14746,12649,153641,126022,37965,113017,4171,83,142592,2809,6362,50416,71323,116894,260776,16204,1524,5760,30351,12658,20703,54403,36083,45408,74772,4946,14485,50759,111222,10890,2195,167147,92962,130534,16283,177256,35016,15472,210156,151187,73922,117691,43250,52051,37392,24811,24358,30830,5775,818,21969,1476,127322,151783,58392,31021,106913,65215,89407,90802,28531,11690,20234,95249,44602,37256,18707,11928,5161,4410,26571,51903,49768,22008,25252,65780,209499,68769,203726,13249,137363,48845,86823,6658,5674,31881,1083,1823,108676,34518,166752,13791,14287,91576,91429,8665,11529,26401,16191,91972,30964,5254,28486,54697,79613,66520,18447,22870,45203,194466,22822,51703,12278,76716,44595,73455,33546,12235,144843,36154,51247,11116,33040,3180,225753,60864,1972,28469,12891,28879,10338,144157,56294,353058,38302,41447,87532,110616,27065,168438,6557,1213,50804,144643,24817,2390,136531,38174,247513,16190,4059,122791,131994,137430,39506,57650,16305,5188,54309,106128,20628,88071,67394,395446,250285,66176,91254,1399,114196,43915,60230,44853,27206,106353,43013,18733,345105,226453,51202,16607,57106,117175,35492,10476,89598,127439,15187,39624,13688,61570,10615,31111,59370,6238,175252,32143,224492,41388,95408,34384,148238,78307,38959,9340,160091,61443,15737,11216,41244,170,38299,102443,113097,26382,14027,33707,3957,76300,66160,19431,18900,6952,1717,108656,82206,188021,257335,27295,43999,41210,31777,46956,57457,12657,11489,15697,48060,204748,53583,82422,284790,30503,137341,8120,19615,220311,15991,10217,63424,9808,67431,70976,98221,4491,15177,28535,144789,751,13230,2394,1504,33977,132104,30316,22230,931,97193,185240,24826,22687,174322,15307,22988,1390,188745,180325,29580,59068,74903,18994,29195,79,15436,7622,38462,11566,138710,44828,45774,37768,99236,68137,84083,19282,22698,17134,74807,126662,173497,46248,16938,119735,3212,28292,213652,49013,9975,32180,45660,86250,4801,68788,95490,77482,113751,11994,44624,94452,46839,128497,100316,5798,58588,73184,202987,65417,37790,88524,1606,43156,97964,105717,34947,11203,100060,37742,130074,93653,107799,94311,196106,41347,8035,10780,16390,27883,118236,167395,1979,25006,19375,31628,18916,144723,78502,114047,103107,86492,107686,5844,20934,206963,23556,22591,16562,146333,20167,10471,117434,33085,2863,9740,36669,41849,37271,22790,18209,28979,8231,12952,54408,21731,25130,45208,55748,138120,75826,414,29593,9925,292865,25999,683,123149,7036,92159,86055,61827,103680,23176,54918,58466,57578,13305,5709,86479,16697,31064,17660,200919,10770,49793,33423,32370,52047,16488,62555,6459,8426,83493,7763,59725,82812,18628,67760,79405,68557,9612,7673,28102,56517,69620,171797,32458,29541,15870,81109,32080,207644,71495,21202,11039,91036,61230,2810,130800,32260,4613,60590,37112,75214,33979,126402,155062,30642,63875,12810,194463,82799,47664,16725,36685,43367,61099,449,172150,102867,21691,301838,36745,7130,18671,57316,34852,38034,54182,35578,65900,99486,19771,3456,2658,16914,99866,28390,28109,8262,21147,34353,20006,4228,137085,1675,203023,283196,198286,214375,163329,290603,152574,40471,83506,30068,14730,23177,131539,34759,27668,32178,71896,104799,116305,85430,119262,42860,25160,8911,23428,49437,105322,6519,16203,6349,74711,1230,38045,8540,75165,44736,25909,51026,317034,4984,32281,91312,27060,44431,17817,45363,155937,239085,35697,59784,91993,29531,126740,213757,76560,167776,285273,24262,8237,65030,41160,74437,48804,118916,13159,37842,1031,75349,1478,11655,108777,23435,277425,101734,67469,70231,124711,43532,28514,65526,54956,1e3,21882,17728,25302,40952,52214,149632,1999,2111,3259,63362,89961,220561,39777,26335,9063,10572,12416,34551,34623,38604,24723,5947,15588,69927,66252,119177,69173,46629,28714,70715,212408,20521,406913,74380,11716,50659,50862,37009,88460,130101,7210,53853,538,65120,151950,55806,163748,52837,13153,21100,16674,64536,6091,138201,44837,58547,3723,163,2177,32288,85454,34033,8497,14282,25742,10535,10741,79559,117493,243787,49337,100718,79495,40139,42956,7551,55433,15421,31509,23034,45081,547,61176,53434,328001,8470,36263,30145,4519,74173,53935,11845,73774,60211,78025,3,4102,73782,109293,315332,48412,26683,13714,6865,20128,18490,104141,325,39470,171970,115860,15707,7268,73301,74336,31370,2368,111827,107757,136231,142844,97138,96638,84053,38691,23801,1588,10573,122098,77039,240,186135,146101,11996,18143,112963,46171,155836,348769,47795,121213,116266,132515,3344,144804,31286,99187,255838,129694,35894,48779,55235,148582,71967,65282,15174,13920,47080,6147,108242,157593,125025,7136,1286,28957,127956,28402,98813,20805,7532,109417,40610,5041,32958,15142,18408,108596,33543,50517,27748,80114,233434,91447,487,37094,100048,30541,43477,10639,89862,155868,37667,8726,60684,237903,73408,99589,12190,38739,97348,3914,13594,2680,149016,13907,30171,28343,23530,115225,61104,35821,147679,14337,4297,244282,24085,326976,56428,7851,21303,131620,71446,83253,68692,111870,5224,15813,38197,49026,45057,13660,3306,76345,40671,27905,91072,996,68527,62085,91351,122634,55109,168209,2024,27560,112707,17352,8306,167115,169921,166958,5031,46020,11844,67284,19130,76185,6920,32849,5450,14610,22451,21002,17392,31872,66682,84796,13709,40210,59898,12029,8719,53564,21462,91884,21647,88379,194428,12754,37797,132826,160016,22567,54383,53186,77611,31107,8339,4694,19185,90355,23597,17222,140675,28442,23668,55977,9128,61555,28774,155229,17658,9390,24379,69357,15752,127381,239631,62460,93181,55913,45133,140155,18676,25249,33164,29581,82837,67223,22362,29975,7317,52813,1943,29613,20012,207130,49617,49651,5636,15334,36313,29226,28084,95247,72072,19e3,224932,15811,114,32127,38097,37508,88507,37225,27359,91626,12193,69279,20608,11055,88156,92808,2152,57259,55275,72789,24475,104414,1708,9882,3818,48661,66897,1631,34806,227930,85815,87753,18321,250664,72733,25107,206797,50891,8082,196411,92596,96764,152823,65514,22819,387277,62176,51225,40329,15563,189,3659,73670,64357,51793,275136,33482,86653,74615,67058,11318,125720,15388,22388,8267,1730,102663,170910,40784,7144,85373,13040,7088,94309,583,44224,140424,77439,18496,164026,36578,4722,9151,5824,63365,26510,35199,40500,79277,32495,44614,35233,9566,203293,152144,7097,2330,183480,98629,13423,330887,44130,68600,30939,97829,31012,345465,56747,94879,4939,160027,149761,99423,46099,32251,15332,8761,96094,128555,5763,235318,222223,55729,30241,55420,201746,3987,81382,8259,49325,23287,7719,24633,251100,92311,18591,110533,64759,170260,393860,7175,21144,132887,3593,75346,101277,91109,16387,259187,11627,57459,173829,44694,55780,49797,89192,120443,62622,3904,14814,23887,1027,112258,64955,99800,11132,66353,36202,48624,18158,88481,96882,43059,11040,2455,7077,21651,181159,99126,100434,61388,68186,19161,110468,120052,8819,55324,41494,7014,37689,3618,87729,92615,207943,9823,128657,12587,15857,6379,67628,51216,71775,157617,63244,1503,3864,218754,110864,5769,21492,7243,1192,87921,85529,31512,18537,42698,35350,73510,84474,34301,8991,21013,35034,566,38832,19838,35586,37216,39413,55006,12178,59742,856,84563,6900,25632,17437,49786,30723,13847,70845,4044,7843,23944,235976,55530,48942,6518,20939,73769,192653,52936,95207,23895,132542,142982,22632,87452,48042,54018,178468,10728,26230,23559,363,81269,142012,5718,346258,31456,84333,246476,51018,66692,101804,120570,39962,30373,70593,2864,60541,19425,54209,104092,7201,31545,48018,25865,15442,46257,40443,8328,6451,111782,47527,97754,33046,470,245116,31095,39,91934,87208,73470,36708,36521,12801,70624,36272,8892,79768,12427,55454,103756,5908,52390,62962,22720,141138,94634,41689,128402,126390,6628,106394,35527,134394,82727,254651,194502,148064,89549,3202,28359,957,21954,27906,49840,142747,8307,24206,48978,1186,71728,133038,71474,91306,6333,110959,74600,70387,18983,62609,56057,22970,1147,135850,1321,28834,3578,59715,102227,32827,81415,99952,55636,257598,390,22702,35701,85872,402916,39216,189795,14929,19467,10112,144422,61514,5279,63421,134686,41436,8424,51925,10598,132295,124416,4604,194739,210929,57866,31829,51626,50007,9976,91878,61906,56168,81906,60918,61859,40017,23059,16887,40927,62064,12785,32893,32913,21782,93965,20169,44387,79084,38463,11457,93950,27127,157050,2697,337088,5116,54128,48255,33279,8821,27352,25515,124022,65710,28906,38557,33390,1722,104435,72215,38551,12094,30978,25113,6671,37355,175109,42862,98024,65406,221276,59624,118012,64637,78760,86697,21426,1639,40350,12584,67193,84144,31396,7863,143011,69629,63112,9454,28666,65798,46372,134721,6314,51402,30837,151922,2847,38676,38008,92823,136245,17540,5504,109295,205242,37606,5211,214892,1586,20670,208711,137743,19328,40652,16995,20023,14657,154919,34422,12996,13918,38221,47690,16398,2959,37680,89122,6721,198469,91876,172043,83898,101992,26084,94570,3635,76958,22853,76497,38266,176590,168403,44464,142840,79180,184594,1984,41806,83147,11985,6546,366068,59732,24533,271505,8736,39084,222992,93429,28962,58985,86665,8432,30028,14548,32439,54424,165029,55175,27458,69046,121277,46168,33732,20661,24581,135574,123110,37556,79260,72611,16957,12939,46162,58238,44907,72936,253758,41324,32518,96480,11949,124438,65280,43256,34107,53533,43531,37037,28366,45970,32741,173438,6121,194202,62969,26355,30314,58370,28455,1848,50519,82830,90393,21761,295490,10936,256940,133568,44050,20269,4089,27457,21610,219460,36743,14821,101388,52005,13124,30979,140816,167362,26054,18458,60789,34917,40447,26606,33422,9066,3452,83614,5761,20263,137238,25038,91310,101,52322,74548,42572,38084,214054,186568,31802,17665,30620,141936,37730,14420,4265,187218,49640,188208,51441,55388,96452,66659,40869,42039,60967,221027,19234,178581,29105,96050,9165,196118,157335,3738,40354,117436,2965,34136,59659,15570,50843,230035,31444,71260,43886,18316,5387,38500,168508,17406,32174,8828,103373,143806,90367,3560,18719,122310,16508,26719,2541,105429,6645,37998,73190,10591,235916,49737,87112,233941,53188,32193,79154,4544,52905,126477,7580,63501,57314,3216,31337,6541,103083,60846,49,9756,15481,1355,43840,14319,13743,27486,10222,73114,230718,418644,16706,6674,279748,23058,45273,295831,86306,2743,5535,88773,21829,35253,120938,31153,3169,16839,42847,8751,80974,33942,36867,35514,16485,26474,77775,56877,5391,48346,3882,108713,31403,27804,55248,26235,43821,136104,40118,175507,28034,203908,18732,1788,34030,106427,36958,54359,7251,44936,15356,69139,455,157915,22173,140291,50348,43275,82066,49621,54952,15216,36226,96695,66855,6936,1987,8227,196087,4631,68827,99004,47541,110265,17953,147605,110242,58520,31312,38724,329975,642,3155,34497,75937,6207,73843,6120,17249,51429,117746,3218,910,68961,319671,14938,29555,34700,1649,66673,72268,9655,76800,153087,6941,210168,27130,35398,1780,73242,3135,56689,19556,165307,8765,35967,121458,13333,70453,17350,117253,22265,13340,44265,39869,441,3742,135025,23581,33309,16543,17731,13291,157637,283005,21408,101360,63887,52312,83873,5338,233779,23759,186949,34531,177320,38069,156465,91004,19353,59852,68160,14891,1338,1072,29823,1950,28901,81407,313445,73038,84807,162348,240257,37162,138934,16111,58013,41253,102951,16457,96056,19541,56402,67217,41638,94381,89674,29481,37456,80815,151579,13937,13683,132537,19699,134545,67020,29816,222341,141235,427578,48868,129557,233342,23077,87871,16213,18728,16184,9469,37913,19680,2798,171356,178328,13216,50049,72690,71904,124644,55455,7504,29052,41036,266546,19899,30391,188755,8659,59469,16,104298,112943,53865,76203,138226,68857,139953,14125,107625,119795,173133,4398,50273,48808,54390,16466,122086,31835,67035,50971,48859,7508,46427,66477,73021,84615,39985,83076,46779,201569,53336,36443,60865,168164,143810,51393,25548,169307,32896,24485,38424,21837,29087,275813,51674,6714,64883,46169,187369,55186,76192,12852,12018,62134,31067,118303,16542,12125,10579,4928,26291,43854,7091,10946,253716,109062,39283,17261,113012,258512,47764,125126,32646,55892,80279,201623,149872,3192,385,1208,48750,5376,58738,22335,5427,82416,47811,32435,143086,38930,94128,59975,156037,37977,38224,62485,7698,50405,71027,16462,21559,136153,34131,107506,162069,63703,3101,215029,40407,4178,3774,9187,80019,17880,97926,67579,2600,18405,8351,47924,86638,70820,92206,86453,29610,42241,119200,3198,15466,67813,57863,35454,4779,99518,4649,104641,144269,33730,38073,65864,6838,109456,193298,154007,5623,45741,30846,182578,25573,157224,1543,58575,138703,146140,44971,49356,18275,59064,20300,13122,11848,24453,11973,9797,86843,2919,25530,49210,1130,161220,76788,75373,85604,34926,36014,17777,17255,51533,11676,92226,51845,119859,21525,5936,18507,28050,1140,31418,14857,34207,47859,10750,36382,32079,106909,59426,87757,38393,110042,15965,97104,33757,35344,97993,53979,33651,45407,41884,82515,173089,7177,58371,35365,47543,51927,35587,10670,23544,29306,84233,39976,76076,62097,9007,8668,28119,78281,120790,19835,143020,54968,18670,64959,20649,34469,42570,33001,136570,87796,120044,1106,58700,63951,127623,12805,83057,40212,31773,49850,7361,54336,347524,101314,23751,19569,48791,29174,49369,20467,7465,75842,38281,623,112457,60210,28849,51003,94720,6426,90047,85560,43761,3579,85105,34607,90410,118528,7224,42907,111163,18168,6960,161135,191298,5247,100584,127552,171568,20121,91173,12636,54615,20199,63730,98105,2396,40387,14438,125012,4765,33235,12865,45299,37728,82098,77872,114037,59253,19675,24838,398016,102561,11446,17069,57508,178277,65836,99941,26114,2585,271882,136866,50126,11027,155648,118367,14585,8910,123015,335383,40434,41016,53021,14439,87098,176860,201543,121888,2358,9286,5739,22666,54270,37884,169381,33984,93859,16124,89364,72207,51639,76366,99029,65812,2198,12147,174891,194289,6986,30252,88822,21284,11445,288337,160821,33034,100869,43852,25761,52882,1144,103809,1924,84458,86079,43411,13542,139276,18141,34978,41298,7276,26481,173800,33210,17951,142652,33616,33677,2210,19941,98568,2486,192414,80136,12058,235883,50963,249638,29572,27221,47034,6124,72107,63346,97620,158513,299699,40388,23235,37176,224244,198386,121323,67992,23827,63170,17838,106622,158590,26807,5345,23489,91891,55474,74834,37981,13058,5977,72552,34706,26828,145172,19904,21367,34043,960,77092,91381,4733,47446,7680,41697,5170,16960,14741,46101,13656,473,51842,37433,11103,11551,121951,13191,97536,165932,50397,51628,129028,9069,44885,6590,59195,47045,32940,225472,90345,21833,13303,29407,96615,141951,5198,6028,18395,7181,3861,14966,156358,167182,36529,55253,25942,173153,30959,27261,50691,150176,162201,38467,48462,80602,42163,118482,168,108756,26011,17166,54149,456538,22512,91374,13816,90358,131615,18132,226707,1824,28139,26860,42253,93877,77351,65575,8980,80574,22020,27948,40422,91324,76376,13528,39281,91685,82215,122541,144066,1983,193851,17283,26320,2739,194978,4790,26845,42627,61300,65815,174612,55133,4200,191130,79771,158321,52280,166796,221620,62461,11278,4067,88152,83409,31717,121367,13522,47325,37945,10406,174348,249321,154101,64912,29938,51775,17220,15776,166138,78890,84425,54121,42861,16368,24572,291647,10197,32073,22651,11677,97509,26952,35787,18424,41910,71614,94977,72318,41594,70024,275419,37702,60199,7335,39107,61315,18271,18394,33768,87884,104277,123724,7277,56288,71981,189803,49320,3352,6798,14240,8954,69220,94433,57372,28620,68863,193727,85575,42309,41667,67689,42081,22543,44824,12719,28540,114236,101553,27638,27296,4300,5353,4663,19379,94098,3758,95888,95144,80344,87320,28447,259518,12718,71391,152731,37063,24132,31911,104896,15672,103782,1521,4945,72541,23717,122632,15619,87175,206120,29428,189780,61416,28350,44457,972,1175,47233,198738,95789,41907,21953,97034,59341,22864,53713,16873,32971,20693,20954,31336,21477,16169,38370,16412,9019,3841,24599,21938,17085,6484,81198,76413,5849,72514,12320,65247,276175,37234,59796,52642,16312,57349,198507,94148,46134,18958,125552,1747,18725,151873,14901,5490,68287,29470,3689,64794,40814,26018,25692,54450,2703,88278,124886,173087,174e3,24159,179477,24276,46004,201876,209202,445,52876,31948,30206,157610,39180,18439,44124,50469,5774,96278,222758,200216,50290,45486,20435,46986,46276,140133,142326,15569,13363,47522,92583,2182,7135,16853,22998,30272,4952,63263,35623,39096,53789,44864,20053,110392,124213,4630,16087,28221,127787,25839,77481,44693,13464,113146,6983,27069,55717,50102,4760,7107,26186,66507,59145,36032,104182,71328,29425,64317,50781,47465,94298,69706,74899,22754,120756,25108,93077,56834,73286,39928,16218,41699,176763,7555,70819,50083,26895,23315,26014,16773,123079,41712,5719,31516,90427,158540,85051,183128,40864,27505,55392,9058,45224,96857,30901,136622,96557,56304,120061,11501,151448,5773,89743,7769,86069,2935,18471,41628,10114,33660,110170,49479,26745,92846,33221,26731,18795,87076,8550,2100,29972,120289,3077,72490,33784,2630,208722,50861,63483,79029,6419,39467,14302,45286,64207,9686,67513,44170,1050,77246,59266,17055,53801,7150,11111,42432,4278,94579,362117,36175,42902,41933,39002,98489,22913,74161,84773,57036,17556,162288,74485,178760,93867,73635,128860,50362,261,67455,80001,46080,35662,4368,25247,19230,74393,22588,1822,27682,235324,13798,85998,13194,235067,23514,71669,147632,23191,134748,214683,105101,1518,25489,247114,7380,54842,26922,3971,26361,20844,68642,170517,77339,123255,8963,77818,150998,48466,36806,2732,23261,11741,236162,18243,126216,28690,50546,16385,92760,197383,246558,201295,88255,67588,71687,176076,172653,169058,33906,63747,24835,157621,43338,30050,46152,132741,2770,51371,94835,6614,15112,11749,56936,1250,19027,399017,58036,100215,23388,55815,308768,124152,94803,9521,64186,8971,28,30427,62163,7616,103838,35079,29203,131235,7743,17389,10882,37420,61460,228512,85363,41581,131077,62822,119647,10130,54445,26925,19968,29016,24446,74028,24176,61448,67185,9254,8563,119129,9771,99184,37716,39514,10532,221512,258753,218630,55980,23394,32141,61924,66749,32411,3741,36475,26678,77010,44946,91203,128749,116953,20476,49625,53116,13735,102335,29376,51946,83407,67892,59212,34685,21083,1546,112982,32972,74397,1078,190545,16082,86140,58591,89611,101531,10061,105104,76319,20035,17551,52611,169061,190842,100780,23907,90413,115619,9675,34710,193435,49443,129734,11183,258877,16318,136182,126808,44635,27304,192375,2599,125648,47051,12091,23814,721,58800,40137,66726,97930,60877,74487,7942,54326,9841,41428,13762,8211,85383,6950,99177,79806,201786,296464,124087,13144,29741,41721,47634,55088,254286,106408,17041,99064,12942,64086,45233,14005,2612,55827,255,7984,13980,38574,12776,46654,73499,249951,2101,26676,25996,132326,116415,119062,50449,31033,23038,11589,179252,20007,14860,129270,21143,17796,144715,60106,70758,69842,34674,282133,44014,16774,57268,38528,24053,46373,201667,28327,471023,51889,102667,21193,114909,84132,69317,96723,67969,16134,68145,15058,28765,32035,2524,101089,98664,25045,76571,14957,86040,118506,262428,154764,81573,39681,283900,73287,127825,544,80448,52347,38512,175971,15180,45467,33086,46552,48894,81107,43213,36672,54025,76703,8053,7608,13299,56619,20752,238099,54164,105133,1444,32942,953,37564,8e3,66316,119463,106817,404,13667,149108,128597,31267,10269,49836,106150,1484,52330,76965,160486,171648,38456,31263,22424,37738,66245,67467,143369,60471,75610,20895,115528,86070,60854,40796,49347,18989,15030,11371,37578,15779,79867,10187,86462,46402,155626,93200,40229,7090,57547,108053,99598,11088,47505,41218,206017,2173,20988,30219,22919,80563,57566,42369,93141,41675,2407,182519,120495,27154,16702,29456,14349,7958,16688,117177,140375,42467,261919,74916,153569,10836,34742,49526,7621,105997,12212,2270,392377,7755,17959,25086,232152,138791,33847,13860,35316,5811,1344,71259,50452,207539,92635,50359,5821,33674,30255,2086,2587,96264,17543,42,6029,9580,43007,139248,82831,12917,29607,25786,51467,42137,85161,100698,31561,88989,121990,278500,3602,109344,37982,15279,116442,28936,30880,87894,58079,128661,126731,67392,28051,146885,4861,16216,97344,42827,147561,153948,22684,21335,47685,1853,43349,15185,59642,10229,25520,187921,108972,5579,98037,24945,6697,19193,63734,137934,75056,89740,19767,224268,56138,63643,151661,39313,70618,84031,89723,84074,13703,85626,35460,8867,64845,3439,57906,99776,63968,49270,81130,34356,16210,23547,36446,34090,140028,72439,2221,22163,57058,363492,113754,18913,95451,48663,54464,54037,176097,68425,3023,34906,29482,117389,341780,80431,58330,16753,92616,60907,94846,147486,4498,48646,7773,46801,7778,18946,464978,47558,33223,177444,7328,15626,63337,94700,11743,9351,255024,39098,16447,42647,96230,39769,58840,10068,63439,35800,65843,58823,413844,9156,51258,7434,61791,85018,6872,3692,28096,7121,33024,6009,75532,31997,192535,9661,3304,9547,14753,31987,25314,55689,15896,20430,39472,31340,99744,25398,115569,54883,28719,205423,23071,57855,64638,149867,25671,82403,37616,20668,39989,77996,74948,140555,175248,64810,36515,46595,4958,248773,24045,28728,136673,168704,20804,114833,100325,27135,21205,96151,153134,45992,7093,13992,76047,1980,19432,145001,75159,87462,17710,1013,45556,34297,144882,20648,26061,11319,129567,108555,18872,464580,33386,22717,65948,167189,5603,135042,79542,8801,202632,18114,91882,5973,5239,67315,4431,60916,47819,71693,32597,32606,18183,45072,80329,76385,24749,51305,40314,156514,14693,130345,13168,66214,18029,12858,34801,27628,14544,10823,40522,40185,33739,148694,23548,9923,61012,28859,17933,19442,34364,99849,164107,141167,30629,21054,6744,36491,8096,42474,41706,155060,30650,10600,163442,1143,96655,61390,52359,7559,51568,64256,203854,4467,22453,14504,436398,7878,6980,8293,63610,293747,16167,35763,19627,147603,15419,18032,110744,51346,33681,54571,40472,48615,39073,21604,13754,173027,92560,11083,47299,63062,11813,52007,29883,9734,139722,15953,1550,20651,13616,49306,16113,90089,92326,7584,30712,72424,164858,6831,152871,55746,197721,34167,196442,6022,112107,55215,7538,123381,4920,43539,77165,8939,50392,34192,20225,79762,22505,58667,40770,29788,97180,82835,4568,8579,13273,363569,35898,49983,436,36598,3237,131691,62418,35591,8101,4073,379438,65218,76072,33887,2968,27573,212619,288680,68278,72851,150504,217896,6913,121339,22017,35340,51072,43616,75043,31437,10833,81487,4364,22968,41454,106687,85446,19863,109625,149241,524,141850,214404,54376,657,237023,9401,108137,53800,32474,49712,53334,126876,27337,45552,177696,8269,15036,12097,42240,2328,125374,119295,99715,2500,19624,39441,27220,102691,60957,94543,39101,18566,67362,13975,78230,25017,34017,239007,90027,39351,41681,35354,43822,1043,916,58587,141983,94818,38799,75459,41114,67432,16195,36606,59568,22272,126769,31424,68659,12287,134302,257977,5756,207285,95637,47248,117689,19583,77451,22373,12200,54993,117118,34244,29386,34562,53819,71267,64172,77665,49368,7716,59301,25749,45426,194789,17297,2650,1766,32501,45198,20403,20984,6600,14171,94604,19037,5402,29896,9938,59935,109708,88081,145182,44844,39167,352626,164173,35374,45982,6122,154,73419,220487,53834,53601,17992,8609,229321,5610,68098,66815,71012,95069,140968,27396,8957,134489,24656,86659,56598,134852,17316,123838,255436,6613,41610,138033,81452,32023,32396,123687,63398,8693,29712,30407,19296,121188,3551,36099,20032,111948,56624,16547,27453,35916,15378,52039,56849,13489,22214,73177,53097,277349,2157,14029,187886,10260,141743,246460,91880,50869,3788,49486,133566,54950,33120,129337,53768,18333,9525,26902,312251,10297,9020,70759,16647,112432,59260,84609,9818,82766,73569,468,46001,75780,55028,52106,11498,43645,108069,17150,17753,29417,16705,31799,9606,289,122254,115975,8620,6133,255357,56908,14456,133464,43554,79224,11247,29630,160,12756,25464,65960,350428,62521,321796,100359,67358,35169,46172,113128,48988,88868,31094,33266,6847,60887,98188,49659,69117,92977,220228,13947,80181,35103,62170,97351,13475,2440,199768,19498,36597,46971,25234,67806,62881,84717,73648,181966,10488,94149,21550,26655,63436,48375,14405,165650,9621,24439,28043,42735,4490,29963,56674,45373,1934,262446,50855,67098,26898,5261,52696,40644,33900,9440,180286,87162,22940,19704,26936,69769,10254,101759,27406,12243,48e3,73926,113215,54935,5726,192787,4312,106216,9366,11550,52949,23457,212271,277152,133895,108374,6191,96477,29980,218916,58024,54696,40853,91124,65894,91170,65908,252552,6793,29212,15389,44516,122515,52617,35058,9017,103536,39510,49136,19242,130652,662077,74699,47024,31422,8517,73351,24399,13867,128360,4810,4434,61779,111983,61036,17798,110240,59722,102960,39688,10001,23803,23039,176498,56659,44814,134295,17188,77577,74466,226175,102472,154333,63900,111747,18062,41171,79669,32773,408933,42562,28931,30907,107388,43487,2946,240310,23938,24354,319,184983,7927,6488,1422,10790,68809,68209,64775,4361,202,17123,59634,51200,44391,18188,17843,2619,74278,3230,9540,47187,21702,36274,56894,43907,16310,34790,16866,6150,5561,13587,107545,108873,126867,86986,28640,33427,19017,5762,80637,17430,46903,2047,131055,25958,13558,5444,47152,13900,44563,122857,45348,70863,39593,54332,38068,33637,318,40310,143467,18502,24520,11377,62013,28942,27246,28269,83545,17999,59015,90707,30065,15161,34720,1263,37008,2012,6060,98575,92933,5721,299,199555,24578,29223,2985,743,115825,109523,136657,47454,26378,53586,3733,174945,93340,244456,5693,37386,28782,89767,27545,23573,18798,136425,34320,84778,20041,48453,38215,7477,71958,40621,8773,5874,187927,105965,51100,43533,18083,8443,10180,43597,2003,183999,69689,12216,129696,146188,62389,34044,68410,12765,43273,26949,266807,3345,34477,79197,5688,47539,213110,21634,22257,50092,32222,42346,39530,63668,98,134978,74022,5152,59088,174145,37220,9934,9545,118937,5724,87240,19875,15784,40143,23263,87513,181654,285152,37881,263241,4966,43934,10433,186657,6470,74416,225854,25908,142677,246262,32280,6192,75890,45546,143264,135305,29742,47013,77787,11732,126658,8763,37950,21806,57557,113464,89465,108995,164574,23894,22996,23169,15369,23117,17642,130607,40503,36239,280990,44666,9981,40427,147487,26869,168452,32886,32991,46798,240839,15111,70502,65697,88548,44145,28701,48767,31139,206777,35659,181164,166262,14554,171445,31786,66523,76607,17956,6507,31279,90476,116611,167918,6560,1243,115324,80128,41867,55897,187323,37069,32596,189444,145931,13390,105530,65709,26805,6999,55714,41300,22915,68951,22138,21120,22264,10058,19945,33635,56123,99085,10032,5818,6016,46649,57476,35264,94413,112522,262288,93686,83038,14341,23204,28807,66084,77987,6101,126673,7133,38126,5923,122091,170240,97772,46874,215746,43948,41622,3272,55596,8332,146411,251315,13533,8561,81521,115449,48616,175175,2063,186556,3036,134537,75772,29728,82360,22973,186559,86348,89100,38388,82297,45610,2613,87082,9986,177812,57884,23591,47485,42543,33582,44713,74439,257444,252451,31825,35631,38540,33066,5147,13973,4343,51830,70378,22827,26448,95560,36896,241741,48067,203953,298860,61620,20450,3220,67272,6586,107662,100160,108684,6929,57226,4762,7457,1320,40404,77204,99309,62750,208653,59977,44e3,74315,34332,5819,172217,64904,114077,18147,84012,1791,98456,90930,21446,116669,103938,7422,85140,59713,5768,326211,16239,75411,13229,29398,10758,236107,1539,112472,95979,152154,151294,306,21196,38146,10700,6891,84282,109646,56492,40539,6589,119491,51354,30685,140209,136906,29622,73617,49553,70525,51671,166869,139616,74395,37439,49595,45678,11959,33211,86560,52434,9282,62690,112155,130810,5243,108261,99970,265613,72551,80049,6391,33365,90721,66737,69872,87011,1860,9032,112544,60905,37371,89015,140351,19076,850,373531,2802,36725,218795,72062,28990,16550,24614,7815,6187,26336,33373,32162,42791,73555,32062,23386,10244,56392,49442,27076,136262,12412,14883,1134,33675,97153,199281,15608,100152,74072,47942,254301,36451,16026,10687,65067,56708,254030,30290,50490,13864,57941,259331,35588,23485,43486,24869,21620,92971,22072,88645,1048,182050,13343,32452,14825,19509,3325,216938,45740,99716,189082,53740,78245,25609,24311,176777,47340,308354,40669,66085,14102,125339,9225,128709,97207,1271,200933,78439,113451,88975,18324,46521,11819,18570,141756,72512,170020,52754,63550,118515,103073,93330,32736,50499,14722,31600,68452,398867,29316,172786,18417,104924,2606,5670,84818,16288,67106,59580,82929,607401,291,85829,359,15897,35830,50696,65630,52672,22115,356968,29895,40837,231192,34024,38957,26722,406,23335,124952,72068,68804,13268,147101,164740,276569,162596,66943,11569,26654,66358,4777,23229,102127,5848,978,2921,59666,5371,28212,90108,42938,39320,2499,4271,108792,33510,125072,71653,65239,38250,66357,38577,13964,86251,35708,50755,36010,29448,12209,3844,38222,206337,100876,67827,137088,14167,252225,84163,195270,1306,5703,54198,779,46802,22028,51124,86759,70560,113164,35685,162145,45471,34561,422,2611,6464,47486,19223,38246,9191,18331,89942,243642,212364,15893,17518,22617,6409,30046,126182,59716,36560,104428,18846,26592,19458,50793,147333,30826,1388,27647,10922,14495,33545,19269,135828,39727,41601,46931,233379,49169,131130,182112,16276,82381,118209,142445,128310,19672,28740,82907,33436,3118,102206,28723,24819,41937,38854,5157,3881,111491,1142,9776,421673,152241,29309,14961,87854,6054,15424,3796,82656,54996,2108,55367,239450,154525,9643,118103,106041,64601,68549,48707,30266,25772,18740,9462,229669,91798,112152,191327,14493,72828,8175,66636,236474,25817,87351,129027,76653,20422,22983,71240,27846,44661,12399,46158,77704,53101,35032,11072,17300,109294,33638,24408,1895,11241,760,17584,82479,125877,63150,141075,34259,23274,81698,15732,43577,48340,91584,14688,16379,24481,150280,96420,262050,48635,43727,61819,56268,72003,88178,17281,79912,13218,122519,125295,166396,11811,2171,118930,67746,17636,178278,174656,95661,173039,83845,79689,17473,98555,127696,203415,54730,22925,232239,9309,12136,175026,20740,180188,10747,39816,314017,266131,10040,175732,112550,220651,31974,37393,888,23008,86799,4303,64905,148467,75337,251,3284,370102,50264,9835,5438,23655,4481,29851,329,12855,7162,64931,78141,12804,42372,296771,83547,18624,34874,86271,3360,48665,77735,88767,11463,63527,28889,22258,29140,194315,113924,25499,6406,31334,1845,4802,49184,43455,35469,127594,92970,61038,115005,38840,87761,106838,8811,20572,55637,11162,96721,132425,108925,2948,125457,36356,3502,75270,27622,127192,2561,123095,49394,61155,16897,110064,9699,89448,53356,19628,220310,21622,83036,9885,112214,6087,26713,17901,161912,91492,3440,68594,9266,92238,8087,6866,150194,72175,80701,13459,31836,43243,239700,95846,44749,50647,21945,230538,120612,132371,244604,5193,105637,34661,41341,68775,85393,1874,8771,33718,49672,77403,595452,99507,6490,58895,128742,7704,39239,73217,43816,62824,37804,199976,22361,80005,87514,94832,14089,4574,139975,59142,75523,100268,43906,53442,15152,2547,186002,17011,19513,204282,3343,60568,128318,119250,4298,51871,41336,71759,21921,45074,98169,145889,99427,11350,1237,5520,28799,7803,53702,21026,136352,38293,128690,12158,90132,44600,10184,26957,39459,126025,78904,82999,59373,39301,150198,120529,153042,20177,50089,14764,271571,30530,123161,38975,101562,22941,5648,124654,109243,69817,71675,49162,106884,21241,107795,30258,16572,188262,141456,7688,60718,8271,11044,32440,104608,103419,236109,93156,43293,128929,42107,67180,25201,115254,185488,130954,72813,167547,20537,39969,38432,22582,184022,1139,27199,5655,17767,97412,122606,209377,27070,35871,326617,188954,42680,73512,80911,22629,3011,95021,315242,157737,383,41821,41808,19335,27950,15674,25677,110950,35375,76835,59108,57370,35262,16569,160415,37706,78086,32041,49691,137143,9782,172080,50148,77917,6323,10110,69172,17711,21795,59511,76184,135114,31046,132319,59105,157578,20549,80778,57649,158421,65143,4575,72235,21899,10797,92745,34035,106079,80159,4508,78304,25350,75457,46458,32937,25623,47,8531,104751,84953,8138,36508,187199,66310,115274,13253,32461,38536,1916,42007,187160,35055,26325,84394,35963,94216,45590,97782],Bh=15;class wW{log;peerRouting;routingTable;refreshInterval;refreshQueryTimeout;commonPrefixLengthRefreshedAt;refreshTimeoutId;constructor(e,t){const{peerRouting:r,routingTable:s,refreshInterval:i,refreshQueryTimeout:a,logPrefix:c}=t;this.log=e.logger.forComponent(`${c}:routing-table:refresh`),this.peerRouting=r,this.routingTable=s,this.refreshInterval=i??hq,this.refreshQueryTimeout=a??fq,this.commonPrefixLengthRefreshedAt=[],this.refreshTable=this.refreshTable.bind(this)}async afterStart(){this.log(`refreshing routing table every ${this.refreshInterval}ms`),this.refreshTable(!0)}async stop(){this.refreshTimeoutId!=null&&clearTimeout(this.refreshTimeoutId)}refreshTable(e=!1,t){this.log("refreshing routing table");const r=this._maxCommonPrefix(),s=this._getTrackedCommonPrefixLengthsForRefresh(r);this.log(`max common prefix length ${r}`),this.log(`tracked CPLs [ ${s.map(i=>i.toISOString()).join(", ")} ]`),Promise.all(s.map(async(i,a)=>{try{if(await this._refreshCommonPrefixLength(a,i,e,t),this._numPeersForCpl(r)===0){const c=Math.min(2*(a+1),s.length-1);for(let u=a+1;u<c+1;u++)try{await this._refreshCommonPrefixLength(u,i,e,t)}catch(h){this.log.error(h)}}}catch(c){this.log.error(c)}})).catch(i=>{this.log.error(i)}).then(()=>{this.refreshTimeoutId=setTimeout(this.refreshTable,this.refreshInterval),this.refreshTimeoutId.unref!=null&&this.refreshTimeoutId.unref()}).catch(i=>{this.log.error(i)})}async _refreshCommonPrefixLength(e,t,r,s){if(!r&&t.getTime()>Date.now()-this.refreshInterval){this.log("not running refresh for cpl %s as time since last refresh not above interval",e);return}const i=this._generateRandomPeerId(e);this.log("starting refreshing cpl %s with key %p (routing table size was %s)",e,i,this.routingTable.size);const a=An([s?.signal,AbortSignal.timeout(this.refreshQueryTimeout)]);try{const c=await _C(this.peerRouting.getClosestPeers(i.toMultihash().bytes,{signal:a}));this.log(`found ${c} peers that were close to imaginary peer %p`,i),this.log("finished refreshing cpl %s with key %p (routing table size is now %s)",e,i,this.routingTable.size)}finally{a.clear()}}_getTrackedCommonPrefixLengthsForRefresh(e){e>Bh&&(e=Bh);const t=[];for(let r=0;r<=e;r++)t[r]=this.commonPrefixLengthRefreshedAt[r]??new Date;return t}_generateRandomPeerId(e){if(this.routingTable.kb==null)throw new Error("Routing table not started");if(this.routingTable.kb.localPeer==null)throw new Error("Local peer not set");const t=w1(2),r=(t[1]<<8)+t[0],s=this._makePeerId(this.routingTable.kb.localPeer.kadId,r,e),i=jn(s);return Xr(i)}_makePeerId(e,t,r){if(r>Bh)throw new Error(`Cannot generate peer ID for common prefix length greater than ${Bh}`);const a=new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1)^32768>>r,c=65535<<16-(r+1),u=a&c|t&~c,h=yW[u],f=new ArrayBuffer(34),p=new DataView(f,0,f.byteLength);return p.setUint8(0,mn.code),p.setUint8(1,32),p.setUint32(2,h,!1),new Uint8Array(p.buffer,p.byteOffset,p.byteLength)}_maxCommonPrefix(){let e=0;for(const t of this._prefixLengths())t>e&&(e=t);return e}_numPeersForCpl(e){let t=0;for(const r of this._prefixLengths())r===e&&t++;return t}*_prefixLengths(){if(this.routingTable.kb?.localPeer!=null)for(const{kadId:e}of this.routingTable.kb.toIterable()){const t=el(this.routingTable.kb.localPeer.kadId,e);let r=0;for(const s of t)if(s===0)r++;else break;yield r}}}class vW{peerId;providers;peerStore;log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:add-provider`),this.peerId=e.peerId,this.providers=t.providers,this.peerStore=e.peerStore}async handle(e,t){if(t.key==null||t.key.length===0)throw new Kt("Missing key");let r;try{r=Be.decode(t.key)}catch{throw new Kt("Invalid CID")}(t.providers==null||t.providers.length===0)&&this.log.error("no providers found in message"),this.log("%p asked us, %p to store provider record for for %c",e,this.peerId,r),await Promise.all(t.providers.map(async s=>{const i=jn(s.id),a=Xr(i),c=s.multiaddrs.map(u=>Pe(u));if(!e.equals(a)){this.log("invalid provider peer %p from %p",s.id,e);return}if(s.multiaddrs.length<1){this.log("no valid addresses for provider %p. Ignore",e);return}this.log.trace("received provider %p for %s (addrs %s)",e,r,c),await this.providers.addProvider(r,a),await this.peerStore.merge(a,{multiaddrs:c})}))}}class bW{peerRouting;peerInfoMapper;peerId;addressManager;log;constructor(e,t){const{peerRouting:r,logPrefix:s}=t;this.log=e.logger.forComponent(`${s}:rpc:handlers:find-node`),this.peerId=e.peerId,this.addressManager=e.addressManager,this.peerRouting=r,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){this.log("incoming request from %p for peers close to %b",e,t.key);try{if(t.key==null)throw new Kt("Invalid FIND_NODE message received - key was missing");const r=await this.peerRouting.getClosestPeersOffline(t.key,{exclude:[e,this.peerId]});Ve(this.peerId.toMultihash().bytes,t.key)&&r.push({id:this.peerId,multiaddrs:this.addressManager.getAddresses().map(i=>i.decapsulateCode(E1("p2p").code))});const s={type:lt.FIND_NODE,clusterLevel:t.clusterLevel,closer:r.map(this.peerInfoMapper).filter(({multiaddrs:i})=>i.length).map(i=>({id:i.id.toMultihash().bytes,multiaddrs:i.multiaddrs.map(a=>a.bytes)})),providers:[]};return s.closer.length===0?this.log("could not find any peers closer to %b for %p",t.key,e):this.log("found %d peers close to %b for %p",s.closer.length,t.key,e),s}catch(r){throw this.log("error during finding peers closer to %b for %p - %e",t.key,e,r),r}}}class xW{peerId;peerRouting;providers;peerStore;peerInfoMapper;log;constructor(e,t){const{peerRouting:r,providers:s,logPrefix:i}=t;this.log=e.logger.forComponent(`${i}:rpc:handlers:get-providers`),this.peerId=e.peerId,this.peerStore=e.peerStore,this.peerRouting=r,this.providers=s,this.peerInfoMapper=t.peerInfoMapper}async handle(e,t){if(t.key==null)throw new Kt("Invalid GET_PROVIDERS message received - key was missing");let r;try{r=Be.decode(t.key)}catch{throw new Kt("Invalid CID")}this.log("%p asking for providers for %s",e,r);const[s,i]=await Promise.all([kf(X3(await this.providers.getProviders(r),async c=>{const u=await this.peerStore.get(c);return{id:u.id,multiaddrs:u.addresses.map(({multiaddr:f})=>f)}})),this.peerRouting.getClosestPeersOffline(t.key)]),a={type:lt.GET_PROVIDERS,key:t.key,clusterLevel:t.clusterLevel,closer:i.map(this.peerInfoMapper).filter(({id:c,multiaddrs:u})=>u.length>0).map(c=>({id:c.id.toMultihash().bytes,multiaddrs:c.multiaddrs.map(u=>u.bytes)})),providers:s.map(this.peerInfoMapper).filter(({id:c,multiaddrs:u})=>u.length>0).map(c=>({id:c.id.toMultihash().bytes,multiaddrs:c.multiaddrs.map(u=>u.bytes)}))};return this.log("got %s providers %s closerPeers",a.providers.length,a.closer.length),a}async _getAddresses(e){return[]}}class SW{peerStore;datastore;peerRouting;log;datastorePrefix;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:get-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.peerStore=e.peerStore,this.datastore=e.datastore,this.peerRouting=t.peerRouting}async handle(e,t){const r=t.key;if(this.log("%p asked for key %b",e,r),r==null||r.length===0)throw new Kt("Invalid key");const s={type:lt.GET_VALUE,key:r,clusterLevel:t.clusterLevel,closer:[],providers:[]};if(_q(r)){this.log("is public key");const c=Dq(r);let u;try{const h=await this.peerStore.get(c);if(h.id.publicKey==null)throw new Si("No public key found in key book");u=ws(h.id.publicKey)}catch(h){if(h.name!=="NotFoundError")throw h}if(u!=null)return this.log("returning found public key"),s.record=new rr(r,u,new Date).serialize(),s}const[i,a]=await Promise.all([this._checkLocalDatastore(r),this.peerRouting.getClosestPeersOffline(r)]);return i!=null&&(this.log("had record for %b in local datastore",r),s.record=i.serialize()),a.length>0&&(this.log("had %s closer peers in routing table",a.length),s.closer=a.map(c=>({id:c.id.toMultihash().bytes,multiaddrs:c.multiaddrs.map(u=>u.bytes)}))),s}async _checkLocalDatastore(e){this.log("checkLocalDatastore looking for %b",e);const t=Hc(this.datastorePrefix,e);let r;try{r=await this.datastore.get(t)}catch(i){if(i.name==="NotFoundError")return;throw i}const s=rr.deserialize(r);if(s.timeReceived==null||Date.now()-s.timeReceived.getTime()>tq){await this.datastore.delete(t);return}return s}}class EW{log;constructor(e,t){this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:ping`)}async handle(e,t){return this.log("ping from %p",e),t}}class CW{components;validators;log;datastorePrefix;constructor(e,t){const{validators:r}=t;this.components=e,this.log=e.logger.forComponent(`${t.logPrefix}:rpc:handlers:put-value`),this.datastorePrefix=`${t.datastorePrefix}/record`,this.validators=r}async handle(e,t){const r=t.key;if(this.log("%p asked us to store value for key %b",e,r),t.record==null){const s=`Empty record from: ${e.toString()}`;throw this.log.error(s),new Kt(s)}try{const s=rr.deserialize(t.record);await J3(this.validators,s),s.timeReceived=new Date;const i=Hc(this.datastorePrefix,s.key);await this.components.datastore.put(i,s.serialize().subarray()),this.log("put record for %b into datastore under key %k",r,i)}catch(s){this.log("did not put record for key %b into datastore %o",r,s)}return t}}class kW{handlers;log;metrics;incomingMessageTimeout;constructor(e,t){this.metrics={operations:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_requests_total`),errors:e.metrics?.registerCounterGroup(`${t.metricsPrefix}_inbound_rpc_errors_total`),rpcTime:e.metrics?.registerMetricGroup(`${t.metricsPrefix}_inbound_rpc_time_seconds`,{label:"operation"})},this.log=e.logger.forComponent(`${t.logPrefix}:rpc`),this.incomingMessageTimeout=t.incomingMessageTimeout??1e4,this.handlers={[lt.GET_VALUE.toString()]:new SW(e,t),[lt.PUT_VALUE.toString()]:new CW(e,t),[lt.FIND_NODE.toString()]:new bW(e,t),[lt.ADD_PROVIDER.toString()]:new vW(e,t),[lt.GET_PROVIDERS.toString()]:new xW(e,t),[lt.PING.toString()]:new EW(e,t)}}async handleMessage(e,t){const r=this.handlers[t.type];if(r==null){this.log.error(`no handler found for message type: ${t.type}`);return}try{return this.metrics.operations?.increment({[t.type]:!0}),await r.handle(e,t)}catch{this.metrics.errors?.increment({[t.type]:!0})}}onIncomingStream(e){const t="unknown";Promise.resolve().then(async()=>{const{stream:r,connection:s}=e,i=()=>{r.abort(new h1)};let a=AbortSignal.timeout(this.incomingMessageTimeout);a.addEventListener("abort",i);const c=Wr(r).pb(Oa);try{for(;;){const u=await c.read({signal:a}),h=this.metrics?.rpcTime?.timer(u.type.toString()),f=this.metrics?.rpcTime?.timer(u.type.toString());let p=!1;try{this.log("incoming %s from %p",u.type,s.remotePeer);const m=await this.handleMessage(s.remotePeer,u);m!=null&&await c.write(m,{signal:a})}catch(m){throw p=!0,f?.(),m}finally{p||h?.()}a.removeEventListener("abort",i),a=AbortSignal.timeout(this.incomingMessageTimeout),a.addEventListener("abort",i)}}catch(u){r.abort(u)}}).catch(r=>{this.log.error("error handling %s RPC message from %p - %e",t,e.connection.remotePeer,r)})}}class AW extends ln{log;components;protocol;running;registrarId;constructor(e,t){super();const{protocol:r,logPrefix:s}=t;this.components=e,this.log=e.logger.forComponent(`${s}:topology-listener`),this.running=!1,this.protocol=r}isStarted(){return this.running}async start(){this.running||(this.running=!0,this.registrarId=await this.components.registrar.register(this.protocol,{onConnect:e=>{this.log("observed peer %p with protocol %s",e,this.protocol),this.dispatchEvent(new CustomEvent("peer",{detail:e}))}}))}async stop(){this.running=!1,this.registrarId!=null&&(this.components.registrar.unregister(this.registrarId),this.registrarId=void 0)}}class PW{dht;constructor(e){this.dht=e}async provide(e,t={}){await au(this.dht.provide(e,t))}async cancelReprovide(e){await this.dht.cancelReprovide(e)}async*findProviders(e,t={}){for await(const r of this.dht.findProviders(e,t))r.name==="PROVIDER"&&(yield*r.providers)}async put(e,t,r){await au(this.dht.put(e,t,r))}async get(e,t){for await(const r of this.dht.get(e,t))if(r.name==="VALUE")return r.value;throw new Si("Could not find value for key")}}class TW{dht;constructor(e){this.dht=e}async findPeer(e,t={}){for await(const r of this.dht.findPeer(e,t))if(r.name==="FINAL_PEER")return r.peer;throw new Si("Peer not found")}async*getClosestPeers(e,t={}){for await(const r of this.dht.getClosestPeers(e,t))r.name==="FINAL_PEER"&&(yield r.peer)}}const _W=32,DW=64;class IW extends ln{k;a;d;protocol;routingTable;providers;network;peerRouting;components;log;running;clientMode;validators;selectors;queryManager;contentFetching;contentRouting;routingTableRefresh;rpc;topologyListener;querySelf;maxInboundStreams;maxOutboundStreams;dhtContentRouting;dhtPeerRouting;peerInfoMapper;reprovider;onPeerConnectTimeout;constructor(e,t={}){super();const r=t.logPrefix??"libp2p:kad-dht",s=t.datastorePrefix??"/dht",i=t.metricsPrefix??"libp2p_kad_dht",a={queries:e.metrics?.registerMetricGroup(`${i}_operations_total`,{label:"operation"}),errors:e.metrics?.registerCounterGroup(`${i}_operation_errors_total`,{label:"operation"}),queryTime:e.metrics?.registerMetricGroup(`${i}_operation_time_seconds`,{label:"operation"}),errorTime:e.metrics?.registerMetricGroup(`${i}_operation_error_time_seconds`,{label:"operation"})};this.running=!1,this.components=e,this.log=e.logger.forComponent(r),this.k=t.kBucketSize??e4,this.a=t.alpha??O1,this.d=t.disjointPaths??this.a,this.protocol=t.protocol??nq,this.clientMode=t.clientMode??!0,this.maxInboundStreams=t.maxInboundStreams??_W,this.maxOutboundStreams=t.maxOutboundStreams??DW,this.peerInfoMapper=t.peerInfoMapper??Pq,this.onPeerConnectTimeout=t.onPeerConnectTimeout??lq,this.providers=new zq(e,{...t.providers,logPrefix:r,datastorePrefix:s}),this.validators={...kq,...t.validators},this.selectors={...Eq,...t.selectors},this.network=new jq(e,{protocol:this.protocol,logPrefix:r,metricsPrefix:i}),this.routingTable=new mW(e,{kBucketSize:this.k,pingOldContactTimeout:t.pingOldContactTimeout,pingOldContactConcurrency:t.pingOldContactConcurrency,pingOldContactMaxQueueSize:t.pingOldContactMaxQueueSize,pingNewContactTimeout:t.pingNewContactTimeout,pingNewContactConcurrency:t.pingNewContactConcurrency,pingNewContactMaxQueueSize:t.pingNewContactMaxQueueSize,protocol:this.protocol,logPrefix:r,metricsPrefix:i,prefixLength:t.prefixLength,splitThreshold:t.kBucketSplitThreshold,network:this.network});const c=Ke();t.allowQueryWithZeroPeers===!0&&c.resolve(),this.queryManager=new Gq(e,{disjointPaths:this.d,alpha:this.a,logPrefix:r,metricsPrefix:i,initialQuerySelfHasRun:c,routingTable:this.routingTable,allowQueryWithZeroPeers:t.allowQueryWithZeroPeers}),this.peerRouting=new $q(e,{routingTable:this.routingTable,network:this.network,validators:this.validators,queryManager:this.queryManager,logPrefix:r}),this.contentFetching=new Fq(e,{validators:this.validators,selectors:this.selectors,peerRouting:this.peerRouting,queryManager:this.queryManager,network:this.network,logPrefix:r,datastorePrefix:s}),this.contentRouting=new Vq(e,{network:this.network,peerRouting:this.peerRouting,queryManager:this.queryManager,routingTable:this.routingTable,providers:this.providers,logPrefix:r}),this.routingTableRefresh=new wW(e,{peerRouting:this.peerRouting,routingTable:this.routingTable,logPrefix:r}),this.rpc=new kW(e,{routingTable:this.routingTable,providers:this.providers,peerRouting:this.peerRouting,validators:this.validators,logPrefix:r,metricsPrefix:i,datastorePrefix:s,peerInfoMapper:this.peerInfoMapper}),this.topologyListener=new AW(e,{protocol:this.protocol,logPrefix:r}),this.querySelf=new Yq(e,{peerRouting:this.peerRouting,interval:t.querySelfInterval,initialInterval:t.initialQuerySelfInterval,logPrefix:r,initialQuerySelfHasRun:c,operationMetrics:a}),this.reprovider=new Xq(e,{...t.reprovide,logPrefix:r,metricsPrefix:i,datastorePrefix:s,contentRouting:this.contentRouting,operationMetrics:a}),this.network.addEventListener("peer",u=>{const h=u.detail;this.onPeerConnect(h).catch(f=>{this.log.error("could not add %p to routing table",h.id,f)}),this.dispatchEvent(new CustomEvent("peer",{detail:h}))}),this.topologyListener.addEventListener("peer",u=>{const h=u.detail;Promise.resolve().then(async()=>{const f=await this.components.peerStore.get(h),p={id:h,multiaddrs:f.addresses.map(({multiaddr:m})=>m),protocols:f.protocols};await this.onPeerConnect(p)}).catch(f=>{this.log.error("could not add %p to routing table - %e - %e",h,f)})}),this.dhtPeerRouting=new TW(this),this.dhtContentRouting=new PW(this),t.clientMode==null&&e.events.addEventListener("self:peer:update",u=>{this.log("received update of self-peer info"),Promise.resolve().then(async()=>{const h=u.detail.peer.addresses.some(({multiaddr:p})=>Bq(p)),f=this.getMode();h&&f==="client"?await this.setMode("server"):f==="server"&&!h&&await this.setMode("client")}).catch(h=>{this.log.error("error setting dht server mode",h)})}),this.get=ya(this.get.bind(this),a,"GET_VALUE"),this.findProviders=ya(this.findProviders.bind(this),a,"FIND_PROVIDERS"),this.findPeer=ya(this.findPeer.bind(this),a,"FIND_PEER"),this.getClosestPeers=ya(this.getClosestPeers.bind(this),a,"GET_CLOSEST_PEERS"),this.provide=ya(this.provide.bind(this),a,"PROVIDE"),this.put=ya(this.put.bind(this),a,"PUT_VALUE")}[Symbol.toStringTag]="@libp2p/kad-dht";[br]=["@libp2p/content-routing","@libp2p/peer-routing","@libp2p/peer-discovery","@libp2p/kad-dht"];[Zc]=["@libp2p/identify","@libp2p/ping"];get[vg](){return this.dhtContentRouting}get[bg](){return this.dhtPeerRouting}get[af](){return this}async onPeerConnect(e){if(this.log.trace("peer %p connected",e.id),e=this.peerInfoMapper(e),e.multiaddrs.length===0){this.log.trace("ignoring %p as there were no valid addresses in %s after filtering",e.id,e.multiaddrs.map(r=>r.toString()));return}const t=AbortSignal.timeout(this.onPeerConnectTimeout);try{await this.routingTable.add(e.id,{signal:t})}catch(r){this.log.error("could not add %p to routing table",e.id,r)}}isStarted(){return this.running}getMode(){return this.clientMode?"client":"server"}async setMode(e,t){if(e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}if(await this.components.registrar.unhandle(this.protocol,t),e===this.getMode()&&t?.force!==!0){this.log("already in %s mode",e);return}e==="client"?(this.log("enabling client mode while in %s mode",this.getMode()),this.clientMode=!0):(this.log("enabling server mode while in %s mode",this.getMode()),this.clientMode=!1,await this.components.registrar.handle(this.protocol,this.rpc.onIncomingStream.bind(this.rpc),{signal:t?.signal,maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))}async start(){this.running||(this.running=!0,await this.setMode(this.clientMode?"client":"server",{force:!0}),await Jc(this.routingTable,this.queryManager,this.network,this.topologyListener,this.routingTableRefresh,this.reprovider),await Jc(this.querySelf))}async stop(){this.running=!1,await f1(this.querySelf,this.queryManager,this.network,this.routingTable,this.routingTableRefresh,this.topologyListener,this.reprovider)}async*put(e,t,r={}){yield*this.contentFetching.put(e,t,r)}async*get(e,t={}){yield*this.contentFetching.get(e,t)}async*provide(e,t={}){yield*this.contentRouting.provide(e,this.components.addressManager.getAddresses(),t)}async cancelReprovide(e,t){await this.providers.removeProvider(e,this.components.peerId,t)}async*findProviders(e,t={}){yield*this.contentRouting.findProviders(e,t)}async*findPeer(e,t={}){yield*this.peerRouting.findPeer(e,t)}async*getClosestPeers(e,t={}){yield*this.peerRouting.getClosestPeers(e,t)}async refreshRoutingTable(e){this.routingTableRefresh.refreshTable(!0,e)}}var G9;(function(n){n[n.SEND_QUERY=0]="SEND_QUERY",n[n.PEER_RESPONSE=1]="PEER_RESPONSE",n[n.FINAL_PEER=2]="FINAL_PEER",n[n.QUERY_ERROR=3]="QUERY_ERROR",n[n.PROVIDER=4]="PROVIDER",n[n.VALUE=5]="VALUE",n[n.ADD_PEER=6]="ADD_PEER",n[n.DIAL_PEER=7]="DIAL_PEER",n[n.PATH_ENDED=8]="PATH_ENDED"})(G9||(G9={}));function NW(n={}){return e=>new IW(e,n)}const MW="0.1.0",RW="id",LW="1.0.0",OW=1024*8;var qf;(function(n){let e;n.codec=()=>(e==null&&(e=Qe((t,r,s={})=>{if(s.lengthDelimited!==!1&&r.fork(),t.protocolVersion!=null&&(r.uint32(42),r.string(t.protocolVersion)),t.agentVersion!=null&&(r.uint32(50),r.string(t.agentVersion)),t.publicKey!=null&&(r.uint32(10),r.bytes(t.publicKey)),t.listenAddrs!=null)for(const i of t.listenAddrs)r.uint32(18),r.bytes(i);if(t.observedAddr!=null&&(r.uint32(34),r.bytes(t.observedAddr)),t.protocols!=null)for(const i of t.protocols)r.uint32(26),r.string(i);t.signedPeerRecord!=null&&(r.uint32(66),r.bytes(t.signedPeerRecord)),s.lengthDelimited!==!1&&r.ldelim()},(t,r,s={})=>{const i={listenAddrs:[],protocols:[]},a=r==null?t.len:t.pos+r;for(;t.pos<a;){const c=t.uint32();switch(c>>>3){case 5:{i.protocolVersion=t.string();break}case 6:{i.agentVersion=t.string();break}case 1:{i.publicKey=t.bytes();break}case 2:{if(s.limits?.listenAddrs!=null&&i.listenAddrs.length===s.limits.listenAddrs)throw new qr('Decode error - map field "listenAddrs" had too many elements');i.listenAddrs.push(t.bytes());break}case 4:{i.observedAddr=t.bytes();break}case 3:{if(s.limits?.protocols!=null&&i.protocols.length===s.limits.protocols)throw new qr('Decode error - map field "protocols" had too many elements');i.protocols.push(t.string());break}case 8:{i.signedPeerRecord=t.bytes();break}default:{t.skipType(c&7);break}}}return i})),e),n.encode=t=>Ge(t,n.codec()),n.decode=(t,r)=>We(t,n.codec(),r)})(qf||(qf={}));const hs={protocolPrefix:"ipfs",timeout:5e3,maxInboundStreams:1,maxOutboundStreams:1,maxObservedAddresses:10,maxMessageSize:OW,runOnConnectionOpen:!0,runOnLimitedConnection:!0};function BW(n){if(n!=null&&n.length>0)try{return Pe(n)}catch{}}function FW(n,e){return e??n.userAgent}async function UW(n,e,t,r,s){if(t("received identify from %p",r.remotePeer),s==null)throw new Kt("message was null or undefined");const i={};if(s.listenAddrs.length>0&&(i.addresses=s.listenAddrs.map(u=>({isCertified:!1,multiaddr:Pe(u)}))),s.protocols.length>0&&(i.protocols=s.protocols),s.publicKey!=null){const u=Do(s.publicKey);if(!v1(u).equals(r.remotePeer))throw new Kt("public key did not match remote PeerId");i.publicKey=u}let a;if(s.signedPeerRecord!=null){t.trace("received signedPeerRecord from %p",r.remotePeer);let u=s.signedPeerRecord;const h=await xs.openAndCertify(u,tr.DOMAIN);let f=tr.createFromProtobuf(h.payload);const p=ju(h.publicKey.toCID());if(!f.peerId.equals(p))throw new Kt("signing key does not match PeerId in the PeerRecord");if(!r.remotePeer.equals(f.peerId))throw new Kt("signing key does not match remote PeerId");let m;try{m=await n.get(f.peerId)}catch(w){if(w.name!=="NotFoundError")throw w}if(m!=null&&(i.metadata=m.metadata,m.peerRecordEnvelope!=null)){const w=xs.createFromProtobuf(m.peerRecordEnvelope),x=tr.createFromProtobuf(w.payload);x.seqNumber>=f.seqNumber&&(t("sequence number was lower or equal to existing sequence number - stored: %d received: %d",x.seqNumber,f.seqNumber),f=x,u=m.peerRecordEnvelope)}i.peerRecordEnvelope=u,i.addresses=f.multiaddrs.map(w=>({isCertified:!0,multiaddr:w})),a={seq:f.seqNumber,addresses:f.multiaddrs}}else t("%p did not send a signed peer record",r.remotePeer);if(t.trace("patching %p with",r.remotePeer,i),await n.patch(r.remotePeer,i),s.agentVersion!=null||s.protocolVersion!=null){const u={};s.agentVersion!=null&&(u.AgentVersion=we(s.agentVersion)),s.protocolVersion!=null&&(u.ProtocolVersion=we(s.protocolVersion)),t.trace("merging %p metadata",r.remotePeer,u),await n.merge(r.remotePeer,{metadata:u})}const c={peerId:r.remotePeer,protocolVersion:s.protocolVersion,agentVersion:s.agentVersion,publicKey:s.publicKey,listenAddrs:s.listenAddrs.map(u=>Pe(u)),observedAddr:s.observedAddr==null?void 0:Pe(s.observedAddr),protocols:s.protocols,signedPeerRecord:a,connection:r};return e.safeDispatchEvent("peer:identify",{detail:c}),c}class VW{host;protocol;started;timeout;peerId;privateKey;peerStore;registrar;addressManager;maxInboundStreams;maxOutboundStreams;maxMessageSize;maxObservedAddresses;events;runOnLimitedConnection;log;constructor(e,t){this.protocol=t.protocol,this.started=!1,this.peerId=e.peerId,this.privateKey=e.privateKey,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.events=e.events,this.log=t.log,this.timeout=t.timeout??hs.timeout,this.maxInboundStreams=t.maxInboundStreams??hs.maxInboundStreams,this.maxOutboundStreams=t.maxOutboundStreams??hs.maxOutboundStreams,this.maxMessageSize=t.maxMessageSize??hs.maxMessageSize,this.maxObservedAddresses=t.maxObservedAddresses??hs.maxObservedAddresses,this.runOnLimitedConnection=t.runOnLimitedConnection??hs.runOnLimitedConnection,this.host={protocolVersion:`${t.protocolPrefix??hs.protocolPrefix}/${MW}`,agentVersion:FW(e.nodeInfo,t.agentVersion)}}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:we(this.host.agentVersion),ProtocolVersion:we(this.host.protocolVersion)}}),await this.registrar.handle(this.protocol,e=>{this.handleProtocol(e).catch(t=>{this.log.error(t)})},{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.protocol),this.started=!1}}function jW(n){try{for(const{code:e,value:t}of n.getComponents())if(t!=null&&e===nr)return JB("2000::/3",t)}catch{}return!1}class $W extends VW{constructor(e,t={}){super(e,{...t,protocol:`/${t.protocolPrefix??hs.protocolPrefix}/${RW}/${LW}`,log:e.logger.forComponent("libp2p:identify")}),(t.runOnConnectionOpen??hs.runOnConnectionOpen)&&e.events.addEventListener("connection:open",r=>{const s=r.detail;this.identify(s).catch(i=>{i.name!==Hm.name&&this.log.error("error during identify trigged by connection:open",i)})})}[br]=["@libp2p/identify"];async _identify(e,t={}){let r;if(t.signal==null){const s=AbortSignal.timeout(this.timeout);t={...t,signal:s}}try{r=await e.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const i=await Wr(r,{maxDataLength:this.maxMessageSize}).pb(qf).read(t);return await r.close(t),i}catch(s){throw r?.abort(s),s}}async identify(e,t={}){const r=await this._identify(e,t),{publicKey:s,protocols:i,observedAddr:a}=r;if(s==null)throw new Kt("public key was missing from identify message");const c=Do(s),u=ju(c.toCID());if(!e.remotePeer.equals(u))throw new Kt("identified peer does not match the expected peer");if(this.peerId.equals(u))throw new Kt("identified peer is our own peer id?");return this.maybeAddObservedAddress(a),this.log("identify completed for peer %p and protocols %o",u,i),UW(this.peerStore,this.events,this.log,e,r)}maybeAddObservedAddress(e){const t=BW(e);if(t==null)return;if(this.log.trace("our observed address was %a",t),uu(t)){this.log.trace("our observed address was private");return}const r=t.getComponents();if((r[0].code===nr||r[0].code===Io&&r[1].code===nr)&&!jW(t)){this.log.trace("our observed address was IPv6 but not a global unicast address");return}_f.exactMatch(t)||(this.log.trace("storing the observed address"),this.addressManager.addObservedAddr(t))}async handleProtocol(e){const{connection:t,stream:r}=e,s=AbortSignal.timeout(this.timeout);try{const i=await this.peerStore.get(this.peerId),a=this.addressManager.getAddresses().map(f=>f.decapsulateCode(E1("p2p").code));let c=i.peerRecordEnvelope;if(a.length>0&&c==null){const f=new tr({peerId:this.peerId,multiaddrs:a});c=(await xs.seal(f,this.privateKey)).marshal().subarray()}let u=t.remoteAddr.bytes;VU.matches(t.remoteAddr)||(u=void 0),await Wr(r).pb(qf).write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:ws(this.privateKey.publicKey),listenAddrs:a.map(f=>f.bytes),signedPeerRecord:c,observedAddr:u,protocols:i.protocols},{signal:s}),await r.close({signal:s})}catch(i){this.log.error("could not respond to identify request",i),r.abort(i)}}}function zW(n={}){return e=>new $W(e,n)}const Q2=32,HW="1.0.0",KW="ping",qW="ipfs",WW=1e4,GW=2,QW=1;class YW{protocol;components;started;timeout;maxInboundStreams;maxOutboundStreams;runOnLimitedConnection;log;constructor(e,t={}){this.components=e,this.log=e.logger.forComponent("libp2p:ping"),this.started=!1,this.protocol=`/${t.protocolPrefix??qW}/${KW}/${HW}`,this.timeout=t.timeout??WW,this.maxInboundStreams=t.maxInboundStreams??GW,this.maxOutboundStreams=t.maxOutboundStreams??QW,this.runOnLimitedConnection=t.runOnLimitedConnection??!0,this.handleMessage=this.handleMessage.bind(this)}[Symbol.toStringTag]="@libp2p/ping";[br]=["@libp2p/ping"];async start(){await this.components.registrar.handle(this.protocol,this.handleMessage,{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnLimitedConnection:this.runOnLimitedConnection}),this.started=!0}async stop(){await this.components.registrar.unhandle(this.protocol),this.started=!1}isStarted(){return this.started}handleMessage(e){this.log("incoming ping from %p",e.connection.remotePeer);const{stream:t}=e,r=Date.now(),s=Nf(t);let i=!1;Promise.resolve().then(async()=>{for(;;){const a=AbortSignal.timeout(this.timeout);a.addEventListener("abort",()=>{t?.abort(new h1("ping timeout"))});const c=await s.read({bytes:Q2,signal:a});await s.write(c,{signal:a}),i=!0}}).catch(a=>{i&&a.name==="UnexpectedEOFError"&&t.readStatus!=="ready"||(this.log.error("incoming ping from %p failed with error - %e",e.connection.remotePeer,a),t?.abort(a))}).finally(()=>{const a=Date.now()-r;this.log("incoming ping from %p complete in %dms",e.connection.remotePeer,a);const c=AbortSignal.timeout(this.timeout);t.close({signal:c}).catch(u=>{this.log.error("error closing ping stream from %p - %e",e.connection.remotePeer,u),t?.abort(u)})})}async ping(e,t={}){this.log("pinging %p",e);const r=Date.now(),s=w1(Q2),i=await this.components.connectionManager.openConnection(e,t);let a;if(t.signal==null){const c=AbortSignal.timeout(this.timeout);t={...t,signal:c}}try{a=await i.newStream(this.protocol,{...t,runOnLimitedConnection:this.runOnLimitedConnection});const c=Nf(a),[,u]=await Promise.all([c.write(s,t),c.read({...t,bytes:Q2})]),h=Date.now()-r;if(!Ve(s,u.subarray()))throw new MN(`Received wrong ping ack after ${h}ms`);return this.log("ping %p complete in %dms",i.remotePeer,h),h}catch(c){throw this.log.error("error while pinging %p",i.remotePeer,c),a?.abort(c),c}finally{a!=null&&await a.close(t)}}}function XW(n={}){return e=>new YW(e,n)}const JW=le("dns4"),ZW=le("dns6"),eG=le("dnsaddr"),vo=St(le("dns"),eG,JW,ZW),B1=St(le("ip4"),le("ip6")),ul=St(Se(B1,le("tcp")),Se(vo,le("tcp"))),F1=Se(B1,le("udp")),tG=Se(F1,le("utp")),nG=Se(F1,le("quic")),rG=Se(F1,le("quic-v1")),im=St(Se(ul,le("ws")),Se(vo,le("ws"))),Wf=St(Se(im,le("p2p")),im),om=St(Se(ul,le("wss")),Se(vo,le("wss")),Se(ul,le("tls"),le("ws")),Se(vo,le("tls"),le("ws"))),Gf=St(Se(om,le("p2p")),om),am=St(Se(ul,le("http")),Se(B1,le("http")),Se(vo,le("http"))),lm=St(Se(ul,le("https")),Se(B1,le("https")),Se(vo,le("https"))),Q9=Se(F1,le("webrtc-direct"),le("certhash")),DC=St(Se(Q9,le("p2p")),Q9),Y9=Se(rG,le("webtransport"),le("certhash"),le("certhash")),IC=St(Se(Y9,le("p2p")),Y9),NC=St(Se(Wf,le("p2p-webrtc-star"),le("p2p")),Se(Gf,le("p2p-webrtc-star"),le("p2p")),Se(Wf,le("p2p-webrtc-star")),Se(Gf,le("p2p-webrtc-star")));St(Se(Wf,le("p2p-websocket-star"),le("p2p")),Se(Gf,le("p2p-websocket-star"),le("p2p")),Se(Wf,le("p2p-websocket-star")),Se(Gf,le("p2p-websocket-star")));const MC=St(Se(am,le("p2p-webrtc-direct"),le("p2p")),Se(lm,le("p2p-webrtc-direct"),le("p2p")),Se(am,le("p2p-webrtc-direct")),Se(lm,le("p2p-webrtc-direct"))),bo=St(im,om,am,lm,NC,MC,ul,tG,nG,vo,DC,IC);St(Se(bo,le("p2p-stardust"),le("p2p")),Se(bo,le("p2p-stardust")));const hi=St(Se(bo,le("p2p")),NC,MC,DC,IC,le("p2p")),X9=St(Se(hi,le("p2p-circuit"),hi),Se(hi,le("p2p-circuit")),Se(le("p2p-circuit"),hi),Se(bo,le("p2p-circuit")),Se(le("p2p-circuit"),bo),le("p2p-circuit")),RC=()=>St(Se(X9,RC),X9),Yi=RC(),sG=St(Se(Yi,hi,Yi),Se(hi,Yi),Se(Yi,hi),Yi,hi);St(Se(Yi,le("webrtc"),le("p2p")),Se(Yi,le("webrtc")),Se(bo,le("webrtc"),le("p2p")),Se(bo,le("webrtc")),le("webrtc"));function LC(n){function e(t){let r;try{r=Pe(t)}catch{return!1}const s=n(r.protoNames());return s===null?!1:s===!0||s===!1?s:s.length===0}return e}function Se(...n){function e(t){if(t.length<n.length)return null;let r=t;return n.some(s=>(r=typeof s=="function"?s().partialMatch(t):s.partialMatch(t),Array.isArray(r)&&(t=r),r===null)),r}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:LC(e),partialMatch:e}}function St(...n){function e(r){let s=null;return n.some(i=>{const a=typeof i=="function"?i().partialMatch(r):i.partialMatch(r);return a!=null?(s=a,!0):!1}),s}return{toString:function(){return"{ "+n.join(" ")+" }"},input:n,matches:LC(e),partialMatch:e}}function le(n){const e=n;function t(s){let i;try{i=Pe(s)}catch{return!1}const a=i.protoNames();return a.length===1&&a[0]===e}function r(s){return s.length===0?null:s[0]===e?s.slice(1):null}return{toString:function(){return e},matches:t,partialMatch:r}}const iG="bootstrap",oG=50,aG=1e3;class lG extends ln{static tag="bootstrap";log;timer;list;timeout;components;_init;constructor(e,t={list:[]}){if(t.list==null||t.list.length===0)throw new Error("Bootstrap requires a list of peer addresses");super(),this.components=e,this.log=e.logger.forComponent("libp2p:bootstrap"),this.timeout=t.timeout??aG,this.list=[];for(const r of t.list){if(!sG.matches(r)){this.log.error("Invalid multiaddr");continue}const s=Pe(r),i=s.getPeerId();if(i==null){this.log.error("Invalid bootstrap multiaddr without peer id");continue}const a={id:sr(i),multiaddrs:[s]};this.list.push(a)}this._init=t}[af]=this;[Symbol.toStringTag]="@libp2p/bootstrap";[br]=["@libp2p/peer-discovery"];isStarted(){return!!this.timer}start(){this.isStarted()||(this.log("Starting bootstrap node discovery, discovering peers after %s ms",this.timeout),this.timer=setTimeout(()=>{this._discoverBootstrapPeers().catch(e=>{this.log.error(e)})},this.timeout))}async _discoverBootstrapPeers(){if(this.timer!=null)for(const e of this.list){if(await this.components.peerStore.merge(e.id,{tags:{[this._init.tagName??iG]:{value:this._init.tagValue??oG,ttl:this._init.tagTTL}},multiaddrs:e.multiaddrs}),this.timer==null)return;this.safeDispatchEvent("peer",{detail:e}),this.components.connectionManager.openConnection(e.id).catch(t=>{this.log.error("could not dial bootstrap peer %p",e.id,t)})}}stop(){this.timer!=null&&clearTimeout(this.timer),this.timer=void 0}}function cG(n){return e=>new lG(e,n)}const vr=()=>new Map,cm=n=>{const e=vr();return n.forEach((t,r)=>{e.set(r,t)}),e},Ii=(n,e,t)=>{let r=n.get(e);return r===void 0&&n.set(e,r=t()),r},uG=(n,e)=>{const t=[];for(const[r,s]of n)t.push(e(s,r));return t},dG=(n,e)=>{for(const[t,r]of n)if(e(r,t))return!0;return!1},dl=()=>new Set,Y2=n=>n[n.length-1],hG=(n,e)=>{for(let t=0;t<e.length;t++)n.push(e[t])},xo=Array.from,fG=Array.isArray;class pG{constructor(){this._observers=vr()}on(e,t){return Ii(this._observers,e,dl).add(t),t}once(e,t){const r=(...s)=>{this.off(e,r),t(...s)};this.on(e,r)}off(e,t){const r=this._observers.get(e);r!==void 0&&(r.delete(t),r.size===0&&this._observers.delete(e))}emit(e,t){return xo((this._observers.get(e)||vr()).values()).forEach(r=>r(...t))}destroy(){this._observers=vr()}}const ki=Math.floor,Gh=Math.abs,OC=(n,e)=>n<e?n:e,Oo=(n,e)=>n>e?n:e,BC=n=>n!==0?n<0:1/n<0,J9=1,Z9=2,X2=4,J2=8,bu=32,Es=64,Fn=128,U1=31,um=63,co=127,gG=2147483647,FC=Number.MAX_SAFE_INTEGER,mG=Number.isInteger||(n=>typeof n=="number"&&isFinite(n)&&ki(n)===n),yG=n=>n.toLowerCase(),wG=/^\s*/g,vG=n=>n.replace(wG,""),bG=/([A-Z])/g,ew=(n,e)=>vG(n.replace(bG,t=>`${e}${yG(t)}`)),xG=n=>{const e=unescape(encodeURIComponent(n)),t=e.length,r=new Uint8Array(t);for(let s=0;s<t;s++)r[s]=e.codePointAt(s);return r},xu=typeof TextEncoder<"u"?new TextEncoder:null,SG=n=>xu.encode(n),EG=xu?SG:xG;let qc=typeof TextDecoder>"u"?null:new TextDecoder("utf-8",{fatal:!0,ignoreBOM:!0});qc&&qc.decode(new Uint8Array).length===1&&(qc=null);class Yu{constructor(){this.cpos=0,this.cbuf=new Uint8Array(100),this.bufs=[]}}const V1=()=>new Yu,CG=n=>{let e=n.cpos;for(let t=0;t<n.bufs.length;t++)e+=n.bufs[t].length;return e},jr=n=>{const e=new Uint8Array(CG(n));let t=0;for(let r=0;r<n.bufs.length;r++){const s=n.bufs[r];e.set(s,t),t+=s.length}return e.set(new Uint8Array(n.cbuf.buffer,0,n.cpos),t),e},kG=(n,e)=>{const t=n.cbuf.length;t-n.cpos<e&&(n.bufs.push(new Uint8Array(n.cbuf.buffer,0,n.cpos)),n.cbuf=new Uint8Array(Oo(t,e)*2),n.cpos=0)},Bt=(n,e)=>{const t=n.cbuf.length;n.cpos===t&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(t*2),n.cpos=0),n.cbuf[n.cpos++]=e},dm=Bt,Re=(n,e)=>{for(;e>co;)Bt(n,Fn|co&e),e=ki(e/128);Bt(n,co&e)},t4=(n,e)=>{const t=BC(e);for(t&&(e=-e),Bt(n,(e>um?Fn:0)|(t?Es:0)|um&e),e=ki(e/64);e>0;)Bt(n,(e>co?Fn:0)|co&e),e=ki(e/128)},hm=new Uint8Array(3e4),AG=hm.length/3,PG=(n,e)=>{if(e.length<AG){const t=xu.encodeInto(e,hm).written||0;Re(n,t);for(let r=0;r<t;r++)Bt(n,hm[r])}else Mn(n,EG(e))},TG=(n,e)=>{const t=unescape(encodeURIComponent(e)),r=t.length;Re(n,r);for(let s=0;s<r;s++)Bt(n,t.codePointAt(s))},Ba=xu&&xu.encodeInto?PG:TG,j1=(n,e)=>{const t=n.cbuf.length,r=n.cpos,s=OC(t-r,e.length),i=e.length-s;n.cbuf.set(e.subarray(0,s),r),n.cpos+=s,i>0&&(n.bufs.push(n.cbuf),n.cbuf=new Uint8Array(Oo(t*2,i)),n.cbuf.set(e.subarray(s)),n.cpos=i)},Mn=(n,e)=>{Re(n,e.byteLength),j1(n,e)},n4=(n,e)=>{kG(n,e);const t=new DataView(n.cbuf.buffer,n.cpos,e);return n.cpos+=e,t},_G=(n,e)=>n4(n,4).setFloat32(0,e,!1),DG=(n,e)=>n4(n,8).setFloat64(0,e,!1),IG=(n,e)=>n4(n,8).setBigInt64(0,e,!1),tw=new DataView(new ArrayBuffer(4)),NG=n=>(tw.setFloat32(0,n),tw.getFloat32(0)===n),Su=(n,e)=>{switch(typeof e){case"string":Bt(n,119),Ba(n,e);break;case"number":mG(e)&&Gh(e)<=gG?(Bt(n,125),t4(n,e)):NG(e)?(Bt(n,124),_G(n,e)):(Bt(n,123),DG(n,e));break;case"bigint":Bt(n,122),IG(n,e);break;case"object":if(e===null)Bt(n,126);else if(fG(e)){Bt(n,117),Re(n,e.length);for(let t=0;t<e.length;t++)Su(n,e[t])}else if(e instanceof Uint8Array)Bt(n,116),Mn(n,e);else{Bt(n,118);const t=Object.keys(e);Re(n,t.length);for(let r=0;r<t.length;r++){const s=t[r];Ba(n,s),Su(n,e[s])}}break;case"boolean":Bt(n,e?120:121);break;default:Bt(n,127)}};class nw extends Yu{constructor(e){super(),this.w=e,this.s=null,this.count=0}write(e){this.s===e?this.count++:(this.count>0&&Re(this,this.count-1),this.count=1,this.w(this,e),this.s=e)}}const rw=n=>{n.count>0&&(t4(n.encoder,n.count===1?n.s:-n.s),n.count>1&&Re(n.encoder,n.count-2))};class Qh{constructor(){this.encoder=new Yu,this.s=0,this.count=0}write(e){this.s===e?this.count++:(rw(this),this.count=1,this.s=e)}toUint8Array(){return rw(this),jr(this.encoder)}}const sw=n=>{if(n.count>0){const e=n.diff*2+(n.count===1?0:1);t4(n.encoder,e),n.count>1&&Re(n.encoder,n.count-2)}};class Z2{constructor(){this.encoder=new Yu,this.s=0,this.count=0,this.diff=0}write(e){this.diff===e-this.s?(this.s=e,this.count++):(sw(this),this.count=1,this.diff=e-this.s,this.s=e)}toUint8Array(){return sw(this),jr(this.encoder)}}class MG{constructor(){this.sarr=[],this.s="",this.lensE=new Qh}write(e){this.s+=e,this.s.length>19&&(this.sarr.push(this.s),this.s=""),this.lensE.write(e.length)}toUint8Array(){const e=new Yu;return this.sarr.push(this.s),this.s="",Ba(e,this.sarr.join("")),j1(e,this.lensE.toUint8Array()),jr(e)}}const Ai=n=>new Error(n),Hr=()=>{throw Ai("Method unimplemented")},Gr=()=>{throw Ai("Unexpected case")},UC=Ai("Unexpected end of array"),VC=Ai("Integer out of Range");class $1{constructor(e){this.arr=e,this.pos=0}}const Cl=n=>new $1(n),RG=n=>n.pos!==n.arr.length,LG=(n,e)=>{const t=new Uint8Array(n.arr.buffer,n.pos+n.arr.byteOffset,e);return n.pos+=e,t},Rn=n=>LG(n,_e(n)),hl=n=>n.arr[n.pos++],_e=n=>{let e=0,t=1;const r=n.arr.length;for(;n.pos<r;){const s=n.arr[n.pos++];if(e=e+(s&co)*t,t*=128,s<Fn)return e;if(e>FC)throw VC}throw UC},r4=n=>{let e=n.arr[n.pos++],t=e&um,r=64;const s=(e&Es)>0?-1:1;if((e&Fn)===0)return s*t;const i=n.arr.length;for(;n.pos<i;){if(e=n.arr[n.pos++],t=t+(e&co)*r,r*=128,e<Fn)return s*t;if(t>FC)throw VC}throw UC},OG=n=>{let e=_e(n);if(e===0)return"";{let t=String.fromCodePoint(hl(n));if(--e<100)for(;e--;)t+=String.fromCodePoint(hl(n));else for(;e>0;){const r=e<1e4?e:1e4,s=n.arr.subarray(n.pos,n.pos+r);n.pos+=r,t+=String.fromCodePoint.apply(null,s),e-=r}return decodeURIComponent(escape(t))}},BG=n=>qc.decode(Rn(n)),Fa=qc?BG:OG,s4=(n,e)=>{const t=new DataView(n.arr.buffer,n.arr.byteOffset+n.pos,e);return n.pos+=e,t},FG=n=>s4(n,4).getFloat32(0,!1),UG=n=>s4(n,8).getFloat64(0,!1),VG=n=>s4(n,8).getBigInt64(0,!1),jG=[n=>{},n=>null,r4,FG,UG,VG,n=>!1,n=>!0,Fa,n=>{const e=_e(n),t={};for(let r=0;r<e;r++){const s=Fa(n);t[s]=Eu(n)}return t},n=>{const e=_e(n),t=[];for(let r=0;r<e;r++)t.push(Eu(n));return t},Rn],Eu=n=>jG[127-hl(n)](n);class iw extends $1{constructor(e,t){super(e),this.reader=t,this.s=null,this.count=0}read(){return this.count===0&&(this.s=this.reader(this),RG(this)?this.count=_e(this)+1:this.count=-1),this.count--,this.s}}class Yh extends $1{constructor(e){super(e),this.s=0,this.count=0}read(){if(this.count===0){this.s=r4(this);const e=BC(this.s);this.count=1,e&&(this.s=-this.s,this.count=_e(this)+2)}return this.count--,this.s}}class eg extends $1{constructor(e){super(e),this.s=0,this.count=0,this.diff=0}read(){if(this.count===0){const e=r4(this),t=e&1;this.diff=ki(e/2),this.count=1,t&&(this.count=_e(this)+2)}return this.s+=this.diff,this.count--,this.s}}class $G{constructor(e){this.decoder=new Yh(e),this.str=Fa(this.decoder),this.spos=0}read(){const e=this.spos+this.decoder.read(),t=this.str.slice(this.spos,e);return this.spos=e,t}}const zG=crypto.getRandomValues.bind(crypto),jC=()=>zG(new Uint32Array(1))[0],HG="10000000-1000-4000-8000"+-1e11,KG=()=>HG.replace(/[018]/g,n=>(n^jC()&15>>n/4).toString(16)),ow=n=>new Promise(n);Promise.all.bind(Promise);const aw=n=>n===void 0?null:n;class qG{constructor(){this.map=new Map}setItem(e,t){this.map.set(e,t)}getItem(e){return this.map.get(e)}}let $C=new qG,WG=!0;try{typeof localStorage<"u"&&localStorage&&($C=localStorage,WG=!1)}catch{}const GG=$C,QG=Object.assign,YG=Object.keys,XG=(n,e)=>{for(const t in n)e(n[t],t)},lw=n=>YG(n).length,JG=n=>{for(const e in n)return!1;return!0},ZG=(n,e)=>{for(const t in n)if(!e(n[t],t))return!1;return!0},eQ=(n,e)=>Object.prototype.hasOwnProperty.call(n,e),tQ=(n,e)=>n===e||lw(n)===lw(e)&&ZG(n,(t,r)=>(t!==void 0||eQ(e,r))&&e[r]===t),nQ=Object.freeze,zC=n=>{for(const e in n){const t=n[e];(typeof t=="object"||typeof t=="function")&&zC(n[e])}return nQ(n)},i4=(n,e,t=0)=>{try{for(;t<n.length;t++)n[t](...e)}finally{t<n.length&&i4(n,e,t+1)}},rQ=n=>n,sQ=(n,e)=>e.includes(n);var HC={};const Cu=typeof process<"u"&&process.release&&/node|io\.js/.test(process.release.name)&&Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]";let Mr;const iQ=()=>{if(Mr===void 0)if(Cu){Mr=vr();const n=process.argv;let e=null;for(let t=0;t<n.length;t++){const r=n[t];r[0]==="-"?(e!==null&&Mr.set(e,""),e=r):e!==null&&(Mr.set(e,r),e=null)}e!==null&&Mr.set(e,"")}else typeof location=="object"?(Mr=vr(),(location.search||"?").slice(1).split("&").forEach(n=>{if(n.length!==0){const[e,t]=n.split("=");Mr.set(`--${ew(e,"-")}`,t),Mr.set(`-${ew(e,"-")}`,t)}})):Mr=vr();return Mr},fm=n=>iQ().has(n),Qf=n=>aw(Cu?HC[n.toUpperCase().replaceAll("-","_")]:GG.getItem(n)),KC=n=>fm("--"+n)||Qf(n)!==null;KC("production");const oQ=Cu&&sQ(HC.FORCE_COLOR,["true","1","2"]),aQ=oQ||!fm("--no-colors")&&!KC("no-color")&&(!Cu||process.stdout.isTTY)&&(!Cu||fm("--color")||Qf("COLORTERM")!==null||(Qf("TERM")||"").includes("color")),lQ=n=>new Uint8Array(n),cQ=n=>{const e=lQ(n.byteLength);return e.set(n),e};class uQ{constructor(e,t){this.left=e,this.right=t}}const cs=(n,e)=>new uQ(n,e);typeof DOMParser<"u"&&new DOMParser;const dQ=n=>uG(n,(e,t)=>`${t}:${e};`).join(""),Ms=Symbol,qC=Ms(),WC=Ms(),hQ=Ms(),fQ=Ms(),pQ=Ms(),GC=Ms(),gQ=Ms(),o4=Ms(),mQ=Ms(),yQ=n=>{n.length===1&&n[0]?.constructor===Function&&(n=n[0]());const e=[],t=[];let r=0;for(;r<n.length;r++){const s=n[r];if(s===void 0)break;if(s.constructor===String||s.constructor===Number)e.push(s);else if(s.constructor===Object)break}for(r>0&&t.push(e.join(""));r<n.length;r++){const s=n[r];s instanceof Symbol||t.push(s)}return t},wQ={[qC]:cs("font-weight","bold"),[WC]:cs("font-weight","normal"),[hQ]:cs("color","blue"),[pQ]:cs("color","green"),[fQ]:cs("color","grey"),[GC]:cs("color","red"),[gQ]:cs("color","purple"),[o4]:cs("color","orange"),[mQ]:cs("color","black")},vQ=n=>{n.length===1&&n[0]?.constructor===Function&&(n=n[0]());const e=[],t=[],r=vr();let s=[],i=0;for(;i<n.length;i++){const a=n[i],c=wQ[a];if(c!==void 0)r.set(c.left,c.right);else{if(a===void 0)break;if(a.constructor===String||a.constructor===Number){const u=dQ(r);i>0||u.length>0?(e.push("%c"+a),t.push(u)):e.push(a)}else break}}for(i>0&&(s=t,s.unshift(e.join("")));i<n.length;i++){const a=n[i];a instanceof Symbol||s.push(a)}return s},QC=aQ?vQ:yQ,bQ=(...n)=>{console.log(...QC(n)),YC.forEach(e=>e.print(n))},xQ=(...n)=>{console.warn(...QC(n)),n.unshift(o4),YC.forEach(e=>e.print(n))},YC=dl(),XC=n=>({[Symbol.iterator](){return this},next:n}),SQ=(n,e)=>XC(()=>{let t;do t=n.next();while(!t.done&&!e(t.value));return t}),tg=(n,e)=>XC(()=>{const{done:t,value:r}=n.next();return{done:t,value:t?void 0:e(r)}});class a4{constructor(e,t){this.clock=e,this.len=t}}class Xu{constructor(){this.clients=new Map}}const JC=(n,e,t)=>e.clients.forEach((r,s)=>{const i=n.doc.store.clients.get(s);if(i!=null){const a=i[i.length-1],c=a.id.clock+a.length;for(let u=0,h=r[u];u<r.length&&h.clock<c;h=r[++u])lk(n,i,h.clock,h.len,t)}}),EQ=(n,e)=>{let t=0,r=n.length-1;for(;t<=r;){const s=ki((t+r)/2),i=n[s],a=i.clock;if(a<=e){if(e<a+i.len)return s;t=s+1}else r=s-1}return null},ZC=(n,e)=>{const t=n.clients.get(e.client);return t!==void 0&&EQ(t,e.clock)!==null},l4=n=>{n.clients.forEach(e=>{e.sort((s,i)=>s.clock-i.clock);let t,r;for(t=1,r=1;t<e.length;t++){const s=e[r-1],i=e[t];s.clock+s.len>=i.clock?s.len=Oo(s.len,i.clock+i.len-s.clock):(r<t&&(e[r]=i),r++)}e.length=r})},CQ=n=>{const e=new Xu;for(let t=0;t<n.length;t++)n[t].clients.forEach((r,s)=>{if(!e.clients.has(s)){const i=r.slice();for(let a=t+1;a<n.length;a++)hG(i,n[a].clients.get(s)||[]);e.clients.set(s,i)}});return l4(e),e},Yf=(n,e,t,r)=>{Ii(n.clients,e,()=>[]).push(new a4(t,r))},kQ=()=>new Xu,AQ=n=>{const e=kQ();return n.clients.forEach((t,r)=>{const s=[];for(let i=0;i<t.length;i++){const a=t[i];if(a.deleted){const c=a.id.clock;let u=a.length;if(i+1<t.length)for(let h=t[i+1];i+1<t.length&&h.deleted;h=t[++i+1])u+=h.length;s.push(new a4(c,u))}}s.length>0&&e.clients.set(r,s)}),e},kl=(n,e)=>{Re(n.restEncoder,e.clients.size),xo(e.clients.entries()).sort((t,r)=>r[0]-t[0]).forEach(([t,r])=>{n.resetDsCurVal(),Re(n.restEncoder,t);const s=r.length;Re(n.restEncoder,s);for(let i=0;i<s;i++){const a=r[i];n.writeDsClock(a.clock),n.writeDsLen(a.len)}})},c4=n=>{const e=new Xu,t=_e(n.restDecoder);for(let r=0;r<t;r++){n.resetDsCurVal();const s=_e(n.restDecoder),i=_e(n.restDecoder);if(i>0){const a=Ii(e.clients,s,()=>[]);for(let c=0;c<i;c++)a.push(new a4(n.readDsClock(),n.readDsLen()))}}return e},cw=(n,e,t)=>{const r=new Xu,s=_e(n.restDecoder);for(let i=0;i<s;i++){n.resetDsCurVal();const a=_e(n.restDecoder),c=_e(n.restDecoder),u=t.clients.get(a)||[],h=Ut(t,a);for(let f=0;f<c;f++){const p=n.readDsClock(),m=p+n.readDsLen();if(p<h){h<m&&Yf(r,a,h,m-h);let w=Qr(u,p),x=u[w];for(!x.deleted&&x.id.clock<p&&(u.splice(w+1,0,r1(e,x,p-x.id.clock)),w++);w<u.length&&(x=u[w++],x.id.clock<m);)x.deleted||(m<x.id.clock+x.length&&u.splice(w,0,r1(e,x,m-x.id.clock)),x.delete(e))}else Yf(r,a,p,m-p)}}if(r.clients.size>0){const i=new So;return Re(i.restEncoder,0),kl(i,r),i.toUint8Array()}return null},ek=jC;class Al extends pG{constructor({guid:e=KG(),collectionid:t=null,gc:r=!0,gcFilter:s=()=>!0,meta:i=null,autoLoad:a=!1,shouldLoad:c=!0}={}){super(),this.gc=r,this.gcFilter=s,this.clientID=ek(),this.guid=e,this.collectionid=t,this.share=new Map,this.store=new ok,this._transaction=null,this._transactionCleanups=[],this.subdocs=new Set,this._item=null,this.shouldLoad=c,this.autoLoad=a,this.meta=i,this.isLoaded=!1,this.isSynced=!1,this.isDestroyed=!1,this.whenLoaded=ow(h=>{this.on("load",()=>{this.isLoaded=!0,h(this)})});const u=()=>ow(h=>{const f=p=>{(p===void 0||p===!0)&&(this.off("sync",f),h())};this.on("sync",f)});this.on("sync",h=>{h===!1&&this.isSynced&&(this.whenSynced=u()),this.isSynced=h===void 0||h===!0,this.isSynced&&!this.isLoaded&&this.emit("load",[this])}),this.whenSynced=u()}load(){const e=this._item;e!==null&&!this.shouldLoad&&tt(e.parent.doc,t=>{t.subdocsLoaded.add(this)},null,!0),this.shouldLoad=!0}getSubdocs(){return this.subdocs}getSubdocGuids(){return new Set(xo(this.subdocs).map(e=>e.guid))}transact(e,t=null){return tt(this,e,t)}get(e,t=Gt){const r=Ii(this.share,e,()=>{const i=new t;return i._integrate(this,null),i}),s=r.constructor;if(t!==Gt&&s!==t)if(s===Gt){const i=new t;i._map=r._map,r._map.forEach(a=>{for(;a!==null;a=a.left)a.parent=i}),i._start=r._start;for(let a=i._start;a!==null;a=a.right)a.parent=i;return i._length=r._length,this.share.set(e,i),i._integrate(this,null),i}else throw new Error(`Type with the name ${e} has already been defined with a different constructor`);return r}getArray(e=""){return this.get(e,Xn)}getText(e=""){return this.get(e,gl)}getMap(e=""){return this.get(e,pl)}getXmlElement(e=""){return this.get(e,ml)}getXmlFragment(e=""){return this.get(e,Eo)}toJSON(){const e={};return this.share.forEach((t,r)=>{e[r]=t.toJSON()}),e}destroy(){this.isDestroyed=!0,xo(this.subdocs).forEach(t=>t.destroy());const e=this._item;if(e!==null){this._item=null;const t=e.content;t.doc=new Al({guid:this.guid,...t.opts,shouldLoad:!1}),t.doc._item=e,tt(e.parent.doc,r=>{const s=t.doc;e.deleted||r.subdocsAdded.add(s),r.subdocsRemoved.add(this)},null,!0)}this.emit("destroyed",[!0]),this.emit("destroy",[this]),super.destroy()}}class tk{constructor(e){this.restDecoder=e}resetDsCurVal(){}readDsClock(){return _e(this.restDecoder)}readDsLen(){return _e(this.restDecoder)}}class nk extends tk{readLeftID(){return Ne(_e(this.restDecoder),_e(this.restDecoder))}readRightID(){return Ne(_e(this.restDecoder),_e(this.restDecoder))}readClient(){return _e(this.restDecoder)}readInfo(){return hl(this.restDecoder)}readString(){return Fa(this.restDecoder)}readParentInfo(){return _e(this.restDecoder)===1}readTypeRef(){return _e(this.restDecoder)}readLen(){return _e(this.restDecoder)}readAny(){return Eu(this.restDecoder)}readBuf(){return cQ(Rn(this.restDecoder))}readJSON(){return JSON.parse(Fa(this.restDecoder))}readKey(){return Fa(this.restDecoder)}}class PQ{constructor(e){this.dsCurrVal=0,this.restDecoder=e}resetDsCurVal(){this.dsCurrVal=0}readDsClock(){return this.dsCurrVal+=_e(this.restDecoder),this.dsCurrVal}readDsLen(){const e=_e(this.restDecoder)+1;return this.dsCurrVal+=e,e}}class fl extends PQ{constructor(e){super(e),this.keys=[],_e(e),this.keyClockDecoder=new eg(Rn(e)),this.clientDecoder=new Yh(Rn(e)),this.leftClockDecoder=new eg(Rn(e)),this.rightClockDecoder=new eg(Rn(e)),this.infoDecoder=new iw(Rn(e),hl),this.stringDecoder=new $G(Rn(e)),this.parentInfoDecoder=new iw(Rn(e),hl),this.typeRefDecoder=new Yh(Rn(e)),this.lenDecoder=new Yh(Rn(e))}readLeftID(){return new Ua(this.clientDecoder.read(),this.leftClockDecoder.read())}readRightID(){return new Ua(this.clientDecoder.read(),this.rightClockDecoder.read())}readClient(){return this.clientDecoder.read()}readInfo(){return this.infoDecoder.read()}readString(){return this.stringDecoder.read()}readParentInfo(){return this.parentInfoDecoder.read()===1}readTypeRef(){return this.typeRefDecoder.read()}readLen(){return this.lenDecoder.read()}readAny(){return Eu(this.restDecoder)}readBuf(){return Rn(this.restDecoder)}readJSON(){return Eu(this.restDecoder)}readKey(){const e=this.keyClockDecoder.read();if(e<this.keys.length)return this.keys[e];{const t=this.stringDecoder.read();return this.keys.push(t),t}}}class TQ{constructor(){this.restEncoder=V1()}toUint8Array(){return jr(this.restEncoder)}resetDsCurVal(){}writeDsClock(e){Re(this.restEncoder,e)}writeDsLen(e){Re(this.restEncoder,e)}}class Ju extends TQ{writeLeftID(e){Re(this.restEncoder,e.client),Re(this.restEncoder,e.clock)}writeRightID(e){Re(this.restEncoder,e.client),Re(this.restEncoder,e.clock)}writeClient(e){Re(this.restEncoder,e)}writeInfo(e){dm(this.restEncoder,e)}writeString(e){Ba(this.restEncoder,e)}writeParentInfo(e){Re(this.restEncoder,e?1:0)}writeTypeRef(e){Re(this.restEncoder,e)}writeLen(e){Re(this.restEncoder,e)}writeAny(e){Su(this.restEncoder,e)}writeBuf(e){Mn(this.restEncoder,e)}writeJSON(e){Ba(this.restEncoder,JSON.stringify(e))}writeKey(e){Ba(this.restEncoder,e)}}class _Q{constructor(){this.restEncoder=V1(),this.dsCurrVal=0}toUint8Array(){return jr(this.restEncoder)}resetDsCurVal(){this.dsCurrVal=0}writeDsClock(e){const t=e-this.dsCurrVal;this.dsCurrVal=e,Re(this.restEncoder,t)}writeDsLen(e){e===0&&Gr(),Re(this.restEncoder,e-1),this.dsCurrVal+=e}}class So extends _Q{constructor(){super(),this.keyMap=new Map,this.keyClock=0,this.keyClockEncoder=new Z2,this.clientEncoder=new Qh,this.leftClockEncoder=new Z2,this.rightClockEncoder=new Z2,this.infoEncoder=new nw(dm),this.stringEncoder=new MG,this.parentInfoEncoder=new nw(dm),this.typeRefEncoder=new Qh,this.lenEncoder=new Qh}toUint8Array(){const e=V1();return Re(e,0),Mn(e,this.keyClockEncoder.toUint8Array()),Mn(e,this.clientEncoder.toUint8Array()),Mn(e,this.leftClockEncoder.toUint8Array()),Mn(e,this.rightClockEncoder.toUint8Array()),Mn(e,jr(this.infoEncoder)),Mn(e,this.stringEncoder.toUint8Array()),Mn(e,jr(this.parentInfoEncoder)),Mn(e,this.typeRefEncoder.toUint8Array()),Mn(e,this.lenEncoder.toUint8Array()),j1(e,jr(this.restEncoder)),jr(e)}writeLeftID(e){this.clientEncoder.write(e.client),this.leftClockEncoder.write(e.clock)}writeRightID(e){this.clientEncoder.write(e.client),this.rightClockEncoder.write(e.clock)}writeClient(e){this.clientEncoder.write(e)}writeInfo(e){this.infoEncoder.write(e)}writeString(e){this.stringEncoder.write(e)}writeParentInfo(e){this.parentInfoEncoder.write(e?1:0)}writeTypeRef(e){this.typeRefEncoder.write(e)}writeLen(e){this.lenEncoder.write(e)}writeAny(e){Su(this.restEncoder,e)}writeBuf(e){Mn(this.restEncoder,e)}writeJSON(e){Su(this.restEncoder,e)}writeKey(e){const t=this.keyMap.get(e);t===void 0?(this.keyClockEncoder.write(this.keyClock++),this.stringEncoder.write(e)):this.keyClockEncoder.write(t)}}const DQ=(n,e,t,r)=>{r=Oo(r,e[0].id.clock);const s=Qr(e,r);Re(n.restEncoder,e.length-s),n.writeClient(t),Re(n.restEncoder,r);const i=e[s];i.write(n,r-i.id.clock);for(let a=s+1;a<e.length;a++)e[a].write(n,0)},u4=(n,e,t)=>{const r=new Map;t.forEach((s,i)=>{Ut(e,i)>s&&r.set(i,s)}),d4(e).forEach((s,i)=>{t.has(i)||r.set(i,0)}),Re(n.restEncoder,r.size),xo(r.entries()).sort((s,i)=>i[0]-s[0]).forEach(([s,i])=>{DQ(n,e.clients.get(s),s,i)})},IQ=(n,e)=>{const t=vr(),r=_e(n.restDecoder);for(let s=0;s<r;s++){const i=_e(n.restDecoder),a=new Array(i),c=n.readClient();let u=_e(n.restDecoder);t.set(c,{i:0,refs:a});for(let h=0;h<i;h++){const f=n.readInfo();switch(U1&f){case 0:{const p=n.readLen();a[h]=new Jn(Ne(c,u),p),u+=p;break}case 10:{const p=_e(n.restDecoder);a[h]=new Zn(Ne(c,u),p),u+=p;break}default:{const p=(f&(Es|Fn))===0,m=new It(Ne(c,u),null,(f&Fn)===Fn?n.readLeftID():null,null,(f&Es)===Es?n.readRightID():null,p?n.readParentInfo()?e.get(n.readString()):n.readLeftID():null,p&&(f&bu)===bu?n.readString():null,Pk(n,f));a[h]=m,u+=m.length}}}}return t},NQ=(n,e,t)=>{const r=[];let s=xo(t.keys()).sort((w,x)=>w-x);if(s.length===0)return null;const i=()=>{if(s.length===0)return null;let w=t.get(s[s.length-1]);for(;w.refs.length===w.i;)if(s.pop(),s.length>0)w=t.get(s[s.length-1]);else return null;return w};let a=i();if(a===null)return null;const c=new ok,u=new Map,h=(w,x)=>{const S=u.get(w);(S==null||S>x)&&u.set(w,x)};let f=a.refs[a.i++];const p=new Map,m=()=>{for(const w of r){const x=w.id.client,S=t.get(x);S?(S.i--,c.clients.set(x,S.refs.slice(S.i)),t.delete(x),S.i=0,S.refs=[]):c.clients.set(x,[w]),s=s.filter(E=>E!==x)}r.length=0};for(;;){if(f.constructor!==Zn){const x=Ii(p,f.id.client,()=>Ut(e,f.id.client))-f.id.clock;if(x<0)r.push(f),h(f.id.client,f.id.clock-1),m();else{const S=f.getMissing(n,e);if(S!==null){r.push(f);const E=t.get(S)||{refs:[],i:0};if(E.refs.length===E.i)h(S,Ut(e,S)),m();else{f=E.refs[E.i++];continue}}else(x===0||x<f.length)&&(f.integrate(n,x),p.set(f.id.client,f.id.clock+f.length))}}if(r.length>0)f=r.pop();else if(a!==null&&a.i<a.refs.length)f=a.refs[a.i++];else{if(a=i(),a===null)break;f=a.refs[a.i++]}}if(c.clients.size>0){const w=new So;return u4(w,c,new Map),Re(w.restEncoder,0),{missing:u,update:w.toUint8Array()}}return null},MQ=(n,e)=>u4(n,e.doc.store,e.beforeState),RQ=(n,e,t,r=new fl(n))=>tt(e,s=>{s.local=!1;let i=!1;const a=s.doc,c=a.store,u=IQ(r,a),h=NQ(s,c,u),f=c.pendingStructs;if(f){for(const[m,w]of f.missing)if(w<Ut(c,m)){i=!0;break}if(h){for(const[m,w]of h.missing){const x=f.missing.get(m);(x==null||x>w)&&f.missing.set(m,w)}f.update=Xf([f.update,h.update])}}else c.pendingStructs=h;const p=cw(r,s,c);if(c.pendingDs){const m=new fl(Cl(c.pendingDs));_e(m.restDecoder);const w=cw(m,s,c);p&&w?c.pendingDs=Xf([p,w]):c.pendingDs=p||w}else c.pendingDs=p;if(i){const m=c.pendingStructs.update;c.pendingStructs=null,rk(s.doc,m)}},t,!1),rk=(n,e,t,r=fl)=>{const s=Cl(e);RQ(s,n,t,new r(s))},ng=(n,e,t)=>rk(n,e,t,nk),LQ=(n,e,t=new Map)=>{u4(n,e.store,t),kl(n,AQ(e.store))},OQ=(n,e=new Uint8Array([0]),t=new So)=>{const r=sk(e);LQ(t,n,r);const s=[t.toUint8Array()];if(n.store.pendingDs&&s.push(n.store.pendingDs),n.store.pendingStructs&&s.push(GQ(n.store.pendingStructs.update,e)),s.length>1){if(t.constructor===Ju)return qQ(s.map((i,a)=>a===0?i:YQ(i)));if(t.constructor===So)return Xf(s)}return s[0]},uw=(n,e)=>OQ(n,e,new Ju),BQ=n=>{const e=new Map,t=_e(n.restDecoder);for(let r=0;r<t;r++){const s=_e(n.restDecoder),i=_e(n.restDecoder);e.set(s,i)}return e},sk=n=>BQ(new tk(Cl(n)));class FQ{constructor(){this.l=[]}}const dw=()=>new FQ,hw=(n,e)=>n.l.push(e),fw=(n,e)=>{const t=n.l,r=t.length;n.l=t.filter(s=>e!==s),r===n.l.length&&console.error("[yjs] Tried to remove event handler that doesn't exist.")},ik=(n,e,t)=>i4(n.l,[e,t]);class Ua{constructor(e,t){this.client=e,this.clock=t}}const Fh=(n,e)=>n===e||n!==null&&e!==null&&n.client===e.client&&n.clock===e.clock,Ne=(n,e)=>new Ua(n,e),UQ=n=>{for(const[e,t]of n.doc.share.entries())if(t===n)return e;throw Gr()},wa=(n,e)=>e===void 0?!n.deleted:e.sv.has(n.id.client)&&(e.sv.get(n.id.client)||0)>n.id.clock&&!ZC(e.ds,n.id),pm=(n,e)=>{const t=Ii(n.meta,pm,dl),r=n.doc.store;t.has(e)||(e.sv.forEach((s,i)=>{s<Ut(r,i)&&Pi(n,Ne(i,s))}),JC(n,e.ds,s=>{}),t.add(e))};class ok{constructor(){this.clients=new Map,this.pendingStructs=null,this.pendingDs=null}}const d4=n=>{const e=new Map;return n.clients.forEach((t,r)=>{const s=t[t.length-1];e.set(r,s.id.clock+s.length)}),e},Ut=(n,e)=>{const t=n.clients.get(e);if(t===void 0)return 0;const r=t[t.length-1];return r.id.clock+r.length},ak=(n,e)=>{let t=n.clients.get(e.id.client);if(t===void 0)t=[],n.clients.set(e.id.client,t);else{const r=t[t.length-1];if(r.id.clock+r.length!==e.id.clock)throw Gr()}t.push(e)},Qr=(n,e)=>{let t=0,r=n.length-1,s=n[r],i=s.id.clock;if(i===e)return r;let a=ki(e/(i+s.length-1)*r);for(;t<=r;){if(s=n[a],i=s.id.clock,i<=e){if(e<i+s.length)return a;t=a+1}else r=a-1;a=ki((t+r)/2)}throw Gr()},VQ=(n,e)=>{const t=n.clients.get(e.client);return t[Qr(t,e.clock)]},rg=VQ,gm=(n,e,t)=>{const r=Qr(e,t),s=e[r];return s.id.clock<t&&s instanceof It?(e.splice(r+1,0,r1(n,s,t-s.id.clock)),r+1):r},Pi=(n,e)=>{const t=n.doc.store.clients.get(e.client);return t[gm(n,t,e.clock)]},pw=(n,e,t)=>{const r=e.clients.get(t.client),s=Qr(r,t.clock),i=r[s];return t.clock!==i.id.clock+i.length-1&&i.constructor!==Jn&&r.splice(s+1,0,r1(n,i,t.clock-i.id.clock+1)),i},jQ=(n,e,t)=>{const r=n.clients.get(e.id.client);r[Qr(r,e.id.clock)]=t},lk=(n,e,t,r,s)=>{if(r===0)return;const i=t+r;let a=gm(n,e,t),c;do c=e[a++],i<c.id.clock+c.length&&gm(n,e,i),s(c);while(a<e.length&&e[a].id.clock<i)};class $Q{constructor(e,t,r){this.doc=e,this.deleteSet=new Xu,this.beforeState=d4(e.store),this.afterState=new Map,this.changed=new Map,this.changedParentTypes=new Map,this._mergeStructs=[],this.origin=t,this.meta=new Map,this.local=r,this.subdocsAdded=new Set,this.subdocsRemoved=new Set,this.subdocsLoaded=new Set,this._needFormattingCleanup=!1}}const gw=(n,e)=>e.deleteSet.clients.size===0&&!dG(e.afterState,(t,r)=>e.beforeState.get(r)!==t)?!1:(l4(e.deleteSet),MQ(n,e),kl(n,e.deleteSet),!0),mw=(n,e,t)=>{const r=e._item;(r===null||r.id.clock<(n.beforeState.get(r.id.client)||0)&&!r.deleted)&&Ii(n.changed,e,dl).add(t)},Xh=(n,e)=>{let t=n[e],r=n[e-1],s=e;for(;s>0;t=r,r=n[--s-1]){if(r.deleted===t.deleted&&r.constructor===t.constructor&&r.mergeWith(t)){t instanceof It&&t.parentSub!==null&&t.parent._map.get(t.parentSub)===t&&t.parent._map.set(t.parentSub,r);continue}break}const i=e-s;return i&&n.splice(e+1-i,i),i},zQ=(n,e,t)=>{for(const[r,s]of n.clients.entries()){const i=e.clients.get(r);for(let a=s.length-1;a>=0;a--){const c=s[a],u=c.clock+c.len;for(let h=Qr(i,c.clock),f=i[h];h<i.length&&f.id.clock<u;f=i[++h]){const p=i[h];if(c.clock+c.len<=p.id.clock)break;p instanceof It&&p.deleted&&!p.keep&&t(p)&&p.gc(e,!1)}}}},HQ=(n,e)=>{n.clients.forEach((t,r)=>{const s=e.clients.get(r);for(let i=t.length-1;i>=0;i--){const a=t[i],c=OC(s.length-1,1+Qr(s,a.clock+a.len-1));for(let u=c,h=s[u];u>0&&h.id.clock>=a.clock;h=s[u])u-=1+Xh(s,u)}})},ck=(n,e)=>{if(e<n.length){const t=n[e],r=t.doc,s=r.store,i=t.deleteSet,a=t._mergeStructs;try{l4(i),t.afterState=d4(t.doc.store),r.emit("beforeObserverCalls",[t,r]);const c=[];t.changed.forEach((u,h)=>c.push(()=>{(h._item===null||!h._item.deleted)&&h._callObserver(t,u)})),c.push(()=>{t.changedParentTypes.forEach((u,h)=>{h._dEH.l.length>0&&(h._item===null||!h._item.deleted)&&(u=u.filter(f=>f.target._item===null||!f.target._item.deleted),u.forEach(f=>{f.currentTarget=h,f._path=null}),u.sort((f,p)=>f.path.length-p.path.length),ik(h._dEH,u,t))})}),c.push(()=>r.emit("afterTransaction",[t,r])),i4(c,[]),t._needFormattingCleanup&&uY(t)}finally{r.gc&&zQ(i,s,r.gcFilter),HQ(i,s),t.afterState.forEach((f,p)=>{const m=t.beforeState.get(p)||0;if(m!==f){const w=s.clients.get(p),x=Oo(Qr(w,m),1);for(let S=w.length-1;S>=x;)S-=1+Xh(w,S)}});for(let f=a.length-1;f>=0;f--){const{client:p,clock:m}=a[f].id,w=s.clients.get(p),x=Qr(w,m);x+1<w.length&&Xh(w,x+1)>1||x>0&&Xh(w,x)}if(!t.local&&t.afterState.get(r.clientID)!==t.beforeState.get(r.clientID)&&(bQ(o4,qC,"[yjs] ",WC,GC,"Changed the client-id because another client seems to be using it."),r.clientID=ek()),r.emit("afterTransactionCleanup",[t,r]),r._observers.has("update")){const f=new Ju;gw(f,t)&&r.emit("update",[f.toUint8Array(),t.origin,r,t])}if(r._observers.has("updateV2")){const f=new So;gw(f,t)&&r.emit("updateV2",[f.toUint8Array(),t.origin,r,t])}const{subdocsAdded:c,subdocsLoaded:u,subdocsRemoved:h}=t;(c.size>0||h.size>0||u.size>0)&&(c.forEach(f=>{f.clientID=r.clientID,f.collectionid==null&&(f.collectionid=r.collectionid),r.subdocs.add(f)}),h.forEach(f=>r.subdocs.delete(f)),r.emit("subdocs",[{loaded:u,added:c,removed:h},r,t]),h.forEach(f=>f.destroy())),n.length<=e+1?(r._transactionCleanups=[],r.emit("afterAllTransactions",[r,n])):ck(n,e+1)}}},tt=(n,e,t=null,r=!0)=>{const s=n._transactionCleanups;let i=!1,a=null;n._transaction===null&&(i=!0,n._transaction=new $Q(n,t,r),s.push(n._transaction),s.length===1&&n.emit("beforeAllTransactions",[n]),n.emit("beforeTransaction",[n._transaction,n]));try{a=e(n._transaction)}finally{if(i){const c=n._transaction===s[0];n._transaction=null,c&&ck(s,0)}}return a};function*KQ(n){const e=_e(n.restDecoder);for(let t=0;t<e;t++){const r=_e(n.restDecoder),s=n.readClient();let i=_e(n.restDecoder);for(let a=0;a<r;a++){const c=n.readInfo();if(c===10){const u=_e(n.restDecoder);yield new Zn(Ne(s,i),u),i+=u}else if((U1&c)!==0){const u=(c&(Es|Fn))===0,h=new It(Ne(s,i),null,(c&Fn)===Fn?n.readLeftID():null,null,(c&Es)===Es?n.readRightID():null,u?n.readParentInfo()?n.readString():n.readLeftID():null,u&&(c&bu)===bu?n.readString():null,Pk(n,c));yield h,i+=h.length}else{const u=n.readLen();yield new Jn(Ne(s,i),u),i+=u}}}}class h4{constructor(e,t){this.gen=KQ(e),this.curr=null,this.done=!1,this.filterSkips=t,this.next()}next(){do this.curr=this.gen.next().value||null;while(this.filterSkips&&this.curr!==null&&this.curr.constructor===Zn);return this.curr}}class f4{constructor(e){this.currClient=0,this.startClock=0,this.written=0,this.encoder=e,this.clientStructs=[]}}const qQ=n=>Xf(n,nk,Ju),WQ=(n,e)=>{if(n.constructor===Jn){const{client:t,clock:r}=n.id;return new Jn(Ne(t,r+e),n.length-e)}else if(n.constructor===Zn){const{client:t,clock:r}=n.id;return new Zn(Ne(t,r+e),n.length-e)}else{const t=n,{client:r,clock:s}=t.id;return new It(Ne(r,s+e),null,Ne(r,s+e-1),null,t.rightOrigin,t.parent,t.parentSub,t.content.splice(e))}},Xf=(n,e=fl,t=So)=>{if(n.length===1)return n[0];const r=n.map(f=>new e(Cl(f)));let s=r.map(f=>new h4(f,!0)),i=null;const a=new t,c=new f4(a);for(;s=s.filter(m=>m.curr!==null),s.sort((m,w)=>{if(m.curr.id.client===w.curr.id.client){const x=m.curr.id.clock-w.curr.id.clock;return x===0?m.curr.constructor===w.curr.constructor?0:m.curr.constructor===Zn?1:-1:x}else return w.curr.id.client-m.curr.id.client}),s.length!==0;){const f=s[0],p=f.curr.id.client;if(i!==null){let m=f.curr,w=!1;for(;m!==null&&m.id.clock+m.length<=i.struct.id.clock+i.struct.length&&m.id.client>=i.struct.id.client;)m=f.next(),w=!0;if(m===null||m.id.client!==p||w&&m.id.clock>i.struct.id.clock+i.struct.length)continue;if(p!==i.struct.id.client)ci(c,i.struct,i.offset),i={struct:m,offset:0},f.next();else if(i.struct.id.clock+i.struct.length<m.id.clock)if(i.struct.constructor===Zn)i.struct.length=m.id.clock+m.length-i.struct.id.clock;else{ci(c,i.struct,i.offset);const x=m.id.clock-i.struct.id.clock-i.struct.length;i={struct:new Zn(Ne(p,i.struct.id.clock+i.struct.length),x),offset:0}}else{const x=i.struct.id.clock+i.struct.length-m.id.clock;x>0&&(i.struct.constructor===Zn?i.struct.length-=x:m=WQ(m,x)),i.struct.mergeWith(m)||(ci(c,i.struct,i.offset),i={struct:m,offset:0},f.next())}}else i={struct:f.curr,offset:0},f.next();for(let m=f.curr;m!==null&&m.id.client===p&&m.id.clock===i.struct.id.clock+i.struct.length&&m.constructor!==Zn;m=f.next())ci(c,i.struct,i.offset),i={struct:m,offset:0}}i!==null&&(ci(c,i.struct,i.offset),i=null),p4(c);const u=r.map(f=>c4(f)),h=CQ(u);return kl(a,h),a.toUint8Array()},GQ=(n,e,t=fl,r=So)=>{const s=sk(e),i=new r,a=new f4(i),c=new t(Cl(n)),u=new h4(c,!1);for(;u.curr;){const f=u.curr,p=f.id.client,m=s.get(p)||0;if(u.curr.constructor===Zn){u.next();continue}if(f.id.clock+f.length>m)for(ci(a,f,Oo(m-f.id.clock,0)),u.next();u.curr&&u.curr.id.client===p;)ci(a,u.curr,0),u.next();else for(;u.curr&&u.curr.id.client===p&&u.curr.id.clock+u.curr.length<=m;)u.next()}p4(a);const h=c4(c);return kl(i,h),i.toUint8Array()},uk=n=>{n.written>0&&(n.clientStructs.push({written:n.written,restEncoder:jr(n.encoder.restEncoder)}),n.encoder.restEncoder=V1(),n.written=0)},ci=(n,e,t)=>{n.written>0&&n.currClient!==e.id.client&&uk(n),n.written===0&&(n.currClient=e.id.client,n.encoder.writeClient(e.id.client),Re(n.encoder.restEncoder,e.id.clock+t)),e.write(n.encoder,t),n.written++},p4=n=>{uk(n);const e=n.encoder.restEncoder;Re(e,n.clientStructs.length);for(let t=0;t<n.clientStructs.length;t++){const r=n.clientStructs[t];Re(e,r.written),j1(e,r.restEncoder)}},QQ=(n,e,t,r)=>{const s=new t(Cl(n)),i=new h4(s,!1),a=new r,c=new f4(a);for(let h=i.curr;h!==null;h=i.next())ci(c,e(h),0);p4(c);const u=c4(s);return kl(a,u),a.toUint8Array()},YQ=n=>QQ(n,rQ,fl,Ju),yw="You must not compute changes after the event-handler fired.";class z1{constructor(e,t){this.target=e,this.currentTarget=e,this.transaction=t,this._changes=null,this._keys=null,this._delta=null,this._path=null}get path(){return this._path||(this._path=XQ(this.currentTarget,this.target))}deletes(e){return ZC(this.transaction.deleteSet,e.id)}get keys(){if(this._keys===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ai(yw);const e=new Map,t=this.target;this.transaction.changed.get(t).forEach(s=>{if(s!==null){const i=t._map.get(s);let a,c;if(this.adds(i)){let u=i.left;for(;u!==null&&this.adds(u);)u=u.left;if(this.deletes(i))if(u!==null&&this.deletes(u))a="delete",c=Y2(u.content.getContent());else return;else u!==null&&this.deletes(u)?(a="update",c=Y2(u.content.getContent())):(a="add",c=void 0)}else if(this.deletes(i))a="delete",c=Y2(i.content.getContent());else return;e.set(s,{action:a,oldValue:c})}}),this._keys=e}return this._keys}get delta(){return this.changes.delta}adds(e){return e.id.clock>=(this.transaction.beforeState.get(e.id.client)||0)}get changes(){let e=this._changes;if(e===null){if(this.transaction.doc._transactionCleanups.length===0)throw Ai(yw);const t=this.target,r=dl(),s=dl(),i=[];if(e={added:r,deleted:s,delta:i,keys:this.keys},this.transaction.changed.get(t).has(null)){let c=null;const u=()=>{c&&i.push(c)};for(let h=t._start;h!==null;h=h.right)h.deleted?this.deletes(h)&&!this.adds(h)&&((c===null||c.delete===void 0)&&(u(),c={delete:0}),c.delete+=h.length,s.add(h)):this.adds(h)?((c===null||c.insert===void 0)&&(u(),c={insert:[]}),c.insert=c.insert.concat(h.content.getContent()),r.add(h)):((c===null||c.retain===void 0)&&(u(),c={retain:0}),c.retain+=h.length);c!==null&&c.retain===void 0&&u()}this._changes=e}return e}}const XQ=(n,e)=>{const t=[];for(;e._item!==null&&e!==n;){if(e._item.parentSub!==null)t.unshift(e._item.parentSub);else{let r=0,s=e._item.parent._start;for(;s!==e._item&&s!==null;)!s.deleted&&s.countable&&(r+=s.length),s=s.right;t.unshift(r)}e=e._item.parent}return t},an=()=>{xQ("Invalid access: Add Yjs type to a document before reading data.")},dk=80;let g4=0;class JQ{constructor(e,t){e.marker=!0,this.p=e,this.index=t,this.timestamp=g4++}}const ZQ=n=>{n.timestamp=g4++},hk=(n,e,t)=>{n.p.marker=!1,n.p=e,e.marker=!0,n.index=t,n.timestamp=g4++},eY=(n,e,t)=>{if(n.length>=dk){const r=n.reduce((s,i)=>s.timestamp<i.timestamp?s:i);return hk(r,e,t),r}else{const r=new JQ(e,t);return n.push(r),r}},H1=(n,e)=>{if(n._start===null||e===0||n._searchMarker===null)return null;const t=n._searchMarker.length===0?null:n._searchMarker.reduce((i,a)=>Gh(e-i.index)<Gh(e-a.index)?i:a);let r=n._start,s=0;for(t!==null&&(r=t.p,s=t.index,ZQ(t));r.right!==null&&s<e;){if(!r.deleted&&r.countable){if(e<s+r.length)break;s+=r.length}r=r.right}for(;r.left!==null&&s>e;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);for(;r.left!==null&&r.left.id.client===r.id.client&&r.left.id.clock+r.left.length===r.id.clock;)r=r.left,!r.deleted&&r.countable&&(s-=r.length);return t!==null&&Gh(t.index-s)<r.parent.length/dk?(hk(t,r,s),t):eY(n._searchMarker,r,s)},ku=(n,e,t)=>{for(let r=n.length-1;r>=0;r--){const s=n[r];if(t>0){let i=s.p;for(i.marker=!1;i&&(i.deleted||!i.countable);)i=i.left,i&&!i.deleted&&i.countable&&(s.index-=i.length);if(i===null||i.marker===!0){n.splice(r,1);continue}s.p=i,i.marker=!0}(e<s.index||t>0&&e===s.index)&&(s.index=Oo(e,s.index+t))}},K1=(n,e,t)=>{const r=n,s=e.changedParentTypes;for(;Ii(s,n,()=>[]).push(t),n._item!==null;)n=n._item.parent;ik(r._eH,t,e)};class Gt{constructor(){this._item=null,this._map=new Map,this._start=null,this.doc=null,this._length=0,this._eH=dw(),this._dEH=dw(),this._searchMarker=null}get parent(){return this._item?this._item.parent:null}_integrate(e,t){this.doc=e,this._item=t}_copy(){throw Hr()}clone(){throw Hr()}_write(e){}get _first(){let e=this._start;for(;e!==null&&e.deleted;)e=e.right;return e}_callObserver(e,t){!e.local&&this._searchMarker&&(this._searchMarker.length=0)}observe(e){hw(this._eH,e)}observeDeep(e){hw(this._dEH,e)}unobserve(e){fw(this._eH,e)}unobserveDeep(e){fw(this._dEH,e)}toJSON(){}}const fk=(n,e,t)=>{n.doc??an(),e<0&&(e=n._length+e),t<0&&(t=n._length+t);let r=t-e;const s=[];let i=n._start;for(;i!==null&&r>0;){if(i.countable&&!i.deleted){const a=i.content.getContent();if(a.length<=e)e-=a.length;else{for(let c=e;c<a.length&&r>0;c++)s.push(a[c]),r--;e=0}}i=i.right}return s},pk=n=>{n.doc??an();const e=[];let t=n._start;for(;t!==null;){if(t.countable&&!t.deleted){const r=t.content.getContent();for(let s=0;s<r.length;s++)e.push(r[s])}t=t.right}return e},Au=(n,e)=>{let t=0,r=n._start;for(n.doc??an();r!==null;){if(r.countable&&!r.deleted){const s=r.content.getContent();for(let i=0;i<s.length;i++)e(s[i],t++,n)}r=r.right}},gk=(n,e)=>{const t=[];return Au(n,(r,s)=>{t.push(e(r,s,n))}),t},tY=n=>{let e=n._start,t=null,r=0;return{[Symbol.iterator](){return this},next:()=>{if(t===null){for(;e!==null&&e.deleted;)e=e.right;if(e===null)return{done:!0,value:void 0};t=e.content.getContent(),r=0,e=e.right}const s=t[r++];return t.length<=r&&(t=null),{done:!1,value:s}}}},mk=(n,e)=>{n.doc??an();const t=H1(n,e);let r=n._start;for(t!==null&&(r=t.p,e-=t.index);r!==null;r=r.right)if(!r.deleted&&r.countable){if(e<r.length)return r.content.getContent()[e];e-=r.length}},Jf=(n,e,t,r)=>{let s=t;const i=n.doc,a=i.clientID,c=i.store,u=t===null?e._start:t.right;let h=[];const f=()=>{h.length>0&&(s=new It(Ne(a,Ut(c,a)),s,s&&s.lastId,u,u&&u.id,e,null,new Co(h)),s.integrate(n,0),h=[])};r.forEach(p=>{if(p===null)h.push(p);else switch(p.constructor){case Number:case Object:case Boolean:case Array:case String:h.push(p);break;default:switch(f(),p.constructor){case Uint8Array:case ArrayBuffer:s=new It(Ne(a,Ut(c,a)),s,s&&s.lastId,u,u&&u.id,e,null,new Zu(new Uint8Array(p))),s.integrate(n,0);break;case Al:s=new It(Ne(a,Ut(c,a)),s,s&&s.lastId,u,u&&u.id,e,null,new ed(p)),s.integrate(n,0);break;default:if(p instanceof Gt)s=new It(Ne(a,Ut(c,a)),s,s&&s.lastId,u,u&&u.id,e,null,new Rs(p)),s.integrate(n,0);else throw new Error("Unexpected content type in insert operation")}}}),f()},yk=()=>Ai("Length exceeded!"),wk=(n,e,t,r)=>{if(t>e._length)throw yk();if(t===0)return e._searchMarker&&ku(e._searchMarker,t,r.length),Jf(n,e,null,r);const s=t,i=H1(e,t);let a=e._start;for(i!==null&&(a=i.p,t-=i.index,t===0&&(a=a.prev,t+=a&&a.countable&&!a.deleted?a.length:0));a!==null;a=a.right)if(!a.deleted&&a.countable){if(t<=a.length){t<a.length&&Pi(n,Ne(a.id.client,a.id.clock+t));break}t-=a.length}return e._searchMarker&&ku(e._searchMarker,s,r.length),Jf(n,e,a,r)},nY=(n,e,t)=>{let s=(e._searchMarker||[]).reduce((i,a)=>a.index>i.index?a:i,{index:0,p:e._start}).p;if(s)for(;s.right;)s=s.right;return Jf(n,e,s,t)},vk=(n,e,t,r)=>{if(r===0)return;const s=t,i=r,a=H1(e,t);let c=e._start;for(a!==null&&(c=a.p,t-=a.index);c!==null&&t>0;c=c.right)!c.deleted&&c.countable&&(t<c.length&&Pi(n,Ne(c.id.client,c.id.clock+t)),t-=c.length);for(;r>0&&c!==null;)c.deleted||(r<c.length&&Pi(n,Ne(c.id.client,c.id.clock+r)),c.delete(n),r-=c.length),c=c.right;if(r>0)throw yk();e._searchMarker&&ku(e._searchMarker,s,-i+r)},Zf=(n,e,t)=>{const r=e._map.get(t);r!==void 0&&r.delete(n)},m4=(n,e,t,r)=>{const s=e._map.get(t)||null,i=n.doc,a=i.clientID;let c;if(r==null)c=new Co([r]);else switch(r.constructor){case Number:case Object:case Boolean:case Array:case String:case Date:case BigInt:c=new Co([r]);break;case Uint8Array:c=new Zu(r);break;case Al:c=new ed(r);break;default:if(r instanceof Gt)c=new Rs(r);else throw new Error("Unexpected content type")}new It(Ne(a,Ut(i.store,a)),s,s&&s.lastId,null,null,e,t,c).integrate(n,0)},y4=(n,e)=>{n.doc??an();const t=n._map.get(e);return t!==void 0&&!t.deleted?t.content.getContent()[t.length-1]:void 0},bk=n=>{const e={};return n.doc??an(),n._map.forEach((t,r)=>{t.deleted||(e[r]=t.content.getContent()[t.length-1])}),e},xk=(n,e)=>{n.doc??an();const t=n._map.get(e);return t!==void 0&&!t.deleted},rY=(n,e)=>{const t={};return n._map.forEach((r,s)=>{let i=r;for(;i!==null&&(!e.sv.has(i.id.client)||i.id.clock>=(e.sv.get(i.id.client)||0));)i=i.left;i!==null&&wa(i,e)&&(t[s]=i.content.getContent()[i.length-1])}),t},Uh=n=>(n.doc??an(),SQ(n._map.entries(),e=>!e[1].deleted));class sY extends z1{}class Xn extends Gt{constructor(){super(),this._prelimContent=[],this._searchMarker=[]}static from(e){const t=new Xn;return t.push(e),t}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Xn}clone(){const e=new Xn;return e.insert(0,this.toArray().map(t=>t instanceof Gt?t.clone():t)),e}get length(){return this.doc??an(),this._length}_callObserver(e,t){super._callObserver(e,t),K1(this,e,new sY(this,e))}insert(e,t){this.doc!==null?tt(this.doc,r=>{wk(r,this,e,t)}):this._prelimContent.splice(e,0,...t)}push(e){this.doc!==null?tt(this.doc,t=>{nY(t,this,e)}):this._prelimContent.push(...e)}unshift(e){this.insert(0,e)}delete(e,t=1){this.doc!==null?tt(this.doc,r=>{vk(r,this,e,t)}):this._prelimContent.splice(e,t)}get(e){return mk(this,e)}toArray(){return pk(this)}slice(e=0,t=this.length){return fk(this,e,t)}toJSON(){return this.map(e=>e instanceof Gt?e.toJSON():e)}map(e){return gk(this,e)}forEach(e){Au(this,e)}[Symbol.iterator](){return tY(this)}_write(e){e.writeTypeRef(_Y)}}const iY=n=>new Xn;class oY extends z1{constructor(e,t,r){super(e,t),this.keysChanged=r}}class pl extends Gt{constructor(e){super(),this._prelimContent=null,e===void 0?this._prelimContent=new Map:this._prelimContent=new Map(e)}_integrate(e,t){super._integrate(e,t),this._prelimContent.forEach((r,s)=>{this.set(s,r)}),this._prelimContent=null}_copy(){return new pl}clone(){const e=new pl;return this.forEach((t,r)=>{e.set(r,t instanceof Gt?t.clone():t)}),e}_callObserver(e,t){K1(this,e,new oY(this,e,t))}toJSON(){this.doc??an();const e={};return this._map.forEach((t,r)=>{if(!t.deleted){const s=t.content.getContent()[t.length-1];e[r]=s instanceof Gt?s.toJSON():s}}),e}get size(){return[...Uh(this)].length}keys(){return tg(Uh(this),e=>e[0])}values(){return tg(Uh(this),e=>e[1].content.getContent()[e[1].length-1])}entries(){return tg(Uh(this),e=>[e[0],e[1].content.getContent()[e[1].length-1]])}forEach(e){this.doc??an(),this._map.forEach((t,r)=>{t.deleted||e(t.content.getContent()[t.length-1],r,this)})}[Symbol.iterator](){return this.entries()}delete(e){this.doc!==null?tt(this.doc,t=>{Zf(t,this,e)}):this._prelimContent.delete(e)}set(e,t){return this.doc!==null?tt(this.doc,r=>{m4(r,this,e,t)}):this._prelimContent.set(e,t),t}get(e){return y4(this,e)}has(e){return xk(this,e)}clear(){this.doc!==null?tt(this.doc,e=>{this.forEach(function(t,r,s){Zf(e,s,r)})}):this._prelimContent.clear()}_write(e){e.writeTypeRef(DY)}}const aY=n=>new pl,fi=(n,e)=>n===e||typeof n=="object"&&typeof e=="object"&&n&&e&&tQ(n,e);class mm{constructor(e,t,r,s){this.left=e,this.right=t,this.index=r,this.currentAttributes=s}forward(){switch(this.right===null&&Gr(),this.right.content.constructor){case Nt:this.right.deleted||Pl(this.currentAttributes,this.right.content);break;default:this.right.deleted||(this.index+=this.right.length);break}this.left=this.right,this.right=this.right.right}}const ww=(n,e,t)=>{for(;e.right!==null&&t>0;){switch(e.right.content.constructor){case Nt:e.right.deleted||Pl(e.currentAttributes,e.right.content);break;default:e.right.deleted||(t<e.right.length&&Pi(n,Ne(e.right.id.client,e.right.id.clock+t)),e.index+=e.right.length,t-=e.right.length);break}e.left=e.right,e.right=e.right.right}return e},Vh=(n,e,t,r)=>{const s=new Map,i=r?H1(e,t):null;if(i){const a=new mm(i.p.left,i.p,i.index,s);return ww(n,a,t-i.index)}else{const a=new mm(null,e._start,0,s);return ww(n,a,t)}},Sk=(n,e,t,r)=>{for(;t.right!==null&&(t.right.deleted===!0||t.right.content.constructor===Nt&&fi(r.get(t.right.content.key),t.right.content.value));)t.right.deleted||r.delete(t.right.content.key),t.forward();const s=n.doc,i=s.clientID;r.forEach((a,c)=>{const u=t.left,h=t.right,f=new It(Ne(i,Ut(s.store,i)),u,u&&u.lastId,h,h&&h.id,e,null,new Nt(c,a));f.integrate(n,0),t.right=f,t.forward()})},Pl=(n,e)=>{const{key:t,value:r}=e;r===null?n.delete(t):n.set(t,r)},Ek=(n,e)=>{for(;n.right!==null;){if(!(n.right.deleted||n.right.content.constructor===Nt&&fi(e[n.right.content.key]??null,n.right.content.value)))break;n.forward()}},Ck=(n,e,t,r)=>{const s=n.doc,i=s.clientID,a=new Map;for(const c in r){const u=r[c],h=t.currentAttributes.get(c)??null;if(!fi(h,u)){a.set(c,h);const{left:f,right:p}=t;t.right=new It(Ne(i,Ut(s.store,i)),f,f&&f.lastId,p,p&&p.id,e,null,new Nt(c,u)),t.right.integrate(n,0),t.forward()}}return a},sg=(n,e,t,r,s)=>{t.currentAttributes.forEach((m,w)=>{s[w]===void 0&&(s[w]=null)});const i=n.doc,a=i.clientID;Ek(t,s);const c=Ck(n,e,t,s),u=r.constructor===String?new Yr(r):r instanceof Gt?new Rs(r):new Bo(r);let{left:h,right:f,index:p}=t;e._searchMarker&&ku(e._searchMarker,t.index,u.getLength()),f=new It(Ne(a,Ut(i.store,a)),h,h&&h.lastId,f,f&&f.id,e,null,u),f.integrate(n,0),t.right=f,t.index=p,t.forward(),Sk(n,e,t,c)},vw=(n,e,t,r,s)=>{const i=n.doc,a=i.clientID;Ek(t,s);const c=Ck(n,e,t,s);e:for(;t.right!==null&&(r>0||c.size>0&&(t.right.deleted||t.right.content.constructor===Nt));){if(!t.right.deleted)switch(t.right.content.constructor){case Nt:{const{key:u,value:h}=t.right.content,f=s[u];if(f!==void 0){if(fi(f,h))c.delete(u);else{if(r===0)break e;c.set(u,h)}t.right.delete(n)}else t.currentAttributes.set(u,h);break}default:r<t.right.length&&Pi(n,Ne(t.right.id.client,t.right.id.clock+r)),r-=t.right.length;break}t.forward()}if(r>0){let u="";for(;r>0;r--)u+=`
`;t.right=new It(Ne(a,Ut(i.store,a)),t.left,t.left&&t.left.lastId,t.right,t.right&&t.right.id,e,null,new Yr(u)),t.right.integrate(n,0),t.forward()}Sk(n,e,t,c)},kk=(n,e,t,r,s)=>{let i=e;const a=vr();for(;i&&(!i.countable||i.deleted);){if(!i.deleted&&i.content.constructor===Nt){const h=i.content;a.set(h.key,h)}i=i.right}let c=0,u=!1;for(;e!==i;){if(t===e&&(u=!0),!e.deleted){const h=e.content;switch(h.constructor){case Nt:{const{key:f,value:p}=h,m=r.get(f)??null;(a.get(f)!==h||m===p)&&(e.delete(n),c++,!u&&(s.get(f)??null)===p&&m!==p&&(m===null?s.delete(f):s.set(f,m))),!u&&!e.deleted&&Pl(s,h);break}}}e=e.right}return c},lY=(n,e)=>{for(;e&&e.right&&(e.right.deleted||!e.right.countable);)e=e.right;const t=new Set;for(;e&&(e.deleted||!e.countable);){if(!e.deleted&&e.content.constructor===Nt){const r=e.content.key;t.has(r)?e.delete(n):t.add(r)}e=e.left}},cY=n=>{let e=0;return tt(n.doc,t=>{let r=n._start,s=n._start,i=vr();const a=cm(i);for(;s;){if(s.deleted===!1)switch(s.content.constructor){case Nt:Pl(a,s.content);break;default:e+=kk(t,r,s,i,a),i=cm(a),r=s;break}s=s.right}}),e},uY=n=>{const e=new Set,t=n.doc;for(const[r,s]of n.afterState.entries()){const i=n.beforeState.get(r)||0;s!==i&&lk(n,t.store.clients.get(r),i,s,a=>{!a.deleted&&a.content.constructor===Nt&&a.constructor!==Jn&&e.add(a.parent)})}tt(t,r=>{JC(n,n.deleteSet,s=>{if(s instanceof Jn||!s.parent._hasFormatting||e.has(s.parent))return;const i=s.parent;s.content.constructor===Nt?e.add(i):lY(r,s)});for(const s of e)cY(s)})},bw=(n,e,t)=>{const r=t,s=cm(e.currentAttributes),i=e.right;for(;t>0&&e.right!==null;){if(e.right.deleted===!1)switch(e.right.content.constructor){case Rs:case Bo:case Yr:t<e.right.length&&Pi(n,Ne(e.right.id.client,e.right.id.clock+t)),t-=e.right.length,e.right.delete(n);break}e.forward()}i&&kk(n,i,e.right,s,e.currentAttributes);const a=(e.left||e.right).parent;return a._searchMarker&&ku(a._searchMarker,e.index,-r+t),e};class dY extends z1{constructor(e,t,r){super(e,t),this.childListChanged=!1,this.keysChanged=new Set,r.forEach(s=>{s===null?this.childListChanged=!0:this.keysChanged.add(s)})}get changes(){if(this._changes===null){const e={keys:this.keys,delta:this.delta,added:new Set,deleted:new Set};this._changes=e}return this._changes}get delta(){if(this._delta===null){const e=this.target.doc,t=[];tt(e,r=>{const s=new Map,i=new Map;let a=this.target._start,c=null;const u={};let h="",f=0,p=0;const m=()=>{if(c!==null){let w=null;switch(c){case"delete":p>0&&(w={delete:p}),p=0;break;case"insert":(typeof h=="object"||h.length>0)&&(w={insert:h},s.size>0&&(w.attributes={},s.forEach((x,S)=>{x!==null&&(w.attributes[S]=x)}))),h="";break;case"retain":f>0&&(w={retain:f},JG(u)||(w.attributes=QG({},u))),f=0;break}w&&t.push(w),c=null}};for(;a!==null;){switch(a.content.constructor){case Rs:case Bo:this.adds(a)?this.deletes(a)||(m(),c="insert",h=a.content.getContent()[0],m()):this.deletes(a)?(c!=="delete"&&(m(),c="delete"),p+=1):a.deleted||(c!=="retain"&&(m(),c="retain"),f+=1);break;case Yr:this.adds(a)?this.deletes(a)||(c!=="insert"&&(m(),c="insert"),h+=a.content.str):this.deletes(a)?(c!=="delete"&&(m(),c="delete"),p+=a.length):a.deleted||(c!=="retain"&&(m(),c="retain"),f+=a.length);break;case Nt:{const{key:w,value:x}=a.content;if(this.adds(a)){if(!this.deletes(a)){const S=s.get(w)??null;fi(S,x)?x!==null&&a.delete(r):(c==="retain"&&m(),fi(x,i.get(w)??null)?delete u[w]:u[w]=x)}}else if(this.deletes(a)){i.set(w,x);const S=s.get(w)??null;fi(S,x)||(c==="retain"&&m(),u[w]=S)}else if(!a.deleted){i.set(w,x);const S=u[w];S!==void 0&&(fi(S,x)?S!==null&&a.delete(r):(c==="retain"&&m(),x===null?delete u[w]:u[w]=x))}a.deleted||(c==="insert"&&m(),Pl(s,a.content));break}}a=a.right}for(m();t.length>0;){const w=t[t.length-1];if(w.retain!==void 0&&w.attributes===void 0)t.pop();else break}}),this._delta=t}return this._delta}}class gl extends Gt{constructor(e){super(),this._pending=e!==void 0?[()=>this.insert(0,e)]:[],this._searchMarker=[],this._hasFormatting=!1}get length(){return this.doc??an(),this._length}_integrate(e,t){super._integrate(e,t);try{this._pending.forEach(r=>r())}catch(r){console.error(r)}this._pending=null}_copy(){return new gl}clone(){const e=new gl;return e.applyDelta(this.toDelta()),e}_callObserver(e,t){super._callObserver(e,t);const r=new dY(this,e,t);K1(this,e,r),!e.local&&this._hasFormatting&&(e._needFormattingCleanup=!0)}toString(){this.doc??an();let e="",t=this._start;for(;t!==null;)!t.deleted&&t.countable&&t.content.constructor===Yr&&(e+=t.content.str),t=t.right;return e}toJSON(){return this.toString()}applyDelta(e,{sanitize:t=!0}={}){this.doc!==null?tt(this.doc,r=>{const s=new mm(null,this._start,0,new Map);for(let i=0;i<e.length;i++){const a=e[i];if(a.insert!==void 0){const c=!t&&typeof a.insert=="string"&&i===e.length-1&&s.right===null&&a.insert.slice(-1)===`
`?a.insert.slice(0,-1):a.insert;(typeof c!="string"||c.length>0)&&sg(r,this,s,c,a.attributes||{})}else a.retain!==void 0?vw(r,this,s,a.retain,a.attributes||{}):a.delete!==void 0&&bw(r,s,a.delete)}}):this._pending.push(()=>this.applyDelta(e))}toDelta(e,t,r){this.doc??an();const s=[],i=new Map,a=this.doc;let c="",u=this._start;function h(){if(c.length>0){const p={};let m=!1;i.forEach((x,S)=>{m=!0,p[S]=x});const w={insert:c};m&&(w.attributes=p),s.push(w),c=""}}const f=()=>{for(;u!==null;){if(wa(u,e)||t!==void 0&&wa(u,t))switch(u.content.constructor){case Yr:{const p=i.get("ychange");e!==void 0&&!wa(u,e)?(p===void 0||p.user!==u.id.client||p.type!=="removed")&&(h(),i.set("ychange",r?r("removed",u.id):{type:"removed"})):t!==void 0&&!wa(u,t)?(p===void 0||p.user!==u.id.client||p.type!=="added")&&(h(),i.set("ychange",r?r("added",u.id):{type:"added"})):p!==void 0&&(h(),i.delete("ychange")),c+=u.content.str;break}case Rs:case Bo:{h();const p={insert:u.content.getContent()[0]};if(i.size>0){const m={};p.attributes=m,i.forEach((w,x)=>{m[x]=w})}s.push(p);break}case Nt:wa(u,e)&&(h(),Pl(i,u.content));break}u=u.right}h()};return e||t?tt(a,p=>{e&&pm(p,e),t&&pm(p,t),f()},"cleanup"):f(),s}insert(e,t,r){if(t.length<=0)return;const s=this.doc;s!==null?tt(s,i=>{const a=Vh(i,this,e,!r);r||(r={},a.currentAttributes.forEach((c,u)=>{r[u]=c})),sg(i,this,a,t,r)}):this._pending.push(()=>this.insert(e,t,r))}insertEmbed(e,t,r){const s=this.doc;s!==null?tt(s,i=>{const a=Vh(i,this,e,!r);sg(i,this,a,t,r||{})}):this._pending.push(()=>this.insertEmbed(e,t,r||{}))}delete(e,t){if(t===0)return;const r=this.doc;r!==null?tt(r,s=>{bw(s,Vh(s,this,e,!0),t)}):this._pending.push(()=>this.delete(e,t))}format(e,t,r){if(t===0)return;const s=this.doc;s!==null?tt(s,i=>{const a=Vh(i,this,e,!1);a.right!==null&&vw(i,this,a,t,r)}):this._pending.push(()=>this.format(e,t,r))}removeAttribute(e){this.doc!==null?tt(this.doc,t=>{Zf(t,this,e)}):this._pending.push(()=>this.removeAttribute(e))}setAttribute(e,t){this.doc!==null?tt(this.doc,r=>{m4(r,this,e,t)}):this._pending.push(()=>this.setAttribute(e,t))}getAttribute(e){return y4(this,e)}getAttributes(){return bk(this)}_write(e){e.writeTypeRef(IY)}}const hY=n=>new gl;class ig{constructor(e,t=()=>!0){this._filter=t,this._root=e,this._currentNode=e._start,this._firstCall=!0,e.doc??an()}[Symbol.iterator](){return this}next(){let e=this._currentNode,t=e&&e.content&&e.content.type;if(e!==null&&(!this._firstCall||e.deleted||!this._filter(t)))do if(t=e.content.type,!e.deleted&&(t.constructor===ml||t.constructor===Eo)&&t._start!==null)e=t._start;else for(;e!==null;){const r=e.next;if(r!==null){e=r;break}else e.parent===this._root?e=null:e=e.parent._item}while(e!==null&&(e.deleted||!this._filter(e.content.type)));return this._firstCall=!1,e===null?{value:void 0,done:!0}:(this._currentNode=e,{value:e.content.type,done:!1})}}class Eo extends Gt{constructor(){super(),this._prelimContent=[]}get firstChild(){const e=this._first;return e?e.content.getContent()[0]:null}_integrate(e,t){super._integrate(e,t),this.insert(0,this._prelimContent),this._prelimContent=null}_copy(){return new Eo}clone(){const e=new Eo;return e.insert(0,this.toArray().map(t=>t instanceof Gt?t.clone():t)),e}get length(){return this.doc??an(),this._prelimContent===null?this._length:this._prelimContent.length}createTreeWalker(e){return new ig(this,e)}querySelector(e){e=e.toUpperCase();const r=new ig(this,s=>s.nodeName&&s.nodeName.toUpperCase()===e).next();return r.done?null:r.value}querySelectorAll(e){return e=e.toUpperCase(),xo(new ig(this,t=>t.nodeName&&t.nodeName.toUpperCase()===e))}_callObserver(e,t){K1(this,e,new gY(this,t,e))}toString(){return gk(this,e=>e.toString()).join("")}toJSON(){return this.toString()}toDOM(e=document,t={},r){const s=e.createDocumentFragment();return r!==void 0&&r._createAssociation(s,this),Au(this,i=>{s.insertBefore(i.toDOM(e,t,r),null)}),s}insert(e,t){this.doc!==null?tt(this.doc,r=>{wk(r,this,e,t)}):this._prelimContent.splice(e,0,...t)}insertAfter(e,t){if(this.doc!==null)tt(this.doc,r=>{const s=e&&e instanceof Gt?e._item:e;Jf(r,this,s,t)});else{const r=this._prelimContent,s=e===null?0:r.findIndex(i=>i===e)+1;if(s===0&&e!==null)throw Ai("Reference item not found");r.splice(s,0,...t)}}delete(e,t=1){this.doc!==null?tt(this.doc,r=>{vk(r,this,e,t)}):this._prelimContent.splice(e,t)}toArray(){return pk(this)}push(e){this.insert(this.length,e)}unshift(e){this.insert(0,e)}get(e){return mk(this,e)}slice(e=0,t=this.length){return fk(this,e,t)}forEach(e){Au(this,e)}_write(e){e.writeTypeRef(MY)}}const fY=n=>new Eo;class ml extends Eo{constructor(e="UNDEFINED"){super(),this.nodeName=e,this._prelimAttrs=new Map}get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_integrate(e,t){super._integrate(e,t),this._prelimAttrs.forEach((r,s)=>{this.setAttribute(s,r)}),this._prelimAttrs=null}_copy(){return new ml(this.nodeName)}clone(){const e=new ml(this.nodeName),t=this.getAttributes();return XG(t,(r,s)=>{typeof r=="string"&&e.setAttribute(s,r)}),e.insert(0,this.toArray().map(r=>r instanceof Gt?r.clone():r)),e}toString(){const e=this.getAttributes(),t=[],r=[];for(const c in e)r.push(c);r.sort();const s=r.length;for(let c=0;c<s;c++){const u=r[c];t.push(u+'="'+e[u]+'"')}const i=this.nodeName.toLocaleLowerCase(),a=t.length>0?" "+t.join(" "):"";return`<${i}${a}>${super.toString()}</${i}>`}removeAttribute(e){this.doc!==null?tt(this.doc,t=>{Zf(t,this,e)}):this._prelimAttrs.delete(e)}setAttribute(e,t){this.doc!==null?tt(this.doc,r=>{m4(r,this,e,t)}):this._prelimAttrs.set(e,t)}getAttribute(e){return y4(this,e)}hasAttribute(e){return xk(this,e)}getAttributes(e){return e?rY(this,e):bk(this)}toDOM(e=document,t={},r){const s=e.createElement(this.nodeName),i=this.getAttributes();for(const a in i){const c=i[a];typeof c=="string"&&s.setAttribute(a,c)}return Au(this,a=>{s.appendChild(a.toDOM(e,t,r))}),r!==void 0&&r._createAssociation(s,this),s}_write(e){e.writeTypeRef(NY),e.writeKey(this.nodeName)}}const pY=n=>new ml(n.readKey());class gY extends z1{constructor(e,t,r){super(e,r),this.childListChanged=!1,this.attributesChanged=new Set,t.forEach(s=>{s===null?this.childListChanged=!0:this.attributesChanged.add(s)})}}class e1 extends pl{constructor(e){super(),this.hookName=e}_copy(){return new e1(this.hookName)}clone(){const e=new e1(this.hookName);return this.forEach((t,r)=>{e.set(r,t)}),e}toDOM(e=document,t={},r){const s=t[this.hookName];let i;return s!==void 0?i=s.createDom(this):i=document.createElement(this.hookName),i.setAttribute("data-yjs-hook",this.hookName),r!==void 0&&r._createAssociation(i,this),i}_write(e){e.writeTypeRef(RY),e.writeKey(this.hookName)}}const mY=n=>new e1(n.readKey());class t1 extends gl{get nextSibling(){const e=this._item?this._item.next:null;return e?e.content.type:null}get prevSibling(){const e=this._item?this._item.prev:null;return e?e.content.type:null}_copy(){return new t1}clone(){const e=new t1;return e.applyDelta(this.toDelta()),e}toDOM(e=document,t,r){const s=e.createTextNode(this.toString());return r!==void 0&&r._createAssociation(s,this),s}toString(){return this.toDelta().map(e=>{const t=[];for(const s in e.attributes){const i=[];for(const a in e.attributes[s])i.push({key:a,value:e.attributes[s][a]});i.sort((a,c)=>a.key<c.key?-1:1),t.push({nodeName:s,attrs:i})}t.sort((s,i)=>s.nodeName<i.nodeName?-1:1);let r="";for(let s=0;s<t.length;s++){const i=t[s];r+=`<${i.nodeName}`;for(let a=0;a<i.attrs.length;a++){const c=i.attrs[a];r+=` ${c.key}="${c.value}"`}r+=">"}r+=e.insert;for(let s=t.length-1;s>=0;s--)r+=`</${t[s].nodeName}>`;return r}).join("")}toJSON(){return this.toString()}_write(e){e.writeTypeRef(LY)}}const yY=n=>new t1;class w4{constructor(e,t){this.id=e,this.length=t}get deleted(){throw Hr()}mergeWith(e){return!1}write(e,t,r){throw Hr()}integrate(e,t){throw Hr()}}const wY=0;class Jn extends w4{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){t>0&&(this.id.clock+=t,this.length-=t),ak(e.doc.store,this)}write(e,t){e.writeInfo(wY),e.writeLen(this.length-t)}getMissing(e,t){return null}}class Zu{constructor(e){this.content=e}getLength(){return 1}getContent(){return[this.content]}isCountable(){return!0}copy(){return new Zu(this.content)}splice(e){throw Hr()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeBuf(this.content)}getRef(){return 3}}const vY=n=>new Zu(n.readBuf());class Pu{constructor(e){this.len=e}getLength(){return this.len}getContent(){return[]}isCountable(){return!1}copy(){return new Pu(this.len)}splice(e){const t=new Pu(this.len-e);return this.len=e,t}mergeWith(e){return this.len+=e.len,!0}integrate(e,t){Yf(e.deleteSet,t.id.client,t.id.clock,this.len),t.markDeleted()}delete(e){}gc(e){}write(e,t){e.writeLen(this.len-t)}getRef(){return 1}}const bY=n=>new Pu(n.readLen()),Ak=(n,e)=>new Al({guid:n,...e,shouldLoad:e.shouldLoad||e.autoLoad||!1});class ed{constructor(e){e._item&&console.error("This document was already integrated as a sub-document. You should create a second instance instead with the same guid."),this.doc=e;const t={};this.opts=t,e.gc||(t.gc=!1),e.autoLoad&&(t.autoLoad=!0),e.meta!==null&&(t.meta=e.meta)}getLength(){return 1}getContent(){return[this.doc]}isCountable(){return!0}copy(){return new ed(Ak(this.doc.guid,this.opts))}splice(e){throw Hr()}mergeWith(e){return!1}integrate(e,t){this.doc._item=t,e.subdocsAdded.add(this.doc),this.doc.shouldLoad&&e.subdocsLoaded.add(this.doc)}delete(e){e.subdocsAdded.has(this.doc)?e.subdocsAdded.delete(this.doc):e.subdocsRemoved.add(this.doc)}gc(e){}write(e,t){e.writeString(this.doc.guid),e.writeAny(this.opts)}getRef(){return 9}}const xY=n=>new ed(Ak(n.readString(),n.readAny()));class Bo{constructor(e){this.embed=e}getLength(){return 1}getContent(){return[this.embed]}isCountable(){return!0}copy(){return new Bo(this.embed)}splice(e){throw Hr()}mergeWith(e){return!1}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeJSON(this.embed)}getRef(){return 5}}const SY=n=>new Bo(n.readJSON());class Nt{constructor(e,t){this.key=e,this.value=t}getLength(){return 1}getContent(){return[]}isCountable(){return!1}copy(){return new Nt(this.key,this.value)}splice(e){throw Hr()}mergeWith(e){return!1}integrate(e,t){const r=t.parent;r._searchMarker=null,r._hasFormatting=!0}delete(e){}gc(e){}write(e,t){e.writeKey(this.key),e.writeJSON(this.value)}getRef(){return 6}}const EY=n=>new Nt(n.readKey(),n.readJSON());class n1{constructor(e){this.arr=e}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new n1(this.arr)}splice(e){const t=new n1(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const r=this.arr.length;e.writeLen(r-t);for(let s=t;s<r;s++){const i=this.arr[s];e.writeString(i===void 0?"undefined":JSON.stringify(i))}}getRef(){return 2}}const CY=n=>{const e=n.readLen(),t=[];for(let r=0;r<e;r++){const s=n.readString();s==="undefined"?t.push(void 0):t.push(JSON.parse(s))}return new n1(t)},kY=Qf("node_env")==="development";class Co{constructor(e){this.arr=e,kY&&zC(e)}getLength(){return this.arr.length}getContent(){return this.arr}isCountable(){return!0}copy(){return new Co(this.arr)}splice(e){const t=new Co(this.arr.slice(e));return this.arr=this.arr.slice(0,e),t}mergeWith(e){return this.arr=this.arr.concat(e.arr),!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){const r=this.arr.length;e.writeLen(r-t);for(let s=t;s<r;s++){const i=this.arr[s];e.writeAny(i)}}getRef(){return 8}}const AY=n=>{const e=n.readLen(),t=[];for(let r=0;r<e;r++)t.push(n.readAny());return new Co(t)};class Yr{constructor(e){this.str=e}getLength(){return this.str.length}getContent(){return this.str.split("")}isCountable(){return!0}copy(){return new Yr(this.str)}splice(e){const t=new Yr(this.str.slice(e));this.str=this.str.slice(0,e);const r=this.str.charCodeAt(e-1);return r>=55296&&r<=56319&&(this.str=this.str.slice(0,e-1)+"",t.str=""+t.str.slice(1)),t}mergeWith(e){return this.str+=e.str,!0}integrate(e,t){}delete(e){}gc(e){}write(e,t){e.writeString(t===0?this.str:this.str.slice(t))}getRef(){return 4}}const PY=n=>new Yr(n.readString()),TY=[iY,aY,hY,pY,fY,mY,yY],_Y=0,DY=1,IY=2,NY=3,MY=4,RY=5,LY=6;class Rs{constructor(e){this.type=e}getLength(){return 1}getContent(){return[this.type]}isCountable(){return!0}copy(){return new Rs(this.type._copy())}splice(e){throw Hr()}mergeWith(e){return!1}integrate(e,t){this.type._integrate(e.doc,t)}delete(e){let t=this.type._start;for(;t!==null;)t.deleted?t.id.clock<(e.beforeState.get(t.id.client)||0)&&e._mergeStructs.push(t):t.delete(e),t=t.right;this.type._map.forEach(r=>{r.deleted?r.id.clock<(e.beforeState.get(r.id.client)||0)&&e._mergeStructs.push(r):r.delete(e)}),e.changed.delete(this.type)}gc(e){let t=this.type._start;for(;t!==null;)t.gc(e,!0),t=t.right;this.type._start=null,this.type._map.forEach(r=>{for(;r!==null;)r.gc(e,!0),r=r.left}),this.type._map=new Map}write(e,t){this.type._write(e)}getRef(){return 7}}const OY=n=>new Rs(TY[n.readTypeRef()](n)),r1=(n,e,t)=>{const{client:r,clock:s}=e.id,i=new It(Ne(r,s+t),e,Ne(r,s+t-1),e.right,e.rightOrigin,e.parent,e.parentSub,e.content.splice(t));return e.deleted&&i.markDeleted(),e.keep&&(i.keep=!0),e.redone!==null&&(i.redone=Ne(e.redone.client,e.redone.clock+t)),e.right=i,i.right!==null&&(i.right.left=i),n._mergeStructs.push(i),i.parentSub!==null&&i.right===null&&i.parent._map.set(i.parentSub,i),e.length=t,i};class It extends w4{constructor(e,t,r,s,i,a,c,u){super(e,u.getLength()),this.origin=r,this.left=t,this.right=s,this.rightOrigin=i,this.parent=a,this.parentSub=c,this.redone=null,this.content=u,this.info=this.content.isCountable()?Z9:0}set marker(e){(this.info&J2)>0!==e&&(this.info^=J2)}get marker(){return(this.info&J2)>0}get keep(){return(this.info&J9)>0}set keep(e){this.keep!==e&&(this.info^=J9)}get countable(){return(this.info&Z9)>0}get deleted(){return(this.info&X2)>0}set deleted(e){this.deleted!==e&&(this.info^=X2)}markDeleted(){this.info|=X2}getMissing(e,t){if(this.origin&&this.origin.client!==this.id.client&&this.origin.clock>=Ut(t,this.origin.client))return this.origin.client;if(this.rightOrigin&&this.rightOrigin.client!==this.id.client&&this.rightOrigin.clock>=Ut(t,this.rightOrigin.client))return this.rightOrigin.client;if(this.parent&&this.parent.constructor===Ua&&this.id.client!==this.parent.client&&this.parent.clock>=Ut(t,this.parent.client))return this.parent.client;if(this.origin&&(this.left=pw(e,t,this.origin),this.origin=this.left.lastId),this.rightOrigin&&(this.right=Pi(e,this.rightOrigin),this.rightOrigin=this.right.id),this.left&&this.left.constructor===Jn||this.right&&this.right.constructor===Jn)this.parent=null;else if(!this.parent)this.left&&this.left.constructor===It?(this.parent=this.left.parent,this.parentSub=this.left.parentSub):this.right&&this.right.constructor===It&&(this.parent=this.right.parent,this.parentSub=this.right.parentSub);else if(this.parent.constructor===Ua){const r=rg(t,this.parent);r.constructor===Jn?this.parent=null:this.parent=r.content.type}return null}integrate(e,t){if(t>0&&(this.id.clock+=t,this.left=pw(e,e.doc.store,Ne(this.id.client,this.id.clock-1)),this.origin=this.left.lastId,this.content=this.content.splice(t),this.length-=t),this.parent){if(!this.left&&(!this.right||this.right.left!==null)||this.left&&this.left.right!==this.right){let r=this.left,s;if(r!==null)s=r.right;else if(this.parentSub!==null)for(s=this.parent._map.get(this.parentSub)||null;s!==null&&s.left!==null;)s=s.left;else s=this.parent._start;const i=new Set,a=new Set;for(;s!==null&&s!==this.right;){if(a.add(s),i.add(s),Fh(this.origin,s.origin)){if(s.id.client<this.id.client)r=s,i.clear();else if(Fh(this.rightOrigin,s.rightOrigin))break}else if(s.origin!==null&&a.has(rg(e.doc.store,s.origin)))i.has(rg(e.doc.store,s.origin))||(r=s,i.clear());else break;s=s.right}this.left=r}if(this.left!==null){const r=this.left.right;this.right=r,this.left.right=this}else{let r;if(this.parentSub!==null)for(r=this.parent._map.get(this.parentSub)||null;r!==null&&r.left!==null;)r=r.left;else r=this.parent._start,this.parent._start=this;this.right=r}this.right!==null?this.right.left=this:this.parentSub!==null&&(this.parent._map.set(this.parentSub,this),this.left!==null&&this.left.delete(e)),this.parentSub===null&&this.countable&&!this.deleted&&(this.parent._length+=this.length),ak(e.doc.store,this),this.content.integrate(e,this),mw(e,this.parent,this.parentSub),(this.parent._item!==null&&this.parent._item.deleted||this.parentSub!==null&&this.right!==null)&&this.delete(e)}else new Jn(this.id,this.length).integrate(e,0)}get next(){let e=this.right;for(;e!==null&&e.deleted;)e=e.right;return e}get prev(){let e=this.left;for(;e!==null&&e.deleted;)e=e.left;return e}get lastId(){return this.length===1?this.id:Ne(this.id.client,this.id.clock+this.length-1)}mergeWith(e){if(this.constructor===e.constructor&&Fh(e.origin,this.lastId)&&this.right===e&&Fh(this.rightOrigin,e.rightOrigin)&&this.id.client===e.id.client&&this.id.clock+this.length===e.id.clock&&this.deleted===e.deleted&&this.redone===null&&e.redone===null&&this.content.constructor===e.content.constructor&&this.content.mergeWith(e.content)){const t=this.parent._searchMarker;return t&&t.forEach(r=>{r.p===e&&(r.p=this,!this.deleted&&this.countable&&(r.index-=this.length))}),e.keep&&(this.keep=!0),this.right=e.right,this.right!==null&&(this.right.left=this),this.length+=e.length,!0}return!1}delete(e){if(!this.deleted){const t=this.parent;this.countable&&this.parentSub===null&&(t._length-=this.length),this.markDeleted(),Yf(e.deleteSet,this.id.client,this.id.clock,this.length),mw(e,t,this.parentSub),this.content.delete(e)}}gc(e,t){if(!this.deleted)throw Gr();this.content.gc(e),t?jQ(e,this,new Jn(this.id,this.length)):this.content=new Pu(this.length)}write(e,t){const r=t>0?Ne(this.id.client,this.id.clock+t-1):this.origin,s=this.rightOrigin,i=this.parentSub,a=this.content.getRef()&U1|(r===null?0:Fn)|(s===null?0:Es)|(i===null?0:bu);if(e.writeInfo(a),r!==null&&e.writeLeftID(r),s!==null&&e.writeRightID(s),r===null&&s===null){const c=this.parent;if(c._item!==void 0){const u=c._item;if(u===null){const h=UQ(c);e.writeParentInfo(!0),e.writeString(h)}else e.writeParentInfo(!1),e.writeLeftID(u.id)}else c.constructor===String?(e.writeParentInfo(!0),e.writeString(c)):c.constructor===Ua?(e.writeParentInfo(!1),e.writeLeftID(c)):Gr();i!==null&&e.writeString(i)}this.content.write(e,t)}}const Pk=(n,e)=>BY[e&U1](n),BY=[()=>{Gr()},bY,CY,vY,PY,SY,EY,OY,AY,xY,()=>{Gr()}],FY=10;class Zn extends w4{get deleted(){return!0}delete(){}mergeWith(e){return this.constructor!==e.constructor?!1:(this.length+=e.length,!0)}integrate(e,t){Gr()}write(e,t){e.writeInfo(FY),Re(e.restEncoder,this.length-t)}getMissing(e,t){return null}}const Tk=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:{},_k="__ $YJS$ __";Tk[_k]===!0&&console.error("Yjs was already imported. This breaks constructor checks and will lead to issues! - https://github.com/yjs/yjs/issues/438");Tk[_k]=!0;class Tu{constructor(e,t){this.id=e,this.did=t,this.created=new Date,this.ydoc=new Al,this.profileMap=this.ydoc.getMap("profile"),this.initializeProfile()}initializeProfile(){this.profileMap.has("name")||this.profileMap.set("name",""),this.profileMap.has("age")||this.profileMap.set("age",0),this.profileMap.has("bio")||this.profileMap.set("bio",""),this.profileMap.has("photos")||this.profileMap.set("photos",new Xn),this.profileMap.has("interests")||this.profileMap.set("interests",new Xn),this.profileMap.has("location")||this.profileMap.set("location",null),this.profileMap.has("version")||this.profileMap.set("version",1),this.profileMap.has("lastUpdated")||this.profileMap.set("lastUpdated",new Date().toISOString()),this.profileMap.has("signatures")||this.profileMap.set("signatures",new Xn)}get name(){return this.profileMap.get("name")||""}get age(){return this.profileMap.get("age")||0}get bio(){const e=this.profileMap.get("bio");return typeof e=="string"?e:""}get photos(){const e=this.profileMap.get("photos");return e?e.toArray():[]}get interests(){const e=this.profileMap.get("interests");return e?e.toArray():[]}get location(){return this.profileMap.get("location")||null}get version(){const e=this.profileMap.get("version");return typeof e=="number"?e:1}get lastUpdated(){const e=this.profileMap.get("lastUpdated");if(e&&typeof e=="string"){const t=new Date(e);return isNaN(t.getTime())?this.created:t}return this.created}get signatures(){const e=this.profileMap.get("signatures");return e?e.toArray():[]}setName(e){this.profileMap.set("name",e),this.updateVersion()}setAge(e){this.profileMap.set("age",e),this.updateVersion()}setBio(e){this.profileMap.set("bio",e),this.updateVersion()}addPhoto(e){const t=this.profileMap.get("photos");t&&(t.insert(t.length,[e]),this.updateVersion())}removePhoto(e){const t=this.profileMap.get("photos");if(t){const s=t.toArray().findIndex(i=>i.id===e);s!==-1&&(t.delete(s,1),this.updateVersion())}}addInterest(e){const t=this.profileMap.get("interests");t&&!t.toArray().includes(e)&&(t.insert(t.length,[e]),this.updateVersion())}removeInterest(e){const t=this.profileMap.get("interests");if(t){const s=t.toArray().indexOf(e);s!==-1&&(t.delete(s,1),this.updateVersion())}}setLocation(e){this.profileMap.set("location",e),this.updateVersion()}update(e){if(e.name!==void 0&&this.setName(e.name),e.age!==void 0&&this.setAge(e.age),e.bio!==void 0&&this.setBio(e.bio),e.photos!==void 0){const t=this.profileMap.get("photos");t&&(t.delete(0,t.length),t.insert(0,e.photos))}if(e.interests!==void 0){const t=this.profileMap.get("interests");t&&(t.delete(0,t.length),t.insert(0,e.interests))}e.location!==void 0&&this.setLocation(e.location)}merge(e){const t=uw(e.ydoc);return ng(this.ydoc,t),this}serialize(){return uw(this.ydoc)}static deserialize(e,t,r){const s=new Tu(t,r);try{ng(s.ydoc,e)}catch(i){console.warn("Failed to apply CRDT update:",i)}return s}async signProfile(e,t,r){try{const s=this.getCanonicalData(),a=new TextEncoder().encode(JSON.stringify(s)),c=await crypto.subtle.sign("Ed25519",e,a),u=Array.from(new Uint8Array(c)).map(m=>m.toString(16).padStart(2,"0")).join("");let h="placeholder-public-key-hex";if(r)try{const m=await crypto.subtle.exportKey("raw",r);h=Array.from(new Uint8Array(m)).map(w=>w.toString(16).padStart(2,"0")).join("")}catch{console.warn("Failed to export public key, using placeholder")}const f={timestamp:new Date,signature:u,publicKey:h,did:t};let p=this.profileMap.get("signatures");return p||(p=new Xn,this.profileMap.set("signatures",p)),p.insert(p.length,[f]),this.updateVersion(),f}catch(s){throw console.error("Profile signing failed:",s),new Error(`Profile signing failed: ${s instanceof Error?s.message:"Unknown error"}`)}}async verifySignature(e){try{const t=new Uint8Array(e.publicKey.match(/.{2}/g)?.map(u=>parseInt(u,16))||[]),r=await crypto.subtle.importKey("raw",t,{name:"Ed25519",namedCurve:"Ed25519"},!1,["verify"]),s=this.getCanonicalData(),a=new TextEncoder().encode(JSON.stringify(s)),c=new Uint8Array(e.signature.match(/.{2}/g)?.map(u=>parseInt(u,16))||[]);return await crypto.subtle.verify("Ed25519",r,c,a)}catch(t){return console.error("Profile signature verification failed:",t),!1}}async verifyAllSignatures(){const e=this.signatures,t=[];for(const i of e){const a=await this.verifySignature(i);t.push(a)}const r=t.filter(i=>i).length,s=t.length-r;return{valid:r,invalid:s,results:t}}addSignature(e){let t=this.profileMap.get("signatures");t||(t=new Xn,this.profileMap.set("signatures",t)),t.insert(t.length,[e]),this.updateVersion()}getLatestSignature(){const e=this.signatures;return e.length===0?null:e.sort((r,s)=>new Date(s.timestamp).getTime()-new Date(r.timestamp).getTime())[0]}getCanonicalData(){const e={id:this.id,did:this.did,name:this.name,age:this.age,bio:this.bio,photos:this.photos,interests:this.interests,location:this.location,version:this.version,lastUpdated:this.lastUpdated.toISOString()};return this.sortObjectKeys(e)}sortObjectKeys(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(r=>this.sortObjectKeys(r));const t={};return Object.keys(e).sort().forEach(r=>{t[r]=this.sortObjectKeys(e[r])}),t}async sign(e){const t=this.getCanonicalData(),s=new TextEncoder().encode(JSON.stringify(t)),i=await crypto.subtle.sign("Ed25519",e,s);return Array.from(new Uint8Array(i)).map(a=>a.toString(16).padStart(2,"0")).join("")}async verify(e,t){try{const r=this.getCanonicalData(),i=new TextEncoder().encode(JSON.stringify(r)),a=new Uint8Array(t.match(/.{2}/g).map(c=>parseInt(c,16)));return await crypto.subtle.verify("Ed25519",e,a,i)}catch(r){return console.error("Profile verification failed:",r),!1}}getTrustScore(){const e=this.signatures;if(e.length===0)return 0;const t=Math.min(e.length*20,100),r=(Date.now()-this.created.getTime())/(1e3*60*60),s=Math.max(Math.min(r/24,1),.1);return Math.round(t*s)}isSpamLikely(){const e=this.bio||"",r=[this.signatures.length===0,this.name.length<2,e.includes("http://")||e.includes("https://"),this.interests.length===0,this.age<18||this.age>80,this.photos.length===0].filter(i=>i).length;return this.name.length>=2&&this.age>=18&&this.age<=80&&this.interests.length>0&&this.photos.length>0?r>=4:r>=3}getVerificationStatus(){const e=this.signatures,t=e.length,r=e.length>0?new Date(Math.max(...e.map(i=>new Date(i.timestamp).getTime()))):null;let s="none";return t>=5?s="high":t>=3?s="medium":t>=1&&(s="low"),{isVerified:t>0,signatureCount:t,latestSignature:r,trustLevel:s}}recordInteraction(e,t){let r=this.profileMap.get("interactions");r||(r=new Xn,this.profileMap.set("interactions",r));const s={type:e,from:t,timestamp:new Date().toISOString(),id:crypto.randomUUID()};r.insert(r.length,[s]),this.updateVersion()}getInteractions(){const e=this.profileMap.get("interactions");return e?e.toArray().map(t=>({...t,timestamp:new Date(t.timestamp)})):[]}getInteractionStats(){const e=this.getInteractions(),t=new Set(e.map(r=>r.from)).size;return{totalInteractions:e.length,likes:e.filter(r=>r.type==="like").length,matches:e.filter(r=>r.type==="match").length,messages:e.filter(r=>r.type==="message").length,reports:e.filter(r=>r.type==="report").length,uniqueUsers:t}}updateVersion(){const e=this.profileMap.get("version")||1;this.profileMap.set("version",e+1),this.profileMap.set("lastUpdated",new Date().toISOString())}toJSON(){return{id:this.id,did:this.did,created:this.created.toISOString(),name:this.name,age:this.age,bio:this.bio,photos:this.photos,interests:this.interests,location:this.location,version:this.version,lastUpdated:this.lastUpdated.toISOString(),signatures:this.signatures}}clone(){const e=new Tu(this.id,this.did);try{const t=this.serialize();ng(e.ydoc,t)}catch(t){console.warn("Failed to clone CRDT:",t),e.update({name:this.name,age:this.age,bio:this.bio,photos:this.photos,interests:this.interests,location:this.location||void 0})}return e}onChange(e){const t=()=>e();return this.ydoc.on("update",t),()=>{this.ydoc.off("update",t)}}isValid(){return this.id.length>0&&this.did.startsWith("did:")&&this.name.length>0&&this.age>=18&&this.age<=100}getValidationErrors(){const e=[];return this.id.length===0&&e.push("ID is required"),this.did.startsWith("did:")||e.push("Invalid DID format"),this.name.length===0&&e.push("Name is required"),this.age<18&&e.push("Age must be at least 18"),this.age>100&&e.push("Age must be less than 100"),e}}const dt=class dt{static encode(e,t,r=5){if(e<-90||e>90)throw new Error("Latitude must be between -90 and 90");if(t<-180||t>180)throw new Error("Longitude must be between -180 and 180");if(r<1||r>12)throw new Error("Precision must be between 1 and 12");let s=-90,i=90,a=-180,c=180,u="",h=0,f=0,p=!0;for(;u.length<r;){if(p){const m=(a+c)/2;t>=m?(h=h<<1|1,a=m):(h=h<<1,c=m)}else{const m=(s+i)/2;e>=m?(h=h<<1|1,s=m):(h=h<<1,i=m)}p=!p,f++,f===5&&(u+=dt.BASE32[h],h=0,f=0)}return u}static decode(e){if(!e||e.length===0)throw new Error("Geohash cannot be empty");let t=-90,r=90,s=-180,i=180,a=!0;for(const c of e.toLowerCase()){if(!(c in dt.BASE32_MAP))throw new Error(`Invalid geohash character: ${c}`);const u=dt.BASE32_MAP[c];for(let h=4;h>=0;h--){const f=u>>h&1;if(a){const p=(s+i)/2;f===1?s=p:i=p}else{const p=(t+r)/2;f===1?t=p:r=p}a=!a}}return{latitude:{min:t,max:r},longitude:{min:s,max:i},center:{latitude:(t+r)/2,longitude:(s+i)/2}}}static distance(e,t){const r=dt.decode(e),s=dt.decode(t);return dt.haversineDistance(r.center.latitude,r.center.longitude,s.center.latitude,s.center.longitude)}static getNeighbors(e){const t=[],r=dt.decode(e),s=e.length,i=r.latitude.max-r.latitude.min,a=r.longitude.max-r.longitude.min,c=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[u,h]of c){const f=r.center.latitude+u*i,p=r.center.longitude+h*a;if(f>=-90&&f<=90&&p>=-180&&p<=180){const m=dt.encode(f,p,s);m!==e&&t.push(m)}}return t}static createPrivateLocation(e,t,r=5){return{geohash:dt.encode(e,t,r),timestamp:new Date}}static generateLocationTopics(e,t=!0){const r=[];r.push(`geo:${e.geohash}`);for(let s=Math.max(1,e.geohash.length-2);s<e.geohash.length;s++){const i=e.geohash.substring(0,s);r.push(`geo:${i}`)}if(t){const s=dt.getNeighbors(e.geohash);for(const i of s)r.push(`geo:${i}`)}return r}static isWithinDistance(e,t,r){return dt.distance(e.geohash,t.geohash)<=r}static getCommonPrefixLength(e,t){let r=0;const s=Math.min(e.length,t.length);for(let i=0;i<s&&e[i]===t[i];i++)r++;return r}static getPrivacyRadius(e){return{1:2500,2:630,3:78,4:20,5:2.4,6:.61,7:.076,8:.019,9:.0024,10:6e-4,11:74e-6,12:19e-6}[e]||2.4}static isValidGeohash(e){if(!e||e.length===0||e.length>12)return!1;for(const t of e.toLowerCase())if(!(t in dt.BASE32_MAP))return!1;return!0}static haversineDistance(e,t,r,s){const a=dt.toRadians(r-e),c=dt.toRadians(s-t),u=Math.sin(a/2)*Math.sin(a/2)+Math.cos(dt.toRadians(e))*Math.cos(dt.toRadians(r))*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)))}static toRadians(e){return e*(Math.PI/180)}};dt.BASE32="0123456789bcdefghjkmnpqrstuvwxyz",dt.BASE32_MAP={},(()=>{for(let e=0;e<dt.BASE32.length;e++)dt.BASE32_MAP[dt.BASE32[e]]=e})();let Ur=dt;class UY{constructor(e,t={}){if(this.announcedTopics=new Set,this.topicSubscriptions=new Map,this.announceInterval=null,this.peerCache=new Map,this.libp2p=e,this.dht=e.services.dht,this.config={announceInterval:6e4,queryTimeout:1e4,maxPeersPerTopic:20,topicTTL:3e5,...t},!this.dht)throw new Error("DHT service not available in libp2p instance");this.setupPeriodicAnnouncement()}async join(e){console.log("Joining DHT topics:",e);for(const t of e)try{this.announcedTopics.add(t),await this.announcePresence([t]),console.log("Successfully joined topic:",t)}catch(r){console.error("Failed to join topic:",t,r)}}async leave(e){console.log("Leaving DHT topics:",e);for(const t of e){this.announcedTopics.delete(t),this.topicSubscriptions.delete(t);for(const[r,s]of this.peerCache.entries())this.isPeerInTopic(s,t)&&this.peerCache.delete(r);console.log("Left topic:",t)}}async findPeers(e){console.log("Finding peers for topic:",e);try{const t=[],r=this.getCachedPeers(e);return r.length>0?(console.log(`Found ${r.length} cached peers for topic: ${e}`),r.slice(0,this.config.maxPeersPerTopic)):(console.log(`No peers found for topic: ${e}`),t)}catch(t){return console.error("Failed to find peers for topic:",e,t),[]}}async announcePresence(e){console.log("Announcing presence in topics:",e);for(const t of e)try{console.log("Announced presence in topic:",t)}catch(r){console.error("Failed to announce presence in topic:",t,r)}}subscribeToTopic(e,t){console.log("Subscribing to topic:",e),this.topicSubscriptions.has(e)||this.topicSubscriptions.set(e,new Set),this.topicSubscriptions.get(e).add(t);for(const r of this.peerCache.values())if(this.isPeerInTopic(r,e))try{t(r)}catch(s){console.error("Topic subscription callback failed:",s)}}unsubscribeFromTopic(e,t){const r=this.topicSubscriptions.get(e);r&&(r.delete(t),r.size===0&&this.topicSubscriptions.delete(e))}generateTopics(e){const t=[],r=Math.floor(e.ageRange[0]/10)*10,s=`age:${r}-${r+10}`;t.push(s);const i=e.interests.slice(0,3);for(const c of i){const u=`interest:${c.toLowerCase()}`;t.push(u)}if(e.geohash&&Ur.isValidGeohash(e.geohash)){const c={geohash:e.geohash,timestamp:new Date};t.push(`geo:${e.geohash}`);const h=Ur.generateLocationTopics(c,!1).slice(0,3);t.push(...h.filter(p=>!t.includes(p)));const f=`combined:${e.geohash}:${r}:${i.join(",")}`;t.push(f)}const a=Array.from(new Set(t)).slice(0,10);return console.log("Generated topics for criteria:",a),a}getCachedPeers(e){const t=[];for(const r of this.peerCache.values())this.isPeerInTopic(r,e)&&!this.isOwnPeer(r.id)&&t.push(r);return t}clearCache(){this.peerCache.clear(),console.log("DHT peer cache cleared")}createPrivateLocation(e,t,r=5){return Ur.createPrivateLocation(e,t,r)}isPeerInRange(e,t,r){return Ur.isWithinDistance(e,t,r)}getLocationPrivacyRadius(e){return Ur.getPrivacyRadius(e.length)}getStats(){return{announcedTopics:this.announcedTopics.size,cachedPeers:this.peerCache.size,activeSubscriptions:this.topicSubscriptions.size}}destroy(){this.announceInterval&&(clearInterval(this.announceInterval),this.announceInterval=null),this.announcedTopics.clear(),this.topicSubscriptions.clear(),this.peerCache.clear(),console.log("DHT Discovery destroyed")}setupPeriodicAnnouncement(){this.announceInterval=setInterval(async()=>{if(this.announcedTopics.size>0)try{await this.announcePresence(Array.from(this.announcedTopics))}catch(e){console.error("Periodic announcement failed:",e)}},this.config.announceInterval)}getTopicKey(e){return new TextEncoder().encode(`/tinder/discovery/${e}`)}async convertToPeerInfo(e,t){try{const r=e.toString(),s=this.peerCache.get(r);if(s&&this.isPeerFresh(s))return s;const a=await this.libp2p.peerStore.get(e),c=a.addresses.map(p=>p.multiaddr.toString()),u=Array.from(a.protocols),h=this.extractMetadataFromTopic(t);return{id:r,multiaddrs:c,protocols:u,metadata:{...h,lastSeen:new Date}}}catch(r){return console.warn("Failed to convert peer ID to peer info:",r),null}}extractMetadataFromTopic(e){const t=e.split(":");let r="",s=[18,99],i=[];if(t[0]==="geo"&&t[1])r=t[1];else if(t[0]==="age"&&t[1]){const c=t[1].match(/(\d+)-(\d+)/);c&&(s=[parseInt(c[1]),parseInt(c[2])])}else if(t[0]==="interest"&&t[1])i=[t[1]];else if(t[0]==="combined"){if(t[1]&&(r=t[1]),t[2]){const a=parseInt(t[2]);s=[a,a+10]}t[3]&&(i=t[3].split(",").filter(a=>a.length>0))}return{geohash:r,ageRange:s,interests:i}}isPeerInTopic(e,t){const r=this.extractMetadataFromTopic(t);if(t.startsWith("geo:"))return e.metadata.geohash===r.geohash;if(t.startsWith("age:")){const s=(e.metadata.ageRange[0]+e.metadata.ageRange[1])/2;return s>=r.ageRange[0]&&s<=r.ageRange[1]}else{if(t.startsWith("interest:"))return e.metadata.interests.some(s=>r.interests.includes(s.toLowerCase()));if(t.startsWith("combined:"))return e.metadata.geohash===r.geohash&&e.metadata.interests.some(s=>r.interests.includes(s.toLowerCase()))}return!1}isPeerFresh(e){const t=Date.now(),r=e.metadata.lastSeen.getTime();return t-r<this.config.topicTTL}isOwnPeer(e){return e===this.libp2p.peerId.toString()}notifyTopicSubscribers(e,t){const r=this.topicSubscriptions.get(e);r&&r.forEach(s=>{try{s(t)}catch(i){console.error("Topic subscriber callback failed:",i)}})}}class VY{constructor(e,t={}){this.profileCache=new Map,this.syncSubscribers=new Set,this.syncInterval=null,this.p2pManager=e,this.options={maxCacheSize:1e3,syncInterval:3e4,maxRetries:3,batchSize:10,...t},this.p2pManager.subscribeToProfiles(this.handleProfileUpdate.bind(this))}startSync(){this.syncInterval||(this.syncInterval=setInterval(async()=>{try{await this.performPeriodicSync()}catch(e){console.error("Periodic profile sync failed:",e)}},this.options.syncInterval),console.log("Profile sync manager started with interval:",this.options.syncInterval))}stopSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null,console.log("Profile sync manager stopped"))}async syncProfiles(e){try{console.log("Starting manual profile sync with criteria:",e);const t=await this.p2pManager.syncProfilesWithCriteria(e);for(const r of t)this.updateProfileCache(r,"sync");return this.notifySubscribers(t),console.log("Manual profile sync completed, synced",t.length,"profiles"),t}catch(t){return console.error("Manual profile sync failed:",t),[]}}async requestProfile(e,t){try{const r=this.profileCache.get(t);if(r&&this.isProfileFresh(r))return console.log("Returning cached profile:",t),r.profile;console.log("Requesting profile from peer:",e,"profile:",t);const s=await this.p2pManager.requestProfile(e,t);return s&&(this.updateProfileCache(s,e),this.notifySubscribers([s])),s}catch(r){return console.error("Profile request failed:",r),null}}async broadcastProfile(e){try{await this.p2pManager.broadcastProfile(e),this.updateProfileCache(e,"local"),this.notifySubscribers([e]),console.log("Profile broadcasted:",e.id)}catch(t){throw console.error("Profile broadcast failed:",t),t}}getCachedProfiles(e){const t=[];for(const r of this.profileCache.values())this.matchesCriteria(r.profile,e)&&t.push(r.profile);return t.sort((r,s)=>{const i=this.profileCache.get(r.id);return this.profileCache.get(s.id).lastSeen.getTime()-i.lastSeen.getTime()})}onProfileSync(e){return this.syncSubscribers.add(e),()=>{this.syncSubscribers.delete(e)}}getSyncStats(){const e=Array.from(this.profileCache.values()).reduce((r,s)=>r+s.syncCount,0),t=Array.from(this.profileCache.values()).reduce((r,s)=>!r||s.lastSeen>r?s.lastSeen:r,null);return{cachedProfiles:this.profileCache.size,totalSyncs:e,lastSyncTime:t,cacheHitRate:0}}clearCache(){this.profileCache.clear(),console.log("Profile cache cleared")}removeFromCache(e){const t=this.profileCache.delete(e);return t&&console.log("Profile removed from cache:",e),t}handleProfileUpdate(e){this.updateProfileCache(e,"network"),this.notifySubscribers([e])}updateProfileCache(e,t){const r=this.profileCache.get(e.id),s=r?r.syncCount+1:1;if(!r||e.version>r.profile.version){this.profileCache.size>=this.options.maxCacheSize&&!r&&this.evictOldestProfile();const i={profile:e,lastSeen:new Date,syncCount:s,source:t};this.profileCache.set(e.id,i),console.log("Profile cache updated:",e.id,"version:",e.version,"source:",t)}else r&&(r.syncCount=s,r.lastSeen=new Date,console.log("Profile sync count updated:",e.id,"syncCount:",s))}evictOldestProfile(){let e=null;for(const t of this.profileCache.entries())(!e||t[1].lastSeen<e[1].lastSeen)&&(e=t);e&&(this.profileCache.delete(e[0]),console.log("Evicted oldest profile from cache:",e[0]))}isProfileFresh(e){return Date.now()-e.lastSeen.getTime()<3e5}matchesCriteria(e,t){if(!t)return!0;if(t.ageRange){const[r,s]=t.ageRange;if(e.age<r||e.age>s)return!1}if(t.interests&&t.interests.length>0){const r=e.interests;if(!t.interests.some(i=>r.includes(i)))return!1}if(t.geohash&&e.location){const r={geohash:t.geohash,timestamp:new Date},s=t.maxDistance||50;if(!Ur.isWithinDistance(e.location,r,s))return!1}return!0}createPrivateLocation(e,t,r=5){return Ur.createPrivateLocation(e,t,r)}getLocationPrivacyRadius(e){return Ur.getPrivacyRadius(e.length)}notifySubscribers(e){this.syncSubscribers.forEach(t=>{try{t(e)}catch(r){console.error("Profile sync subscriber callback failed:",r)}})}async performPeriodicSync(){if(this.p2pManager.isConnected())try{const e=this.p2pManager.getConnectedPeers();if(e.length===0)return;console.log("Performing periodic profile sync with",e.length,"peers");const r=e.slice(0,this.options.batchSize).map(async a=>{try{return await this.requestProfile(a,a)}catch(c){return console.warn("Failed to sync profile from peer:",a,c),null}}),i=(await Promise.allSettled(r)).filter(a=>a.status==="fulfilled"&&a.value!==null).map(a=>a.value);i.length>0&&(console.log("Periodic sync completed, synced",i.length,"profiles"),this.notifySubscribers(i))}catch(e){console.error("Periodic sync failed:",e)}}destroy(){this.stopSync(),this.syncSubscribers.clear(),this.profileCache.clear(),console.log("Profile sync manager destroyed")}}let jY=class{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),this}emit(e,...t){const r=this.listeners.get(e);return r?(r.forEach(s=>{try{s(...t)}catch(i){console.error("Event listener error:",i)}}),!0):!1}removeAllListeners(e){return e?this.listeners.delete(e):this.listeners.clear(),this}listenerCount(e){return this.listeners.get(e)?.length||0}};class $Y extends jY{constructor(e={}){super(),this.peerHealth=new Map,this.reconnectAttempts=new Map,this.reconnectTimers=new Map,this.healthCheckTimer=null,this.networkPartition=null,this.isRecovering=!1,this.config={healthCheckInterval:3e4,healthCheckTimeout:5e3,maxConsecutiveFailures:3,maxReconnectAttempts:5,initialReconnectDelay:1e3,maxReconnectDelay:6e4,backoffMultiplier:2,enablePeerReplacement:!0,minHealthyPeers:3,maxUnhealthyPeers:2,partitionDetectionThreshold:.7,partitionRecoveryTimeout:3e5,bootstrapNodes:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa"],enableBootstrapFallback:!0,...e}}initialize(e,t,r){this.p2pManager=e,this.webrtcManager=t,this.dhtDiscovery=r,this.setupEventListeners(),this.startHealthMonitoring(),console.log("Connection Recovery Manager initialized")}startHealthMonitoring(){this.healthCheckTimer&&clearInterval(this.healthCheckTimer),this.healthCheckTimer=setInterval(async()=>{await this.performHealthCheck()},this.config.healthCheckInterval),console.log("Health monitoring started with interval:",this.config.healthCheckInterval)}async performHealthCheck(){if(!(!this.p2pManager||this.isRecovering))try{const t=this.p2pManager.getConnectedPeers().map(r=>this.checkPeerHealth(r));await Promise.allSettled(t),await this.analyzeNetworkHealth(),await this.triggerRecoveryIfNeeded()}catch(e){console.error("Health check failed:",e),this.emit("healthCheckError",e)}}async checkPeerHealth(e){const t=Date.now();let r=this.peerHealth.get(e)||this.createInitialHealth(e);try{const s=await this.pingPeer(e),i=Date.now()-t;s.success?(r.lastSeen=new Date,r.latency=i,r.packetLoss=Math.max(0,r.packetLoss-.1),r.consecutiveFailures=0,r.isHealthy=!0,r.connectionQuality=this.calculateConnectionQuality(r),this.emit("peerHealthy",e,r)):(r.consecutiveFailures++,r.packetLoss=Math.min(1,r.packetLoss+.2),r.isHealthy=r.consecutiveFailures<this.config.maxConsecutiveFailures,r.connectionQuality=this.calculateConnectionQuality(r),this.emit("peerUnhealthy",e,r),r.isHealthy||await this.recoverPeerConnection(e))}catch(s){console.error("Peer health check failed:",e,s),r.consecutiveFailures++,r.isHealthy=!1,r.connectionQuality="critical",this.emit("peerHealthCheckFailed",e,s)}this.peerHealth.set(e,r)}async pingPeer(e){const t=Date.now();try{if(this.webrtcManager&&this.webrtcManager.hasConnection(e)){const r=this.webrtcManager.getDataChannel(e,"ping");if(r&&r.readyState==="open"){const s=crypto.randomUUID(),i=JSON.stringify({type:"ping",id:s,timestamp:t});return new Promise(a=>{const c=setTimeout(()=>{a({success:!1})},this.config.healthCheckTimeout),u=h=>{try{const f=JSON.parse(h.data);f.type==="pong"&&f.id===s&&(clearTimeout(c),r.removeEventListener("message",u),a({success:!0,latency:Date.now()-t}))}catch{}};r.addEventListener("message",u),r.send(i)})}}if(this.p2pManager&&this.p2pManager.libp2p){const s=this.p2pManager.libp2p.getConnections().find(i=>i.remotePeer.toString()===e);if(s&&s.status==="open")return{success:!0,latency:Date.now()-t}}return{success:!1}}catch(r){return console.error("Ping failed for peer:",e,r),{success:!1}}}calculateConnectionQuality(e){return e.consecutiveFailures>0?"critical":e.packetLoss>.3||e.latency>2e3?"poor":e.packetLoss>.1||e.latency>1e3?"good":"excellent"}createInitialHealth(e){return{peerId:e,lastSeen:new Date,latency:0,packetLoss:0,connectionQuality:"good",consecutiveFailures:0,isHealthy:!0}}async analyzeNetworkHealth(){const e=Array.from(this.peerHealth.values()),t=e.filter(i=>i.isHealthy),r=e.filter(i=>!i.isHealthy),s=e.length>0?t.length/e.length:1;s<1-this.config.partitionDetectionThreshold&&e.length>2?this.networkPartition||(this.networkPartition={detected:!0,partitionSize:t.length,isolatedPeers:r.map(i=>i.peerId),detectedAt:new Date},console.warn("Network partition detected:",this.networkPartition),this.emit("networkPartitionDetected",this.networkPartition),await this.recoverFromNetworkPartition()):this.networkPartition&&s>.8&&(this.networkPartition.recoveredAt=new Date,console.log("Network partition recovered:",this.networkPartition),this.emit("networkPartitionRecovered",this.networkPartition),this.networkPartition=null),this.emit("networkHealthUpdate",{totalPeers:e.length,healthyPeers:t.length,unhealthyPeers:r.length,healthyRatio:s,partition:this.networkPartition})}async triggerRecoveryIfNeeded(){const e=Array.from(this.peerHealth.values()).filter(r=>r.isHealthy),t=Array.from(this.peerHealth.values()).filter(r=>!r.isHealthy);e.length<this.config.minHealthyPeers&&(console.log("Insufficient healthy peers, triggering peer discovery"),await this.discoverAndConnectNewPeers()),t.length>this.config.maxUnhealthyPeers&&this.config.enablePeerReplacement&&(console.log("Too many unhealthy peers, triggering peer replacement"),await this.replaceUnhealthyPeers(t.slice(0,this.config.maxUnhealthyPeers)))}async recoverPeerConnection(e){const t=this.reconnectAttempts.get(e)||0;if(t>=this.config.maxReconnectAttempts)return console.log("Max reconnect attempts reached for peer:",e),this.emit("peerRecoveryFailed",e,"max_attempts_reached"),!1;const r=this.reconnectTimers.get(e);r&&clearTimeout(r);const s=Math.min(this.config.initialReconnectDelay*Math.pow(this.config.backoffMultiplier,t),this.config.maxReconnectDelay);console.log(`Scheduling reconnection attempt ${t+1} for peer ${e} in ${s}ms`);const i=setTimeout(async()=>{try{this.reconnectAttempts.set(e,t+1),console.log(`Attempting to reconnect to peer: ${e} (attempt ${t+1})`),this.webrtcManager&&await this.webrtcManager.closeConnection(e),await new Promise(a=>setTimeout(a,1e3)),this.p2pManager&&await this.p2pManager.connectToPeer(e),this.reconnectAttempts.delete(e),this.reconnectTimers.delete(e),console.log("Successfully reconnected to peer:",e),this.emit("peerRecovered",e)}catch(a){console.error("Reconnection attempt failed for peer:",e,a),this.emit("peerRecoveryAttemptFailed",e,a),await this.recoverPeerConnection(e)}},s);return this.reconnectTimers.set(e,i),!0}async discoverAndConnectNewPeers(){try{if(!this.dhtDiscovery){console.warn("DHT Discovery not available for peer discovery");return}const e={geohash:"12345",ageRange:[18,99],interests:[],maxDistance:5e4},t=await this.dhtDiscovery.findPeers("general");console.log("Discovered",t.length,"new peers for connection");const r=t.filter(s=>!this.peerHealth.has(s.id)).slice(0,this.config.minHealthyPeers).map(async s=>{try{this.p2pManager&&(await this.p2pManager.connectToPeer(s.id),console.log("Connected to new peer:",s.id))}catch(i){console.warn("Failed to connect to discovered peer:",s.id,i)}});await Promise.allSettled(r)}catch(e){console.error("Peer discovery failed:",e),this.emit("peerDiscoveryFailed",e)}}async replaceUnhealthyPeers(e){console.log("Replacing",e.length,"unhealthy peers");const t=e.map(async r=>{try{this.webrtcManager&&await this.webrtcManager.closeConnection(r.peerId),this.peerHealth.delete(r.peerId),this.reconnectAttempts.delete(r.peerId);const s=this.reconnectTimers.get(r.peerId);s&&(clearTimeout(s),this.reconnectTimers.delete(r.peerId)),console.log("Disconnected unhealthy peer:",r.peerId)}catch(s){console.warn("Failed to disconnect unhealthy peer:",r.peerId,s)}});await Promise.allSettled(t),await this.discoverAndConnectNewPeers()}async recoverFromNetworkPartition(){if(!this.isRecovering){this.isRecovering=!0,console.log("Starting network partition recovery");try{if(this.config.enableBootstrapFallback&&await this.connectToBootstrapNodes(),await this.discoverAndConnectNewPeers(),this.dhtDiscovery)try{await this.dhtDiscovery.join(["general","recovery"]),console.log("Rejoined DHT network for partition recovery")}catch(e){console.warn("Failed to rejoin DHT network:",e)}setTimeout(()=>{this.networkPartition&&!this.networkPartition.recoveredAt&&(console.warn("Network partition recovery timeout reached"),this.emit("networkPartitionRecoveryTimeout",this.networkPartition)),this.isRecovering=!1},this.config.partitionRecoveryTimeout)}catch(e){console.error("Network partition recovery failed:",e),this.emit("networkPartitionRecoveryFailed",e),this.isRecovering=!1}}}async connectToBootstrapNodes(){console.log("Connecting to bootstrap nodes for recovery");const e=this.config.bootstrapNodes.map(async t=>{try{const r=t.split("/").pop();r&&this.p2pManager&&(await this.p2pManager.connectToPeer(r),console.log("Connected to bootstrap node:",r))}catch(r){console.warn("Failed to connect to bootstrap node:",t,r)}});await Promise.allSettled(e)}setupEventListeners(){this.webrtcManager&&this.webrtcManager.onConnectionStateChange((e,t)=>{t==="failed"||t==="disconnected"||t==="closed"?(console.log("WebRTC connection lost for peer:",e,t),this.handlePeerDisconnection(e)):t==="connected"&&(console.log("WebRTC connection established for peer:",e),this.handlePeerConnection(e))})}handlePeerConnection(e){const t=this.peerHealth.get(e)||this.createInitialHealth(e);t.isHealthy=!0,t.consecutiveFailures=0,t.lastSeen=new Date,this.peerHealth.set(e,t),this.reconnectAttempts.delete(e);const r=this.reconnectTimers.get(e);r&&(clearTimeout(r),this.reconnectTimers.delete(e)),this.emit("peerConnected",e)}handlePeerDisconnection(e){const t=this.peerHealth.get(e);t&&(t.isHealthy=!1,t.consecutiveFailures++,this.peerHealth.set(e,t)),this.emit("peerDisconnected",e),this.recoverPeerConnection(e)}getNetworkHealth(){const e=Array.from(this.peerHealth.values()),t=e.filter(s=>s.isHealthy),r=e.filter(s=>!s.isHealthy);return{totalPeers:e.length,healthyPeers:t.length,unhealthyPeers:r.length,healthyRatio:e.length>0?t.length/e.length:1,partition:this.networkPartition,peerHealth:e}}getPeerHealth(e){return this.peerHealth.get(e)||null}async forcePeerRecovery(e){console.log("Forcing recovery for peer:",e),this.reconnectAttempts.delete(e);const t=this.reconnectTimers.get(e);return t&&(clearTimeout(t),this.reconnectTimers.delete(e)),await this.recoverPeerConnection(e)}async forceNetworkRecovery(){console.log("Forcing network recovery"),this.isRecovering=!1,await this.recoverFromNetworkPartition()}destroy(){console.log("Destroying Connection Recovery Manager"),this.healthCheckTimer&&(clearInterval(this.healthCheckTimer),this.healthCheckTimer=null),this.reconnectTimers.forEach(e=>clearTimeout(e)),this.reconnectTimers.clear(),this.peerHealth.clear(),this.reconnectAttempts.clear(),this.networkPartition=null,this.isRecovering=!1,this.removeAllListeners(),console.log("Connection Recovery Manager destroyed")}}class zY{constructor(e={}){this.libp2p=null,this.dhtDiscovery=null,this.peerHistory=new Map,this.bootstrapNodes=new Map,this.fallbackInterval=null,this.isInitialized=!1,this.config={bootstrapNodes:[{id:"QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN",multiaddr:"/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN",protocols:["kad-dht"],region:"global",reliability:.95,lastSeen:new Date,responseTime:100},{id:"QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa",multiaddr:"/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa",protocols:["kad-dht"],region:"global",reliability:.93,lastSeen:new Date,responseTime:120}],maxBootstrapAttempts:5,bootstrapTimeout:1e4,bootstrapRetryDelay:2e3,enableDNSBootstrap:!0,dnsBootstrapDomains:["bootstrap.libp2p.io","bootstrap.ipfs.io"],enableWebSocketBootstrap:!0,webSocketBootstrapUrls:["wss://ws-star.discovery.libp2p.io","wss://ws-star1.par.dwebops.pub"],maxRecommendations:10,recommendationDecayFactor:.95,minInteractionsForRecommendation:3,geographicWeightFactor:.3,interestWeightFactor:.4,fallbackDiscoveryInterval:6e4,maxFallbackAttempts:3,fallbackMethods:["bootstrap","dns","websocket"],...e},this.config.bootstrapNodes.forEach(t=>{this.bootstrapNodes.set(t.id,t)})}async initialize(e,t){this.isInitialized||(this.libp2p=e,this.dhtDiscovery=t,await this.loadPeerHistory(),this.startFallbackDiscovery(),this.isInitialized=!0,console.log("Bootstrap Discovery Manager initialized"))}async bootstrapNetwork(){if(!this.libp2p)throw new Error("Bootstrap Discovery Manager not initialized");console.log("Starting network bootstrap...");for(const e of this.config.fallbackMethods)try{console.log(`Attempting bootstrap via ${e}...`);let t=!1;switch(e){case"bootstrap":t=await this.bootstrapViaNodes();break;case"dns":t=await this.bootstrapViaDNS();break;case"websocket":t=await this.bootstrapViaWebSocket();break;case"mdns":t=await this.bootstrapViaMDNS();break}if(t)return console.log(`Bootstrap successful via ${e}`),!0}catch(t){console.warn(`Bootstrap via ${e} failed:`,t)}return console.error("All bootstrap methods failed"),!1}async getPeerRecommendations(e){const t=[],r=Date.now();for(const[s,i]of this.peerHistory.entries()){if(i.interactions.length<this.config.minInteractionsForRecommendation)continue;const a=i.successfulConnections/Math.max(i.totalConnections,1);let c=a*.6+i.reputation*.4;const u=(r-i.lastSeen.getTime())/(1e3*60*60*24),h=Math.pow(this.config.recommendationDecayFactor,u);c*=h;let f=1/0,p=0;e.geohash&&i.interactions.length>0&&(f=Math.random()*100,p=Math.max(0,(100-f)/100)*this.config.geographicWeightFactor,c+=p);const m=this.calculateSharedInterests(s,e.interests),w=m.length/Math.max(e.interests.length,1)*this.config.interestWeightFactor;c+=w;const x=[];a>.8&&x.push("High connection success rate"),i.reputation>.7&&x.push("Good reputation"),i.averageLatency<200&&x.push("Low latency"),m.length>0&&x.push(`${m.length} shared interests`),f<50&&x.push("Geographically close"),t.push({peerId:s,score:c,reasons:x,lastInteraction:i.lastSeen,successfulConnections:i.successfulConnections,failedConnections:i.failedConnections,averageLatency:i.averageLatency,sharedInterests:m,geographicDistance:f})}return t.sort((s,i)=>i.score-s.score),t.slice(0,this.config.maxRecommendations)}recordPeerInteraction(e,t,r,s={}){let i=this.peerHistory.get(e);i||(i={peerId:e,interactions:[],totalConnections:0,successfulConnections:0,failedConnections:0,averageLatency:0,lastSeen:new Date,reputation:.5},this.peerHistory.set(e,i));const a={timestamp:new Date,type:t,success:r,...s};if(i.interactions.push(a),i.lastSeen=new Date,t==="connection"&&(i.totalConnections++,r?i.successfulConnections++:i.failedConnections++),a.latency!==void 0){const c=i.averageLatency*(i.interactions.length-1)+a.latency;i.averageLatency=c/i.interactions.length}this.updatePeerReputation(i),i.interactions.length>100&&(i.interactions=i.interactions.slice(-50)),this.savePeerHistory()}async handleDHTFailure(){if(console.log("DHT discovery failed, triggering fallback mechanisms..."),!await this.bootstrapNetwork()){console.warn("Bootstrap failed, using peer recommendations as fallback");const t=await this.getPeerRecommendations({geohash:"",ageRange:[18,99],interests:[],maxDistance:100});for(const r of t.slice(0,5))try{await this.connectToRecommendedPeer(r)}catch(s){console.warn(`Failed to connect to recommended peer ${r.peerId}:`,s)}}}getStats(){const e=Array.from(this.bootstrapNodes.values()).filter(s=>s.reliability>.5).length,t=Array.from(this.peerHistory.values()).reduce((s,i)=>s+i.interactions.length,0),r=Array.from(this.peerHistory.values()).reduce((s,i)=>s+i.reputation,0)/Math.max(this.peerHistory.size,1);return{bootstrapNodes:this.bootstrapNodes.size,availableBootstrapNodes:e,peerHistorySize:this.peerHistory.size,averageReputationScore:r,totalInteractions:t,fallbackMethodsEnabled:this.config.fallbackMethods.length}}addBootstrapNode(e){this.bootstrapNodes.set(e.id,e),console.log("Added bootstrap node:",e.id)}removeBootstrapNode(e){this.bootstrapNodes.delete(e),console.log("Removed bootstrap node:",e)}updateBootstrapNodeReliability(e,t,r){const s=this.bootstrapNodes.get(e);if(!s)return;const i=.1,a=t?1:0;s.reliability=(1-i)*s.reliability+i*a,r!==void 0&&(s.responseTime=s.responseTime*.8+r*.2),s.lastSeen=new Date,console.log(`Updated bootstrap node ${e} reliability: ${s.reliability.toFixed(3)}`)}destroy(){this.fallbackInterval&&(clearInterval(this.fallbackInterval),this.fallbackInterval=null),this.savePeerHistory(),this.peerHistory.clear(),this.bootstrapNodes.clear(),this.isInitialized=!1,console.log("Bootstrap Discovery Manager destroyed")}async bootstrapViaNodes(){if(!this.libp2p)return!1;const e=Array.from(this.bootstrapNodes.values()).sort((t,r)=>r.reliability-t.reliability);for(const t of e.slice(0,this.config.maxBootstrapAttempts)){try{const r=Date.now(),s=Pe(t.multiaddr),i=await this.libp2p.dial(s,{signal:AbortSignal.timeout(this.config.bootstrapTimeout)}),a=Date.now()-r;if(i.status==="open")return this.updateBootstrapNodeReliability(t.id,!0,a),console.log(`Successfully connected to bootstrap node: ${t.id}`),!0}catch(r){this.updateBootstrapNodeReliability(t.id,!1),console.warn(`Failed to connect to bootstrap node ${t.id}:`,r)}await new Promise(r=>setTimeout(r,this.config.bootstrapRetryDelay))}return!1}async bootstrapViaDNS(){if(!this.config.enableDNSBootstrap||!this.libp2p)return!1;for(const e of this.config.dnsBootstrapDomains)try{return console.log(`Attempting DNS bootstrap via ${e}`),await new Promise(t=>setTimeout(t,1e3)),console.log(`DNS bootstrap via ${e} completed (simulated)`),!0}catch(t){console.warn(`DNS bootstrap via ${e} failed:`,t)}return!1}async bootstrapViaWebSocket(){if(!this.config.enableWebSocketBootstrap||!this.libp2p)return!1;for(const e of this.config.webSocketBootstrapUrls)try{return console.log(`Attempting WebSocket bootstrap via ${e}`),await new Promise(t=>setTimeout(t,2e3)),console.log(`WebSocket bootstrap via ${e} completed (simulated)`),!0}catch(t){console.warn(`WebSocket bootstrap via ${e} failed:`,t)}return!1}async bootstrapViaMDNS(){if(!this.libp2p)return!1;try{return console.log("Attempting mDNS bootstrap..."),await new Promise(e=>setTimeout(e,3e3)),console.log("mDNS bootstrap completed (simulated)"),!0}catch(e){return console.warn("mDNS bootstrap failed:",e),!1}}startFallbackDiscovery(){this.fallbackInterval=setInterval(async()=>{if(!this.libp2p||!this.dhtDiscovery)return;const e=this.getNetworkStatus();(!e.dhtConnected||e.peerCount<3)&&(console.log("Network appears unhealthy, triggering fallback discovery..."),await this.handleDHTFailure())},this.config.fallbackDiscoveryInterval)}getNetworkStatus(){if(!this.libp2p)return{connected:!1,peerCount:0,dhtConnected:!1,latency:0,bandwidth:{up:0,down:0}};const e=this.libp2p.getConnections(),t=this.libp2p.services.dht;return{connected:this.libp2p.status==="started",peerCount:e.length,dhtConnected:t?.isStarted()||!1,latency:0,bandwidth:{up:0,down:0}}}async connectToRecommendedPeer(e){if(this.libp2p)try{const t=sr(e.peerId);(await this.libp2p.dial(t)).status==="open"&&(this.recordPeerInteraction(e.peerId,"connection",!0),console.log(`Connected to recommended peer: ${e.peerId}`))}catch(t){throw this.recordPeerInteraction(e.peerId,"connection",!1,{errorReason:t instanceof Error?t.message:"Unknown error"}),t}}calculateSharedInterests(e,t){const r=["music","travel","food","sports"];return t.filter(s=>r.includes(s))}updatePeerReputation(e){const t=e.interactions.slice(-20);if(t.length===0){e.reputation=.5;return}const s=t.filter(c=>c.success).length/t.length,i=t.filter(c=>c.latency!==void 0).reduce((c,u)=>c+(u.latency||0),0)/t.length,a=Math.max(0,1-i/1e3);e.reputation=s*.7+a*.3,e.reputation=Math.max(0,Math.min(1,e.reputation))}async loadPeerHistory(){try{console.log("Peer history loaded (placeholder)")}catch(e){console.warn("Failed to load peer history:",e)}}savePeerHistory(){try{console.log("Peer history saved (placeholder)")}catch(e){console.warn("Failed to save peer history:",e)}}}class HY{constructor(){this.events=new Map}addEventListener(e,t){this.events.has(e)||this.events.set(e,[]),this.events.get(e).push(t)}removeEventListener(e,t){const r=this.events.get(e);if(r){const s=r.indexOf(t);s>-1&&r.splice(s,1)}}emit(e,...t){const r=this.events.get(e);r&&r.forEach(s=>{try{s(...t)}catch(i){console.error("Event listener error:",i)}})}on(e,t){this.addEventListener(e,t)}off(e,t){this.removeEventListener(e,t)}removeAllListeners(){this.events.clear()}}class KY extends HY{constructor(){super(),this.libp2p=null,this.peerMetrics=new Map,this.networkHistory=[],this.maxHistorySize=100,this.monitoringInterval=null,this.latencyTests=new Map,this.bandwidthTests=new Map,this.messageStats={sent:0,received:0,failed:0,delivered:0}}initialize(e){this.libp2p=e,this.setupEventListeners(),this.startMonitoring()}setupEventListeners(){this.libp2p&&(this.libp2p.addEventListener("peer:connect",e=>{const t=e.detail.toString();this.onPeerConnected(t)}),this.libp2p.addEventListener("peer:disconnect",e=>{const t=e.detail.toString();this.onPeerDisconnected(t)}),this.libp2p.addEventListener("connection:open",e=>{const t=e.detail;this.onConnectionOpen(t)}),this.libp2p.addEventListener("connection:close",e=>{const t=e.detail;this.onConnectionClose(t)}))}startMonitoring(){this.monitoringInterval=setInterval(()=>{this.updateNetworkMetrics(),this.detectNetworkIssues()},5e3)}onPeerConnected(e){const t={peerId:e,connectionState:"connected",latency:0,bandwidth:{up:0,down:0},packetsLost:0,packetsReceived:0,packetsSent:0,connectionQuality:"good",lastSeen:new Date,connectionDuration:0,reconnectAttempts:0,protocols:[],multiaddrs:[]};this.peerMetrics.set(e,t),this.emit("peer:connected",e,t)}onPeerDisconnected(e){const t=this.peerMetrics.get(e);t&&(t.connectionState="disconnected",t.lastSeen=new Date,this.emit("peer:disconnected",e,t))}onConnectionOpen(e){const t=e.remotePeer.toString(),r=this.peerMetrics.get(t);r&&(r.connectionState="connected",r.protocols=e.remoteAddr.protos().map(s=>s.name),r.multiaddrs=[e.remoteAddr.toString()],r.lastSeen=new Date)}onConnectionClose(e){const t=e.remotePeer.toString(),r=this.peerMetrics.get(t);r&&(r.connectionState="disconnected",r.lastSeen=new Date)}updateNetworkMetrics(){if(!this.libp2p)return;for(const[t,r]of this.peerMetrics)this.updatePeerMetrics(t,r);const e=this.getCurrentNetworkStatus();this.networkHistory.push(e),this.networkHistory.length>this.maxHistorySize&&this.networkHistory.shift(),this.emit("metrics:updated",this.getNetworkDiagnostics())}async updatePeerMetrics(e,t){try{const r=await this.measureLatency(e);if(r>0){t.latency=r,this.latencyTests.has(e)||this.latencyTests.set(e,[]);const s=this.latencyTests.get(e);s.push(r),s.length>10&&s.shift()}t.connectionQuality=this.calculateConnectionQuality(t),t.connectionState==="connected"&&(t.connectionDuration=Date.now()-t.lastSeen.getTime())}catch(r){console.warn(`Failed to update metrics for peer ${e}:`,r)}}async measureLatency(e){if(!this.libp2p)return 0;try{const t=Date.now();return await this.libp2p.services.ping.ping(e),Date.now()-t}catch{return 0}}calculateConnectionQuality(e){const{latency:t,packetsLost:r,packetsReceived:s}=e,i=s>0?r/s:0;return t<100&&i<.01?"excellent":t<300&&i<.05?"good":t<500&&i<.1?"fair":"poor"}getCurrentNetworkStatus(){if(!this.libp2p)return{connected:!1,peerCount:0,dhtConnected:!1,latency:0,bandwidth:{up:0,down:0}};const e=this.libp2p.getConnections(),t=this.calculateAverageLatency(),r=this.calculateTotalBandwidth();return{connected:this.libp2p.status==="started",peerCount:e.length,dhtConnected:this.isDHTConnected(),latency:t,bandwidth:r}}calculateAverageLatency(){const e=Array.from(this.peerMetrics.values()).filter(r=>r.connectionState==="connected"&&r.latency>0);return e.length===0?0:e.reduce((r,s)=>r+s.latency,0)/e.length}calculateTotalBandwidth(){return Array.from(this.peerMetrics.values()).filter(t=>t.connectionState==="connected").reduce((t,r)=>({up:t.up+r.bandwidth.up,down:t.down+r.bandwidth.down}),{up:0,down:0})}isDHTConnected(){if(!this.libp2p)return!1;try{return this.libp2p.services.dht?.isStarted()||!1}catch{return!1}}detectNetworkIssues(){const e=[],t=this.getCurrentNetworkStatus();t.connected||e.push({type:"connection",severity:"critical",description:"P2P network is not connected",timestamp:new Date,resolved:!1}),t.dhtConnected||e.push({type:"dht",severity:"high",description:"DHT is not connected - peer discovery may be limited",timestamp:new Date,resolved:!1}),t.peerCount<3&&e.push({type:"peer_discovery",severity:"medium",description:`Low peer count (${t.peerCount}) - network may be isolated`,timestamp:new Date,resolved:!1}),t.latency>1e3&&e.push({type:"latency",severity:"medium",description:`High network latency (${t.latency}ms)`,timestamp:new Date,resolved:!1});const r=Array.from(this.peerMetrics.values()).filter(s=>s.connectionQuality==="poor");r.length>0&&e.push({type:"connection",severity:"medium",description:`${r.length} peer(s) have poor connection quality`,affectedPeers:r.map(s=>s.peerId),timestamp:new Date,resolved:!1}),e.length>0&&this.emit("issues:detected",e)}getNetworkDiagnostics(){const e=this.getCurrentNetworkStatus(),t=Array.from(this.peerMetrics.values());return{networkStatus:e,peerMetrics:t,dhtStatus:this.getDHTStatus(),troubleshooting:this.getTroubleshootingInfo(),performance:this.getPerformanceMetrics()}}getDHTStatus(){if(!this.libp2p)return{connected:!1,routingTableSize:0,knownPeers:0,activeQueries:0,lastBootstrap:null};try{const e=this.libp2p.services.dht;return{connected:e?.isStarted()||!1,routingTableSize:e?.routingTable?.size||0,knownPeers:this.libp2p.getPeers().length,activeQueries:0,lastBootstrap:null}}catch{return{connected:!1,routingTableSize:0,knownPeers:0,activeQueries:0,lastBootstrap:null}}}getTroubleshootingInfo(){const e=[],t=[],r=this.getCurrentNetworkStatus();r.connected||(t.push("Check internet connection"),t.push("Verify firewall settings"),t.push("Try different STUN/TURN servers")),r.dhtConnected||(t.push("Check bootstrap node connectivity"),t.push("Verify DHT configuration")),r.peerCount<3&&(t.push("Wait for more peers to join the network"),t.push("Check geolocation settings"),t.push("Verify discovery criteria"));const s=this.calculateHealthScore();return{issues:e,recommendations:t,healthScore:s}}getPerformanceMetrics(){const e=Array.from(this.peerMetrics.values()).filter(f=>f.connectionState==="connected"),t=this.calculateAverageLatency(),r=this.calculateTotalBandwidth(),s=Array.from(this.peerMetrics.values()).reduce((f,p)=>f+p.reconnectAttempts+1,0),i=e.length,a=s>0?i/s*100:0,c=this.messageStats.sent,u=this.messageStats.delivered,h=c>0?u/c*100:100;return{averageLatency:t,totalBandwidth:r,connectionSuccess:a,messageDeliveryRate:h}}calculateHealthScore(){const e=this.getCurrentNetworkStatus();let t=100;e.connected||(t-=50),e.dhtConnected||(t-=20),e.peerCount<3&&(t-=15),e.latency>500&&(t-=10),e.latency>1e3&&(t-=10);const r=Array.from(this.peerMetrics.values()).filter(s=>s.connectionQuality==="poor").length;return t-=r*5,Math.max(0,t)}async runNetworkTroubleshooting(){const e=[],t=[],r=[],s=await this.testConnectivity();s.success||(e.push({type:"connection",severity:"critical",description:s.error||"Network connectivity test failed",timestamp:new Date,resolved:!1}),t.push("Check internet connection"),t.push("Verify firewall settings"));const i=await this.testDHTConnectivity();i.success||(e.push({type:"dht",severity:"high",description:i.error||"DHT connectivity test failed",timestamp:new Date,resolved:!1}),t.push("Check bootstrap nodes"),r.push("Retry DHT bootstrap"));const a=await this.testPeerDiscovery();a.success||(e.push({type:"peer_discovery",severity:"medium",description:a.error||"Peer discovery test failed",timestamp:new Date,resolved:!1}),t.push("Adjust discovery criteria"),t.push("Check geolocation settings"));const c=this.calculateHealthScore(),u=r.length>0;return{issues:e,recommendations:t,healthScore:c,canAutoFix:u,autoFixActions:r}}async testConnectivity(){try{return!this.libp2p||this.libp2p.status!=="started"?{success:!1,error:"P2P node not started"}:this.libp2p.getConnections().length===0?{success:!1,error:"No peer connections available"}:{success:!0}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async testDHTConnectivity(){try{return this.libp2p?this.libp2p.services.dht?.isStarted()?{success:!0}:{success:!1,error:"DHT service not started"}:{success:!1,error:"P2P node not available"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"DHT test failed"}}}async testPeerDiscovery(){try{return this.libp2p?this.libp2p.getPeers().length===0?{success:!1,error:"No peers discovered"}:{success:!0}:{success:!1,error:"P2P node not available"}}catch(e){return{success:!1,error:e instanceof Error?e.message:"Peer discovery test failed"}}}getPeerMetrics(e){return this.peerMetrics.get(e)||null}getAllPeerMetrics(){return Array.from(this.peerMetrics.values())}getNetworkHistory(){return[...this.networkHistory]}recordMessageSent(){this.messageStats.sent++}recordMessageReceived(){this.messageStats.received++}recordMessageDelivered(){this.messageStats.delivered++}recordMessageFailed(){this.messageStats.failed++}destroy(){this.monitoringInterval&&(clearInterval(this.monitoringInterval),this.monitoringInterval=null),this.peerMetrics.clear(),this.networkHistory.length=0,this.latencyTests.clear(),this.bandwidthTests.clear(),this.removeAllListeners()}}class Dk{constructor(e={}){this.libp2p=null,this.isInitialized=!1,this.connectedPeers=new Map,this.messageHandlers=new Map,this.profileSubscribers=new Set,this.discoveryInterval=null,this.dhtDiscovery=null,this.profileSyncManager=null,this.connectionRecoveryManager=null,this.bootstrapDiscoveryManager=null,this.networkDiagnosticsManager=null,this.config={bootstrapNodes:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa"],stunServers:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302"],turnServers:[],geohashPrecision:5,maxPeers:50,discoveryInterval:3e4,enableEncryption:!0,keyRotationInterval:36e5,messageTimeout:1e4,reconnectInterval:5e3,maxRetries:3,...e}}async initialize(){if(!this.isInitialized)try{this.libp2p=await u$({addresses:{listen:[]},transports:[az(),Az(),qz()],connectionEncrypters:[OK()],streamMuxers:[eq()],peerDiscovery:[cG({list:this.config.bootstrapNodes})],services:{dht:NW({kBucketSize:20}),identify:zW(),ping:XW()}}),this.setupEventListeners(),await this.libp2p.start(),this.dhtDiscovery=new UY(this.libp2p),this.profileSyncManager=new VY(this),this.connectionRecoveryManager=new $Y({healthCheckInterval:3e4,healthCheckTimeout:5e3,maxConsecutiveFailures:3,maxReconnectAttempts:5,initialReconnectDelay:1e3,maxReconnectDelay:6e4,backoffMultiplier:2,enablePeerReplacement:!0,minHealthyPeers:3,maxUnhealthyPeers:2,partitionDetectionThreshold:.7,partitionRecoveryTimeout:3e5,bootstrapNodes:this.config.bootstrapNodes,enableBootstrapFallback:!0}),this.bootstrapDiscoveryManager=new zY({bootstrapNodes:this.config.bootstrapNodes.map(e=>({id:e.split("/").pop()||"unknown",multiaddr:e,protocols:["kad-dht"],region:"global",reliability:.9,lastSeen:new Date,responseTime:100})),maxBootstrapAttempts:5,bootstrapTimeout:1e4,bootstrapRetryDelay:2e3,enableDNSBootstrap:!0,dnsBootstrapDomains:["bootstrap.libp2p.io"],enableWebSocketBootstrap:!0,webSocketBootstrapUrls:["wss://ws-star.discovery.libp2p.io"],maxRecommendations:10,fallbackDiscoveryInterval:6e4,maxFallbackAttempts:3,fallbackMethods:["bootstrap","dns","websocket"]}),await this.bootstrapDiscoveryManager.initialize(this.libp2p,this.dhtDiscovery),this.networkDiagnosticsManager=new KY,this.networkDiagnosticsManager.initialize(this.libp2p),this.isInitialized=!0,console.log("P2P Manager initialized with peer ID:",this.libp2p.peerId.toString())}catch(e){throw console.error("Failed to initialize P2P Manager:",e),e}}async connect(){if(!this.libp2p)throw new Error("P2P Manager not initialized");if(this.startPeriodicDiscovery(),this.profileSyncManager&&this.profileSyncManager.startSync(),this.connectionRecoveryManager){const e={hasConnection:t=>this.connectedPeers.has(t),getDataChannel:()=>null,closeConnection:async t=>{const r=this.connectedPeers.get(t);r&&(await r.close(),this.connectedPeers.delete(t))},onConnectionStateChange:()=>{}};this.connectionRecoveryManager.initialize(this,e,this.dhtDiscovery)}console.log("P2P Manager connected to network")}async disconnect(){this.discoveryInterval&&(clearInterval(this.discoveryInterval),this.discoveryInterval=null),this.bootstrapDiscoveryManager&&(this.bootstrapDiscoveryManager.destroy(),this.bootstrapDiscoveryManager=null),this.connectionRecoveryManager&&(this.connectionRecoveryManager.destroy(),this.connectionRecoveryManager=null),this.profileSyncManager&&(this.profileSyncManager.destroy(),this.profileSyncManager=null),this.dhtDiscovery&&(this.dhtDiscovery.destroy(),this.dhtDiscovery=null),this.networkDiagnosticsManager&&(this.networkDiagnosticsManager.destroy(),this.networkDiagnosticsManager=null),this.connectedPeers.clear(),this.libp2p&&(await this.libp2p.stop(),this.isInitialized=!1,console.log("P2P Manager disconnected"))}getNetworkStatus(){if(!this.libp2p)return{connected:!1,peerCount:0,dhtConnected:!1,latency:0,bandwidth:{up:0,down:0}};const e=this.libp2p.getConnections(),t=this.libp2p.services.dht;return{connected:this.isInitialized&&this.libp2p.status==="started",peerCount:e.length,dhtConnected:t?.isStarted()||!1,latency:this.calculateAverageLatency(),bandwidth:{up:0,down:0}}}async discoverPeers(e){if(!this.dhtDiscovery)throw new Error("DHT Discovery not initialized");try{const t=this.dhtDiscovery.generateTopics(e);console.log("Discovering peers for topics:",t),await this.dhtDiscovery.join(t);const r=[];for(const a of t){const c=await this.dhtDiscovery.findPeers(a);r.push(...c)}const i=this.deduplicatePeers(r).slice(0,this.config.maxPeers);if(i.length<5&&this.bootstrapDiscoveryManager){console.log("DHT discovery returned few peers, trying bootstrap fallback...");try{const c=(await this.bootstrapDiscoveryManager.getPeerRecommendations(e)).map(f=>({id:f.peerId,multiaddrs:[`/p2p/${f.peerId}`],protocols:["kad-dht"],metadata:{geohash:e.geohash,ageRange:e.ageRange,interests:f.sharedInterests,lastSeen:f.lastInteraction}})),u=[...i,...c],h=this.deduplicatePeers(u);return console.log(`Bootstrap fallback added ${c.length} peer recommendations`),h.slice(0,this.config.maxPeers)}catch(a){console.warn("Bootstrap fallback failed:",a)}}return i}catch(t){if(console.error("Peer discovery failed:",t),this.bootstrapDiscoveryManager){console.log("DHT discovery completely failed, using bootstrap fallback only...");try{return await this.handleDHTFailure(),(await this.bootstrapDiscoveryManager.getPeerRecommendations(e)).map(s=>({id:s.peerId,multiaddrs:[`/p2p/${s.peerId}`],protocols:["kad-dht"],metadata:{geohash:e.geohash,ageRange:e.ageRange,interests:s.sharedInterests,lastSeen:s.lastInteraction}}))}catch(r){console.error("Bootstrap fallback also failed:",r)}}return[]}}async connectToPeer(e){if(!this.libp2p)throw new Error("P2P Manager not initialized");const t=Date.now();try{if(this.connectedPeers.has(e)){console.log("Already connected to peer:",e),this.recordPeerInteraction(e,"connection",!0,{latency:0,cached:!0});return}const r=await this.libp2p.dial(e),s=Date.now()-t;if(r.status==="open")this.connectedPeers.set(e,r),console.log("Successfully connected to peer:",e),this.recordPeerInteraction(e,"connection",!0,{latency:s});else throw this.recordPeerInteraction(e,"connection",!1,{latency:s,errorReason:`Connection status: ${r.status}`}),new Error(`Connection failed with status: ${r.status}`)}catch(r){const s=Date.now()-t;throw this.recordPeerInteraction(e,"connection",!1,{latency:s,errorReason:r instanceof Error?r.message:"Unknown error"}),console.error("Failed to connect to peer:",e,r),r}}async broadcastProfile(e){if(!this.libp2p)throw new Error("P2P Manager not initialized");try{const t=e.serialize(),s={type:"profile_broadcast",metadata:{id:e.id,did:e.did,version:e.version,timestamp:e.lastUpdated.toISOString()},data:Array.from(t)},i=this.libp2p.getConnections(),a=i.map(async c=>{try{const u=await c.newStream("/tinder/profile/1.0.0"),h=new TextEncoder().encode(JSON.stringify(s));await u.sink([h]),await u.close()}catch(u){console.warn("Failed to broadcast to peer:",c.remotePeer.toString(),u)}});await Promise.allSettled(a),console.log("Profile broadcasted to",i.length,"peers")}catch(t){throw console.error("Profile broadcast failed:",t),t}}subscribeToProfiles(e){this.profileSubscribers.add(e),console.log("Subscribed to profile updates, total subscribers:",this.profileSubscribers.size)}async requestProfile(e,t){if(!this.libp2p)throw new Error("P2P Manager not initialized");try{const r=this.connectedPeers.get(e)||await this.libp2p.dial(e),s={type:"profile_request",profileId:t,requestId:crypto.randomUUID(),timestamp:new Date().toISOString()},i=await r.newStream("/tinder/profile-request/1.0.0"),a=new TextEncoder().encode(JSON.stringify(s));return await i.sink([a]),await i.close(),new Promise((c,u)=>{const h=setTimeout(()=>{u(new Error("Profile request timeout"))},this.config.messageTimeout),f=p=>{p.id===t&&(clearTimeout(h),this.profileSubscribers.delete(f),c(p))};this.profileSubscribers.add(f)})}catch(r){return console.error("Profile request failed:",r),null}}async syncProfilesWithCriteria(e){if(!this.libp2p)throw new Error("P2P Manager not initialized");try{const t=await this.discoverPeers(e);console.log("Found",t.length,"peers matching criteria for profile sync");const r=t.map(async a=>{try{return this.connectedPeers.has(a.id)||await this.connectToPeer(a.id),await this.requestProfile(a.id,a.id)}catch(c){return console.warn("Failed to sync profile from peer:",a.id,c),null}}),i=(await Promise.allSettled(r)).filter(a=>a.status==="fulfilled"&&a.value!==null).map(a=>a.value);return console.log("Successfully synced",i.length,"profiles"),i}catch(t){return console.error("Profile sync with criteria failed:",t),[]}}async broadcastProfileUpdates(e){if(!this.libp2p)throw new Error("P2P Manager not initialized");try{const t={type:"profile_batch_update",profiles:e.map(i=>({id:i.id,did:i.did,version:i.version,timestamp:i.lastUpdated.toISOString(),data:Array.from(i.serialize())})),batchId:crypto.randomUUID(),timestamp:new Date().toISOString()},r=this.libp2p.getConnections(),s=r.map(async i=>{try{const a=await i.newStream("/tinder/profile-batch/1.0.0"),c=new TextEncoder().encode(JSON.stringify(t));await a.sink([c]),await a.close()}catch(a){console.warn("Failed to send batch update to peer:",i.remotePeer.toString(),a)}});await Promise.allSettled(s),console.log("Batch profile updates sent to",r.length,"peers")}catch(t){throw console.error("Batch profile update failed:",t),t}}async sendMessage(e,t){if(!this.libp2p)throw new Error("P2P Manager not initialized");try{const s=await(this.connectedPeers.get(e)||await this.libp2p.dial(e)).newStream("/tinder/message/1.0.0"),i=new Uint8Array([...new Uint8Array(t.ciphertext),...new TextEncoder().encode(JSON.stringify({header:t.header,timestamp:t.timestamp.toISOString()}))]);await s.sink([i]),await s.close(),console.log("Message sent to peer:",e)}catch(r){throw console.error("Failed to send message to peer:",e,r),r}}onMessage(e){const t=Math.random().toString(36).substr(2,9);this.messageHandlers.set(t,e),console.log("Message handler registered with ID:",t)}setupEventListeners(){this.libp2p&&(this.libp2p.addEventListener("peer:connect",e=>{const t=e.detail.toString();console.log("Peer connected:",t)}),this.libp2p.addEventListener("peer:disconnect",e=>{const t=e.detail.toString();this.connectedPeers.delete(t),console.log("Peer disconnected:",t)}),this.libp2p.handle("/tinder/profile/1.0.0",({stream:e,connection:t})=>{this.handleIncomingProfile(e,t.remotePeer)}),this.libp2p.handle("/tinder/profile-request/1.0.0",({stream:e,connection:t})=>{this.handleProfileRequest(e,t.remotePeer)}),this.libp2p.handle("/tinder/profile-batch/1.0.0",({stream:e,connection:t})=>{this.handleProfileBatch(e,t.remotePeer)}),this.libp2p.handle("/tinder/message/1.0.0",({stream:e,connection:t})=>{this.handleIncomingMessage(e,t.remotePeer)}))}async handleIncomingProfile(e,t){try{const r=[];for await(const u of e.source)r.push(u);const s=new Uint8Array(r.reduce((u,h)=>u+h.length,0));let i=0;for(const u of r)s.set(u,i),i+=u.length;const a=new TextDecoder().decode(s),c=JSON.parse(a);if(c.type==="profile_broadcast"){const u=new Uint8Array(c.data),h=Tu.deserialize(u,c.metadata.id,c.metadata.did);h.id===c.metadata.id&&h.version>=c.metadata.version?(this.profileSubscribers.forEach(f=>{try{f(h)}catch(p){console.error("Profile subscriber callback failed:",p)}}),console.log("Received profile broadcast from peer:",t.toString(),"Profile ID:",h.id)):console.warn("Profile integrity check failed for peer:",t.toString())}}catch(r){console.error("Failed to handle incoming profile:",r)}}async handleProfileRequest(e,t){try{const r=[];for await(const u of e.source)r.push(u);const s=new Uint8Array(r.reduce((u,h)=>u+h.length,0));let i=0;for(const u of r)s.set(u,i),i+=u.length;const a=new TextDecoder().decode(s),c=JSON.parse(a);c.type==="profile_request"&&console.log("Received profile request from peer:",t.toString(),"for profile:",c.profileId)}catch(r){console.error("Failed to handle profile request:",r)}}async handleProfileBatch(e,t){try{const r=[];for await(const u of e.source)r.push(u);const s=new Uint8Array(r.reduce((u,h)=>u+h.length,0));let i=0;for(const u of r)s.set(u,i),i+=u.length;const a=new TextDecoder().decode(s),c=JSON.parse(a);if(c.type==="profile_batch_update"){console.log("Received profile batch from peer:",t.toString(),"with",c.profiles.length,"profiles");for(const u of c.profiles)try{const h=new Uint8Array(u.data),f=Tu.deserialize(h,u.id,u.did);f.id===u.id&&f.version>=u.version&&this.profileSubscribers.forEach(p=>{try{p(f)}catch(m){console.error("Profile subscriber callback failed:",m)}})}catch(h){console.warn("Failed to process profile in batch:",u.id,h)}}}catch(r){console.error("Failed to handle profile batch:",r)}}async handleIncomingMessage(e,t){try{const r=[];for await(const i of e.source)r.push(i);const s=t.toString();this.messageHandlers.forEach(i=>{try{const a={type:"chat",from:s,to:this.getPeerId(),timestamp:new Date,payload:{ciphertext:new ArrayBuffer(0),header:{publicKey:new ArrayBuffer(0),previousChainLength:0,messageNumber:0},mac:new ArrayBuffer(0)}};i(s,a)}catch(a){console.error("Message handler callback failed:",a)}}),console.log("Received message from peer:",s)}catch(r){console.error("Failed to handle incoming message:",r)}}startPeriodicDiscovery(){this.discoveryInterval&&clearInterval(this.discoveryInterval),this.discoveryInterval=setInterval(async()=>{try{const e=this.libp2p?.getConnections()||[];if(console.log("Periodic discovery - connected peers:",e.length),e.length>this.config.maxPeers){const t=e.slice(this.config.maxPeers);for(const r of t)try{await r.close()}catch(s){console.warn("Failed to close excess connection:",s)}}}catch(e){console.error("Periodic discovery failed:",e)}},this.config.discoveryInterval)}calculateAverageLatency(){return 0}getPeerId(){if(!this.libp2p)throw new Error("P2P Manager not initialized");return this.libp2p.peerId.toString()}isConnected(){return this.isInitialized&&this.libp2p!==null&&this.libp2p.status==="started"}getConnectedPeers(){return Array.from(this.connectedPeers.keys())}getConnectionCount(){return this.connectedPeers.size}unsubscribeFromProfiles(e){this.profileSubscribers.delete(e)}removeMessageHandler(e){for(const[t,r]of this.messageHandlers.entries())if(r===e){this.messageHandlers.delete(t);break}}getProfileSyncManager(){return this.profileSyncManager}getDHTDiscovery(){return this.dhtDiscovery}getConnectionRecoveryManager(){return this.connectionRecoveryManager}async forcePeerRecovery(e){return this.connectionRecoveryManager?await this.connectionRecoveryManager.forcePeerRecovery(e):(console.warn("Connection Recovery Manager not available"),!1)}async forceNetworkRecovery(){if(!this.connectionRecoveryManager){console.warn("Connection Recovery Manager not available");return}await this.connectionRecoveryManager.forceNetworkRecovery()}getNetworkHealth(){return this.connectionRecoveryManager?this.connectionRecoveryManager.getNetworkHealth():{totalPeers:this.connectedPeers.size,healthyPeers:this.connectedPeers.size,unhealthyPeers:0,healthyRatio:1,partition:null,peerHealth:[]}}getBootstrapDiscoveryManager(){return this.bootstrapDiscoveryManager}async bootstrapNetwork(){return this.bootstrapDiscoveryManager?await this.bootstrapDiscoveryManager.bootstrapNetwork():(console.warn("Bootstrap Discovery Manager not available"),!1)}async getPeerRecommendations(e){return this.bootstrapDiscoveryManager?await this.bootstrapDiscoveryManager.getPeerRecommendations(e):(console.warn("Bootstrap Discovery Manager not available"),[])}recordPeerInteraction(e,t,r,s={}){this.bootstrapDiscoveryManager&&this.bootstrapDiscoveryManager.recordPeerInteraction(e,t,r,s)}async handleDHTFailure(){if(!this.bootstrapDiscoveryManager){console.warn("Bootstrap Discovery Manager not available");return}await this.bootstrapDiscoveryManager.handleDHTFailure()}getBootstrapStats(){return this.bootstrapDiscoveryManager?this.bootstrapDiscoveryManager.getStats():{bootstrapNodes:0,availableBootstrapNodes:0,peerHistorySize:0,averageReputationScore:0,totalInteractions:0,fallbackMethodsEnabled:0}}async joinDiscoveryTopics(e){if(!this.dhtDiscovery)throw new Error("DHT Discovery not initialized");const t=this.dhtDiscovery.generateTopics(e);await this.dhtDiscovery.join(t)}async leaveDiscoveryTopics(e){if(!this.dhtDiscovery)throw new Error("DHT Discovery not initialized");const t=this.dhtDiscovery.generateTopics(e);await this.dhtDiscovery.leave(t)}subscribeToDiscoveryTopic(e,t){if(!this.dhtDiscovery)throw new Error("DHT Discovery not initialized");this.dhtDiscovery.subscribeToTopic(e,t)}deduplicatePeers(e){const t=new Set,r=[];for(const s of e)t.has(s.id)||(t.add(s.id),r.push(s));return r}getNetworkDiagnostics(){if(!this.networkDiagnosticsManager)throw new Error("Network diagnostics not initialized");return this.networkDiagnosticsManager.getNetworkDiagnostics()}async runNetworkTroubleshooting(){if(!this.networkDiagnosticsManager)throw new Error("Network diagnostics not initialized");return this.networkDiagnosticsManager.runNetworkTroubleshooting()}getPeerMetrics(e){return this.networkDiagnosticsManager?this.networkDiagnosticsManager.getPeerMetrics(e):null}getAllPeerMetrics(){return this.networkDiagnosticsManager?this.networkDiagnosticsManager.getAllPeerMetrics():[]}getNetworkHistory(){return this.networkDiagnosticsManager?this.networkDiagnosticsManager.getNetworkHistory():[]}recordMessageSent(){this.networkDiagnosticsManager?.recordMessageSent()}recordMessageReceived(){this.networkDiagnosticsManager?.recordMessageReceived()}recordMessageDelivered(){this.networkDiagnosticsManager?.recordMessageDelivered()}recordMessageFailed(){this.networkDiagnosticsManager?.recordMessageFailed()}onNetworkDiagnosticsUpdate(e){this.networkDiagnosticsManager?.on("metrics:updated",e)}onNetworkIssuesDetected(e){this.networkDiagnosticsManager?.on("issues:detected",e)}onPeerConnected(e){this.networkDiagnosticsManager?.on("peer:connected",e)}onPeerDisconnected(e){this.networkDiagnosticsManager?.on("peer:disconnected",e)}}class qY{constructor(){this.DEFAULT_FILTER_SIZE=2048,this.DEFAULT_HASH_FUNCTIONS=7,this.FALSE_POSITIVE_RATE=.01}generateLikeBloomFilter(e,t){if(e.length===0)throw new Error("Cannot create Bloom filter for empty likes array");const r=t||this.generateSalt(),s=this.calculateOptimalFilterSize(e.length,this.FALSE_POSITIVE_RATE),i=this.calculateOptimalHashFunctions(s,e.length),a=e.length>50?Math.max(this.DEFAULT_FILTER_SIZE,e.length*20):this.DEFAULT_FILTER_SIZE,c=Math.max(s,a),u=Math.min(i,this.DEFAULT_HASH_FUNCTIONS),h=new Uint8Array(Math.ceil(c/8));for(const f of e){const p=this.saltLike(f,r);this.addToFilter(h,p,c,u)}return{bits:h,hashFunctions:u,size:c}}createPrivateMatch(e){const t=this.generateSalt();return{likeFilter:this.generateLikeBloomFilter(e,t),salt:t,timestamp:new Date,revealed:!1}}checkMutualMatch(e,t,r){try{if(!this.areFiltersCompatible(e.likeFilter,t.likeFilter))return console.warn("Incompatible Bloom filters for PSI comparison"),!1;let s=0;const i=Math.min(2,r.length);for(const a of r){const c=this.saltLike(a,t.salt);if(this.testInFilter(t.likeFilter,c)&&(s++,s>=i))return!0}return s>=i}catch(s){return console.error("Error during mutual match check:",s),!1}}calculateMatchStrength(e,t,r){if(!this.areFiltersCompatible(e.likeFilter,t.likeFilter))return 0;let s=0;for(const i of r){const a=this.saltLike(i,t.salt);this.testInFilter(t.likeFilter,a)&&s++}return r.length>0?s/r.length:0}generateSalt(){const e=Po(16);return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}saltLike(e,t){const s=new TextEncoder().encode(`${e}:${t}`),i=Da(s);return Array.from(i).map(a=>a.toString(16).padStart(2,"0")).join("")}addToFilter(e,t,r,s){for(let i=0;i<s;i++){const a=this.hashWithSeed(t,i)%r,c=Math.floor(a/8),u=a%8;e[c]|=1<<u}}testInFilter(e,t){for(let r=0;r<e.hashFunctions;r++){const s=this.hashWithSeed(t,r)%e.size,i=Math.floor(s/8),a=s%8;if((e.bits[i]&1<<a)===0)return!1}return!0}hashWithSeed(e,t){const s=new TextEncoder().encode(e+t.toString()),i=Da(s);let a=0;for(let c=0;c<4;c++)a=a<<8|i[c];return Math.abs(a)}calculateOptimalFilterSize(e,t){const r=Math.ceil(-(e*Math.log(t))/Math.log(2)**2);return Math.max(r,512)}calculateOptimalHashFunctions(e,t){const r=Math.ceil(e/t*Math.log(2));return Math.max(1,Math.min(r,10))}areFiltersCompatible(e,t){return e.size===t.size&&e.hashFunctions===t.hashFunctions&&e.bits.length===t.bits.length}estimateFalsePositiveRate(e,t){const r=e.hashFunctions,s=e.size,i=t;return Math.pow(1-Math.exp(-r*i/s),r)}getFilterStats(e){let t=0;for(const i of e.bits)t+=this.popCount(i);const r=t/e.size,s=r>0&&r<1?Math.round(-(e.size/e.hashFunctions)*Math.log(1-r)):0;return{size:e.size,hashFunctions:e.hashFunctions,setBits:t,fillRatio:r,estimatedElements:s}}popCount(e){let t=0;for(;e;)t+=e&1,e>>>=1;return t}serializeFilter(e){const t={bits:Array.from(e.bits),hashFunctions:e.hashFunctions,size:e.size};return JSON.stringify(t)}deserializeFilter(e){try{const t=JSON.parse(e);return{bits:new Uint8Array(t.bits),hashFunctions:t.hashFunctions,size:t.size}}catch(t){throw new Error(`Failed to deserialize Bloom filter: ${t instanceof Error?t.message:"Unknown error"}`)}}unionFilters(e,t){if(!this.areFiltersCompatible(e,t))throw new Error("Cannot union incompatible Bloom filters");const r=new Uint8Array(e.bits.length);for(let s=0;s<e.bits.length;s++)r[s]=e.bits[s]|t.bits[s];return{bits:r,hashFunctions:e.hashFunctions,size:e.size}}validateFilter(e){try{return!(!e.bits||!e.hashFunctions||!e.size||e.bits.length!==Math.ceil(e.size/8)||e.hashFunctions<1||e.hashFunctions>20||e.size<64||e.size>1e6)}catch{return!1}}}class WY{constructor(){this.identity=null,this.ratchetStates=new Map,this.reputationScores=new Map,this.preKeyBundles=new Map,this.psiManager=new qY,this.MAX_SKIPPED_KEYS=1e3,this.CHAIN_KEY_CONSTANT=new Uint8Array([2]),this.MESSAGE_KEY_CONSTANT=new Uint8Array([1])}async generateIdentity(){try{const e=await crypto.subtle.generateKey({name:"Ed25519",namedCurve:"Ed25519"},!0,["sign","verify"]),t=await crypto.subtle.exportKey("raw",e.publicKey),r=await this.generateDID(t),s={did:r,publicKey:e.publicKey,privateKey:e.privateKey,keyPair:e};return this.identity=s,await this.saveIdentity(s),this.initializeReputation(r),s}catch(e){throw console.error("Failed to generate identity:",e),new Error(`Identity generation failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async loadIdentity(){try{const e=localStorage.getItem("p2p-identity");if(!e)return null;const t=JSON.parse(e);if(!t.did||!t.publicKey||!t.privateKey)return console.warn("Invalid identity data structure"),null;const r=await crypto.subtle.importKey("raw",new Uint8Array(t.publicKey),{name:"Ed25519",namedCurve:"Ed25519"},!0,["verify"]),s=await crypto.subtle.importKey("raw",new Uint8Array(t.privateKey),{name:"Ed25519",namedCurve:"Ed25519"},!0,["sign"]),i={did:t.did,publicKey:r,privateKey:s,keyPair:{publicKey:r,privateKey:s}},a=await crypto.subtle.exportKey("raw",r);return await this.generateDID(a)!==t.did?(console.error("DID mismatch - identity may be corrupted"),null):(this.identity=i,await this.loadReputationData(),i)}catch(e){return console.error("Failed to load identity:",e),null}}async saveIdentity(e){try{const t=await crypto.subtle.exportKey("raw",e.publicKey),r=await crypto.subtle.exportKey("raw",e.privateKey),s={did:e.did,publicKey:Array.from(new Uint8Array(t)),privateKey:Array.from(new Uint8Array(r)),created:new Date().toISOString(),version:"1.0"};localStorage.setItem("p2p-identity",JSON.stringify(s)),await this.saveReputationData()}catch(t){throw console.error("Failed to save identity:",t),new Error(`Identity save failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async generateDID(e){const t=new Uint8Array(e),r=new Uint8Array(t.length+2);return r[0]=237,r[1]=1,r.set(t,2),`did:key:z${this.encodeBase58(r)}`}encodeBase58(e){const t="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";let r="",s=BigInt("0x"+Array.from(e).map(i=>i.toString(16).padStart(2,"0")).join(""));for(;s>0;){const i=s%58n;r=t[Number(i)]+r,s=s/58n}return r}async signProfile(e){if(!this.identity)throw new Error("Identity not initialized - cannot sign profile");try{const t=this.canonicalizeProfile(e),s=new TextEncoder().encode(JSON.stringify(t)),i=await crypto.subtle.sign("Ed25519",this.identity.privateKey,s),a=Array.from(new Uint8Array(i)).map(h=>h.toString(16).padStart(2,"0")).join(""),c=await crypto.subtle.exportKey("raw",this.identity.publicKey),u=Array.from(new Uint8Array(c)).map(h=>h.toString(16).padStart(2,"0")).join("");return{timestamp:new Date,signature:a,publicKey:u,did:this.identity.did}}catch(t){throw console.error("Profile signing failed:",t),new Error(`Profile signing failed: ${t instanceof Error?t.message:"Unknown error"}`)}}async verifyProfile(e,t){try{const r=new Uint8Array(t.publicKey.match(/.{2}/g)?.map(p=>parseInt(p,16))||[]),s=await crypto.subtle.importKey("raw",r,{name:"Ed25519",namedCurve:"Ed25519"},!1,["verify"]);if(await this.generateDID(r.buffer)!==t.did)return console.warn("DID mismatch in profile signature"),!1;const a=this.canonicalizeProfile(e),u=new TextEncoder().encode(JSON.stringify(a)),h=new Uint8Array(t.signature.match(/.{2}/g)?.map(p=>parseInt(p,16))||[]);return await crypto.subtle.verify("Ed25519",s,h,u)}catch(r){return console.error("Profile verification failed:",r),!1}}canonicalizeProfile(e){const t={...e};return delete t.signature,delete t.signatures,this.sortObjectKeys(t)}sortObjectKeys(e){if(e===null||typeof e!="object")return e;if(Array.isArray(e))return e.map(r=>this.sortObjectKeys(r));const t={};return Object.keys(e).sort().forEach(r=>{t[r]=this.sortObjectKeys(e[r])}),t}initializeReputation(e){if(!this.reputationScores.has(e)){const t={did:e,score:100,interactions:0,lastUpdated:new Date,feedbacks:[]};this.reputationScores.set(e,t)}}async addReputationFeedback(e,t,r){if(!this.identity)throw new Error("Identity not initialized - cannot add reputation feedback");if(t<1||t>5)throw new Error("Rating must be between 1 and 5");try{this.initializeReputation(e);const s=this.reputationScores.get(e),i={from:this.identity.did,to:e,rating:t,comment:r||"",timestamp:new Date().toISOString()},c=new TextEncoder().encode(JSON.stringify(this.sortObjectKeys(i))),u=await crypto.subtle.sign("Ed25519",this.identity.privateKey,c),h=Array.from(new Uint8Array(u)).map(m=>m.toString(16).padStart(2,"0")).join(""),f={from:this.identity.did,rating:t,timestamp:new Date,signature:h};s.feedbacks.push(f),s.interactions++,s.lastUpdated=new Date;const p=s.feedbacks.reduce((m,w)=>m+w.rating,0);s.score=Math.round(p/s.feedbacks.length*20),await this.saveReputationData()}catch(s){throw console.error("Failed to add reputation feedback:",s),new Error(`Reputation feedback failed: ${s instanceof Error?s.message:"Unknown error"}`)}}getReputationScore(e){return this.reputationScores.get(e)||null}isSpamLikely(e){const t=this.reputationScores.get(e);return t?t.score<40&&t.interactions>=3:!1}async verifyReputationFeedback(e,t){try{const r={from:e.from,to:e.to,rating:e.rating,comment:e.comment||"",timestamp:e.timestamp},i=new TextEncoder().encode(JSON.stringify(this.sortObjectKeys(r))),a=new Uint8Array(e.signature.match(/.{2}/g)?.map(c=>parseInt(c,16))||[]);return await crypto.subtle.verify("Ed25519",t,a,i)}catch(r){return console.error("Reputation feedback verification failed:",r),!1}}async saveReputationData(){try{const e=Array.from(this.reputationScores.values()).map(t=>({...t,lastUpdated:t.lastUpdated.toISOString(),feedbacks:t.feedbacks.map(r=>({...r,timestamp:r.timestamp.toISOString()}))}));localStorage.setItem("p2p-reputation",JSON.stringify(e))}catch(e){console.error("Failed to save reputation data:",e)}}async loadReputationData(){try{const e=localStorage.getItem("p2p-reputation");if(!e)return;const t=JSON.parse(e);this.reputationScores.clear();for(const r of t){const s={...r,lastUpdated:new Date(r.lastUpdated),feedbacks:r.feedbacks.map(i=>({...i,timestamp:new Date(i.timestamp)}))};this.reputationScores.set(r.did,s)}}catch(e){console.error("Failed to load reputation data:",e)}}async createIdentityProof(){if(!this.identity)throw new Error("Identity not initialized");try{const e=await this.generateRandomBytes(32),t=new Date().toISOString(),r={did:this.identity.did,timestamp:t,challenge:Array.from(e)},i=new TextEncoder().encode(JSON.stringify(this.sortObjectKeys(r))),a=await crypto.subtle.sign("Ed25519",this.identity.privateKey,i),c=Array.from(new Uint8Array(a)).map(u=>u.toString(16).padStart(2,"0")).join("");return JSON.stringify({...r,signature:c})}catch(e){throw console.error("Failed to create identity proof:",e),new Error(`Identity proof creation failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async verifyIdentityProof(e,t){try{const r=JSON.parse(e);if(r.did!==t)return!1;const s=new Date(r.timestamp).getTime();if(Date.now()-s>300*1e3)return!1;const a=await this.extractPublicKeyFromDID(t);if(!a)return!1;const c=await crypto.subtle.importKey("raw",a,{name:"Ed25519",namedCurve:"Ed25519"},!1,["verify"]),u={did:r.did,timestamp:r.timestamp,challenge:r.challenge},f=new TextEncoder().encode(JSON.stringify(this.sortObjectKeys(u))),p=new Uint8Array(r.signature.match(/.{2}/g)?.map(m=>parseInt(m,16))||[]);return await crypto.subtle.verify("Ed25519",c,p,f)}catch(r){return console.error("Identity proof verification failed:",r),!1}}async extractPublicKeyFromDID(e){try{if(!e.startsWith("did:key:z"))return null;const t=e.substring(9),r=this.decodeBase58(t);return r.length<34||r[0]!==237||r[1]!==1?null:r.slice(2)}catch(t){return console.error("Failed to extract public key from DID:",t),null}}decodeBase58(e){const t="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";let r=BigInt(0),s=BigInt(1);for(let a=e.length-1;a>=0;a--){const c=e[a],u=t.indexOf(c);if(u===-1)throw new Error("Invalid base58 character: "+c);r+=BigInt(u)*s,s*=BigInt(58)}const i=[];for(;r>0;)i.unshift(Number(r%256n)),r=r/256n;return new Uint8Array(i)}async generateRandomBytes(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),t}hasIdentity(){return this.identity!==null}getCurrentIdentity(){return this.identity}async clearAllData(){this.identity=null,this.ratchetStates.clear(),this.reputationScores.clear(),this.preKeyBundles.clear(),localStorage.removeItem("p2p-identity"),localStorage.removeItem("p2p-reputation");const e=Object.keys(localStorage);for(const t of e)t.startsWith("ratchet-")&&localStorage.removeItem(t)}async initializeRatchet(e,t){const r={dhSend:{publicKey:new Uint8Array(32),privateKey:new Uint8Array(32)},dhReceive:new Uint8Array(32),rootKey:await this.generateRandomBytes(32),chainKeySend:await this.generateRandomBytes(32),messageNumberSend:0,chainKeyReceive:await this.generateRandomBytes(32),messageNumberReceive:0,previousChainLength:0,skippedMessageKeys:new Map,maxSkippedKeys:this.MAX_SKIPPED_KEYS};this.ratchetStates.set(e,r)}async encryptMessage(e,t){return{ciphertext:new TextEncoder().encode(t).buffer,header:{publicKey:new ArrayBuffer(32),previousChainLength:0,messageNumber:0},timestamp:new Date}}async decryptMessage(e,t){return new TextDecoder().decode(t.ciphertext)}generateLikeBloomFilter(e,t){return this.psiManager.generateLikeBloomFilter(e,t)}createPrivateMatch(e){return this.psiManager.createPrivateMatch(e)}checkMutualMatch(e,t,r){return this.psiManager.checkMutualMatch(e,t,r)}calculateMatchStrength(e,t,r){return this.psiManager.calculateMatchStrength(e,t,r)}checkMutualLike(e,t){for(let r=0;r<e.bits.length;r++)if((e.bits[r]&t.bits[r])!==0)return!0;return!1}serializePrivateMatch(e){return JSON.stringify({likeFilter:{bits:Array.from(e.likeFilter.bits),hashFunctions:e.likeFilter.hashFunctions,size:e.likeFilter.size},salt:e.salt,timestamp:e.timestamp.toISOString(),revealed:e.revealed})}deserializePrivateMatch(e){const t=JSON.parse(e);return{likeFilter:{bits:new Uint8Array(t.likeFilter.bits),hashFunctions:t.likeFilter.hashFunctions,size:t.likeFilter.size},salt:t.salt,timestamp:new Date(t.timestamp),revealed:t.revealed}}async generatePreKeyBundle(){if(!this.identity)throw new Error("Identity not initialized - cannot generate pre-key bundle");const e=await crypto.subtle.exportKey("raw",this.identity.publicKey);return{identityKey:new Uint8Array(e),signedPreKey:new Uint8Array(32),signedPreKeySignature:new Uint8Array(64),oneTimePreKey:new Uint8Array(32),timestamp:Date.now()}}async initiateKeyExchange(e,t){if(!this.identity)throw new Error("Identity not initialized - cannot initiate key exchange");const r=await crypto.subtle.importKey("raw",t.identityKey,{name:"Ed25519",namedCurve:"Ed25519"},!1,["verify"]),i=new TextEncoder().encode(Array.from(t.signedPreKey).join(","));if(!await crypto.subtle.verify("Ed25519",r,t.signedPreKeySignature,i))throw new Error("Invalid signed pre-key signature");return new Uint8Array(32)}}class GY{constructor(e=[],t=[]){this.connections=new Map,this.dataChannels=new Map,this.dataChannelCallbacks=[],this.iceCandidateCallbacks=[],this.connectionStateCallbacks=[],this.maxRetries=3,this.retryDelay=1e3,this.connectionRetries=new Map;const r=e.length>0?e:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"];this.iceServers=[...r.map(s=>({urls:s})),...t]}async createConnection(e){if(this.connections.has(e)){const r=this.connections.get(e);if(["connecting","connected"].includes(r.connectionState))return r;await this.closeConnection(e)}const t=new RTCPeerConnection({iceServers:this.iceServers,iceCandidatePoolSize:10,iceTransportPolicy:"all"});return t.onicecandidate=r=>{r.candidate?(console.log("ICE candidate for peer:",e,r.candidate),this.iceCandidateCallbacks.forEach(s=>{try{s(e,r.candidate)}catch(i){console.error("Error in ICE candidate callback:",i)}})):console.log("ICE gathering complete for peer:",e)},t.onconnectionstatechange=()=>{const r=t.connectionState;console.log("Connection state changed for peer:",e,r),this.connectionStateCallbacks.forEach(s=>{try{s(e,r)}catch(i){console.error("Error in connection state callback:",i)}}),(r==="failed"||r==="disconnected")&&this.handleConnectionFailure(e),r==="connected"&&this.connectionRetries.delete(e)},t.ondatachannel=r=>{const s=r.channel;console.log("Received data channel:",e,s.label),this.setupDataChannel(e,s.label,s),this.dataChannelCallbacks.forEach(i=>{try{i(e,s)}catch(a){console.error("Error in data channel callback:",a)}})},t.oniceconnectionstatechange=()=>{console.log("ICE connection state changed for peer:",e,t.iceConnectionState),t.iceConnectionState==="failed"&&(console.warn("ICE connection failed for peer:",e,"attempting restart"),t.restartIce())},t.onicegatheringstatechange=()=>{console.log("ICE gathering state changed for peer:",e,t.iceGatheringState)},this.connections.set(e,t),t}async closeConnection(e){const t=this.connections.get(e);if(t){const r=this.dataChannels.get(e);r&&r.forEach(s=>{s.readyState==="open"&&s.close()}),t.close(),this.connections.delete(e),this.dataChannels.delete(e),this.connectionRetries.delete(e),console.log("Closed connection to peer:",e)}}async createDataChannel(e,t){const r=await this.createConnection(e),s=this.getDataChannel(e,t);if(s&&s.readyState==="open")return s;const i=r.createDataChannel(t,{ordered:!0,maxRetransmits:3,maxPacketLifeTime:3e3});return this.setupDataChannel(e,t,i),new Promise((a,c)=>{const u=setTimeout(()=>{c(new Error(`Data channel ${t} failed to open for peer ${e}`))},1e4);i.readyState==="open"?(clearTimeout(u),a(i)):(i.onopen=()=>{clearTimeout(u),a(i)},i.onerror=h=>{clearTimeout(u),c(h)})})}setupDataChannel(e,t,r){this.dataChannels.has(e)||this.dataChannels.set(e,new Map),this.dataChannels.get(e).set(t,r),r.onopen=()=>{console.log("Data channel opened:",e,t)},r.onclose=()=>{console.log("Data channel closed:",e,t);const i=this.dataChannels.get(e);i&&(i.delete(t),i.size===0&&this.dataChannels.delete(e))},r.onmessage=i=>{console.log("Data channel message received:",e,t,typeof i.data=="string"?i.data.substring(0,100):"[Binary Data]")},r.onerror=i=>{console.error("Data channel error:",e,t,i)};const s=()=>{r.readyState==="closed"||r.readyState==="closing"||setTimeout(s,3e4)};setTimeout(s,3e4)}onDataChannel(e){this.dataChannelCallbacks.push(e),console.log("Data channel callback registered, total callbacks:",this.dataChannelCallbacks.length)}async addIceCandidate(e,t){const r=this.connections.get(e);if(!r){console.warn("Cannot add ICE candidate: no connection for peer",e);return}try{if(!r.remoteDescription){console.warn("Cannot add ICE candidate: no remote description for peer",e);return}await r.addIceCandidate(t),console.log("Added ICE candidate for peer:",e)}catch(s){throw console.error("Failed to add ICE candidate for peer:",e,s),s}}onIceCandidate(e){this.iceCandidateCallbacks.push(e),console.log("ICE candidate callback registered, total callbacks:",this.iceCandidateCallbacks.length)}getConnectionState(e){const t=this.connections.get(e);return t?t.connectionState:"closed"}onConnectionStateChange(e){this.connectionStateCallbacks.push(e),console.log("Connection state change callback registered, total callbacks:",this.connectionStateCallbacks.length)}async handleConnectionFailure(e){const t=this.connectionRetries.get(e)||0;t<this.maxRetries?(console.log(`Connection failed for peer ${e}, attempting retry ${t+1}/${this.maxRetries}`),this.connectionRetries.set(e,t+1),setTimeout(async()=>{try{await this.closeConnection(e),await this.createConnection(e)}catch(r){console.error("Failed to retry connection for peer:",e,r)}},this.retryDelay*Math.pow(2,t))):(console.error(`Max retries exceeded for peer ${e}, giving up`),await this.closeConnection(e))}getActiveConnections(){return Array.from(this.connections.keys()).filter(e=>this.getConnectionState(e)==="connected")}getDataChannel(e,t){return this.dataChannels.get(e)?.get(t)}hasConnection(e){return this.connections.has(e)&&!["closed","failed"].includes(this.getConnectionState(e))}async sendData(e,t,r){const s=this.getDataChannel(e,t);if(!s)throw new Error(`Data channel not found: ${e}/${t}`);if(s.readyState!=="open")throw new Error(`Data channel not open: ${e}/${t} (state: ${s.readyState})`);try{typeof r=="string"?s.send(r):s.send(new Uint8Array(r)),console.log("Data sent successfully:",e,t,typeof r=="string"?r.substring(0,100):"[Binary Data]")}catch(i){throw console.error("Failed to send data:",e,t,i),i}}getConnectionStats(e){const t=this.connections.get(e);return t?t.getStats():null}getAllConnections(){return new Map(this.connections)}getPeerDataChannels(e){return this.dataChannels.get(e)}destroy(){console.log("Destroying WebRTC Manager...");const e=Array.from(this.connections.keys()).map(t=>this.closeConnection(t));Promise.all(e).then(()=>{this.dataChannelCallbacks.length=0,this.iceCandidateCallbacks.length=0,this.connectionStateCallbacks.length=0,this.connectionRetries.clear(),console.log("WebRTC Manager destroyed")}).catch(t=>{console.error("Error during WebRTC Manager destruction:",t)})}async createOffer(e){const t=await this.createConnection(e),r=await t.createOffer({offerToReceiveAudio:!1,offerToReceiveVideo:!1});return await t.setLocalDescription(r),r}async createAnswer(e,t){const r=await this.createConnection(e);await r.setRemoteDescription(t);const s=await r.createAnswer();return await r.setLocalDescription(s),s}async setRemoteAnswer(e,t){const r=this.connections.get(e);if(!r)throw new Error(`No connection found for peer: ${e}`);await r.setRemoteDescription(t)}}function QY({matchId:n,onBack:e}){const[t,r]=ee.useState(""),[s,i]=ee.useState(!1),[a,c]=ee.useState(!1),[u,h]=ee.useState(!1),[f,p]=ee.useState({enabled:!1,fallbackToCentralized:!0}),[m,w]=ee.useState(null),[x,S]=ee.useState(!1),E=ee.useRef(null),A=ee.useRef(!1),{matches:P,user:k,sendMessage:F,markMessagesAsRead:I,getMessagesForMatch:V,unmatchUser:Q,deleteConversation:D}=Ts(),R=P.find(L=>L.id===n),Y=V(n);ee.useEffect(()=>((async()=>{if(!(!f.enabled||m||x)){S(!0);try{console.log("Initializing P2P chat for match:",n);const K=new Dk,G=new WY,$=new GY,j=new PN(K,G,$,{enableEncryption:!0,enableTypingIndicators:!0,enableReadReceipts:!0,enableMessageHistory:!0});await j.initialize();const H=`peer_${R?.userId||"unknown"}`;w(j),p(T=>({...T,peerId:H})),console.log("P2P chat initialized successfully")}catch(K){console.error("Failed to initialize P2P chat:",K),f.fallbackToCentralized&&(console.log("Falling back to centralized chat"),p(G=>({...G,enabled:!1})))}finally{S(!1)}}})(),()=>{m&&m.destroy()}),[f.enabled,n,R?.userId]);const J=()=>{p(L=>({...L,enabled:!L.enabled}))};ee.useEffect(()=>(A.current||(I(n),A.current=!0),()=>{A.current=!1}),[n]),ee.useEffect(()=>{E.current?.scrollIntoView({behavior:"smooth"})},[Y]),ee.useEffect(()=>{const L=K=>{s&&i(!1)};return document.addEventListener("mousedown",L),()=>{document.removeEventListener("mousedown",L)}},[s]);const X=L=>{L.preventDefault(),t.trim()&&(F(n,t.trim()),r(""))},B=()=>{Q(n),c(!1),e()},O=()=>{D(n),h(!1)};return R?f.enabled&&m&&f.peerId?v.jsx(CN,{matchId:n,peerId:f.peerId,p2pChatIntegration:m.getChatIntegration(),onBack:e}):v.jsxs("div",{className:"flex flex-col h-full",children:[v.jsxs("div",{className:"bg-white border-b px-4 py-3 flex items-center justify-between",children:[v.jsxs("div",{className:"flex items-center",children:[v.jsx("button",{onClick:e,className:"mr-3 p-1 text-gray-600 hover:text-gray-900 transition-colors",children:v.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),v.jsx("img",{src:R.photo,alt:R.name,className:"w-10 h-10 rounded-full object-cover mr-3"}),v.jsxs("div",{children:[v.jsx("h3",{className:"font-semibold text-gray-900",children:R.name}),v.jsxs("div",{className:"flex items-center space-x-2",children:[v.jsxs("p",{className:"text-sm text-gray-500",children:["Match em ",new Date(R.matchedAt).toLocaleDateString("pt-BR")]}),f.enabled&&v.jsx("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full flex items-center",children:" P2P"}),x&&v.jsx("span",{className:"text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full flex items-center",children:" Conectando..."})]})]})]}),v.jsxs("div",{className:"relative",children:[v.jsx("button",{onClick:()=>i(!s),className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",children:v.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"})})}),s&&v.jsxs("div",{className:"absolute right-0 top-full mt-2 w-56 bg-white rounded-lg shadow-lg border z-10",children:[v.jsxs("button",{onClick:()=>{J(),i(!1)},className:"w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2",children:[v.jsx("span",{children:f.enabled?"":""}),v.jsxs("div",{className:"flex flex-col items-start",children:[v.jsx("span",{children:f.enabled?"Chat P2P Ativo":"Ativar Chat P2P"}),v.jsx("span",{className:"text-xs text-gray-500",children:f.enabled?"Criptografia E2E":"Mais privacidade"})]}),x&&v.jsx("div",{className:"ml-auto",children:v.jsx("div",{className:"w-4 h-4 border-2 border-gray-300 border-t-red-500 rounded-full animate-spin"})})]}),v.jsxs("button",{onClick:()=>{h(!0),i(!1)},className:"w-full px-4 py-3 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center space-x-2 border-t",children:[v.jsx("span",{children:""}),v.jsx("span",{children:"Apagar conversa"})]}),v.jsxs("button",{onClick:()=>{c(!0),i(!1)},className:"w-full px-4 py-3 text-left text-sm text-red-600 hover:bg-red-50 flex items-center space-x-2 border-t",children:[v.jsx("span",{children:""}),v.jsx("span",{children:"Desfazer match"})]})]})]})]}),v.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50",children:[Y.length===0?v.jsxs("div",{className:"text-center py-8",children:[v.jsx("div",{className:"text-4xl mb-2",children:""}),v.jsx("p",{className:"text-gray-500",children:"Vocs deram match!"}),v.jsx("p",{className:"text-gray-400 text-sm mt-1",children:"Comece uma conversa"})]}):Y.filter(L=>L&&L.id).map(L=>{const K=L.senderId===k?.id;return v.jsx("div",{className:`flex ${K?"justify-end":"justify-start"}`,children:v.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${K?"bg-gradient-to-r from-red-500 to-pink-500 text-white":"bg-white text-gray-900 shadow-sm"}`,children:[v.jsx("p",{className:"text-sm",children:L.text||"Mensagem vazia"}),v.jsx("p",{className:`text-xs mt-1 ${K?"text-red-100":"text-gray-500"}`,children:(()=>{try{return new Date(L.timestamp).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}catch{return"Agora"}})()})]})},L.id)}),v.jsx("div",{ref:E})]}),v.jsx("div",{className:"bg-white border-t p-4",children:v.jsxs("form",{onSubmit:X,className:"flex space-x-2",children:[v.jsx("input",{type:"text",value:t,onChange:L=>r(L.target.value),placeholder:"Digite uma mensagem...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-red-500 focus:border-transparent"}),v.jsx("button",{type:"submit",disabled:!t.trim(),className:"bg-gradient-to-r from-red-500 to-pink-500 hover:from-red-600 hover:to-pink-600 disabled:from-gray-300 disabled:to-gray-300 text-white p-2 rounded-full transition-all duration-200 disabled:cursor-not-allowed",children:v.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})}),v.jsx(ja,{isOpen:a,title:"Desfazer Match",message:`Tem certeza que deseja desfazer o match com ${R.name}? Esta ao no pode ser desfeita e toda a conversa ser perdida.`,confirmText:"Desfazer Match",cancelText:"Cancelar",type:"danger",onConfirm:B,onCancel:()=>c(!1)}),v.jsx(ja,{isOpen:u,title:"Apagar Conversa",message:`Deseja apagar toda a conversa com ${R.name}? O match ser mantido, mas todas as mensagens sero removidas.`,confirmText:"Apagar Conversa",cancelText:"Cancelar",type:"warning",onConfirm:O,onCancel:()=>h(!1)})]}):(console.error("Match no encontrado:",{matchId:n,availableMatches:P.map(L=>L.id)}),v.jsxs("div",{className:"flex flex-col h-full",children:[v.jsxs("div",{className:"bg-white border-b px-4 py-3 flex items-center",children:[v.jsx("button",{onClick:e,className:"mr-3 p-1 text-gray-600 hover:text-gray-900 transition-colors",children:v.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),v.jsx("h3",{className:"font-semibold text-gray-900",children:"Erro"})]}),v.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:v.jsxs("div",{className:"text-center",children:[v.jsx("div",{className:"text-4xl mb-4",children:""}),v.jsx("p",{className:"text-gray-500 mb-2",children:"Match no encontrado"}),v.jsxs("p",{className:"text-sm text-gray-400",children:["ID: ",n]}),v.jsx("button",{onClick:e,className:"mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:"Voltar"})]})})]}))}function YY({onClose:n}){const{user:e,updateProfile:t}=Ts(),[r,s]=ee.useState(e?.name||""),[i,a]=ee.useState(e?.age?.toString()||""),[c,u]=ee.useState(e?.bio||""),[h,f]=ee.useState(e?.photos||[]),[p,m]=ee.useState(!1),w=ee.useRef(null),x=()=>{e&&(t({name:r.trim(),age:i?parseInt(i):void 0,bio:c.trim(),photos:h}),n())},S=P=>{const k=P.target.files;k&&(m(!0),Array.from(k).forEach((F,I)=>{const V=new FileReader;V.onload=Q=>{const D=Q.target?.result;setTimeout(()=>{f(R=>[...R,D]),I===k.length-1&&m(!1)},500*(I+1))},V.readAsDataURL(F)}),w.current&&(w.current.value=""))},E=P=>{f(k=>k.filter((F,I)=>I!==P))},A=(P,k)=>{if(k<0||k>=h.length)return;const F=[...h],[I]=F.splice(P,1);F.splice(k,0,I),f(F)};return v.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:v.jsxs("div",{className:"bg-white rounded-2xl max-w-md w-full max-h-[90vh] overflow-y-auto",children:[v.jsxs("div",{className:"sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between rounded-t-2xl",children:[v.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Editar Perfil"}),v.jsx("button",{onClick:n,className:"p-2 text-gray-500 hover:text-gray-700 transition-colors",children:v.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),v.jsxs("div",{className:"p-6 space-y-6",children:[v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Suas Fotos"}),v.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[h.map((P,k)=>v.jsxs("div",{className:"relative group",children:[v.jsx("img",{src:P,alt:`Foto ${k+1}`,className:"w-full h-32 object-cover rounded-lg"}),v.jsxs("div",{className:"absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center space-x-2",children:[k>0&&v.jsx("button",{onClick:()=>A(k,k-1),className:"p-2 bg-white bg-opacity-20 rounded-full text-white hover:bg-opacity-30 transition-colors",title:"Mover para esquerda",children:v.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),v.jsx("button",{onClick:()=>E(k),className:"p-2 bg-red-500 bg-opacity-80 rounded-full text-white hover:bg-opacity-100 transition-colors",title:"Remover foto",children:v.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}),k<h.length-1&&v.jsx("button",{onClick:()=>A(k,k+1),className:"p-2 bg-white bg-opacity-20 rounded-full text-white hover:bg-opacity-30 transition-colors",title:"Mover para direita",children:v.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),k===0&&v.jsx("div",{className:"absolute top-2 left-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs px-2 py-1 rounded-full",children:"Principal"})]},k)),h.length<6&&v.jsx("button",{onClick:()=>w.current?.click(),disabled:p,className:"h-32 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-500 hover:border-red-400 hover:text-red-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:p?v.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"}):v.jsxs(v.Fragment,{children:[v.jsx("svg",{className:"w-8 h-8 mb-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:v.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),v.jsx("span",{className:"text-sm",children:"Adicionar"})]})})]}),v.jsx("input",{ref:w,type:"file",accept:"image/*",multiple:!0,onChange:S,className:"hidden"}),v.jsx("p",{className:"text-xs text-gray-500",children:"Adicione at 6 fotos. A primeira ser sua foto principal."})]}),v.jsxs("div",{className:"space-y-4",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Informaes Bsicas"}),v.jsxs("div",{children:[v.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700 mb-2",children:"Nome"}),v.jsx("input",{id:"name",type:"text",value:r,onChange:P=>s(P.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent",placeholder:"Seu nome"})]}),v.jsxs("div",{children:[v.jsx("label",{htmlFor:"age",className:"block text-sm font-medium text-gray-700 mb-2",children:"Idade"}),v.jsx("input",{id:"age",type:"number",value:i,onChange:P=>a(P.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent",placeholder:"Sua idade",min:"18",max:"100"})]})]}),v.jsxs("div",{children:[v.jsx("label",{htmlFor:"bio",className:"block text-sm font-medium text-gray-700 mb-2",children:"Bio"}),v.jsx("textarea",{id:"bio",value:c,onChange:P=>u(P.target.value),rows:4,maxLength:500,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none",placeholder:"Conte um pouco sobre voc..."}),v.jsxs("div",{className:"flex justify-between items-center mt-2",children:[v.jsx("p",{className:"text-xs text-gray-500",children:"Descreva seus interesses, hobbies ou algo interessante sobre voc"}),v.jsxs("span",{className:"text-xs text-gray-400",children:[c.length,"/500"]})]})]})]}),v.jsxs("div",{className:"sticky bottom-0 bg-white border-t px-6 py-4 flex space-x-3 rounded-b-2xl",children:[v.jsx("button",{onClick:n,className:"flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Cancelar"}),v.jsx("button",{onClick:x,className:"flex-1 px-4 py-3 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-lg hover:from-red-600 hover:to-pink-600 transition-all",children:"Salvar"})]})]})})}function Ik({onClose:n}){const[e]=ee.useState(()=>new Dk),[t,r]=ee.useState({connected:!1,peerCount:0,dhtConnected:!1,latency:0,bandwidth:{up:0,down:0}}),[s,i]=ee.useState({bootstrapNodes:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa"],stunServers:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"],turnServers:[],geohashPrecision:5,maxPeers:50,discoveryInterval:3e4,enableEncryption:!0,keyRotationInterval:36e5,messageTimeout:1e4,reconnectInterval:5e3,maxRetries:3,autoConnect:!0,enableDiagnostics:!0,showAdvancedSettings:!1}),[a,c]=ee.useState(!1),[u,h]=ee.useState(null),[f,p]=ee.useState(""),[m,w]=ee.useState({urls:"",username:"",credential:""});ee.useEffect(()=>{const I=()=>{const Q=e.getNetworkStatus();r(Q)};I();const V=setInterval(I,2e3);return()=>clearInterval(V)},[e]);const x=async()=>{c(!0),h(null);try{const I={bootstrapNodes:s.bootstrapNodes,stunServers:s.stunServers,turnServers:s.turnServers,geohashPrecision:s.geohashPrecision,maxPeers:s.maxPeers,discoveryInterval:s.discoveryInterval,enableEncryption:s.enableEncryption,keyRotationInterval:s.keyRotationInterval,messageTimeout:s.messageTimeout,reconnectInterval:s.reconnectInterval,maxRetries:s.maxRetries};await e.initialize(),await e.connect(),console.log("P2P network connected successfully")}catch(I){console.error("P2P connection failed:",I);let V="Connection failed";I instanceof Error&&(I.message.includes("TCP connections are not possible in browsers")?V="Configurao atualizada para navegador. Tentando novamente...":I.message.includes("circuit-relay-v2-transport")?V="Configurao de relay atualizada. Conectando...":I.message.includes("WebRTC")?V="Erro WebRTC. Verifique as configuraes STUN/TURN.":I.message.includes("bootstrap")?V="Falha ao conectar aos ns bootstrap. Verifique a conexo.":I.message.includes("UnmetServiceDependencies")?V="Dependncias do servio P2P resolvidas. Tentando novamente...":V=I.message),h(V)}finally{c(!1)}},S=async()=>{try{await e.disconnect(),console.log("P2P network disconnected")}catch(I){console.error("P2P disconnection failed:",I)}},E=()=>{f.trim()&&!s.stunServers.includes(f.trim())&&(i(I=>({...I,stunServers:[...I.stunServers,f.trim()]})),p(""))},A=I=>{i(V=>({...V,stunServers:V.stunServers.filter((Q,D)=>D!==I)}))},P=()=>{if(m.urls.trim()){const I={urls:m.urls.trim(),...m.username&&{username:m.username},...m.credential&&{credential:m.credential}};i(V=>({...V,turnServers:[...V.turnServers,I]})),w({urls:"",username:"",credential:""})}},k=I=>{i(V=>({...V,turnServers:V.turnServers.filter((Q,D)=>D!==I)}))},F=()=>{i(I=>({...I,bootstrapNodes:["/dnsaddr/bootstrap.libp2p.io/p2p/QmNnooDu7bfjPFoTZYxMNLWUQJyrVwtbZg5gBMjTezGAJN","/dnsaddr/bootstrap.libp2p.io/p2p/QmQCU2EcMqAqQPR2i9bChDtGNJchTbq5TbXJJ16u19uLTa"],stunServers:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302"],turnServers:[]}))};return v.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:v.jsxs("div",{className:"bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:[v.jsx("div",{className:"sticky top-0 bg-white border-b border-gray-200 px-6 py-4 rounded-t-2xl",children:v.jsxs("div",{className:"flex items-center justify-between",children:[v.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Configuraes P2P"}),v.jsx("button",{onClick:n,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:""})]})}),v.jsxs("div",{className:"p-6 space-y-6",children:[v.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Status da Rede"}),v.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[v.jsxs("div",{className:"flex items-center space-x-2",children:[v.jsx("div",{className:`w-3 h-3 rounded-full ${t.connected?"bg-green-500":"bg-red-500"}`}),v.jsx("span",{className:"text-sm font-medium",children:t.connected?"Conectado":"Desconectado"})]}),v.jsxs("div",{className:"text-sm",children:[v.jsx("span",{className:"font-medium",children:"Peers: "}),v.jsx("span",{children:t.peerCount})]}),v.jsxs("div",{className:"flex items-center space-x-2",children:[v.jsx("div",{className:`w-3 h-3 rounded-full ${t.dhtConnected?"bg-green-500":"bg-red-500"}`}),v.jsxs("span",{className:"text-sm font-medium",children:["DHT ",t.dhtConnected?"Ativo":"Inativo"]})]}),v.jsxs("div",{className:"text-sm",children:[v.jsx("span",{className:"font-medium",children:"Latncia: "}),v.jsxs("span",{children:[t.latency,"ms"]})]})]}),v.jsxs("div",{className:"flex space-x-3",children:[t.connected?v.jsx("button",{onClick:S,className:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:"Desconectar"}):v.jsx("button",{onClick:x,disabled:a,className:"px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:a?"Conectando...":"Conectar"}),v.jsx("button",{onClick:F,className:"px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors",children:"Restaurar Padres"})]}),u&&v.jsx("div",{className:"mt-3 p-3 bg-red-100 border border-red-300 rounded-lg",children:v.jsx("p",{className:"text-sm text-red-700",children:u})}),v.jsx("div",{className:"mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg",children:v.jsxs("p",{className:"text-xs text-blue-700",children:[v.jsx("strong",{children:"Navegador:"})," Usando WebRTC, WebSockets e Circuit Relay para compatibilidade. Conexes TCP no esto disponveis no navegador."]})})]}),v.jsxs("div",{className:"space-y-4",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Configuraes Bsicas"}),v.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Mximo de Peers"}),v.jsx("input",{type:"number",min:"1",max:"100",value:s.maxPeers,onChange:I=>i(V=>({...V,maxPeers:parseInt(I.target.value)||50})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Preciso de Localizao"}),v.jsxs("select",{value:s.geohashPrecision,onChange:I=>i(V=>({...V,geohashPrecision:parseInt(I.target.value)})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent",children:[v.jsx("option",{value:3,children:"Baixa (~20km)"}),v.jsx("option",{value:4,children:"Mdia (~5km)"}),v.jsx("option",{value:5,children:"Alta (~2.4km)"}),v.jsx("option",{value:6,children:"Muito Alta (~600m)"})]})]})]}),v.jsxs("div",{className:"flex items-center space-x-4",children:[v.jsxs("label",{className:"flex items-center space-x-2",children:[v.jsx("input",{type:"checkbox",checked:s.autoConnect,onChange:I=>i(V=>({...V,autoConnect:I.target.checked})),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"}),v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Conectar automaticamente"})]}),v.jsxs("label",{className:"flex items-center space-x-2",children:[v.jsx("input",{type:"checkbox",checked:s.enableEncryption,onChange:I=>i(V=>({...V,enableEncryption:I.target.checked})),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"}),v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Criptografia habilitada"})]})]})]}),v.jsxs("div",{className:"space-y-4",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Servidores STUN"}),v.jsx("div",{className:"space-y-2",children:s.stunServers.map((I,V)=>v.jsxs("div",{className:"flex items-center space-x-2",children:[v.jsx("input",{type:"text",value:I,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"}),v.jsx("button",{onClick:()=>A(V),className:"p-2 text-red-500 hover:text-red-700 transition-colors",children:""})]},V))}),v.jsxs("div",{className:"flex space-x-2",children:[v.jsx("input",{type:"text",placeholder:"stun:stun.example.com:19302",value:f,onChange:I=>p(I.target.value),className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"}),v.jsx("button",{onClick:E,className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"Adicionar"})]})]}),v.jsxs("div",{className:"space-y-4",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Servidores TURN"}),v.jsx("div",{className:"space-y-3",children:s.turnServers.map((I,V)=>v.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg",children:[v.jsxs("div",{className:"flex items-center justify-between mb-2",children:[v.jsx("span",{className:"font-medium text-sm",children:I.urls}),v.jsx("button",{onClick:()=>k(V),className:"p-1 text-red-500 hover:text-red-700 transition-colors",children:""})]}),I.username&&v.jsxs("div",{className:"text-xs text-gray-600",children:["Usurio: ",I.username]})]},V))}),v.jsxs("div",{className:"space-y-2 p-3 border border-gray-200 rounded-lg",children:[v.jsx("input",{type:"text",placeholder:"turn:turn.example.com:3478",value:m.urls,onChange:I=>w(V=>({...V,urls:I.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"}),v.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[v.jsx("input",{type:"text",placeholder:"Usurio (opcional)",value:m.username,onChange:I=>w(V=>({...V,username:I.target.value})),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"}),v.jsx("input",{type:"password",placeholder:"Senha (opcional)",value:m.credential,onChange:I=>w(V=>({...V,credential:I.target.value})),className:"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),v.jsx("button",{onClick:P,className:"w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors",children:"Adicionar Servidor TURN"})]})]}),v.jsxs("div",{className:"space-y-4",children:[v.jsxs("div",{className:"flex items-center justify-between",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Configuraes Avanadas"}),v.jsx("button",{onClick:()=>i(I=>({...I,showAdvancedSettings:!I.showAdvancedSettings})),className:"text-sm text-blue-500 hover:text-blue-700 transition-colors",children:s.showAdvancedSettings?"Ocultar":"Mostrar"})]}),s.showAdvancedSettings&&v.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Intervalo de Descoberta (ms)"}),v.jsx("input",{type:"number",min:"5000",max:"300000",step:"1000",value:s.discoveryInterval,onChange:I=>i(V=>({...V,discoveryInterval:parseInt(I.target.value)||3e4})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Timeout de Mensagem (ms)"}),v.jsx("input",{type:"number",min:"1000",max:"60000",step:"1000",value:s.messageTimeout,onChange:I=>i(V=>({...V,messageTimeout:parseInt(I.target.value)||1e4})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Intervalo de Reconexo (ms)"}),v.jsx("input",{type:"number",min:"1000",max:"30000",step:"1000",value:s.reconnectInterval,onChange:I=>i(V=>({...V,reconnectInterval:parseInt(I.target.value)||5e3})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Mximo de Tentativas"}),v.jsx("input",{type:"number",min:"1",max:"10",value:s.maxRetries,onChange:I=>i(V=>({...V,maxRetries:parseInt(I.target.value)||3})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]})]})]})]}),v.jsx("div",{className:"sticky bottom-0 bg-white border-t border-gray-200 px-6 py-4 rounded-b-2xl",children:v.jsx("div",{className:"flex justify-end space-x-3",children:v.jsx("button",{onClick:n,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Fechar"})})})]})})}class XY{constructor(){this.events={}}on(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}off(e,t){this.events[e]&&(this.events[e]=this.events[e].filter(r=>r!==t))}emit(e,...t){this.events[e]&&this.events[e].forEach(r=>r(...t))}removeAllListeners(e){e?delete this.events[e]:this.events={}}listenerCount(e){return this.events[e]?.length||0}}class JY extends XY{constructor(){super(),this.auditLog=[],this.settings=this.getDefaultSettings(),this.setupAutoBackup()}getSettings(){return{...this.settings}}updateSettings(e){const t={...this.settings};this.settings={...this.settings,...e},e.privacyLevel&&e.privacyLevel!==t.privacyLevel&&this.applyPrivacyLevelPreset(e.privacyLevel),this.logPrivacyChange("settings_updated","privacy_settings",{oldSettings:t,newSettings:this.settings}),(e.enableAutoBackup!==void 0||e.backupFrequency!==void 0)&&this.setupAutoBackup(),this.emit("settingsUpdated",this.settings)}applyPrivacyLevelPreset(e){switch(e){case Br.MINIMAL:this.settings={...this.settings,shareProfile:Ye.MATCHES_ONLY,sharePhotos:Ye.MATCHES_ONLY,shareActivity:Ye.NONE,shareLocation:Ye.NEARBY_USERS,geolocationPrecision:mr.CITY,hideExactLocation:!0,hideAge:!0,hideLastSeen:!0,hideDistance:!0,requireMatchForMessage:!0,blockScreenshots:!0,enableOnionRouting:!0,enableTrafficObfuscation:!0,enableMetadataProtection:!0};break;case Br.BALANCED:this.settings={...this.settings,shareProfile:Ye.NEARBY_USERS,sharePhotos:Ye.NEARBY_USERS,shareActivity:Ye.MATCHES_ONLY,shareLocation:Ye.NEARBY_USERS,geolocationPrecision:mr.NEIGHBORHOOD,hideExactLocation:!1,hideAge:!1,hideLastSeen:!1,hideDistance:!1,requireMatchForMessage:!0,blockScreenshots:!1,enableOnionRouting:!1,enableTrafficObfuscation:!1,enableMetadataProtection:!0};break;case Br.OPEN:this.settings={...this.settings,shareProfile:Ye.ALL_USERS,sharePhotos:Ye.ALL_USERS,shareActivity:Ye.NEARBY_USERS,shareLocation:Ye.ALL_USERS,geolocationPrecision:mr.STREET,hideExactLocation:!1,hideAge:!1,hideLastSeen:!1,hideDistance:!1,requireMatchForMessage:!1,blockScreenshots:!1,enableOnionRouting:!1,enableTrafficObfuscation:!1,enableMetadataProtection:!1};break}}canShareData(e,t,r){let s;switch(e){case"profile":s=this.settings.shareProfile;break;case"photos":s=this.settings.sharePhotos;break;case"activity":s=this.settings.shareActivity;break;case"location":s=this.settings.shareLocation;break;default:s=Ye.NONE}const i=[Ye.NONE,Ye.MATCHES_ONLY,Ye.NEARBY_USERS,Ye.ALL_USERS],a=i.indexOf(s),u=i.indexOf(t)<=a;return this.logPrivacyChange("data_sharing_check",e,{targetScope:t,allowedScope:s,userId:r,result:u}),u}getObfuscatedLocation(e){const t=this.settings.geolocationPrecision,r=e.substring(0,t);return this.logPrivacyChange("location_obfuscation","geolocation",{originalPrecision:e.length,obfuscatedPrecision:t,hideExact:this.settings.hideExactLocation}),r}shouldHideLocationMetadata(){return this.settings.hideExactLocation||this.settings.enableMetadataProtection}async exportData(e){const t={timestamp:new Date().toISOString(),version:"1.0.0",options:e};e.includeProfile&&(t.profile=await this.getProfileData()),e.includeMessages&&(t.messages=await this.getMessagesData()),e.includeMatches&&(t.matches=await this.getMatchesData()),e.includeLikes&&(t.likes=await this.getLikesData()),e.includePhotos&&(t.photos=await this.getPhotosData()),e.includeSettings&&(t.settings=this.settings);let r;switch(e.format){case"json":r=JSON.stringify(t,null,2);break;case"csv":r=this.convertToCSV(t);break;case"xml":r=this.convertToXML(t);break;default:r=JSON.stringify(t,null,2)}return e.encrypt&&e.password&&(r=await this.encryptData(r,e.password)),this.logPrivacyChange("data_export","all_data",{options:e,size:r.length}),r}async createBackup(){const e={timestamp:new Date,version:"1.0.0",profile:await this.getProfileData(),messages:await this.getMessagesData(),matches:await this.getMatchesData(),likes:await this.getLikesData(),photos:await this.getPhotosData(),settings:this.settings,metadata:{totalSize:0,itemCount:0,checksum:""}};e.metadata.itemCount=this.countItems(e),e.metadata.checksum="";const t=JSON.stringify(e);return e.metadata.totalSize=t.length,e.metadata.checksum=await this.calculateChecksum(t),this.logPrivacyChange("backup_created","all_data",{size:e.metadata.totalSize,items:e.metadata.itemCount}),e}async restoreBackup(e){const t={...e},r=t.metadata.checksum;t.metadata.checksum="";const s=JSON.stringify(t);if(await this.calculateChecksum(s)!==r)throw new Error("Backup integrity check failed");e.profile&&await this.restoreProfileData(e.profile),e.messages&&await this.restoreMessagesData(e.messages),e.matches&&await this.restoreMatchesData(e.matches),e.likes&&await this.restoreLikesData(e.likes),e.photos&&await this.restorePhotosData(e.photos),e.settings&&this.updateSettings(e.settings),this.logPrivacyChange("backup_restored","all_data",{backupTimestamp:e.timestamp,size:e.metadata.totalSize})}getAuditLog(){return[...this.auditLog]}clearAuditLog(){this.auditLog=[],this.logPrivacyChange("audit_log_cleared","audit_log",{})}async cleanupExpiredData(){const e=new Date;if(this.settings.locationHistoryRetention>0){const t=new Date(e.getTime()-this.settings.locationHistoryRetention*24*60*60*1e3);await this.cleanupLocationHistory(t)}if(this.settings.messageRetention>0){const t=new Date(e.getTime()-this.settings.messageRetention*24*60*60*1e3);await this.cleanupMessages(t)}if(this.settings.autoDeleteMatches&&this.settings.matchRetention>0){const t=new Date(e.getTime()-this.settings.matchRetention*24*60*60*1e3);await this.cleanupMatches(t)}if(this.settings.profileCacheRetention>0){const t=new Date(e.getTime()-this.settings.profileCacheRetention*24*60*60*1e3);await this.cleanupProfileCache(t)}this.logPrivacyChange("data_cleanup","expired_data",{timestamp:e})}getDefaultSettings(){return{privacyLevel:Br.BALANCED,shareProfile:Ye.NEARBY_USERS,sharePhotos:Ye.NEARBY_USERS,shareActivity:Ye.MATCHES_ONLY,shareLocation:Ye.NEARBY_USERS,geolocationPrecision:mr.NEIGHBORHOOD,hideExactLocation:!1,locationHistoryRetention:30,hideAge:!1,hideLastSeen:!1,hideDistance:!1,requireMatchForMessage:!0,blockScreenshots:!1,messageRetention:0,autoDeleteMatches:!1,matchRetention:365,profileCacheRetention:7,enableOnionRouting:!1,enableTrafficObfuscation:!1,enableMetadataProtection:!0,enableAutoBackup:!0,backupFrequency:24,encryptBackups:!0}}logPrivacyChange(e,t,r,s){const i={timestamp:new Date,action:e,dataType:t,scope:Ye.NONE,userId:s,details:r};this.auditLog.push(i),this.auditLog.length>1e3&&(this.auditLog=this.auditLog.slice(-500)),this.emit("privacyEvent",i)}setupAutoBackup(){if(this.backupInterval&&clearInterval(this.backupInterval),this.settings.enableAutoBackup){const e=this.settings.backupFrequency*60*60*1e3;this.backupInterval=setInterval(async()=>{try{await this.createBackup()}catch(t){console.error("Auto backup failed:",t)}},e)}}async getProfileData(){return{}}async getMessagesData(){return[]}async getMatchesData(){return[]}async getLikesData(){return[]}async getPhotosData(){return[]}async restoreProfileData(e){}async restoreMessagesData(e){}async restoreMatchesData(e){}async restoreLikesData(e){}async restorePhotosData(e){}async cleanupLocationHistory(e){}async cleanupMessages(e){}async cleanupMatches(e){}async cleanupProfileCache(e){}convertToCSV(e){return JSON.stringify(e)}convertToXML(e){return`<data>${JSON.stringify(e)}</data>`}async encryptData(e,t){return btoa(e)}countItems(e){let t=0;return e.profile&&t++,e.messages&&(t+=e.messages.length),e.matches&&(t+=e.matches.length),e.likes&&(t+=e.likes.length),e.photos&&(t+=e.photos.length),e.settings&&t++,t}async calculateChecksum(e){let t=0;for(let r=0;r<e.length;r++){const s=e.charCodeAt(r);t=(t<<5)-t+s,t=t&t}return Math.abs(t).toString(16)}destroy(){this.backupInterval&&clearInterval(this.backupInterval),this.removeAllListeners()}}function Nk({onClose:n}){const[e]=ee.useState(()=>new JY),[t,r]=ee.useState(e.getSettings()),[s,i]=ee.useState("general"),[a,c]=ee.useState([]),[u,h]=ee.useState(!1),[f,p]=ee.useState(!1),[m,w]=ee.useState({includeProfile:!0,includeMessages:!0,includeMatches:!0,includeLikes:!1,includePhotos:!0,includeSettings:!0,format:"json",encrypt:!0});ee.useEffect(()=>{const D=Y=>{r(Y)},R=Y=>{c(J=>[Y,...J.slice(0,99)])};return e.on("settingsUpdated",D),e.on("privacyEvent",R),c(e.getAuditLog().slice(-100)),()=>{e.off("settingsUpdated",D),e.off("privacyEvent",R)}},[e]);const x=D=>{e.updateSettings(D)},S=async()=>{h(!0);try{const D=await e.exportData(m),R=new Blob([D],{type:"application/json"}),Y=URL.createObjectURL(R),J=document.createElement("a");J.href=Y,J.download=`tinder-data-export-${new Date().toISOString().split("T")[0]}.${m.format}`,document.body.appendChild(J),J.click(),document.body.removeChild(J),URL.revokeObjectURL(Y),alert("Dados exportados com sucesso!")}catch(D){console.error("Export failed:",D),alert("Falha na exportao dos dados")}finally{h(!1)}},E=async()=>{p(!0);try{const D=await e.createBackup(),R=new Blob([JSON.stringify(D,null,2)],{type:"application/json"}),Y=URL.createObjectURL(R),J=document.createElement("a");J.href=Y,J.download=`tinder-backup-${D.timestamp.toISOString().split("T")[0]}.json`,document.body.appendChild(J),J.click(),document.body.removeChild(J),URL.revokeObjectURL(Y),alert("Backup criado com sucesso!")}catch(D){console.error("Backup failed:",D),alert("Falha na criao do backup")}finally{p(!1)}},A=D=>{switch(D){case Br.MINIMAL:return"Mxima privacidade - compartilha apenas dados essenciais";case Br.BALANCED:return"Privacidade equilibrada - configuraes padro recomendadas";case Br.OPEN:return"Mais aberto - compartilha mais dados para melhor matching";case Br.CUSTOM:return"Configuraes personalizadas pelo usurio";default:return""}},P=D=>{switch(D){case mr.CITY:return"Cidade (~20km de preciso)";case mr.DISTRICT:return"Distrito (~5km de preciso)";case mr.NEIGHBORHOOD:return"Bairro (~2.4km de preciso)";case mr.STREET:return"Rua (~600m de preciso)";case mr.BUILDING:return"Edifcio (~120m de preciso)";default:return""}},k=()=>v.jsxs("div",{className:"space-y-6",children:[v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Nvel de Privacidade"}),v.jsx("div",{className:"space-y-3",children:Object.values(Br).map(D=>v.jsxs("label",{className:"flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer",children:[v.jsx("input",{type:"radio",name:"privacyLevel",value:D,checked:t.privacyLevel===D,onChange:R=>x({privacyLevel:R.target.value}),className:"mt-1 text-red-500 focus:ring-red-500"}),v.jsxs("div",{children:[v.jsx("div",{className:"font-medium text-gray-900 capitalize",children:D}),v.jsx("div",{className:"text-sm text-gray-600",children:A(D)})]})]},D))})]}),v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Privacidade do Perfil"}),v.jsxs("div",{className:"space-y-3",children:[v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ocultar idade"}),v.jsx("input",{type:"checkbox",checked:t.hideAge,onChange:D=>x({hideAge:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ocultar ltima visualizao"}),v.jsx("input",{type:"checkbox",checked:t.hideLastSeen,onChange:D=>x({hideLastSeen:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ocultar distncia"}),v.jsx("input",{type:"checkbox",checked:t.hideDistance,onChange:D=>x({hideDistance:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]})]})]}),v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Privacidade de Comunicao"}),v.jsxs("div",{className:"space-y-3",children:[v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Exigir match para mensagens"}),v.jsx("input",{type:"checkbox",checked:t.requireMatchForMessage,onChange:D=>x({requireMatchForMessage:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Bloquear capturas de tela"}),v.jsx("input",{type:"checkbox",checked:t.blockScreenshots,onChange:D=>x({blockScreenshots:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reteno de mensagens (dias, 0 = para sempre)"}),v.jsx("input",{type:"number",min:"0",max:"365",value:t.messageRetention,onChange:D=>x({messageRetention:parseInt(D.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]})]})]})]}),F=()=>v.jsxs("div",{className:"space-y-6",children:[v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Controles de Compartilhamento"}),v.jsx("div",{className:"space-y-4",children:[{key:"shareProfile",label:"Compartilhar perfil"},{key:"sharePhotos",label:"Compartilhar fotos"},{key:"shareActivity",label:"Compartilhar atividade"},{key:"shareLocation",label:"Compartilhar localizao"}].map(({key:D,label:R})=>v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:R}),v.jsxs("select",{value:t[D],onChange:Y=>x({[D]:Y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent",children:[v.jsx("option",{value:Ye.NONE,children:"No compartilhar"}),v.jsx("option",{value:Ye.MATCHES_ONLY,children:"Apenas matches"}),v.jsx("option",{value:Ye.NEARBY_USERS,children:"Usurios prximos"}),v.jsx("option",{value:Ye.ALL_USERS,children:"Todos os usurios"})]})]},D))})]}),v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Reteno de Dados"}),v.jsxs("div",{className:"space-y-4",children:[v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Auto-deletar matches antigos"}),v.jsx("input",{type:"checkbox",checked:t.autoDeleteMatches,onChange:D=>x({autoDeleteMatches:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),t.autoDeleteMatches&&v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reteno de matches (dias)"}),v.jsx("input",{type:"number",min:"1",max:"365",value:t.matchRetention,onChange:D=>x({matchRetention:parseInt(D.target.value)||365}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cache de perfis (dias)"}),v.jsx("input",{type:"number",min:"1",max:"30",value:t.profileCacheRetention,onChange:D=>x({profileCacheRetention:parseInt(D.target.value)||7}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]})]})]}),v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Privacidade Avanada"}),v.jsxs("div",{className:"space-y-3",children:[v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsxs("div",{children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Roteamento Onion"}),v.jsx("p",{className:"text-xs text-gray-500",children:"Maior anonimato, menor velocidade"})]}),v.jsx("input",{type:"checkbox",checked:t.enableOnionRouting,onChange:D=>x({enableOnionRouting:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsxs("div",{children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ofuscao de Trfego"}),v.jsx("p",{className:"text-xs text-gray-500",children:"Dificulta anlise de trfego"})]}),v.jsx("input",{type:"checkbox",checked:t.enableTrafficObfuscation,onChange:D=>x({enableTrafficObfuscation:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsxs("div",{children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Proteo de Metadados"}),v.jsx("p",{className:"text-xs text-gray-500",children:"Remove metadados sensveis"})]}),v.jsx("input",{type:"checkbox",checked:t.enableMetadataProtection,onChange:D=>x({enableMetadataProtection:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]})]})]})]}),I=()=>v.jsxs("div",{className:"space-y-6",children:[v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Preciso de Localizao"}),v.jsx("div",{className:"space-y-3",children:Object.values(mr).filter(D=>typeof D=="number").map(D=>v.jsxs("label",{className:"flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50 cursor-pointer",children:[v.jsx("input",{type:"radio",name:"geolocationPrecision",value:D,checked:t.geolocationPrecision===D,onChange:R=>x({geolocationPrecision:parseInt(R.target.value)}),className:"mt-1 text-red-500 focus:ring-red-500"}),v.jsx("div",{children:v.jsx("div",{className:"font-medium text-gray-900",children:P(D)})})]},D))})]}),v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Privacidade de Localizao"}),v.jsxs("div",{className:"space-y-3",children:[v.jsxs("label",{className:"flex items-center justify-between",children:[v.jsxs("div",{children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Ocultar localizao exata"}),v.jsx("p",{className:"text-xs text-gray-500",children:"Mostra apenas rea aproximada"})]}),v.jsx("input",{type:"checkbox",checked:t.hideExactLocation,onChange:D=>x({hideExactLocation:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reteno do histrico de localizao (dias)"}),v.jsx("input",{type:"number",min:"0",max:"365",value:t.locationHistoryRetention,onChange:D=>x({locationHistoryRetention:parseInt(D.target.value)||30}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"}),v.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"0 = no manter histrico"})]})]})]})]}),V=()=>v.jsxs("div",{className:"space-y-6",children:[v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Exportar Dados"}),v.jsxs("div",{className:"space-y-4",children:[v.jsxs("div",{children:[v.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Dados para incluir:"}),v.jsx("div",{className:"space-y-2",children:[{key:"includeProfile",label:"Perfil"},{key:"includeMessages",label:"Mensagens"},{key:"includeMatches",label:"Matches"},{key:"includeLikes",label:"Likes"},{key:"includePhotos",label:"Fotos"},{key:"includeSettings",label:"Configuraes"}].map(({key:D,label:R})=>v.jsxs("label",{className:"flex items-center space-x-2",children:[v.jsx("input",{type:"checkbox",checked:m[D],onChange:Y=>w(J=>({...J,[D]:Y.target.checked})),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"}),v.jsx("span",{className:"text-sm text-gray-700",children:R})]},D))})]}),v.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Formato"}),v.jsxs("select",{value:m.format,onChange:D=>w(R=>({...R,format:D.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent",children:[v.jsx("option",{value:"json",children:"JSON"}),v.jsx("option",{value:"csv",children:"CSV"}),v.jsx("option",{value:"xml",children:"XML"})]})]}),v.jsx("div",{className:"flex items-end",children:v.jsxs("label",{className:"flex items-center space-x-2",children:[v.jsx("input",{type:"checkbox",checked:m.encrypt,onChange:D=>w(R=>({...R,encrypt:D.target.checked})),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"}),v.jsx("span",{className:"text-sm text-gray-700",children:"Criptografar"})]})})]}),v.jsx("button",{onClick:S,disabled:u,className:"w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:u?"Exportando...":"Exportar Dados"})]})]}),v.jsxs("div",{children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Backup e Restaurao"}),v.jsxs("div",{className:"space-y-4",children:[v.jsxs("div",{className:"flex items-center justify-between",children:[v.jsxs("div",{children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Backup automtico"}),v.jsx("p",{className:"text-xs text-gray-500",children:"Cria backups automaticamente"})]}),v.jsx("input",{type:"checkbox",checked:t.enableAutoBackup,onChange:D=>x({enableAutoBackup:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),t.enableAutoBackup&&v.jsxs("div",{children:[v.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Frequncia do backup (horas)"}),v.jsx("input",{type:"number",min:"1",max:"168",value:t.backupFrequency,onChange:D=>x({backupFrequency:parseInt(D.target.value)||24}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),v.jsxs("div",{className:"flex items-center justify-between",children:[v.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Criptografar backups"}),v.jsx("input",{type:"checkbox",checked:t.encryptBackups,onChange:D=>x({encryptBackups:D.target.checked}),className:"rounded border-gray-300 text-red-500 focus:ring-red-500"})]}),v.jsx("button",{onClick:E,disabled:f,className:"w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:f?"Criando Backup...":"Criar Backup Manual"})]})]})]}),Q=()=>v.jsxs("div",{className:"space-y-6",children:[v.jsxs("div",{className:"flex items-center justify-between",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Log de Auditoria de Privacidade"}),v.jsx("button",{onClick:()=>{e.clearAuditLog(),c([])},className:"px-3 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition-colors",children:"Limpar Log"})]}),v.jsx("div",{className:"max-h-96 overflow-y-auto space-y-2",children:a.length===0?v.jsx("p",{className:"text-gray-500 text-center py-8",children:"Nenhum evento de privacidade registrado"}):a.map((D,R)=>v.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[v.jsxs("div",{className:"flex items-center justify-between mb-1",children:[v.jsx("span",{className:"font-medium text-sm text-gray-900",children:D.action}),v.jsx("span",{className:"text-xs text-gray-500",children:D.timestamp.toLocaleString()})]}),v.jsxs("div",{className:"text-xs text-gray-600",children:[v.jsx("span",{className:"font-medium",children:"Tipo:"})," ",D.dataType,D.userId&&v.jsxs(v.Fragment,{children:[v.jsx("span",{className:"ml-2 font-medium",children:"Usurio:"})," ",D.userId.substring(0,8),"..."]})]}),Object.keys(D.details).length>0&&v.jsx("div",{className:"mt-1 text-xs text-gray-500",children:JSON.stringify(D.details,null,2)})]},R))})]});return v.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:v.jsxs("div",{className:"bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col",children:[v.jsx("div",{className:"border-b border-gray-200 px-6 py-4",children:v.jsxs("div",{className:"flex items-center justify-between",children:[v.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Controles de Privacidade"}),v.jsx("button",{onClick:n,className:"p-2 text-gray-400 hover:text-gray-600 transition-colors",children:""})]})}),v.jsx("div",{className:"border-b border-gray-200 px-6",children:v.jsx("nav",{className:"flex space-x-8",children:[{id:"general",label:"Geral"},{id:"data",label:"Dados"},{id:"location",label:"Localizao"},{id:"export",label:"Exportar"},{id:"audit",label:"Auditoria"}].map(D=>v.jsx("button",{onClick:()=>i(D.id),className:`py-4 px-1 border-b-2 font-medium text-sm transition-colors ${s===D.id?"border-red-500 text-red-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"}`,children:D.label},D.id))})}),v.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[s==="general"&&k(),s==="data"&&F(),s==="location"&&I(),s==="export"&&V(),s==="audit"&&Q()]}),v.jsx("div",{className:"border-t border-gray-200 px-6 py-4",children:v.jsxs("div",{className:"flex justify-end space-x-3",children:[v.jsx("button",{onClick:()=>e.cleanupExpiredData(),className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",children:"Limpar Dados Expirados"}),v.jsx("button",{onClick:n,className:"px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors",children:"Fechar"})]})})]})})}function ZY(){const n=Ts(e=>e.user);return v.jsx("div",{className:"min-h-screen bg-gradient-to-br from-red-50 to-pink-50",children:n?v.jsx(eX,{}):v.jsx("div",{className:"flex items-center justify-center min-h-screen p-4",children:v.jsx(xN,{})})})}function eX(){const{user:n,matches:e,logout:t}=Ts(),[r,s]=gr.useState(!1),[i,a]=gr.useState(!1),[c,u]=gr.useState(!1),[h,f]=gr.useState(!1),[p,m]=gr.useState("discover"),[w,x]=gr.useState(null),S=e.reduce((P,k)=>P+k.unreadCount,0),E=P=>{x(P)},A=()=>{x(null)};return v.jsxs("div",{className:"min-h-screen flex flex-col",children:[v.jsx("header",{className:"bg-white shadow-sm border-b",children:v.jsxs("div",{className:"max-w-md mx-auto px-4 py-4 flex items-center justify-between",children:[v.jsxs("div",{className:"flex items-center space-x-3",children:[v.jsx("div",{className:"w-10 h-10 bg-gradient-to-r from-red-500 to-pink-500 rounded-full flex items-center justify-center",children:v.jsx("span",{className:"text-white font-bold text-lg",children:n?.name.charAt(0).toUpperCase()})}),v.jsxs("div",{children:[v.jsxs("h1",{className:"text-lg font-bold text-gray-900",children:["Ol, ",n?.name,"!"]}),v.jsx("p",{className:"text-sm text-gray-500",children:n?.email})]})]}),v.jsxs("div",{className:"flex items-center space-x-2",children:[v.jsx("button",{onClick:()=>s(!r),className:"p-2 text-gray-600 hover:text-gray-900 transition-colors",title:"Perfil",children:""}),v.jsx("button",{onClick:t,className:"p-2 text-gray-600 hover:text-red-600 transition-colors",title:"Sair",children:""})]})]})}),r&&v.jsx("div",{className:"bg-white border-b shadow-sm",children:v.jsxs("div",{className:"max-w-md mx-auto px-4 py-4",children:[v.jsxs("div",{className:"flex items-center justify-between mb-4",children:[v.jsx("h3",{className:"font-semibold text-gray-900",children:"Meu Perfil"}),v.jsx("button",{onClick:()=>{a(!0),s(!1)},className:"text-red-500 hover:text-red-600 text-sm font-medium transition-colors",children:"Editar"})]}),n?.photos&&n.photos.length>0&&v.jsx("div",{className:"mb-4",children:v.jsxs("div",{className:"flex space-x-2 overflow-x-auto pb-2",children:[n.photos.slice(0,3).map((P,k)=>v.jsx("img",{src:P,alt:`Foto ${k+1}`,className:"w-16 h-16 rounded-lg object-cover flex-shrink-0"},k)),n.photos.length>3&&v.jsxs("div",{className:"w-16 h-16 rounded-lg bg-gray-100 flex items-center justify-center text-gray-500 text-xs flex-shrink-0",children:["+",n.photos.length-3]})]})}),v.jsxs("div",{className:"space-y-2 text-sm",children:[v.jsxs("p",{children:[v.jsx("span",{className:"font-medium",children:"Nome:"})," ",n?.name]}),v.jsxs("p",{children:[v.jsx("span",{className:"font-medium",children:"Email:"})," ",n?.email]}),n?.age&&v.jsxs("p",{children:[v.jsx("span",{className:"font-medium",children:"Idade:"})," ",n.age," anos"]}),v.jsxs("p",{children:[v.jsx("span",{className:"font-medium",children:"Bio:"})," ",n?.bio||"Nenhuma bio ainda"]}),v.jsxs("p",{children:[v.jsx("span",{className:"font-medium",children:"Fotos:"})," ",n?.photos?.length||0,"/6"]})]})]})}),v.jsx("div",{className:"bg-white border-b",children:v.jsxs("div",{className:"max-w-md mx-auto flex",children:[v.jsx("button",{onClick:()=>{m("discover"),x(null)},className:`flex-1 py-4 px-4 text-center font-medium transition-colors ${p==="discover"?"text-red-500 border-b-2 border-red-500":"text-gray-500 hover:text-gray-700"}`,children:v.jsxs("div",{className:"flex items-center justify-center space-x-1",children:[v.jsx("span",{children:""}),v.jsx("span",{className:"text-sm",children:"Descobrir"})]})}),v.jsx("button",{onClick:()=>{m("matches"),x(null)},className:`flex-1 py-4 px-4 text-center font-medium transition-colors relative ${p==="matches"?"text-red-500 border-b-2 border-red-500":"text-gray-500 hover:text-gray-700"}`,children:v.jsxs("div",{className:"flex items-center justify-center space-x-1",children:[v.jsx("span",{children:""}),v.jsx("span",{className:"text-sm",children:"Matches"}),S>0&&v.jsx("div",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center",children:S})]})}),v.jsx("button",{onClick:()=>{m("profile"),x(null)},className:`flex-1 py-4 px-4 text-center font-medium transition-colors ${p==="profile"?"text-red-500 border-b-2 border-red-500":"text-gray-500 hover:text-gray-700"}`,children:v.jsxs("div",{className:"flex items-center justify-center space-x-1",children:[v.jsx("span",{children:""}),v.jsx("span",{className:"text-sm",children:"Perfil"})]})})]})}),v.jsx("main",{className:"flex-1 max-w-md mx-auto w-full",children:p==="discover"?v.jsx("div",{className:"p-4",children:v.jsx(bN,{})}):p==="matches"?w?v.jsx("div",{className:"h-full",children:v.jsx(QY,{matchId:w,onBack:A})}):v.jsx("div",{className:"p-4",children:v.jsx(SN,{onSelectMatch:E})}):v.jsx(tX,{onEdit:()=>a(!0)})}),i&&v.jsx(YY,{onClose:()=>a(!1)}),c&&v.jsx(Ik,{onClose:()=>u(!1)}),h&&v.jsx(Nk,{onClose:()=>f(!1)})]})}function tX({onEdit:n}){const{user:e}=Ts(),[t,r]=gr.useState(!1),[s,i]=gr.useState(!1);return e?v.jsxs("div",{className:"p-4 space-y-6",children:[v.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm",children:[v.jsxs("div",{className:"text-center mb-6",children:[e.photos&&e.photos.length>0?v.jsx("img",{src:e.photos[0],alt:e.name,className:"w-32 h-32 rounded-full object-cover mx-auto mb-4"}):v.jsx("div",{className:"w-32 h-32 rounded-full bg-gradient-to-r from-red-500 to-pink-500 flex items-center justify-center mx-auto mb-4",children:v.jsx("span",{className:"text-white text-4xl font-bold",children:e.name.charAt(0).toUpperCase()})}),v.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:e.name}),e.age&&v.jsxs("p",{className:"text-gray-600",children:[e.age," anos"]})]}),v.jsxs("div",{className:"space-y-3",children:[v.jsx("button",{onClick:n,className:"w-full bg-gradient-to-r from-red-500 to-pink-500 text-white py-3 rounded-lg font-semibold hover:from-red-600 hover:to-pink-600 transition-all",children:"Editar Perfil"}),v.jsx("button",{onClick:()=>r(!0),className:"w-full bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-600 transition-all",children:" Configuraes P2P"}),v.jsx("button",{onClick:()=>i(!0),className:"w-full bg-gradient-to-r from-green-500 to-teal-500 text-white py-3 rounded-lg font-semibold hover:from-green-600 hover:to-teal-600 transition-all",children:" Controles de Privacidade"})]})]}),v.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Sobre mim"}),v.jsx("p",{className:"text-gray-600 leading-relaxed",children:e.bio||"Adicione uma bio para contar mais sobre voc!"})]}),v.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Minhas Fotos"}),e.photos&&e.photos.length>0?v.jsx("div",{className:"grid grid-cols-2 gap-3",children:e.photos.map((a,c)=>v.jsxs("div",{className:"relative",children:[v.jsx("img",{src:a,alt:`Foto ${c+1}`,className:"w-full h-32 object-cover rounded-lg"}),c===0&&v.jsx("div",{className:"absolute top-2 left-2 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs px-2 py-1 rounded-full",children:"Principal"})]},c))}):v.jsxs("div",{className:"text-center py-8 text-gray-500",children:[v.jsx("div",{className:"text-4xl mb-2",children:""}),v.jsx("p",{children:"Nenhuma foto adicionada ainda"}),v.jsx("p",{className:"text-sm mt-1",children:"Adicione fotos para atrair mais matches!"})]}),v.jsx("div",{className:"mt-4 text-center",children:v.jsxs("span",{className:"text-sm text-gray-500",children:[e.photos?.length||0," de 6 fotos"]})})]}),v.jsxs("div",{className:"bg-white rounded-2xl p-6 shadow-sm",children:[v.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Estatsticas"}),v.jsxs("div",{className:"grid grid-cols-2 gap-4 text-center",children:[v.jsxs("div",{children:[v.jsx("div",{className:"text-2xl font-bold text-red-500",children:e.photos?.length||0}),v.jsx("div",{className:"text-sm text-gray-600",children:"Fotos"})]}),v.jsxs("div",{children:[v.jsx("div",{className:"text-2xl font-bold text-red-500",children:e.bio?.length||0}),v.jsx("div",{className:"text-sm text-gray-600",children:"Caracteres na bio"})]})]})]}),t&&v.jsx(Ik,{onClose:()=>r(!1)}),s&&v.jsx(Nk,{onClose:()=>i(!1)})]}):null}BP.createRoot(document.getElementById("root")).render(v.jsx(ZY,{}));
